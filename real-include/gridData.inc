<?php 
class gridData
{
	function isSearch($gridSearchFields)
	{
		$status=false;
		for($i=0;$i<count($gridSearchFields);$i++)
		{
			if($gridSearchFields[$i]!="")
			{
				$status=true;
				break;
			}
		}
		return $status; 
	}
	
	function isSearchSingle($gridSearchFields,$asFields)
	{
		$status=false;
		for($i=0;$i<count($gridSearchFields);$i++)
		{
			if($gridSearchFields[$i]!="" && !strpos("*".$asFields[$i+1],"GROUP_CONCAT") && !strpos("*".$asFields[$i+1],"DISTINCT") && !strpos("*".$asFields[$i+1],"SUM"))
			{
				$status=true;
				break;
			}
		}
		return $status; 
	}
	
	function isSearchGroup($gridSearchFields,$asFields)
	{
		$status=false;
		for($i=0;$i<count($gridSearchFields);$i++)
		{
			if($gridSearchFields[$i]!="" && (strpos("*".$asFields[$i+1],"GROUP_CONCAT") || strpos("*".$asFields[$i+1],"DISTINCT") || strpos("*".$asFields[$i+1],"SUM")))
			{
				$status=true;
				break;
			}
		}
		return $status; 
	}

	function buildLimt($gridPage,$gridRecords)
	{
		if($gridPage==1)
			$offset=0;
		else
			$offset=intval($gridRecords*($gridPage-1));
		return " LIMIT $offset,$gridRecords ";
	}

	function buildQSTR($gridSearchType,$gridSearchFields,$asFields)
	{
		$qstr="";
		if($this->isSearch($gridSearchFields))
		{
			$qstr=" AND (";
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);
										
				if($gridSearchFields[$i]!="")
				{
					// Functionality task 1 - NH0067 
					if($i==0 && strpos($gridSearchFields[0],"-")!== false)
					{
						$array_dates = explode("-",$gridSearchFields[0]);
						$array_dates[0] = trim($array_dates[0]);
						$array_dates[1] = trim($array_dates[1]);
						
						$temp1 = explode("/",$array_dates[0]);
						$temp2 = explode("/",$array_dates[1]);
						if(count($temp1)==3 && count($temp2)==3)
						{
							$date1 = $temp1[2].'-'.$temp1[0].'-'.$temp1[1];
							$date2 = $temp2[2].'-'.$temp2[0].'-'.$temp2[1];
							$date1_time = strtotime($date1);
							$date2_time = strtotime($date2);
							if($date1_time < $date2_time) 
							{ 
								$mindate = $date1;
								$maxdate = $date2;
							}
							else
							{
								$mindate = $date2;
								$maxdate = $date1;
							}
							$mindate = $mindate." 00:00:00";
							$maxdate = $maxdate." 23:59:59";
							
							$qstr.="CONVERT_TZ(cmngmt_pr.sdate,'SYSTEM','EST5EDT') >='".$mindate."' AND CONVERT_TZ(cmngmt_pr.sdate,'SYSTEM','EST5EDT') <='".$maxdate."' $gridSearchType ";
						}
						else
						{
							$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
						}
					}
					else 
					{	
						if($i==4 AND substr($gridSearchField,0,4)=="ASGN")
						{
								
								if(strpos($gridSearchField,",")!== false)
								{
										$asgn_pusername_arr = explode(",",$gridSearchField);
										foreach($asgn_pusername_arr AS $key=>$val)
										{
												$asgn_pusername_arr[$key] = trim($val);
										}
										$pusername_str = implode("','",$asgn_pusername_arr);
										$qstr.=$asFields[$i+1]." IN ('".$pusername_str."') $gridSearchType ";
								}
								else
								{
										$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
								}
						}
						else{
								$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
						}
						
					}
				} 
			}
			$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
			$qstr.=")";
		}
		return $qstr;
	}
	
	function buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields)
	{
		$qstr="";
		$hstr="";

		if($this->isSearchSingle($gridSearchFields,$asFields))
		{
			$qstr=" AND (";
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);

				if($gridSearchFields[$i]!="" && !strpos("*".$asFields[$i+1],"GROUP_CONCAT") && !strpos("*".$asFields[$i+1],"DISTINCT") && !strpos("*".$asFields[$i+1],"SUM"))
					$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
			}
			$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
			$qstr.=")";
		}

		if($this->isSearchGroup($gridSearchFields,$asFields))
		{
			$hstr=" HAVING (";

			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);
										
				if($gridSearchFields[$i]!="" && (strpos("*".$asFields[$i+1],"GROUP_CONCAT") || strpos("*".$asFields[$i+1],"DISTINCT") || strpos("*".$asFields[$i+1],"SUM")))
					$hstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
			}

			$hstr=substr($hstr,0,(strlen($hstr)-(strlen($gridSearchType)+1)));
			$hstr.=")";
		}

		$gqstr[0]=$qstr;
		$gqstr[1]=$hstr;

		return $gqstr;
	}
	
	function buildUDFQSTR($gridSearchType,$gridSearchFields,$asFields)
	{
		$qstr="";
		if($this->isSearch($gridSearchFields))
		{
			$qstr=" AND (";
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string(addslashes($gridSearchFields[$i]));
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);
										
				if($gridSearchFields[$i]!="")
				{
						if($asFields[$i+1] == 't1.status')
						{
								$qstr.=$asFields[$i+1]." LIKE '".$gridSearchField."%' $gridSearchType ";
						}
						if($asFields[$i+1] == 't1.element_name')
						{
								$qstr.=$asFields[$i+1]." LIKE '%".urlencode($gridSearchField)."%' $gridSearchType ";
						}
						else
						{
								$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
						}
				}					
			}
			$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
			$qstr.=")";
		}
		return $qstr;
	}
	
	
	//For preparing where conditions, Using AND for text columns searchs and Using FIND_IN_SET for dropdown lists search columns, $colValue variable should be piep(|) seperated column numbers.
	function buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,$colValue)
	{
		$qstr="";
		$colValueArray = explode("|",$colValue);

		if($this->isSearch($gridSearchFields))
		{
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);

				if($qstr=="")
					$qstr=" AND (";

				if(!in_array($i,$colValueArray) || $colValue=="")
				{
					if($gridSearchFields[$i]!="")
						$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
				}
				else
				{
					if($gridSearchFields[$i]!="")
						$qstr .= " (FIND_IN_SET('".$gridSearchField."',".$asFields[$i+1].")) $gridSearchType ";
				}
			}

			if($qstr!="")
			{
    			$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
    			$qstr.=")";
			}
		}
		return $qstr;
	}

	function buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,$colValue,$modulename)
	{
		global $username, $cvsid;
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$search_array = $custom_grid_function_obj->searchQueryStrings($modulename, $username, $cvsid);
		
		$qstr = '';
		$having_string = "";
		$colValueArray = explode("|",$colValue);

		if($this->isSearch($gridSearchFields))
		{
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);
				
				if($qstr=="")
				    $qstr=" AND (";
				    
				if(!in_array($i,$colValueArray))
				{					
					if($gridSearchFields[$i]!="")
					{						
						if($search_array[$i] != '')
						{
							if(strpos($search_array[$i],'HAVING') === false)
							{
								if(strpos($search_array[$i],'@^@^@^@^@^') === false)
								{
									$search_sub_query = str_replace("@|@|@|@|@",$username,$search_array[$i]);
									$qstr .= $search_sub_query." LIKE '%".$gridSearchField."%' $gridSearchType ";
								}
								else
								{
									$search_sub_query = str_replace('@^@^@^@^@^',"%".$gridSearchFields[$i]."%",$search_array[$i]);
									
									//$qstr.= $asFields[$i+1]."  (".$search_sub_query.") $gridSearchType ";
									//$qstr.= " (FIND_IN_SET(111".$search_sub_query.",".$asFields[$i+1].")) $gridSearchType ";
									$qstr .= $search_sub_query ." ". $gridSearchType;
								}
								
								
							}
							else
							{
								if(empty($having_string))
								{
									$having_string = str_replace("HAVING ",'',str_replace('@^@^@^@^@^',"%".$gridSearchFields[$i]."%",$search_array[$i]));
								}
								else
								{
									$having_string .= " ".$gridSearchType.' '.str_replace("HAVING ",'',str_replace('@^@^@^@^@^',"%".$gridSearchFields[$i]."%",$search_array[$i]));								
								}
							}
						}
						else
						{
							$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
						}
					}
				}
				else
				{
					
					if($gridSearchFields[$i]!="")
					{
						$qstr .= " (FIND_IN_SET('".$gridSearchField."',".$asFields[$i+1].")) $gridSearchType ";
					}
				}
			}
			if($qstr!="")
			{
				$qstr = trim($qstr);
				
				if($qstr == 'AND (')
					$qstr = '';
				else
				{
					$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
					$qstr.=")";
				}
			}
		}
	
		if(!empty($having_string))
			return $qstr." HAVING ".$having_string;
		else
			return $qstr;
	}

    //This function will be called only in case of searching skills plus some other field with "OR" condition(coz in this case we r using union condition so need to pass field number instead of field name for order by clause.)
	function buildOSTRSkiilOrCond($gridSortCol,$gridSort,$UnFields)
	{
        $ostr=" ORDER BY ".$UnFields[$gridSortCol]." $gridSort ";
        return $ostr;
	}
	
	
	function buildOSTR($gridSortCol,$gridSort,$asFields)
	{
		$ostr=" ORDER BY $asFields[$gridSortCol] $gridSort ";
		return $ostr;
	}

	function buildTQuery($que,$qstr,$gstr)
	{
		return "$que $qstr $gstr";
	}

	function buildOQuery($que,$qstr,$ostr,$lstr,$gstr)
	{
		return "$que $qstr $gstr $ostr $lstr";
	}

	function getTotalRows($que)
	{
		global $maildb,$db;

		$res=mysql_query($que,$db);
		$row=mysql_fetch_row($res);
		return $row[0];
	}
	
	function getTotalRowsSkills($que)
	{
		global $maildb,$db;

		$res=mysql_query($que,$db);
		//$row=mysql_fetch_row($res);
		return mysql_num_rows($res);
	}
	
	function getTotalCount($que)
	{
		global $maildb,$db;
		$res=mysql_query($que,$db);		
		return mysql_num_rows($res);
	}
	
	function convertSpecChars($input)
	{
		//--------Replacing special char's like ’,” with single quote------START
		$input=str_replace("’","'",$input);
		$input=str_replace("‘","'",$input);
		$input=str_replace('”',"'",$input);
		$input=str_replace('“',"'",$input);
		$input=str_replace("–","-",$input);
		$input=stripslashes($input);
		$input=str_replace('\\', '',$input);
		//-------------END-------------------
		
		$input=preg_replace("/(\n|\t|\r|\b)*/","",$input);
		return html_tls_specialchars(trim($input),ENT_QUOTES);
	}	
	
	function getContactCheckBoxValue($sno)
	{
		global $username;
		$sel_ContactCheckBoxValue = "SELECT 
				staffoppr_contact.sno, 
				staffoppr_contact.fname,
				staffoppr_contact.lname,
				staffoppr_cinfo.cname, 
				staffoppr_contact.ytitle, 
				staffoppr_contact.email,
				staffoppr_contact.wphone,
				staffoppr_contact.state,
				staffoppr_contact.owner,
				manage.name as cat, 
				IF(staffoppr_contact.accessto='ALL','Public',IF(staffoppr_contact.accessto='".$username."','Private','Share')) as share_type,
				users.name,
				staffoppr_contact.stime,
				staffoppr_contact.mdate,
				IF(staffoppr_contact.email = '', IF(staffoppr_contact.email_2 = '', IF(staffoppr_contact.email_3 = '', CONCAT(staffoppr_contact.fname,staffoppr_contact.lname), ''), ''), '') as email_flag_name,
				IF(staffoppr_contact.email!='',staffoppr_contact.email,IF(staffoppr_contact.email_2!='',staffoppr_contact.email_2,IF(staffoppr_contact.email_3!='',staffoppr_contact.email_3,''))) as con_email_id,
				staffoppr_contact.ds_pobstatus 
				FROM staffoppr_contact 
				LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno
				LEFT JOIN manage ON staffoppr_contact.cat_id = manage.sno
				LEFT JOIN users ON staffoppr_contact.owner = users.username
				WHERE staffoppr_contact.sno = ".$sno;
		
		$res_ContactCheckBoxValue = mysql_query($sel_ContactCheckBoxValue);
		$rec_ContactCheckBoxValue = mysql_fetch_assoc($res_ContactCheckBoxValue);
		return($rec_ContactCheckBoxValue);
	}
	
	function fetchCustomSortOrder($moduleId,$cvsid=0){
		global $db,$username;
		
		if(!empty($cvsid) && $cvsid!=0)
		{
			$selQery = "SELECT cgucols.column_order,cgcols.column_name
					FROM udv_grids_savedsearch cg
						LEFT JOIN udv_grids_usercolumns cgucols ON cgucols.savedsearch_id = cg.id AND cgucols.custom_grid_id=0
						LEFT JOIN udv_grid_columns cgcols ON cgcols.id = cgucols.custom_grid_column_id
						LEFT JOIN udf_form_modules cfm ON cfm.module_id = cgcols.custom_form_modules_id
					WHERE cg.custom_form_modules_id = $moduleId
					AND cg.cuser = $username
					AND cg.id = $cvsid
					AND cgcols.udfstatus = 1 
					ORDER BY cgucols.column_order asc";
		}else
		{
			$selQery = "SELECT cgucols.column_order,cgcols.column_name
					FROM udv_grids cg
						LEFT JOIN udv_grids_usercolumns cgucols ON cgucols.custom_grid_id = cg.id
						LEFT JOIN udv_grid_columns cgcols ON cgcols.id = cgucols.custom_grid_column_id
						LEFT JOIN udf_form_modules cfm ON cfm.module_id = cgcols.custom_form_modules_id
					WHERE cg.custom_form_modules_id = $moduleId
					AND cg.cuser = $username
					AND cgcols.udfstatus = 1 
					ORDER BY cgucols.column_order asc";
		}		
		$res=mysql_query($selQery,$db);
		$return = '';
		if(mysql_num_rows($res)> 0){
			while($row = mysql_fetch_row($res)){
			  
				if($row[1] == 'Company Name'){
					$return = $row[0];				
				}			
			}
		}	
		return $return;		
	}

	function fetchOpprCSno($sno){
		global $db,$username;
		$selQry = "SELECT csno FROM staffoppr_oppr WHERE sno =".$sno;
		$res = mysql_query($selQry,$db);
		$return = '';
		if(mysql_num_rows($res) > 0 ){
			$row = mysql_fetch_row($res);
			$return = $row[0];
		}
		return $return;
	}
	
	function fetchCompanyCSno($sno){
		global $db,$username;
		$selQry = "SELECT csno FROM staffoppr_contact WHERE sno =".$sno;
		$res = mysql_query($selQry,$db);
		$return = '';
		if(mysql_num_rows($res) > 0 ){
			$row = mysql_fetch_row($res);
			$return = $row[0];
		}
		return $return;
	}	
	function fetchCompanyName($sno){
		global $db,$username;
		$selQry = "SELECT company FROM posdesc WHERE posid =".$sno;
		$res = mysql_query($selQry,$db);
		$return = '';
		if(mysql_num_rows($res) > 0 ){
			$row = mysql_fetch_row($res);			
			$return = $row[0];
		}	
		return $return;
	}
	function fetchCustomSortOrder_pob($moduleId,$cvsid=0){
		global $db,$username;
		
		if(!empty($cvsid) && $cvsid!=0)
		{
			$selQery = "SELECT cgucols.column_order,cgcols.column_name
					FROM udv_grids_savedsearch cg
						LEFT JOIN udv_grids_usercolumns cgucols ON cgucols.savedsearch_id = cg.id AND cgucols.custom_grid_id=0
						LEFT JOIN udv_grid_columns cgcols ON cgcols.id = cgucols.custom_grid_column_id
						LEFT JOIN udf_form_modules cfm ON cfm.module_id = cgcols.custom_form_modules_id
					WHERE cg.custom_form_modules_id = $moduleId
					AND cg.cuser = $username
					AND cg.id = $cvsid
					AND cgcols.udfstatus = 1 
					ORDER BY cgucols.column_order asc";
		}else
		{
			$selQery = "SELECT cgucols.column_order,cgcols.column_name
					FROM udv_grids cg
						LEFT JOIN udv_grids_usercolumns cgucols ON cgucols.custom_grid_id = cg.id
						LEFT JOIN udv_grid_columns cgcols ON cgcols.id = cgucols.custom_grid_column_id
						LEFT JOIN udf_form_modules cfm ON cfm.module_id = cgcols.custom_form_modules_id
					WHERE cg.custom_form_modules_id = $moduleId
					AND cg.cuser = $username
					AND cgcols.udfstatus = 1 
					ORDER BY cgucols.column_order asc";
		}	
		
		$res=mysql_query($selQery,$db);
		$return = '';
		if(mysql_num_rows($res)> 0){
			while($row = mysql_fetch_row($res)){
			  
				if($row[1] == 'POB Status'){
					$return = $row[0];				
				}			
			}
		}	
		return $return;		
	}
	function buildContacts($que,$colNumber,$cvsid=0,$module)
	{
		global $maildb,$db,$stat,$pageFrom, $username;
		
		$pos = strpos($_SERVER['SCRIPT_FILENAME'],"Admin/Data_Mngmt");
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("contacts",$username,$cvsid);
		
		// Why we are adding 1 becoz in the below for loop , they are considering 0 as checkbox value.
	    $customSortOrderVal = $this->fetchCustomSortOrder(1,$cvsid);	
		if($customSortOrderVal != '')		
			$returnVal = 1 + $this->fetchCustomSortOrder(1,$cvsid);
		else
			$returnVal = '';
			
		// Why we are adding 1 becoz in the below for loop , they are considering 0 as checkbox value.
	    $customSortOrderVal_pob = $this->fetchCustomSortOrder_pob(1,$cvsid);	
		if($customSortOrderVal_pob != '')		
			$returnVal_pob = 1 + $this->fetchCustomSortOrder_pob(1,$cvsid);
		else
			$returnVal_pob = '';
		
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_row($res))
		{
			/*
			if($colNumber == 8)
			{
				$dispCategory = $row[7];
			}
			else
			{
				$dispCategory = convertCategory($row[7]);
			}
			*/
			$fetchCmpyCsno = $this->fetchCompanyCSno($row[0]);
			if($stat=="ER")
			{
				if(!empty($grdi_details) && $pos <= 0)
				{
					for($i=0;$i<count($row);$i++)
					{
						if($i == 0)
						{
							$contactCheckboxVal = $this->getContactCheckBoxValue($row[$i]);							
							$cont_send = "";
							$cont_send = $contactCheckboxVal['fname']." ".$contactCheckboxVal['lname']."^".$contactCheckboxVal['ds_pobstatus'];
							
							$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value='".$contactCheckboxVal['sno']."|".html_tls_specialchars($contactCheckboxVal['name'],ENT_QUOTES)."|".$contactCheckboxVal['owner']."|".$contactCheckboxVal['share_type']."|".$j."|".html_tls_specialchars(stripslashes($contactCheckboxVal['fname']),ENT_QUOTES)."'><span class='checkmark'></span></label><input type='hidden' id='email_flag_name_".$contactCheckboxVal['sno']."' name='email_flag_name[]' value='".$this->convertSpecChars($contactCheckboxVal['email_flag_name'])."'><input type='hidden' id='cand_email_".$contactCheckboxVal['sno']."' name='cand_email[]' value='".$this->convertSpecChars($contactCheckboxVal['con_email_id'])."'><input type='hidden' id='cand_ds_pob_".$contactCheckboxVal['sno']."' name='cand_ds_pob[]' value='".$this->convertSpecChars(stripslashes($cont_send))."'>";
						}
						else
						{
							
							if($returnVal == $i && $customSortOrderVal !=''){
							    $hyperLink = "<a href=javascript:showComp('".$fetchCmpyCsno."','".$module."')>".stripslashes($row[$i])."</a>";
								$grid[$j][$i]= $hyperLink;
							}else if($returnVal_pob == $i && $customSortOrderVal_pob !=''){
								
								$hyperLink_pob = "<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcont')>".ucwords($this->convertSpecChars($row[$i]))."</a>";
								$grid[$j][$i]= $hyperLink_pob;
							}else{	
								$grid[$j][$i]= $this->convertSpecChars(stripslashes($row[$i]));
							}
						}
					}				
					
					$grid[$j][count($row)]= '';				
					$grid[$j][(count($row)+1)]= "/BSOS/Marketing/Lead_Mngmt/reviewContact.php?addr=".$row[0]."&contasno=".$row[0]."&sesvar=new&module=".$module;		
				}
				else
				{
					if($colNumber == 8)
					{
						$dispCategory = $row[7];
					}
					else
					{
						$dispCategory = convertCategory($row[7]);
					}
					// POB Status Icon
					
				
					$cont_send = "";
					$cont_send = $row[1]." ".$row[2]."^".$row[16];
					
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value='".$row[0]."|".html_tls_specialchars($row[9],ENT_QUOTES)."|".$row[10]."|".$row[8]."|".$j."|".html_tls_specialchars(stripslashes($row[1]),ENT_QUOTES)."'><span class='checkmark'></span></label>
					<input type='hidden' id='email_flag_name_".$row[0]."' name='email_flag_name[]' value='".$this->convertSpecChars($row[14])."'>
					<input type='hidden' id='cand_email_".$row[0]."' name='cand_email[]' value='".$this->convertSpecChars($row[15])."'>
					<input type='hidden' id='cand_ds_pob_".$row[0]."' name='cand_ds_pob[]' value='".$this->convertSpecChars($cont_send)."'>";
					$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
					$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
					$grid[$j][3]=stripslashes($row[3]);
					$grid[$j][4]=$this->convertSpecChars(stripslashes($row[13]));
					$grid[$j][5]=$this->convertSpecChars(stripslashes($row[4]));
					$grid[$j][6]=$this->convertSpecChars(stripslashes($row[5]));
					$grid[$j][7]=$this->convertSpecChars(stripslashes($row[6]));
					$grid[$j][8]=$this->convertSpecChars(stripslashes($dispCategory));
					$grid[$j][9]=$this->convertSpecChars(stripslashes($row[8]));
					$grid[$j][10]=$this->convertSpecChars(stripslashes($row[9]));
					$grid[$j][11]=$this->convertSpecChars($row[11]);
					$grid[$j][12]=$this->convertSpecChars($row[12]);
					$grid[$j][13]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcont')>".ucwords($this->convertSpecChars($row[16]))."</a>";
					$grid[$j][14]='';
					$grid[$j][15]="/BSOS/Marketing/Lead_Mngmt/reviewContact.php?addr=$row[0]&contasno=$row[0]&sesvar=new&module=".$module;
				}
			}
			else
			{		
				if($colNumber == 8)
				{
					$dispCategory = stripslashes($row[7]);
				}
				else
				{
					$dispCategory = convertCategory(stripslashes($row[7]));
				}
					
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[9]."|".$row[10]."|".$row[8]."|".$j."'><span class='checkmark'></span></label>";
				$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
				$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][3]=stripslashes($row[3]);
				$grid[$j][4]=$this->convertSpecChars(stripslashes($row[4]));
				$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
				$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
				$grid[$j][7]=$this->convertSpecChars(stripslashes($dispCategory));
				$grid[$j][8]=$this->convertSpecChars(stripslashes($row[9]));
				$grid[$j][9]="";
				$grid[$j][10]="";
				$grid[$j][11]="";
				$grid[$j][12]="";
				$grid[$j][13]="";
				$grid[$j][14]="/BSOS/Marketing/Lead_Mngmt/hisreviewmanage.php?addr=$row[0]&contasno=$row[0]";
			}
			$j++;
		}
		return $grid;
	}
	
	function getCandidateCheckBoxValue($sno)
	{
		global $username;
		$sel_CandidateCheckBoxValue="SELECT
			candidate_list.sno as sno,
			candidate_list.username as username,
			candidate_list.profiletitle profiletitle,
			candidate_list.fname as fname,
			candidate_list.lname as lname,
			candidate_list.recentemp as company,
			candidate_list.owner as owner,
			candidate_list.email as email,
			candidate_list.hphone as hphone,
			candidate_list.areacode as areacode,
			candidate_list.hareacode as hareacode, 
			candidate_list.wareacode as wareacode, 
			candidate_list.mareacode as mareacode, 
			candidate_list.city as city,
			candidate_list.state as state,
			candidate_list.zip as zip,
			candidate_list.resid as resid,
			IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='".$username."','My Candidate','Candidate')) as candtype,
			IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='".$username."','Private','Share')) as shrtype,
			candidate_list.resid as resid ,
			IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', IF(candidate_list.other_email = '', candidate_list.fname, ''), ''), '') as email_flag_name,
                IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', candidate_list.other_email, candidate_list.alternate_email), candidate_list.email) as cand_email_id,
				candidate_list.ds_pobstatus as pobstatus
			from candidate_list where candidate_list.sno = ".$sno;
		
		$res_CandidateCheckBoxValue = mysql_query($sel_CandidateCheckBoxValue);
		$rec_CandidateCheckBoxValue = mysql_fetch_assoc($res_CandidateCheckBoxValue);
		return($rec_CandidateCheckBoxValue);
	}
	
	// Candidates Grid Data 
	function buildCandidates($que,$gridSortCol,$gridSort,$cvsid)
	{
		global $maildb,$db, $username;

		$gd=new gridData();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("candidates",$username,$cvsid);
		
		// Why we are adding 1 becoz in the below for loop , they are considering 0 as checkbox value.
	    $customSortOrderVal_pob = $this->fetchCustomSortOrder_pob(3,$cvsid);	
		if($customSortOrderVal_pob != '')		
			$returnVal_pob = 1 + $this->fetchCustomSortOrder_pob(3,$cvsid);
		else
			$returnVal_pob = '';
		
		$j=0;
		$grid=array();
		$grid_header = array();
		$res=mysql_query($que,$db);
		
		if(!empty($grdi_details))
		{
			$res_grid_headers = mysql_query($que,$db);
			
			while($rec_grid_headers = mysql_fetch_field($res_grid_headers))
			{
				$grid_header[] = strtolower($rec_grid_headers->name);
			}
			//array_unshift($grid_header,"sno");
			
			while ($row=mysql_fetch_row($res))
			{
				$grid_cols = 0;
				for($i=0;$i<count($row);$i++)
				{					
					if($i == 0)
					{
						$candidateCheckboxVal = $this->getCandidateCheckBoxValue($row[$i]);
						if((trim($candidateCheckboxVal['fname']).trim($candidateCheckboxVal['lname']))=="")
							$candAlert=trim($candidateCheckboxVal['profiletitle']);
						else
							$candAlert=trim(trim($candidateCheckboxVal['fname'])." ".trim($candidateCheckboxVal['lname']));
							$cand_send = "";
						$cand_send = $candidateCheckboxVal['fname']." ".$candidateCheckboxVal['lname']."^".$candidateCheckboxVal['pobstatus'];
						$grid[$j][$grid_cols++]="<label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value='".$candidateCheckboxVal['sno']."|".html_tls_specialchars($candidateCheckboxVal['candtype'],ENT_QUOTES)."|".$candidateCheckboxVal['owner']."|".$candidateCheckboxVal['shrtype']."|".html_tls_specialchars($candAlert,ENT_QUOTES)."|".$j."|".html_tls_specialchars($candidateCheckboxVal['username'],ENT_QUOTES)."'><span class='checkmark'></span></label>
						<input type=hidden id='email_flag_name_".$candidateCheckboxVal['sno']."' name='email_flag_name[]' value='".$this->convertSpecChars($candidateCheckboxVal['email_flag_name'])."'>
						<input type='hidden' id='cand_email_".$candidateCheckboxVal['sno']."' name='cand_email[]' value='".$this->convertSpecChars($candidateCheckboxVal['cand_email_id'])."'>
						<input type='hidden' id='cand_ds_pob_".$candidateCheckboxVal['sno']."' name='cand_ds_pob[]' value='".$this->convertSpecChars($cand_send)."'>
						";
					}
					else
					{
						if($grid_header[$i] == "desirejob")
						{
							
							if($row[$i] == ''){
								$grid[$j][$grid_cols++] = '';
							}else{
								$desiredJob = explode('|',$row[$i]);
								$desiredJob = array_filter($desiredJob);
								$grid[$j][$grid_cols++] = implode(',',$desiredJob);
							}
						}elseif($returnVal_pob == $i && $customSortOrderVal_pob !=''){
					
							    $hyperLink_pob = "<a style='color: #0099ff;'  href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcand')>".ucwords($this->convertSpecChars($row[$i]))."</a>";
								$grid[$j][$grid_cols++]= $hyperLink_pob;
								
						}elseif(strtolower($grid_header[$i]) == "caregiver_id"){
					
							    $prophecy_viewLink='';
								if($row[$i] !=''){
									$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row[$i]."','crmcandidates')>View</a>";
								}
								$grid[$j][$grid_cols++]= $prophecy_viewLink;
								
						}elseif(strtolower($grid_header[$i]) == "eskill_email"){
					
							    $eskill_viewLink='';
								if($row[$i] !=''){
									$eskill_viewLink = "<a href=javascript:viewEskillResults('".$row[$i]."','Candidates','".$row[0]."')>View</a>";
								}
								$grid[$j][$grid_cols++]= $eskill_viewLink;
								
						}elseif(strtolower($grid_header[$i]) == "wotc_mja_status") 
                                                {
                                                        // WOTC-MJA condition
                                                        $grid[$j][$grid_cols++]=ucfirst($this->convertSpecChars($row[$i]));
                                                }  
                                                else 
                                                {
                                                        $grid[$j][$grid_cols++] = $this->convertSpecChars($row[$i]);
                                                }

						// Zipcode Radius (ZCR) Condition
						if(strtolower($grid_header[$i]) == "zip")
						{
							if(isset($_SESSION['SPHINX_Candidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_Candidates']))
							{
								$zipMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['savezipCODE']);
								$grid[$j][$grid_cols++] = $_SESSION['ZCR_SPHINX_Candidates'][$zipMilesArr[1]][$row[$i]];
							} else {
								$grid[$j][$grid_cols++]="";
							}
						}
						// Areacode Radius (ACR) Condition
						if(strtolower($grid_header[$i]) == "hphone")
						{
							if(isset($_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_Candidates']))
							{
								$areaMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']);
								$grid[$j][$grid_cols++] = $gd->getAreaCodeRadiusPSM($row[0],'candidate_list',$areaMilesArr[1],'ACR_SPHINX_Candidates');                           
							} else {
								$grid[$j][$grid_cols++]="";
							}
						}
					}
					
				}				
				$resume_link = "";
				if($candidateCheckboxVal['resid']!="" && $candidateCheckboxVal['resid']!=0)
					$resume_link="<a href=getresume.php?fsno=".$candidateCheckboxVal['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
				
				/*
				 *$grid[$j][count($row)]= $resume_link;				
				
				$grid[$j][count($row)+1]= '';				
				$grid[$j][(count($row)+2)]= "/BSOS/Marketing/Candidates/review.php?cno=".$row[0]."&dest=0";
				*/
				$grid[$j][$grid_cols++]= $resume_link;				
				
				$grid[$j][$grid_cols++]= '';				
				$grid[$j][$grid_cols++]= "/BSOS/Marketing/Candidates/review.php?cno=".$row[0]."&dest=0&module=CRM";
				$j++;
			}
		}
		else
		{
			while ($row=mysql_fetch_array($res))
			{
				if((trim($row['fname']).trim($row['lname']))=="")
					$candAlert=trim($row['profiletitle']);
				else
					$candAlert=trim(trim($row['fname'])." ".trim($row['lname']));
	
	
					$cand_send = "";
					$cand_send = $row['fname']." ".$row['lname']."^".$row['pobstatus'];
					
					
				$resume_link = "";
				if($row['resid']!="" && $row['resid']!=0)
					$resume_link="<a href=getresume.php?fsno=".$row['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
			
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row['sno']."|".$row['candtype']."|".$row['owner']."|".$row['shrtype']."|".html_tls_specialchars($candAlert,ENT_QUOTES)."|".$j."|".$row['username']."'><span class='checkmark'></span></label>
				<input type=hidden id='email_flag_name_".$row['sno']."' name='email_flag_name[]' value='".$this->convertSpecChars($row['email_flag_name'])."'><input type='hidden' id='cand_email_".$row['sno']."' name='cand_email[]' value='".$this->convertSpecChars($row['cand_email_id'])."'><input type='hidden' id='cand_ds_pob_".$row['sno']."' name='cand_ds_pob[]' value='".$this->convertSpecChars($cand_send)."'>
				";
				$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
				$grid[$j][2]=$this->convertSpecChars($row['fname']);
				$grid[$j][3]=$this->convertSpecChars($row['lname']);
				$grid[$j][4]=$this->convertSpecChars($row['company']);
				$grid[$j][5]=$this->convertSpecChars($row['email']);
				$grid[$j][6]=$this->convertSpecChars($row['hphone']);
				$grid[$j][7]=$this->convertSpecChars($row['wphone']);
				$grid[$j][8]=$this->convertSpecChars($row['mobile']);
	
				// Areacode Radius (ACR) Condition
				if(isset($_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_Candidates']))
				{
					$areaMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']);
					if(isset($_SESSION['ACR_SPHINX_Candidates'][$areaMilesArr[1]][$row['hareacode']]))
					{
						$grid[$j][9] = $_SESSION['ACR_SPHINX_Candidates'][$areaMilesArr[1]][$row['hareacode']];
					} else if(isset($_SESSION['ACR_SPHINX_Candidates'][$areaMilesArr[1]][$row['wareacode']])) {
						$grid[$j][9] = $_SESSION['ACR_SPHINX_Candidates'][$areaMilesArr[1]][$row['wareacode']];
					} else {
						$grid[$j][9] = $_SESSION['ACR_SPHINX_Candidates'][$areaMilesArr[1]][$row['mareacode']];
					}
				} else {
					$grid[$j][9]="";
				}

				$grid[$j][10]=$this->convertSpecChars($row['city']);
				$grid[$j][11]=$this->convertSpecChars($row['state']);
				$grid[$j][12]=$this->convertSpecChars($row['zip']);

				// Zipcode Radius (ZCR) Condition
				if(isset($_SESSION['SPHINX_Candidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_Candidates']))
				{
					$zipMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['savezipCODE']);
					$grid[$j][13] = $_SESSION['ZCR_SPHINX_Candidates'][$zipMilesArr[1]][$row['zip']];
				} else {
					$grid[$j][13]="";
				}
	
				$grid[$j][14]=$this->convertSpecChars($row['candtype']);
				$grid[$j][15]=$this->convertSpecChars($row['mgname']);
				$grid[$j][16]=$this->convertSpecChars($row['shrtype']);
				$grid[$j][17]=$this->convertSpecChars($row['candavl']);
				$grid[$j][18]=$this->convertSpecChars($row['owname']);	
				$grid[$j][19]=$this->convertSpecChars($row['source']);			
				$grid[$j][20]=$this->convertSpecChars($row['sourcetype']);			
				$grid[$j][21]=$this->convertSpecChars($row['crdate']);
				$grid[$j][22]=$this->convertSpecChars($row['mddate']);
				$grid[$j][23]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcand')>".ucwords($this->convertSpecChars($row['pobstatus']))."</a>";
				$grid[$j][24]=ucfirst($this->convertSpecChars($row['wotc_mja_status']));		//WOTC MJA Status
				$prophecy_viewLink='';
				if($row['caregiver_id'] !=''){
					$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row['caregiver_id']."','crmcandidates')>View</a>";
				}
				$grid[$j][25]=$prophecy_viewLink;
                                
                                $eskill_viewLink='';
				if($row['eskill_email'] !=''){
					$eskill_viewLink = "<a href=javascript:viewEskillResults('".$row['eskill_email']."','Candidates','".$row['sno']."')>View</a>";
				}
				$grid[$j][26]=$eskill_viewLink;
				$grid[$j][27]=$resume_link;			
				$grid[$j][28]="";
				$grid[$j][29]="/BSOS/Marketing/Candidates/review.php?cno=".$row['sno']."&dest=0";
				$j++;
			}
		}
		return $grid;
	}

	function orderByPHP($data, $field, $sort)
	{
		if($sort=="ASC")
			$code = "return strnatcmp(\$a['$field'], \$b['$field']);";
		else
			$code = "return strnatcmp(\$b['$field'], \$a['$field']);";
		usort($data, create_function('$a,$b', $code));
		return $data;
	}

	// CRM-Candidates
	function getCandidates($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$user_timezone,$tempvalue,$pageFrom,$groupId,$cvsid;
		
		$searchCond="";
		$duplicateCheck = ""; // For candidates duplicate checking
		$crmGroupTable="";
		$crmGroupCondition = "";

		$gd=new gridData();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("candidates",$username, $cvsid);

		if(!empty($grdi_details))
		{
			
			$asFields = $custom_grid_function_obj->asFields("candidates", $username, $cvsid);
			

			///////////////////////////// SS FIELDS GENERATION //////////////////////////////
			
			$ssFields = $custom_grid_function_obj->ssFields("candidates", $username, $cvsid);
			$ss_string_org = implode(",",$ssFields);
			$ss_string = implode("^",$ssFields);

			$ss_zip_pos = strpos($ss_string, "zip");
			if($ss_zip_pos > 0)
			{
				$ss_zip_pos = (strpos($ss_string, "zip")+strlen("zip"))+1;
				
				if($ss_zip_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."^ZCR ".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."ZCR^".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}

			$ss_acr_pos = strpos($ss_string, "hphone");
			if($ss_acr_pos > 0)
			{
				$ss_acr_pos = (strpos($ss_string, "hphone")+strlen("hphone"))+1;
				
				if($ss_acr_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."^ACR ".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."ACR^".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}

			$ssFieldsZcrAcr = $ssFields;

			for($wpindex = 0; $wpindex < count($ssFields); $wpindex++)
			{
				$wpflag = strpos($ssFields[$wpindex],"hphone");
				if($wpflag >0)
				{			
					$ssFields[$wpindex+1] = $ssFields[$wpindex];
					break;
				}
			}
			
			for($zipindex = 0; $zipindex < count($ssFields); $zipindex++)
			{
				$zipflag = strpos($ssFields[$zipindex],"zip");
				if($zipflag >0)
				{			
					$ssFields[$zipindex+1] = $ssFields[$zipindex];
					break;
				}
			}
			
			
			///////////////////////////// END SS FIELDS GENERATION //////////////////////////////
			
			$oque = $custom_grid_function_obj->queryBuilder("candidates", $username ,$cvsid);
			$tque = $custom_grid_function_obj->countQueryBuilder("candidates", $username ,$cvsid);
			
			if(trim($gridExtraFields['resume'])=="" || ($gridExtraFields['SpeedSearchString']=='' && $gridExtraFields['SpeedSearchString']=='?'))
			{
				// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
				foreach($ssFields as $ssFields_key => $ssFields_value) {
					if (strpos($ssFields_value, 'desirejob') !== false) {
					   $asFieldsKey = $ssFields_key;
					   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
					}
				}
			
			}
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			//$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('candidate_list.hphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.hphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.wphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.wphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.mobile',$asFields)){
				$asFieldsKey = array_search("candidate_list.mobile", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
			}

			$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'candidates');
			
			if($gridSortCol == 100){
				$ostr = " ORDER BY candidate_list.mtime DESC";				
			}else{  
                                $sortFlag = 0;				
                                if(is_array($ssFieldsZcrAcr))
                                {
                                    if(strpos($ssFieldsZcrAcr[$gridSortCol], 'availsdate') !== false){
                                        $tableAliasValue = explode('.availsdate',substr($ssFieldsZcrAcr[$gridSortCol],3,20)); 
                                        $ostr ="ORDER BY IF(".$tableAliasValue[0].".availsdate = 'inactive', 'Inactive', IF((".$tableAliasValue[0].".availsdate = '0-0-0' OR ".$tableAliasValue[0].".availsdate = '' OR ".$tableAliasValue[0].".availsdate IS NULL OR ".$tableAliasValue[0].".availsdate = 'immediate'),'Immediate', IF((datediff(".$tableAliasValue[0].".availsdate, now())) < 0,'Immediate', DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availsdate, '%Y-%m-%d'), '%Y-%m-%d')))) ".$gridSort ;
                                        $sortFlag = 1;	
                                    }
                                    if(strpos($ssFieldsZcrAcr[$gridSortCol], 'availedate') !== false){
                                        $tableAliasValue = explode('.availedate',substr($ssFieldsZcrAcr[$gridSortCol],4,20)); 
                                        $ostr ="ORDER BY IF((".$tableAliasValue[0].".availedate = '0-0-0' OR ".$tableAliasValue[0].".availedate = '' OR ".$tableAliasValue[0].".availedate IS NULL),'' ,DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availedate, '%Y-%m-%d'), '%Y-%m-%d')) ".$gridSort;
                                        $sortFlag = 1;	
                                    }
                                }
                                
                                if($sortFlag==0){
                                   $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFieldsZcrAcr); // Order by fields, append the where clause accordingly 
                                }
				
			}	
			
			if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
			{
				//require("searchdatabase.inc");

				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);

				require("quickSubCandidates.inc");
				
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
				$customesearch = true;
				
				require("visualsearch_candidates.php");
				require("database.inc");
			}
			
			if(empty($aqstr))
				$aqstr = '';

			if($pageFrom == "crmGroups") {
				$crmGroupTable=" LEFT JOIN crmgroup_details ON crmgroup_details.refid = candidate_list.sno ";
				$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."'";
			}
			else
			{
				$crmGroupTable="";
				$crmGroupCondition = "";
			}
			
			if(($gridExtraFields['frm_ws_id']=="SHOWCAND" || $gridExtraFields['frm_ws_id']=="SHOWCANDPARSE") && $gridExtraFields['frm_ws_email']!="")
			{
				// Displaying candidates for SHOW CANDIDATE Button from OUTLOOK
				$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
				$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
			}
			if($gridExtraFields['frm_ws_id']=="show_sidebar_cand" && $gridExtraFields['frm_ws_sno']!="")
			{
				// Displaying candidates for SHOW CANDIDATE Button from Browser Plugin
				$oque.= " AND candidate_list.sno='".$gridExtraFields['frm_ws_sno']."'";
				$tque.= " AND candidate_list.sno='".$gridExtraFields['frm_ws_sno']."'";
			}
			$oque_split = explode('where',$oque);
			$oque_built = $crmGroupTable." where ".$oque_split[(count($oque_split)-1)];
			array_pop($oque_split);
			$oque = implode(" where ",$oque_split);
			$oque = $oque.$oque_built;

			$tque_split = explode('where',$tque);
			$tque_built = $crmGroupTable." where ".$tque_split[(count($tque_split)-1)];
			array_pop($tque_split);
			$tque = implode(" where ",$tque_split);
			$tque = $tque.$tque_built;

			if($gridExtraFields['duplicate'] == 'yes')
				$qstr = $gd->duplicateCandidateChecking($gridExtraFields['duplicateCandfname'],$gridExtraFields['duplicateCandlname'],$gridExtraFields['duplicateCandemail']);				

			// This query will give us the total number of records, for that we will remove the limit string.
			$tque .= " $qstr $CompanyCond $grpque $aqstr $crmGroupCondition";
			$oque="$oque $qstr $CompanyCond $grpque $aqstr $crmGroupCondition $ostr $lstr";

			// This function will give us the total number of records.			
			$total=$gd->getTotalRows($tque);
		}
		else
		{
			$tque="SELECT count(1) ";
	
			$oque="SELECT
			candidate_list.sno as sno,
			candidate_list.username as username,
			candidate_list.profiletitle profiletitle,
			candidate_list.fname as fname,
			candidate_list.lname as lname,
			candidate_list.recentemp as company,
			candidate_list.email as email,
			candidate_list.hphone as hphone,
			candidate_list.wphone as wphone,
			candidate_list.areacode as areacode,
			candidate_list.hareacode as hareacode, 
			candidate_list.wareacode as wareacode, 
			candidate_list.mareacode as mareacode, 
			candidate_list.city as city,
			candidate_list.state as state,
			candidate_list.zip as zip,
			candidate_list.mobile as mobile,
			candidate_list.ds_pobstatus as pobstatus,
			IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as candtype,
			IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share')) as shrtype,
			IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail))) as candavl,
			users.name as owname,
			".tzRetQueryStringDTime('candidate_list.ctime','Date','/')." as crdate,
			".tzRetQueryStringDTime('candidate_list.mtime','Date','/')." as mddate,
			candidate_list.resid as resid,
			candidate_list.owner as owner,
			manage.name as mgname, 
			candidate_list.cl_source as source,
			mg.name as sourcetype,
			IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', IF(candidate_list.other_email = '', candidate_list.fname, ''), ''), '') as email_flag_name,
                IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', candidate_list.other_email, candidate_list.alternate_email), candidate_list.email) as cand_email_id, candidate_list.wotc_mja_status,pc.caregiver_id,veas.email as eskill_email";
			if(trim($gridExtraFields['resume'])=="" || ($gridExtraFields['SpeedSearchString']=='' && $gridExtraFields['SpeedSearchString']=='?'))
			{
					// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
					foreach($ssFields as $ssFields_key => $ssFields_value) {
						if (strpos($ssFields_value, 'desirejob') !== false) {
						   $asFieldsKey = $ssFields_key;
						   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
						}
					}
				}
			//Added by vijaya to provide checking for duplicate candidates.		
			if($gridExtraFields['duplicate']== "yes")
			{
				$gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
				$gridSearchFields[2] = $gd->gridSearchFieldConvert($gridSearchFields[2]);
				$gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);
	
				$duplicateCheck = $gd->duplicateCandidateChecking($gridSearchFields[1],$gridSearchFields[2],$gridSearchFields[4]);
			}
			else
			{
				if(trim($gridExtraFields['resume'])!=""  || ($gridExtraFields['SpeedSearchString']!='' &&  $gridExtraFields['SpeedSearchString']!='?'))
				{
					//require("searchdatabase.inc");

					$setQry = "SET SESSION group_concat_max_len=1073740800";
					mysql_query($setQry,$db);
	
					require("quickSubCandidates.inc");
					
					$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);
					
					require("visualsearch_candidates.php");
					require("database.inc");
				}
				
			}
	
			if($aqstr=="")
				$aqstr=" 1=1 ";
			
			if($pageFrom == "crmGroups") 
			{
				$crmGroupTable="crmgroup_details,";
				$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."' AND crmgroup_details.refid=candidate_list.sno";
			}		
	
			$tque.=" FROM ".$searchCond.$crmGroupTable." candidate_list
			LEFT JOIN users ON candidate_list.owner=users.username
			LEFT JOIN manage ON candidate_list.cl_status=manage.sno 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN prophecy_caregivers pc ON pc.username = candidate_list.username AND module='Candidates'
			LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = candidate_list.email";
	
			$tque.=" WHERE candidate_list.status='ACTIVE' ".$crmGroupCondition." AND (candidate_list.owner='$username' OR FIND_IN_SET('$username',candidate_list.accessto )>0 OR candidate_list.accessto='ALL') AND ".$aqstr." ";
			$oque.=" FROM ".$searchCond.$crmGroupTable." candidate_list
			LEFT JOIN users ON candidate_list.owner=users.username
			LEFT JOIN manage ON candidate_list.cl_status=manage.sno
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN prophecy_caregivers pc ON pc.username = candidate_list.username AND module='Candidates'
            LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = candidate_list.email";
	            
			$oque.=" WHERE candidate_list.status='ACTIVE' ".$crmGroupCondition." AND (candidate_list.owner='$username' OR FIND_IN_SET('$username',candidate_list.accessto )>0 OR candidate_list.accessto='ALL') AND ".$aqstr." ";
	
			if($gridExtraFields['checklist'] != '')
			{
				//Duplicate Candidates matching ID from Duplicate screen
				$oque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";
				$tque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";		
			}
			if(($gridExtraFields['frm_ws_id']=="SHOWCAND" || $gridExtraFields['frm_ws_id']=="SHOWCANDPARSE") && $gridExtraFields['frm_ws_email']!="")
			{
				// Displaying candidates for SHOW CANDIDATE Button from OUTLOOK
				$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
				$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
			}
			if($gridExtraFields['frm_ws_id']=="show_sidebar_cand"  && $gridExtraFields['frm_ws_sno']!="")
			{
	            // Displaying candidates for SHOW CANDIDATE Button from Browser Plugin
				$oque.= " AND candidate_list.sno='".$gridExtraFields['frm_ws_sno']."'";
				$tque.= " AND candidate_list.sno='".$gridExtraFields['frm_ws_sno']."'";
			
			}
			
			$asFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","ACR","candidate_list.city","candidate_list.state","candidate_list.zip","ZCR","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share'))","IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail)))","users.name","candidate_list.cl_source","mg.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/'),tzRetQueryStringDTime('candidate_list.mtime','Date','/'),"candidate_list.ds_pobstatus","candidate_list.wotc_mja_status","pc.caregiver_id","eskill_email","");
	
			$ssFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","ACR","candidate_list.city","candidate_list.state","candidate_list.zip","ZCR","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share'))","IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail)))","users.name","candidate_list.cl_source","mg.name","candidate_list.ctime","candidate_list.mtime","candidate_list.ds_pobstatus","candidate_list.wotc_mja_status","pc.caregiver_id","eskill_email","");
			
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
			
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
	
			$CandiateCond = "";
	
			if($gridSearchFields[13] != "")
			{
				$CandiateCond.=" AND IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) = '".$gridSearchFields[13]."' ";
				$gridSearchFields[13] = "";
			}
	
			if($gridSearchFields[14] != "")
			{
				$CandiateCond.=" AND manage.name = '".$gridSearchFields[14]."' ";
				$gridSearchFields[14] = "";
			}
			// Replacing phone number fields query field to map any numbers or with -,(,)'s and spaces.
			if(in_array('candidate_list.hphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.hphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.wphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.wphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.mobile',$asFields)){
				$asFieldsKey = array_search("candidate_list.mobile", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
			}

			if($gridExtraFields['duplicate']!="yes")
				$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			else
				$qstr=$duplicateCheck;
	
			$tque=$gd->buildTQuery($tque,$qstr.$CandiateCond,$gstr);
			$oque=$gd->buildOQuery($oque,$qstr.$CandiateCond,$ostr,$lstr,$gstr);
	
			$tres = mysql_query($tque,$db);
			$total = mysql_num_rows($tres);
			if($total == 1)
			{
				$trow = mysql_fetch_row($tres);
				$total = $trow[0];
			}
		}
		
		// ZCR order by condition 
		if(isset($_SESSION['SPHINX_Candidates_sub']['savezipCODE']))
		{
			if(isset($_SESSION['ZCR_SPHINX_Candidates'])){
				$zipMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['savezipCODE']);
				$ZcrSortArr = $_SESSION['ZCR_SPHINX_Candidates'];

				asort($ZcrSortArr[$zipMilesArr[1]]);

				$ZcrOrderByQry = "'".implode("','",array_keys($ZcrSortArr[$zipMilesArr[1]]))."'";

				$oque = str_replace("ZCR","field(candidate_list.zip,".$ZcrOrderByQry.")",$oque);
			} else {
				$oque = str_replace("ZCR","candidate_list.zip",$oque);
			}
		} else {
			$oque = str_replace("ZCR","candidate_list.zip",$oque);
		}

		// ACR order by condition 
		if(isset($_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']))
		{
			if(isset($_SESSION['ACR_SPHINX_Candidates'])){
				$areaMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']);
				$AcrSortArr = $_SESSION['ACR_SPHINX_Candidates'];

				asort($AcrSortArr[$areaMilesArr[1]]);

				$AcrOrderByQry = "'".implode("','",array_keys($AcrSortArr[$areaMilesArr[1]]))."'";

				$oque = str_replace("ACR","field(IF(candidate_list.hareacode IN(".$AcrOrderByQry."),candidate_list.hareacode,IF(candidate_list.wareacode IN(".$AcrOrderByQry."),candidate_list.wareacode,IF(candidate_list.mareacode IN(".$AcrOrderByQry."),candidate_list.mareacode,''))),".$AcrOrderByQry.")",$oque);
			} else {
				$oque = str_replace("ACR","candidate_list.hareacode",$oque);
			}
		} else {
			$oque = str_replace("ACR","candidate_list.hareacode",$oque);
		}

		$gridData=$gd->buildCandidates($oque,$gridSortCol,$gridSort,$cvsid);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$crmGroupCondition,$oque);

		return $objResponse;
	}


	function getContacts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		
		global $maildb,$db,$username,$stat,$user_timezone,$pageFrom,$groupId,$sysdb,$maindb,$companyuser, $cvsid;
		
		if($gridSortCol=="")
			$gridSortCol=1;

		$acs="";//variable for passing access permissions
		$crmGroupTable = "";
		$crmGroupCondition="";//variable for crm groups condition
		$gd=new gridData();

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);

			require("quickSubCandidates.inc");
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);
			$customesearch = true;			
			require("visualsearch_contacts.php");
			require("database.inc");
		}
		else
		{
			$aqstr=" 1=1 ";
		}		
		if($gridSortCol == 8)//Category col header clicked case for sorting...
			$fetchCategory = "getContactCategory(staffoppr_contact.cat_id) cat";
		else
			$fetchCategory = "staffoppr_contact.cat_id cat";

		$tque="SELECT COUNT(1) FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username ".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition.$acs;

		if($stat=="ER")//Active Contacts
		{	
			/////////////////////////////////////
			//// Code for User Defined Views ////
			/////////////////////////////////////		

			$custom_grid_function_obj = new CustomGridFunctions();
			$grdi_details = $custom_grid_function_obj->getGridName("contacts",$username,$cvsid);

			if(!empty($grdi_details))
			{
				if($pageFrom == "crmGroups") 
				{
					$crmGroupTable=" LEFT JOIN crmgroup_details ON crmgroup_details.refid = staffoppr_contact.sno ";
					$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."'";
				}
				else
				{
					$crmGroupTable="";
					$crmGroupCondition = "";
				}

				$asFields = $custom_grid_function_obj->asFields("contacts", $username,$cvsid);
				$ssFields=$custom_grid_function_obj->ssFields("contacts", $username,$cvsid);	
				$oque = $custom_grid_function_obj->queryBuilder("contacts", $username,$cvsid);
				$tque = $custom_grid_function_obj->countQueryBuilder("contacts", $username,$cvsid);

				$oque_split = explode('where',$oque);
				$oque_built = $crmGroupTable." where ".$oque_split[(count($oque_split)-1)];
				array_pop($oque_split);
				$oque = implode(" where ",$oque_split);
				$oque = $oque.$oque_built;

				$tque_split = explode('where',$tque);
				$tque_built = $crmGroupTable." where ".$tque_split[(count($tque_split)-1)];
				array_pop($tque_split);
				$tque = implode(" where ",$tque_split);
				$tque = $tque.$tque_built;

				if(($gridExtraFields['frm_ws_id']=="SHOWCON" || $gridExtraFields['frm_ws_id']=="SHOWCONPARSE") && $gridExtraFields['frm_ws_email']!="")
				{
					// Displaying candidates for SHOW CONTACT Button from OUTLOOK
					$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (staffoppr_contact.email, staffoppr_contact.email_2, staffoppr_contact.email_3) ";
					$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (staffoppr_contact.email, staffoppr_contact.email_2, staffoppr_contact.email_3) ";
				}
                if($gridExtraFields['frm_ws_id']=="show_sidebar_cont" && $gridExtraFields['frm_ws_sno']!="")
			    {
				// Displaying candidates for SHOW CANDIDATE Button from Browser Extension
				$oque.= " AND staffoppr_contact.sno = ".$gridExtraFields['frm_ws_sno']." ";
				$tque.= " AND staffoppr_contact.sno = ".$gridExtraFields['frm_ws_sno']." ";
			     }
			     
				$lstr=$gd->buildLimt($gridPage,$gridRecords);				
				// Sunil wirtten code, Handling the Category filter values					
				
				if(is_array($gridSearchFields)){
					$colOrder = $gd->getColumnOrder();
					// $colOrder == '' then it is restorview.
					if($colOrder !=''){
						// Custom View Logic
						if($gridSearchFields[$colOrder] !=''){													
							$strSno = $gd->getCategoryMatchIds($gridSearchFields[$colOrder]);							
							if($strSno !=''){	
								$gridSearchFields[$colOrder] = '';
								// If entered value does not have 'sno' in DB.
								$expSno = explode(',',$strSno);									
								for($j=0;$j<count($expSno);$j++){
									if($j != count($expSno)-1 )
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) OR ";
									else
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) ";
								}							
								$addQstr = " AND ( $expSnoLoc ) ";							
							}
						}
					}else{
					    //Restore View Logic
						if(!empty($gridSearchFields[7])){
							$selSno = "SELECT sno FROM manage WHERE type='Category' and name ='".$gridSearchFields[7]."'";
							$resSno = mysql_query($selSno,$db);
							if( mysql_num_rows($resSno)>0 ){
								$fetchSno = mysql_fetch_array($resSno);
							}
							if(is_array($fetchSno)){	
								if($fetchSno['sno'] !=''){
									$strSno .= 	$fetchSno['sno'];
									$gridSearchFields[7]= '';							
									$addQstr = " AND ( FIND_IN_SET('".$strSno."',staffoppr_contact.cat_id) ) ";
								}
							}	
						}	
					}				
				}	

				// End here		
				// Replacing phone number fields query field to map any numbers  or with -,(,)'s and spaces.			
				if(in_array('staffoppr_contact.hphone',$asFields)){
					$asFieldsKey = array_search("staffoppr_contact.hphone", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.hphone",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.hphone",$gridSearchFields,$asFieldsKey);
				}
				// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
				if(in_array('staffoppr_contact.wphone',$asFields)){
					$asFieldsKey = array_search("staffoppr_contact.wphone", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.wphone",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.wphone",$gridSearchFields,$asFieldsKey);
				}
				if(in_array('staffoppr_contact.mobile',$asFields)){
					$asFieldsKey = array_search("staffoppr_contact.mobile", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.mobile",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.mobile",$gridSearchFields,$asFieldsKey);
				}
				if(in_array('staffoppr_contact.other',$asFields)){
					$asFieldsKey = array_search("staffoppr_contact.other", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.other",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.other",$gridSearchFields,$asFieldsKey);
				}	


				$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'contacts');				
				if($addQstr != '')
					$qstr = $qstr.$addQstr;
				if($gridSortCol == 100){
					$ostr = " ORDER BY staffoppr_contact.mdate DESC ";				
				}else{
					$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
				}

				if(!empty($aqstr))
					$aqstr = " AND ".$aqstr;
				else
					$aqstr = '';

				if($gridExtraFields['duplicate'] == 'yes')
					$qstr = $gd->duplicateContactChecking($gridExtraFields['duplicateCandfname'],$gridExtraFields['duplicateCandlname'],$gridExtraFields['duplicateCandemail']);				
				
				// This query will give us the total number of records, for that we will remove the limit string.
				$tque .= $qstr.$aqstr.$crmGroupCondition;
				
				$oque= $oque.$qstr.$aqstr.$crmGroupCondition.$ostr.$lstr;
				
				// This function will give us the total number of records.			
				$total=$gd->getTotalRows($tque);
			}
			else
			{
				$asFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.ytitle","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","getContactCategory(staffoppr_contact.cat_id)","IF(staffoppr_contact.accessto='ALL','Public',IF(staffoppr_contact.accessto='$username','Private','Share'))","users.name",tzRetQueryStringDTime('staffoppr_contact.stime','Date','/'),tzRetQueryStringDTime('staffoppr_contact.mdate','Date','/'),"staffoppr_contact.ds_pobstatus");
				$ssFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.ytitle","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","cat","IF(staffoppr_contact.accessto='ALL','Public',IF(staffoppr_contact.accessto='$username','Private','Share'))","trim(users.name)","staffoppr_contact.stime","staffoppr_contact.mdate","staffoppr_contact.ds_pobstatus");
				$acs=" AND (FIND_IN_SET('$username',staffoppr_contact.accessto)>0 OR staffoppr_contact.owner='$username' OR staffoppr_contact.accessto='ALL') ";
				
				if($pageFrom == "crmGroups")
				{
					$crmGroupTable=",crmgroup_details";
					$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."' AND crmgroup_details.refid=staffoppr_contact.sno";
				}
			
				$tque="SELECT COUNT(1) FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition.$acs;

				$oque="SELECT 
				staffoppr_contact.sno, 
				staffoppr_contact.fname,
				staffoppr_contact.lname,
				IF(staffoppr_cinfo.cname = '', staffoppr_cinfo.cname, CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'CRM\')>', staffoppr_cinfo.cname, '</a>')), 
				staffoppr_contact.email,
				staffoppr_contact.wphone,
				staffoppr_contact.state,
				".$fetchCategory.", IF(staffoppr_contact.accessto='ALL','Public',IF(staffoppr_contact.accessto='$username','Private','Share')),users.name,staffoppr_contact.owner,".tzRetQueryStringDTime('staffoppr_contact.stime','Date','/').",".tzRetQueryStringDTime('staffoppr_contact.mdate','Date','/').",staffoppr_contact.ytitle,
				IF(staffoppr_contact.email = '', IF(staffoppr_contact.email_2 = '', IF(staffoppr_contact.email_3 = '', CONCAT(staffoppr_contact.fname,staffoppr_contact.lname), ''), ''), '') as email_flag_name,
				IF(staffoppr_contact.email!='',staffoppr_contact.email,IF(staffoppr_contact.email_2!='',staffoppr_contact.email_2,IF(staffoppr_contact.email_3!='',staffoppr_contact.email_3,''))) as con_email_id,
				staffoppr_contact.ds_pobstatus  
				FROM staffoppr_contact 
				LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition.$acs;
				
				if(($gridExtraFields['frm_ws_id']=="SHOWCON" || $gridExtraFields['frm_ws_id']=="SHOWCONPARSE") && $gridExtraFields['frm_ws_email']!="")
				{
					// Displaying candidates for SHOW CONTACT Button from OUTLOOK
					$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (staffoppr_contact.email, staffoppr_contact.email_2, staffoppr_contact.email_3) ";
					$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (staffoppr_contact.email, staffoppr_contact.email_2, staffoppr_contact.email_3) ";
				}
				if($gridExtraFields['frm_ws_id']=="show_sidebar_cont" && $gridExtraFields['frm_ws_sno']!="")
			    {
				// Displaying candidates for SHOW CANDIDATE Button from Browser Extension
				$oque.= " AND staffoppr_contact.sno = ".$gridExtraFields['frm_ws_sno']." ";
				$tque.= " AND staffoppr_contact.sno = ".$gridExtraFields['frm_ws_sno']." ";
			     }
				$lstr=$gd->buildLimt($gridPage,$gridRecords);
				// Sunil wirtten code, Handling the Category filter values					
				if(is_array($gridSearchFields)){
					$colOrder = $gd->getColumnOrder();
					// $colOrder == '' then it is restorview.
					if($colOrder !=''){
						if($gridSearchFields[$colOrder] !=''){						
							$strSno = $gd->getCategoryMatchIds($gridSearchFields[$colOrder]);
							$gridSearchFields[$colOrder] = '';
							if($strSno !=''){	
								// If entered value does not have 'sno' in DB.
								$expSno = explode(',',$strSno);									
								for($j=0;$j<count($expSno);$j++){
									if($j != count($expSno)-1 )
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) OR ";
									else
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) ";
								}							
								$addQstr = " AND ( $expSnoLoc ) ";							
							}
						}
					}else{
						if(!empty($gridSearchFields[7])){
							$selSno = "SELECT sno FROM manage WHERE type='Category' and name ='".$gridSearchFields[7]."'";
							$resSno = mysql_query($selSno,$db);
							if( mysql_num_rows($resSno)>0 ){
								$fetchSno = mysql_fetch_array($resSno);
							}
							if(is_array($fetchSno)){	
								if($fetchSno['sno'] !=''){
									$strSno .= 	$fetchSno['sno'];
									$gridSearchFields[7]= '';							
									$addQstr = " AND ( FIND_IN_SET('".$strSno."',staffoppr_contact.cat_id) ) ";
								}
							}
						}	
					}				
				}
				// End HERe	
				// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.	
				if(in_array('staffoppr_contact.wphone',$asFields)){
					$asFieldsKey = array_search("staffoppr_contact.wphone", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.wphone",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.wphone",$gridSearchFields,$asFieldsKey);
				}
				$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,'');
				if($addQstr != '')
					$qstr = $qstr.$addQstr;
				if($gridSortCol == 100){
					$ostr = " ORDER BY staffoppr_contact.mdate DESC ";				
				}else{
					$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
				}
				
				//For checking contacts duplicates and displaying the search result on main grid.
				if($gridExtraFields['duplicate']== "yes")
				{
					$gridSearchFields[0] = $gd->gridSearchFieldConvert($gridSearchFields[0]);
					$gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
					$gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);
		
					$qstr = $gd->duplicateContactChecking($gridSearchFields[0],$gridSearchFields[1],$gridSearchFields[4]);
					
					$gridSearchFields[0] = "";
					$gridSearchFields[1] = "";
					$gridSearchFields[4] = "";
				}
				
				$tque=$gd->buildTQuery($tque,$qstr,'');
				$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,'');
				$total=$gd->getTotalRows($tque);
			}
		}
		else
		{
			//Archived Contacts
			$asFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","staffoppr_contact.cat_id","users.name");
			$ssFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","cat","trim(users.name)");
			$acs=" AND  staffoppr_contact.owner='$username' ";

			$tque="SELECT COUNT(1) FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition.$acs;

			$oque="SELECT 
			staffoppr_contact.sno, 
			staffoppr_contact.fname,
			staffoppr_contact.lname,
			IF(staffoppr_cinfo.cname = '', staffoppr_cinfo.cname, CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'CRM\')>', staffoppr_cinfo.cname, '</a>')),  
			staffoppr_contact.email,
			staffoppr_contact.wphone,
			staffoppr_contact.state,
			".$fetchCategory.", IF(staffoppr_contact.accessto='ALL','Public',IF(staffoppr_contact.accessto='$username','Private','Share')),users.name,staffoppr_contact.owner,".tzRetQueryStringDTime('staffoppr_contact.stime','Date','/').",".tzRetQueryStringDTime('staffoppr_contact.mdate','Date','/').",staffoppr_contact.ytitle FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition.$acs;

			
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			// Sunil wirtten code, Handling the Category filter values					
				if(is_array($gridSearchFields)){
					$colOrder = $gd->getColumnOrder();
					// $colOrder == '' then it is restorview.
					if($colOrder !=''){
						if($gridSearchFields[$colOrder] !=''){						
							$strSno = $gd->getCategoryMatchIds($gridSearchFields[$colOrder]);
							$gridSearchFields[$colOrder] = '';
							if($strSno !=''){	
								// If entered value does not have 'sno' in DB.
								$expSno = explode(',',$strSno);									
								for($j=0;$j<count($expSno);$j++){
									if($j != count($expSno)-1 )
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) OR ";
									else
										$expSnoLoc .= " FIND_IN_SET('".$expSno[$j]."',staffoppr_contact.cat_id) ";
								}							
								$addQstr = " AND ( $expSnoLoc ) ";							
							}
						}
					}else{
						if(!empty($gridSearchFields[7])){
							$selSno = "SELECT sno FROM manage WHERE type='Category' and name ='".$gridSearchFields[7]."'";
							$resSno = mysql_query($selSno,$db);
							if( mysql_num_rows($resSno)>0 ){
								$fetchSno = mysql_fetch_array($resSno);
							}
							if(is_array($fetchSno)){	
								if($fetchSno['sno'] !=''){
									$strSno .= 	$fetchSno['sno'];
									$gridSearchFields[7]= '';							
									$addQstr = " AND ( FIND_IN_SET('".$strSno."',staffoppr_contact.cat_id) ) ";
								}
							}	
						}	
					}				
				}				
			// End here	
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('staffoppr_contact.wphone',$asFields)){
				$asFieldsKey = array_search("staffoppr_contact.wphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.wphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.wphone",$gridSearchFields,$asFieldsKey);
			}
			$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,'8');
			if($addQstr != '')
				$qstr = $qstr.$addQstr;
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

			//For checking contacts duplicates and displaying the search result on main grid.
			if($gridExtraFields['duplicate']== "yes")
			{
				$gridSearchFields[0] = $gd->gridSearchFieldConvert($gridSearchFields[0]);
				$gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
				$gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);

				$qstr = $gd->duplicateContactChecking($gridSearchFields[0],$gridSearchFields[1],$gridSearchFields[4]);

				$gridSearchFields[0] = "";
				$gridSearchFields[1] = "";
				$gridSearchFields[4] = "";
			}

			$tque=$gd->buildTQuery($tque,$qstr,'');
			$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,'');
			$total=$gd->getTotalRows($tque);
			$gridData=$gd->buildContacts($oque,$gridSortCol,$cvsid,'CRM');
		}
		
		$gridData=$gd->buildContacts($oque,$gridSortCol,$cvsid,'CRM');
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);		
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	
	function getColumnOrder(){		
		global $maildb,$db,$username;
		// Fetching the column_order from udv_grids_usercolumns for category filter								
		$selQryCol = "SELECT id  FROM udv_grid_columns WHERE custom_form_modules_id = 1 and column_name = 'Category'";
		$res = mysql_query($selQryCol,$db);
		$fetchColId = mysql_fetch_array($res);		
		$selcolOrder = "SELECT column_order FROM udv_grids_usercolumns WHERE c_user_id=$username AND custom_grid_column_id=".$fetchColId['id'];
		$resOrder = mysql_query($selcolOrder,$db);
		$fetchOrder = mysql_fetch_array($resOrder);
		return $fetchOrder['column_order'];
	}
	
	/* Added by Sunil Kumar VC for Category Filter in Contacts Grid to Fetch id of Filter Values*/
	function getCategoryMatchIds($gridSearchFieldsValues){
		global $maildb,$db;
		$strSno = '';
		$pos = strpos($gridSearchFieldsValues, ',');
		if($pos !== false){
			$arrExp = explode(',',$gridSearchFieldsValues);					
			for($i=0;$i<count($arrExp);$i++){
				$selSno = "SELECT sno FROM manage WHERE type='Category' and name LIKE '%".$arrExp[$i]."%'";
				$resSno = mysql_query($selSno,$db);
				if( mysql_num_rows($resSno)>0 ){
					$fetchSno = mysql_fetch_array($resSno);
					if($fetchSno['sno'])	
					$strSno .= 	$fetchSno['sno'].',';
				}	
			}						
			$strSno = substr($strSno,0,-1);
		}else{					
			$selSno = "SELECT GROUP_CONCAT(sno) as csno FROM manage WHERE type='Category' and name LIKE '%".$gridSearchFieldsValues."%'";
			$resSno = mysql_query($selSno,$db);
			if( mysql_num_rows($resSno)>0 ){
				$fetchSno = mysql_fetch_array($resSno);
			}
			$strSno .= 	$fetchSno['csno'];		
		}	
		return $strSno;
	}
	function getCategoryIds($gridSearchFieldsValues){
		global $maildb,$db;
		$strSno = '';
		$pos = strpos($gridSearchFieldsValues, ',');
		if($pos !== false){
			$arrExp = explode(',',$gridSearchFieldsValues);					
			for($i=0;$i<count($arrExp);$i++){
				$selSno = "SELECT sno FROM manage WHERE type='Category' and name ='".$arrExp[$i]."'";
				$resSno = mysql_query($selSno,$db);
				if( mysql_num_rows($resSno)>0 ){
					$fetchSno = mysql_fetch_array($resSno);
					if($fetchSno['sno'])	
					$strSno .= 	$fetchSno['sno'].',';
				}	
			}						
			$strSno = substr($strSno,0,-1);
		}else{					
			$selSno = "SELECT sno FROM manage WHERE type='Category' and name ='".$gridSearchFieldsValues."'";
				$resSno = mysql_query($selSno,$db);
				if( mysql_num_rows($resSno)>0 ){
					$fetchSno = mysql_fetch_array($resSno);
				}
			$strSno .= 	$fetchSno['sno'];		
		}	
		return $strSno;
	}// end of the function 

	/* Added by Rajkumar M. for News #Modified By Vijaya to add new columns */
 	function buildNews($que)
 	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$temp = explode('[',$row[6]);
			if(trim($temp[0])=='Removed')
			{
				$row[6] = "<font color='#FF0000'>".$row[6]."</font>";
			}			
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onclick='chk_clearTop();' value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]); #Created By
			$grid[$j][4]=$this->convertSpecChars($row[4]); #Modified Date
			$grid[$j][5]=$this->convertSpecChars($row[5]); #Modified By			
			$grid[$j][6]=$row[6];
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]='';
			$grid[$j][9]="editnews.php?addr=".$row[0];
			$j++;
		}
		return $grid;
	}

	// Modified by vijaya to add created date and user , modified date and user columns on 16-09-2008
	function getNews($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		
		$asFields=array("","news.headline",tzRetQueryStringDTime("news.stime","DateTime","/"),"users.name",
		tzRetQueryStringDTime("news.mtime","DateTime","/"),"muser.name");
		
		$ssFields=array("","news.headline","news.stime","users.name","news.mtime","muser.name","IF(news.posted_date >  news.removed_date,news.posted_date,removed_date)", "news.display_news_edesk");
						
		$tque="SELECT count(1) FROM news_manage as news
		LEFT JOIN users ON users.username = news.cuser
		LEFT JOIN users as muser ON muser.username = news.muser 
		WHERE news.status!='BP'"; 	
		
		$oque="SELECT news.serial_no,news.headline,".tzRetQueryStringDTime("news.stime","DateTime","/").", users.name, 		".tzRetQueryStringDTime("news.mtime","DateTime","/").",muser.name,IF(news.posted_date='0000-00-00 00:00:00','',IF(news.status='P',CONCAT_WS('','Posted [',".tzRetQueryStringDTime("news.posted_date","Date","/").", ']'),IF(news.status='RM',CONCAT_WS('','Removed [',". tzRetQueryStringDTime("news.removed_date","Date","/").",']'), ''))), IF(news.display_news_edesk='Y','Yes','No')
		FROM news_manage as news
		LEFT JOIN users ON users.username = news.cuser
		LEFT JOIN users as muser ON muser.username = news.muser 
		WHERE news.status!='BP'";
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);		
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
	  	$oque="$oque $qstr $ostr $lstr";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildNews($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
		
	/*****************************************/

	//Added by Sandeep Kumar Ganachary (10/07/08) Optimizing Joborders Main Page
	function getJobOrders($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{  
		global $maildb,$db,$username,$user_timezone,$sysdb,$maindb,$companyuser,$cvsid;

		$gd = new gridData();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("job orders",$username,$cvsid);
		
		if(!empty($grdi_details))
		{			
			$asFields = $custom_grid_function_obj->asFields("job orders", $username,$cvsid);
			$ssFields=$custom_grid_function_obj->ssFields("job orders", $username,$cvsid);	
			$oque = $custom_grid_function_obj->queryBuilder("job orders", $username,$cvsid);
			$tque = $custom_grid_function_obj->countQueryBuilder("job orders", $username,$cvsid);
			
			$grpque = "";
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			//$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('t1.phone',$asFields)){
				$asFieldsKey = array_search("t1.phone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("t1.phone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("t1.phone",$gridSearchFields,$asFieldsKey);
			}
			$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'job orders');
			//Sunil	 Added this code to check the gridLoading First time or not	
			
			if($gridSortCol == 100){
				$ostr = " ORDER BY posdesc.mdate DESC ";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
			}
				
			if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
			{
				//require("searchdatabase.inc");

				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);
	
				require("quickSubCandidates.inc");	
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
				$customesearch = true;
				require("visualsearch_joborders.php");
				require("database.inc");
			}
			else
			{
				$aqstr=" AND 1=1 ";
			}
			
			// This query will give us the total number of records, for that we will remove the limit string.
			$tque .= " $qstr $CompanyCond $aqstr $grpque"; 
			
			$oque="$oque $qstr $CompanyCond $aqstr $grpque $ostr $lstr";
			
			// This function will give us the total number of records.			
			$total=$gd->getTotalRows($tque);
			//$total=$gd->getDevTotalRows($tque);
		}
		else
		{
			$asFields=array("","posdesc.jonumber","jobstatus.name","posdesc.postitle","staffoppr_cinfo.cname",
			"loc.city","loc.state", "posdesc.refcode","req_pref.po_num",
			tzRetQueryStringSelBoxDate('posdesc.duedate','Date','/'),"IF(no_of_pos - closepos <0,0,no_of_pos - closepos)",
			"sub_sub_count","sub_cand_count","posdesc.sub_int_count","posdesc.video_interview_count",
			"IF (posdesc.accessto = 'all', 'Public',IF (posdesc.accessto = '".$username."', 'Private', 'Share'))",
			"sourcetype.name","jobtype.name",		"users.name",tzRetQueryStringSelBoxDate('posstartdate','Date','/'),tzRetQueryStringDTime('posdesc.stime','Date','/'),
			tzRetQueryStringDTime('posdesc.mdate','Date','/'),'posdesc.shift_type');
	
			$ssFields = array("","jonumber","jobstatus.name","posdesc.postitle","staffoppr_cinfo.cname",	
			"loc.city","loc.state","posdesc.refcode","req_pref.po_num",
			"posdesc.duedate", "openpos","posdesc.sub_sub_count","posdesc.sub_cand_count","posdesc.sub_int_count","posdesc.video_interview_count",
			"IF(posdesc.accessto = 'all', 'Public', IF(posdesc.accessto = '".$username."', 'Private', 'Share'))",
			"sourcetype.name","jobtype.name","users.name","posdesc.posstartdate","posdesc.stime","posdesc.mdate","posdesc.shift_type");
	
			$tque="SELECT count(posdesc.posid) FROM posdesc   
			LEFT JOIN staffoppr_cinfo ON(posdesc.company=staffoppr_cinfo.sno)
			LEFT JOIN staffoppr_location loc ON (posdesc.location=loc.sno)
			LEFT JOIN manage jobtype ON(posdesc.postype=jobtype.sno AND jobtype.type='jotype')
			LEFT JOIN manage sourcetype ON(posdesc.sourcetype=sourcetype.sno AND sourcetype.type='josourcetype')
			LEFT JOIN users ON(posdesc.owner=users.username)
			LEFT JOIN manage jobstatus ON (posdesc.posstatus=jobstatus.sno AND jobstatus.type='jostatus'),req_pref
			WHERE (posdesc.owner='".$username."' OR FIND_IN_SET('".$username."',posdesc.accessto)>0 OR posdesc.accessto='all')
			AND posdesc.status IN ('approve','Accepted') AND req_pref.posid = posdesc.posid ";
	
			$oque="SELECT posdesc.posid, posdesc.jonumber,
			posdesc.postitle, CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'CRM\')>', staffoppr_cinfo.cname, '</a>') as cname,jobtype.name jobtype, jobstatus.name  STATUS, posdesc.refcode,req_pref.po_num,
			".tzRetQueryStringSelBoxDate('posdesc.duedate','Date','/').",
			IF(no_of_pos - closepos < 0, 0, no_of_pos - closepos) openpos,posdesc.sub_sub_count,
			posdesc.sub_inq_count,posdesc.sub_cand_count,posdesc.sub_int_count,
			IF(posdesc.accessto = 'all', 'Public',
			IF(posdesc.accessto != '".$username."', 'Share', 'Private')) TYPE, 
			sourcetype.name  sourcetype,
			posdesc.owner, users.name, ".tzRetQueryStringSelBoxDate('posstartdate','Date','/')."  startdate,
			".tzRetQueryStringDTime('posdesc.stime','Date','/').",".tzRetQueryStringDTime('posdesc.mdate','Date','/').",
			loc.city,loc.state,posdesc.video_interview_count,posdesc.shift_type
			FROM posdesc force index(status)
			LEFT JOIN staffoppr_cinfo ON (posdesc.company=staffoppr_cinfo.sno)
			LEFT JOIN staffoppr_location loc ON (posdesc.location=loc.sno)
			LEFT JOIN manage jobtype ON (posdesc.postype=jobtype.sno AND jobtype.type='jotype')
			LEFT JOIN manage sourcetype ON (posdesc.sourcetype=sourcetype.sno AND sourcetype.type='josourcetype')
			LEFT JOIN users ON (posdesc.owner=users.username)
			LEFT JOIN manage jobstatus ON (posdesc.posstatus=jobstatus.sno AND jobstatus.type='jostatus'),
			req_pref		
			WHERE (posdesc.owner='".$username."' OR FIND_IN_SET('".$username."',posdesc.accessto)>0 OR posdesc.accessto='all')
			AND posdesc.status IN ('approve','Accepted')  AND req_pref.posid= posdesc.posid" ;
	
			if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
			{
				//require("searchdatabase.inc");

				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);
	
				require("quickSubCandidates.inc");	
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
				$customesearch = true;
				require("visualsearch_joborders.php");
				require("database.inc");
			}
			else
			{
				$aqstr=" AND 1=1 ";
			}
	
			$gstr="";
			$ValJobType = "";//for holding jobtype in searching
			$hvstr = "";//for holding having in searching
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
	
			//To get exact result of selected jobtype
			if($gridSearchFields[14]!="")
			{
				$ValJobType = " AND (jobtype.name = '$gridSearchFields[14]')";
				$gridSearchFields[14]="";
			}
	
			//To get no. of submissions of job in searching
			if($gridSearchFields[9]!="")
			{
				$hvstr = " AND sub_sub_count = '$gridSearchFields[9]' ";
				$gridSearchFields[9]="";
			}
	
			if($gridSearchFields[10]!= "")
			{			
				$ValJobType .= " AND (sub_cand_count = '$gridSearchFields[10]') ";
				$gridSearchFields[10] = "";
			}
	
			$qstr=$gd->buildQSTR($gridSearchType, $gridSearchFields, $asFields);
			$qstr=$aqstr.$qstr.$ValJobType;//appending the jobtype selected
			//Sunil	 Added this code to check the gridLoading First time or not			
			if($gridSortCol == 100){
				$ostr = " ORDER BY posdesc.mdate DESC ";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
			}
			$tque=$gd->buildTQuery($tque,$qstr,$gstr.$hvstr);
			$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr.$hvstr);
				
			$total=$gd->getTotalRows($tque);
		}
		
		$gridData=$gd->buildJobOrders($oque,$cvsid);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
	}
	
	function getJobOrdersCheckBoxValue($sno)
	{
		global $username;
		$sel_JobOrderCheckBoxValue = "SELECT posdesc.posid,posdesc.postitle, posdesc.owner, ";		
		$sel_JobOrderCheckBoxValue .= "IF(posdesc.accessto = 'all', 'Public', IF(posdesc.accessto != '".$username."', 'Share', 'Private')) type ";
		$sel_JobOrderCheckBoxValue .= "FROM posdesc WHERE posid = ".$sno;
			
		
		$res_JobOrderCheckBoxValue = mysql_query($sel_JobOrderCheckBoxValue);
		$rec_JobOrderCheckBoxValue = mysql_fetch_assoc($res_JobOrderCheckBoxValue);
		return $rec_JobOrderCheckBoxValue;	
	}
	
	
	function buildJobOrders($que,$cvsid=0)
	{	
		
		global $maildb,$db, $username;
		$j=0;
		$grid=array();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("job orders",$username,$cvsid);
		$customSortOrderVal = $this->fetchCustomSortOrder(4,$cvsid);
		
		if($customSortOrderVal != '')		
			$returnVal = 1 + $this->fetchCustomSortOrder(4,$cvsid);
		else
			$returnVal = '';
		$res=mysql_query($que,$db);
		
		if(!empty($grdi_details))
		{
			// Fetching the headers
			$res_grid_headers = mysql_query($que,$db);
			while($rec_grid_headers = mysql_fetch_field($res_grid_headers))
			{
				$grid_header[] = strtolower($rec_grid_headers->name);
			}

			while ($row=mysql_fetch_row($res))
			{
				$fetchCmpyCsno = $this->fetchCompanyName($row[0]);
				for($i=0;$i<count($row);$i++)
				{
					if($i == 0)
					{
						$row[3] = stripslashes($row[3]);
						$joborderCheckboxVal = $this->getJobOrdersCheckBoxValue($row[$i]);
						/*
						$joborderCheckboxVal = $this->getJobOrdersCheckBoxValue($row[$i]);
						
						$grid[$j][0]="<input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value=
								'".$companyCheckboxVal["sno"]
								."|".$companyCheckboxVal["owner"]
								."|".html_tls_specialchars($companyCheckboxVal["ownername"],ENT_QUOTES)
								."|".$j
								."|".html_tls_specialchars($companyCheckboxVal["cname"],ENT_QUOTES)
								."|".$companyCheckboxVal["acc_comp"]
								."'>";
						*/
						$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value=
								'".$joborderCheckboxVal["posid"]
								."|".$joborderCheckboxVal["owner"]
								."|".$joborderCheckboxVal["type"]
								."|".$joborderCheckboxVal["postitle"]
								."|".$j."'><span class='checkmark'></span></label>";
						
					}
					else
					{
						if($returnVal == $i && $customSortOrderVal != ''){
							    $hyperLink = "<a href=javascript:showComp('".$fetchCmpyCsno."','CRM')>".stripslashes($row[$i])."</a>";
								$grid[$j][$i]= $hyperLink;
						}
						else if(strtolower($grid_header[$i]) == "shift_type"){
								$grid[$j][$i] = ucfirst($row[$i]);
								
						}
						else{
							$row_contents = ($row[$i] == "00/00/0000")? "" : $row[$i];
							$grid[$j][$i]= stripslashes($row_contents);
						}	
					}
				}				
				
				$grid[$j][count($row)]= '';				
				$grid[$j][(count($row)+1)]= "redirectjob.php?addr=".$row[0]."&module=CRM";
				$j++;
			}
			
		}
		else
		{
			while ($row=mysql_fetch_array($res))
			{
		
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[16]."|".$row[14]."|".html_tls_specialchars($row[2],ENT_QUOTES)."|".$j."'><span class='checkmark'></span></label>"; 
				$row[18] = ($row[18]=="00/00/0000")? "" : $row[18];
				$grid[$j][1]=$this->convertSpecChars($row[1]); //Job ID
				$grid[$j][2]=$this->convertSpecChars($row[5]);  //Status
				$grid[$j][3]=$this->convertSpecChars($row[2]); //Title
				$grid[$j][4]=stripslashes($row[3]); //Company Name
				$grid[$j][5]=$this->convertSpecChars($row[21]);//city
				$grid[$j][6]=$this->convertSpecChars($row[22]);//state
				$grid[$j][7]=$this->convertSpecChars($row[6]); //REF Code		
				$grid[$j][8]=$this->convertSpecChars($row[7]); //PO Number
				$grid[$j][9]=($row[8]=="00/00/0000")? "" : $row[8];//Due Date
				$grid[$j][10]=$row[9]; // Openings
				$rescount=$row[10]; 
				if($rescount==0) 
					$grid[$j][11]="";//Submissions
				else
				{
					$k=$row[11];
		
					if($k==0)
						$grid[$j][11]="<a href=javascript:link($row[0],'CRM')>$rescount</a>";
					else
						$grid[$j][11]="<a href=javascript:link($row[0],'CRM')>$rescount</a>&nbsp;&nbsp;&nbsp;<a href=javascript:subInqiries($row[0]) style='color:red'>($k new)</a>";
				}
			
				$grid[$j][12] = ($row[12]==0) ? "" : "<a href=javascript:showCand($row[0],'','CRM')>".$row[12]."</a>"; //Candidates
				$grid[$j][13]=($row[13]==0)? "" : $row[13]; // Interviews
				$grid[$j][14]=($row[23]==0)? "" : "<a href=javascript:manVInterview($row[0])>".$row[23]."</a>"; // Vidoe Interviews
				$grid[$j][15]=$this->convertSpecChars($row[14]); // Type 
				$grid[$j][16]=$this->convertSpecChars($row[15]); //Source Type 
				$grid[$j][17]=$this->convertSpecChars(stripslashes($row[4]));  //Job Type				
				$grid[$j][18]=$this->convertSpecChars($row[17]); //Owner 
				$grid[$j][19]=$this->convertSpecChars($row[18]); //Start Date
				$grid[$j][20]=$this->convertSpecChars($row[19]); //Created Date
				$grid[$j][21]=$this->convertSpecChars($row[20]); //Modified Date			
				$grid[$j][22]="";
				$grid[$j][23]="redirectjob.php?addr=".$row[0]."&module=CRM";
				
				$j++;
			}
		}
		
        return $grid;
	}
	
	
	function getCompaniesCheckBoxValue($sno)
	{
		global $username;
				
		$sel_CompaniesCheckBoxValue = "SELECT
		staffoppr_cinfo.sno,
		staffoppr_cinfo.cname,
		staffoppr_cinfo.phone,
		staffoppr_cinfo.state,
		IF (staffoppr_cinfo.accessto = 'ALL', 'Public',IF (staffoppr_cinfo.accessto = '".$username."', 'Private', 'Share')) as share_type,
		users.name as ownername,'',staffoppr_cinfo.owner,staffoppr_cinfo.cdate,staffoppr_cinfo.acc_comp,staffoppr_cinfo.mdate, staffoppr_cinfo.city,manage.name
		FROM users,staffoppr_cinfo LEFT JOIN manage ON staffoppr_cinfo.compstatus=manage.sno
		WHERE staffoppr_cinfo.sno = ".$sno." AND staffoppr_cinfo.status = 'ER'";
		$res_CompaniesCheckBoxValue = mysql_query($sel_CompaniesCheckBoxValue);
		$rec_CompaniesCheckBoxValue = mysql_fetch_assoc($res_CompaniesCheckBoxValue);
		return($rec_CompaniesCheckBoxValue);	
	}
	

	function buildCompanies($que,$cvsid=0)
	{
		global $maildb,$db, $username;
		
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("companies",$username,$cvsid);
		
		if(!empty($grdi_details))
		{
			while ($row=mysql_fetch_row($res))
			{
				for($i=0;$i<count($row);$i++)
				{
					if($i == 0)
					{
						$companyCheckboxVal = $this->getCompaniesCheckBoxValue($row[$i]);
						
						$grid[$j][0]=" <label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value=
								'".$companyCheckboxVal["sno"]
								."|".$companyCheckboxVal["owner"]
								."|".html_tls_specialchars($companyCheckboxVal["ownername"],ENT_QUOTES)
								."|".$j
								."|".html_tls_specialchars(stripslashes($companyCheckboxVal["cname"]),ENT_QUOTES)
								."|".$companyCheckboxVal["acc_comp"]
								."'><span class='checkmark'></span></label>";
						
					}
					else
					{
						$grid[$j][$i]= $this->convertSpecChars(stripslashes($row[$i]));
					}
				}				
				
				$grid[$j][count($row)]= '';				
				$grid[$j][(count($row)+1)]= "viewcompanySummary.php?addr=".$row[0]."&module=CRM";
				$j++;
			}
		}
		else
		{
			
			while ($row=mysql_fetch_array($res))
			{
				$grid[$j][0]=" <label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[7]."|".html_tls_specialchars($row[5],ENT_QUOTES)."|".$j."|".html_tls_specialchars(stripslashes($row[1]),ENT_QUOTES)."|".$row[9]."'><span class='checkmark'></span></label>";
				$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
				$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[11]));			
				$grid[$j][4]=$this->convertSpecChars(stripslashes($row[3]));
				$grid[$j][5]=$this->convertSpecChars(stripslashes($row[4]));
				$grid[$j][6]=$this->convertSpecChars(stripslashes($row[12]));
				$grid[$j][7]=$this->convertSpecChars(stripslashes($row[5]));
				$grid[$j][8]=$this->convertSpecChars(stripslashes($row[8]));
				$grid[$j][9]=$this->convertSpecChars(stripslashes($row[10]));
				$grid[$j][10]='';			
				$grid[$j][11]="viewcompanySummary.php?addr=".$row[0]."&module=CRM";
				$j++;
			}
		}
		return $grid;
	}

	function getCompanies($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$sysdb,$maindb,$companyuser,$cvsid;

		if($gridExtraFields['cvsid'] != '' || $gridExtraFields['cvsid'] != 0) 
		{
			$cvsid = $gridExtraFields['cvsid'];
		}
		
		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			//require("searchdatabase.inc");
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);

			require("quickSubCandidates.inc");	
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			
			require("visualsearch_companies.php");
			require("database.inc");
		}
		else
		{
			$aqstr=" 1=1 ";
		}
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("companies",$username,$cvsid);
		
		
		if(!empty($grdi_details))
		{			
			$asFields = $custom_grid_function_obj->asFields("companies", $username,$cvsid);
			$ssFields=$custom_grid_function_obj->ssFields("companies", $username,$cvsid);	
			$oque = $custom_grid_function_obj->queryBuilder("companies", $username,$cvsid);
			$tque = $custom_grid_function_obj->countQueryBuilder("companies", $username,$cvsid);
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('staffoppr_cinfo.phone',$asFields)){
				$asFieldsKey = array_search("staffoppr_cinfo.phone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_cinfo.phone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_cinfo.phone",$gridSearchFields,$asFieldsKey);
			}
						
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'companies');
			
			//Sunil	 Added this code to check the gridLoading First time or not	
			if($gridSortCol == 100){
				$ostr = " ORDER BY staffoppr_cinfo.mdate DESC ";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
			}
			if(empty($aqstr))
				$aqstr = '';
			else
				$aqstr = " AND ".$aqstr;
			
			// This query will give us the total number of records, for that we will remove the limit string.
			$tque .= " $qstr $CompanyCond $grpque $aqstr"; 
			
			$oque="$oque $qstr $CompanyCond $grpque $aqstr $ostr $lstr";
			
			
			// This function will give us the total number of records.			
			//$total=$gd->getDevTotalRows($tque);
	
			$total=$gd->getTotalRows($tque);
				
			
		}
		else
		{
			$asFields=array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.state","IF (staffoppr_cinfo.accessto = 'ALL', 'Public',IF (staffoppr_cinfo.accessto = '".$username."', 'Private', 'Share'))","manage.name","users.name",tzRetQueryStringDTime('staffoppr_cinfo.cdate','Date','/'),tzRetQueryStringDTime('staffoppr_cinfo.mdate','Date','/'),"staffoppr_cinfo.owner","staffoppr_cinfo.city");
			$ssFields=array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.city","staffoppr_cinfo.state","IF (staffoppr_cinfo.accessto = 'ALL', 'Public',IF (staffoppr_cinfo.accessto = '".$username."', 'Private', 'Share'))","manage.name","users.name","staffoppr_cinfo.cdate","staffoppr_cinfo.mdate","staffoppr_cinfo.owner");
	
			$tque="SELECT
				count(distinct(staffoppr_cinfo.sno))
				FROM staffoppr_cinfo LEFT JOIN users ON staffoppr_cinfo.owner=users.username LEFT JOIN manage ON staffoppr_cinfo.compstatus=manage.sno
				WHERE $aqstr
				AND staffoppr_cinfo.status = 'ER'
				AND (staffoppr_cinfo.owner = '".$username."' OR FIND_IN_SET( '".$username."', staffoppr_cinfo.accessto ) >0 OR staffoppr_cinfo.accessto = 'ALL') and crmcompany='Y'";
	
			$oque="SELECT
				staffoppr_cinfo.sno,
				staffoppr_cinfo.cname,
				staffoppr_cinfo.phone,
				staffoppr_cinfo.state,
				IF (staffoppr_cinfo.accessto = 'ALL', 'Public',IF (staffoppr_cinfo.accessto = '".$username."', 'Private', 'Share')),
				users.name,'',staffoppr_cinfo.owner,".tzRetQueryStringDTime('staffoppr_cinfo.cdate','Date','/').",staffoppr_cinfo.acc_comp,".tzRetQueryStringDTime('staffoppr_cinfo.mdate','Date','/').", staffoppr_cinfo.city,manage.name 
				FROM staffoppr_cinfo LEFT JOIN users ON staffoppr_cinfo.owner=users.username LEFT JOIN manage ON staffoppr_cinfo.compstatus=manage.sno
				WHERE $aqstr
				AND staffoppr_cinfo.status = 'ER'
				AND (staffoppr_cinfo.owner = '".$username."' OR FIND_IN_SET( '".$username."', staffoppr_cinfo.accessto ) >0 OR staffoppr_cinfo.accessto = 'ALL') and crmcompany='Y'";
			
			$grpque=" group by staffoppr_cinfo.sno";
			
			$CompanyCond = "";
			if($gridSearchFields[4] != "")
			{
				$CompanyCond.=" AND manage.name = '".$gridSearchFields[4]."' ";
				$gridSearchFields[4] = "";
			}
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('staffoppr_cinfo.phone',$asFields)){
				$asFieldsKey = array_search("staffoppr_cinfo.phone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_cinfo.phone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_cinfo.phone",$gridSearchFields,$asFieldsKey);
			}

			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			//Sunil	 Added this code to check the gridLoading First time or not				
			if($gridSortCol == 100){
				$ostr = " ORDER BY staffoppr_cinfo.mdate DESC ";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
			}		
			$tque=$gd->buildTQuery($tque,$qstr.$CompanyCond,'');
			$oque="$oque $qstr $CompanyCond $grpque $ostr $lstr";
	
			$total=$gd->getTotalRows($tque);
		
		}
		
		$gridData=$gd->buildCompanies($oque,$cvsid);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		
		return $objResponse;
	}
	
	/**
	* The below Four functions (buildHiring_Mngmt,getHiring_Mngmt,buildDepartments,getDepartments) 
	* are added by Sandeep Boora for XAJAX implementation of HRM's Hiring_Mngmt and Departments.
	**/

	// Function for Hiring Managment's XAJAX Grid Outputs - Added by Sandeep Boora
	function buildHiring_Mngmt($que)
	{
		global $maildb,$db,$ac_aced;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$row[2] = trim($row[2],',');
			$prow="";

			if($row[2])
            {
    			$pqry="SELECT group_concat(postitle) from posdesc where posid IN ($row[2])";
    			$pres=mysql_query($pqry,$db);
    			$prow=mysql_fetch_array($pres);
            }
			if($row[11]!='' && $row[11]!='0-0-0' && $row[11]!='0000-00-00')
				$row[11] = date("m/d/Y",strtotime($row[11]));			
			else
				$row[11] = '';
			
			$emp_send = "";
			$emp_send = $row[1]."^".$row[16];
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label><input type='hidden' id='email_flag_name_".$row[0]."' name='email_flag_name[]' value='".$this->convertSpecChars($row[14])."'><input type='hidden' id='employee_email_".$row[0]."' name='employee_email[]' value='".$this->convertSpecChars($row[15])."'><input type='hidden' id='employee_ds_pob_".$row[0]."' name='employee_ds_pob[]' value='".$this->convertSpecChars($emp_send)."'>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($prow[0]);
			//$grid[$j][3]=$this->convertSpecChars($type_array[$row[3]]);			
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[8])));
			//$grid[$j][6]=$this->convertSpecChars($row[9]);// Old POB Status
			
			$grid[$j][6]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','hrmmngmt')>".ucwords($this->convertSpecChars($row[16]))."</a>";
			$grid[$j][7]=ucfirst($this->convertSpecChars($row[17]));	//WOTC MJA Status
			$prophecy_viewLink='';
			if($row[18] !=''){
				$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row[18]."','hrmHiringMngmt')>View</a>";
			}
			$sterling_viewLink='';
			if($row[19] !=''){
				$sterling_viewLink = "<a href=javascript:viewSterlingOrder('".$row[19]."')>View</a>";
			}
			$grid[$j][8]=$prophecy_viewLink;
			$grid[$j][9]=$sterling_viewLink;
			$grid[$j][10]=$this->convertSpecChars($row[10]);
			$grid[$j][11]=$this->convertSpecChars($row[11]);
			$grid[$j][12]=$this->convertSpecChars($row[12]);
			$grid[$j][13]=$this->convertSpecChars($row[13]);
                        $eskill_viewLink='';
                        if($row[20] !=''){
                                $eskill_viewLink = "<a href=javascript:viewEskillResults('".$row[20]."','HiringManagement','".$row[0]."')>View</a>";
                        }
                        $grid[$j][14]=$eskill_viewLink;
			$grid[$j][15]="";
			$grid[$j][16]=$this->convertSpecChars($row[7]."|".$row[0]);

			$j++;
		}
		return $grid;
	}
	
	// Function for Hiring Managment's XAJAX Grid Inputs and Queries - Added by Sandeep Boora
	function getHiring_Mngmt($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields=array("","app.name","posdesc.postitle","manage.name","users.name","cp.ssn","app.ds_pobstatus","app.wotc_mja_status","pc.caregiver_id","so.email",tzRetQueryStringDTime('app.stime','DateTime','/'),tzRetQueryStringDate('cjobs.startdate','Date','/'),"si.cname","CONCAT(sl.address1,' ',sl.address2,' ',sl.city,' ',sl.state,' ',sl.zipcode)","eskill_email");
		
	    $ssFields=array("","app.name","posdesc.postitle","manage.name","users.name","cp.ssn","app.ds_pobstatus","app.wotc_mja_status","pc.caregiver_id","so.email","app.stime","cjobs.startdate","si.cname","CONCAT(sl.address1,' ',sl.address2,' ',sl.city,' ',sl.state,' ',sl.zipcode)","eskill_email");

		
		$tque="SELECT count(1) FROM applicants app 
		LEFT JOIN posdesc ON find_in_set(posdesc.posid,app.jobtitle) 
		LEFT JOIN users ON users.username=app.apmark 
		LEFT JOIN consultant_jobs ON consultant_jobs.username=app.username 
		LEFT JOIN consultant_personal cp ON cp.username=app.username 
		LEFT JOIN manage ON manage.sno = consultant_jobs.jotype 
		LEFT OUTER JOIN
		(
			SELECT cj.username,STR_TO_DATE( cj.s_date, '%m-%d-%Y' ) as startdate,cj.client,cj.endclient
			FROM consultant_jobs cj
			INNER JOIN (
				SELECT MIN( STR_TO_DATE( cj1.s_date, '%m-%d-%Y' ) ) AS min_date, cj1.sno, cj1.username
				FROM consultant_jobs cj1
				WHERE cj1.s_date <> '0-0-0'
				GROUP BY cj1.username
			)cj2 ON cj2.username = cj.username
			AND cj2.min_date = STR_TO_DATE( cj.s_date, '%m-%d-%Y' )
		) cjobs
		ON
		(cjobs.username=app.username)
		LEFT JOIN staffacc_location sl ON cjobs.endclient = sl.sno
		LEFT JOIN staffacc_cinfo si ON cjobs.client = si.sno
		LEFT JOIN consultant_general cnsg ON cnsg.username = app.username
		LEFT JOIN prophecy_caregivers pc ON pc.email=cnsg.email
		LEFT JOIN sterling_orders so ON so.email=cnsg.email
        LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = cnsg.email
		WHERE astatus NOT IN ('hire','HREJ','backup','HRF')";	
		
		/******************************
		Added extra fields Start Date,Location and company on 23-07-2015 by Naresh Reddy
		Start Date is the minimum date of assignment where multiple assignments can be there.Job Location and Company are fetched for that particular minimum date.
		******************************/
		
		$oque="SELECT app.serial_no,app.name,app.jobtitle,manage.name,users.name,app.hr,app.apmark,app.username,cp.ssn,app.pobstatus,".tzRetQueryStringDTime('app.stime','DateTime','/').",
		cjobs.startdate,si.cname,CONCAT(sl.address1,' ',sl.address2,' ',sl.city,' ',sl.state,' ',sl.zipcode) Location, IF(cnsg.email = '', IF(cnsg.alternate_email = '', IF(cnsg.other_email = '', app.name, ''), ''), '') as email_flag_name,
                IF(cnsg.email = '', IF(cnsg.alternate_email = '', cnsg.other_email, cnsg.alternate_email), cnsg.email) as emp_email_id,
		app.ds_pobstatus,app.wotc_mja_status,pc.caregiver_id,so.email,veas.email as eskill_email
		FROM applicants app
		LEFT JOIN posdesc ON FIND_IN_SET( posdesc.posid, app.jobtitle ) 
		LEFT JOIN users ON users.username = app.apmark
		LEFT JOIN consultant_jobs ON consultant_jobs.username = app.username
		LEFT JOIN consultant_personal cp ON cp.username = app.username
		LEFT JOIN manage ON manage.sno = consultant_jobs.jotype
		LEFT OUTER JOIN
		(
			SELECT cj.username,STR_TO_DATE( cj.s_date, '%m-%d-%Y' ) as startdate,cj.client,cj.endclient
			FROM consultant_jobs cj
			INNER JOIN (
				SELECT MIN( STR_TO_DATE( cj1.s_date, '%m-%d-%Y' ) ) AS min_date, cj1.username
				FROM consultant_jobs cj1
				WHERE cj1.s_date <> '0-0-0'
				GROUP BY cj1.username
			)cj2 ON cj2.username = cj.username
			AND cj2.min_date = STR_TO_DATE( cj.s_date, '%m-%d-%Y' )
		) cjobs
		ON
		(cjobs.username=app.username) 
		LEFT JOIN staffacc_location sl ON cjobs.endclient = sl.sno
		LEFT JOIN staffacc_cinfo si ON cjobs.client = si.sno
		LEFT JOIN consultant_general cnsg ON cnsg.username = app.username
		LEFT JOIN prophecy_caregivers pc ON pc.email=cnsg.email 
		LEFT JOIN sterling_orders so ON so.email=cnsg.email
		LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = cnsg.email
		WHERE app.astatus NOT 
		IN ( 'hire',  'HREJ',  'backup',  'HRF' )";
		
        $grpque=" group by app.serial_no";
		$qstr = "";
		if($gridSearchFields[2]!="")
		{
			$qstr1 = " and manage.name = '".$gridSearchFields[2]."'";
			$gridSearchFields[2]="";
		}

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
        $qstr.=$qstr1;
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,$grpque);	
		$tque="SELECT count(*) FROM ($tque) count"; //For Total Records Count
        $oque="$oque $qstr $grpque $ostr $lstr";	//For Total Records Data

    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildHiring_Mngmt($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	
	// Function for Department's XAJAX Grid Outputs - Added by Sandeep Boora
	function buildDepartments($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[7]."|".$row[14]."|".$row[15]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[8]);
			$grid[$j][5]=$this->convertSpecChars($row[9]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]=$this->convertSpecChars($row[10]);
			$grid[$j][9]=$this->convertSpecChars($row[11]);
			$grid[$j][10]=$this->convertSpecChars($row[12]);
			$grid[$j][11]=$this->convertSpecChars($row[13]);
			$grid[$j][12]="";
			$grid[$j][13]=$this->convertSpecChars($row[0]);
			$j++;
		}
		return $grid;
	}
	
	// Function for Department's XAJAX Grid Inputs and Queries - Added by Sandeep Boora
	function getDepartments($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
		
		$asFields=array("","adeptcode","adeptname","parent","locname","class.classname","empcnt","empnames","cdate","cname","mdate","mname");
       
	    $ssFields=array("","adeptcode","adeptname","parent","locname","class.classname","empcnt","empnames","depta.stime","cname","depta.etime","mname");


				
		$oque="SELECT depta.sno,depta.depcode adeptcode,depta.deptname adeptname,IF(deptb.depcode!='',CONCAT_WS(' - ',deptb.depcode,deptb.deptname),deptb.deptname) AS parent,depta.permission, IF(emp_cnt.ct!='',emp_cnt.ct,0) as empcnt, depta.permission_empnames AS empnames,(SELECT count(*) FROM department WHERE parent=depta.sno AND status='Active') par_cnt,IF(loc.loccode!='',CONCAT_WS(' - ',loc.loccode,loc.heading),loc.heading) locname, class.classname,".tzRetQueryStringDTime('depta.stime','DateTime','/')." cdate, curs.name cname, ".tzRetQueryStringDTime('depta.etime','DateTime','/')." mdate, murs.name mname,depta.loc_id,depta.deflt FROM contact_manage loc,department depta 
		LEFT JOIN department deptb ON depta.parent=deptb.sno 
		LEFT JOIN users curs ON depta.createdby=curs.username 
		LEFT JOIN users murs ON depta.modifiedby=murs.username 
		LEFT JOIN class_setup class ON (depta.classid=class.sno AND class.status='ACTIVE') 

		LEFT JOIN (SELECT COUNT(DISTINCT(emp_list.sno)) ct,emp_department FROM emp_list 
					
					WHERE emp_list.lstatus NOT IN ('DA','INACTIVE') 
					AND emp_list.empterminated != 'Y' GROUP BY emp_department) emp_cnt ON emp_cnt.emp_department=depta.sno 

		WHERE loc.serial_no=depta.loc_id 
		AND FIND_IN_SET('".$username."',depta.permission)>0 
		AND depta.status='Active'";
        
        $grpque=" GROUP BY depta.sno having 1 ";
		$oque2=" ORDER BY adeptname";
        
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields) ; // Order by fields, append the where clause accordingly
		$ostr = ($ostr == '')? $oque2 : $ostr;
        //$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		
		$tque = "select count(1) from ($oque $grpque $qstr $ostr) as temp";		//For Total Records Count
		$oque="$oque $grpque $qstr $ostr $lstr";	//For Total Records data
		
		$total =$gd->getTotalRows($tque);
    	$gridData=$gd->buildDepartments($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildCompaniesHis($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[7]."|".$row[5]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]='';
			$grid[$j][6]="hisreviewmanage.php?addr=".$row[0];
			$j++;

		}
		return $grid;
	}

	function getCompaniesHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
		global $maildb,$db,$username;

		$gd=new gridData();

		$asFields=array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.state","users.name","staffoppr_cinfo.owner");

		$tque="SELECT count(distinct(staffoppr_cinfo.sno))
        FROM users,staffoppr_cinfo
        WHERE users.username = staffoppr_cinfo.owner
        AND staffoppr_cinfo.status = 'INACTIVE'
        AND staffoppr_cinfo.owner = '".$username."' and crmcompany='Y'";

		$oque="SELECT
        staffoppr_cinfo.sno,
        staffoppr_cinfo.cname,
        staffoppr_cinfo.phone,
        staffoppr_cinfo.state,
        users.name,'',
        staffoppr_cinfo.owner
        FROM users,staffoppr_cinfo
        WHERE users.username = staffoppr_cinfo.owner
        AND staffoppr_cinfo.status = 'INACTIVE'
        AND staffoppr_cinfo.owner = '".$username."' and crmcompany='Y'";

        // Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('staffoppr_cinfo.phone',$asFields)){
			$asFieldsKey = array_search("staffoppr_cinfo.phone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_cinfo.phone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_cinfo.phone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,$ostr);
		$grpque=" group by staffoppr_cinfo.sno";
        $oque="$oque $qstr $grpque $ostr $lstr";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCompaniesHis($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	function buildCompanyActivities($que)
	{	
            global $maildb, $db, $con_id, $addr;

            $j		= 0;
            $grid	= array();
            $res	= mysql_query($que,$db);

            while ($row = mysql_fetch_array($res))
            {
            	if($row[5] == "Sent Mail" || $row[5] == "REmail") {
                    $despath	= "/BSOS/Activities/email/showemaildet.php?addr=".$addr."&reply=no&message=".$row[6]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Event") {
                    $despath	= "/BSOS/Activities/event/editnotes.php?addr=".$addr."&sno=".$row[6]."&con_id=".$con_id."&do_action=editevent&moduletype=".$_GET['module']."&act_type=".$row[5]."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Document") {
                    $despath	= "editdoc.php?addr=".$addr."&sno=".$row[6]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Task") {
                    $despath	= "/BSOS/Activities/task/edittask.php?module_type_appoint=Contacts->Companies&addr=".$addr."&sno=".$row[6]."&con_id=".$con_id."&do_action=edittask&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Appointment") {
                   $despath	= "/BSOS/Activities/appointment/editappoint.php?module_type_appoint=Contacts->Companies&addr=".$addr."&line=".$row[6]."&do_action=editappoint&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Campaign") {
                    $despath	= "/BSOS/Marketing/Campaigns/showcampaigndet.php?frm=act&val=".$row[6]."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Postings") {
                    $despath	= "/BSOS/Sales/Req_Post/postview.php?addr=".$addr."&val=".$row[6]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Submissions") {
                    $despath	= "/BSOS/Sales/Req_Mngmt/subinfo.php?addr=".$addr."&val=".$row[6]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                else if($row[5] == "Notes") {
                    $despath	= "/BSOS/Sales/Req_Mngmt/notes_details.php?sno=".$row[6]."&con_id=".$con_id."&csno=".$row[0]."&module=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
                }
                if($_GET['module'] == 'CRM'){
				$grid[$j][0] = '||'.$despath;
				}
				else{
				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0].'|'.$row[15]."'><span class='checkmark'></span></label>&nbsp;&nbsp;<br><br>".'||'.$despath.'||'.$row[0];
				}
                $grid[$j][1]	= $this->convertSpecChars(strtolower($row[1]));
                $grid[$j][2]	= $this->convertSpecChars($row[2]);
                $grid[$j][3]	= $this->convertSpecChars($row[3]);

                //code added as to avoid getting No Subject,other than Email...RameshT 
                if(($row[4] == "") && ($row[5] == "Sent Mail" || $row[5] == "REmail") ) {
                     $row[4]	= "No Subject";
                }

                $grid[$j][4]	= iconv("ISO-8859-1","UTF-8",$this->convertSpecChars($row[4]));

                if($row[5] == "REmail") {
                    $row[5]	= "Received Mail";
                }
                else if($row[5] == "Campaign") {
                    $row[5]	= "eCampaign";
                }
                else if($row[5] == "Submissions") {
                    $row[5]	= "Submission";
                }
                else if($row[5] == "Postings") {
                    $row[5] = "Posting";
                }

                //Added the attachment Icon  - Jyothi Chundi - 11/13/2014
                if($row[14] == 1 || $row[14] == '1') {
                    $url	= "<img src=/BSOS/images/icons/attach.gif alt='Reset' border=0 width=16 heigh=16>";
                }
                else {
                    $url	= "";
                }

                $grid[$j][5]	= $this->convertSpecChars($row[5]);
                $grid[$j][6]	= ($row[5]=="Appointment") ? $row[7] : $this->convertSpecChars($row[7]);
                $grid[$j][7]	= $this->convertSpecChars($row[10]);
                $grid[$j][8]	= $this->convertSpecChars($row[11]);
                $grid[$j][9]	= $this->convertSpecChars($row[12]);
                $grid[$j][10]	= $this->convertSpecChars($row[13]);
                $grid[$j][11]	= $url;
				if($row[5]=="Document" && (strstr($row[7],"POB") || strstr($row[7],"SIGNER"))){
					$filedownloadpath="/BSOS/Activities/document/getdoc.php?sno=".$row[6]."";
					$grid[$j][12]="<a href='".$filedownloadpath."'><i alt='Download Document' class='fa fa-download'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<a href='javascript: previewDocumentFile(".$row[6].")'><i class='fa fa-tasks' alt='View Document'></i></a>";
					if($row[15] == '1'){
						$grid[$j][13] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
					}else{
						$grid[$j][13] = '';
					}
					
				}
				if($_GET['module'] == 'Admin_Companies'){
					if($row[15] == '1'){
						$grid[$j][13] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
					}else{
						$grid[$j][13] = '';
					}
					$grid[$j][14] = $row[16];
					$grid[$j][15] = $row[17];
				}
				else{
					$grid[$j][13] = '';
				}


                $j++;
            }

            return $grid;
	}

	function getCompanyActivities($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
            global $maildb, $db, $username, $act_ids, $company_contact_names, $conNameCom, $e_type, $user_timezone, $contactNameChk, $addr, $comContIDS, $companyChildIds, $contactOldNameChk, $cmngmtIDs;

            $gd	= new gridData();
            $showAssocCand	= $showAssocContCand = $fetchStr = $varActType = $titleAdd = "";
            $flagCompHeirarchy	= false;

            $frm_module = $_GET['module'];
			if($frm_module == 'CRM'){
				$act_status = 'AND activity.activity_status = "0" ';
				$activity_status = 'AND cmngmt_pr.activity_status = "0" ';
			}else{
				$act_status = '';
				$activity_status = '';
			}
			 if($gridExtraFields['ShowCompHierarchy'] == "true")
            {
                if($companyChildIds != '')
                {
                    $flagCompHeirarchy	= true;

                    $resultSet		= prepareCompanyContactID($addr, $companyChildIds, $act_ids, 'true');
                    $tempAssCompIds = $resultSet['tempAssCompIds'];
                    $tempCompIds	= $resultSet['tempCompIds'];
                    $temp_compIds	= $resultSet['temp_compIds'];
                    $temp_company_contact_names	= $resultSet['temp_company_contact_names'];
                    $temp_comContIDS	= $resultSet['temp_comContIDS'];
                    $temp_contactNameChk	= $resultSet['temp_contactNameChk'];
                    $temp_conNameCom	= $resultSet['temp_conNameCom'];
                    $temp_contactOldNameChk	= $resultSet['temp_contactOldNameChk'];
                    $temp_cmngmtIDs	= $resultSet['temp_cmngmtIDs'];		
                }
            }	
		
            if($flagCompHeirarchy == false)
            {
                $tempAssCompIds	= "A".$addr."A";
                $tempCompIds	= $act_ids;
                $temp_compIds	= $addr;
                $temp_company_contact_names	= $company_contact_names;
                $temp_comContIDS	= $comContIDS;
                $temp_contactNameChk	= $contactNameChk;
                $temp_conNameCom	= $conNameCom;		
                $temp_contactOldNameChk	= $contactOldNameChk;
                $temp_cmngmtIDs	= $cmngmtIDs;
            }
		
            $temp_company_contact_names	= ",REPLACE(CONCAT_WS(' ',cont.fname,cont.mname,cont.lname),'  ',' ')";
		
            if($gridExtraFields['ShowAssoc'] == "true")
            {
                $cmgsnos	= "";

                $osFields	= array("","cmngmt_pr.sdate","users.name","REPLACE(CONCAT_WS(' ',cont.fname,cont.mname,cont.lname),'  ',' ')","cmngmt_pr.subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");

                $asFields	= array("","CAST(".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/')."AS CHAR)","users.name","REPLACE(CONCAT_WS(' ',cont.fname,cont.mname,cont.lname),'  ',' ')","cmngmt_pr.subject","cmngmt_pr.title","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");

                $fetchStr	= ", notesAssociate_fun(cmngmt_pr.joborder, 'JOB') AS JobOrder, notesAssociate_fun(cmngmt_pr.contact, 'CON') AS Contact, notesAssociate_fun(cmngmt_pr.company, 'COM') AS Company,notesAssociate_fun(cmngmt_pr.candidate, 'CAN') AS Candidate";			

                $showAssocCand	= " AND MATCH(cmngmt_pr.company) AGAINST ('".$tempAssCompIds."' IN BOOLEAN MODE)";

                $showAssocContCand	= " AND MATCH(cmngmt_pr.contact) AGAINST ('".$temp_comContIDS."' IN BOOLEAN MODE)";

                $snque	= "(SELECT sno FROM cmngmt_pr WHERE MATCH(con_id) AGAINST ('".$tempCompIds."' IN BOOLEAN MODE) $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE title='Notes' $showAssocCand $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE title='Notes' $showAssocContCand $activity_status) ";
                $snres	= mysql_query($snque,$db);
                while($snrow = mysql_fetch_row($snres)) {
                    $cmgsnos	.= $snrow[0].",";
                }

                $cmgsnos	= trim($cmgsnos,",");

                if($cmgsnos != "" && $temp_cmngmtIDs != "") {
                    $cmgsnos	.= ",".$temp_cmngmtIDs;
                }

                $tque	= "SELECT COUNT(1) 
                FROM users, cmngmt_pr 
                LEFT JOIN staffoppr_contact cont ON (cont.sno = REPLACE(cmngmt_pr.con_id,'oppr','') AND `status` = 'ER')  
                LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username)
                WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.sno IN ($cmgsnos) $activity_status";

                $oque	= "SELECT cmngmt_pr.sno,".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/').",users.name".$temp_company_contact_names.",cmngmt_pr.subject, IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title) AS title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username,cmngmt_pr.sno".$fetchStr.",cmngmt_pr.email_attach_flag ,cmngmt_pr.activity_status,u.name,".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."
                FROM users ,cmngmt_pr 
                LEFT JOIN staffoppr_contact cont ON (cont.sno = REPLACE(cmngmt_pr.con_id,'oppr','') AND `status` = 'ER') 
                LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username)
                WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.sno IN ($cmgsnos) $activity_status";
            }
            else
            {
                $fetchStr	= ",'' AS Candidate,'' AS Contact,'' AS Company,'' AS JobOrder";

                //Added the cmngmt_pr.email_attach_flag to osFields, asFields for Icon Attachment - Jyothi 11/13/2104
                $osFields	= array("","sdate","users.name","REPLACE(CONCAT_WS(' ',cont.fname,cont.mname,cont.lname),'  ',' ')","subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","subtype","cmngmt_pr.tysno", "cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");
			
                $asFields	= array("","cast(".tzRetQueryStringDTime('sdate','DateTime','/')."AS CHAR)","users.name","REPLACE(CONCAT_WS(' ',cont.fname,cont.mname,cont.lname),'  ',' ')","subject","title","subtype","cmngmt_pr.tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");
			
                $tque	= "SELECT COUNT(1) 
                FROM users, cmngmt_pr 
                LEFT JOIN staffoppr_contact cont ON (cont.sno = REPLACE(cmngmt_pr.con_id,'oppr','') AND `status` = 'ER') 
                LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username)
                WHERE cmngmt_pr.lmuser = users.username $activity_status";
            
                //Added the cmngmt_pr.email_attach_flag to oque for Icon Attachment - Jyothi 11/13/2104
                $oque	= "SELECT cmngmt_pr.sno,".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/').",users.name".$temp_company_contact_names.",cmngmt_pr.subject, IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title) AS title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username,cmngmt_pr.sno".$fetchStr.",cmngmt_pr.email_attach_flag,cmngmt_pr.activity_status,u.name,".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."
                FROM users,cmngmt_pr 
                LEFT JOIN staffoppr_contact cont ON (cont.sno = REPLACE(cmngmt_pr.con_id,'oppr','') AND `status` = 'ER') 
                LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username)
                WHERE cmngmt_pr.lmuser = users.username $activity_status";
            }
		
            $lstr	= $gd->buildLimt($gridPage,$gridRecords);
	
            if($gridSearchFields[4] == "Email") {
                $varActType	= "cmngmt_pr.title='Email'";
                $gridSearchFields[4]	= "";
                $titleAdd	= "";
            }
            else if($gridSearchFields[4] != "") {
                $titleAdd	= "";
            }
            else {
                $titleAdd	= " AND cmngmt_pr.title in ('".$e_type."') ";
            }
            $oque	.= $titleAdd;
            $tque	.= $titleAdd;

            if($gridSearchFields[12]=="0")
			{
				$varActType="activity_status='0'";
				$gridSearchFields[12]="";
			}
			if($gridSearchFields[12]=="1")
			{
				$varActType="activity_status='1'";
				$gridSearchFields[12]="";
			}
			
			$qstr	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			
            if($gridExtraFields['ShowAssoc'] != "true")
            {
                if($temp_cmngmtIDs != '') {
                    $qstr	.= " AND (match(con_id)against('".$tempCompIds."' in boolean mode) OR (cmngmt_pr.sno IN($temp_cmngmtIDs)))";
                }
                else {
                    $qstr	.= " AND (match(con_id)against('".$tempCompIds."' in boolean mode))";
                }
            }

            // In the function we used like % data % .In select box we have Email and REmail when i select only Email is getting the results of REmail also.Thats the reason added these conditions.
            if($qstr != "" && $varActType != "") {
                $qstr	.= " AND ".$varActType."";
            }
            else if($qstr == "" && $varActType != "") {
                $qstr	.= " AND (".$varActType.")";
            }
		
            $gstr	= " GROUP BY cmngmt_pr.sno".$havingStr;
            $ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$osFields); // Order by fields, append the where clause accordingly
            $tque	= $gd->buildTQuery($tque,$qstr,$gstr);
            $oque	= "$oque $qstr $gstr $ostr $lstr";

            $tres	= mysql_query($tque,$db);
            $total	= mysql_num_rows($tres);
            $gridData	= $gd->buildCompanyActivities($oque);
            $objResponse	= new xajaxResponse(CONVERT_DEFAULT_MAIL_CHAR,false);
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
            return $objResponse;
	}

	function buildAllActivities($que)
	{
		
		global $maildb,$db,$con_id,$addr,$module_type_appoint;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$despath ='';
			if($row[4]=="Sent Mail" || $row[4]=="REmail")
				$despath="/BSOS/Activities/email/showemaildet.php?addr=".$addr."&reply=no&message=".$row[5]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Event" || $row[4]=="Submitted" || $row[4]=="Placed")
				$despath="/BSOS/Activities/event/editnotes.php?addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&do_action=editevent&moduletype=".$_GET['module']."&act_type=".$row[4]."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Document")
				$despath="editdoc.php?addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Task")
				$despath="/BSOS/Activities/task/edittask.php?module_type_appoint=".$module_type_appoint."&addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&do_action=edittask&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Appointment")
				$despath="/BSOS/Activities/appointment/editappoint.php?module_type_appoint=".$module_type_appoint."&addr=".$addr."&line=".$row[5]."&do_action=editappoint&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Campaign")
				$despath="/BSOS/Marketing/Campaigns/showcampaigndet.php?frm=act&val=".$row[5]."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Postings")
				$despath="/BSOS/Sales/Req_Post/postview.php?addr=".$addr."&val=".$row[5]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4]=="Submissions")
				$despath="/BSOS/Sales/Req_Mngmt/subinfo.php?sno=".$addr."&val=".$row[5]."&con_id=".$con_id."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
            else if($row[4] == "Responded Details")
				$despath="/BSOS/Sales/Req_Mngmt/req_sub.php?frm=act&sno=".$row[5]."&moduletype=".$_GET['module']."&module=".$_GET['module']."&hidemodule=".$_GET['module'];
			else if($row[4] == "Notes")
				$despath="/BSOS/Sales/Req_Mngmt/notes_details.php?sno=".$row[5]."&con_id=".$con_id."&csno=".$row[0]."&module=".$_GET['module']."&hidemodule=".$_GET['module'];

			if($_GET['module'] == 'CRM'){
				$grid[$j][0] = '||'.$despath;
			}
			else{
				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0].'|'.$row[13]."'><span class='checkmark'></span></label>&nbsp;&nbsp;<br><br>".'||'.$despath.'||'.$row[0];
			}
			$grid[$j][1]=$this->convertSpecChars(strtolower($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			if(($row[3] == "") && ($row[4]=="Sent Mail" || $row[4]=="REmail") )
				$row[3]="No Subject";
			$grid[$j][3]=iconv("ISO-8859-1","UTF-8",$this->convertSpecChars($row[3]));

			if($row[4]=="REmail")
				$row[4]="Received Mail";
			else if($row[4]=="Campaign")
				$row[4]="eCampaign";
			else if($row[4]=="Submissions")
			    $row[4]="Submission";
			else if($row[4]=="Postings")
                $row[4]="Posting";
            else if($row[4]=="Textus Brdcst Sent")
            	$row[4]="TextUs Broadcast Sent";
		    else if($row[4]=="Call-Em-All Msg Sent" || $row[4]=="Call-Em-All Msg Rcvd" || $row[4]=="Call-Em-All BC Sent")
				$row[4]	= "Call-Em-All";	
                   
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=($row[4]=="Appointment")?$row[6]:$this->convertSpecChars($row[6]);
			$grid[$j][6]=$this->convertSpecChars($row[8]);
			$grid[$j][7]=$this->convertSpecChars($row[9]);
			$grid[$j][8]=$this->convertSpecChars($row[10]);
			$grid[$j][9]=$this->convertSpecChars($row[11]);
			
			 if($row[12] == 1 || $row[12] == '1')
			 {
			   $url="<img src=/BSOS/images/icons/attach.gif alt='Attach' border=0 width=16 heigh=16>";
			 }else{ 
			   $url="";
			  }
			$grid[$j][10]=$url;
			if($row[4]=="Document" && (strstr($row[6],"POB") || strstr($row[6],"SIGNER"))){
				if (CANDIDATE_VIEW_POB_DOCS == "N" && $module_type_appoint == "Marketing->Candidates") {
					$POBAlertMsg="You&nbsp;do&nbsp;not&nbsp;have&nbsp;access&nbsp;to&nbsp;view&nbsp;POB&nbsp;Documents.";
					$grid[$j][11]="<a href=javascript:alert('".$POBAlertMsg."');><i alt='Download Document' class='fa fa-download'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href=javascript:alert('".$POBAlertMsg."');><i class='fa fa-tasks' alt='View Document'></i></a>";
					$grid[$j][13]="viewPOBDocNo";
					if($row[13] == '1'){
					$grid[$j][12] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
				}else{
					$grid[$j][12] = '';
				}
				}else{
					$filedownloadpath="/BSOS/Activities/document/getdoc.php?sno=".$row[5]."";
					//$fileviewpath="/BSOS/Activities/document/viewdoc.php?sno=".$row[5]."";				
					$grid[$j][11]="<a href='".$filedownloadpath."'><i alt='Download Document' class='fa fa-download'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<a href='javascript: previewDocumentFile(".$row[5].")'><i class='fa fa-tasks' alt='View Document'></i></a>";
					$grid[$j][14]="";
					if($row[13] == '1'){
					$grid[$j][12] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
				}else{
					$grid[$j][12] = '';
				}
				}	
			}else{
				$grid[$j][11]="";
			}
		   //	$grid[$j][12]="";
			if($_GET['module'] == 'Admin_Candidates' || $_GET['module'] == 'Admin_Contacts'){
				if($row[13] == '1'){
					$grid[$j][12] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
				}else{
					$grid[$j][12] = '';
				}
				$grid[$j][13] = $row[14];
				$grid[$j][14] = $row[15];
			}
			else if($_GET['module'] == 'Admin_JobOrders' && $_GET['hidecrm']!= 'hidecrm')
			{
				if($row[13] == '1'){
					$grid[$j][11] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
				}else{
					$grid[$j][11] = '';
				}
				$grid[$j][12] = $row[14];
				$grid[$j][13] = $row[15];
			}
			else if($_GET['module'] == 'Admin_JobOrders' && $_GET['hidecrm'] == 'hidecrm')
			{
				if($row[13] == '1'){
					$grid[$j][12] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
				}else{
					$grid[$j][12] = '';
				}
				$grid[$j][13] = $row[14];
				$grid[$j][14] = $row[15];
			}
			else{
				$grid[$j][12]= "";
			}
			
			$j++;
			
		}
		return $grid;


	}

	function getAllActivities($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$con_id,$e_type,$user_timezone,$checkDomainCond_activities,$addr,$ats_con_id,$ats_emp_id,$ats_app_con_id; //$checkDomainCond_activities variable is to check the domain name and to display the activities accordingly.

		$gd=new gridData();
		$frm_module = $_GET['module'];
		if($frm_module == 'CRM'){
			$act_status = 'AND activity.activity_status = "0" ';
			$activity_status = 'AND cmngmt_pr.activity_status = "0" ';
		}else{
			$act_status = '';
			$activity_status = '';
		}
		//echo $frm_module;
		$varActType="";
		$fetchStr="";
		$showAssocCand="";

		if($gridExtraFields['ShowAssoc'] == "true")
		{
			$cmgsnos="";
			$fetchStr=", notesAssociate_fun(cmngmt_pr.joborder, 'JOB') AS JobOrder, notesAssociate_fun(cmngmt_pr.contact, 'CON') AS Contact, notesAssociate_fun(cmngmt_pr.company, 'COM') AS Company,notesAssociate_fun(cmngmt_pr.candidate, 'CAN') AS Candidate";
			//Added the cmngmt_pr.email_attach_flag to osFields, asFields for Icon Attachment - Jyothi 11/13/2104
			if($frm_module == 'Admin_JobOrders'){
				$osFields=array("","cmngmt_pr.sdate","users.name","cmngmt_pr.subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");
				$asFields=array("","cast(".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/')."AS CHAR)","users.name","cmngmt_pr.subject","cmngmt_pr.title","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");
			}else
			{
				$osFields=array("","cmngmt_pr.sdate","users.name","cmngmt_pr.subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");
				$asFields=array("","cast(".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/')."AS CHAR)","users.name","cmngmt_pr.subject","cmngmt_pr.title","cmngmt_pr.subtype","notesAssociate_fun(cmngmt_pr.joborder, 'JOB')","notesAssociate_fun(cmngmt_pr.contact, 'CON')","notesAssociate_fun(cmngmt_pr.company, 'COM')","notesAssociate_fun(cmngmt_pr.candidate, 'CAN')","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");
			}


			

			if(strpos($con_id, 'oppr') !== false)
				$showAssocCand = " AND MATCH(cmngmt_pr.contact) AGAINST (CONCAT('A',".$addr.",'A') IN BOOLEAN MODE)";
			else if(strpos($con_id, 'cand') !== false)
				$showAssocCand = " AND MATCH(cmngmt_pr.candidate) AGAINST (CONCAT('A',".substr($con_id,4).",'A') IN BOOLEAN MODE)";
			else if(strpos($con_id, 'req') !== false)
				$showAssocCand = " AND MATCH(cmngmt_pr.joborder) AGAINST (CONCAT('A',".$addr.",'A') IN BOOLEAN MODE)";

			if($ats_con_id == ''){
				$snque="(SELECT sno FROM cmngmt_pr WHERE cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$con_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE title='Notes' $showAssocCand $checkDomainCond_activities $activity_status)";
			}else{

				  $snque="(SELECT sno FROM cmngmt_pr WHERE cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$con_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$ats_con_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$ats_emp_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$ats_app_con_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT sno FROM cmngmt_pr WHERE title='Notes' $showAssocCand $checkDomainCond_activities $activity_status)";
				
			}
			$snres=mysql_query($snque,$db);
			while($snrow=mysql_fetch_row($snres))
				$cmgsnos .= $snrow[0].",";
			$cmgsnos = trim($cmgsnos,",");

			$tque="SELECT COUNT(cmngmt_pr.sno) FROM cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username),users WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.sno IN ($cmgsnos) $activity_status";
			//Added the cmngmt_pr.email_attach_flag to oque for Icon Attachment - Jyothi 11/13/2104
			$oque="SELECT cmngmt_pr.sno,".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/').",users.name,cmngmt_pr.subject,CASE WHEN cmngmt_pr.title = 'Email' THEN 'Sent Mail' WHEN cmngmt_pr.title = 'AplcntDistri' THEN 'Applicant Distribution' ELSE cmngmt_pr.title END AS title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag,cmngmt_pr.activity_status,u.name,".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')." FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.sno IN ($cmgsnos) $activity_status";
		}
		else
		{
		
		    $fetchStr = ",'' AS Candidate,'' AS Contact,'' AS Company,'' AS JobOrder";
		 //Added the email_attach_flag to osFields, asFields for Icon Attachment - Jyothi 11/13/2104	
		 	if($ats_con_id == ''){
			 	if($frm_module == 'Admin_Contacts')
			 	{
					$osFields=array("","cmngmt_pr.sdate","users.name","cmngmt_pr.subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","cmngmt_pr.subtype", "cmngmt_pr.tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");
					$asFields=array("","cast(".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/')."AS CHAR)","users.name","cmngmt_pr.subject","cmngmt_pr.title","cmngmt_pr.subtype","cmngmt_pr.tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");
				}else{
					$osFields=array("","cmngmt_pr.sdate","users.name","cmngmt_pr.subject","IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title)","cmngmt_pr.subtype", "cmngmt_pr.tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cmngmt_pr.hidden_date");
					$asFields=array("","cast(".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/')."AS CHAR)","users.name","cmngmt_pr.subject","cmngmt_pr.title","cmngmt_pr.subtype","cmngmt_pr.tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.email_attach_flag","cmngmt_pr.activity_status","u.name","cast(".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')."AS CHAR)");
				}
				
			}
			else{
				$osFields=array("","activity.sdate","activity.name","activity.subject","IF(activity.title='Email','Sent Mail',activity.title)","activity.subtype", "activity.tysno","activity.username","activity.email_attach_flag","activity.email_attach_flag","activity.email_attach_flag","activity.email_attach_flag","activity.activity_status","activity.name","activity.hidden_date");
				$asFields=array("","activity.sdate","activity.name","activity.subject","activity.title","activity.subtype","activity.tysno","activity.username","activity.email_attach_flag","activity.email_attach_flag","activity.email_attach_flag","activity.email_attach_flag","activity.activity_status","activity.name","activity.hidden_date");
			}
			
				$tque="SELECT COUNT(cmngmt_pr.sno) FROM cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) ,users  WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(con_id) AGAINST ('".$con_id."' IN boolean mode) $checkDomainCond_activities $activity_status";
				//Added the email_attach_flag to oque for Icon Attachment - Jyothi 11/13/2104
			
			if($ats_con_id == ''){
				$oque="SELECT cmngmt_pr.sno,".tzRetQueryStringDTime('cmngmt_pr.sdate','DateTime','/').",users.name,cmngmt_pr.subject,IF(cmngmt_pr.title='Email','Sent Mail',cmngmt_pr.title) AS title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag,cmngmt_pr.activity_status,u.name,".tzRetQueryStringDTime('cmngmt_pr.hidden_date','DateTime','/')." FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(cmngmt_pr.con_id) AGAINST ('".$con_id."' IN boolean mode) $checkDomainCond_activities $activity_status";
			}
			else{

				$oque="SELECT activity.sno,".tzRetQueryStringDTime('activity.sdate','DateTime','/')." as sdate,activity.name,activity.subject,CASE WHEN activity.title = 'Email' THEN 'Sent Mail' WHEN activity.title = 'AplcntDistri' THEN 'Applicant Distribution' ELSE activity.title END AS title,activity.tysno,activity.subtype,activity.username ".$fetchStr.",activity.email_attach_flag,activity.activity_status,activity.hidden_by,".tzRetQueryStringDTime('activity.hidden_date','DateTime','/')."  AS hidden_date FROM ((SELECT cmngmt_pr.sno,cmngmt_pr.sdate,users.name,cmngmt_pr.subject,cmngmt_pr.title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag,cmngmt_pr.activity_status,u.name AS hidden_by,cmngmt_pr.hidden_date FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(cmngmt_pr.con_id) AGAINST ('".$con_id."' IN boolean mode) $checkDomainCond_activities $activity_status) UNION (SELECT cmngmt_pr.sno,cmngmt_pr.sdate,users.name,cmngmt_pr.subject,cmngmt_pr.title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag, cmngmt_pr.activity_status,u.name AS hidden_by,cmngmt_pr.hidden_date FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(cmngmt_pr.con_id) AGAINST ('".$ats_con_id."' IN boolean mode) $checkDomainCond_activities $activity_status)  UNION (SELECT cmngmt_pr.sno,cmngmt_pr.sdate,users.name,cmngmt_pr.subject,cmngmt_pr.title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag, cmngmt_pr.activity_status,u.name AS hidden_by,cmngmt_pr.hidden_date FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(cmngmt_pr.con_id) AGAINST ('".$ats_emp_id."' IN boolean mode) $checkDomainCond_activities $activity_status)
				UNION (SELECT cmngmt_pr.sno,cmngmt_pr.sdate,users.name,cmngmt_pr.subject,cmngmt_pr.title,cmngmt_pr.tysno,cmngmt_pr.subtype,cmngmt_pr.username ".$fetchStr.",cmngmt_pr.email_attach_flag, cmngmt_pr.activity_status,u.name AS hidden_by,cmngmt_pr.hidden_date FROM users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) WHERE cmngmt_pr.lmuser = users.username AND cmngmt_pr.title IN ('".$e_type."') AND MATCH(cmngmt_pr.con_id) AGAINST ('".$ats_app_con_id."' IN boolean mode) $checkDomainCond_activities $act_stat) )  activity WHERE 1=1 $act_status ";

				
			}
		}

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		if($gridSearchFields[3]=="Email")
		{
			$varActType="title='Email'";
			$gridSearchFields[3]="";
		}
		if($_GET['module'] == 'Admin_JobOrders')
		{
			if($gridSearchFields[10]=="0")
			{
				$varActType="activity_status='0'";
				$gridSearchFields[10]="";
			}
			if($gridSearchFields[10]=="1")
			{
				$varActType="activity_status='1'";
				$gridSearchFields[10]="";
			}
		}else{
			if($gridSearchFields[11]=="0")
			{
				$varActType="activity_status='0'";
				$gridSearchFields[11]="";
			}
			if($gridSearchFields[11]=="1")
			{
				$varActType="activity_status='1'";
				$gridSearchFields[11]="";
			}
		}

		// In the buildQSTR() function we used like % data % .In select box we have Email and REmail when i select only Email its  getting the results of Email and  also REmail.Thats the reason added these conditions.
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="" && $varActType!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$varActType.")";
        }
        else if($qstr=="" && $varActType!="")
        {
            $qstr.=" AND (".$varActType.")";
        }
		if($ats_con_id == '' || $gridExtraFields['ShowAssoc'] == "true"){
			$gstr = " GROUP BY cmngmt_pr.sno";
		}
		else
		{
			if(strpos($qstr,"CONVERT_TZ(cmngmt_pr.sdate,'SYSTEM','EST5EDT')")!== false)
			{
				$qstr = str_replace("CONVERT_TZ(cmngmt_pr.sdate,'SYSTEM','EST5EDT')","CONVERT_TZ(activity.sdate,'SYSTEM','EST5EDT')",$qstr);
			}
			$gstr = " GROUP BY activity.sno";
		}
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); // Order by fields, append the where clause accordingly
		
		if($ats_con_id == '' || $gridExtraFields['ShowAssoc'] == "true"){
			$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		}else{
			$tque=$gd->buildTQuery($oque,$qstr,$gstr);
		}
		$oque="$oque $qstr $gstr $ostr $lstr";

		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		$gridData=$gd->buildAllActivities($oque,$frm_module);
		$objResponse = new xajaxResponse(CONVERT_DEFAULT_MAIL_CHAR,false);
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// Submission Candidates Grid Data
	function buildSubmissionCand($que,$posid,$gridSortCol,$gridSort,$module,$mode)
	{
		global $maildb,$db,$CandSubMode;

		$j=0;
		$grid=array();
		$HidName1=($CandSubMode=="camp")?"contype":"cand[]";
		$AuidRObName=($CandSubMode=="camp")?'sno':'resid';

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<input type=hidden name='' value='".$AuidRObName."'><label for='newuichk_".$j."' class='container-chk'><input type=hidden name=".$HidName1." value='".$row['sno']."' ><input type=checkbox name=auids[] id='newuichk_".$j."' OnClick='chk_clearTop();' value='".$row[$AuidRObName]."' ><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row['sno']."'>";
			$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
			$grid[$j][2]=$this->convertSpecChars($row['fname']);
			$grid[$j][3]=$this->convertSpecChars($row['lname']);
			$grid[$j][4]=$this->convertSpecChars($row['hphone']);
			$grid[$j][5]=$this->convertSpecChars($row['wphone']);
			$grid[$j][6]=$this->convertSpecChars($row['mobile']);
			
			// Areacode Radius (ACR) Condition
			if(isset($_SESSION['SPHINX_MCCandidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_MCCandidates']))
			{
				$areaMilesArr = explode("|", $_SESSION['SPHINX_MCCandidates_sub']['saveareacodePSM']);
				if(isset($_SESSION['ACR_SPHINX_MCCandidates'][$areaMilesArr[1]][$row['hareacode']]))
				{
					$grid[$j][7] = $_SESSION['ACR_SPHINX_MCCandidates'][$areaMilesArr[1]][$row['hareacode']];
				} else if(isset($_SESSION['ACR_SPHINX_MCCandidates'][$areaMilesArr[1]][$row['wareacode']])) {
					$grid[$j][7] = $_SESSION['ACR_SPHINX_MCCandidates'][$areaMilesArr[1]][$row['wareacode']];
				} else {
					$grid[$j][7] = $_SESSION['ACR_SPHINX_MCCandidates'][$areaMilesArr[1]][$row['mareacode']];
				}
			} else {
				$grid[$j][7]="";
			}

			$grid[$j][8]=$this->convertSpecChars($row['city']);
			$grid[$j][9]=$this->convertSpecChars($row['state']);
			$grid[$j][10]=$this->convertSpecChars($row['zip']);	

			// Zipcode Radius (ZCR) Condition
			if(isset($_SESSION['SPHINX_MCCandidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_MCCandidates']))
			{
				$zipMilesArr = explode("|", $_SESSION['SPHINX_MCCandidates_sub']['savezipCODE']);
				$grid[$j][11] = $_SESSION['ZCR_SPHINX_MCCandidates'][$zipMilesArr[1]][$row['zip']];
			} else {
				$grid[$j][11]="";
			}

			$grid[$j][12]=$this->convertSpecChars($row['descomp']);
			$grid[$j][13]=$this->convertSpecChars($row['candrate']);
			$grid[$j][14]=$this->convertSpecChars($row['candavl']);
			$grid[$j][15]=$this->convertSpecChars($row['candtype']);
			$grid[$j][16]=$this->convertSpecChars($row['mgname']);
			$grid[$j][17]=$this->convertSpecChars($row['credential_type']);
			$grid[$j][18]=$this->convertSpecChars($row['credential_name']);
			$grid[$j][19]=$this->convertSpecChars($row['cre_number']);
			$grid[$j][20]=$this->convertSpecChars($row['owname']);
			$grid[$j][21]=$this->convertSpecChars($row['score']);

			if($row['resid']=="" || $row['resid']==0)
				$grid[$j][22]="";
			else
				$grid[$j][22]="<a href=getresume.php?fsno=".$row['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
			$grid[$j][23]="";
			$grid[$j][24]="review.php?cno=".$row['sno']."&posid=$posid&dest=0&module=".$module."&mode=".$mode;
			$j++;
		}

		return $grid;
	}

	// CRM-Submission Candidates
	function getSubmissionCand($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$arrmatch,$posno,$user_timezone,$CandSubMode,$jobType;
		
		$selected_tab = $gridExtraFields['selected_tab'];
		$jo_shift_type = $gridExtraFields['jo_shift_type'];
		$module = $gridExtraFields['module'];
		$mode = $gridExtraFields['mode'];

		/********** BUILDING EXCEPTION CLAUSES AS OF JOB ORDER AND ADMIN - DATA MNGMT ***********/

		$AdminChk=($CandSubMode=="admin") ? "" : " AND (candidate_list.owner='$username' OR FIND_IN_SET('$username',candidate_list.accessto )>0 OR candidate_list.accessto='ALL') ";

		if($posno!="")
		{
			$rlque="SELECT candids FROM remove_lists WHERE username='$username' AND reqid='$posno'";
			$rlres=mysql_query($rlque,$db);
			$rlrow=mysql_fetch_row($rlres);

			if($rlrow[0]!="")
				$removed_candids_clause = " AND candidate_list.sno NOT IN (".$rlrow[0].") ";
			else
				$removed_candids_clause = "";
				
			if(SHIFT_SCHEDULING_ENABLED == 'N')
		 	{
		 		$shifts_on_job_qry 	= 	"select shiftid from posdesc where posid = '".$posno."'";
				$shifts_on_job_res 	=	mysql_query($shifts_on_job_qry,$db);
				$shifts_on_job_row 	=	mysql_fetch_row($shifts_on_job_res);
				$shifts_sno 		= 	$shifts_on_job_row[0];
				$shift_count 		=   count($shifts_on_job_row);
				
		 	}
		 	else
		 	{
		 		//when enabled the shift management
		 		if($jo_shift_type == "perdiem")
		 		{
					$shifts_on_job = "SELECT GROUP_CONCAT(DISTINCT(shift_id)) FROM jo_perdiem_shift_sch WHERE posid = '".$posno."'";
		 		}
		 		else
		 		{
		 			$shifts_on_job = "SELECT GROUP_CONCAT(DISTINCT(sm_sno)) FROM posdesc_sm_timeslots WHERE pid = '".$posno."'";					
		 		}
		 		
				$shifts_on_job_res =mysql_query($shifts_on_job,$db);
				$shifts_list = mysql_num_rows($shifts_on_job_res);
				
				$shifts_list_arr =mysql_fetch_row($shifts_on_job_res);

				if($shifts_list_arr[0] != "" ){
					$shifts_sno = implode(",",$shifts_list_arr);
				}else {
					$shifts_sno = 0;
				}

				$shift_count = explode(",",$shifts_sno);
		 	}
				
			
			//getting the submitted shifts count of job order to avoid the candidate if he submitted for all shifts
			$rsusername = array();
			$rsque="select resume_status.res_id,count(resume_status.shift_id) from resume_status, manage WHERE manage.sno = resume_status.status AND req_id='".$posno."' AND manage.name NOT IN ('Closed','Cancelled') AND resume_status.pstatus!='A' and resume_status.shift_id IN(".$shifts_sno.") group by resume_status.res_id";
								
			$rsres=mysql_query($rsque,$db);
			while($rsrow=mysql_fetch_row($rsres))
			{
				if($rsrow[1] == count($shift_count) ){
					$rsusername[] = $rsrow[0];
				}
				
			}
			$cand_sub_sphquery = '';
			if(count($rsusername)>0)
			if(($jo_shift_type != "perdiem") && ($selected_tab == 0 || $selected_tab == ""))
			{
				$cand_sub_query=" AND candidate_list.sno NOT IN (".implode(",",$rsusername).") "; 
				$cand_sub_sphquery="!filter=snoid,".implode(",",$rsusername).";";
			}
			else
			{
				$cand_sub_query = "";
			}

			
				
			$scoreQuery = " LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.posid = $posno and cm.module='mc' ) ";
			
		}
		else
		{
			$cand_sub_query = "";
			$scoreQuery = " LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.module='mc' ) ";
		}

		/********** END OF BUILDING EXCEPTION CLAUSES AS OF JOB ORDER AND ADMIN - DATA MNGMT ***********/

		require("zipCodeSearch.inc");

		$gd=new gridData();
		
		$setHeapSizeQry = "SET SESSION max_heap_table_size=1073740800";
		mysql_query($setHeapSizeQry,$db);
					
		$setTmpTableSizeQry = "SET SESSION tmp_table_size=1073740800";
		mysql_query($setTmpTableSizeQry,$db);

		$tque="SELECT count(DISTINCT(candidate_list.sno)) ";

		$oque="SELECT
		candidate_list.sno as sno,
		candidate_list.username as username,
		candidate_list.profiletitle as profiletitle,
		candidate_list.fname as fname,
		candidate_list.lname as lname,
		candidate_list.hphone as hphone,
		candidate_list.wphone as wphone,
		candidate_list.mobile as mobile,
		candidate_list.hareacode as hareacode,
		candidate_list.wareacode as wareacode,
		candidate_list.mareacode as mareacode,
		candidate_list.city as city,
		candidate_list.state as state,
		candidate_list.zip as zip,
		IF((candidate_list.amount = '0' OR candidate_list.amount = '' ),'',CONCAT_WS(' ', candidate_list.amount, CONCAT_WS('/',candidate_list.currency, candidate_list.period))) as descomp,
		IF((candidate_list.pramount = '0' OR candidate_list.pramount = '' ),'',CONCAT_WS(' ', candidate_list.pramount, CONCAT_WS('/',candidate_list.rcurrency, IF((candidate_list.rperiod = 'hourly'),'HOUR',IF((candidate_list.rperiod = 'daily'),'DAY',IF((candidate_list.rperiod = 'weekly'),'WEEK', IF((candidate_list.rperiod = 'monthly'),'MONTH', IF((candidate_list.rperiod = 'yearly'),'YEAR',IF((candidate_list.rperiod = 'semi-monthly'),'SEMI-MONTH', IF((candidate_list.rperiod = 'biweekly'),'BI-WEEK', IF((candidate_list.rperiod = 'fortnightly'),'FORT-NIGHT', IF((candidate_list.rperiod = 'perunit'),'UNIT',IF((candidate_list.rperiod = 'flatfee'),'FLATFEE', candidate_list.rperiod))))))))))))) as candrate,
		candidate_list.avail as candavl,
		IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as candtype,
		users.name as owname,
		candidate_list.resid as resid,
		manage.name as mgname, TRIM(BOTH ',' FROM GROUP_CONCAT(mct.credential_type)) AS credential_type, TRIM(BOTH ',' FROM GROUP_CONCAT(mcn.credential_name)) AS credential_name, TRIM(BOTH ',' FROM GROUP_CONCAT(cc.cre_number)) AS cre_number,
		cm.score as score,candidate_list.ctype,candidate_list.owner ";

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			require("quickSubCandidates.inc");
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$serdb);				
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			require("visualsearch_mccandidates.php");
			require("database.inc");		
		}
		else
		{
			//$oque.=", '' as score ";
			$aqstr="";
		}
	    
		if(!empty($gridExtraFields['scheduleviewtype']) && !empty($gridExtraFields['schedulesearchtype'])){
			
			// All distinct job order shift dates stored in this array
			$jo_shifts_arr = array();
				
			// Stores Candidate's Details
			$candidates_details = array();
			
			// Stores Candidate's Username
			$candidates_usernames = array();
			
			//Show only those shift dates which are present in selected shift
			if(!empty($gridExtraFields['sm_shift_snos'])){
				$selShiftCond = " AND sm_sno IN (".$gridExtraFields['sm_shift_snos'].") ";
				$selPerdiemShiftCond = " AND shift_id IN (".$gridExtraFields['sm_shift_snos'].") ";
			}
			
			// Find distinct shift schedule dates for job order. Required to map the data correctly with the columns in the grid. Considers 90 Days only starting from yesterday.		
			if($jo_shift_type == "perdiem")
			{
				$jo_sel_shifts = "SELECT DISTINCT(DATE_FORMAT(shift_startdate,'%m/%d/%Y')) as shift_date FROM jo_perdiem_shift_sch WHERE posid = '".$posno."'  AND shift_startdate >= DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ".$selPerdiemShiftCond." ORDER BY shift_startdate ASC LIMIT 0,90 ";
			}	
			else
			{
				$jo_sel_shifts = "SELECT DISTINCT(DATE_FORMAT(shift_date,'%m/%d/%Y')) as shift_date FROM posdesc_sm_timeslots WHERE pid = '".$posno."'  AND shift_date >= DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ".$selShiftCond." ORDER BY shift_date ASC LIMIT 0,90 ";
			}
			
			$jo_res_shifts = mysql_query($jo_sel_shifts,$db);
		
			while($jo_row_shifts = mysql_fetch_array($jo_res_shifts)){
				$jo_shifts_arr[] = $jo_row_shifts['shift_date'];
			}	
		
			usort($jo_shifts_arr, array($this, "sort_shift_dates"));
			$jo_shifts_arr_len = count($jo_shifts_arr);		
			
			if($jo_shifts_arr_len > 0){
				if($jo_shift_type == "perdiem")
				{
					$candidates_details = $gd->getCandidatesMatchingJOPerdiemShifts($posno, $jo_shifts_arr, $gridExtraFields);	
				}
				else{
					$candidates_details = $gd->getCandidatesMatchingJOShifts($posno, $jo_shifts_arr, $gridExtraFields);	
				}
				
				$candidates_usernames = array_keys($candidates_details);
				$append_fname_query = "";
				if(empty($candidates_usernames)){
					$append_fname_query = " AND candidate_list.fname!='' ";
				}
			}
			$ss_cand_sub_query=" AND candidate_list.username IN ('".implode("','",$candidates_usernames)."') ".$append_fname_query;
		}

		if($aqstr=="")
			$aqstr=" 1=1 ";

		$tque.=" FROM users, $searchCond candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id $scoreQuery "; 
		$tque.=" WHERE candidate_list.status='ACTIVE' $AdminChk $removed_candids_clause $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username AND ".$aqstr." ";

		$oque.=" FROM users, $searchCond candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id $scoreQuery "; 
		$oque.=" WHERE candidate_list.status='ACTIVE' $AdminChk $removed_candids_clause $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username AND ".$aqstr." ";

		
		if($gridExtraFields['tabname'] == "schedulesearch"){
			
			$asFields=array("","trim(candidate_list.fname)","trim(candidate_list.lname)");
		
			$osFields=array("","trim(a.fname)","trim(a.lname)");
		}else{
			$asFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","ACR","candidate_list.city","candidate_list.state","candidate_list.zip","ZCR","IF((candidate_list.amount = '0' OR candidate_list.amount = '' ),'',CONCAT_WS(' ', candidate_list.amount, CONCAT_WS('/',candidate_list.currency, candidate_list.period)))","IF((candidate_list.pramount = '0' OR candidate_list.pramount = '' ),'',CONCAT_WS(' ', candidate_list.pramount, CONCAT_WS('/',candidate_list.rcurrency, IF((candidate_list.rperiod = 'hourly'),'HOUR',IF((candidate_list.rperiod = 'daily'),'DAY',IF((candidate_list.rperiod = 'weekly'),'WEEK', IF((candidate_list.rperiod = 'monthly'),'MONTH', IF((candidate_list.rperiod = 'yearly'),'YEAR',IF((candidate_list.rperiod = 'semi-monthly'),'SEMI-MONTH', IF((candidate_list.rperiod = 'biweekly'),'BI-WEEK', IF((candidate_list.rperiod = 'fortnightly'),'FORT-NIGHT', IF((candidate_list.rperiod = 'perunit'),'UNIT',IF((candidate_list.rperiod = 'flatfee'),'FLATFEE', candidate_list.rperiod)))))))))))))","candidate_list.avail","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","mct.credential_type","mcn.credential_name","cc.cre_number","users.name","score");
	
			$osFields=array("","a.profiletitle","trim(a.fname)","trim(a.lname)","a.hphone","a.wphone","a.mobile","ACR","a.city","a.state","a.zip","ZCR","CAST(REPLACE(a.descomp,',','') AS UNSIGNED)","CAST(REPLACE(a.candrate,',','') AS UNSIGNED)","a.candavl","IF(a.ctype='Employee','Employee',IF(a.owner='$username','My Candidate','Candidate'))","a.mgname","a.credential_type","a.credential_name","a.cre_number","a.owname","score");
			$cand_match_score = "select count(1) from candidates_matchingscore where posid = '".$posno."' Group By posid";
			$cand_match_score_res =mysql_query($cand_match_score,$db);
			$cand_match_score_cnt =  mysql_fetch_row($cand_match_score_res);
			//echo "numrows---".$cand_match_score_cnt[0];
			if($cand_match_score_cnt[0] !="" && $cand_match_score_cnt[0] > 0)
			{
					$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields);
			}else{
				
				$ostr = "";
			}
		}
                
        if($osFields[$gridSortCol]=='candidate_list.avail'){ // donot change the column name fetching
            $ostr ="ORDER BY IF(a.candavl IN('Inactive','Immediate'),a.candavl,DATE_FORMAT(STR_TO_DATE(a.candavl, '%m/%d/%Y'), '%Y-%m-%d')) ".$gridSort ;
        }else{
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); 
        }
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.wphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.wphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.mobile',$asFields)){
			$asFieldsKey = array_search("candidate_list.mobile", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
		}
 		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$tque=$gd->buildTQuery($tque,$qstr.$duplicateCheck,$gstr);

		$gstr	= " GROUP BY candidate_list.sno ";
		$oque = "Select * from(".$oque.$qstr.$duplicateCheck.$gstr.$lstr.") as a";
		$oque=$gd->buildOQuery($oque,$qstr="".$duplicateCheck="",$ostr,$lstr="",$gstr=""); 
		//$oque=$gd->buildOQuery($oque,$qstr.$duplicateCheck,$ostr,$lstr,$gstr); 

		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}
		
		if($gridExtraFields['tabname'] == "schedulesearch"){
			if($gridExtraFields['scheduleviewtype'] == 2){
				$gridData=$gd->buildSubmissionCandScheduleSearchDailyDetailsView($oque,$posno,$gridSortCol,$gridSort,$gridExtraFields,$candidates_details);
			}else{	  		        
				$gridData=$gd->buildSubmissionCandScheduleSearch($oque,$posno,$gridSortCol,$gridSort,$gridExtraFields,$jo_shifts_arr,$candidates_details,$jo_shift_type);
			}
		}else{

			// ZCR order by condition 
			if(isset($_SESSION['SPHINX_MCCandidates_sub']['savezipCODE']))
			{
				if(isset($_SESSION['ZCR_SPHINX_MCCandidates'])){
					$zipMilesArr = explode("|", $_SESSION['SPHINX_MCCandidates_sub']['savezipCODE']);
					$ZcrSortArr = $_SESSION['ZCR_SPHINX_MCCandidates'];

					asort($ZcrSortArr[$zipMilesArr[1]]);

					$ZcrOrderByQry = "'".implode("','",array_keys($ZcrSortArr[$zipMilesArr[1]]))."'";

					$oque = str_replace("ZCR","field(a.zip,".$ZcrOrderByQry.")",$oque);
				} else {
					$oque = str_replace("ZCR","a.zip",$oque);
				}
			} else {
				$oque = str_replace("ZCR","a.zip",$oque);
			}

			// ACR order by condition 
			if(isset($_SESSION['SPHINX_MCCandidates_sub']['saveareacodePSM']))
			{
				if(isset($_SESSION['ACR_SPHINX_MCCandidates'])){
					$areaMilesArr = explode("|", $_SESSION['SPHINX_MCCandidates_sub']['saveareacodePSM']);
					$AcrSortArr = $_SESSION['ACR_SPHINX_MCCandidates'];

					asort($AcrSortArr[$areaMilesArr[1]]);

					$AcrOrderByQry = "'".implode("','",array_keys($AcrSortArr[$areaMilesArr[1]]))."'";

					$oque = str_replace("ACR","field(IF(a.hareacode IN(".$AcrOrderByQry."),a.hareacode,IF(candidate_list.wareacode IN(".$AcrOrderByQry."),a.wareacode,IF(a.mareacode IN(".$AcrOrderByQry."),a.mareacode,''))),".$AcrOrderByQry.")",$oque);
				}
			} else {
				$oque = str_replace("ACR","a.hareacode",$oque); 
			}

			$gridData=$gd->buildSubmissionCand($oque,$posno,$gridSortCol,$gridSort,$module,$mode);			
		}

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function getCandidatesMatchingJOShifts($joborder_id, $jo_shifts_arr, $gridExtraFields){
	        global $db;
		
		// Matched Candidates
		$matched_cands = array();
		
		$jo_shifts_arr_len = count($jo_shifts_arr);
			
		// Match Shift Option selected by user.
		$match_shift_option = $gridExtraFields['schedulesearchtype'] ;
		$append_hours = 0;
		
		// Match Options selected - Exact Match, Partial Match or Extend Match + Hours
		if($match_shift_option == 3)
		{
			$append_hours = $gridExtraFields['appendhours']; // For Option 3: Extend Match + Hours. Currently set to 1 Hour	
		}

		if($match_shift_option == 2){	// Condition for Partial Match

			$whereCond_match_shift = " AND (((UNIX_TIMESTAMP(pst.shift_starttime) > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(pst.shift_starttime) < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_endtime) > UNIX_TIMESTAMP(cst.shift_endtime)) OR (UNIX_TIMESTAMP(pst.shift_endtime) > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(pst.shift_endtime) < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_starttime) < UNIX_TIMESTAMP(cst.shift_starttime)) OR (UNIX_TIMESTAMP(pst.shift_endtime) > UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_starttime) <= UNIX_TIMESTAMP(cst.shift_starttime)) OR (UNIX_TIMESTAMP(pst.shift_endtime) >= UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_starttime) < UNIX_TIMESTAMP(cst.shift_starttime))) OR (UNIX_TIMESTAMP(pst.shift_starttime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_endtime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime))) ";
			
		}else if($match_shift_option == 3){ // Condition for Extended Match + Hours 
			if($append_hours > 0){    				
				
				$whereCond_match_shift = " AND (UNIX_TIMESTAMP(pst.shift_starttime) BETWEEN UNIX_TIMESTAMP(SUBDATE(cst.shift_starttime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(ADDDATE(cst.shift_endtime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(pst.shift_endtime) BETWEEN UNIX_TIMESTAMP(SUBDATE(cst.shift_starttime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(ADDDATE(cst.shift_endtime, INTERVAL ".$append_hours." MINUTE))) ";					  
			}else{
				$whereCond_match_shift = " AND (UNIX_TIMESTAMP(pst.shift_starttime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_endtime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";
			}
		}else{	// Condition for Exact Match 	
			$whereCond_match_shift = " AND (UNIX_TIMESTAMP(pst.shift_starttime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(pst.shift_endtime) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";
		}
		
		//Match only those shift snos which are selected by user
		if(!empty($gridExtraFields['sm_shift_snos'])){
			$whereCond_match_shift .= " AND pst.sm_sno IN (".$gridExtraFields['sm_shift_snos'].") ";
		}
			
		// View option selected - Full Schedule View or Daily Details View
		
		if($gridExtraFields['scheduleviewtype'] == 2 ){  // for daily details view
			
			// User Selected Date		
			$user_sel_date = $gridExtraFields['user_sel_date'];
			
			if($search_module == 'schedulesearch')
			{
			 $cand_sql_query = "SELECT
				cst.username, 
				GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(pst.shift_starttime,'TO',pst.shift_endtime),pst.sm_sno,stp.shiftcolor) SEPARATOR ',') AS cand_avail_details 
				FROM candidate_sm_timeslots cst
				INNER JOIN posdesc_sm_timeslots pst
				ON cst.shift_date = pst.shift_date
				INNER JOIN shift_setup stp
				ON stp.sno = pst.sm_sno
				WHERE cst.shift_status = 'available' AND
				concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
							SELECT concat(concat('cand',res_id),'-',shift_id) 
							FROM resume_status, manage 
							WHERE  manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
				AND pst.pid = '".$joborder_id."'
				AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
				AND DATE_FORMAT(pst.shift_date,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";
				
			}else{
				
				$cand_sql_query = "SELECT
				cst.username, 
				GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(pst.shift_starttime,'TO',pst.shift_endtime),pst.sm_sno,stp.shiftcolor) order by pst.sm_sno ASC SEPARATOR ',') AS cand_avail_details 
				FROM candidate_sm_timeslots cst
				INNER JOIN posdesc_sm_timeslots pst
				ON cst.shift_date = pst.shift_date
				INNER JOIN shift_setup stp
				ON stp.sno = pst.sm_sno
				WHERE cst.shift_status = 'available' AND
				concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
							SELECT concat(concat('cand',res_id),'-',shift_id) 
							FROM resume_status, manage 
							WHERE  manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
				AND pst.pid = '".$joborder_id."'
				AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
				AND DATE_FORMAT(pst.shift_date,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";
			
			}
		}
		else // for full schedule view
		{
			$avail_dates = $jo_shifts_arr;
			$all_avail_dates =  implode("','",$avail_dates);	
			
			$matched_cands = array();
			if($search_module == 'schedulesearch')
			{
				 $cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.sm_sno,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN posdesc_sm_timeslots pst
						  ON cst.shift_date = pst.shift_date
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.sm_sno
						WHERE cst.shift_status = 'available' AND
						concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
                            SELECT concat(concat('cand',res_id),'-',shift_id) FROM resume_status, manage 
                            WHERE  
                            manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
						  AND pst.pid = '".$joborder_id."'
						  AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.sm_sno ";	
			}else{
			
				$cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.sm_sno,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN posdesc_sm_timeslots pst
						  ON cst.shift_date = pst.shift_date
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.sm_sno
						WHERE cst.shift_status = 'available' AND
						concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
                            SELECT concat(concat('cand',res_id),'-',shift_id) FROM resume_status, manage 
                            WHERE  
                            manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
						  AND pst.pid = '".$joborder_id."'
						  AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.sm_sno ";	
			
			}
		}
		
		$cand_res = mysql_query($cand_sql_query,$db);
		
		while($cand_row = mysql_fetch_array($cand_res)){
			$matched_candidate = $cand_row['username'];
			
			if($gridExtraFields['scheduleviewtype'] == 1){
			
				if($search_module == 'schedulesearch')
				{
					$matched_cands[$matched_candidate][] = $cand_row['avail_date'].'|'.$cand_row['sm_sno'].'|'.$cand_row['shiftcolor'];	
				}else{
					$matched_cands[$matched_candidate][] = $cand_row['avail_date'].'|'.$cand_row['sm_sno'].'|'.$cand_row['shiftcolor'];	
				}
			}		
			if($gridExtraFields['scheduleviewtype'] == 2){
				$matched_cands[$matched_candidate][] = $cand_row['cand_avail_details'];	
			}		
		}
		
		if($gridExtraFields['scheduleviewtype'] == 1){  // for full schedule view
			$sm_shifts_snos_count = 0;
			if(!empty($gridExtraFields['sm_shift_snos'])){
				$sm_shifts_snos_arr = explode(",",$gridExtraFields['sm_shift_snos']);
				$sm_shifts_snos_count = count($sm_shifts_snos_arr);
			}			
			// Removes a candidate record whose availability dates are not matching all shift dates within a shift selected. This is applicable only in case of EXACT SHIFT MATCHING and EXTENDED MATCH + HOURS
			if($match_shift_option != 2 && $sm_shifts_snos_count == 1){
				foreach($matched_cands as $matched_cand_key=>$matched_cand_val){
					$matched_cand_avail_dates_count = count($matched_cand_val);
					if($matched_cand_avail_dates_count != $jo_shifts_arr_len){
						unset($matched_cands[$matched_cand_key]);
					}
				}
			}
		}
		
		return $matched_cands;		
	}
	
	function getCandidatesMatchingJOPerdiemShifts($joborder_id, $jo_shifts_arr, $gridExtraFields){
	        global $db;
		
		// Matched Candidates
		$matched_cands = array();
		
		$jo_shifts_arr_len = count($jo_shifts_arr);
			
		// Match Shift Option selected by user.
		$match_shift_option = $gridExtraFields['schedulesearchtype'] ;
		$append_hours = 0;
		
		// Match Options selected - Exact Match, Partial Match or Extend Match + Hours
		if($match_shift_option == 3)
		{
			$append_hours = $gridExtraFields['appendhours']; // For Option 3: Extend Match + Hours. Currently set to 1 Hour	
		}

		if($match_shift_option == 2){	// Condition for Partial Match

			$whereCond_match_shift = " AND (((UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) > UNIX_TIMESTAMP(cst.shift_endtime)) OR (UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) < UNIX_TIMESTAMP(cst.shift_starttime)) OR (UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) > UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) <= UNIX_TIMESTAMP(cst.shift_starttime)) OR (UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) >= UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) < UNIX_TIMESTAMP(cst.shift_starttime))) OR (UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime))) ";
			
		}else if($match_shift_option == 3){ // Condition for Extended Match + Hours 
			if($append_hours > 0){    				
				
				$whereCond_match_shift = " AND (UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(SUBDATE(cst.shift_starttime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(ADDDATE(cst.shift_endtime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(SUBDATE(cst.shift_starttime, INTERVAL ".$append_hours." MINUTE)) AND UNIX_TIMESTAMP(ADDDATE(cst.shift_endtime, INTERVAL ".$append_hours." MINUTE))) "; 
			}else{
        		$whereCond_match_shift = " AND (UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";
			}
		}else{	// Condition for Exact Match 	
			
			$whereCond_match_shift = " AND (UNIX_TIMESTAMP(cast(concat(pst.shift_startdate, ' ', pst.shift_starttime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(cast(concat(pst.shift_enddate, ' ', pst.shift_endtime) as DATETIME)) BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";
		}
		
		//Match only those shift snos which are selected by user
		if(!empty($gridExtraFields['sm_shift_snos'])){
			$whereCond_match_shift .= " AND pst.shift_id IN (".$gridExtraFields['sm_shift_snos'].") ";
		}
			
		// View option selected - Full Schedule View or Daily Details View
		
		if($gridExtraFields['scheduleviewtype'] == 2 ){  // for daily details view
			
			// User Selected Date		
			$user_sel_date = $gridExtraFields['user_sel_date'];
			
			if($search_module == 'schedulesearch')
			{
				/* $cand_sql_query = "SELECT
					cst.username, 
					GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(CONCAT(pst.shift_startdate, ' ', pst.shift_starttime),'TO',CONCAT(pst.shift_enddate, ' ', pst.shift_endtime)),pst.shift_id,stp.shiftcolor) SEPARATOR ',') AS cand_avail_details 
					FROM candidate_sm_timeslots cst
					INNER JOIN jo_perdiem_shift_sch_search pst
					ON cst.shift_date = pst.shift_startdate
					INNER JOIN shift_setup stp
					ON stp.sno = pst.shift_id
					WHERE cst.shift_status = 'available' AND
					concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
								SELECT concat(concat('cand',res_id),'-',shift_id) 
								FROM resume_status, manage 
								WHERE  manage.sno = resume_status.status AND 
	                            req_id = '".$joborder_id."' AND 
	                            manage.name NOT IN ('Closed','Cancelled') AND 
	                            resume_status.pstatus != 'A' 
							)
					AND pst.posid = '".$joborder_id."'
					AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
					AND DATE_FORMAT(pst.shift_startdate,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";*/
				$cand_sql_query = "SELECT
					cst.username, 
					GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(CONCAT(pst.shift_startdate, ' ', pst.shift_starttime),'TO',CONCAT(pst.shift_enddate, ' ', pst.shift_endtime)),pst.shift_id,stp.shiftcolor) SEPARATOR ',') AS cand_avail_details 
					FROM candidate_sm_timeslots cst
					INNER JOIN jo_perdiem_shift_sch_search pst
					ON cst.shift_date = pst.shift_startdate
					INNER JOIN shift_setup stp
					ON stp.sno = pst.shift_id
					WHERE cst.shift_status = 'available'
					AND pst.posid = '".$joborder_id."'
					AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
					AND DATE_FORMAT(pst.shift_startdate,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";				
			}else{
				
				/* $cand_sql_query = "SELECT
				cst.username, 
				GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(CONCAT(pst.shift_startdate, ' ', pst.shift_starttime),'TO',CONCAT(pst.shift_enddate, ' ', pst.shift_endtime)),pst.shift_id,stp.shiftcolor) ORDER BY pst.shift_id ASC SEPARATOR ',') AS cand_avail_details 
				FROM candidate_sm_timeslots cst
				INNER JOIN jo_perdiem_shift_sch_search pst
				ON cst.shift_date = pst.shift_startdate
				INNER JOIN shift_setup stp
				ON stp.sno = pst.shift_id
				WHERE cst.shift_status = 'available' AND
				concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
							SELECT concat(concat('cand',res_id),'-',shift_id) 
							FROM resume_status, manage 
							WHERE  manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
				AND pst.posid = '".$joborder_id."'
				AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
				AND DATE_FORMAT(pst.shift_startdate,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";*/
				$cand_sql_query = "SELECT
				cst.username, 
				GROUP_CONCAT(DISTINCT CONCAT_WS('|',CONCAT(CONCAT(pst.shift_startdate, ' ', pst.shift_starttime),'TO',CONCAT(pst.shift_enddate, ' ', pst.shift_endtime)),pst.shift_id,stp.shiftcolor) ORDER BY pst.shift_id ASC SEPARATOR ',') AS cand_avail_details 
				FROM candidate_sm_timeslots cst
				INNER JOIN jo_perdiem_shift_sch_search pst
				ON cst.shift_date = pst.shift_startdate
				INNER JOIN shift_setup stp
				ON stp.sno = pst.shift_id
				WHERE cst.shift_status = 'available' 
				AND pst.posid = '".$joborder_id."'
				AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') = '".$user_sel_date."'
				AND DATE_FORMAT(pst.shift_startdate,'%m/%d/%Y') = '".$user_sel_date."' ".$whereCond_match_shift." GROUP BY cst.username";			
			}
		}
		else // for full schedule view
		{
			$avail_dates = $jo_shifts_arr;
			$all_avail_dates =  implode("','",$avail_dates);	
			
			$matched_cands = array();
			if($search_module == 'schedulesearch')
			{
				/* $cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.shift_id,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN jo_perdiem_shift_sch_search pst
						  ON cst.shift_date = pst.shift_startdate
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.shift_id
						WHERE cst.shift_status = 'available' AND
						concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
                            SELECT concat(concat('cand',res_id),'-',shift_id) FROM resume_status, manage 
                            WHERE  
                            manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
						  AND pst.posid = '".$joborder_id."'
						  AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.shift_id ";*/	
				 $cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.shift_id,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN jo_perdiem_shift_sch_search pst
						  ON cst.shift_date = pst.shift_startdate
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.shift_id
						WHERE cst.shift_status = 'available' 
						AND pst.posid = '".$joborder_id."'
						AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.shift_id ";						  
			}else{
			
				/* $cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.shift_id,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN jo_perdiem_shift_sch_search pst
						  ON cst.shift_date = pst.shift_startdate
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.shift_id
						WHERE cst.shift_status = 'available' AND
						concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
                            SELECT concat(concat('cand',res_id),'-',shift_id) FROM resume_status, manage 
                            WHERE  
                            manage.sno = resume_status.status AND 
                            req_id = '".$joborder_id."' AND 
                            manage.name NOT IN ('Closed','Cancelled') AND 
                            resume_status.pstatus != 'A' 
						)
						  AND pst.posid = '".$joborder_id."'
						  AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.shift_id ";	*/
				$cand_sql_query = "SELECT
						cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.shift_id,stp.shiftcolor
						FROM candidate_sm_timeslots cst
						INNER JOIN jo_perdiem_shift_sch_search pst
						  ON cst.shift_date = pst.shift_startdate
						INNER JOIN shift_setup stp
						  ON stp.sno = pst.shift_id
						WHERE cst.shift_status = 'available' 
						AND pst.posid = '".$joborder_id."'
						AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.shift_id ";				
			}
		}
		//echo $cand_sql_query;
		$cand_res = mysql_query($cand_sql_query,$db);
		
		while($cand_row = mysql_fetch_array($cand_res)){
			$matched_candidate = $cand_row['username'];
			
			if($gridExtraFields['scheduleviewtype'] == 1){
			
				if($search_module == 'schedulesearch')
				{
					$matched_cands[$matched_candidate][] = $cand_row['avail_date'].'|'.$cand_row['shift_id'].'|'.$cand_row['shiftcolor'];	
				}else{
					$matched_cands[$matched_candidate][] = $cand_row['avail_date'].'|'.$cand_row['shift_id'].'|'.$cand_row['shiftcolor'];	
				}
			}		
			if($gridExtraFields['scheduleviewtype'] == 2){
				$matched_cands[$matched_candidate][] = $cand_row['cand_avail_details'];	
			}		
		}
		//print_r($matched_cands);
		if($gridExtraFields['scheduleviewtype'] == 1){  // for full schedule view
			$sm_shifts_snos_count = 0;
			if(!empty($gridExtraFields['sm_shift_snos'])){
				$sm_shifts_snos_arr = explode(",",$gridExtraFields['sm_shift_snos']);
				$sm_shifts_snos_count = count($sm_shifts_snos_arr);
			}			
			// Removes a candidate record whose availability dates are not matching all shift dates within a shift selected. This is applicable only in case of EXACT SHIFT MATCHING and EXTENDED MATCH + HOURS
			if($match_shift_option != 2 && $sm_shifts_snos_count == 1){
				foreach($matched_cands as $matched_cand_key=>$matched_cand_val){
					$matched_cand_avail_dates_count = count($matched_cand_val);
					if($matched_cand_avail_dates_count != $jo_shifts_arr_len){
						unset($matched_cands[$matched_cand_key]);
					}
				}
			}
		}
		
		return $matched_cands;		
	}
	
	// Submission Candidates Grid Data - Schedule Search
	function buildSubmissionCandScheduleSearch($que,$posid,$gridSortCol,$gridSort,$gridExtraFields,$jo_shifts_arr,$candidates_details,$jo_shift_type)
	{
		global $maildb,$db,$CandSubMode;

		$j=0;
		$grid=array();
		$HidName1=($CandSubMode=="camp")?"contype":"cand[]";
		$AuidRObName=($CandSubMode=="camp")?'sno':'resid';
		
			
		$jo_shifts_arr_uniq = array_values(array_unique($jo_shifts_arr)) ;
		$jo_shifts_arr_len = count($jo_shifts_arr_uniq);
		$sm_sno = $gridExtraFields['sm_shift_snos'];
		$sch_search_type = $gridExtraFields['schedulesearchtype'];
		// Match Options selected - Exact Match, Partial Match or Extend Match + Hours
		if($sch_search_type == 3)
		{
			$append_hours = $gridExtraFields['appendhours']; // For Option 3: Extend Match + Hours. Currently set to 1 Hour	
		}
		
		$res=mysql_query($que,$db);
		$cand_avail_dates = array();
		while ($row=mysql_fetch_array($res))
		{		
			$cand_avail_dates = array();
			$avail_dates = array();
		
			$grid[$j][0]="<label class='container-chk' for='newuichk_".$j."'><input type=hidden name=".$HidName1." value='".$row['sno']."'><input type=checkbox name=auids[] id='newuichk_".$j."' OnClick='chk_clearTop();' value='".$row[$AuidRObName]."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row['sno']."'>";			
			
			$grid[$j][1]=$this->convertSpecChars($row['fname']);
			$grid[$j][2]=$this->convertSpecChars($row['lname']);
			$candname = $row['fname']."_".$row['lname'];
			$grid[$j][3]="<a style='padding: 1px 0px 0px 30px;' href=javascript:displayTimeFrameWindow('/include/shift_schedule/viewalltimeframes.php?refid=".$row['username']."&posid=$posid&module=Req_Mngmt&smsno=$sm_sno&schtype=$sch_search_type&candname=$candname&append_hours=$append_hours&shift_type=$jo_shift_type')><font class=linkrow><i class='fa fa-info-circle'></i></font></a>";
			
			// Finds this current candidate's availability details.
			$candidate_username = $row['username'];
			$avail_dates = $candidates_details[$candidate_username];
			
			foreach ($avail_dates as $key => $value){
				
				$avail_shift_date = explode('|',$value,2);
				$cand_avail_dates[] = $avail_shift_date[0];
			}
			
			// Displays Full Schedule View - for 90 Days starting from yesterday's date 
			for($k = 0; $k<$jo_shifts_arr_len; $k++){
				$cand_avail_keys = array();
				$cand_avail_keys_count = "";
				$width_each_shift ="";
				$shift_div_content = "";
				if(in_array($jo_shifts_arr_uniq[$k],$cand_avail_dates)){
					$cand_avail_keys = array();
					$shift_div_content = "";
					$cand_avail_keys = array_keys($cand_avail_dates,$jo_shifts_arr_uniq[$k]);
					$cand_avail_keys_count = count($cand_avail_keys);
					$tot_shift_width = 100;
					$width_each_shift = 100/$cand_avail_keys_count;
					
					foreach($cand_avail_keys as $ky=>$val){
					$shif_data = "";
					$avail_shift_data=array();$shift_color ="";
					$shif_data = $avail_dates[$val];
					$avail_shift_data = explode('|',$shif_data);
					$shift_color =  $avail_shift_data[2];
					$shift_div_content .= "<div class= 'availstaus' style='background:{$shift_color};display: inline-block;width: {$width_each_shift}px;height:100%'>&nbsp;</div>";
					}
					
						
				}
				
				if(!empty($shift_div_content)){
					$grid[$j][$k+4] = $shift_div_content;
				}else{
					$grid[$j][$k+4] = ""; 
				}
			}				
			if($jo_shifts_arr_len > 0){
				$updated_index = $jo_shifts_arr_len+4;
			}else{
				$updated_index = 4;
			}
			$grid[$j][$updated_index] = "";
			$grid[$j][$updated_index+1] = "review.php?cno=".$row['sno']."&posid=$posid&dest=0";	 		
						
			$j++;
		}		
		return $grid;		
	}	
	
	function fillShiftColors($timeslot,$fromTF,$toTF,$shiftColor){
		
		/*if($timeslot == 1410)
			$timeslot = $timeslot+29;
		else
		$timeslot = $timeslot+30;*/
		
		
		for($i=0; $i < count($fromTF); $i++){
			if($fromTF[$i]<=$timeslot && $timeslot < $toTF[$i]){
				return $shiftColor[$i];
			}
		}
		return FALSE;
		
	}		
	
	// Submission Candidates Grid Data - Schedule Search - Daily details View
	function buildSubmissionCandScheduleSearchDailyDetailsView($que,$posid,$gridSortCol,$gridSort,$gridExtraFields,$candidates_details)
	{
		global $maildb,$db,$CandSubMode;	
		
		$j=0;
		$grid=array();
		$HidName1=($CandSubMode=="camp")?"contype":"cand[]";
		$AuidRObName=($CandSubMode=="camp")?'sno':'resid';					
		
		// User Selected Date		
		$user_sel_date = $gridExtraFields['user_sel_date'];		
		
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{		
			$style = "";
			$cand_avail_exists_str = "";
			$color_code = "";
			$fromTF = array();
			$toTF = array();
			
			$grid[$j][0]="<input type=hidden name=".$HidName1." value='".$row['sno']."'><label class='container-chk' for='newuichk_".$j."'><input type=checkbox name=auids[] id='newuichk_".$j."' OnClick='chk_clearTop();' value='".$row[$AuidRObName]."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row['sno']."'>";			
			
			$grid[$j][1]=$this->convertSpecChars($row['fname']);
			$grid[$j][2]=$this->convertSpecChars($row['lname']);			
			
		
			$candidate_username = $row['username'];
			$cand_avail_details = $candidates_details[$candidate_username][0];
			
			$cand_avail_details_arr = explode(",",$cand_avail_details);
		
			$avail_time = array();
			$shiftColor = array();
			foreach($cand_avail_details_arr as $cand_avail){
				
				$avail_time			=	explode("|",$cand_avail);
				list($stime,$etime) = explode("TO",$avail_time[0]);
				$expSTime		= explode(' ',$stime);
				$getSTimeHourMins	= '0000-00-00 '.$expSTime[1];
				$fromTF[] = (( date("H",strtotime($getSTimeHourMins)) * 60 ) + ( date("i",strtotime($getSTimeHourMins))));

				$expETime		= explode(' ',$etime);
				$getETimeHourMins	= '0000-00-00 '.$expETime[1];
				$toTF[] = (( date("H",strtotime($getETimeHourMins)) * 60 ) + ( date("i",strtotime($getETimeHourMins))));
				$shiftColor[] = $avail_time[2];
				 
			}			

			$html_content = "<div class='timegridcontainer' id='timegridmaindiv$j'>";			
								
			for($k=0;$k<1439;)
			{	
				
				$fillColor = $this->fillShiftColors($k,$fromTF,$toTF,$shiftColor);
				
				if($fillColor){
					$style = "style='background-color: ".$fillColor."' ";
					$cand_avail_exists_str .= $style;
				}else{
					$style = "";
				}
				
				if($k == 1425)
					$k = $k+14;
				else
					$k = $k+15;
				if($k == 1439)
				{
					//$html_content .= "<div class='timegridlast' id='grid_$j_$k' $style>&nbsp;</div>";
					$html_content .= "<div class='timegrid' id='grid_$j_$k' $style>&nbsp;</div>";
				}
				else
				{
					$html_content .= "<div class='timegrid' id='grid_$j_$k' $style>&nbsp;</div>";				
				}				
			}
													
			$html_content .= "</div>";							
			
			$grid[$j][3]= $html_content;						
			
			$grid[$j][4] = "";
			$grid[$j][5] = "review.php?cno=".$row['sno']."&posid=$posid&dest=0";
						
			$j++;
		}
	
		return $grid;
	}
	function fillColor($timeslot,$fromTF,$toTF){
		
		for($i=0; $i < count($fromTF); $i++){
			if($fromTF[$i]<=$timeslot && $timeslot < $toTF[$i]){
				return TRUE;
			}
		}
		return FALSE;
		
	}		
	
	// Sorts Dates in chronological order
	function sort_shift_dates($date1, $date2){
		$date1 = strtotime($date1);
		$date2 = strtotime($date2);
		if ($date1 == $date2) $r = 0;
		else $r = ($date1 > $date2) ? 1: -1;							
		return $r;
	}
	
	//Function for CRM -> eCampaign Job Orders -- Gopi
	function getJobeCampaignList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$addStatus;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
		
		$aqstr=" 1=1 ";
		
		$asFields=array("","postitle","refcode","cname","manage.name","DATE_FORMAT(CONVERT_TZ(posstartdate,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')","no_of_pos","IF(reqrate.rateopen!='',reqrate.rateopen,reqrate.amount)","joblocation","cusr.name"); 
					  
		$ssFields=array("","postitle","refcode","cname","manage.name","CONVERT_TZ(posstartdate,'SYSTEM','".$user_timezone[1]."')","no_of_pos","IF(reqrate.rateopen!='',reqrate.rateopen,reqrate.amount)","joblocation","cusr.name");
							
 		$tque="select COUNT(posdesc.posid) as count from manage ma,posdesc  LEFT JOIN users cusr ON (posdesc.username=cusr.username) LEFT JOIN staffoppr_cinfo ON posdesc.company = staffoppr_cinfo.sno LEFT JOIN manage ON posdesc.postype = manage.sno and manage.type='jotype' LEFT JOIN reqrate ON posdesc.posid = reqrate.posid  where (posdesc.owner='".$username."' or FIND_IN_SET('".$username."',posdesc.accessto)>0 or posdesc.accessto='all' or posdesc.type='staffacc') and posdesc.status in ('approve','Accepted') AND posdesc.posstatus = ma.sno AND ma.name = 'Open' AND ma.type='jostatus'";
				
		$oque="select posdesc.posid,postitle,refcode,if(posdesc.type='staffoppr',staffoppr_cinfo.cname,'') as cname,manage.name,DATE_FORMAT(CONVERT_TZ(posstartdate,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),no_of_pos,IF(reqrate.rateopen!='',reqrate.rateopen,reqrate.amount) as rate,joblocation,cusr.name from manage ma,posdesc  LEFT JOIN users cusr ON (posdesc.username=cusr.username) LEFT JOIN staffoppr_cinfo ON posdesc.company = staffoppr_cinfo.sno LEFT JOIN manage ON posdesc.postype = manage.sno and manage.type='jotype' LEFT JOIN reqrate ON posdesc.posid = reqrate.posid where (posdesc.owner='".$username."' or FIND_IN_SET('".$username."',posdesc.accessto)>0 or posdesc.accessto='all' or posdesc.type='staffacc') and posdesc.status in ('approve','Accepted') AND posdesc.posstatus = ma.sno AND ma.name = 'Open' AND ma.type='jostatus'";
		
		$gstr="group by posdesc.posid ";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		if($gridSearchFields[5] != "")
		{
			$grpt = " and no_of_pos = '".$gridSearchFields[5]."'";	
			$gridSearchFields[5] = "";
		}

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr.= $grpt;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$tque = "select count(a.count) from ($tque) a";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildJobeCampaignData($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	//This is for CRM -> eCampaign Job Orders Grid Data.. - Gopi.
	function buildJobeCampaignData($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			if($row[4] == "0/0/0000")
				$row[4] = "";
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);					
			$grid[$j][10]="";
			$grid[$j][11]=$row[0];
			$j++;
		}
		return $grid;
	}
	
	
	// COLLABORATION - Task Manager
	function getTaskManager($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=8;
		$gd=new gridData();

		$asFields=array("","tasks.taskname","tasklist.title","IF(tasklist.recurrence='recurrence', 'Yes', 'No')","REPLACE(tasklist.regarding,'  ',' ')",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'), "if(tasklist.duedate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")", "tasklist.priority", "if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Overdue',tasklist.taskstatus))","created_user.name",tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/'),"modified_user.name", "if(tasklist.mdate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').")");
        $ssFields=array("","tasks.taskname","tasklist.title","IF(tasklist.recurrence='recurrence', 'Yes', 'No')","REPLACE(tasklist.regarding,'  ',' ')","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)", "tasklist.priority", "if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Z',if(tasklist.taskstatus='','Y',tasklist.taskstatus)))","created_user.name","tasklist.datecreated","modified_user.name","if(tasklist.mdate='0000-00-00', '',tasklist.mdate)");


		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.sendto='' and tasklist.cuser='".$username."' and tasklist.status not in ('remove','backup','ARCHIVE')";

		$oque="select tasklist.sno,
		group_concat(tasks.taskname),
		tasklist.title, IF(tasklist.recurrence='recurrence', 'Yes', 'No') AS recurrence, tasklist.regarding,".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').", if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."), if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Overdue',tasklist.taskstatus)), tasklist.contactsno,tasklist.modulename,tasklist.tasktype,
		tasklist.priority,created_user.name,".tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/').",modified_user.name,if(tasklist.mdate ='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').") from tasklist LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) 
		LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.sendto='' and tasklist.cuser='".$username."' and tasklist.status not in ('remove','backup','ARCHIVE')";
        
		$grpque="group by tasklist.sno";
		
		$varActType="";
		if($gridSearchFields[8]=="Overdue")
		{
			$varActType="status='Overdue'";
			$gridSearchFields[8]="";
		}
		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND (FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type))";
 			$gridSearchFields[0]="";
 		}
        
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		if($qstr!="" && $varActType!="")
		{
			$qstr=substr($qstr,0,(strlen($qstr)-1));
			$qstr.=" AND ".$varActType.")";
		}
		else if($qstr=="" && $varActType!="")
		{
			$qstr.=" AND (".$varActType.")";
		}

		$qstr .= $varttype;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
        if($gridSortCol==5)
            $ostr = $ostr." ,tasklist.duedate desc,tasklist.sno desc";
        else if($gridSortCol==6)
            $ostr = $ostr." ,tasklist.startdate desc,tasklist.sno desc";
        else
            $ostr = $ostr.",tasklist.startdate desc,tasklist.duedate desc,tasklist.sno desc";
		$tque=$gd->buildTQuery($tque,$qstr);
        $oque="$oque $qstr $grpque $ostr $lstr";
        //echo $oque;
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTaskManager($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager
	function buildTaskManager($que)
	{
		global $maildb,$db;

		$j		= 0;
		$grid	= array();
		$res	= mysql_query($que,$db);

		while ($row=mysql_fetch_array($res)) {

			if ($row[3] == 'Yes')
			$rflag	= 'Y';
			elseif ($row[3] == 'No')
			$rflag	= 'N';

			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value='".$row[0]."|".$row[8]."|".$row[9]."|".$row[0]."~".$rflag."|'"."><span class='checkmark'></span></label>";

			if($row[7]=="Overdue")
			{
				$grid[$j][1]="<font class=taskcaption>".$this->convertSpecChars($row[1])."</font>";
				$grid[$j][2]="<font class=taskcaption>".$this->convertSpecChars($row[2])."</font>";
				$grid[$j][3]="<font class=taskcaption>".$this->convertSpecChars($row[3])."</font>";
				$grid[$j][4]="<font class=taskcaption>".$this->convertSpecChars($row[4])."</font>";
				$grid[$j][5]="<font class=taskcaption>".$this->convertSpecChars($row[5])."</font>";
				$grid[$j][6]="<font class=taskcaption>".$this->convertSpecChars($row[6])."</font>";
				$grid[$j][7]="<font class=taskcaption>".$this->convertSpecChars($row[11])."</font>";
				$grid[$j][8]="<font class=taskcaption>".$this->convertSpecChars($row[7])."</font>";
				$grid[$j][9]="<font class=taskcaption>".$this->convertSpecChars($row[12])."</font>";
				$grid[$j][10]="<font class=taskcaption>".$this->convertSpecChars($row[13])."</font>";
				$grid[$j][11]="<font class=taskcaption>".$this->convertSpecChars($row[14])."</font>";
				$grid[$j][12]="<font class=taskcaption>".$this->convertSpecChars($row[15])."</font>";
			}
			else
			{
				$grid[$j][1]=$this->convertSpecChars($row[1]);
				$grid[$j][2]=$this->convertSpecChars($row[2]);
				$grid[$j][3]=$this->convertSpecChars($row[3]);
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
				$grid[$j][6]=$this->convertSpecChars($row[6]);
				$grid[$j][7]=$this->convertSpecChars($row[11]);
				$grid[$j][8]=$this->convertSpecChars($row[7]);
				$grid[$j][9]= $this->convertSpecChars($row[12]);
				$grid[$j][10]= $this->convertSpecChars($row[13]);
				$grid[$j][11]= $this->convertSpecChars($row[14]);
				$grid[$j][12]= $this->convertSpecChars($row[15]);
			}

			/*$grid[$j][9]	= '';
			$grid[$j][10]	= $this->convertSpecChars($row[0]);
			$grid[$j][11]	= $this->convertSpecChars($row[10]);*/
			$grid[$j][13]	= '';
			$grid[$j][14]	= $this->convertSpecChars($row[0]);
			$grid[$j][15]	= $this->convertSpecChars($row[10]);
			

			$j++;
		}
		return $grid;
	}
	
	// COLLABORATION - Task Manager Assigned To You Completed Tasks
	function getAssignToYouComp($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=7;
		$gd=new gridData();
		
		$asFields=array("","tasks.taskname","tasklist.title","emp_list.name",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'),"if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")", "tasklist.priority", "if(tasklist.datecom='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.datecom','Date','/').")");
		
$ssFields=array("","tasks.taskname","tasklist.title","emp_list.name","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)","tasklist.priority", "if(tasklist.datecom='0000-00-00', '',tasklist.datecom) ");
				
		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN emp_list ON emp_list.username=tasklist.cuser LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) where FIND_IN_SET('".$username."',tasklist.sendto) and tasklist.cuser!='".$username."' and tasklist.taskstatus='Completed' and tasklist.status not in ('remove','backup')";

		$oque="select tasklist.sno,group_concat(distinct(tasks.taskname)),tasklist.title,emp_list.name,".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').",if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."), if(tasklist.datecom='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.datecom','Date','/')."),tasklist.priority from tasklist LEFT JOIN emp_list ON emp_list.username=tasklist.cuser LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) where FIND_IN_SET('".$username."',tasklist.sendto) and tasklist.cuser!='".$username."' and tasklist.taskstatus='Completed' and tasklist.status not in ('remove','backup')";
        
        $grpque="group by tasklist.sno";
        
		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND (FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type))";
 			$gridSearchFields[0]="";
 		}
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr .= $varttype;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
        $oque="$oque $qstr $grpque $ostr $lstr";

    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAssignToYouComp($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager Assigned To You Completed Tasks
	function buildAssignToYouComp($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
            $grid[$j][6]=$this->convertSpecChars($row[7]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]="";//$this->convertSpecChars($row[0]);
			$grid[$j][9]=$this->convertSpecChars($row[0]);
			
			$j++;
		}
		return $grid;
	}
	
	// COLLABORATION - Task Manager Assigned By You Completed Tasks
	function getAssignByYouComp($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=7;
		$gd=new gridData();
		
		$asFields=array("","tasks.taskname","tasklist.title","emp_list.name",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'),"if(tasklist.duedate='0000-00-00','', ".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")", "tasklist.priority", "if(tasklist.datecom='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.datecom','Date','/').")");
        $ssFields=array("","tasks.taskname","tasklist.title","emp_list.name","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)", "tasklist.priority", "if(tasklist.datecom='0000-00-00', '',tasklist.datecom) ");
				
		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN emp_list ON FIND_IN_SET(emp_list.username,tasklist.sendto) LEFT JOIN tasks on FIND_IN_SET(tasks.taskid,tasklist.type) where tasklist.cuser='".$username."' and tasklist.sendto!='' and tasklist.taskstatus='Completed' and tasklist.status not in ('remove','backup')";

		$oque="select tasklist.sno,group_concat(distinct(tasks.taskname)),tasklist.title,group_concat(distinct(emp_list.name)),".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').",if(tasklist.duedate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."),if(tasklist.datecom='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.datecom','Date','/')."),tasklist.priority from tasklist LEFT JOIN emp_list ON FIND_IN_SET(emp_list.username,tasklist.sendto) LEFT JOIN tasks on FIND_IN_SET(tasks.taskid,tasklist.type) where tasklist.cuser='".$username."' and tasklist.sendto!='' and tasklist.taskstatus='Completed' and tasklist.status not in ('remove','backup')";
        
        $grpque="group by tasklist.sno";
        
		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND (FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type))";
 			$gridSearchFields[0]="";
 		}
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr .= $varttype;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
        $oque="$oque $qstr $grpque $ostr $lstr";
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAssignByYouComp($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager Assigned By You Completed Tasks
	function buildAssignByYouComp($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
            $grid[$j][6]=$this->convertSpecChars($row[7]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]="";//$this->convertSpecChars($row[0]);
			$grid[$j][9]=$this->convertSpecChars($row[0]);
			
			$j++;
		}
		return $grid;
	}
	
	// COLLABORATION - Task Manager Assigned By You
	function getAssignByYou($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=6;

		$gd=new gridData();

		$asFields=array("","tasks.taskname","tasklist.title","emp_list.name",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'),"if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")", "tasklist.priority", "tasklist.taskstatus","created_user.name",tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/'),"modified_user.name", "if(tasklist.mdate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').")");
        $ssFields=array("","tasks.taskname","tasklist.title","emp_list.name","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)", "tasklist.priority", "if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Z',if(tasklist.taskstatus='','Y',tasklist.taskstatus)))","created_user.name","tasklist.datecreated","modified_user.name","if(tasklist.mdate='0000-00-00', '',tasklist.mdate)");

		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN emp_list ON FIND_IN_SET(emp_list.username,tasklist.sendto) LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.cuser='".$username."' and tasklist.sendto!='' and tasklist.taskstatus!='Completed' and tasklist.status not in ('remove','backup')";
		$oque="select tasklist.sno,group_concat(distinct(tasks.taskname)),tasklist.title,tasklist.sendto,".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').",if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."),tasklist.taskstatus,tasklist.priority,tasklist.tasktype,tasklist.contactsno,tasklist.modulename,tasklist.recurrence,created_user.name,".tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/').",modified_user.name,if(tasklist.mdate ='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').") from tasklist LEFT JOIN emp_list ON FIND_IN_SET(emp_list.username,tasklist.sendto) LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.cuser='".$username."' and tasklist.sendto!='' and tasklist.taskstatus!='Completed' and tasklist.status not in ('remove','backup')";

        $grpque="group by tasklist.sno";

		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND (FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type))";
 			$gridSearchFields[0]="";
 		}

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr .= $varttype;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		if($gridSortCol==4)
            $ostr = $ostr." ,tasklist.duedate desc,tasklist.sno desc";
        else if($gridSortCol==5)
            $ostr = $ostr." ,tasklist.startdate desc,tasklist.sno desc";
        else
            $ostr = $ostr.",tasklist.startdate desc,tasklist.duedate desc,tasklist.sno desc";

		$tque=$gd->buildTQuery($tque,$qstr,$grpque);
		$tque="SELECT count(*) FROM ($tque) count"; //For Total Records Count
        $oque="$oque $qstr $grpque $ostr $lstr";

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAssignByYou($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager Assigned By You
	function buildAssignByYou($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$row[3] = trim($row[3],',');
			$prow="";

			if($row[3])
            {
    			$pqry="SELECT group_concat(emp_list.name) from emp_list where username IN ($row[3])";
    			$pres=mysql_query($pqry,$db);
    			$prow=mysql_fetch_row($pres);
            }

			if ($row[11] == 'Yes')
				$rflag	= 'Y';
			elseif ($row[11] == 'No')
				$rflag	= 'N';
			
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($prow[0]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);	
			$grid[$j][6]=$this->convertSpecChars($row[7]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]= $this->convertSpecChars($row[12]);
			$grid[$j][9]= $this->convertSpecChars($row[13]);
			$grid[$j][10]= $this->convertSpecChars($row[14]);
			$grid[$j][11]= $this->convertSpecChars($row[15]);
			$grid[$j][12]="";
			$grid[$j][13]=$this->convertSpecChars($row[0]);
			$grid[$j][14]=$row[0]."|".$row[9]."|".$row[10]."|".$row[0]."~".$rflag;
			$grid[$j][15]=$this->convertSpecChars($row[8]);
			
			$j++;
		}
		return $grid;
	}

	// COLLABORATION - Task Manager Assigned To You
	function getAssignToYou($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=7;
		$gd=new gridData();
		
  $asFields=array("","tasks.taskname","tasklist.title","emp_list.name",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'),"if(tasklist.duedate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")","tasklist.priority","tasklist.taskstatus","created_user.name",tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/'),"modified_user.name", "if(tasklist.mdate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').")");
        $ssFields=array("","tasks.taskname","tasklist.title","emp_list.name","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)","tasklist.priority","if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Z',if(tasklist.taskstatus='','Y',tasklist.taskstatus)))","created_user.name","tasklist.datecreated","modified_user.name","if(tasklist.mdate='0000-00-00', '',tasklist.mdate)");
				
		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN emp_list ON emp_list.username=tasklist.cuser LEFT JOIN tasks ON tasklist.type in(tasks.taskid) LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where FIND_IN_SET('".$username."',tasklist.sendto) and tasklist.cuser!='".$username."' and tasklist.taskstatus!='Completed' and tasklist.status not in ('remove','backup')";

		$oque="select tasklist.sno,group_concat(distinct(tasks.taskname)),tasklist.title,emp_list.name,".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').",if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."),tasklist.taskstatus,tasklist.priority,tasklist.tasktype,tasklist.contactsno,tasklist.modulename,tasklist.recurrence,created_user.name,".tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/').",modified_user.name,if(tasklist.mdate ='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').") from tasklist LEFT JOIN emp_list ON emp_list.username=tasklist.cuser LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type)  LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where FIND_IN_SET('".$username."',tasklist.sendto) and tasklist.cuser!='".$username."' and tasklist.taskstatus!='Completed' and tasklist.status not in ('remove','backup')";
        
		$grpque="group by tasklist.sno";
        
		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND (FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type))";
 			$gridSearchFields[0]="";
 		}
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr .= $varttype;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		
		if($gridSortCol==4)
            $ostr = $ostr." ,tasklist.duedate desc,tasklist.sno desc";
        else if($gridSortCol==5)
            $ostr = $ostr." ,tasklist.startdate desc,tasklist.sno desc";
        else
            $ostr = $ostr.",tasklist.startdate desc,tasklist.duedate desc,tasklist.sno desc";
		
		$tque=$gd->buildTQuery($tque,$qstr);
        $oque="$oque $qstr $grpque $ostr $lstr";
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAssignToYou($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager Assigned To You
	function buildAssignToYou($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			if ($row[11] == 'Yes')
			$rflag	= 'Y';
			elseif ($row[11] == 'No')
			$rflag	= 'N';

			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
            $grid[$j][6]=$this->convertSpecChars($row[7]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]= $this->convertSpecChars($row[12]);
			$grid[$j][9]= $this->convertSpecChars($row[13]);
			$grid[$j][10]= $this->convertSpecChars($row[14]);
			$grid[$j][11]= $this->convertSpecChars($row[15]);

			$grid[$j][12]="";//$this->convertSpecChars($row[0]);
			$grid[$j][13]=$this->convertSpecChars($row[0]);
			$grid[$j][14]=$row[0]."|".$row[9]."|".$row[10];
			$grid[$j][15]=$this->convertSpecChars($row[8]);
			
			$j++;
		}
		return $grid;
	}
	
	// COLLABORATION - Task Manager Archive
	function getTaskManagerArch($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=7;
		$gd=new gridData();
		
		$asFields=array("","tasks.taskname","tasklist.title","tasklist.regarding",tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/'),	"if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/').")", "tasklist.priority", "if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Overdue',tasklist.taskstatus))","created_user.name",tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/'),"modified_user.name", "if(tasklist.mdate='0000-00-00', '',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').")");
        $ssFields=array("","tasks.taskname","tasklist.title","tasklist.regarding","tasklist.startdate","if(tasklist.duedate='0000-00-00', '',tasklist.duedate)", "tasklist.priority", "if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0', 'Z',if(tasklist.taskstatus='','Y',tasklist.taskstatus)))","created_user.name","tasklist.datecreated","modified_user.name","if(tasklist.mdate='0000-00-00', '',tasklist.mdate)");
				
		$tque="select count(distinct(tasklist.sno)) from tasklist LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type)  LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.cuser='".$username."' and tasklist.status in ('remove')";

		$oque="select tasklist.sno,group_concat(tasks.taskname),tasklist.title,tasklist.regarding,".tzRetQueryStringSelBoxDate('tasklist.startdate','Date','/').",if(tasklist.duedate='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.duedate','Date','/')."),if((tasklist.taskstatus='Completed'),'Completed',if(DATEDIFF(NOW(),tasklist.duedate) >'0','Overdue',tasklist.taskstatus)),tasklist.priority,created_user.name,".tzRetQueryStringSelBoxDate('tasklist.datecreated','Date','/').",modified_user.name,if(tasklist.mdate ='0000-00-00','',".tzRetQueryStringSelBoxDate('tasklist.mdate','Date','/').") from tasklist LEFT JOIN tasks ON FIND_IN_SET(tasks.taskid,tasklist.type) LEFT JOIN users created_user ON (created_user.username = tasklist.cuser) LEFT JOIN users modified_user ON (modified_user.username = tasklist.muser) where tasklist.cuser='".$username."' and tasklist.status in ('remove')";
        
        $grpque="group by tasklist.sno";
		
		$varActType="";
		if($gridSearchFields[6]=="Overdue")
		{
			$varActType="status='Overdue'";
			$gridSearchFields[6]="";
		}
		$varttype="";
        if($gridSearchFields[0] != "")
 		{
 			$varttype .= " AND FIND_IN_SET('".$gridSearchFields[0]."',tasklist.type)";
 			$gridSearchFields[0]="";
 		}
		        
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		if($qstr!="" && $varActType!="")
		{
			$qstr=substr($qstr,0,(strlen($qstr)-1));
			$qstr.=" AND ".$varActType.")";
		}
		else if($qstr=="" && $varActType!="")
		{
			$qstr.=" AND (".$varActType.")";
		}
		$qstr .= $varttype; 
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

        if($gridSortCol==4)
            $ostr = $ostr." ,tasklist.duedate desc,tasklist.sno desc";
        else if($gridSortCol==5)
            $ostr = $ostr." ,tasklist.startdate desc,tasklist.sno desc";
        else
            $ostr = $ostr.",tasklist.startdate desc,tasklist.duedate desc,tasklist.sno desc";
            
		$tque=$gd->buildTQuery($tque,$qstr);
        $oque="$oque $qstr $grpque $ostr $lstr";

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTaskManagerArch($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// COLLABORATION - Task Manager Archive
	function buildTaskManagerArch($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[0]."><span class='checkmark'></span></label>";
			if($row[6]=="Overdue")
			{	
				$grid[$j][1]="<font class=taskcaption>".$this->convertSpecChars($row[1])."</font>";
				$grid[$j][2]="<font class=taskcaption>".$this->convertSpecChars($row[2])."</font>";
				$grid[$j][3]="<font class=taskcaption>".$this->convertSpecChars($row[3])."</font>";
				$grid[$j][4]="<font class=taskcaption>".$this->convertSpecChars($row[4])."</font>";
				$grid[$j][5]="<font class=taskcaption>".$this->convertSpecChars($row[5])."</font>";	
				$grid[$j][6]="<font class=taskcaption>".$this->convertSpecChars($row[7])."</font>";
				$grid[$j][7]="<font class=taskcaption>".$this->convertSpecChars($row[6])."</font>";
				$grid[$j][8]="<font class=taskcaption>".$this->convertSpecChars($row[8])."</font>";
				$grid[$j][9]="<font class=taskcaption>".$this->convertSpecChars($row[9])."</font>";	
				$grid[$j][10]="<font class=taskcaption>".$this->convertSpecChars($row[10])."</font>";
				$grid[$j][11]="<font class=taskcaption>".$this->convertSpecChars($row[11])."</font>";
			}
			else
			{
				$grid[$j][1]=$this->convertSpecChars($row[1]);
				$grid[$j][2]=$this->convertSpecChars($row[2]);
				$grid[$j][3]=$this->convertSpecChars($row[3]);
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);	
				$grid[$j][6]=$this->convertSpecChars($row[7]);
				$grid[$j][7]=$this->convertSpecChars($row[6]);
				$grid[$j][8]=$this->convertSpecChars($row[8]);
				$grid[$j][9]=$this->convertSpecChars($row[9]);	
				$grid[$j][10]=$this->convertSpecChars($row[10]);
				$grid[$j][11]=$this->convertSpecChars($row[11]);
			}
			$grid[$j][12]="";//$this->convertSpecChars($row[0]);
			$grid[$j][13]=$this->convertSpecChars($row[0]);
			
			$j++;
		}
		return $grid;
	}
	
	// CRM JOB ORDERS - JoborderMangSub
	function getJoborderMangSub($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
	    global $maildb,$db,$username,$user_timezone;

		$gd=new gridData();

		if($gridExtraFields['posid'] != "")
			$req_id = $gridExtraFields['posid'];

		$hidemodule = $gridExtraFields['hidemodule'];

		$resume_status_sno_str = "";
		if($gridExtraFields['display_sub_rates'] == "YES")
		{
			$pay_rate_type = $gridExtraFields['pay_rate_type'];
			$pay_rate_txt = $gridExtraFields['pay_rate_txt'];
			if($pay_rate_type!= "" ||  $pay_rate_txt != "")
			{

				$candlist = $gd->getCandlistForSelectedRate($pay_rate_type , $req_id, $pay_rate_txt);

				$resume_status_sno_str = " resume_status.sno IN ($candlist)";
			}
		}
		
		$jotype_qry = "SELECT postype,shift_type from posdesc WHERE posid =".$req_id;
		$jotype_res = mysql_query($jotype_qry,$db);
		$jotype_row =mysql_fetch_row($jotype_res);
		$manage_row = getManage($jotype_row[0]);
		$job_shift_type = $jotype_row[1];

		$asFields=array("",tzRetQueryStringDTime('reqresponse.rdate','DateTime','/'),"REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","candidate_list.hphone",tzRetQueryStringDTime('candidate_list.mtime','Date','/'),"IF(resume_status.pstatus='P','Placed',manage.name)","(SELECT status FROM viInterviews WHERE posid='$req_id' and candid=candidate_list.sno ORDER BY mdate DESC limit 1)","","","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","","","","","","");
		
		$ssFields=array("","","reqresponse.rdate","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","candidate_list.hphone","candidate_list.mtime","IF(resume_status.pstatus='P','Placed',manage.name)","(SELECT status FROM viInterviews WHERE posid='$req_id' and candid=candidate_list.sno ORDER BY mdate DESC limit 1)","","","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","","","","","","");
		


		if($job_shift_type == "perdiem")
		{
 			$tque1 = "select count(1) FROM (SELECT IF(resume_status.pstatus = 'P', 'Placed', IF(manage.name!='',manage.name,'Submitted')),resume_status.pstatus,manage.name FROM posdesc, reqresponse, candidate_list,  resume_status, manage WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid) AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."' AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus' AND manage.name!='Applied'  AND reqresponse.par_id='0' AND candidate_list.status !='backup'";

			$oque1 = "SELECT candidate_list.sno, candidate_list.username, CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname), candidate_list.hphone, IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as CandType, 
			candidate_list.resid, candidate_list.candid , candidate_list.status, IF(candidate_list.accessto = 'ALL', 'Public', IF(FIND_IN_SET('".$username."',candidate_list.accessto)>0 , 'Share','NONE')), ".tzRetQueryStringDTime('candidate_list.mtime','Date','/').", reqresponse.rdate, manage.name, resume_status.status,resume_status.pstatus,candidate_list.supid,reqresponse.seqnumber,reqresponse.sno,reqresponse.resumeid,IF(resume_status.pstatus='P','Placed',IF(manage.name!='',manage.name,'Submitted')), (SELECT status FROM viInterviews WHERE posid='".$req_id."' and candid=candidate_list.sno ORDER BY mdate DESC limit 1) as IntStatus, (SELECT slink FROM viInterviews WHERE posid='".$req_id."' and candid=candidate_list.sno AND slink!='' ORDER BY mdate DESC limit 1) as SLink ,resume_status.shift_id,custom_rh.notes,".tzRetQueryStringDTime("custom_rh.mdate","DateTime","/").",custom_rh.appuser,resume_status.sno FROM posdesc, reqresponse, candidate_list, resume_status left join (SELECT resume_history.req_id,resume_history.res_id,resume_history.shift_id,resume_history.notes,resume_history.appuser,resume_history.mdate,resume_history.seqnumber FROM resume_history WHERE sno IN (SELECT MAX(sno) FROM resume_history GROUP BY resume_history.req_id,resume_history.res_id,resume_history.shift_id,resume_history.seqnumber)) custom_rh on resume_status.req_id = custom_rh.req_id AND resume_status.res_id = custom_rh.res_id AND resume_status.shift_id = custom_rh.shift_id  AND resume_status.seqnumber = custom_rh.seqnumber, manage
			WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid)
			AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."'
			AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus'
			AND candidate_list.status !='backup'
			AND manage.name!='Applied' AND reqresponse.par_id='0'";
			$tque2 = ") temp";


			$grpque = "GROUP BY candidate_list.sno,resume_status.shift_id,resume_status.status,resume_status.seqnumber";				
		}
		else
		{
			$tque1 = "select count(1) FROM (SELECT IF(resume_status.pstatus = 'P', 'Placed', IF(manage.name!='',manage.name,'Submitted')),resume_status.pstatus,manage.name FROM posdesc, reqresponse, candidate_list,  resume_status, manage WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid) AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."' AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus' AND manage.name!='Applied'  AND reqresponse.par_id='0' AND candidate_list.status !='backup'";

			$oque1 = "SELECT candidate_list.sno, candidate_list.username, CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname), candidate_list.hphone, IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as CandType, 
			candidate_list.resid, candidate_list.candid , candidate_list.status, IF(candidate_list.accessto = 'ALL', 'Public', IF(FIND_IN_SET('".$username."',candidate_list.accessto)>0 , 'Share','NONE')), ".tzRetQueryStringDTime('candidate_list.mtime','Date','/').", reqresponse.rdate, manage.name, resume_status.status,resume_status.pstatus,candidate_list.supid,reqresponse.seqnumber,reqresponse.sno,reqresponse.resumeid,IF(resume_status.pstatus='P','Placed',IF(manage.name!='',manage.name,'Submitted')), (SELECT status FROM viInterviews WHERE posid='".$req_id."' and candid=candidate_list.sno ORDER BY mdate DESC limit 1) as IntStatus, (SELECT slink FROM viInterviews WHERE posid='".$req_id."' and candid=candidate_list.sno AND slink!='' ORDER BY mdate DESC limit 1) as SLink ,resume_status.shift_id,custom_rh.notes,".tzRetQueryStringDTime("custom_rh.mdate","DateTime","/").",custom_rh.appuser,resume_status.sno FROM posdesc, reqresponse, candidate_list, resume_status left join (SELECT resume_history.req_id,resume_history.res_id,resume_history.shift_id,resume_history.notes,resume_history.appuser,resume_history.mdate FROM resume_history WHERE sno IN (SELECT MAX(sno) FROM resume_history GROUP BY resume_history.req_id,resume_history.res_id,resume_history.shift_id)) custom_rh on resume_status.req_id = custom_rh.req_id AND resume_status.res_id = custom_rh.res_id AND resume_status.shift_id = custom_rh.shift_id, manage
			WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid)
			AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."'
			AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus'
			AND candidate_list.status !='backup'
			AND manage.name!='Applied' AND reqresponse.par_id='0'";
			$tque2 = ") temp";


			$grpque = "GROUP BY candidate_list.sno,resume_status.shift_id,resume_status.status"; 
		}
		

		$oque2 = "ORDER BY reqresponse.rdate DESC";

		$varCandType="";
		$hvstr="";

		if($gridSearchFields[4] != "")
		{
			$gridSearchFields[4] = getManage($gridSearchFields[4]);
			$hvstr="having (IF(resume_status.pstatus='P','Placed', IF(manage.name!='',manage.name,'Submitted'))) LIKE '".$gridSearchFields[4]."%' ";
			$gridSearchFields[4]= "";
			$candstatus = "resume_status.status!=''";
		}

		if($gridSearchFields[5]=="Candidate")
		{
			$varCandType="candidate_list.owner!='$username' and candidate_list.ctype!='Employee'";
			$gridSearchFields[5]="";
		}
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="" && $varCandType!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$varCandType.")";
        }
        else if($qstr=="" && $varCandType!="")
        {
			$qstr.=" AND (".$varCandType.")";
        }

		if($qstr!="" && $candstatus!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$candstatus.")";
        }
        else if($qstr=="" && $candstatus!="")
        {
			$qstr.=" AND (".$candstatus.")";
        }

		if($qstr!="" && $resume_status_sno_str != "")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$resume_status_sno_str.")";
        }
        else if($qstr=="" && $resume_status_sno_str != "")
        {
			$qstr.=" AND (".$resume_status_sno_str.")";
        }        

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields) ; // Order by fields, append the where clause accordingly
		$ostr = ($ostr == '')? $oque2 : $ostr;
		$totstr = "$grpque $hvstr $tque2";
		$tque=$gd->buildTQuery($tque1,$qstr,$totstr);
    	$oque="$oque1 $qstr $grpque $hvstr $ostr $lstr";
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildJoborderMangSub($oque,$manage_row,$req_id,$hidemodule);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total, $tque, $oque);

		return $objResponse;
	}
	
	// CRM JOB ORDERS - JoborderMangSub
	function buildJoborderMangSub($que,$manage_row,$req_id,$hidemodule)
	{
		global $maildb,$db;

		$j=0;
		$k=0;
		$grid=array();

		require("OutLookEnbLinks.php");
		$OutLookObj=new EnbOutLookPluginLinks(OUTLOOK_PLUG_IN,"CRMCAND");

		$res=mysql_query($que,$db);
		while($drow=mysql_fetch_array($res))
		{
			$newSubmissionStatus = array();
			$newSubmissionNotes = array();
			$newSubmissionIcons = array();
			$seqnumber = $drow[15];	
			$res_status=$drow[18];	

			
			$grid[$j][0]="<a href=".'"'."javascript:submission_notes_toggle('sub_notes','DisplayBlock','DisplayNone',".$k.");".'"'."style='text-decoration:none;'><span id='toggle_btn_".$k."' name=toggle_btns[]><i class='fa fa-plus-square fa-lg'></i></span></a>";
			
			$grid[$j][1]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids_".$j."' OnClick=chk_clearTop() value='".$drow[0]."'><span class='checkmark'></span><input type=hidden name='shiftids[]' id='shift_".$j."' value='".$drow[21]."'><input type=hidden name='candids[]' id='candids_".$j."' value='".$drow[0]."'><input type=hidden name='resumesno[]' id='resumesno_".$j."' value='".$drow[25]."'></label><input type=hidden name=seqstatus[] value='".$seqnumber."|".$res_status."'><input type=hidden name='placedstat[]' id='placedstat_".$j."' value='".$drow[13]."'>";
			
			$cand_access=$drow[8];
			if($drow[7]=="ACTIVE")
			{
				if($cand_access=='NONE')
					$accessvalue="NO";
				else
					$accessvalue="YES";
			}
			else
			{
				$accessvalue="NO";
			}

			$subno=$drow[16];			
			$sid="'".str_replace(",","','",$drow[17])."'";
			$type = $drow[4];

			$hiddval = $drow[0]."|".$drow[11];
			$hiddcanval = $drow[0]."|".$drow[11]."|".$drow[21];

			if($drow[11] == 'submitted')
			{
				$grid[$j][2]="<a href=javascript:subdetails($subno)><font class=linkrow>$drow[10]</font></a>";
			}
			else
			{
 				$hiddval 	= $drow[0]."|".urlencode($drow[11])."|".$seqnumber."|".urlencode($res_status)."|".$drow[21]."|".$drow[25];
				$hiddcanval = $drow[0]."|".$seqnumber."|".urlencode($res_status)."|".$subno."|".$j."|".$drow[6]."|".$drow[21];
				$grid[$j][2]="<a href=javascript:openNewWindow('$hiddval')><font class=linkrow>$drow[10]</font></a>";
				$grid[$j][2].="<input type='hidden' name='candDetails".$j."' id='candDetails".$j."' value='$hiddcanval'>";
			}	

			$grid[$j][3]="<a href=javascript:winopennew('review.php?type=cand&posid=$req_id&candstat=$drow[7]&cno=$drow[0]&candaccess=$accessvalue&module=$hidemodule','5')><font class=linkrow>".$this->convertSpecChars($drow[2])."</font></a>";
			$drow[3]=str_replace("--","",str_replace("---","",$drow[3]));
			$grid[$j][4]=$this->convertSpecChars($drow[3]);
			$grid[$j][5]=$this->convertSpecChars($drow[9]);
			$grid[$j][6]=$this->convertSpecChars($res_status);

			if(strtolower($drow[19])=="completed" && $drow[20]!="")
				$grid[$j][7]="<a href='".stripslashes($drow[20])."' target=_blank><font class=linkrow>".ucfirst($this->convertSpecChars($drow[19]))."</font></a>";
			else
				$grid[$j][7]=ucfirst($this->convertSpecChars($drow[19]));

			if($res_status=="Placed")
			{

				$hque="SELECT COUNT(1) FROM hrcon_jobs WHERE ustatus!='backup' AND candidate=".$drow[0]." AND posid=$req_id";
				$hres=mysql_query($hque,$db);
				$hrow=mysql_fetch_row($hres);

				if($hrow[0]>0)
					$grid[$j][8]="Assignment - ".$drow[11];
				else
					$grid[$j][8]="Hiring Mngmt - ".$drow[11];
			}
			else
			{
				$grid[$j][8]="";
			}

			$shift_details = "";
			//if(SHIFT_SCHEDULING_ENABLED == 'Y'){			
				// Gets and displays the Shift Names on which the candidate is submitted/shortlisted/placed				
				$shift_details_arr = array();
								
				 $shift_name_que = "SELECT GROUP_CONCAT(CONCAT(shiftname,'--',shiftcolor)) FROM shift_setup WHERE sno IN (SELECT rs.shift_id FROM resume_status rs WHERE rs.req_id=".$req_id." AND rs.res_id='".$drow[0]."' and rs.shift_id = '".$drow[21]."' )";
				$shift_name_res	= mysql_query($shift_name_que,$db);
				$shift_name_row = mysql_fetch_row($shift_name_res);
				$shift_details_arr = explode(",",$shift_name_row[0]);
				foreach($shift_details_arr as $shift_details_val){
					list($shift_setup_sname,$shift_setup_scolor) = explode("--",$shift_details_val);
					$css_colorcode = str_replace("#","",$shift_setup_scolor);
					$shift_details .= "<span title='".$shift_setup_sname."' class='shiftcss_".$css_colorcode."'></span><span style='margin-left: 5px; display: inline-block;'>".$shift_setup_sname."</span>";
				}
			//}
			
			if(!empty($shift_details))
				$grid[$j][9] = $shift_details;
			else
				$grid[$j][9]="";
				
			$grid[$j][10]=$this->convertSpecChars($drow[4]);	
				
			$status = $drow[12];
			$con_id = $drow[1];
			
			$cand_schque	= "SELECT COUNT(1) FROM candidate_sm_timeslots WHERE username = '".$drow[1]."'";
			$cand_schres	= mysql_query($cand_schque,$db);
			$cand_schrow	= mysql_fetch_row($cand_schres);
			
			if($res_status == "Placed" || $drow[7] == "INACTIVE" || $drow[7] == "backup" || $drow[7] == "HIDE")
			{
				if($res_status == "Placed")
				{
					$NewUIplaced='';
					//$grid[$j][11]="<a href=javascript:winopennew('notespopup.php?addr={$drow[0]}&posid={$req_id}','6')><i alt='Notes' title='Notes' class='fa fa-file-text'></i></a>";
					$NewUIplaced = "<div><a href=javascript:winopennew('notespopup.php?addr={$drow[0]}&posid={$req_id}','6')><i alt='Notes' title='Notes' class='fa fa-file-text fa-lg'></i></a></div>";
				}
				else
				{
					$grid[$j][11]="";
				}	

				$grid[$j][12]="";
				$grid[$j][13]="";	
				$grid[$j][14]="";
				$grid[$j][15]="";
				$grid[$j][16]="";

				if($res_status == "Placed")
				{
					
					$grid[$j][17]="<a href=javascript:winopennew('viewjobs.php?candidateVal=".$drow[1]."&req_id=".$req_id."&cand_sno=".$drow[0]."&candid=".$drow[6]."&tol=".$contact_mail."&FromSubmit=yes&seqnumber=".$seqnumber."&shiftid=".$drow[21]."&res_sno=".$drow[25]."','5')><i alt='Placement Details' title='Placement Details' class='fa fa-tasks fa-lg'></i></a>";

				}
				else
				{
					$grid[$j][17]="";
				}

				if($cand_schrow[0] > 0  && SHIFT_SCHEDULING_ENABLED=='Y')
				{
					$NewUIAvli ='';
					$grid[$j][18]="<a href=javascript:winopennew('/include/shift_schedule/viewalltimeframes.php?refid=".$drow[1]."&status=viewall&module=candidates','4')><i alt='Availability Details' title='Availability Details' class='fa fa-calendar-check-o  fa-lg'></i></a>";

					$NewUIAvli = "<div><a href=javascript:winopennew('/include/shift_schedule/viewalltimeframes.php?refid=".$drow[1]."&status=viewall&module=candidates','4')><i alt='Availability Details' title='Availability Details' class='fa fa-calendar-check-o  fa-lg'></i></a></div>";
				}
				else
				{
					$grid[$j][18]="";
				}

			}
			else
			{
				/*Out look plugin */
				$EmailLink="javascript:winopennew('../../Activities/email/Compose.php?candid=".$drow[1]."&req_id=".$req_id."&Came_From=Request','4')";
				$subject="^Request^".$drow[1]."^".$req_id;
				$LinkEmailCont=$OutLookObj->CheckOutlookStatuseEMail(array('AkkenId'=>$drow[1],''),$EmailLink,'','','',$subject);

				$grid[$j][11]="<a href=javascript:winopennew('notespopup.php?addr={$drow[0]}&posid={$req_id}','6')><i alt='Notes' title='Notes' class='fa fa-file-text fa-lg'></i></a>";	
				
				$grid[$j][12]="<a href=".$LinkEmailCont."><i alt='Request Interview' title='Request Interview' class='fa fa-book fa-lg'></i></a>";
				
				$grid[$j][13]="<a href=javascript:confpopup('".$drow[1]."');><i alt='Setup Interview' title='Setup Interview' class='fa fa-user-plus fa-lg'></i></a>";

				$grid[$j][14]="<a href=javascript:winopennew_Interview('resumereviewf.php?addr=".$req_id."|".$drow[0]."|".rawurlencode($drow[12])."|".$drow[21]."&subno=$subno&candidate_id=$con_id&seqnumber=$drow[15]&res_sno=$drow[25]','3',$j)><i alt='Update Status' title='Update Status' class='fa fa-ticket fa-lg'></i></a>";

				if( $status != "Reject" )
				{
					if( $type != "Employee" )
					{
						if(strtolower($manage_row)==strtolower("Direct"))
						{
							$grid[$j][15]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."&res_sno=".$drow[25]."','4',$j)><i alt='Forward to Accounting' title='Forward to Accounting' class='fa fa-industry fa-lg'></i></a>";
						}
						else
						{
							$grid[$j][15]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."&shiftid=".$drow[21]."&res_sno=".$drow[25]."','4',$j)><i alt='Forward to Hiring' title='Forward to Hiring' class='fa fa-industry fa-lg'></i></a>";	
						}
					}
					else
					{
						$grid[$j][15]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."&shiftid=".$drow[21]."&res_sno=".$drow[25]."','4',$j)><i alt='Forward to Accounting' title='Forward to Accounting' class='fa fa-industry fa-lg'></i></a>";	
					}
				}
				else
				{
					$grid[$j][15]="";
				}

				$grid[$j][16]="<a href=javascript:winopennew('Compose.php?msgunumber=".$seqnumber."&candidateVal=".$drow[0]."&req_stat=details&FromSubmit=yes&chk_count=1&re_submit=YES&bulk_resubmit=NO&res_sno=".$drow[25]."&shift_id=".$drow[21]."','5')><i alt='Re-Submit' title='Re-Submit' class='fa fa-list-alt fa-lg'></i></a>";
				
				$grid[$j][17]="";

				if($cand_schrow[0] > 0)
				{
					$grid[$j][18]="<a href=javascript:winopennew('/include/shift_schedule/viewalltimeframes.php?refid=".$drow[1]."&status=viewall&module=candidates','4')><i alt='Availability Details' title='Availability Details' class='fa fa-calendar-check-o fa-lg'></i></a>";
				}
				else
				{
					$grid[$j][18]="";
				}
												
			}
			
			$column11="<div class='assignmentblkNew'>".(($grid[$j][8]!="") ? '<div class="sub_status"><i class="fa fa-suitcase fa-lg"></i>'.$grid[$j][8].'</div>' : '' )."&nbsp;".(($grid[$j][9]!="") ? '<div style="display: inline-block;">'.$grid[$j][9].'</div>' : '' )."</div><div class='submissionblkNew'>".implode(" ", $newSubmissionIcons)."</div>";
				
			$username = getOwnerName($drow[24]);
			if($drow[22]!="")
			{
				$viewhistory = "<a href=javascript:viewhistorypopup('".$req_id."','".$drow[0]."','".$drow[21]."','".$seqnumber."') style='margin-left:35px;'><font style='font-size:12px;' class='lbl_viewhistory'>View Submission Notes History</font></a>";
				//$date_string = "<i>".$username." at ".date("jS F, Y h:i A", strtotime($drow[23]))."</i>: "; 
				$date_string = "<font class='submision_time'>".date("Y-m-d G:i:s", strtotime($drow[23]))." | ".$username."</font>: "; 
				
				$grid[$j][19]= "<span class='DisplayNone' id='sub_notes_".$k."' name='sub_notes[]'><div class='submission_notes'>".$date_string.urldecode($drow[22]).$viewhistory."</div></span>";
				$k++;
			}
			else
			{
				$viewhistory="";
				$date_string="";
				$grid[$j][0]="";
				$grid[$j][19]="<span></span>";
			}
			
			$grid[$j][20]= "<input type=hidden name='subinf$j' value='$hiddval'><input type=hidden name='toggle_count[]' value='".$k."'>";
			$grid[$j][21]="";
			//Dont remove the below line .The line was impacted in PSOS/scripts/crmNextPrev.js in function nextGridRec()
			$grid[$j][22]="review.php?cno=".$drow[0]."&posid=$posid&dest=0";
			$oldJ1 = "";
			if (BULK_PLACE_ACCESS == "Y" && $res_status != "Placed") {
				
				$selectBulkPlace = "SELECT sno FROM bulk_placement_queue WHERE cand_id='".$drow[0]."' AND posid = '".$req_id."' AND shift_id='".$drow[21]."' AND seqnumber='".$drow[15]."' AND status !='PlacementCompleted' ";
				$resultBulkPlace = mysql_query($selectBulkPlace,$db);
				if (mysql_num_rows($resultBulkPlace)>0) {
					$grid[$j][12]=""; // Request Interview
					$grid[$j][13]=""; // setup Interview
					$grid[$j][14]=""; // Update Status
					$grid[$j][15]=""; // Forward to Hiring making Empty
					$grid[$j][16]=""; // Re-Submit making Empty
					$oldJ1 = $grid[$j][1];
					$grid[$j][1] = $oldJ1."<input type='hidden' name='bulkQueue[]' id='bulkQueue_".$j."' value='".$drow[0]."' > ";
				}
			}
			$j++;
			$newSubmissionIcons = array();
		}
		return $grid;
	}

	//added by prasad to Accounting--Expenses grid optimization...
	function getExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		$decimalPref=getDecimalPreference();
        $asFields=array("","".getEntityDispName("emp_list.sno","LOWER(emp_list.name)")."",tzRetQueryStringDate('par_expense.sdate','Date','/'),tzRetQueryStringDate('par_expense.edate','Date','/'),"round(sum(expense.quantity * expense.unitcost),".$decimalPref.")","round(sum(expense.advance),".$decimalPref.")","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.")");
        //ordering array
	    $ssFields = array("","employeeName","MIN(par_expense.sdate)","MAX(par_expense.edate)","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")","round(sum(expense.advance),".$decimalPref.")","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.")");

		$tque = "select count(a.sno) from(select emp_list.name,".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').",round(sum(expense.quantity * expense.unitcost),".$decimalPref."), round(sum(expense.advance),".$decimalPref."),round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref."),par_expense.username,par_expense.sdate, par_expense.edate,par_expense.sno sno
from   par_expense FORCE INDEX(username),expense,emp_list
WHERE  par_expense.sno=expense.parid
AND    par_expense.username=emp_list.username
AND    par_expense.astatus = 'ER'
AND    expense.status = 'ER'
 ";

        $oque = "select emp_list.name,".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').",round(sum(expense.quantity * expense.unitcost),".$decimalPref."), round(sum(expense.advance),".$decimalPref."),round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref."),par_expense.username, par_expense.sdate, par_expense.edate,par_expense.sno, ".getEntityDispName("emp_list.sno","emp_list.name")." AS employeeName
from   par_expense FORCE INDEX(username),expense,emp_list
WHERE  par_expense.sno=expense.parid
AND    par_expense.username=emp_list.username
AND    par_expense.astatus = 'ER'
AND    expense.status = 'ER'
 ";

        $dateString = "";
        if($gridExtraFields['servicedate']!="")
        {
            $fromArr=explode("/",$gridExtraFields['servicedate']);
            $fromDate= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
            $sDate=date("Y-m-d",$fromDate);
            $dateString .= " AND par_expense.sdate >='".$sDate."'";
        }
        if($gridExtraFields['servicedateto']!="")
        {
            $toArr=explode("/",$gridExtraFields['servicedateto']);
            $toDate= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
            $todaf=date("Y-m-d",$toDate);
            $dateString .= " AND par_expense.edate <='".$todaf."'";
        }

        $gstr = $dateString." group by par_expense.username ";
        $hvngstr = "";

        if($gridSearchFields[0]!="")
        {
			$gridSearchFields[0]= strtolower($gridSearchFields[0]);	//employee name
        }
		if($gridSearchFields[3]!="")
        {
          $hvngstr = " having round(sum(expense.quantity * expense.unitcost),".$decimalPref.") LIKE '%$gridSearchFields[3]%'";
          $gridSearchFields[3]="";
        }
        if($gridSearchFields[4]!="")
        {
          if($hvngstr!="")
          {
            $hvngstr .= " and round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[4]%'";
          }
          else
          {
            $hvngstr = " having round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[4]%'";
          }
          $gridSearchFields[4]="";
        }
        if($gridSearchFields[5]!="")
        {
          if($hvngstr!="")
          {
            $hvngstr .= " and round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[5]%'";
          }
          else
          {
            $hvngstr = " having round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[5]%'";
          }
          $gridSearchFields[5]="";
        }
        $gstr .= " ".$hvngstr;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);

        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr.") a");
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildExpenses($oque);
        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	//this  fun for assigning fetched data to grid...
	function buildExpenses($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='mainchk_clearTop();' value='".$row[6]."'"."><span class='checkmark'></span></label>";
			$row[1] = ($row[2]=="00/00/0000")? "" : $row[1];
			$row[2] = ($row[2]=="00/00/0000")? "" : $row[2];
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[10]));
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars($row[2]);
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$row[5];
			$grid[$j][7]="";
			$grid[$j][8]="empexpenses.php?addr=".$row[6];
            $j++;
		}
        return $grid;
	}
		// CRM eCampaigns - Main Grid --- Sivaprasanth

	function getCampaigns($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{

		global $maildb,$db,$username,$user_timezone;

		$gd=new gridData();

  		$asFields=array("","substring_index(subject,'(eCampaign@',1)","inq_count","resp_count","camp_date","IF (accessto = 'ALL', 'Public',IF (accessto = '".$username."', 'Private', 'Share'))","owner","id","par_id","accessto","user","subject");

	    $ssFields=array("","substring_index(subject,'(eCampaign@',1)","inq_count","resp_count",tzRetQueryStringDTime('camp_date','DateTime','/'),"IF (accessto = 'ALL', 'Public',IF (accessto = '".$username."', 'Private', 'Share'))","users.name","id","par_id","accessto","subject");
		$tque="select count(cnt.sno) from (SELECT sno, (SELECT count(*)  FROM process_mail_headers WHERE ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', a.accessto ) >0 OR a.accessto = 'all' ) AND folder = 'CampaignResponses' and replace(SUBSTRING_INDEX(subject,'@',-1),')','')=a.id) inq_count, subject, (SELECT count(*) FROM campaign_res WHERE campaignsno = a.sno) resp_count,".tzRetQueryStringDTime('camp_date','DateTime','/').", IF ( accessto = 'all', 'Public', IF ( accessto = '".$username."' OR accessto = '', 'Private', 'Share' ) ), b.name 'owner',id, par_id ,accessto FROM campaign_list a left join users b on a.username=b.username WHERE par_id = '0' AND ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', accessto ) >0 OR accessto = 'all' ) AND a.status = 'OPEN' ";		

         $oque="SELECT sno, substring_index(subject,'(eCampaign@',1), 
(SELECT count(*)  FROM process_mail_headers 
WHERE ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', a.accessto ) >0 OR a.accessto = 'all' )
AND folder = 'CampaignResponses' and replace(SUBSTRING_INDEX(subject,'@',-1),')','')=a.id) inq_count, subject, 
(SELECT count(*) FROM campaign_res WHERE campaignsno = a.sno) resp_count,".tzRetQueryStringDTime('camp_date','DateTime','/').",
IF ( accessto = 'all', 'Public', IF ( accessto = '".$username."' OR accessto = '', 'Private', 'Share' ) ), b.name 'owner',id,
par_id ,accessto,a.username 'user'
FROM campaign_list a left join users b on a.username=b.username
WHERE par_id = '0' AND ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', accessto ) >0
OR accessto = 'all' )
AND a.status = 'OPEN' ";
        $grpque=" group by a.sno ";

        $hvngstr = "";

		if($gridSearchFields[1]!="")
		{
			$hvngstr = " having inq_count LIKE '%$gridSearchFields[1]%'";
			$gridSearchFields[1]="";
		}

		if($gridSearchFields[5]!="")
		{
			if($hvngstr!="")
				$hvngstr .= " and b.name LIKE '%$gridSearchFields[5]%'";
			else
				$hvngstr = " having b.name LIKE '%$gridSearchFields[5]%'";
			$gridSearchFields[5]="";
		}

        $grpque .= " ".$hvngstr;

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$grpque.' ) cnt');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$grpque);

    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCampaigns($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	//CRM build ecampaigns
	function buildCampaigns($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' OnClick=chk_clearTop() value='".$row[0]."|".$row[6]."|".$row[11]."|".html_tls_specialchars($row[1],ENT_QUOTES)."|".$j."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);

			if(($row[2]!="")&&($row[2]!=0))
				$grid[$j][2]="<a href=javascript:newEnq('SCl_Email.php?folder=CampaignResponses&Subject=".$row[8]."') title='New Inquiries'><span  class=\"grid_new_res\"></span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".$row[2];
			else
				$grid[$j][2]="";

			if(($row[4]!="")&&($row[4]!=0))
				$grid[$j][3]="<a href=javascript:resEnq('viewcampaign.php?sno=".$row[0]."&frm=act') title='Show All Inquiries'><span  class=\"grid_res_enq\"></span></a>";
			else
				$grid[$j][3]="";

			$grid[$j][4]=$this->convertSpecChars($row[5]);
			$grid[$j][5]=$this->convertSpecChars($row[6]);
			$grid[$j][6]=$this->convertSpecChars($row[7]);
   			$grid[$j][7]='';
			$grid[$j][8]="showcampaigndet.php?frm=act&val=".$row[0];
			$j++;
		}
		return $grid;
	}

    // CRM eCampaigns Archive grid
	function getCampaignHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd=new gridData();

  		$asFields=array("","inq_count","substring_index(subject,'(eCampaign@',1)","resp_count","camp_date","IF (accessto = 'ALL', 'Public',IF (accessto = '".$username."', 'Private', 'Share'))","owner","id","par_id","accessto","user","subject");

	    $ssFields=array("","inq_count","substring_index(subject,'(eCampaign@',1)","resp_count",tzRetQueryStringDTime('camp_date','DateTime','/'),"IF (accessto = 'ALL', 'Public',IF (accessto = '".$username."', 'Private', 'Share'))","users.name","id","par_id","accessto","subject");
		$tque="select count(cnt.sno) from (SELECT sno, (SELECT count(*)  FROM process_mail_headers WHERE ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', a.accessto ) >0 OR a.accessto = 'all' ) AND folder = 'CampaignResponses' and replace(SUBSTRING_INDEX(subject,'@',-1),')','')=a.id) inq_count, subject, (SELECT count(*) FROM campaign_res WHERE campaignsno = a.sno) resp_count,".tzRetQueryStringDTime('camp_date','DateTime','/').", IF ( accessto = 'all', 'Public', IF ( accessto = '".$username."' OR accessto = '', 'Private', 'Share' ) ), b.name 'owner',id, par_id ,accessto FROM campaign_list a left join users b on a.username=b.username WHERE par_id = '0' AND ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', accessto ) >0 OR accessto = 'all' ) AND a.status = 'CLOSE' ";

         $oque="SELECT sno, (SELECT count(*)  FROM process_mail_headers
WHERE ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', a.accessto ) >0 OR a.accessto = 'all' )
AND folder = 'CampaignResponses' and replace(SUBSTRING_INDEX(subject,'@',-1),')','')=a.id) inq_count,
substring_index(subject,'(eCampaign@',1) ,subject,
(SELECT count(*) FROM campaign_res WHERE campaignsno = a.sno) resp_count,".tzRetQueryStringDTime('camp_date','DateTime','/').",
IF ( accessto = 'all', 'Public', IF ( accessto = '".$username."' OR accessto = '', 'Private', 'Share' ) ), b.name 'owner',id,
par_id ,accessto,a.username 'user'
FROM campaign_list a left join users b on a.username=b.username
WHERE par_id = '0' AND ( a.username = '".$username."' OR FIND_IN_SET( '".$username."', accessto ) >0
OR accessto = 'all' )
AND a.status = 'CLOSE' ";
        $grpque=" group by a.sno ";
		//$grpque="";
        $hvngstr = "";

        if($gridSearchFields[0]!="")
        {
          $hvngstr = " having inq_count LIKE '%$gridSearchFields[0]%'";
          $gridSearchFields[0]="";
        }
        if($gridSearchFields[4]!="")
        {
          if($hvngstr!="")
          {
            $hvngstr .= " and b.name LIKE '%$gridSearchFields[4]%'";
          }
          else
          {
            $hvngstr = " having b.name LIKE '%$gridSearchFields[4]%'";
          }
          $gridSearchFields[4]="";
        }
        $grpque .= " ".$hvngstr;
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$grpque.' ) cnt');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$grpque);
        //$oque="$oque $qstr $grpque $ostr $lstr";
 

    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCampaignHis($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCampaignHis($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{


			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value='".$row[0]."|".$row[6]."|".$row[11]."|".html_tls_specialchars($row[2],ENT_QUOTES)."|".$j."'><span class='checkmark'></span></label>";

			// New Inquiries
			if(($row[1]!="")&&($row[1]!=0))
			      $grid[$j][1]="<a href=javascript:newEnq('SCl_Email.php?folder=CampaignResponses&Subject=".$row[8]."') title='New Inquiries'><span  class=".grid_new_res."></span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".$row[1];

			 else
                 $grid[$j][1]="";
			// Campaign Name
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			// Responded Inquiries
			if(($row[4]!="")&&($row[4]!=0))
			 $grid[$j][3]="<a href=javascript:resEnq('viewcampaign.php?sno=".$row[0]."&frm=act') title='Show All Inquiries'><span  class=".grid_res_enq." ></span></a>";			else
                 $grid[$j][3]="";
			// Date
			$grid[$j][4]=$this->convertSpecChars($row[5]);
			// Owner
			$grid[$j][5]=$this->convertSpecChars($row[7]);
   			$grid[$j][6]='';
			$grid[$j][7]="showcampaigndet.php?frm=act&val=".$row[0];

			$j++;
		}
		return $grid;
	}
		//------xajax grid for active clients--siva prasanth

		function getActiveClients($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{

		global $maildb,$db,$username;

		$gd=new gridData();

  		$asFields=array("","staffacc_cinfo.cname","staffacc_cinfo.city","staffacc_cinfo.state","staffacc_ctype.company_type","IF (staffacc_list.status='INACTIVE','Passive','Active')","users.name","staffacc_list.stime","staffacc_list.type","staffacc_cinfo.curl","staffacc_list.username");

	    $ssFields=array("","staffacc_cinfo.cname","staffacc_cinfo.city","staffacc_cinfo.state","staffacc_ctype.company_type","IF (staffacc_list.status='INACTIVE','Passive','Active')","users.name","staffacc_list.stime","staffacc_list.type","staffacc_cinfo.curl","staffacc_list.username");

		$tque="SELECT count( DISTINCT( staffacc_list.sno)) FROM hrcon_jobs, staffacc_cinfo LEFT JOIN staffacc_list ON staffacc_cinfo.username = staffacc_list.username LEFT JOIN staffacc_ctype ON staffacc_ctype.company_id = staffacc_cinfo.ctype where ( hrcon_jobs.client = staffacc_cinfo.sno  OR hrcon_jobs.endclient = staffacc_cinfo.sno OR hrcon_jobs.bill_address = staffacc_cinfo.sno ) and hrcon_jobs.ustatus ='active' and staffacc_list.status IN ( 'ACTIVE', 'INACTIVE' )";



         $oque="SELECT DISTINCT staffacc_list.sno, staffacc_cinfo.cname, staffacc_cinfo.city,staffacc_cinfo.state, staffacc_ctype.company_type,IF (staffacc_list.status='INACTIVE','Passive','Active'),  staffacc_list.stime,  staffacc_list.type,staffacc_cinfo.curl, staffacc_list.username FROM hrcon_jobs, staffacc_cinfo LEFT JOIN staffacc_list ON staffacc_cinfo.username = staffacc_list.username LEFT JOIN staffacc_ctype ON staffacc_ctype.company_id = staffacc_cinfo.ctype where ( hrcon_jobs.client = staffacc_cinfo.sno  OR hrcon_jobs.endclient = staffacc_cinfo.sno OR hrcon_jobs.bill_address = staffacc_cinfo.sno ) and hrcon_jobs.ustatus ='active' and staffacc_list.status IN ( 'ACTIVE', 'INACTIVE' )";
       // $grpque=" GROUP BY username  ";
		$grpque="";



		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$grpque);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$grpque);
        //$oque="$oque $qstr $grpque $ostr $lstr";

       //echo $oque;
    	$total=$gd->getTotalRows($tque);
     //echo $tque;
		$gridData=$gd->buildActiveClients($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildActiveClients($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{

			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value='".$row[0]."'><span class='checkmark'></span></label>";

			// company name
			$grid[$j][1]=$row[1];
			//city
			$grid[$j][2]=$row[2];
			//state
			$grid[$j][3]=$row[3];
			//company type
			$grid[$j][4]=$row[4];
			//status
			$grid[$j][5]=$row[5];
   			$grid[$j][6]='';
			$grid[$j][7]="reviewmanage.php?addr=".$row[10];

			$j++;
		}
		return $grid;
	}
	//------xajax grid for My FAQ in collabaration  clients--siva prasanth

		function getMyPending($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{

		global $maildb,$db,$username;

		$gd=new gridData();

  		$asFields=array("","title","category","type","status");

	    $ssFields=array("","title","category","IF(type='CON','Suggestion',IF(type='FAQ','Question',IF(status='ANS','Answered Question','')))","status");

		$tque="SELECT count( * ) FROM resource_manage WHERE resource_manage.status NOT IN ('backup', 'VIEW')AND resource_manage.username = '".$username."' ";


         $oque="SELECT serial_no,title,category, IF(type='CON','Suggestion',IF(type='FAQ','Question',IF(status='ANS','Answered Question',''))),status
  FROM resource_manage
 WHERE resource_manage.status NOT IN ('backup', 'VIEW') AND resource_manage.username = '".$username."'";
       // $grpque=" GROUP BY username  ";
		$grpque="";



		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$grpque);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$grpque);
        //$oque="$oque $qstr $grpque $ostr $lstr";

       //echo $oque;
    	$total=$gd->getTotalRows($tque);
     //echo $tque;
		$gridData=$gd->buildMyPending($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
		function buildMyPending($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
            
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value='".$row[0]."'><span class='checkmark'></span></label>";

            //title
			$grid[$j][1]=stripslashes($row[1]); 
			//category
			$grid[$j][2]=stripslashes($row[2]);
			// type
			$grid[$j][3]=stripslashes($row[3]);
			$grid[$j][4]='';
			//status
			if($row[3]=='Suggestion')
              {
                $link="suggest.php?stat=edit&addr=".$row[0];
              }
              if($row[3]=='Question')
              {
                $link="ask.php?stat=edit&addr=".$row[0];
              }

              if($row[4]=='ANS')
              {
                $link="suggest.php?stat=edit&addr=".$row[0];
              }

              //echo $link;

			  $grid[$j][5]=$link;
         	$j++;
		}
		return $grid;
	}
 //----xajax grid for admin usermanagement siva prasanth
	// Modified By Vijaya to add created by created user, modified date to consultants and selfservice accoutns and user on 12-09-2008
	function getAdminUserManagementData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone,$acctype;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		if($acctype=="SSU")
		{
			$asFields=array("","CONCAT(emp_list.sno,' - ',emp_list.name)","users.userid","users.usertype","department.deptname",tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/"),tzRetQueryStringDTime("max(userlog_acc.last_access)","DateTime","/"),tzRetQueryStringDTime("users.cdate","DateTime","/"),"create_user.name",tzRetQueryStringDTime("users.um_mdate","DateTime","/"),"modified_user.name");
			$ssFields=array("","TRIM(users.name)","users.userid","users.usertype","department.deptname","max(userlog_acc.last_login)","max(userlog_acc.last_access)","users.cdate","create_user.name","users.um_mdate","modified_user.name","","","","","","","");

			$tque="SELECT count(1) CNT FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype=''";
			$oque="SELECT emp_list.sno SNO,emp_list.username,CONCAT(emp_list.sno,' - ',emp_list.name),department.deptname,users.type,users.userid,sysuser.collaboration,users.last_login,".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",".tzRetQueryStringDTime('users.cdate','DateTime','/').",create_user.name,".tzRetQueryStringDTime('users.um_mdate','DateTime','/').",modified_user.name, users.usertype FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype=''";
		}
        else if($acctype=="CSS")
        {
			$asFields=array("","CONCAT_WS(' - ',staffacc_cinfo.sno,staffacc_cinfo.cname)","users.userid","users.usertype","CONCAT_WS(' - ',staffacc_contact.sno,TRIM(concat_ws(' ',staffacc_contact.fname,staffacc_contact.lname)))",tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/"),tzRetQueryStringDTime("max(userlog_acc.last_access)","DateTime","/"),tzRetQueryStringDTime("users.cdate","DateTime","/"),"cuser.name",tzRetQueryStringDTime("users.um_mdate","DateTime","/"),"muser.name");
            $ssFields=array("","TRIM(staffacc_cinfo.cname)","users.userid","users.usertype","concat_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)","max(userlog_acc.last_login)","max(userlog_acc.last_access)","users.cdate","cuser.name","users.um_mdate","muser.name","","","");

            $tque="SELECT COUNT(1) FROM staffacc_cinfo LEFT JOIN staffacc_contact ON staffacc_cinfo.username=staffacc_contact.username LEFT JOIN staffacc_contactacc ON staffacc_contact.sno=staffacc_contactacc.con_id LEFT JOIN users ON staffacc_contactacc.username=users.username LEFT JOIN userlog_acc on staffacc_contactacc.username=userlog_acc.username LEFT JOIN users as muser ON muser.username = users.um_muser LEFT JOIN users as cuser ON cuser.username = users.um_cuser WHERE staffacc_contactacc.status='ACTIVE'";
	        $oque="SELECT CONCAT_WS(' - ',staffacc_cinfo.sno,staffacc_cinfo.cname) as cmpName,users.userid,staffacc_contact.sno,CONCAT_WS(' - ',staffacc_contact.sno,TRIM(concat_ws(' ',staffacc_contact.fname,staffacc_contact.lname))) as canName,".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",users.username,".tzRetQueryStringDTime("users.cdate","DateTime","/").",cuser.name, ".tzRetQueryStringDTime("users.um_mdate","DateTime","/").", muser.name FROM staffacc_cinfo LEFT JOIN staffacc_contact ON staffacc_cinfo.username=staffacc_contact.username LEFT JOIN staffacc_contactacc ON staffacc_contact.sno=staffacc_contactacc.con_id LEFT JOIN users ON staffacc_contactacc.username=users.username LEFT JOIN userlog_acc on staffacc_contactacc.username=userlog_acc.username LEFT JOIN users as muser ON muser.username = users.um_muser LEFT JOIN users as cuser ON cuser.username = users.um_cuser WHERE staffacc_contactacc.status='ACTIVE'";
        }
        else if($acctype=="APP")
        {          
			$asFields = array("","consultant_list.name","users.userid","users.usertype","IF(consultant_list.A2M = 'Y','CRM','Pipeline')",tzRetQueryStringDTime("users.cdate","DateTime","/"),"IF(create_user.name IS NULL,'Applicant',create_user.name)",tzRetQueryStringDTime("users.um_mdate","DateTime","/"),"IF(modified_user.name IS NULL,'Applicant',modified_user.name)");
			$ssFields = array("","TRIM(consultant_list.name)","users.userid","users.usertype","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","users.cdate","IF(create_user.name IS NULL,'Applicant',create_user.name)","users.um_mdate","IF(modified_user.name IS NULL,'Applicant',modified_user.name)");

			$tque="SELECT COUNT(1) FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE users.type='cand' AND users.status!='DA'";
			$oque="SELECT users.userid,consultant_list.serial_no,consultant_list.name,IF(consultant_list.A2M = 'Y','CRM','Pipeline') stage,".tzRetQueryStringDTime("users.cdate","DateTime","/").",IF(create_user.name IS NULL,'Applicant',create_user.name) cuser,".tzRetQueryStringDTime("users.um_mdate","DateTime","/").",IF(modified_user.name IS NULL,'Applicant',modified_user.name) muser FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE users.type='cand' AND users.status!='DA'";
        }
		else
		{
			$asFields=array("","CONCAT(emp_list.sno,' - ',emp_list.name)","users.userid","users.usertype","department.deptname",tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/"),tzRetQueryStringDTime("max(userlog_acc.last_access)","DateTime","/"),tzRetQueryStringDTime("users.cdate","DateTime","/"),"create_user.name",tzRetQueryStringDTime("users.um_mdate","DateTime","/"),"modified_user.name");
			$ssFields=array("","TRIM(users.name)","users.userid","users.usertype","department.deptname","max(userlog_acc.last_login)","max(userlog_acc.last_access)","users.cdate","create_user.name","users.um_mdate","modified_user.name","","","","","","","");

			if($acctype=="PUS" || $acctype=="")
			{
				$tque="SELECT count(1) CNT FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype!=''";
				$oque="SELECT emp_list.sno SNO,emp_list.username,CONCAT(emp_list.sno,' - ',emp_list.name),department.deptname,users.type,users.userid,sysuser.collaboration,users.last_login,".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",".tzRetQueryStringDTime('users.cdate','DateTime','/').",create_user.name,".tzRetQueryStringDTime('users.um_mdate','DateTime','/').",modified_user.name, users.usertype FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype!=''";
			}
			else
			{
				$tque="SELECT count(1) CNT FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype='$acctype'";
				$oque="SELECT emp_list.sno SNO,emp_list.username,CONCAT(emp_list.sno,' - ',emp_list.name),department.deptname,users.type,users.userid,sysuser.collaboration,users.last_login,".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",".tzRetQueryStringDTime('users.cdate','DateTime','/').",create_user.name,".tzRetQueryStringDTime('users.um_mdate','DateTime','/').",modified_user.name, users.usertype FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype='$acctype'";
			}
		}

		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		if($acctype=="APP")
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		else
			$qstr=$gd->buildQSTRForAdmin($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="")
		{
			if ($gridSearchFields[4]=="" && $gridSearchFields[5]=="")
				$qstr.=" group by users.username";
		}
		else
		{
			$oque.=" group by users.username";
			$tque.=" group by users.username";
		}

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);

        $tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);

        $gridData=$gd->buildAdminUserManagementData($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
    }

    //---Function for displaying the data in main grid for Employees, Accounts and Consultants(for active recored only) in Admin->User Management. siva prasanth
	// Modified By Vijaya to add new columns on 11-09-2008
    function buildAdminUserManagementData($que)
	{
		global $maildb,$db,$acctype;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
            if($acctype=="SSU")
            {
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[1]."><span class='checkmark'></span><input type=hidden name='user_type_".$row[1]."' id='user_type_".$row[1]."' value='SSU'></label>";
                $grid[$j][1]=$this->convertSpecChars($row[2]);
                $grid[$j][2]=$this->convertSpecChars($row[5]);
                $grid[$j][3]=$this->convertSpecChars("Employee Self Service User");
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars(trim($row[8]));
                $grid[$j][6]=$this->convertSpecChars(trim($row[9]));
				$grid[$j][7]=$this->convertSpecChars(trim($row[10]));
				$grid[$j][8]=$this->convertSpecChars(trim($row[11]));
				$grid[$j][9]=$this->convertSpecChars(trim($row[12]));
				$grid[$j][10]=$this->convertSpecChars(trim($row[13]));
                $grid[$j][11]="<a href=javascript:doEditSSU(".$row[1].")><img src=/BSOS/images/icons/preferences.gif title='Preferences' border=0></a>";
    			$grid[$j][12]="<a href=javascript:doUserName(".$row[1].")><img src=/BSOS/images/icons/username.gif title='Edit&nbsp;User&nbsp;Name' border=0></a>";
    			$grid[$j][13]="<a href=javascript:doPassword(".$row[1].")><img src=/BSOS/images/icons/password.gif title='Reset&nbsp;Password' border=0></a>";
				$grid[$j][14]="<a href=javascript:doDeactivateSSU(".$row[1].")><img src=/BSOS/images/icons/deactivate.gif title='Deactivate' border=0></a>";
                $grid[$j][15]="";
    			$j++;
			}
			else if($acctype=="CSS")
			{
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' Onclick=chk_clearTop() value=".$row[2]."><span class='checkmark'></span><input type=hidden name='user_type_".$row[2]."' id='user_type_".$row[2]."' value='CSS'><input type=hidden name='user_sno_".$row[2]."' id='user_sno_".$row[2]."' value=".$row[6]."></label>";
                $grid[$j][1]=$this->convertSpecChars($row[0]);
                $grid[$j][2]=$this->convertSpecChars($row[1]);
                $grid[$j][3]=$this->convertSpecChars("Customer Self Service User");
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars(trim($row[4]));
                $grid[$j][6]=$this->convertSpecChars(trim($row[5]));
				$grid[$j][7]=$this->convertSpecChars(trim($row[7]));
				$grid[$j][8]=$this->convertSpecChars(trim($row[8]));
				$grid[$j][9]=$this->convertSpecChars(trim($row[9]));
				$grid[$j][10]=$this->convertSpecChars(trim($row[10]));
                $grid[$j][11]="<a href=javascript:DoprefEdit(".$row[6].")><img src=/BSOS/images/icons/preferences.gif title='Preferences' border=0></a>";
                $grid[$j][12]="<a href=javascript:doPrefusername(".$row[6].")><img src=/BSOS/images/icons/username.gif title='Edit&nbsp;User&nbsp;Name' border=0></a>";
                $grid[$j][13]="<a href=javascript:doPrefpassword(".$row[6].")><img src=/BSOS/images/icons/password.gif title='Reset&nbsp;Password' border=0></a>";
                $grid[$j][14]="<a href=javascript:do_Deactivate(".$row[6].")><img src=/BSOS/images/icons/deactivate.gif title='Deactivate' border=0></a>";
                $grid[$j][15]="";
                $j++;
            }
            else if($acctype=="APP")
			{
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value=".$row[1]."><span class='checkmark'></span></label>";
        		$grid[$j][1]=$this->convertSpecChars($row[2]);
        		$grid[$j][2]=$this->convertSpecChars($row[0]);
                $grid[$j][3]=$this->convertSpecChars("Applicant User");
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars($row[4]);
                $grid[$j][6]=$this->convertSpecChars($row[5]);
				$grid[$j][7]=$this->convertSpecChars($row[6]);
				$grid[$j][8]=$this->convertSpecChars($row[7]);
    			$grid[$j][9]="<a href=javascript:doAppPassword(".$row[1].")><img src=/BSOS/images/icons/password.gif title='Reset&nbsp;Password' border=0></a>";
        		$grid[$j][10]="<a href=javascript:doDeactive('".$row[1]."')><img src=/BSOS/images/icons/deactivate.gif title='Deactivate' border=0></a>";
                $grid[$j][11]="";
        		$j++;
            }
            else
			{
				if($row[14]=="FO") 
				{
					$row[14]="Front Office User";
					$utype = 'FO';
				} 
				else if($row[14]=="BO") 
				{
					$row[14]="Back Office User";
					$utype = 'BO';
				} 
				else
				{
					$row[14]="The all in User";
					$utype = 'UL';
				}

                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[1]."><span class='checkmark'></span><input type=hidden name='user_type_".$row[1]."' id='user_type_".$row[1]."' value=".$utype."></label>";
                $grid[$j][1]=$this->convertSpecChars($row[2]);
                $grid[$j][2]=$this->convertSpecChars($row[5]);
                $grid[$j][3]=$this->convertSpecChars(trim($row[14]));
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars(trim($row[8]));
                $grid[$j][6]=$this->convertSpecChars(trim($row[9]));
				$grid[$j][7]=$this->convertSpecChars(trim($row[10]));
				$grid[$j][8]=$this->convertSpecChars(trim($row[11]));
				$grid[$j][9]=$this->convertSpecChars(trim($row[12]));
				$grid[$j][10]=$this->convertSpecChars(trim($row[13]));
                $grid[$j][11]="<a href=javascript:doEdit(".$row[1].")><img src=/BSOS/images/icons/preferences.gif title='Preferences' border=0></a>";
    			$grid[$j][12]="<a href=javascript:doUserName(".$row[1].")><img src=/BSOS/images/icons/username.gif title='Edit&nbsp;User&nbsp;Name' border=0></a>";
    			$grid[$j][13]="<a href=javascript:doPassword(".$row[1].")><img src=/BSOS/images/icons/password.gif title='Reset&nbsp;Password' border=0></a>";

                if(strpos("+".$row[6],"+1+"))
                {
//Subdomain concept we have removed mailid & mailsize - Jyothi 05/12/2014
               		$grid[$j][14]="<a href=javascript:doMailsetup(".$row[1].")><img src=/BSOS/images/icons/emailsetup.gif title='EMail Set Up' border=0></a>";
    				
                }
                else
                {
                    $grid[$j][14]="";
            		
                }

                if($row[4]=="sp")
                    $grid[$j][15]="";
                else
                    $grid[$j][15]="<a href=javascript:deActiveWin(".$row[1].")><img src=/BSOS/images/icons/deactivate.gif title='Deactivate' border=0></a>";
				$grid[$j][16]="";

    			$j++;
			}
		}
		return $grid;
	}
	//My References grid query
	function getMyReferencesData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $db,$username;

		if($gridSortCol=="")
			$gridSortCol=0;

		$gd=new gridData();

		$asFields=array("","cand_refer.sno","cand_refer.fname","cand_refer.mname","cand_refer.lname","cand_refer.email","cand_refer.phone","posdesc.postitle","IF(cand_refer.emp_id!='0','Hired',IF(cand_refer.emp_id='0' AND emp_list.sno IS NOT NULL,'Hired on other Job',
		(IF(applicants.serial_no IS NOT NULL AND resume_status.pstatus = 'P','Placed',IF(applicants.serial_no IS NULL AND resume_status.pstatus = 'P','Placement-Cancelled',IF(resume_status.pstatus = 'S','Submitted','Pending'))))))","IF(cand_refer.applied_through='RAF','Referred/Applied','Shared/Applied')","jobSharedType(cand_refer.applied_through)",tzRetQueryStringDTime('cand_refer.mdate','Date','/'),"cand_refer.resume_id");
		$ssFields=array("","cand_refer.sno","TRIM(cand_refer.fname)","TRIM(cand_refer.mname)","TRIM(cand_refer.lname)","TRIM(cand_refer.email)","cand_refer.phone","TRIM(posdesc.postitle)","TRIM(cand_refer.emp_id!='0','Hired',IF(cand_refer.emp_id='0' AND emp_list.sno IS NOT NULL,'Hired on other Job',
		(IF(applicants.serial_no IS NOT NULL AND resume_status.pstatus = 'P','Placed',IF(applicants.serial_no IS NULL AND resume_status.pstatus = 'P','Placement-Cancelled',IF(resume_status.pstatus = 'S','Submitted','Pending')))))))","IF(cand_refer.applied_through='RAF','Referred/Applied','Shared/Applied')","jobSharedType(cand_refer.applied_through)",tzRetQueryStringDTime('cand_refer.mdate','Date','/'),"cand_refer.resume_id");

		$tque="SELECT count(1) CNT FROM cand_refer 
		LEFT JOIN posdesc ON posdesc.posid=cand_refer.req_id 
		LEFT JOIN candidate_list ON candidate_list.candid = cand_refer.ref_id AND candidate_list.candid!=''
		LEFT JOIN resume_status ON resume_status.res_id = candidate_list.sno AND cand_refer.req_id = resume_status.req_id AND pstatus IN ('P','S')
		LEFT JOIN applicants ON applicants.username=cand_refer.ref_id  AND FIND_IN_SET(cand_refer.req_id, applicants.jobtitle)>0
		LEFT JOIN emp_list ON IF(cand_refer.emp_id!=0,emp_list.sno=cand_refer.emp_id,IF(cand_refer.user_id IS NOT NULL,emp_list.username=cand_refer.user_id,emp_list.username=cand_refer.ref_id)) 
		WHERE cand_refer.status='active' AND cand_refer.username='".$username."'";
		
		$oque="SELECT cand_refer.ref_id,cand_refer.fname,cand_refer.mname,cand_refer.lname,cand_refer.email,cand_refer.phone,
		cand_refer.resume_id,posdesc.postitle,candidate_list.username as candid,
		resume_status.sno as cand_resume,resume_status.pstatus,applicants.serial_no as appid,emp_list.sno as empid,cand_refer.user_id,
		IF(cand_refer.emp_id!='0','Hired',IF(cand_refer.emp_id='0' AND emp_list.sno IS NOT NULL,'Hired on other Job',
		(IF(applicants.serial_no IS NOT NULL AND resume_status.pstatus = 'P','Placed',IF(applicants.serial_no IS NULL AND resume_status.pstatus = 'P','Placement-Cancelled',IF(resume_status.pstatus = 'S','Submitted','Pending')))))) AS cand_ref_status,IF(cand_refer.applied_through='RAF',if(cand_refer.ref_id IS NOT NULL,'Referred/Applied','Referred'),if(cand_refer.ref_id IS NOT NULL,'Shared/Applied','Shared')),".tzRetQueryStringDTime('cand_refer.mdate','Date','/')." as mdate,cand_refer.sno,jobSharedType(cand_refer.applied_through) as Source
		FROM cand_refer 
		LEFT JOIN posdesc ON posdesc.posid=cand_refer.req_id 
		LEFT JOIN candidate_list ON candidate_list.candid = cand_refer.ref_id AND candidate_list.candid!=''
		LEFT JOIN resume_status ON resume_status.res_id = candidate_list.sno AND cand_refer.req_id = resume_status.req_id AND pstatus IN ('P','S')
		LEFT JOIN applicants ON applicants.username=cand_refer.ref_id  AND FIND_IN_SET(cand_refer.req_id, applicants.jobtitle)>0
		LEFT JOIN emp_list ON IF(cand_refer.emp_id!=0,emp_list.sno=cand_refer.emp_id,IF(cand_refer.user_id IS NOT NULL,emp_list.username=cand_refer.user_id,emp_list.username=cand_refer.ref_id)) 
		WHERE cand_refer.status='active' AND cand_refer.username='".$username."'";

	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);

        $tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}
        $gridData=$gd->buildMyReferencesData($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
    }

    //---Function for displaying the data in main grid for Employees, Accounts and Consultants(for active recored only) in Admin->User Management. siva prasanth
	function buildMyReferencesData($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
           
				$grid[$j][0] ='';
				$grid[$j][1]=$this->convertSpecChars($row[17]);
                $grid[$j][2]=$this->convertSpecChars($row[1]);
                $grid[$j][3]=$this->convertSpecChars($row[2]);
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars($row[4]);
                $grid[$j][6]=$this->convertSpecChars($row[5]);
				
                $grid[$j][7]=$this->convertSpecChars($row[7]);
				
				$grid[$j][8]=$this->convertSpecChars($row[14]);
				$grid[$j][9]=$this->convertSpecChars($row[15]);
                $grid[$j][10]=$this->convertSpecChars($row['Source']);
				$grid[$j][11]=$this->convertSpecChars($row[16]);
				if($row[6] != '' && $row[6] != '0'){
					$grid[$j][12]="<a href=getResume.php?csno=".$row[6]." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
				}
                else{
					$grid[$j][12]='';
				}	
    			$j++;
			
		} 
		return $grid;
	}
	//My SharedJobs grid query
	function getMySharedJobsData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $db,$username;

		if($gridSortCol=="")
			$gridSortCol=0;

		$gd=new gridData();

		$asFields=array("","hj.postitle","jobSharedType(sd.sharetype)",tzRetQueryStringDTime('sd.mdate','Date','/'),"COUNT(cdr.applied_through)");
		$ssFields=array("","TRIM(hj.postitle)","TRIM(jobSharedType(sd.sharetype))",tzRetQueryStringDTime('sd.mdate','Date','/'),"COUNT(cdr.applied_through)");

		$tque="SELECT COUNT(1) FROM shared_data  sd 
          LEFT JOIN api_jobs  aj ON sd.job_id=aj.sno
          LEFT JOIN hotjobs  hj ON hj.sno=aj.req_id
          LEFT JOIN cand_refer  cdr ON hj.req_id =cdr.req_id AND cdr.applied_through=sd.sharetype AND cdr.username=sd.username
WHERE sd.username='".$username."' ";
		
		$oque="SELECT hj.postitle, jobSharedType(sd.sharetype) AS shareTh, ".tzRetQueryStringDTime('sd.mdate','Date','/')." AS  mdate,COUNT(cdr.applied_through)  FROM shared_data  sd 
          LEFT JOIN api_jobs  aj ON sd.job_id=aj.sno
          LEFT JOIN hotjobs  hj ON hj.sno=aj.req_id
          LEFT JOIN cand_refer  cdr ON hj.req_id =cdr.req_id AND cdr.applied_through=sd.sharetype AND cdr.username=sd.username 
		WHERE sd.username='".$username."' ";

	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$gstr = 'GROUP BY sd.job_id,sd.sharetype';
		
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

        $tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		
        $gridData=$gd->buildMySharedJobsData($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
    }

    //---Function for displaying the data in main grid for Employees, Accounts and Consultants(for active recored only) in Admin->User Management. siva prasanth
	function buildMySharedJobsData($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
           //print_r($row);
				$grid[$j][0] ='';
                $grid[$j][1]=$this->convertSpecChars($row[0]);
                $grid[$j][2]=$this->convertSpecChars($row[1]);
                $grid[$j][3]=$row[2];
                $grid[$j][4]=$row[3];
                	
    			$j++;
			
		} 
		//print_r($grid);
		return $grid;
	}	
	//Function which contains queries for Employees, Accounts and Consultants(for inactive recored only) in Admin->User Management.-- siva prasanth
	function getAdminUserManagementInactiveData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone,$acctype;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

        if($acctype=="SSU")
        {
			$asFields=array("","emp_list.name","users.userid","users.usertype","department.deptname",tzRetQueryStringDTime("users.cdate","DateTime","/"),"cusr.name",tzRetQueryStringDTime("users.um_deactive_date","DateTime","/"),"dausr.name");
			$ssFields=array("","users.name","users.userid","users.usertype","department.deptname","users.cdate","cusr.name","users.um_deactive_date","dausr.name","emp_list.sno");

			$tque="SELECT count(1) from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN users ON hrcon_compen.username=users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username where hrcon_compen.ustatus='active' and users.status='DA' and users.type in ('sp','PE','consultant') AND users.usertype='' ";
			$oque="SELECT emp_list.sno,emp_list.username,emp_list.name, department.deptname, users.type, users.userid,".tzRetQueryStringDTime("users.cdate","DateTime","/").", cusr.name,".tzRetQueryStringDTime("users.um_deactive_date","DateTime","/").", dausr.name FROM emp_list LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept = department.sno LEFT JOIN users ON hrcon_compen.username = users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username WHERE hrcon_compen.ustatus = 'active' AND users.status = 'DA' and users.type in ('sp','PE','consultant') AND users.usertype='' ";
        }
        else if($acctype=="CSS")
        {
            $asFields=array("","staffacc_cinfo.cname","users.userid","users.usertype","concat_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)",tzRetQueryStringDTime("users.cdate","DateTime","/"),"cusr.name",tzRetQueryStringDTime("users.um_deactive_date","DateTime","/"),"dausr.name");
            $ssFields=array("","staffacc_cinfo.cname","users.userid","users.usertype","concat_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)","users.cdate","cusr.name","users.um_deactive_date","dausr.name");

            $tque="SELECT COUNT(1) from  staffacc_cinfo,staffacc_contact,staffacc_contactacc,users LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username where staffacc_cinfo.username=staffacc_contact.username and staffacc_contactacc.status='DA' and staffacc_contact.sno=staffacc_contactacc.con_id and staffacc_contactacc.username=users.username ";
            $oque="select staffacc_cinfo.cname,users.userid,staffacc_contact.sno,concat_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname),".tzRetQueryStringDTime("users.cdate","DateTime","/").",cusr.name cuser,".tzRetQueryStringDTime("users.um_deactive_date","DateTime","/").",dausr.name duser from staffacc_cinfo,staffacc_contact,staffacc_contactacc,users LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username where staffacc_cinfo.username=staffacc_contact.username and staffacc_contactacc.status='DA' and staffacc_contact.sno=staffacc_contactacc.con_id and staffacc_contactacc.username=users.username ";
        }
        else if($acctype=="APP")
        {          
			$asFields = array("","consultant_list.name","users.userid","users.usertype","IF(consultant_list.A2M = 'Y','CRM','Pipeline')",tzRetQueryStringDTime("users.cdate","DateTime","/"),"IF(create_user.name IS NULL,'Applicant',create_user.name)",tzRetQueryStringDTime("users.um_deactive_date","DateTime","/"),"IF(modified_user.name IS NULL,'Applicant',modified_user.name)");
			$ssFields = array("","consultant_list.name","users.userid","users.usertype","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","users.cdate","IF(create_user.name IS NULL,'Applicant',create_user.name)","users.um_deactive_date","IF(modified_user.name IS NULL,'Applicant',modified_user.name)");

			$tque="SELECT COUNT(1) FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_muser = modified_user.username WHERE users.type='cand' AND users.status='DA'";
			$oque="SELECT users.userid,consultant_list.serial_no,consultant_list.name,IF(consultant_list.A2M = 'Y','CRM','Pipeline') stage,".tzRetQueryStringDTime("users.cdate","DateTime","/").",IF(create_user.name IS NULL,'Applicant',create_user.name) cuser,".tzRetQueryStringDTime("users.um_deactive_date","DateTime","/").",IF(modified_user.name IS NULL,'Applicant',modified_user.name) muser FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN users modified_user ON users.um_deactive_user = modified_user.username WHERE users.type='cand' AND users.status='DA'";
        }
        else
        {
			$asFields=array("","emp_list.name","users.userid","users.usertype","department.deptname",tzRetQueryStringDTime("users.cdate","DateTime","/"),"cusr.name",tzRetQueryStringDTime("users.um_deactive_date","DateTime","/"),"dausr.name");
			$ssFields=array("","users.name","users.userid","users.usertype","department.deptname","users.cdate","cusr.name","users.um_deactive_date","dausr.name","emp_list.sno");

			if($acctype=="PUS" || $acctype=="")
			{
				$tque="SELECT count(1) from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN users ON hrcon_compen.username=users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username where hrcon_compen.ustatus='active' and users.status='DA' and users.type in ('sp','PE','consultant') AND users.usertype!='' ";
				$oque="SELECT emp_list.sno,emp_list.username,emp_list.name, department.deptname, users.type, users.userid,".tzRetQueryStringDTime("users.cdate","DateTime","/").", cusr.name,".tzRetQueryStringDTime("users.um_deactive_date","DateTime","/").", dausr.name, users.usertype FROM emp_list LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept = department.sno LEFT JOIN users ON hrcon_compen.username = users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username WHERE hrcon_compen.ustatus = 'active' AND users.status = 'DA' and users.type in ('sp','PE','consultant') AND users.usertype!='' ";
			}
			else
			{
				$tque="SELECT count(1) from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN users ON hrcon_compen.username=users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username where hrcon_compen.ustatus='active' and users.status='DA' and users.type in ('sp','PE','consultant') AND users.usertype='$acctype' ";
				$oque="SELECT emp_list.sno,emp_list.username,emp_list.name, department.deptname, users.type, users.userid,".tzRetQueryStringDTime("users.cdate","DateTime","/").", cusr.name,".tzRetQueryStringDTime("users.um_deactive_date","DateTime","/").", dausr.name, users.usertype FROM emp_list LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept = department.sno LEFT JOIN users ON hrcon_compen.username = users.username LEFT JOIN users cusr ON users.um_cuser = cusr.username LEFT JOIN users dausr ON users.um_deactive_user = dausr.username WHERE hrcon_compen.ustatus = 'active' AND users.status = 'DA' and users.type in ('sp','PE','consultant') AND users.usertype='$acctype' ";
			}
        }

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="")
		{
			if ($gridSearchFields[4]=="" && $gridSearchFields[5]=="")
				$qstr.=" group by users.username";
		}
		else
		{
			$oque.=" group by users.username";
			$tque.=" group by users.username";
		}

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);

        $tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);

        $gridData=$gd->buildAdminUserManagementInactiveData($oque);
        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
    }

    //Function for displaying the data in main grid for Employees, Accounts and Consultants(for active recored only) in Admin->User Management.--siva prasanth
    function buildAdminUserManagementInactiveData($que)
	{
		global $maildb,$db,$acctype;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
            if($acctype=="SSU")
            {
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[0]."><span class='checkmark'></span></label>";
                $grid[$j][1]=$this->convertSpecChars($row[2]);
                $grid[$j][2]=$this->convertSpecChars($row[5]);
                $grid[$j][3]=$this->convertSpecChars("Employee Self Service User");
                $grid[$j][4]=$this->convertSpecChars($row[3]);
				$grid[$j][5]=$this->convertSpecChars($row[6]);
				$grid[$j][6]=$this->convertSpecChars($row[7]);
				$grid[$j][7]=$this->convertSpecChars($row[8]);
				$grid[$j][8]=$this->convertSpecChars($row[9]);
                $grid[$j][9]="<a href=javascript:doActiveSSU(".$row[0].")><img src=/BSOS/images/icons/activate.gif title='Activate' border=0></a>";
                $grid[$j][10]="";
    			$j++;
			}
			else if($acctype=="CSS")
			{
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[2]."><span class='checkmark'></span></label>";
                $grid[$j][1]=$this->convertSpecChars($row[0]);
                $grid[$j][2]=$this->convertSpecChars($row[1]);
                $grid[$j][3]=$this->convertSpecChars("Customer Self Service User");
				$grid[$j][4]=$this->convertSpecChars($row[3]);
				$grid[$j][5]=$this->convertSpecChars($row[4]);
				$grid[$j][6]=$this->convertSpecChars($row[5]);
				$grid[$j][7]=$this->convertSpecChars($row[6]);
				$grid[$j][8]=$this->convertSpecChars($row[7]);
                $grid[$j][9]="<a href=javascript:do_Activate('".$row[2]."')><img src=/BSOS/images/icons/activate.gif title='Activate' border=0></a>";
                $grid[$j][10]="";
                $j++;
            }
            else if($acctype=="APP")
			{
                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value=".$row[1]."><span class='checkmark'></span></label>";
        		$grid[$j][1]=$this->convertSpecChars($row[2]);
        		$grid[$j][2]=$this->convertSpecChars($row[0]);
        		$grid[$j][3]=$this->convertSpecChars("Applicant User");
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars($row[4]);
                $grid[$j][6]=$this->convertSpecChars($row[5]);
				$grid[$j][7]=$this->convertSpecChars($row[6]);
				$grid[$j][8]=$this->convertSpecChars($row[7]);
        		$grid[$j][9]="<a href=javascript:doActivate('".$row[1]."')><img src=/BSOS/images/icons/activate.gif title='Activate' border=0></a>";
                $grid[$j][10]="";
        		$j++;
            }
            else
            {
				if($row[10]=="FO")
					$row[10]="Front Office User";
				else if($row[10]=="BO")
					$row[10]="Back Office User";
				else
					$row[10]="The all in User";

                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[0]."><span class='checkmark'></span></label>";
                $grid[$j][1]=$this->convertSpecChars($row[2]);
                $grid[$j][2]=$this->convertSpecChars($row[5]);
				$grid[$j][3]=$this->convertSpecChars($row[10]);
                $grid[$j][4]=$this->convertSpecChars($row[3]);
				$grid[$j][5]=$this->convertSpecChars($row[6]);
				$grid[$j][6]=$this->convertSpecChars($row[7]);
				$grid[$j][7]=$this->convertSpecChars($row[8]);
				$grid[$j][8]=$this->convertSpecChars($row[9]);
                $grid[$j][9]="<a href=javascript:doActive(".$row[0].")><img src=/BSOS/images/icons/activate.gif title='Activate' border=0></a>";
                $grid[$j][10]="";
    			$j++;
			}
		}
		return $grid;
	}
  //------xajax grid for admin user mangement --siva prasanth
	function buildQSTRForAdmin($gridSearchType,$gridSearchFields,$asFields)
	{
		$qstr="";

		if($this->isSearch($gridSearchFields))
		{
			for($i=0;$i<count($gridSearchFields);$i++)
			{
                $gridSearchField=mysql_real_escape_string(addslashes($gridSearchFields[$i]));
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);

                if($gridSearchFields[$i]!="")
				{
					$flag=true;
					if($i==4)
					{
						if($gridSearchFields[4]!="")
							$gridSearchType=" group by users.username having ";
						$flag= false;	
					}
					else if($i==5 && $gridSearchFields[4]=="")
					{
						$gridSearchType=" group by users.username having ";
						$flag= false;
					}
					else if($i==5 && $gridSearchFields[4]!="")
					{
						$flag= false;
						$gridSearchType=" AND ";
					}
					else
					{
						$gridSearchType=" AND ";
					}

					if($flag==true)
                    	$qstr.= $gridSearchType." ".$asFields[$i+1]." LIKE '%".$gridSearchField."%' ";
					else
						$temp.= $gridSearchType." ".$asFields[$i+1]." LIKE '%".$gridSearchField."%' ";	
 				}
			}
		}
		return $qstr.$temp;
	}
	//---------implement of xajax grid for HRM->employee management for archive data--------Modified By suryaprakash
	/*--prasadd-moved hrcon_jobs_ustatus term from where condition to left join itself and $department_dynStr added...--*/
	function  getEmployeeManagementHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$accountingpref;

		if($gridSortCol=="")
			$gridSortCol=1;

		$acs="";//variable for passing access permissions
		$gd=new gridData();

    	$asFields=array("","hrcon_general.fname","hrcon_general.lname", "hrcon_general.wphone","hrcon_general.email","hrcon_w4.tax","emp_list.stime","own.name","emp_list.mtime","musr.name");
		
    	$ssFields=array("","hrcon_general.fname","hrcon_general.lname", "hrcon_general.wphone","hrcon_general.email","hrcon_w4.tax","DATE_FORMAT(CONVERT_TZ(emp_list.stime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')","own.name","DATE_FORMAT(CONVERT_TZ(emp_list.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')","musr.name");

		$department_dynStr = " AND FIND_IN_SET('".$username."',department.permission)>0 ";

		$tque = "select count(distinct(emp_list.sno)) from emp_list LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active') LEFT JOIN hrcon_w4 ON (emp_list.username=hrcon_w4.username and hrcon_w4.ustatus='active') LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username LEFT JOIN department ON hrcon_compen.dept=department.sno left join users own on emp_list.approveuser=own.username	left join users musr on emp_list.muser=musr.username where hrcon_general.ustatus='active' and emp_list.lstatus = 'DA' ".$department_dynStr;

		$oque = "select distinct(emp_list.sno),hrcon_general.fname,hrcon_general.lname,'' sk_nm,hrcon_general.wphone,hrcon_general.email,
		hrcon_w4.tax,hrcon_general.username,DATE_FORMAT(CONVERT_TZ(emp_list.stime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),own.name approveuser,DATE_FORMAT(CONVERT_TZ(emp_list.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),musr.name muser
		from emp_list 
		LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active') 
		LEFT JOIN hrcon_w4 ON (emp_list.username=hrcon_w4.username and hrcon_w4.ustatus='active')  
		LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		left join users own on emp_list.approveuser=own.username				
		left join users musr on emp_list.muser=musr.username
		where hrcon_general.ustatus='active' and emp_list.lstatus = 'DA' ".$department_dynStr;

        $gstr = " group by emp_list.sno";
        // Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('hrcon_general.wphone',$ssFields)){
			$asFieldsKey = array_search("hrcon_general.wphone", $ssFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("hrcon_general.wphone",$asFieldsKey);
			$ssFields[$asFieldsKey] = $asFields[$asFieldsKey];
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("hrcon_general.wphone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);

		 if($qstr!="")
             $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildEmployeeManagementHis($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
   //---------implement of xajax grid for HRM->employee management for archive data--------siva prasanth
	function buildEmployeeManagementHis($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
			if($row[4] == "-" || $row[4] == "--" || $row[4] == "---")
				$row[4] = "";
			else
				$row[4] = $row[4];
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop1() value=\"$row[0]\"><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[4]);
			$grid[$j][4]=$this->convertSpecChars($row[5]);
			$grid[$j][5]=$this->convertSpecChars($row[6]);
			$grid[$j][6]=$this->convertSpecChars($row[8]);
			$grid[$j][7]=$this->convertSpecChars($row[9]);
			$grid[$j][8]=$this->convertSpecChars($row[10]);
			$grid[$j][9]=$this->convertSpecChars($row[11]);
			$grid[$j][10]="";
			$grid[$j][11]=$row[0];
			$j++;
		}
        return $grid;
	}
	// Modified by vijaya to add new columns	
	//-------------------------------------------------
	//HRM Applicant Tracking
	function buildApplicants($que)
	{
		global $maildb,$db,$crmpref,$username,$ac_aced;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{			
			//Condition for Availability date
			if (($row[7] == "0-0-0") || ($row[7] == ""))
				$avail="Immediate";
			else
			{
				$row[7]=str_replace("-","/",$row[7]);
				$avail=$row[7];
			}
			//Condition for jobs Jobs Applied To			
			$jobOrder_List="";
			$multiRowBreaks = "";
			if($row[17]!="")
			{
				$sqlPosdes="select posid,postitle,refcode,status,IF(accessto = 'all', 'Public', IF(FIND_IN_SET('".$username."',accessto)>0 , 'Share','NONE')) from posdesc  where posid in ($row[17]) order by postitle  ";
				$resPosdesc=mysql_query($sqlPosdes,$db);
				while($posData=mysql_fetch_row($resPosdesc))
				{
					$joborder="";
					$postitle=$this->convertSpecChars($posData[1]);
					$refcode=$this->convertSpecChars($posData[2]);
					$candrn=strtotime("now");
					if($postitle!="")
					{
						if(chkUserPref($crmpref,"4")) 
						{							
							if($posData[3]=="backup" || $posData[4]=="NONE" )
								$joborder=$postitle;				
							
							else if($posData[3]=="deleted" )
								$joborder="<a href=javascript:winopennewApp('/BSOS/Sales/Req_Mngmt/viewarchivesummary.php?addr=".$posData[0]."&candrn=".$candrn."&user_status=". $posData[4]."&module=CRM') style='font-family: Arial'>$postitle</a>";
								
							else
								$joborder="<a href=javascript:winopennewApp('/BSOS/Sales/Req_Mngmt/jobSummary.php?addr=".$posData[0]."&candrn=".$candrn."&module=CRM') style='font-family: Arial'>$postitle</a>";
							
						}
						else
							$joborder=$postitle;
					}
					if($refcode!="")
						$joborder=$joborder."(".$refcode.")";
					if($joborder!="")	
					{
						if($jobOrder_List=="")
							$jobOrder_List=$joborder;
						else
							$jobOrder_List.="<br>".$joborder;
							
						$multiRowBreaks.="<br>";
					}
				}
			}
			
			$caname=$this->convertSpecChars($row[2]);
			if($row[15] == 'CRM'){
				$quer="SELECT sno FROM candidate_list WHERE candid='$row[1]'";
				$quey=mysql_query($quer,$db);
				$querow=mysql_fetch_row($quey);
				$canlink="<a href=javascript:candOpen($querow[0],'CRM')><font class=linkrow>$caname</font></a>";
			}
			else{
				$canlink=$caname;
			}
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[1]."'><input type=hidden name=serialNo[] value='".$row[0]."'><input type=hidden name=stages[] value='".$row[15]."'><input type=hidden name=adgroupsno[] value='".$row[28]."'><input type=hidden name=adstatus[] value='".$row[29]."'><span class='checkmark'></span></label>".$multiRowBreaks;
			$grid[$j][1]=$canlink.$multiRowBreaks; #Candidate Name
			$grid[$j][2]=$this->convertSpecChars($row[24]).$multiRowBreaks; // Profile Title
			$grid[$j][3]=$this->convertSpecChars($row[3]).$multiRowBreaks;
			$grid[$j][4]=$this->convertSpecChars($row[22]).$multiRowBreaks;	
			$grid[$j][5]=$this->convertSpecChars($row[4]).$multiRowBreaks;
			$grid[$j][6]=$this->convertSpecChars($row[5]).$multiRowBreaks;
			$grid[$j][7]=$jobOrder_List;		
			$grid[$j][8]=$this->convertSpecChars($avail).$multiRowBreaks;
			$grid[$j][9]=$this->convertSpecChars($row[15]).$multiRowBreaks; #stages

			if(APPLICANT_DISTRIBUTION_ENABLED == 'Y' && APPLICANT_DISTRIBUTION_HRMREF == 'Y' && APPLICANT_DISTRIBUTION_ADMINPREF == 'Y')
			{
				
				$grid[$j][10]=$this->convertSpecChars($row[25]).$multiRowBreaks; #assignTo
				$grid[$j][11]=$this->convertSpecChars($row[26]).$multiRowBreaks; #assignDate
				$grid[$j][12]=$this->convertSpecChars($row[27]).$multiRowBreaks; #assignGroupName
				$grid[$j][13]=$this->convertSpecChars($row[29]).$multiRowBreaks; #assignStatus
				$grid[$j][14]=$this->convertSpecChars($row[30]).$multiRowBreaks; #assignDaysCount
				$grid[$j][15]=$this->convertSpecChars($row[16]).$multiRowBreaks;
				$grid[$j][16]=$this->convertSpecChars(getManage($row[23])).$multiRowBreaks;
				$grid[$j][17]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[6]))).$multiRowBreaks;
				$grid[$j][18]=$this->convertSpecChars($row[14]).$multiRowBreaks;						
				$grid[$j][19]=$this->convertSpecChars($row[18]).$multiRowBreaks; #Created By
				$grid[$j][20]=$this->convertSpecChars($row[20]).$multiRowBreaks; #Created Date
				$grid[$j][21]=$this->convertSpecChars($row[19]).$multiRowBreaks; #Modified Date
				$grid[$j][22]=$this->convertSpecChars($row[21]).$multiRowBreaks; #Modified By
				
				$grid[$j][23]=''.$multiRowBreaks;		
				$grid[$j][24]=$row[1];
			
			}
			else 
			{
				$grid[$j][10]=$this->convertSpecChars($row[16]).$multiRowBreaks;
				$grid[$j][11]=$this->convertSpecChars(getManage($row[23])).$multiRowBreaks;
				$grid[$j][12]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[6]))).$multiRowBreaks;
				$grid[$j][13]=$this->convertSpecChars($row[14]).$multiRowBreaks;						
				$grid[$j][14]=$this->convertSpecChars($row[18]).$multiRowBreaks; #Created By
				$grid[$j][15]=$this->convertSpecChars($row[20]).$multiRowBreaks; #Created Date
				$grid[$j][16]=$this->convertSpecChars($row[19]).$multiRowBreaks; #Modified Date
				$grid[$j][17]=$this->convertSpecChars($row[21]).$multiRowBreaks; #Modified By
				
				$grid[$j][18]=''.$multiRowBreaks;		
				$grid[$j][19]=$row[1];
			}
			
			$j++;			
		}
		return $grid;
	}
	//HRM Applicant Tracking--Sandhya 
	// Modified  By vijaya to add Modified Date to the main page
	function getApplicants($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$appStatus;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		
		$aqstr=" 1=1 ";
		$added_leftJoin = " ";
		if(APPLICANT_DISTRIBUTION_ENABLED == 'Y' && APPLICANT_DISTRIBUTION_HRMREF == 'Y' && APPLICANT_DISTRIBUTION_ADMINPREF == 'Y')
		{
		
			$asFields = array("","consultant_list.name","consultant_general.profiletitle","consultant_general.hphone","consultant_general.email","consultant_general.city","consultant_general.state","","IF((consultant_list.avail='0-0-0' or consultant_list.avail='' or consultant_list.avail='immediate'),'Immediate',(IF((to_days(now())-to_days(CONCAT(SUBSTRING_INDEX(consultant_list.avail,'-',-1 ),						'-',SUBSTRING_INDEX(consultant_list.avail,'-',2))))<0,consultant_list.avail,'Immediate')))","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","asignto.name",tzRetQueryStringDTime("consultant_list.assign_date","DateTimeSec","/"),"CONCAT(adgs.group_name,IF(adgs.automation = 'N',' (M)',' (A)'))","CASE WHEN ad.flag = 'Y' THEN 'Accepted' WHEN ad.flag = 'S' THEN 'Completed' WHEN ad.flag = 'N' THEN 'Pending' ELSE '' END","CASE WHEN adgs.exclude_weekends = 'Y' THEN IF(ad.flag = 'N',CONCAT((SELECT (TOTAL_WEEKDAYS(consultant_list.assign_date,NOW()))),'/',adgs.max_days),'') ELSE IF(ad.flag = 'N',CONCAT((SELECT DATEDIFF(NOW(), consultant_list.assign_date)),'/',adgs.max_days),'') END","consultant_general.source","manage.name","consultant_personal.ssn","group_concat(distinct imstyp.status)",tzRetQueryStringDTime("consultant_list.stime","DateTimeSec","/"),"users.name",tzRetQueryStringDTime("consultant_list.mtime","DateTimeSec","/"), "muser.name");
			
			$ssFields = array("","consultant_list.name","consultant_general.profiletitle","consultant_general.hphone","consultant_general.email","consultant_general.city","consultant_general.state","REPLACE (GROUP_CONCAT( DISTINCT posdesc.postitle ORDER BY posdesc.postitle ), ',', '')","IF((consultant_list.avail='0-0-0' or consultant_list.avail='' or consultant_list.avail='immediate'),'Immediate',(IF((to_days(now())-to_days(CONCAT(SUBSTRING_INDEX(consultant_list.avail,'-',-1 ),'-',SUBSTRING_INDEX(consultant_list.avail,'-',2))))<0,consultant_list.avail,'Immediate')))","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","asignto.name","consultant_list.assign_date","CONCAT(adgs.group_name,IF(adgs.automation = 'N',' (M)',' (A)'))","CASE WHEN ad.flag = 'Y' THEN 'Accepted' WHEN ad.flag = 'S' THEN 'Completed' WHEN ad.flag = 'N' THEN 'Pending' ELSE '' END","CASE WHEN adgs.exclude_weekends = 'Y' THEN IF(ad.flag = 'N',CONCAT((SELECT (TOTAL_WEEKDAYS(consultant_list.assign_date,NOW())-1)),'/',adgs.max_days),'') ELSE IF(ad.flag = 'N',CONCAT((SELECT DATEDIFF(NOW(), consultant_list.assign_date)),'/',adgs.max_days),'') END","consultant_general.source","manage.name","consultant_personal.ssn","group_concat(distinct imstyp.status)","consultant_list.stime", "users.name", "consultant_list.mtime", "muser.name");

			$added_col = ",asignto.name as assignTo,".tzRetQueryStringDTime("consultant_list.assign_date","DateTimeSec","/").",CONCAT(adgs.group_name,IF(adgs.automation = 'N',' (M)',' (A)')),adgs.sno,CASE WHEN ad.flag = 'Y' THEN 'Accepted' WHEN ad.flag = 'S' THEN 'Completed' WHEN ad.flag = 'N' THEN 'Pending' ELSE '' END,CASE WHEN adgs.exclude_weekends = 'Y' THEN IF(ad.flag = 'N',CONCAT((SELECT (TOTAL_WEEKDAYS(consultant_list.assign_date,NOW())-1)),'/',adgs.max_days),'') ELSE IF(ad.flag = 'N',CONCAT((SELECT DATEDIFF(NOW(), consultant_list.assign_date)),'/',adgs.max_days),'') END AS excludeWeekends  ";
			$added_leftJoin = " LEFT JOIN users AS asignto ON consultant_list.assign_to=asignto.username 
								LEFT JOIN ad_group_settings AS adgs ON adgs.sno=consultant_list.assign_groupid
								LEFT JOIN applicant_distribution AS ad ON ad.aplcnt_sno=consultant_list.serial_no AND ad.cand_sno <> 0";
		}
		else 
		{
			$asFields = array("","consultant_list.name","consultant_general.profiletitle","consultant_general.hphone","consultant_general.email","consultant_general.city","consultant_general.state","","IF((consultant_list.avail='0-0-0' or 						consultant_list.avail='' or consultant_list.avail='immediate'),'Immediate',(IF((to_days(now())-to_days(CONCAT(SUBSTRING_INDEX(consultant_list.avail,'-',-1 ),						'-',SUBSTRING_INDEX(consultant_list.avail,'-',2))))<0,consultant_list.avail,'Immediate')))","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","consultant_general.source","manage.name","consultant_personal.ssn","group_concat(distinct imstyp.status)",tzRetQueryStringDTime("consultant_list.stime","DateTimeSec","/"),"users.name",tzRetQueryStringDTime("consultant_list.mtime","DateTimeSec","/"), "muser.name");
			
			$ssFields = array("","consultant_list.name","consultant_general.profiletitle","consultant_general.hphone","consultant_general.email","consultant_general.city","consultant_general.state","REPLACE (GROUP_CONCAT( DISTINCT posdesc.postitle ORDER BY posdesc.postitle ), ',', '')","IF((consultant_list.avail='0-0-0' or consultant_list.avail='' or consultant_list.avail='immediate'),'Immediate',(IF((to_days(now())-to_days(CONCAT(SUBSTRING_INDEX(consultant_list.avail,'-',-1 ),'-',SUBSTRING_INDEX(consultant_list.avail,'-',2))))<0,consultant_list.avail,'Immediate')))","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","consultant_general.source","manage.name","consultant_personal.ssn","group_concat(distinct imstyp.status)","consultant_list.stime", "users.name", "consultant_list.mtime", "muser.name");
		}
				
		$tque="SELECT COUNT(DISTINCT(consultant_list.serial_no)) 
				FROM consultant_list FORCE INDEX(username,astatus)
				LEFT JOIN consultant_personal ON consultant_list.username=consultant_personal.username
				LEFT JOIN consultant_prof ON consultant_list.username=consultant_prof.username 
				LEFT JOIN users ON consultant_list.approveuser=users.username 
				LEFT JOIN users AS muser ON consultant_list.muser=muser.username
				".$added_leftJoin."
				LEFT JOIN consultant_appliedjobs ON consultant_list.serial_no=consultant_appliedjobs.consultant_id 
				LEFT JOIN posdesc ON consultant_appliedjobs.req_id = posdesc.posid 
				LEFT JOIN consultant_immig_status cii ON (consultant_list.username=cii.username)
				LEFT JOIN immigration_statustype imstyp ON (cii.status = imstyp.sno),consultant_general
				LEFT JOIN manage ON  manage.sno = consultant_general.sourcetype	
				WHERE consultant_list.username=consultant_general.username AND (consultant_list.astatus = '$appStatus' OR consultant_list.astatus = 'ER')"; 
		
		$oque = "SELECT consultant_list.serial_no,consultant_list.username,consultant_list.name,
				REPLACE(consultant_general.hphone,'---',''),consultant_general.city,consultant_general.state,
				consultant_personal.ssn, IF((consultant_list.avail='0-0-0' OR consultant_list.avail='' OR 
				consultant_list.avail='immediate'),'Immediate',
				(IF((to_days(NOW())-to_days(CONCAT(SUBSTRING_INDEX(consultant_list.avail,'-',-1 ),
				'-',SUBSTRING_INDEX(consultant_list.avail,'-',2))))<0,consultant_list.avail,'Immediate'))),
				consultant_list.stage,consultant_list.astatus,consultant_list.approveuser,consultant_list.A2M,
				consultant_list.adduser,consultant_list.useracc,GROUP_CONCAT(DISTINCT imstyp.status),
				IF(consultant_list.A2M = 'Y','CRM','Pipeline'),consultant_general.source,
				GROUP_CONCAT(consultant_appliedjobs.req_id),".tzRetQueryStringDTime("consultant_list.stime","DateTimeSec","/").",
				".tzRetQueryStringDTime("consultant_list.mtime","DateTimeSec","/").",users.name,muser.name, consultant_general.email, consultant_general.sourcetype,consultant_general.profiletitle".$added_col."
				FROM consultant_list FORCE INDEX(username,astatus)
				LEFT JOIN consultant_personal ON consultant_list.username=consultant_personal.username
				LEFT JOIN consultant_prof ON consultant_list.username=consultant_prof.username 
				LEFT JOIN users ON consultant_list.approveuser=users.username 
				LEFT JOIN users AS muser ON consultant_list.muser=muser.username
				".$added_leftJoin."
				LEFT JOIN consultant_appliedjobs ON consultant_list.serial_no=consultant_appliedjobs.consultant_id 
				LEFT JOIN posdesc ON consultant_appliedjobs.req_id = posdesc.posid 
				LEFT JOIN consultant_immig_status cii ON (consultant_list.username=cii.username)
				LEFT JOIN immigration_statustype imstyp ON (cii.status = imstyp.sno),consultant_general
				LEFT JOIN manage ON  manage.sno = consultant_general.sourcetype
				WHERE consultant_list.username=consultant_general.username AND (consultant_list.astatus = '$appStatus' OR consultant_list.astatus = 'ER')";
		
		$gstr=" GROUP BY consultant_list.serial_no ";
		
		$varCandType="";
		$qstr1 = "";
		
		if(APPLICANT_DISTRIBUTION_ENABLED == 'Y' && APPLICANT_DISTRIBUTION_HRMREF == 'Y' && APPLICANT_DISTRIBUTION_ADMINPREF == 'Y')
		{
			
			if($gridSearchFields[17]=="Approved")
			{
				$varCandType=" imstyp.status!='H1-B Approved' ";
			}

			if($gridSearchFields[12]=="all")
			{
				$gridSearchFields[12]="";
			}

			//this condition for status
			if($gridSearchFields[17]!="")
			{
				if($qstr1!="")
					$qstr1.= " AND group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[17]."%'";
				else
					$qstr1 = " having group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[17]."%'";

				$gridSearchFields[17] = "";
			}

			
			
		}else{

			if($gridSearchFields[12]=="Approved")
			{
				$varCandType=" imstyp.status!='H1-B Approved' ";
			}

			//this condition for status
			if($gridSearchFields[12]!="")
			{
				if($qstr1!="")
					$qstr1.= " AND group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[12]."%'";
				else
					$qstr1 = " having group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[12]."%'";

				$gridSearchFields[12] = "";
			}	
		}		
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		
		if($gridSearchFields[6]!="") //Condition for Applied To Column Search 
		{
			$jobSearchString=$gridSearchFields[6];

			$qstr1="HAVING  (GROUP_CONCAT( DISTINCT  CONCAT( posdesc.postitle,IF (posdesc.refcode <> ' ', concat( '(', posdesc.refcode, ')' ) , posdesc.refcode ))  ORDER BY  posdesc.postitle ) LIKE '%$jobSearchString%' )";
			$gridSearchFields[6]="";
		}
		
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('consultant_general.hphone',$asFields)){
			$asFieldsKey = array_search("consultant_general.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("consultant_general.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("consultant_general.hphone",$gridSearchFields,$asFieldsKey);
		}		
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		if($qstr!="" && $varCandType!="")
		{
			$qstr.=" AND ".$varCandType."";
		}
		else if($qstr=="" && $varCandType!="")
		{
			$qstr.=" AND (".$varCandType.")";
		}		
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		/*$tque=$gd->buildTQuery($tque,$qstr,$gstr);		
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);*/
		
		$tque=$gd->buildTQuery($tque,$qstr,$gstr.'  '.$qstr1);
		$oque="$oque $qstr $gstr $qstr1 $ostr $lstr";
		
		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		$gridData=$gd->buildApplicants($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	
	// Accounting Customers -- Modified By suryaprakash,vijaya
	function getCustomers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$acs="";//variable for passing access permissions
		$gd=new gridData();
		if(PAYROLL_PROCESS_BY=='QB')
		{
			$asFields=array("", "staffacc_cinfo.customerid", "staffacc_cinfo.cname",
					"CONCAT_WS(' - ',department.depcode,department.deptname)",
					"replace(trim(CONCAT_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)),'  ',' ')",
					"staffacc_contact.wphone", "staffacc_cinfo.city","staffacc_cinfo.state");
			
			$ssFields=array("", "staffacc_cinfo.customerid", "staffacc_cinfo.cname",
					"CONCAT_WS(' - ',department.depcode,department.deptname)",
					"replace(trim(CONCAT_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)),'  ',' ')",
					"staffacc_contact.wphone", "staffacc_cinfo.city","staffacc_cinfo.state");
					
			$tque="SELECT  count(*)
					FROM  staffacc_cinfo 				
					LEFT JOIN staffacc_contact ON staffacc_cinfo.bill_contact = staffacc_contact.sno
                    LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active' 
					LEFT JOIN department ON Client_Accounts.deptid=department.sno  ";
			
			 $oque="SELECT staffacc_cinfo.username, staffacc_cinfo.customerid, staffacc_cinfo.cname,
			 		CONCAT_WS(' - ',department.depcode,department.deptname) AS deptname,
					replace(trim(CONCAT_WS(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)),'  ',' ') AS BillingContactName,
					staffacc_contact.wphone AS BillingContactPhone ,staffacc_cinfo.city,staffacc_cinfo.state
					FROM  staffacc_cinfo 				
					LEFT JOIN staffacc_contact ON staffacc_cinfo.bill_contact = staffacc_contact.sno
					LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active' 
					LEFT JOIN department ON Client_Accounts.deptid=department.sno  ";				
		}
		else
		{

			$asFields=array("","staffacc_cinfo.customerid","staffacc_cinfo.cname",
			"CONCAT_WS(' - ',department.depcode,department.deptname)",
			"IF((IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)) - (IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) IS NULL,0,
			IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)-IF(b.Acc_Amount IS NULL,0,b.Acc_Amount))",
			
			"IF((IF(c.Inv_Amount IS NULL,0,c.Inv_Amount))-(IF(d.Acc_Amount IS NULL,0, d.Acc_Amount)) IS NULL,0,
				IF(c.Inv_Amount IS NULL,0,c.Inv_Amount)-IF(d.Acc_Amount IS NULL,0, d.Acc_Amount))",
				
			"IF((IF(e.Inv_Amount IS NULL,0,e.Inv_Amount))-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) IS NULL,0,
				IF(e.Inv_Amount IS NULL,0,e.Inv_Amount)-IF(f.Acc_Amount IS NULL,0,f.Acc_Amount))",
				
			"IF((IF(g.Inv_Amount IS NULL,0,g.Inv_Amount))-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) IS NULL,0,
				IF(g.Inv_Amount IS NULL,0,g.Inv_Amount)-IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) ",
				
			"IF((IF(i.Inv_Amount IS NULL,0,i.Inv_Amount))-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) IS NULL,0,
				IF(i.Inv_Amount IS NULL,0,i.Inv_Amount)-IF(j.Acc_Amount IS NULL,0,j.Acc_Amount))",
				
			"IF((IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)) - (IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) IS NULL,0,
			IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)-IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) + 				
			IF((IF(c.Inv_Amount IS NULL,0,c.Inv_Amount))-(IF(d.Acc_Amount IS NULL,0, d.Acc_Amount)) IS NULL,0,
			IF(c.Inv_Amount IS NULL,0,c.Inv_Amount)-IF(d.Acc_Amount IS NULL,0, d.Acc_Amount)) + 				
			IF((IF(e.Inv_Amount IS NULL,0,e.Inv_Amount))-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) IS NULL,0,
			IF(e.Inv_Amount IS NULL,0,e.Inv_Amount)-IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) +				
			IF((IF(g.Inv_Amount IS NULL,0,g.Inv_Amount))-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) IS NULL,0,
			IF(g.Inv_Amount IS NULL,0,g.Inv_Amount)-IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + 				
			IF((IF(i.Inv_Amount IS NULL,0,i.Inv_Amount))-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) IS NULL,0,
			IF(i.Inv_Amount IS NULL,0,i.Inv_Amount)-IF(j.Acc_Amount IS NULL,0,j.Acc_Amount))",
			"cusr.name","musr.name","staffacc_list.stime", "staffacc_cinfo.mdate");
			
			$ssFields=array("","staffacc_cinfo.customerid","staffacc_cinfo.cname",
			"CONCAT_WS(' - ',department.depcode,department.deptname)",
			"IF((IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)) - (IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) IS NULL,0,
			IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)-IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) + 				
			IF((IF(c.Inv_Amount IS NULL,0,c.Inv_Amount))-(IF(d.Acc_Amount IS NULL,0, d.Acc_Amount)) IS NULL,0,
			IF(c.Inv_Amount IS NULL,0,c.Inv_Amount)-IF(d.Acc_Amount IS NULL,0, d.Acc_Amount)) + 				
			IF((IF(e.Inv_Amount IS NULL,0,e.Inv_Amount))-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) IS NULL,0,
			IF(e.Inv_Amount IS NULL,0,e.Inv_Amount)-IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) +				
			IF((IF(g.Inv_Amount IS NULL,0,g.Inv_Amount))-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) IS NULL,0,
			IF(g.Inv_Amount IS NULL,0,g.Inv_Amount)-IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + 				
			IF((IF(i.Inv_Amount IS NULL,0,i.Inv_Amount))-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) IS NULL,0,
			IF(i.Inv_Amount IS NULL,0,i.Inv_Amount)-IF(j.Acc_Amount IS NULL,0,j.Acc_Amount))",
			"cusr.name","musr.name",tzRetQueryStringDTime('staffacc_list.stime','DateTime','/'),
			tzRetQueryStringDTime('staffacc_cinfo.mdate','DateTime','/'));
				
			$tque="SELECT 
					count(1)
				FROM  staffacc_cinfo 				
					LEFT JOIN staffacc_list ON staffacc_cinfo.username = staffacc_list.username 
					 
					LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2)  Inv_Amount
								FROM invoice LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS invSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'invoice' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.invSno = invoice.sno)
								WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes' 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0 
								GROUP BY invoice.client_id) a  ON(a.client_id=staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee 
								FROM bank_trans ,invoice 
								WHERE bank_trans.source =concat('inv',invoice.sno) 
								AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0 
								GROUP BY invoice.client_id )  b ON(b.payee = staffacc_cinfo.username)
									
					LEFT JOIN 
								(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`  
								FROM acc_reg, invoice  
								WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND  invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y')) <=0 GROUP BY invoice.client_id) k ON (k.cename = staffacc_cinfo.username) 
								
					LEFT JOIN  (SELECT cmt.used_amount,invoice.client_id
					    		 FROM invoice 
								INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
								INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
								AND invoice.deliver='yes' AND cm.credit_type = 'invoice'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0 
								GROUP BY invoice.client_id) used_amt_0   ON(used_amt_0.client_id = staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2)  Inv_Amount
								FROM invoice LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS invSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'invoice' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.invSno = invoice.sno)
								WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30 
								GROUP BY invoice.client_id) c  ON(c.client_id=staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee 
								FROM bank_trans ,invoice 
								WHERE bank_trans.source =concat('inv',invoice.sno) 
								AND bank_trans.type = 'PMT' AND invoice.deliver='yes' 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=1
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30 
								GROUP BY invoice.client_id )  d ON(d.payee = staffacc_cinfo.username)
					
					LEFT JOIN 
								(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`  
								FROM acc_reg, invoice  
								WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=1 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=30 GROUP BY invoice.client_id) l ON (l.cename = staffacc_cinfo.username) 
								
					LEFT JOIN  (SELECT cmt.used_amount,invoice.client_id
					    		 FROM invoice 
								INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
								INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
								AND invoice.deliver='yes' AND cm.credit_type = 'invoice'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30 
								GROUP BY invoice.client_id) used_amt_1_30   ON(used_amt_1_30.client_id = staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
								FROM invoice LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS invSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'invoice' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.invSno = invoice.sno)
								WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60 
								GROUP BY invoice.client_id) e  ON (e.client_id=staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee 
								FROM bank_trans ,invoice 
								WHERE bank_trans.source =concat('inv',invoice.sno) 
								AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=31 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60 
								GROUP BY invoice.client_id )  f ON (f.payee = staffacc_cinfo.username)
					LEFT JOIN 
								(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`  
								FROM acc_reg, invoice  
								WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=31 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=60 GROUP BY invoice.client_id) m ON (m.cename = staffacc_cinfo.username) 
								
					LEFT JOIN  (SELECT cmt.used_amount,invoice.client_id
					    		 FROM invoice 
								INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
								INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
								AND invoice.deliver='yes' AND cm.credit_type = 'invoice'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60 
								GROUP BY invoice.client_id) used_amt_31_60   ON(used_amt_31_60.client_id = staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2)  Inv_Amount
								FROM invoice LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS invSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'invoice' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.invSno = invoice.sno)
								WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes' 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90 
								GROUP BY invoice.client_id) g  on(g.client_id=staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee 
								FROM bank_trans ,invoice 						
								WHERE bank_trans.source =concat('inv',invoice.sno) 
								AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=61 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90 
								GROUP BY invoice.client_id ) h ON (h.payee = staffacc_cinfo.username)
					LEFT JOIN 
								(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`  
								FROM acc_reg, invoice  
								WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=61 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=90 GROUP BY invoice.client_id) n ON (n.cename = staffacc_cinfo.username) 
								
					LEFT JOIN  (SELECT cmt.used_amount,invoice.client_id
					    		 FROM invoice 
								INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
								INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
								AND invoice.deliver='yes' AND cm.credit_type = 'invoice'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90 
								GROUP BY invoice.client_id) used_amt_61_90   ON(used_amt_61_90.client_id = staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
								FROM invoice LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS invSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'invoice' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.invSno = invoice.sno)
								WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes' 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91 
								GROUP BY invoice.client_id) i  on(i.client_id=staffacc_cinfo.sno)
					
					LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee 
								FROM bank_trans ,invoice 
								WHERE bank_trans.source =concat('inv',invoice.sno) 
								AND bank_trans.type = 'PMT' AND invoice.deliver='yes' 
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=91 
								GROUP BY invoice.client_id ) j on(j.payee = staffacc_cinfo.username)
					LEFT JOIN 
								(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`  
								FROM acc_reg, invoice  
								WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=91 GROUP BY invoice.client_id) o ON (o.cename = staffacc_cinfo.username) 
								
					LEFT JOIN  (SELECT cmt.used_amount,invoice.client_id
					    		 FROM invoice 
								INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
								INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
								AND invoice.deliver='yes' AND cm.credit_type = 'invoice'
								AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91 
								GROUP BY invoice.client_id) used_amt_91   ON(used_amt_91.client_id = staffacc_cinfo.sno)
					
					LEFT JOIN users AS cusr ON staffacc_list.approveuser=cusr.username	
					LEFT JOIN users AS musr on staffacc_cinfo.muser=musr.username
					LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active' 
					LEFT JOIN department ON Client_Accounts.deptid=department.sno ";
			
			
			$oque="SELECT
staffacc_cinfo.username,
staffacc_cinfo.customerid,
staffacc_cinfo.cname,
CONCAT_WS(' - ',department.depcode,department.deptname) AS deptname,
IF((IF(a.Inv_Amount IS NULL,0,a.Inv_Amount))-(IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) + (IF(used_amt_0.used_amount IS NULL,0,used_amt_0.used_amount))-(IF(k.adj_amount IS NULL,0,k.adj_amount)) IS NULL,0, IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)-(IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) + (IF(used_amt_0.used_amount IS NULL,0,used_amt_0.used_amount))-IF(k.adj_amount IS NULL,0,k.adj_amount)) AS current,

IF((IF(c.Inv_Amount IS NULL,0,c.Inv_Amount))-(IF(d.Acc_Amount IS NULL,0,d.Acc_Amount)) + (IF(used_amt_1_30.used_amount IS NULL,0,used_amt_1_30.used_amount))-(IF(l.adj_amount IS NULL,0,l.adj_amount)) IS NULL,0, IF(c.Inv_Amount IS NULL,0,c.Inv_Amount)-(IF(d.Acc_Amount IS NULL,0,d.Acc_Amount) - IF(used_amt_1_30.used_amount IS NULL,0,used_amt_1_30.used_amount))-IF(l.adj_amount IS NULL,0,l.adj_amount)) AS '1-30',

IF((IF(e.Inv_Amount IS NULL,0,e.Inv_Amount))-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount))+ (IF(used_amt_31_60.used_amount IS NULL,0,used_amt_31_60.used_amount))-(IF(m.adj_amount IS NULL,0,m.adj_amount)) IS NULL,0, IF(e.Inv_Amount IS NULL,0,e.Inv_Amount)-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) + (IF(used_amt_31_60.used_amount IS NULL,0,used_amt_31_60.used_amount))-IF(m.adj_amount IS NULL,0,m.adj_amount)) AS '31-60',

IF((IF(g.Inv_Amount IS NULL,0,g.Inv_Amount))-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + (IF(used_amt_61_90.used_amount IS NULL,0,used_amt_61_90.used_amount) )-(IF(n.adj_amount IS NULL,0,n.adj_amount)) IS NULL,0, IF(g.Inv_Amount IS NULL,0,g.Inv_Amount)-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + (IF(used_amt_61_90.used_amount IS NULL,0,used_amt_61_90.used_amount))-IF(n.adj_amount IS NULL,0,n.adj_amount)) AS '61-90',

IF((IF(i.Inv_Amount IS NULL,0,i.Inv_Amount))-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) + (IF(used_amt_91.used_amount IS NULL,0,used_amt_91.used_amount))-(IF(o.adj_amount IS NULL,0,o.adj_amount)) IS NULL,0, IF(i.Inv_Amount IS NULL,0,i.Inv_Amount)-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) + (IF(used_amt_91.used_amount IS NULL,0,used_amt_91.used_amount))-IF(o.adj_amount IS NULL,0,o.adj_amount)) AS '>90',

IF((IF(a.Inv_Amount IS NULL,0,a.Inv_Amount))-(IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) +(IF(used_amt_0.used_amount IS NULL,0,used_amt_0.used_amount))- IF(avlcrdt_used_amt_0.avl_used_amount IS NULL,0,avlcrdt_used_amt_0.avl_used_amount)-(IF(k.adj_amount IS NULL,0,k.adj_amount)- IF(avl_used_amt_0.avl_credit_withinv IS NULL,0,avl_used_amt_0.avl_credit_withinv)- IF(avl_wtinv_used_amt_0.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_0.withoutcreditusedamt)) IS NULL,0, IF(a.Inv_Amount IS NULL,0,a.Inv_Amount)-(IF(b.Acc_Amount IS NULL,0,b.Acc_Amount)) + (IF(used_amt_0.used_amount IS NULL,0,used_amt_0.used_amount))- IF(avlcrdt_used_amt_0.avl_used_amount IS NULL,0,avlcrdt_used_amt_0.avl_used_amount)-IF(k.adj_amount IS NULL,0,k.adj_amount)- IF(avl_used_amt_0.avl_credit_withinv IS NULL,0,avl_used_amt_0.avl_credit_withinv)- IF(avl_wtinv_used_amt_0.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_0.withoutcreditusedamt)) +

IF((IF(c.Inv_Amount IS NULL,0,c.Inv_Amount))-(IF(d.Acc_Amount IS NULL,0,d.Acc_Amount)) + (IF(used_amt_1_30.used_amount IS NULL,0,used_amt_1_30.used_amount))- IF(avlcrdt_used_amt_1_30.avl_used_amount IS NULL,0,avlcrdt_used_amt_1_30.avl_used_amount)-(IF(l.adj_amount IS NULL,0,l.adj_amount)- IF(avl_used_amt_1_30.avl_credit_withinv IS NULL,0,avl_used_amt_1_30.avl_credit_withinv)- IF(avl_wtinv_used_amt_1_30.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_1_30.withoutcreditusedamt)) IS NULL,0, IF(c.Inv_Amount IS NULL,0,c.Inv_Amount)-(IF(d.Acc_Amount IS NULL,0,d.Acc_Amount)) + (IF(used_amt_1_30.used_amount IS NULL,0,used_amt_1_30.used_amount))- IF(avlcrdt_used_amt_1_30.avl_used_amount IS NULL,0,avlcrdt_used_amt_1_30.avl_used_amount)-IF(l.adj_amount IS NULL,0,l.adj_amount)- IF(avl_used_amt_1_30.avl_credit_withinv IS NULL,0,avl_used_amt_1_30.avl_credit_withinv)- IF(avl_wtinv_used_amt_1_30.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_1_30.withoutcreditusedamt)) +

IF((IF(e.Inv_Amount IS NULL,0,e.Inv_Amount))-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount))+ (IF(used_amt_31_60.used_amount IS NULL,0,used_amt_31_60.used_amount))- IF(avlcrdt_used_amt_31_60.avl_used_amount IS NULL,0,avlcrdt_used_amt_31_60.avl_used_amount)-(IF(m.adj_amount IS NULL,0,m.adj_amount)- IF(avl_used_amt_31_60.avl_credit_withinv IS NULL,0,avl_used_amt_31_60.avl_credit_withinv)- IF(avl_wtinv_used_amt_31_60.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_31_60.withoutcreditusedamt)) IS NULL,0, IF(e.Inv_Amount IS NULL,0,e.Inv_Amount)-(IF(f.Acc_Amount IS NULL,0,f.Acc_Amount)) + (IF(used_amt_31_60.used_amount IS NULL,0,used_amt_31_60.used_amount))- IF(avlcrdt_used_amt_31_60.avl_used_amount IS NULL,0,avlcrdt_used_amt_31_60.avl_used_amount)-IF(m.adj_amount IS NULL,0,m.adj_amount)- IF(avl_used_amt_31_60.avl_credit_withinv IS NULL,0,avl_used_amt_31_60.avl_credit_withinv)- IF(avl_wtinv_used_amt_31_60.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_31_60.withoutcreditusedamt)) +

IF((IF(g.Inv_Amount IS NULL,0,g.Inv_Amount))-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + (IF(used_amt_61_90.used_amount IS NULL,0,used_amt_61_90.used_amount))- IF(avlcrdt_used_amt_61_90.avl_used_amount IS NULL,0,avlcrdt_used_amt_61_90.avl_used_amount)-(IF(n.adj_amount IS NULL,0,n.adj_amount)- IF(avl_used_amt_61_90.avl_credit_withinv IS NULL,0,avl_used_amt_61_90.avl_credit_withinv)- IF(avl_wtinv_used_amt_61_90.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_61_90.withoutcreditusedamt)) IS NULL,0, IF(g.Inv_Amount IS NULL,0,g.Inv_Amount)-(IF(h.Acc_Amount IS NULL,0,h.Acc_Amount)) + (IF(used_amt_61_90.used_amount IS NULL,0,used_amt_61_90.used_amount))- IF(avlcrdt_used_amt_61_90.avl_used_amount IS NULL,0,avlcrdt_used_amt_61_90.avl_used_amount)-IF(n.adj_amount IS NULL,0,n.adj_amount)- IF(avl_used_amt_61_90.avl_credit_withinv IS NULL,0,avl_used_amt_61_90.avl_credit_withinv)- IF(avl_wtinv_used_amt_61_90.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_61_90.withoutcreditusedamt)) +

IF((IF(i.Inv_Amount IS NULL,0,i.Inv_Amount))-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) + (IF(used_amt_91.used_amount IS NULL,0,used_amt_91.used_amount))- IF(avlcrdt_used_amt_91.avl_used_amount IS NULL,0,avlcrdt_used_amt_91.avl_used_amount)-(IF(o.adj_amount IS NULL,0,o.adj_amount)- IF(avl_used_amt_91.avl_credit_withinv IS NULL,0,avl_used_amt_91.avl_credit_withinv)- IF(avl_wtinv_used_amt_91.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_91.withoutcreditusedamt)) IS NULL,0, IF(i.Inv_Amount IS NULL,0,i.Inv_Amount)-(IF(j.Acc_Amount IS NULL,0,j.Acc_Amount)) + (IF(used_amt_91.used_amount IS NULL,0,used_amt_91.used_amount))- IF(avlcrdt_used_amt_91.avl_used_amount IS NULL,0,avlcrdt_used_amt_91.avl_used_amount)-IF(o.adj_amount IS NULL,0,o.adj_amount)- IF(avl_used_amt_91.avl_credit_withinv IS NULL,0,avl_used_amt_91.avl_credit_withinv)- IF(avl_wtinv_used_amt_91.withoutcreditusedamt IS NULL,0,avl_wtinv_used_amt_91.withoutcreditusedamt)) AS tot,

cusr.name AS `owner`,
musr.name AS muser,
DATE_FORMAT(CONVERT_TZ(staffacc_list.stime,'SYSTEM','EST5EDT'),'%m/%d/%Y %h:%i %p'),
DATE_FORMAT(CONVERT_TZ(staffacc_cinfo.mdate,'SYSTEM','EST5EDT'),'%m/%d/%Y %h:%i %p')
FROM staffacc_cinfo
LEFT JOIN staffacc_list ON staffacc_cinfo.username = staffacc_list.username

LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
FROM invoice
WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0
GROUP BY invoice.client_id) a ON(a.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee
FROM bank_trans ,invoice
WHERE bank_trans.source =concat('inv',invoice.sno)
AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0
GROUP BY invoice.client_id ) b ON(b.payee = staffacc_cinfo.username)


LEFT JOIN (SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`
FROM acc_reg, invoice
WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y')) <=0 GROUP BY invoice.client_id) k ON (k.cename = staffacc_cinfo.username)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes !='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0
GROUP BY invoice.client_id) used_amt_0 ON(used_amt_0.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'avl_used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
LEFT JOIN acc_reg ON (acc_reg.`inv_bill_lineid` = cm.credit_inv_bill_id AND acc_reg.`type`='PMT-ADJ')
LEFT JOIN reg_category reg ON (reg.sno=acc_reg.cate_id and reg.status='ER')
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes ='Available Credits' AND acc_reg.`inv_bill_lineid` != cmt.inv_bill_sno AND reg.name!='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0
GROUP BY invoice.client_id) avlcrdt_used_amt_0 ON(avlcrdt_used_amt_0.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'avl_credit_withinv',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id AND cm.credit_notes='Available Credits')
Where invoice.deliver='yes' AND cm.credit_inv_bill_id!=0
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) <=0
GROUP BY invoice.client_id) avl_used_amt_0 ON(avl_used_amt_0.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'withoutcreditusedamt',cm.credit_source
FROM credit_memo as cm
Where cm.credit_inv_bill_id=0 AND cm.credit_notes='Available Credits'
AND DATEDIFF(curdate(),cm.credit_cdate) <=0
GROUP BY cm.credit_source) avl_wtinv_used_amt_0 ON(avl_wtinv_used_amt_0.credit_source = staffacc_cinfo.sno)

LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
FROM invoice
WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30
GROUP BY invoice.client_id) c ON(c.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee
FROM bank_trans ,invoice
WHERE bank_trans.source =concat('inv',invoice.sno)
AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=1
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30
GROUP BY invoice.client_id ) d ON(d.payee = staffacc_cinfo.username)

LEFT JOIN (SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`
FROM acc_reg, invoice
WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=1 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=30 GROUP BY invoice.client_id) l ON (l.cename = staffacc_cinfo.username)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
WHERE invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes !='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30
GROUP BY invoice.client_id) used_amt_1_30 ON(used_amt_1_30.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'avl_used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
LEFT JOIN acc_reg ON (acc_reg.`inv_bill_lineid` = cm.credit_inv_bill_id AND acc_reg.`type`='PMT-ADJ')
LEFT JOIN reg_category reg ON (reg.sno=acc_reg.cate_id and reg.status='ER')
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes ='Available Credits' AND acc_reg.`inv_bill_lineid` != cmt.inv_bill_sno AND reg.name!='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30
GROUP BY invoice.client_id) avlcrdt_used_amt_1_30 ON(avlcrdt_used_amt_1_30.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'avl_credit_withinv',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id AND cm.credit_notes='Available Credits')
Where invoice.deliver='yes' AND cm.credit_inv_bill_id!=0
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=1
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=30
GROUP BY invoice.client_id) avl_used_amt_1_30 ON(avl_used_amt_1_30.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'withoutcreditusedamt',cm.credit_source
FROM credit_memo as cm
Where cm.credit_inv_bill_id=0 AND cm.credit_notes='Available Credits'
AND DATEDIFF(curdate(),cm.credit_cdate) >=1
AND DATEDIFF(curdate(),cm.credit_cdate)<=30
GROUP BY cm.credit_source) avl_wtinv_used_amt_1_30 ON(avl_wtinv_used_amt_1_30.credit_source = staffacc_cinfo.sno)

LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
FROM invoice
WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60
GROUP BY invoice.client_id) e ON (e.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee
FROM bank_trans ,invoice
WHERE bank_trans.source =concat('inv',invoice.sno)
AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=31
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60
GROUP BY invoice.client_id ) f ON (f.payee = staffacc_cinfo.username)

LEFT JOIN (SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`
FROM acc_reg, invoice
WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=31 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=60 GROUP BY invoice.client_id) m ON (m.cename = staffacc_cinfo.username)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
WHERE invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes !='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60
GROUP BY invoice.client_id) used_amt_31_60 ON(used_amt_31_60.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'avl_used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
LEFT JOIN acc_reg ON (acc_reg.`inv_bill_lineid` = cm.credit_inv_bill_id AND acc_reg.`type`='PMT-ADJ')
LEFT JOIN reg_category reg ON (reg.sno=acc_reg.cate_id and reg.status='ER')
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes ='Available Credits' AND acc_reg.`inv_bill_lineid` != cmt.inv_bill_sno AND reg.name!='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60
GROUP BY invoice.client_id) avlcrdt_used_amt_31_60 ON(avlcrdt_used_amt_31_60.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'avl_credit_withinv',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id AND cm.credit_notes='Available Credits')
Where invoice.deliver='yes' AND cm.credit_inv_bill_id!=0
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=31
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=60
GROUP BY invoice.client_id) avl_used_amt_31_60 ON(avl_used_amt_31_60.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'withoutcreditusedamt',cm.credit_source
FROM credit_memo as cm
Where cm.credit_inv_bill_id=0 AND cm.credit_notes='Available Credits'
AND DATEDIFF(curdate(),cm.credit_cdate) >=31
AND DATEDIFF(curdate(),cm.credit_cdate)<=60
GROUP BY cm.credit_source) avl_wtinv_used_amt_31_60 ON(avl_wtinv_used_amt_31_60.credit_source = staffacc_cinfo.sno)

LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
FROM invoice
WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90
GROUP BY invoice.client_id) g on(g.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee
FROM bank_trans ,invoice
WHERE bank_trans.source =concat('inv',invoice.sno)
AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=61
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90
GROUP BY invoice.client_id ) h ON (h.payee = staffacc_cinfo.username)
LEFT JOIN
(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`
FROM acc_reg, invoice
WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=61 AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))<=90 GROUP BY invoice.client_id) n ON (n.cename = staffacc_cinfo.username)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
WHERE invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes !='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90
GROUP BY invoice.client_id) used_amt_61_90 ON(used_amt_61_90.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'avl_used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
LEFT JOIN acc_reg ON (acc_reg.`inv_bill_lineid` = cm.credit_inv_bill_id AND acc_reg.`type`='PMT-ADJ')
LEFT JOIN reg_category reg ON (reg.sno=acc_reg.cate_id and reg.status='ER')
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes ='Available Credits' AND acc_reg.`inv_bill_lineid` != cmt.inv_bill_sno AND reg.name!='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90
GROUP BY invoice.client_id) avlcrdt_used_amt_61_90 ON(avlcrdt_used_amt_61_90.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'avl_credit_withinv',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id AND cm.credit_notes='Available Credits')
Where invoice.deliver='yes' AND cm.credit_inv_bill_id!=0
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=61
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))<=90
GROUP BY invoice.client_id) avl_used_amt_61_90 ON(avl_used_amt_61_90.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'withoutcreditusedamt',cm.credit_source
FROM credit_memo as cm
Where cm.credit_inv_bill_id=0 AND cm.credit_notes='Available Credits'
AND DATEDIFF(curdate(),cm.credit_cdate) >=61
AND DATEDIFF(curdate(),cm.credit_cdate)<=90
GROUP BY cm.credit_source) avl_wtinv_used_amt_61_90 ON(avl_wtinv_used_amt_61_90.credit_source = staffacc_cinfo.sno)

LEFT JOIN (SELECT invoice.client_id, round(SUM(invoice.total),2) Inv_Amount
FROM invoice
WHERE invoice.status = 'ACTIVE' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91
GROUP BY invoice.client_id) i on(i.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT (round(SUM(bank_trans.amount),2) ) Acc_Amount,bank_trans.payee
FROM bank_trans ,invoice
WHERE bank_trans.source =concat('inv',invoice.sno)
AND bank_trans.type = 'PMT' AND invoice.deliver='yes'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y'))>=91
GROUP BY invoice.client_id ) j on(j.payee = staffacc_cinfo.username)
LEFT JOIN
(SELECT SUM(acc_reg.amount) AS adj_amount, acc_reg.inv_bill_lineid, acc_reg.`cename`
FROM acc_reg, invoice
WHERE acc_reg.`inv_bill_lineid` = invoice.sno AND invoice.status = 'ACTIVE' AND acc_reg.`type`='PMT-ADJ' AND invoice.deliver='yes' AND DATEDIFF(CURDATE(),STR_TO_DATE(invoice.due_date,'%m/%d/%Y'))>=91 GROUP BY invoice.client_id) o ON (o.cename = staffacc_cinfo.username)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
WHERE invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes !='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91
GROUP BY invoice.client_id) used_amt_91 ON(used_amt_91.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT round(SUM(cmt.used_amount),2) as 'avl_used_amount',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id)
INNER JOIN credit_memo_trans as cmt ON(cmt.credit_memo_sno = cm.credit_id)
LEFT JOIN acc_reg ON (acc_reg.`inv_bill_lineid` = cm.credit_inv_bill_id AND acc_reg.`type`='PMT-ADJ')
LEFT JOIN reg_category reg ON (reg.sno=acc_reg.cate_id and reg.status='ER')
Where invoice.deliver='yes' AND cm.credit_type = 'invoice' AND cm.credit_notes ='Available Credits' AND acc_reg.`inv_bill_lineid` != cmt.inv_bill_sno AND reg.name!='Available Credits'
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91
GROUP BY invoice.client_id) avlcrdt_used_amt_91 ON(avlcrdt_used_amt_91.client_id=staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'avl_credit_withinv',invoice.client_id
FROM invoice
INNER JOIN credit_memo as cm ON(invoice.sno = cm.credit_inv_bill_id AND cm.credit_notes='Available Credits')
Where invoice.deliver='yes' AND cm.credit_inv_bill_id!=0
AND DATEDIFF(curdate(),str_to_date(invoice.due_date,'%m/%d/%Y')) >=91
GROUP BY invoice.client_id) avl_used_amt_91 ON(avl_used_amt_91.client_id = staffacc_cinfo.sno)

LEFT JOIN (SELECT IF(SUM(cm.credit_amount) > 0, round(SUM(cm.credit_amount),2), round(SUM(cm.credit_amount),2)) AS 'withoutcreditusedamt',cm.credit_source
FROM credit_memo as cm
Where cm.credit_inv_bill_id=0 AND cm.credit_notes='Available Credits'
AND DATEDIFF(curdate(),cm.credit_cdate) >=91
GROUP BY cm.credit_source) avl_wtinv_used_amt_91 ON(avl_wtinv_used_amt_91.credit_source = staffacc_cinfo.sno)

LEFT JOIN users AS cusr ON staffacc_list.approveuser=cusr.username
LEFT JOIN users AS musr on staffacc_cinfo.muser=musr.username
LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active'
LEFT JOIN department ON Client_Accounts.deptid=department.sno";
		}			
				
		$gstr = "";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		
		//if($qstr!="")
			$oque.=" where 1=1 AND staffacc_cinfo.type IN ('CUST','BOTH') AND Client_Accounts.clienttype IN ('CUST','BOTH')" ;
			$tque.=" where 1=1 AND staffacc_cinfo.type IN ('CUST','BOTH') AND Client_Accounts.clienttype IN ('CUST','BOTH')";
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCustomers($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
		return $objResponse;
	}
	
	function buildCustomers($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		$decimalPref    = getDecimalPreference();

        while ($row=mysql_fetch_array($res))
		{
			if(PAYROLL_PROCESS_BY=='QB')
			{
				$grid[$j][0]="";
				$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));//Customer Name
				$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));//Customer ID
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[3]));//Department Name
				$grid[$j][4]=$this->convertSpecChars(stripslashes($row[4]));//Billing Contact Name
				$grid[$j][5]=$this->convertSpecChars($row[5]);//Billing Contact Phone
				$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));//City
				$grid[$j][7]=$this->convertSpecChars(stripslashes($row[7]));//State
				$grid[$j][8]="";//Reset Column
				$grid[$j][9]=$row[0];//Hidden Value
				$j++;
			}
			else
			{
				$grid[$j][0]="";
				$grid[$j][1]=$this->convertSpecChars($row[1]);
				$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[3]));
				$grid[$j][4]="<a href=\"javascript:doCL('".$row[0]."','0','0')\">".number_format($row[4],$decimalPref,'.','')."</a>";
				$grid[$j][5]="<a href=\"javascript:doCL('".$row[0]."','1','30')\">".number_format($row[5],$decimalPref,'.','')."</a>";
				$grid[$j][6]="<a href=\"javascript:doCL('".$row[0]."','31','60')\">".number_format($row[6],$decimalPref,'.','')."</a>";
				$grid[$j][7]="<a href=\"javascript:doCL('".$row[0]."','61','90')\">".number_format($row[7],$decimalPref,'.','')."</a>";
				$grid[$j][8]="<a href=\"javascript:doCL('".$row[0]."','90','')\">".number_format($row[8],$decimalPref,'.','')."</a>";
				$grid[$j][9]="<a href=\"javascript:doCL('".$row[0]."','-1','-1')\">".number_format($row[9],$decimalPref,'.','')."</a>";  //$this->convertSpecChars($row[9]);
				$grid[$j][10]=$this->convertSpecChars(stripslashes($row[10]));
				$grid[$j][11]=$this->convertSpecChars(stripslashes($row[11]));
				if($row[12]=="00/00/0000")
				{
					$grid[$j][12]="";
				}
				else
				{
					$grid[$j][12]=$this->convertSpecChars($row[12]);
				}
				if($row[13]=="00/00/0000")
				{
					$grid[$j][13]="";
				}
				else
				{
					$grid[$j][13]=$this->convertSpecChars($row[13]);
				}
				$grid[$j][14]="";
				$grid[$j][15]=$row[0];
				$j++;
			}	
		}
        return $grid;
	}
	
	// HRM Overseas Recruitment Main and Archive Grid -- Get Function
	// adding 4 created date modified date,created by ,modifided by using time Zone functinality also
	//just applied time zone function to date coloumns...-prasadd(19/09/2008)
	function getOverseasRecGrid($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$OverseasMain,$user_timezone;
		$gd=new gridData();

        $asFields=array("","trim(REPLACE(list.name,'  ',' '))","cstg.stage","REPLACE(CONCAT_WS(' ',ref.fname,ref.mname,ref.lname),'  ',' ')","group_concat(distinct imty.stage)","group_concat(distinct imstyp.status)",tzRetQueryStringSelBoxDate('cii.date','Date','/'),"appuser.name", "muser.name",tzRetQueryStringDTime('stime','DateTime','/'),tzRetQueryStringDTime('mtime','DateTime','/'));
        $ssFields=array("","trim(REPLACE(list.name,'  ',' '))","cstg.stage","REPLACE(CONCAT_WS(' ',ref.fname,ref.mname,ref.lname),'  ',' ')","group_concat(distinct imty.stage)","group_concat(distinct imstyp.status)","cii.date","appuser.name", "muser.name","list.stime","list.mtime");


		if($OverseasMain == "MainGrid")
			$gridstatus = " ('RNew','RAccount','RER')";
		else
		 	$gridstatus = " ('RARCH')";

        $tque1 = "select count(1) from (select list.serial_no,list.username,list.name,list.stage,cstg.stage st,CONCAT_WS(' ',ref.fname,ref.mname,ref.lname),group_concat(distinct imty.stage),imm.sno,group_concat(distinct imstyp.status),cii.date from consultant_list list left join users appuser on(list.approveuser=appuser.username) left join users muser on(list.muser=muser.username) left join consultant_refby ref on(list.username=ref.username) left join immigration_data imm on (imm.username=list.username) left join immigration_type imty on (imty.stage_id= imm.apptype) left join consultant_immig_status cii on (cii.username=list.username) left join immigration_statustype imstyp on (cii.status = imstyp.sno) left join conleads_stage cstg on cstg.stage_id=list.stage where astatus in ".$gridstatus;

        $oque1 = " select list.serial_no,list.username,list.name,list.stage,cstg.stage st,CONCAT_WS(' ',ref.fname,ref.mname,ref.lname),group_concat(distinct imty.stage),imm.sno,group_concat(distinct imstyp.status),".tzRetQueryStringSelBoxDate('cii.date','Date','/').",appuser.name,muser.name ,".tzRetQueryStringDTime('stime','DateTime','/')." ,
        ".tzRetQueryStringDTime('mtime','DateTime','/')." from consultant_list list left join users appuser on(list.approveuser=appuser.username)
        left join users muser on(list.muser=muser.username) left join consultant_refby ref on(list.username=ref.username) left join immigration_data imm on (imm.username=list.username) left join immigration_type imty on (imty.stage_id= imm.apptype)  left join consultant_immig_status cii on (cii.username=list.username)
        left join immigration_statustype imstyp on (cii.status = imstyp.sno) left join conleads_stage cstg on cstg.stage_id=list.stage where astatus in ".$gridstatus;
		
			$tque2 = " ) cnt";
			$oque2 = "order by TRIM(name)";
			$varCandType="";
            $groupBy = " group by list.serial_no";
            $havingCond = "";
            if($gridSearchFields[4]=="Approved")
			{
				$varCandType=" imstyp.status!='H1-B Approved' ";
			}
			//this condition for application type...-prasadd(19/09/2008)
			if($gridSearchFields[3]!="")
			{
				$havingCond = " having group_concat(distinct imty.stage) LIKE '%".$gridSearchFields[3]."%'";
				$gridSearchFields[3] = "";
			}
			//this condition for status...-prasadd(19/09/2008)
			if($gridSearchFields[4]!="")
			{
                if($havingCond!="")
                    $havingCond.= " AND group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[4]."%'";
                else
                    $havingCond = " having group_concat(distinct imstyp.status) LIKE '%".$gridSearchFields[4]."%'";
				$gridSearchFields[4] = "";
			}
            $lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
	
			if($qstr!="" && $varCandType!="")
			{
				$qstr.=" AND ".$varCandType."";
			}
			else if($qstr=="" && $varCandType!="")
			{
				$qstr.=" AND (".$varCandType.")";
			}

            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields) ; // Order by fields, append the where clause accordingly
			$ostr = ($ostr == '')? $oque2 : $ostr;
			$totstr = " $groupBy $havingCond $tque2";
			$tque=$gd->buildTQuery($tque1,$qstr,$totstr); 
			$oque="$oque1 $qstr $groupBy $havingCond $ostr $lstr";
            $total=$gd->getTotalRows($tque);
			$gridData=$gd->buildOverseasRecGrid($oque); 
		   
			$objResponse = new xajaxResponse();
			$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
	
			return $objResponse;
	}

	// HRM Overseas Recruitment Main and Archive Grid ,Build function
	function buildOverseasRecGrid($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($drow=mysql_fetch_array($res))
		{
            if($drow[12]=="00/00/0000")//change to null if date is not there-prasadd
                $drow[12]="";
            if($drow[13]=="00/00/0000")
                $drow[13]="";
                
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=".$drow[1]."><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($drow[2]);
			$grid[$j][2]=$this->convertSpecChars($drow[4]);
			$grid[$j][3]=$this->convertSpecChars($drow[5]);
			$grid[$j][4]=$this->convertSpecChars($drow[6]);
			$grid[$j][5]=$this->convertSpecChars($drow[8]);
			$grid[$j][6]=$this->convertSpecChars($drow[9]);
			//added by deeapk
			$grid[$j][7]=$this->convertSpecChars($drow[10]);
			$grid[$j][8]=$this->convertSpecChars($drow[11]);
			$grid[$j][9]=$this->convertSpecChars($drow[12]);
            $grid[$j][10]=$this->convertSpecChars($drow[13]);


			$grid[$j][11]="";
			$grid[$j][12]=$drow[1];

			$j++;

		}

		return $grid;

	}

	// HRM EmployeeManagement -- Modified By Suryaprakash
	/*--prasadd-moved hrcon_jobs_ustatus term from where condition to left join itself and $department_dynStr added...--*/
	function  getEmployeeManagement($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$accountingpref,$ac_aced; 

		if($gridSortCol=="")
			$gridSortCol=1;

		$acs=""; //variable for passing access permissions
		$gd=new gridData();

	    	if(ACA_USER_ACCESS=='Y')
	    	{
				$asFields=array("","e.emp_fname","e.emp_lname","e.sno","e.emp_ssn_hash","e.primary_phone","e.email","e.emp_jtype","e.emp_tax","empterminated","CONCAT_WS(' - ',department.depcode,department.deptname)","e.ds_pobstatus","e.pob_i9_status","e.everify_case_status","e.wotc_mja_status","pc.caregiver_id","so.email","veas.eskill_email","IF(aed.sno!='','Yes','No')","own.name","e.stime","musr.name","e.mtime");

				$ssFields=array("","e.emp_fname","e.emp_lname","e.sno","e.emp_ssn_hash","e.primary_phone","e.email","e.emp_jtype","e.emp_tax","empterminated","CONCAT_WS(' - ',department.depcode,department.deptname)","e.ds_pobstatus","e.pob_i9_status","e.everify_case_status","e.wotc_mja_status","pc.caregiver_id","so.email","veas.eskill_email","IF(aed.sno!='','Yes','No')","own.name","DATE_FORMAT(CONVERT_TZ(e.stime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')","musr.name","DATE_FORMAT(CONVERT_TZ(e.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')");	
			}
			else
			{

				$asFields=array("","e.emp_fname","e.emp_lname","e.sno","e.emp_ssn_hash","e.primary_phone","e.email","e.emp_jtype","e.emp_tax","empterminated","CONCAT_WS(' - ',department.depcode,department.deptname)","e.ds_pobstatus","e.pob_i9_status","e.everify_case_status","e.wotc_mja_status","pc.caregiver_id","so.email","veas.eskill_email","own.name","e.stime","musr.name","e.mtime");

				$ssFields=array("","e.emp_fname","e.emp_lname","e.sno","e.emp_ssn_hash","e.primary_phone","e.email","jtype","e.emp_tax","empterminated","CONCAT_WS(' - ',department.depcode,department.deptname)","e.ds_pobstatus","e.pob_i9_status","e.everify_case_status","e.wotc_mja_status","pc.caregiver_id","so.email","veas.eskill_email","own.name","DATE_FORMAT(CONVERT_TZ(e.stime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')","musr.name","DATE_FORMAT(CONVERT_TZ(e.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')");
			}
	    	
			$department_dynStr = " AND FIND_IN_SET('".$username."',department.permission)>0 ";

			if($gridSearchFields[3]!="")
			$gridSearchFields[3]= $ac_aced->hash_data($gridSearchFields[3],$ac_aced->hash_salt);


			$tque = "select count(distinct(e.sno)) from emp_list e
					LEFT JOIN department ON e.emp_department=department.sno
					LEFT JOIN users own on e.approveuser=own.username
					LEFT JOIN users musr on e.muser=musr.username
					LEFT JOIN prophecy_caregivers pc ON pc.email=e.email
					LEFT JOIN sterling_orders so ON so.email=e.email
					LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = e.email
					LEFT JOIN aca_emp_data aed ON aed.emp_sno=e.sno
					WHERE e.lstatus not in ('DA','INACTIVE')".$department_dynStr;

			$oque = "select distinct e.sno,e.emp_fname,e.emp_lname,'' sk_nm,e.primary_phone,e.email,IF(e.emp_jtype='OB','On Bench',IF(e.emp_jtype='OP','On Assignment','')) jtype,e.emp_tax,e.emp_jtype j_type,(select type from users where username=e.username) typ_usr,IF(e.empterminated='N','Active','Terminated') as empterminated,CONCAT_WS(' - ',department.depcode,department.deptname) AS deptname,
			 DATE_FORMAT(CONVERT_TZ(e.stime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),own.name approveuser,DATE_FORMAT(CONVERT_TZ(e.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),musr.name muser,UNIX_TIMESTAMP(DATE_FORMAT(e.tdate,'%Y-%m-%d')) tdate, e.emp_ssn,e.ds_pobstatus, IF(e.email = '', IF(e.alternate_email = '', IF(e.other_email = '', e.name, ''), ''), '') as email_flag_name,
			IF(e.email = '', IF(e.alternate_email = '', e.other_email, e.alternate_email), e.email) as emp_email_id, e.ds_pobstatus, e.wotc_mja_status,pc.caregiver_id,so.email,veas.email AS eskill_email,IF(aed.sno!='','Yes','No') as aed_flag,e.everify_case_status,e.ds_i9_status FROM emp_list e
			LEFT JOIN department ON e.emp_department=department.sno
			LEFT JOIN users own on e.approveuser=own.username
			LEFT JOIN users musr on e.muser=musr.username
			LEFT JOIN prophecy_caregivers pc ON pc.email=e.email
			LEFT JOIN sterling_orders so ON so.email=e.email
			LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = e.email
			LEFT JOIN aca_emp_data aed ON aed.emp_sno=e.sno
			WHERE e.lstatus not in ('DA','INACTIVE')".$department_dynStr;

        	$gstr = "";
        // Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('e.primary_phone',$ssFields)){
			$asFieldsKey = array_search("e.primary_phone", $ssFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("e.primary_phone",$asFieldsKey);
			$ssFields[$asFieldsKey] = $asFields[$asFieldsKey];
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("e.primary_phone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildEmployeeManagement($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildEmployeeManagement($que)
	{
		global $maildb,$db,$stat,$ac_aced;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
			if($row[4] == "-" || $row[4] == "--" || $row[4] == "---")
				$row[4] = "";
			else
				$row[4] = $row[4];
			
			$emp_send = "";
				$emp_send = $row[1]." ".$row[2]."^".$row[18];
	
				if($row[10]=="Terminated")
				{
					if($row[16]<=time())
						$employee_cur_status = $this->convertSpecChars($row[10]);
					else
						$employee_cur_status = $this->convertSpecChars("Active");
				}
				else
				{
					$employee_cur_status = $this->convertSpecChars($row[10]);
				}
				
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=\"$row[0]\"><span class='checkmark'></span></label><input type='hidden' id='email_flag_name_".$row[0]."' name='email_flag_name[]' value='".$this->convertSpecChars($row[19])."'><input type='hidden' id='employee_email_".$row[0]."' name='employee_email[]' value='".$this->convertSpecChars($row[20])."'><input type='hidden' id='employee_ds_pob_".$row[0]."' name='employee_ds_pob[]' value='".$this->convertSpecChars($emp_send)."'><input type='hidden' id='employee_cur_status_".$row[0]."' name='employee_cur_status[]' value='".$employee_cur_status."'>";
				$grid[$j][1]=$this->convertSpecChars($row[1]);
				$grid[$j][2]=$this->convertSpecChars($row[2]);
				$grid[$j][3]=$this->convertSpecChars($row[0]);
				$grid[$j][4]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[17])));
				$grid[$j][5]=$this->convertSpecChars($row[4]);
				$grid[$j][6]=$this->convertSpecChars($row[5]);
				$grid[$j][7]=$this->convertSpecChars($row[6]);
				$grid[$j][8]=$this->convertSpecChars($row[7]);

				if($row[10]=="Terminated")
				{
					if($row[16]<=time())
						$grid[$j][9]=$this->convertSpecChars($row[10]);
					else
						$grid[$j][9]=$this->convertSpecChars("Active");
				}
				else
				{
					$grid[$j][9]=$this->convertSpecChars($row[10]);
				}

				$grid[$j][10]=$this->convertSpecChars($row[11]);
				//$grid[$j][11]=$this->convertSpecChars($row[17]);
				$grid[$j][11]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','empmngmt')>".ucwords($this->convertSpecChars($row[21]))."</a>";
				$grid[$j][12]=$row[28];
				$grid[$j][13]=$row[27];
				$grid[$j][14]=ucfirst($this->convertSpecChars($row[22]));	//WOTC MJA Status
				$prophecy_viewLink='';
				if($row[23] !=''){
					$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row[23]."','hrmEmployeeMngmt')>View</a>";
				}
				$sterling_viewLink='';
				if($row[24] !=''){
					$sterling_viewLink = "<a href=javascript:viewSterlingOrder('".$row[24]."')>View</a>";
				}
				$grid[$j][15]=$prophecy_viewLink;
				$grid[$j][16]=$sterling_viewLink;
				
				$eskill_viewLink='';
				if($row[25] !='')
				{
					$eskill_viewLink = "<a href=javascript:viewEskillResults('".$row[25]."','EmployeeManagement','".$row[0]."')>View</a>";
				}
				$grid[$j][17]=$eskill_viewLink;

				if(ACA_USER_ACCESS == 'Y'){
					$grid[$j][18]=$this->convertSpecChars($row[26]);
					$grid[$j][19]=$this->convertSpecChars($row[13]);
					$grid[$j][20]=$this->convertSpecChars($row[12]);
					$grid[$j][21]=$this->convertSpecChars($row[15]);
					$grid[$j][22]=$this->convertSpecChars($row[14]);
					$grid[$j][23]="";
					$grid[$j][24]=$row[0];
				}
				else{
					$grid[$j][18]=$this->convertSpecChars($row[13]);
					$grid[$j][19]=$this->convertSpecChars($row[12]);
					$grid[$j][20]=$this->convertSpecChars($row[15]);
					$grid[$j][21]=$this->convertSpecChars($row[14]);
					$grid[$j][22]="";
					$grid[$j][23]=$row[0];
				}

			$j++;
		}
	    return $grid;
	}
	
	////////////////////// Start Of Code For Timesheet Grid (Added by Srinivas Y)////////////////////////////////
	
	function buildQSTRTimeSht($gridSearchType,$gridSearchFields,$asFields)
	{
		$qstr="";
		if($this->isSearch($gridSearchFields))
		{
			$qstr=" HAVING (";
			for($i=0;$i<count($gridSearchFields);$i++)
			{
				$gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
				$gridSearchField=str_replace("%","\%",$gridSearchField);
				$gridSearchField=str_replace("_","\_",$gridSearchField);
										
				if($gridSearchFields[$i]!="")
					$qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
			}
			$qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
			$qstr.=")";
		}
		return $qstr;
	}
	
	function getTimesheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		$asFields=array("","emp_list.name",tzRetQueryStringDate('MIN( par_timesheet.sdate )','Date','/'),tzRetQueryStringDate('MAX( par_timesheet.edate )','Date','/'),"ROUND(SUM(timesheet.thours),2)","ROUND(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),2)","ROUND(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),2)","ROUND(ifnull(concat(sum(substring(timesheet.othours, 1, instr( timesheet.othours, '.' ) -1 ) ) + substring( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ) + ifnull( concat( sum( substring( timesheet.double_hours, 1, instr( timesheet.double_hours, '.' ) -1 ) ) + substring( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ) + ifnull( concat( sum( substring( timesheet.thours, 1, instr( timesheet.thours, '.' ) -1 ) ) + substring( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ),2)");
       
	    $ssFields=array("","trim(emp_list.name)"," MIN( par_timesheet.sdate )","MAX( par_timesheet.edate ) ","ROUND(SUM(timesheet.thours),2)","ROUND(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),2)","ROUND(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),2)"," ROUND(ifnull(concat(sum(substring(timesheet.othours, 1, instr( timesheet.othours, '.' ) -1 ) ) + substring( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.othours, instr( timesheet.othours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ) + ifnull( concat( sum( substring( timesheet.double_hours, 1, instr( timesheet.double_hours, '.' ) -1 ) ) + substring( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.double_hours, instr( timesheet.double_hours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ) + ifnull( concat( sum( substring( timesheet.thours, 1, instr( timesheet.thours, '.' ) -1 ) ) + substring( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, 1, instr( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, '.' ) ) , '.', substring( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, instr( sum( substring( timesheet.thours, instr( timesheet.thours, '.' ) +1 ) ) /60, '.' ) ) *60 ) , 0 ),2)");
		
		if($gridExtraFields['date_acntg_to']!=""){//code for date view without refresh
			$where_date = " and (par_timesheet.sdate>=cast('".$gridExtraFields['date_acntg_to']."' AS DATE) and par_timesheet.edate<=cast('".$gridExtraFields['date_acntg_toaf']."' AS DATE))";
		}
		else{
			$where_date=" ";
		}
		
		$tque="select count(*) from (select '', ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/')." startdate, ".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", emp_list.name, ROUND(SUM(timesheet.thours),2), par_timesheet.username,
          ROUND(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),2) othours1,
          ROUND(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),2) double_hours1,
          concat(sum(substring(timesheet.thours,1,instr(timesheet.thours,'.')-1))+substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,1,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.'))*60) thours1,
		   ROUND(ifnull(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),0)+ifnull(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),0)+ifnull(concat(sum(substring(timesheet.thours,1,instr(timesheet.thours,'.')-1))+substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,1,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.'))*60),0),2)
					,timesheet.sno
from par_timesheet force index(username),emp_list,timesheet           
where emp_list.username=par_timesheet.username 
and timesheet.parid=par_timesheet.sno

and timesheet.status IN  ('ER','Approved','Billed','Rejected') ".$where_date;

		$oque="select timesheet.sno,".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", emp_list.name, ROUND(SUM(timesheet.thours),2), par_timesheet.username, 
          ROUND(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),2) othours,
          ROUND(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),2) double_hours,
          concat(sum(substring(timesheet.thours,1,instr(timesheet.thours,'.')-1))+substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,1,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.'))*60) othours
					,emp_list.name
					,ROUND(ifnull(concat(sum(substring(timesheet.othours,1,instr(timesheet.othours,'.')-1))+substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,1,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,instr(sum(substring(timesheet.othours,instr(timesheet.othours,'.')+1))/60,'.'))*60),0)+ifnull(concat(sum(substring(timesheet.double_hours,1,instr(timesheet.double_hours,'.')-1))+substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,1,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,instr(sum(substring(timesheet.double_hours,instr(timesheet.double_hours,'.')+1))/60,'.'))*60),0)+ifnull(concat(sum(substring(timesheet.thours,1,instr(timesheet.thours,'.')-1))+substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,1,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.')),'.',substring(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,instr(sum(substring(timesheet.thours,instr(timesheet.thours,'.')+1))/60,'.'))*60),0),2)					
from par_timesheet force index(username),emp_list,timesheet           
where emp_list.username=par_timesheet.username 
and timesheet.parid=par_timesheet.sno
 
and timesheet.status IN  ('ER','Approved','Billed','Rejected') ".$where_date;

        $grp_str=' group by par_timesheet.username';
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr1=$gd->buildQSTRTimeSht($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1.')a');
		$oque="$oque $qstr $grp_str $qstr1 $ostr $lstr";
		
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTimesheets($oque);

		$objResponse = new xajaxResponse();
	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
	
	function buildTimesheets($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
            $grid[$j][1]=$this->convertSpecChars($row[3]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars($row[2]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[6]);
			$grid[$j][6]=$this->convertSpecChars($row[7]);
       	    $grid[$j][7]=$this->convertSpecChars($row[10]);
			$grid[$j][8]="";
			$grid[$j][9]="showfax.php?sno=".$row[5];
			$j++;
		}
		return $grid;
	}
		
	////////////////////// Start Of Code For Timesheet Grid (Added by Srinivas Y)////////////////////////////////
	
	// Function for displaying Accounting-Invoice Histroy Grid Records data------By RAVIPRASAD
	function getInvoice_History($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$invlocation,$invdept,$invclient,$invservicedate,$invservicedateto;
		$decimalPref= getDecimalPreference();
		$invlocation=$gridExtraFields['invlocation'];
		$invdept=$gridExtraFields['invdept'];
		$invclient=$gridExtraFields['invclient'];
		$invservicedate=$gridExtraFields['servicedate'];
		$invservicedateto=$gridExtraFields['servicedateto'];

		if($gridSortCol=="")
			$gridSortCol=1;

		$acs="";//variable for passing access permissions
		$gd=new gridData();
	
		$asFields=array("","CAST(invoice.invoice_number AS SIGNED)","custname",
		"IF(invoice.tsdate!='' AND invoice.tsdate1!='',CONCAT(invoice.tsdate,'-',invoice.tsdate1),
		CONCAT(invoice.invoice_date,'-',invoice.due_date))","STR_TO_DATE(invoice.invoice_date,'%m/%d/%Y')",
		"STR_TO_DATE(invoice.due_date,'%m/%d/%Y')","round(invoice.total,".$decimalPref.")",
		"round(invoice.total-(ifnull(a.amount,0)),".$decimalPref.")","CONCAT(contact_manage.loccode,' - ',contact_manage.heading)","department.deptname","IF(invoice.pdf_orientation=1,'Portrait','Landscape')","u.name","MAX(invoice.delivered_time)");

		$ssFields=array("","invoice.invoice_number","".getEntityDispName('staffacc_cinfo.sno', 'LOWER(staffacc_cinfo.cname)', 1)."", 
		"IF(invoice.tsdate!='' AND invoice.tsdate1!='',CONCAT(invoice.tsdate,'-',invoice.tsdate1), 
		CONCAT(invoice.invoice_date,'-',invoice.due_date))",
		"invoice.invoice_date","invoice.due_date","round(invoice.total,".$decimalPref.")",
		"round(invoice.total-(ifnull(a.amount,0)+ifnull(b.adj_amount,0)),".$decimalPref.")","CONCAT(contact_manage.loccode,' - ',contact_manage.heading)","department.deptname","IF(invoice.pdf_orientation=1,'Portrait','Landscape')","u.name",tzRetQueryStringDTime('invoice.delivered_time','DateTime24Sec','/'));

		$tque="SELECT COUNT(A.SNO) FROM (SELECT invoice.sno SNO,invoice.client_name,STR_TO_DATE(invoice.invoice_date,'%m/%d/%Y'),
		STR_TO_DATE(invoice.due_date,'%m/%d/%Y'),invoice.deposit,invoice.deliver,invoice.billed,invoice.total,invoice.tsdate,
		invoice.tsdate1,staffacc_cinfo.cname,ifnull(a.amount,0),invoice.sno sno1 
		FROM invoice 
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = invoice.client_name 
		LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active' 
		LEFT JOIN contact_manage ON Client_Accounts.loc_id=contact_manage.serial_no 
		LEFT JOIN department ON Client_Accounts.deptid=department.sno 
		LEFT JOIN (SELECT SUM(amount)amount,source FROM bank_trans WHERE source LIKE 'inv%' GROUP BY source) a ON (invoice.sno=substring(a.source,4))
		LEFT JOIN (SELECT SUM(amount) adj_amount, inv_bill_lineid FROM acc_reg WHERE type='PMT-ADJ' GROUP BY inv_bill_lineid) b ON invoice.sno=b.inv_bill_lineid
		LEFT JOIN users u ON invoice.delivered_by=u.username
		WHERE invoice.deliver = 'Yes' AND invoice.status = 'ACTIVE' AND invoice.client_name=staffacc_cinfo.sno AND Client_Accounts.clienttype IN ('CUST','BOTH')";
	
		$oque="SELECT invoice.sno,invoice.client_name,STR_TO_DATE(invoice.invoice_date,'%m/%d/%Y'),
		STR_TO_DATE(invoice.due_date,'%m/%d/%Y'),invoice.deposit,invoice.deliver,invoice.billed,round(invoice.total,".$decimalPref."),
		invoice.tsdate,invoice.tsdate1,staffacc_cinfo.cname,ifnull(a.amount,0),invoice.sno SNO1,
		round(invoice.total-(ifnull(a.amount,0)+ifnull(b.adj_amount,0)),".$decimalPref."),
		IF(invoice.tsdate!='' AND invoice.tsdate1!='',CONCAT(invoice.tsdate,'-',invoice.tsdate1),
		CONCAT(invoice.invoice_date,'-',invoice.due_date)) SERVICE_DATE ,invoice.invoice_number, 
		".getEntityDispName('staffacc_cinfo.sno', 'staffacc_cinfo.cname', 1)." AS custname,CONCAT(contact_manage.loccode,' - ',contact_manage.heading),department.deptname,invoice.pdf_orientation,u.name,".tzRetQueryStringDTime('invoice.delivered_time','DateTime24Sec','/')." 
		FROM invoice 
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = invoice.client_name 
		LEFT JOIN Client_Accounts ON Client_Accounts.typeid=staffacc_cinfo.sno AND Client_Accounts.status='active'  
		LEFT JOIN contact_manage ON Client_Accounts.loc_id=contact_manage.serial_no 
		LEFT JOIN department ON Client_Accounts.deptid=department.sno 
		LEFT JOIN (SELECT SUM(amount)amount,source FROM bank_trans WHERE source LIKE 'inv%' GROUP BY source) a ON(invoice.sno=substring(a.source,4))
		LEFT JOIN (SELECT SUM(amount) adj_amount, inv_bill_lineid FROM acc_reg WHERE type='PMT-ADJ' GROUP BY inv_bill_lineid) b ON invoice.sno=b.inv_bill_lineid
		LEFT JOIN users u ON invoice.delivered_by=u.username
		WHERE invoice.deliver = 'Yes' AND invoice.status = 'ACTIVE' AND invoice.client_name=staffacc_cinfo.sno AND Client_Accounts.clienttype IN ('CUST','BOTH') ";
	
		$gstr = "";
		$client_str="";
		$dateString = "";

		if($gridSearchFields[1]!="")
			$gridSearchFields[1]= strtolower($gridSearchFields[1]);	//customer name

		if($gridExtraFields['servicedate']!="")
		{
			$fromArr=explode("/",$gridExtraFields['servicedate']);
			$fromDate= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
			$sDate=date("Y-m-d",$fromDate);
			$dateString .= " AND STR_TO_DATE(invoice.invoice_date,'%m/%d/%Y') >='".$sDate."'";
		}

		if($gridExtraFields['servicedateto']!="")
		{
			$toArr=explode("/",$gridExtraFields['servicedateto']);
			$toDate= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
			$todaf=date("Y-m-d",$toDate);
			$dateString .= " AND STR_TO_DATE(invoice.invoice_date,'%m/%d/%Y') <='".$todaf."'";
		}

		if($gridExtraFields['invlocation']!="")
			$client_str=" AND Client_Accounts.loc_id=".$gridExtraFields['invlocation'];

		if($gridExtraFields['invdept']!="")
			$client_str.=" AND Client_Accounts.deptid=".$gridExtraFields['invdept'];
	
		if($gridExtraFields['invclient']!="all" && $gridExtraFields['invclient']!="")
			$client_str.=" AND invoice.client_name=".$gridExtraFields['invclient'];
				
		$gstr.= $dateString.$client_str." GROUP BY invoice.sno ";		

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,$gstr.") A");
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildInvoiceHistory($oque); 
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	
	function buildInvoiceHistory($que)
	{
		global $maildb,$db,$stat,$invlocation,$invdept,$invclient,$invservicedate,$invservicedateto;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		$decimalPref    = getDecimalPreference();

        while ($row=mysql_fetch_array($res))
		{
            $creditBalanceInvoice = "";
            //For getting the extra amount paid from credited amount.
            $queCredit = "SELECT SUM(used_amount) FROM credit_memo_trans WHERE inv_bill_sno='".$row[0]."' AND credit_memo_trans.type = 'invoice'";
            $resCredit = mysql_query($queCredit,$db);
            $rowCredit = mysql_fetch_row($resCredit);
	    
	    /////////////////////////////////// To get the total failed logs /////////////////////////////
	    
	    $queFailed = "SELECT ActivityStatus FROM log_Activity WHERE inv_num='".$row[0]."' AND ActivityStatus NOT IN('InProcess') AND cdate = (SELECT MAX(cdate) FROM log_Activity WHERE inv_num='".$row[0]."' AND ActivityStatus NOT IN('InProcess'))";
            $resFailed = mysql_query($queFailed,$db);
            $rowFailed = mysql_fetch_row($resFailed);
	    $totalFailed = $rowFailed[0];
	    
	    //////////////////////////////////////////////////////////////////////////////////////////////
            
			if($row[13]=="")
				$row[13]="0.00";				
            $creditBalanceInvoice = $row[13];
            //$creditBalanceInvoice = $row[13] - $rowCredit[0]; //After deducting credit amount for invoice.
            if($creditBalanceInvoice <= 0.00)
				$creditBalanceInvoice = "PAID";
			else
				$creditBalanceInvoice = $creditBalanceInvoice;
				
			if($row[2] === '0000-00-00' ) {
				$date1 = '';
			}else{
				$date1 = date('m/d/Y',strtotime($row[2]));
			}
			if($row[3] === '0000-00-00' ) {
				$date2 = '';
			}else{
				$date2 = date('m/d/Y',strtotime($row[3]));
			}
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label><input type=hidden name=newauids[] value='".$row[19]."'><input type=hidden name=custids[] value='".$row[1]."'>";
            $grid[$j][1]=$row[15];
		    $grid[$j][2]=$this->convertSpecChars(stripslashes($row[16]));
            $grid[$j][3]=$row[14];
			//$grid[$j][4]=date('m/d/Y',strtotime($row[2]));
			//$grid[$j][5]=date('m/d/Y',strtotime($row[3]));
			$grid[$j][4]=$date1;
			$grid[$j][5]=$date2;
			$grid[$j][6]=number_format($row[7],$decimalPref,'.','');
			$grid[$j][7]=number_format($creditBalanceInvoice,$decimalPref,'.','');
            $grid[$j][8]=$row[17];
            $grid[$j][9]=$row[18];
            $grid[$j][10]=($row[19]==1)?'Portrait':'Landscape';
			$grid[$j][11] = $row[20];
			$grid[$j][12] = $row[21];
	    if($totalFailed == 'Failed' || $totalFailed == 'Failed- No Attachments' || $totalFailed == 'Failed- No Billing Contact Email')
	    {
           $grid[$j][13]="<a href='#' onclick='javascript:showPopup(\"abv\",\"$row[0]\");return false;' style='text-decoration:none;'><img class='iframe' src=/BSOS/images/log_failed.png alt='log' title='log' border=0 width=16 heigh=16 title='Activity Log'></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' onclick='javascript:downloadInv(\"$row[0]\");return false;'><i class='fa fa-download' alt='Download' title='Download Timesheets,Expenses and their attachments in one zip file'></i></a>";
	    }
	    else
	    {
		$grid[$j][13]="<a href='#' onclick='javascript:showPopup(\"abv\",\"$row[0]\");return false;' style='text-decoration:none;'><i class='fa fa-history' alt='log' title='Activity Log'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' onclick='javascript:downloadInv(\"$row[0]\");return false;'><i class='fa fa-download' alt='Download'  title='Download Timesheets,Expenses and their attachments in one zip file'></i></a>";
	    }
			//$grid[$j][11]="showinvoice.php?invlocation=$invlocation&invdept=$invdept&invclient=$invclient&invservicedate=$invservicedate&invservicedateto=$invservicedateto&printinvoice=yes&addr=".$row[0];
			$grid[$j][14]="showpdfinvoice.php?invlocation=$invlocation&invdept=$invdept&invclient=$invclient&invservicedate=$invservicedate&invservicedateto=$invservicedateto&printinvoice=yes&addr=".$row[0];
            $j++;
		}
        return $grid;
	}

	// Admin - WebSite Management - ContactUs -- Sandeep Kumar Ganachary (07/21/2008)-- Rajkumar M.(09/20/08)
	// Modified by vijaya on 24-09-2008 to add new columns to HRM->Locations.	
	function getContactUs($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$fromHRM,$locationStatus;
		if($gridSortCol=="")
		$gridSortCol=1;
		$acs="";//variable for passing access permissions
		$gd=new gridData();
	  	$mquery = ($locationStatus == "InActive") ? "cnt_mng.status='BP'" : "cnt_mng.status!='BP'";
				
		//Search Fields
		 $ssFields=array("","loccode","heading","company_name","feid","classname","city","state","countries.country","zipcode",tzRetQueryStringDTime('cnt_mng.stime','DateTime','/'),"cuser123.name",tzRetQueryStringDTime('cnt_mng.mtime','DateTime','/'),"muser123.name");	
		
		// Order By fields 	
		$asFields=array("","loccode","heading","company_name","feid","classname","city","state","countries.country","zipcode","cnt_mng.stime","cuser123.name","cnt_mng.mtime","muser123.name","posted_date123");
	  	

		$tque = "SELECT count(*) FROM contact_manage cnt_mng
		LEFT JOIN users cuser123 on(cnt_mng.username=cuser123.username)
		LEFT JOIN users muser123 on(cnt_mng.muser=muser123.username) 
		LEFT JOIN class_setup ON ( class_setup.sno = cnt_mng.classid )
		LEFT JOIN countries ON(countries.sno = cnt_mng.country)
		WHERE ".$mquery;

		$oque = "SELECT serial_no,cnt_mng.heading,cnt_mng.loccode,cnt_mng.company_name,".tzRetQueryStringDTime('cnt_mng.stime','DateTime','/').", cuser123.name, ".tzRetQueryStringDTime('cnt_mng.mtime','DateTime','/').",muser123.name, cnt_mng.status,if(cnt_mng.status = \"P\",concat(\"Posted\",\" [\",".tzRetQueryStringDTime('posted_date','Date','/').",\"]\"),if(cnt_mng.status = \"RM\",concat(\"Removed\",\" [\",".tzRetQueryStringDTime('removed_date','Date','/').",\"]\"), NULL)) as posted_date123,cnt_mng.city,cnt_mng.state,countries.country as con,cnt_mng.zipcode,cnt_mng.feid,class_setup.classname as classname,cnt_mng.deflt
		FROM contact_manage cnt_mng
		LEFT JOIN users cuser123 on(cnt_mng.username=cuser123.username)
		LEFT JOIN users muser123 on(cnt_mng.muser=muser123.username) 
		LEFT JOIN class_setup ON ( class_setup.sno = cnt_mng.classid )
		LEFT JOIN countries ON(countries.sno = cnt_mng.country)
		WHERE ".$mquery;// where status='ER' 

        $gstr = "";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);//Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildContactUs($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildContactUs($que)
	{
		global $maildb,$db,$stat, $fromHRM,$locationStatus;
		
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_row($res))
		{
			if($locationStatus=="InActive")
			{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop(); value=".$row[0]."|".$row[16]."><span class='checkmark'></span></label>";
				$grid[$j][1]=$this->convertSpecChars($row[2]); // Location code
				$grid[$j][2]=$this->convertSpecChars($row[1]); // Location name
				$grid[$j][3]=$this->convertSpecChars($row[3]); // company
				$grid[$j][4]=$this->convertSpecChars($row[14]); // Federal Id
				$grid[$j][5]=$this->convertSpecChars($row[15]); // Class
				$grid[$j][6]=$this->convertSpecChars($row[10]); // City
				$grid[$j][7]=$this->convertSpecChars($row[11]); // State
				$grid[$j][8]=$this->convertSpecChars($row[12]); // County
				$grid[$j][9]=$this->convertSpecChars($row[13]); // Zip
				$grid[$j][10]=$this->convertSpecChars($row[4]); // Cdate
				$grid[$j][11]=$this->convertSpecChars($row[5]);	// Cuser
				$grid[$j][12]=$this->convertSpecChars($row[6]);	// Mdate	
				$grid[$j][13]=$this->convertSpecChars($row[7]);	// Muser
				$grid[$j][14]="";								// Search reset
				$grid[$j][15]=$row[0];							// Double click value
			}
			else
			{
				if(trim($fromHRM) == "HRM")
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop(); value=".$row[0]."|".$row[16]."><span class='checkmark'></span></label>";	
					$grid[$j][14]="";								// Search reset
					$grid[$j][15]=$row[0];							// Double click value
				}
				else
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[0]."|".$row[16]."><span class='checkmark'></span></label>";
					$grid[$j][14]=$this->convertSpecChars($row[9]);	// Posted date
					$grid[$j][15]="";								// Search reset
					$grid[$j][16]=$row[0];							// Double Click value

				}
				
				$grid[$j][1]=$this->convertSpecChars($row[2]); // Location code
				$grid[$j][2]=$this->convertSpecChars($row[1]); // Location name
				$grid[$j][3]=$this->convertSpecChars($row[3]); // company
				$grid[$j][4]=$this->convertSpecChars($row[14]); // Federal Id
				$grid[$j][5]=$this->convertSpecChars($row[15]); // Class
				$grid[$j][6]=$this->convertSpecChars($row[10]); // City
				$grid[$j][7]=$this->convertSpecChars($row[11]); // State
				$grid[$j][8]=$this->convertSpecChars($row[12]); // County
				$grid[$j][9]=$this->convertSpecChars($row[13]); // Zip
				$grid[$j][10]=$this->convertSpecChars($row[4]); // Cdate
				$grid[$j][11]=$this->convertSpecChars($row[5]);	// Cuser
				$grid[$j][12]=$this->convertSpecChars($row[6]);	// Mdate	
				$grid[$j][13]=$this->convertSpecChars($row[7]);	// Muser
			}			
			$j++;
		}
        return $grid;
	}
	//added by prasad to Admin->Job postings grid optimization.....Modified for adding created by,Date,modified By Date-siva prasanth
	function getAdminJobpostings($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        		
		$asFields=array("","jobstatus.name","trim(hotjobs.postitle)","staffoppr_cinfo.cname","loc.city","loc.state","fg.group_name","department.deptname","managecat.name","CONCAT('Total (',hotjobs.no_of_pos,') - Filled (',hotjobs.closepos,')')",tzRetQueryStringDTime('hotjobs.cdate','DateTime','/'),"cuser.name",tzRetQueryStringDTime('hotjobs.mdate','DateTime','/'),"muser.name","hotjobs.hotjob_chk","e");
			
			//ordering array
		$ssFields = array("","jobstatus.name","trim(hotjobs.postitle)","staffoppr_cinfo.cname","loc.city","loc.state","fg.group_name","department.deptname","managecat.name","CONCAT('Total (',hotjobs.no_of_pos,') - Filled (',hotjobs.closepos,')')","hotjobs.cdate","cuser.name","hotjobs.mdate","muser.name","g","hotjobs.hotjob_chk","e");

		$tque="SELECT COUNT( JOB.posid ) FROM (
SELECT DISTINCT hotjobs.sno posid, hotjobs.postitle, CONCAT( 'Total (', hotjobs.no_of_pos, ') - Filled (', hotjobs.closepos, ')' ) , staffoppr_cinfo.cname, loc.city, loc.state,IF (hotjobs.status = 'P',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), concat( 'Expired', ' [', date_format( hotjobs.expire_date, '%m/%d/%Y' ) , ']' ) , concat( 'Posted', ' [', date_format( hotjobs.posted_date, '%m/%d/%Y' ) , ']' )
),IF (hotjobs.status = 'E', concat( 'Expired', ' [', date_format( hotjobs.expire_date, '%m/%d/%Y' ) , ']' ) ,
IF (hotjobs.status = 'R',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), concat( 'Expired', ' [', date_format( hotjobs.expire_date, '%m/%d/%Y' ) , ']' ) , concat( 'Refreshed', ' [', date_format( hotjobs.refresh_date, '%m/%d/%Y' ) , ']' )),IF (hotjobs.status = 'RM', concat( 'Removed', ' [', date_format( hotjobs.remove_date, '%m/%d/%Y' ) , ']' ) , ''))))d,IF (hotjobs.status = 'P',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'
AND hotjobs.expire_date < NOW())), 'Expired', 'Posted'),IF (hotjobs.status = 'E', 'Expired',IF (hotjobs.status = 'R',
IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), 'Expired', 'Refreshed'),IF (hotjobs.status = 'RM', 'Removed', ''))))g,IF (hotjobs.status = 'P',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'
AND hotjobs.expire_date < NOW())), hotjobs.expire_date, hotjobs.posted_date),IF (hotjobs.status = 'E', hotjobs.expire_date,IF (hotjobs.status = 'R',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW()
)), hotjobs.expire_date, hotjobs.refresh_date),IF (hotjobs.status = 'RM', hotjobs.remove_date, ''))))e,hotjobs.hotjob_chk,fg.group_name,department.deptname, managecat.name catname,jobstatus.name STATUS FROM hotjobs
LEFT JOIN hotjobs_pref ON ( hotjobs.sno = hotjobs_pref.posid )LEFT JOIN department ON( hotjobs.deptid = department.sno) LEFT JOIN manage ON ( hotjobs.postype = manage.sno
AND manage.type = 'jotype' )LEFT JOIN staffoppr_cinfo ON staffoppr_cinfo.sno = hotjobs.company LEFT JOIN manage managecat ON ( hotjobs.catid = managecat.sno ) LEFT JOIN users as muser ON muser.username = hotjobs.muser LEFT JOIN users as cuser ON cuser.username = hotjobs.cuser
LEFT JOIN staffoppr_location AS loc ON loc.sno = hotjobs.location LEFT JOIN apt_forms_groups fg ON hotjobs.apt_group_id = fg.sno
LEFT JOIN manage jobstatus ON (hotjobs.posstatus = jobstatus.sno AND jobstatus.type = 'jostatus')
WHERE hotjobs.status
IN ('P', 'E', 'R', 'NP', 'RM') AND hotjobs.sno IN (SELECT
  MAX(hj.sno)
FROM hotjobs hj
GROUP BY hj.req_id)";

		$oque="SELECT DISTINCT hotjobs.sno posid, hotjobs.postitle, CONCAT( 'Total (', hotjobs.no_of_pos, ') - Filled (', hotjobs.closepos, ')' ) ,  staffoppr_cinfo.cname, loc.city, loc.state, IF (hotjobs.status = 'P',
IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), concat( 'Expired', ' [', ".tzRetQueryStringDTime('hotjobs.expire_date','Date','/')." , ']' ) , concat( 'Posted', ' [',".tzRetQueryStringDTime('hotjobs.posted_date','Date','/')." , ']' )),IF (hotjobs.status = 'E', concat( 'Expired', ' [', ".tzRetQueryStringDTime('hotjobs.expire_date','Date','/')." , ']' ) ,
IF (hotjobs.status = 'R',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), concat( 'Expired', ' [', ".tzRetQueryStringDTime('hotjobs.expire_date','Date','/')." , ']' ) , concat( 'Refreshed', ' [', ".tzRetQueryStringDTime('hotjobs.refresh_date','Date','/')." , ']' )),IF (hotjobs.status = 'RM', concat( 'Removed', ' [', ".tzRetQueryStringDTime('hotjobs.remove_date','Date','/')." , ']' ) , ''))))d,IF (hotjobs.status = 'P',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'
AND hotjobs.expire_date < NOW())), 'Expired', 'Posted'),IF (hotjobs.status = 'E', 'Expired',IF (hotjobs.status = 'R',
IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW())), 'Expired', 'Refreshed'),IF (hotjobs.status = 'RM', 'Removed', ''))))g,IF (hotjobs.status = 'P',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'
AND hotjobs.expire_date < NOW())), hotjobs.expire_date, hotjobs.posted_date),IF (hotjobs.status = 'E', hotjobs.expire_date,IF (hotjobs.status = 'R',IF (((hotjobs.expire_date != '0000-00-00 00:00:00'AND hotjobs.expire_date < NOW()
)), hotjobs.expire_date, hotjobs.refresh_date),IF (hotjobs.status = 'RM', hotjobs.remove_date, ''))))e,".tzRetQueryStringDTime('hotjobs.cdate','DateTime','/').",cuser.name,".tzRetQueryStringDTime('hotjobs.mdate','DateTime','/').",muser.name,hotjobs.hotjob_chk, fg.group_name,department.deptname, managecat.name catname,jobstatus.name STATUS FROM hotjobs
LEFT JOIN hotjobs_pref ON ( hotjobs.sno = hotjobs_pref.posid )
LEFT JOIN department ON( hotjobs.deptid = department.sno)
LEFT JOIN manage ON ( hotjobs.postype = manage.sno
AND manage.type = 'jotype' )LEFT JOIN staffoppr_cinfo ON staffoppr_cinfo.sno = hotjobs.company  LEFT JOIN manage managecat ON ( hotjobs.catid = managecat.sno ) LEFT JOIN users as muser ON muser.username = hotjobs.muser LEFT JOIN users as cuser ON cuser.username = hotjobs.cuser
LEFT JOIN staffoppr_location AS loc ON loc.sno = hotjobs.location LEFT JOIN apt_forms_groups fg ON hotjobs.apt_group_id = fg.sno
LEFT JOIN manage jobstatus ON (hotjobs.posstatus = jobstatus.sno AND jobstatus.type = 'jostatus')
WHERE hotjobs.status
IN ('P', 'E', 'R', 'NP', 'RM') AND hotjobs.sno IN (SELECT
  MAX(hj.sno)
FROM hotjobs hj
GROUP BY hj.req_id)";
		
		
		$gstr = "";
		
		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
		if($gridSortCol == 6)
		{
			$orderExplodeArr 	= explode(",",$ostr);
			$ascStr 		= substr(trim($orderExplodeArr[1]), -4);
			$orderExplodeArr[0] 	= $orderExplodeArr[0]." ".$ascStr;
			$ostr 			= implode(" ,",$orderExplodeArr);
		}
		$tque	= $gd->buildTQuery($tque,$qstr,$gstr.") JOB");
		$oque	= $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total	= $gd->getTotalRows($tque);
		$gridData = $gd->buildAdminJobpostings($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
	//this  fun for assigning fetched data to grid...--added by prasad d-- Modified for adding created by,Date,modified By Date-siva prasanth
	function buildAdminJobpostings($que)
	{
		global $maildb,$db;
		$j	= 0;
		$grid	= array();
		$res	= mysql_query($que,$db);
		while($row = mysql_fetch_array($res))
		{
			$dateDisplay = explode("[",$row[6]);

			if(trim($dateDisplay[0])== "Expired" || trim($dateDisplay[0])== "Removed")
				$datePosted = "<font color='#FF0000'>".$row[6]."</font>";
			else if(trim($dateDisplay[0])=="Refreshed")
				$datePosted = "<font color='#009933'>".$row[6]."</font>";
			else
				$datePosted = $row[6];

			$grid[$j][0]	= "<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$j."'><span class='checkmark'></span></label>";
			$grid[$j][1]	= $this->convertSpecChars($row[17]);
			$grid[$j][2]	= $this->convertSpecChars($row[1]);
			$grid[$j][3]	= $this->convertSpecChars($row[3]);
			$grid[$j][4]	= $this->convertSpecChars($row[4]);
			
			$grid[$j][5]	= $this->convertSpecChars($row[5]);
			$grid[$j][6]	= $this->convertSpecChars($row[14]);
			$grid[$j][7]	= $this->convertSpecChars($row[15]);
			$grid[$j][8]	= $this->convertSpecChars($row[16]);
			$grid[$j][9]	= $this->convertSpecChars($row[2]);
			$grid[$j][10]	= $this->convertSpecChars($row[9]);
			$grid[$j][11]	= $this->convertSpecChars($row[10]);
			$grid[$j][12]	= $this->convertSpecChars($row[11]);
			$grid[$j][13]	= $this->convertSpecChars($row[12]);
			$grid[$j][14]	= $datePosted;
			$grid[$j][15]	= $row[13];
			$grid[$j][16]	= '';
			$grid[$j][17]	= "Joborder/redirectjob.php?addr=".$row[0];			
			$j++;
		}
		return $grid;
	}
	 function  getMessageBoard($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	 {	 	
	 	global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		
		
		$asFields=array("","messageboard.title","messageboard.publish_date","messageboard.exprire_date");
		
$ssFields=array("","messageboard.title",tzRetQueryStringDate('messageboard.publish_date','Date','/'),tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/'));
		
		$tque="select count(messageboard.sno) from messageboard  where FIND_IN_SET('".$username."',userlist)>0 and status not in 	('delete','backup')";
		
		$oque="select sno,title,".tzRetQueryStringDate('messageboard.publish_date','Date','/')." pd, if(messageboard.exprire_date='0000-00-00','',".tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/').") ed from messageboard where  FIND_IN_SET('".$username."',userlist)>0 and status not in ('delete','backup') ";

		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMessageBoard($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	 }
	 
	function buildMessageBoard($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]="<a href=viewboard.php?mesno=".$row[0]."><img src=/BSOS/images/icons/view.gif title='View' align='middle' border=0></a>";
			$grid[$j][5]="";
			$j++;
		}
		
		return $grid;
	}
	function  getMessageBoard1($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	 {
	 		 	
	 	global $maildb,$db,$username,$stat,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		//$acs="";variable for passing access permissions
		$gd=new gridData();
		
		$asFields=array("","messageboard.title","messageboard.publish_date", "messageboard.exprire_date");

$ssFields=array("","messageboard.title",tzRetQueryStringDate('messageboard.publish_date','Date','/'),tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/'));
		
		$tque="select count(sno) from messageboard   where createdby='".$username."' and status not in ('delete','backup')";
		
		$oque="select sno,title,if(messageboard.publish_date='0000-00-00','',".tzRetQueryStringDate('messageboard.publish_date','Date','/')."), if(messageboard.exprire_date='0000-00-00','',".tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/').") from messageboard where  createdby='".$username."' and status not in ('delete','backup')";

		
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMessageBoard1($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildMessageBoard1($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]="<a href=viewboard.php?mesno=".$row[0]."><i class='fa fa-search'></i></a>";
			$grid[$j][5]="";
			$j++;
		}
		return $grid;
	}
	function  getMessageBoard2($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	 {
		global $maildb,$db,$username,$stat,$user_timezone;
		
		if($gridSortCol=="")
			$gridSortCol=1;
		
		//$acs="";variable for passing access permissions
		$gd=new gridData();
		
		$asFields=array("","messageboard.title","messageboard.publish_date", "messageboard.exprire_date");
		
$ssFields=array("","messageboard.title",tzRetQueryStringDate('messageboard.publish_date','Date','/'),tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/'));
		$tque="select count(sno) from messageboard   where createdby='".$username."' and status='delete'";
		
		$oque="select sno,title,if(messageboard.publish_date='0000-00-00','',".tzRetQueryStringDate('messageboard.publish_date','Date','/').")  pd, if(messageboard.exprire_date='0000-00-00','',".tzRetQueryStringSelBoxDate('messageboard.exprire_date','Date','/').") ed from messageboard where  createdby='".$username."' and status='delete'";
		
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMessageBoard2($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	function buildMessageBoard2($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]="<a href=viewboard.php?mesno=".$row[0]."><i class='fa fa-search' alt='Search' title='View'></i></a>";
			$grid[$j][5]="";

			$j++;
		}
		return $grid;
	}
	//Function for Collaboration -> Address Book both main and archive page -- Gopi
	function getAddressbook($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$addStatus;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		
		$aqstr=" 1=1 ";
		
		$asFields= array("","contacts.fname","contacts.lname","contacts.company","contacts.mobile","contacts.wphone","contacts.email","comp_grp.grptype");
		      
		$ssFields=array("","contacts.fname","contacts.lname","contacts.company","contacts.mobile","contacts.wphone","contacts.email","comp_grp.grptype");
					
		$tque="select count(contacts.serial_no) as count from contacts LEFT JOIN comp_grp ON FIND_IN_SET(contacts.serial_no, comp_grp.grpmembers) >0 where contacts.type in ('contact','prospect') and contacts.userid='".$username."' and contacts.status='".$addStatus."'";
		$oque="select contacts.serial_no,contacts.userid,contacts.fname,contacts.company,contacts.mobile,contacts.wphone,contacts.email,comp_grp.grptype,contacts.lname from contacts LEFT JOIN comp_grp ON FIND_IN_SET(contacts.serial_no, comp_grp.grpmembers) >0  and  comp_grp.username='".$username."' where contacts.type in ('contact','prospect') and contacts.userid='".$username."' and contacts.status='".$addStatus."'";
		
		//For checking contacts duplicates and displaying the search result on main grid.
        if($gridExtraFields['duplicate']== "yes")
        {
            $gridSearchFields[0] = $gd->gridSearchFieldConvert($gridSearchFields[0]);
            $gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
            $gridSearchFields[5] = $gd->gridSearchFieldConvert($gridSearchFields[5]);
            
            $duplicateCheck = $gd->duplicateContactChecking($gridSearchFields[0],$gridSearchFields[1],$gridSearchFields[5]);
            $tque.=$duplicateCheck;
            $oque.=$duplicateCheck;
            $gridSearchFields[0] = "";
            $gridSearchFields[1] = "";
            $gridSearchFields[5] = "";
        }
		
		$gstr=" group by contacts.serial_no";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		if($gridSearchFields[6] != "")
		{
			$grpt = " and FIND_IN_SET('".$gridSearchFields[6]."',comp_grp.grptype)";
			$gridSearchFields[6] = "";
		}
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr.= $grpt;
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$tque = "select count(a.count) from ($tque) a";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAddressbook($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	function buildAddressbook($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[2]);
			$grid[$j][2]=$this->convertSpecChars($row[8]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]='';
			$grid[$j][9]=$row[0];
			$j++;
		
		}
		return $grid;
	}
	
	//Function for Collaboration -> Groups -- Gopi
	function getGroups($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$addStatus;
		if($gridSortCol=="")
			$gridSortCol=1;
		$gd=new gridData();
		
		$aqstr=" 1=1 ";
		
		$asFields=array("","grpname","grptype"); 
		      
		$ssFields=array("","grpname","grptype");
					
		$tque="select count(1) from comp_grp where username='".$username."' and status='ER'";
		
		$oque="select sno,grpname,grptype from comp_grp where username='".$username."' and status='ER'";
		
		
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		if($gridSearchFields[1] != "")
		{
			$grpt = " and FIND_IN_SET('".$gridSearchFields[1]."',grptype)";	
			$gridSearchFields[1] = "";
		}
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr.=$grpt; 
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildGroups($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildGroups($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]='';			
			$grid[$j][4]=$row[0];
			$j++;
		}
		return $grid;
	}
	
	//Function for the admin joborders main page
	function getAdminJobOrders($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$sysdb,$maindb,$companyuser;

		$gd = new gridData();

		$asFields=array("","posdesc.jonumber","jobstatus.name","posdesc.postitle", "staffoppr_cinfo.cname","loc.city",
		"loc.state","posdesc.refcode","req_pref.po_num", tzRetQueryStringSelBoxDate('posdesc.duedate','Date','/'),
		"IF(no_of_pos - closepos <0,0,no_of_pos - closepos)", "sub_sub_count","sub_cand_count","posdesc.sub_int_count",
		"IF (posdesc.accessto = 'all', 'Public', IF (locate(',',posdesc.accessto)>0,'Share','Private'))",
		"sourcetype.name", "jobtype.name","users.name",tzRetQueryStringSelBoxDate('posstartdate','Date','/'),
		tzRetQueryStringDTime('posdesc.stime','Date','/'),tzRetQueryStringDTime('posdesc.mdate','Date','/'));
		
		$ssFields = array("","jonumber","jobstatus.name","posdesc.postitle","staffoppr_cinfo.cname",	"loc.city","loc.state","posdesc.refcode","req_pref.po_num", "posdesc.duedate", "openpos","posdesc.sub_sub_count",
		"posdesc.sub_cand_count","posdesc.sub_int_count","IF (posdesc.accessto = 'all', 'Public',IF (locate(',',posdesc.accessto)>0,'Share','Private'))", "sourcetype.name","jobtype.name", "users.name","posdesc.posstartdate","posdesc.stime","posdesc.mdate");
		
		$tque="SELECT count(posdesc.posid)
		FROM posdesc LEFT JOIN staffoppr_cinfo ON(posdesc.company=staffoppr_cinfo.sno)
		LEFT JOIN manage jobtype ON(posdesc.postype=jobtype.sno AND jobtype.type='jotype')
		LEFT JOIN staffoppr_location loc ON (posdesc.location=loc.sno)
		LEFT JOIN manage sourcetype ON(posdesc.sourcetype=sourcetype.sno AND sourcetype.type='josourcetype')
		LEFT JOIN users ON(posdesc.owner=users.username)
		LEFT JOIN manage jobstatus ON (posdesc.posstatus=jobstatus.sno AND jobstatus.type='jostatus'),req_pref
		WHERE posdesc.status IN ('approve','Accepted') AND req_pref.posid = posdesc.posid ";
		
		$oque="SELECT posdesc.posid, posdesc.jonumber,
       	posdesc.postitle, CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'Admin_Companies\')>', staffoppr_cinfo.cname, '</a>') as cname,  jobtype.name jobtype, 
		jobstatus.name  STATUS, posdesc.refcode, req_pref.po_num, ".tzRetQueryStringSelBoxDate('posdesc.duedate','Date','/').",
		IF(no_of_pos - closepos < 0, 0, no_of_pos - closepos) openpos,posdesc.sub_sub_count,
	   	posdesc.sub_inq_count,posdesc.sub_cand_count,posdesc.sub_int_count,
       	IF (posdesc.accessto = 'all' , 'Public',
		IF (locate(',',posdesc.accessto)>0,'Share','Private')) TYPE, 
	   	sourcetype.name  sourcetype,
	   	posdesc.owner, users.name, ".tzRetQueryStringSelBoxDate('posstartdate','Date','/')."  startdate,
		".tzRetQueryStringDTime('posdesc.stime','Date','/').",".tzRetQueryStringDTime('posdesc.mdate','Date','/').",
		loc.city,loc.state
	   	FROM posdesc force index(status)
		LEFT JOIN staffoppr_cinfo ON(posdesc.company=staffoppr_cinfo.sno)
		LEFT JOIN staffoppr_location loc ON (posdesc.location=loc.sno)
		LEFT JOIN manage jobtype ON (posdesc.postype=jobtype.sno AND jobtype.type='jotype')
		LEFT JOIN manage sourcetype ON(posdesc.sourcetype=sourcetype.sno AND sourcetype.type='josourcetype')
		LEFT JOIN users ON(posdesc.owner=users.username)
		LEFT JOIN manage jobstatus ON (posdesc.posstatus=jobstatus.sno AND jobstatus.type='jostatus'),req_pref
		WHERE posdesc.status IN ('approve','Accepted') AND req_pref.posid= posdesc.posid ";

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
				//require("searchdatabase.inc");
				$adminsearch = "yes";	
				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);
	
				require("quickSubCandidates.inc");	
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
				$customesearch = true;
				require("visualsearch_joborders_admin.php");
				require("database.inc");
			}
			else
			{
				$aqstr=" AND 1=1 ";
			}
		
		//$gstr = " GROUP BY posdesc.posid ";
		$gstr="";
		$ValJobType = "";//for holding jobtype in searching
		$hvstr = "";//for holding having in searching
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		
		//To get exact result of selected jobtype
		if($gridSearchFields[14]!="")
		{
			$ValJobType = " AND (sourcetype.name = '$gridSearchFields[14]')";
			$gridSearchFields[14]="";
		}
		//To get no. of submissions of job in searching
		if($gridSearchFields[9]!="")
		{
			$hvstr = " AND sub_sub_count = '$gridSearchFields[9]' ";
			$gridSearchFields[9]="";
		}
		if($gridSearchFields[10]!= "")
		{			
			$ValJobType .= " AND ( sub_cand_count = '$gridSearchFields[10]') ";
			$gridSearchFields[10] = "";
		}

        $qstr=$gd->buildQSTR($gridSearchType, $gridSearchFields, $asFields);
        $qstr=$aqstr.$qstr.$ValJobType;//appending the jobtype selected
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr.$hvstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr.$hvstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminJobOrders($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	
	//Function to build the admin joborders main page query
	function buildAdminJobOrders($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[16]."|".$row[14]."|".html_tls_specialchars($row[2],ENT_QUOTES)."|".$j."'><span class='checkmark'></span></label>"; 
			$row[18] = ($row[18]=="00/00/0000")? "" : $row[18];
			$grid[$j][1]=$this->convertSpecChars($row[1]); //Job ID
			$grid[$j][2]=$this->convertSpecChars($row[5]);  //Status
			$grid[$j][3]=$this->convertSpecChars($row[2]); //Title
			$grid[$j][4]=$row[3]; //Company Name
			$grid[$j][5]=$this->convertSpecChars($row[21]);//city
			$grid[$j][6]=$this->convertSpecChars($row[22]);//state
			$grid[$j][7]=$this->convertSpecChars($row[6]); //REF Code		
			$grid[$j][8]=$this->convertSpecChars($row[7]); //PO Number
			$grid[$j][9]=($row[8]=="00/00/0000")? "" : $row[8];//Due Date
			$grid[$j][10]=$row[9]; // Openings
			$rescount=$row[10]; 
			if($rescount==0) 
				$grid[$j][11]="";//Submissions
			else
			{
				$k=$row[11];
	
				if($k==0)
					$grid[$j][11]="<a href=javascript:link($row[0],'Admin_Companies')>$rescount</a>";
				else
					$grid[$j][11]="<a href=javascript:link($row[0],'Admin_Companies')>$rescount</a>&nbsp;&nbsp;&nbsp;<a href=javascript:subInqiries($row[0]) style='color:red'>($k new)</a>";
			}		
			$grid[$j][12] = ($row[12]==0) ? "" : "<a href=javascript:showCand($row[0],'','Admin_Candidates')>".$row[12]."</a>"; //Candidates
			$grid[$j][13]=($row[13]==0)? "" : $row[13]; // Interviews
			$grid[$j][14]=$this->convertSpecChars($row[14]); // Type 
			$grid[$j][15]=$this->convertSpecChars($row[15]); //Source Type 
			$grid[$j][16]=$this->convertSpecChars($row[4]);  //Job Type
			$grid[$j][17]=$this->convertSpecChars($row[17]); //Owner 
			$grid[$j][18]=$this->convertSpecChars($row[18]); //Start Date
			$grid[$j][19]=$this->convertSpecChars($row[19]); //Created Date
			$grid[$j][20]=$this->convertSpecChars($row[20]); //Modified Date
			
			$grid[$j][21]="";
			$grid[$j][22]="/BSOS/Sales/Req_Mngmt/redirectjob.php?addr=".$row[0]."&chkAuth=admin&module=Admin_JobOrders";

			$j++;
		}
        return $grid;
	}



	//Function for admin joborders manage submission
	function getAdminJoborderMangSub($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd=new gridData();
		if($gridExtraFields['posid'] != "")
		$req_id = $gridExtraFields['posid'];
		
		$jotype_qry = "SELECT postype from posdesc WHERE posid =".$req_id;
		$jotype_res = mysql_query($jotype_qry,$db);
		$jotype_row =mysql_fetch_row($jotype_res);
		$manage_row = getManage($jotype_row[0]);	
		
		$asFields=array("",tzRetQueryStringDTime('reqresponse.rdate','DateTime','/'),"REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","candidate_list.hphone",tzRetQueryStringDTime('candidate_list.mtime','Date','/'),"IF(resume_status.pstatus='P','Placed',manage.name)","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","","","","","","","");
        $ssFields=array("","reqresponse.rdate","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","candidate_list.hphone","candidate_list.mtime","IF(resume_status.pstatus='P','Placed',manage.name)","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","","","","","","","");
	
	//AND (manage.name!='Applied' AND manage.type='interviewstatus' )-->condition placedfor not to show candidates with Applied status--Raviprasad	
			
		$tque1 = "select count(1) FROM (SELECT IF (resume_status.pstatus = 'P', 'Placed', IF(manage.name!='',manage.name,'Submitted')),resume_status.pstatus,manage.name FROM posdesc, reqresponse, candidate_list, resume_status, manage
WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND find_in_set(candidate_list.username,reqresponse.resumeid)
AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."'
AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus'
AND manage.name!='Applied' AND reqresponse.par_id='0'";

		$oque1 = "SELECT candidate_list.sno, candidate_list.username, CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname), candidate_list.hphone, IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as CandType, 
candidate_list.resid, candidate_list.candid , candidate_list.status, IF(candidate_list.accessto = 'ALL', 'Public', IF(FIND_IN_SET('".$username."',candidate_list.accessto)>0 , 'Share','NONE')), ".tzRetQueryStringDTime('candidate_list.mtime','Date','/').", reqresponse.rdate, manage.name ,resume_status.status,resume_status.pstatus,candidate_list.supid,reqresponse.seqnumber,reqresponse.sno,reqresponse.resumeid,IF(resume_status.pstatus
='P','Placed',IF(manage.name!='',manage.name,'Submitted')) FROM posdesc, reqresponse, candidate_list,  resume_status, manage
WHERE posdesc.posid='".$req_id."' AND posdesc.posid=reqresponse.posid AND reqresponse.posid='".$req_id."' AND find_in_set(candidate_list.username,reqresponse.resumeid)
AND resume_status.req_id=reqresponse.posid AND resume_status.req_id='".$req_id."'
AND reqresponse.seqnumber=resume_status.seqnumber AND candidate_list.sno=resume_status.res_id AND resume_status.status=manage.sno and manage.type='interviewstatus'
AND manage.name!='Applied' AND reqresponse.par_id='0'";
		$tque2 = ") temp";
		$oque2 = "order by reqresponse.rdate DESC";
		
		//$grpque=" group by candidate_list.username";
		$varCandType="";
		$hvstr="";
		
		if($gridSearchFields[4] != "")
		{
			$gridSearchFields[4] = getManage($gridSearchFields[4]);
			$hvstr="having (IF(resume_status.pstatus='P','Placed',IF(manage.name!='',manage.name,'Submitted')) LIKE '%".$gridSearchFields[4]."%' )";
			$gridSearchFields[4]= "";
			$candstatus = "resume_status.status!=''";
		}
		
		if($gridSearchFields[5]=="Candidate")
		{
			$varCandType="candidate_list.owner!='$username' and candidate_list.ctype!='Employee'";
			$gridSearchFields[5]="";
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		if($qstr!="" && $varCandType!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$varCandType.")";

        }
        else if($qstr=="" && $varCandType!="")
        {
			$qstr.=" AND (".$varCandType.")";
        }
		
		if($qstr!="" && $candstatus!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$candstatus.")";

        }
        else if($qstr=="" && $candstatus!="")
        {
			$qstr.=" AND (".$candstatus.")";
        }
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields) ; // Order by fields, append the where clause accordingly
		$ostr = ($ostr == '')? $oque2 : $ostr;
		$totstr = "$grpque $hvstr $tque2";
		$tque=$gd->buildTQuery($tque1,$qstr,$totstr);
    	$oque="$oque1 $qstr $grpque $hvstr $ostr $lstr";
    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminJoborderMangSub($oque,$manage_row,$req_id);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	// Admin JOB ORDERS - JoborderMangSub Page
	function buildAdminJoborderMangSub($que,$manage_row,$req_id)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		require("OutLookEnbLinks.php");
		$OutLookObj=new EnbOutLookPluginLinks(OUTLOOK_PLUG_IN,"CRMCAND");
		while($drow=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$candaccess=explode(',',$drow[8]);
			$candsear=array_search($username,$candaccess);
			/*if((trim($candsear)!="" && $candsear >=0) || strtolower($drow[8])=='all')
			{*/
				if($drow[7]=='ACTIVE')
					$accessvalue="YES";
				else
					$accessvalue="NO";
			/*}
			else
				$accessvalue="NO";*/
				
			$subno=$drow[16];	
			$seqnumber = $drow[15];	
			$sid="'".str_replace(",","','",$drow[17])."'";
			$type = $drow[4];
			
			/*if($drow[13]=='P')
				$res_status="Placed";
			else if($drow[12]=="")
				$res_status='Submitted';
			else
				$res_status = getManage($drow[12]);*/
			
			$res_status=$drow[18];	
			$hiddval = $drow[0]."|".$drow[11];
			
			/*if($drow[11] =="Applied")                      Submit candidate link needs to show in submission window grid for Applied status--Raviprasad
			 {
				$grid[$j][1]="<a href=javascript:managesub_popup($drow[0]) class='crmsummary-joblnk'>[submit candidate]</a>";
			 }*/
			 
			if($drow[11] == 'submitted')
				$grid[$j][1]="<a href=javascript:subdetails($subno)><font class=linkrow>$drow[10]</font></a>";
			else
			{
 				$hiddval = $drow[0]."|".urlencode($drow[11]."|".$seqnumber);
				$grid[$j][1]="<a href=javascript:openNewWindow('$hiddval')><font class=linkrow>$drow[10]</font></a>";
			}	
			
			$grid[$j][2]="<a href=javascript:winopennew('review.php?type=cand&candstat=$drow[7]&cno=$drow[0]&candaccess=$accessvalue','5')><font class=linkrow>".html_tls_specialchars(addslashes(trim($drow[2])),ENT_QUOTES)."</font></a>";
			$drow[3]=str_replace("--","",str_replace("---","",$drow[3]));
			$grid[$j][3]=$this->convertSpecChars($drow[3]);
			$grid[$j][4]=$this->convertSpecChars($drow[9]);
			$grid[$j][5]=$this->convertSpecChars($res_status);
			$grid[$j][6]=$this->convertSpecChars($drow[4]);	
			
			$status = $drow[12];
            $con_id = $drow[1];
			
			/*if($drow[11]=="Applied")    Submit candidate link needs to show in submission window grid for Applied status--Raviprasad
			{
				$grid[$j][7]="";
				$grid[$j][8]="";	
				$grid[$j][9]="";
				$grid[$j][10]="";	
				$grid[$j][11]="";
				$grid[$j][12]="";
				$grid[$j][13]="";
			}*/
			
			if($res_status == "Placed" || $drow[7] == "INACTIVE" || $drow[7] == "backup" || $drow[7] == "HIDE")

            {
				if($res_status == "Placed")
					$grid[$j][7]="<a href=javascript:winopennew('notespopup.php?addr={$drow[0]}&posid={$req_id}','6')><i class='fa fa-file-text' title='Notes' alt='Notes'></i></a>";
				else
					$grid[$j][7]="";
				
				$grid[$j][8]="";	
				$grid[$j][9]="";
				$grid[$j][10]="";	
				$grid[$j][11]="";
				$grid[$j][12]="";
				
				if($res_status == "Placed")
					$grid[$j][13]="<a href=javascript:winopennew('viewjobs.php?candidateVal=".$drow[1]."&req_id=".$req_id."&cand_sno=".$drow[0]."&candid=".$drow[6]."&tol=".$contact_mail."&FromSubmit=yes&seqnumber=".$seqnumber."','4')><i alt='Placement Details' title='Placement Details' class='fa fa-tasks'></i></a>";
				else
					$grid[$j][13]="";			
			}
			else
			{
				
						/*Out look plugin */
						$EmailLink="javascript:winopennew('../../../Activities/email/Compose.php?candid=".$drow[1]."&req_id=".$req_id."&Came_From=Request','4')";					
						$subject="^Request^".$drow[1]."^".$req_id;
						$LinkEmailCont=$OutLookObj->CheckOutlookStatuseEMail(array('AkkenId'=>$drow[1],''),$EmailLink,'','','',$subject);
										
				$grid[$j][7]="<a href=javascript:winopennew('notespopup.php?addr={$drow[0]}&posid={$req_id}','6')><i class='fa fa-file-text' title='Notes' alt='Notes'></i></a>";	
				$grid[$j][8]="<a href=".$LinkEmailCont."><i alt='Request Interview' title='Request Interview' class='fa fa-book'></i></a>";
				$grid[$j][9]="<a href=javascript:confpopup('".$drow[1]."');><i alt='Setup Interview' title='Setup Interview' class='fa fa-user-plus'></i></a>";	
				$grid[$j][10]="<a href=javascript:winopennew_Interview('resumereviewf.php?addr=".$req_id."|".$drow[0]."|".rawurlencode($drow[12])."&subno=$subno&candidate_id=$con_id&seqnumber=$drow[15]','3',$j)><i alt='Update Status' title='Update Status' class='fa fa-ticket'></i></a>";
				
				
				
				if( $status != "Reject" )
                {
					if( $type != "Employee" )
                    {
						if(strtolower($manage_row)==strtolower("Direct"))
							$grid[$j][11]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."','4',$j)><i alt='Forward to Accounting' title='Forward to Accounting' class='fa fa-industry'></a>";
						else
							$grid[$j][11]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."','4',$j)><i alt='Forward to Hiring' title='Forward to Hiring' class='fa fa-industry'></i></a>";	
				   }
				    else
                     {
					 	$grid[$j][11]="<a href=javascript:winopennew_Interview('placement.php?addr=".$req_id."|".$drow[0]."&supid=".urlencode($drow[14])."&userid=$drow[1]&type=".urlencode($type)."&candidateVal=".$drow[1]."&cand_sno=".$drow[0]."&candid=".$drow[6]."&seqnumber=".$drow[15]."','4',$j)><i alt='Forward to Accounting' title='Forward to Accounting' class='fa fa-industry'></a>";	
					 }
			
			   }
			   else
			   {
			   		$grid[$j][11]="";
				}	   

				$grid[$j][12]="<a href=javascript:winopennew('Compose.php?msgunumber=".$seqnumber."&candidateVal=".$drow[0]."&req_stat=details&FromSubmit=yes&chk_count=1&re_submit=YES','5')><i alt='Re-Submit' title='Re-Submit' class='fa fa-list-alt'></i></a>";
				$grid[$j][13]="";	
			}

			$grid[$j][14]="<input type=hidden name='subinf$j' value='$hiddval'>";

			$j++;
		}
		return $grid;
	}

	//Functions for Admin/Data_Mngmt/Companies--Sandhya
	function buildAdminCompanies($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[7]."|".html_tls_specialchars($row[5],ENT_QUOTES)."|".$j."|".html_tls_specialchars($row[1],ENT_QUOTES)."|".$row[9]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[11]);		
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[12]);
			$grid[$j][7]=$this->convertSpecChars($row[5]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[10]);
			$grid[$j][10]='';
			$grid[$j][11]="/BSOS/Marketing/Companies/viewcompanySummary.php?addr=".$row[0]."&chkAuth=&module=Admin_Companies";
			$j++;
		}
		return $grid;
	}

	function getAdminCompanies($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$sysdb,$maindb,$companyuser;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
		
		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			//require("searchdatabase.inc");

			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);
			$adminsearch = "yes" ;
			require("quickSubCandidates.inc");	
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			
			require("visualsearch_companies_admin.php");
			require("database.inc");
		}
		else
		{
			$aqstr=" 1=1 ";
		}

		$asFields=array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.state",
		"IF (staffoppr_cinfo.accessto = 'all' , 'Public',IF (locate(',',staffoppr_cinfo.accessto)>0,'Share','Private'))","manage.name","users.name",tzRetQueryStringDTime('staffoppr_cinfo.cdate','Date','/'),tzRetQueryStringDTime('staffoppr_cinfo.mdate','Date','/'),"staffoppr_cinfo.owner","staffoppr_cinfo.city");

	    $ssFields=array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.city","staffoppr_cinfo.state","IF (staffoppr_cinfo.accessto = 'all' , 'Public',IF (locate(',',staffoppr_cinfo.accessto)>0,'Share','Private'))","manage.name","users.name","staffoppr_cinfo.cdate","staffoppr_cinfo.mdate","staffoppr_cinfo.owner");

		$tque="SELECT  count(distinct(staffoppr_cinfo.sno))  FROM staffoppr_cinfo LEFT JOIN users ON staffoppr_cinfo.owner=users.username LEFT JOIN manage ON staffoppr_cinfo.compstatus=manage.sno  
		WHERE $aqstr AND staffoppr_cinfo.status = 'ER' and crmcompany='Y'";

		$oque="SELECT staffoppr_cinfo.sno,staffoppr_cinfo.cname,staffoppr_cinfo.phone,staffoppr_cinfo.state,
		IF (staffoppr_cinfo.accessto = 'all' , 'Public',
		IF (locate(',',staffoppr_cinfo.accessto)>0,'Share','Private')),     users.name,'',staffoppr_cinfo.owner,".tzRetQueryStringDTime('staffoppr_cinfo.cdate','Date','/').",staffoppr_cinfo.acc_comp,".tzRetQueryStringDTime('staffoppr_cinfo.mdate','Date','/').", staffoppr_cinfo.city,manage.name
        FROM staffoppr_cinfo LEFT JOIN users ON staffoppr_cinfo.owner=users.username LEFT JOIN manage ON staffoppr_cinfo.compstatus=manage.sno
        WHERE $aqstr AND staffoppr_cinfo.status = 'ER' and crmcompany='Y'";
        
        $grpque=" group by staffoppr_cinfo.sno";

		$CompanyCond = "";
		if($gridSearchFields[4] != "")
		{
			$CompanyCond=" AND manage.name = '".$gridSearchFields[4]."' ";
			$gridSearchFields[4] = "";
		}
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('staffoppr_cinfo.phone',$asFields)){
			$asFieldsKey = array_search("staffoppr_cinfo.phone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_cinfo.phone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_cinfo.phone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr.$CompanyCond, $ostr);
        $oque="$oque $qstr $CompanyCond $grpque $ostr $lstr";

    	$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminCompanies($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	//Functions for Admin/Data_Mngmt/Companies/ViewArchive	
	function buildAdminCompaniesHis($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[7]."|".$row[5]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]='';
       	    $grid[$j][6]="hisreviewmanage.php?addr=".$row[0];
			$j++;
		}
		return $grid;
	}

	function getAdminCompaniesHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
		global $maildb,$db,$username;
		
		$gd=new gridData();
		$asFields=
		array("","staffoppr_cinfo.cname","staffoppr_cinfo.phone","staffoppr_cinfo.state","users.name","staffoppr_cinfo.owner");

		$tque="SELECT count(distinct(staffoppr_cinfo.sno)) FROM staffoppr_cinfo 
		LEFT JOIN users ON (staffoppr_cinfo.owner = users.username) 
		WHERE staffoppr_cinfo.status = 'INACTIVE' and crmcompany='Y'";

		$oque="SELECT staffoppr_cinfo.sno,staffoppr_cinfo.cname,staffoppr_cinfo.phone, staffoppr_cinfo.state, users.name,'',      
        staffoppr_cinfo.owner FROM staffoppr_cinfo
        LEFT JOIN users ON (staffoppr_cinfo.owner = users.username)
        WHERE staffoppr_cinfo.status = 'INACTIVE'  and crmcompany='Y'";

		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('staffoppr_cinfo.phone',$asFields)){
			$asFieldsKey = array_search("staffoppr_cinfo.phone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_cinfo.phone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_cinfo.phone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
		$grpque=" group by staffoppr_cinfo.sno";
        $oque="$oque $qstr $grpque $ostr $lstr";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminCompaniesHis($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	function getAdminContacts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$pageFrom,$groupId,$sysdb,$maindb,$companyuser;

		$_SESSION['admincontactswhereclause'] = '';

		if($gridSortCol=="")
		$gridSortCol=1;

		$acs="";//variable for passing access permissions
		$gd=new gridData();

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);
			$adminsearch = "yes" ; 
			require("quickSubCandidates.inc");
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);
			$customesearch = true;			
			require("visualsearch_contacts_admin.php");
			require("database.inc");
		}
		else
		{
			$aqstr=" 1=1 ";
		}		
		
		if($gridSortCol == 8)//Category col header clicked case for sorting...
		{
			$fetchCategory = "(select group_concat(manage.name) category from manage where type='category' and find_in_set(manage.sno,staffoppr_contact.cat_id)) cat";
		}
		else
		{
			$fetchCategory = "staffoppr_contact.cat_id cat";
		}
		if($stat=="ER")//Active Contacts
		{
			$asFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.ytitle","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","staffoppr_contact.cat_id","IF(staffoppr_contact.accessto = 'ALL' or staffoppr_contact.accessto = '' or staffoppr_contact.accessto is null,'Public',IF(locate(',',staffoppr_contact.accessto)>0,'Share','Private'))","users.name",tzRetQueryStringDTime('staffoppr_contact.stime','Date','/'),tzRetQueryStringDTime('staffoppr_contact.mdate','Date','/'));
		
			$ssFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.ytitle","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","cat","IF(staffoppr_contact.accessto = 'ALL' or staffoppr_contact.accessto = '' or staffoppr_contact.accessto is null,'Public',IF(locate(',',staffoppr_contact.accessto)>0,'Share','Private'))","trim(users.name)","staffoppr_contact.stime","staffoppr_contact.mdate");
			
			if($pageFrom == "crmGroups") {
				$crmGroupTable=",crmgroup_details";
				$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."' AND crmgroup_details.refid=staffoppr_contact.sno";
			}

			//$acs=" AND crmcontact='Y' ";
		}
		else
		{   //Archived Contacts
			$asFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","staffoppr_contact.cat_id","users.name");
			
			$ssFields=array("","staffoppr_contact.fname","staffoppr_contact.lname","staffoppr_cinfo.cname","staffoppr_contact.email","staffoppr_contact.wphone","staffoppr_contact.state","cat","trim(users.name)");

			//$acs=" AND crmcontact='Y' ";
		}
		
		//prasadd-optimized fetching queries...
		$tque="SELECT COUNT(1) FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username ".$crmGroupTable." WHERE $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition;						

		$oque="SELECT 
			staffoppr_contact.sno, 
			staffoppr_contact.fname,
            staffoppr_contact.lname,
			IF(staffoppr_cinfo.cname = '', staffoppr_cinfo.cname, 
			CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'Admin_Companies\')>', staffoppr_cinfo.cname, '</a>')),
			staffoppr_contact.email, 
			staffoppr_contact.wphone,
			staffoppr_contact.state,
			$fetchCategory,
			IF(staffoppr_contact.accessto = 'ALL' or staffoppr_contact.accessto = '' or staffoppr_contact.accessto is null,'Public',IF(locate(',',staffoppr_contact.accessto)>0,'Share','Private')), users.name,staffoppr_contact.owner,".tzRetQueryStringDTime('staffoppr_contact.stime','Date','/').",".tzRetQueryStringDTime('staffoppr_contact.mdate','Date','/').",staffoppr_contact.ytitle FROM staffoppr_contact LEFT JOIN staffoppr_cinfo ON staffoppr_contact.csno=staffoppr_cinfo.sno LEFT JOIN users force index(primary) ON staffoppr_contact.owner = users.username ".$crmGroupTable." WHERE  $aqstr AND staffoppr_contact.status ='$stat' ".$crmGroupCondition;
			
        //For checking contacts duplicates and displaying the search result on main grid.
        if($gridExtraFields['duplicate']== "yes")
        {
            $gridSearchFields[0] = $gd->gridSearchFieldConvert($gridSearchFields[0]);
            $gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
            $gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);
            
            $duplicateCheck = $gd->duplicateContactChecking($gridSearchFields[0],$gridSearchFields[1],$gridSearchFields[4]);
            $tque.=$duplicateCheck;
            $oque.=$duplicateCheck;
            $gridSearchFields[0] = "";
            $gridSearchFields[1] = "";
            $gridSearchFields[4] = "";
        }
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('staffoppr_contact.wphone',$asFields)){
			$asFieldsKey = array_search("staffoppr_contact.wphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("staffoppr_contact.wphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("staffoppr_contact.wphone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		//$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,'6');
		$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,'7|8');
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,'');
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildContacts($oque,$gridSortCol,'','Admin_Contacts');

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$gridRecords,$oque);
		
		//Registering the where clause to use in export
		$_SESSION['admincontactswhereclause'] = " $qstr $ostr $lstr ";
		
		return $objResponse;
	}

	
	/* To Display XAJAX Grid in ADMIN -> Data Management -> Contacts Page  --------------- END  */
	
	
	//XAJAX grid in Admin-> Data Management-> Candidates
	function getAdminCandidates($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$user_timezone,$tempvalue;

		$searchCond="";
		$duplicateCheck = ""; // For candidates duplicate checking
		$crmGroupTable="";
		$crmGroupCondition = "";
		
		require("zipCodeSearch.inc");

		$gd=new gridData();

		$tque="SELECT count(1) ";

		$oque="SELECT
		candidate_list.sno as sno,
		candidate_list.username as username,
		candidate_list.profiletitle profiletitle,
		candidate_list.fname as fname,
		candidate_list.lname as lname,
		candidate_list.recentemp as company,
		candidate_list.email as email,
		candidate_list.hphone as hphone,
		candidate_list.wphone as wphone,
		candidate_list.mobile as mobile,
		candidate_list.hareacode as hareacode,
		candidate_list.wareacode as wareacode,
		candidate_list.mareacode as mareacode,
		candidate_list.city as city,
		candidate_list.state as state,
		candidate_list.zip as zip,
		IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as candtype,
		candidate_list.accessto as shrtype,
		candidate_list.avail as candavl,
		users.name as owname,
		".tzRetQueryStringDTime('candidate_list.ctime','Date','/')." as crdate,
		".tzRetQueryStringDTime('candidate_list.mtime','Date','/')." as mddate,
		candidate_list.resid as resid,
		candidate_list.owner as owner,
		manage.name as mgname, 
		candidate_list.cl_source as source,
		mg.name as sourcetype,
		candidate_list.emplstatus as emplstatus
		";

		//Added by vijaya to provide checking for duplicate candidates.		
		if($gridExtraFields['duplicate']== "yes")
		{
			$gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
			$gridSearchFields[2] = $gd->gridSearchFieldConvert($gridSearchFields[2]);
			$gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);

			$duplicateCheck = $gd->duplicateCandidateChecking($gridSearchFields[1],$gridSearchFields[2],$gridSearchFields[4]);
		}
		else
		{
			if(trim($gridExtraFields['resume'])!=""  || ($gridExtraFields['SpeedSearchString']!='' &&  $gridExtraFields['SpeedSearchString']!='?'))
			{
				//require("searchdatabase.inc");

				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);
				$adminsearch = "yes";
				require("quickSubCandidates.inc");				
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);
				
				require("visualsearch_candidates_admin.php");
				require("database.inc");
			}
		}

		if($aqstr=="")
			$aqstr=" 1=1 ";

		if($gridExtraFields['pageFrom'] == "crmGroups")
		{
			$crmGroupTable="crmgroup_details,";
			$crmGroupCondition = " AND crmgroup_details.groupid='".$gridExtraFields['groupId']."' AND crmgroup_details.refid=candidate_list.sno";
		}
		
		$tque.=" FROM ".$searchCond. $crmGroupTable." candidate_list LEFT JOIN users ON candidate_list.owner=users.username LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno ";
		$tque.=" WHERE candidate_list.status='ACTIVE' ".$crmGroupCondition." AND ".$aqstr." ";
		$oque.=" FROM ".$searchCond.$crmGroupTable." candidate_list LEFT JOIN users ON candidate_list.owner=users.username LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno ";
		//$oque.=" LEFT JOIN emp_list ON CONCAT('emp',emp_list.sno)=candidate_list.candid ";
		$oque.=" WHERE candidate_list.status='ACTIVE' ".$crmGroupCondition." AND ".$aqstr." ";	
		
		if($gridExtraFields['checklist'] != ''){ //Duplicate Candidates matching ID from Duplicate screen
			$oque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";
			$tque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";		
		}
			$asFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto = 'ALL', 'Public',IF(LOCATE(',', candidate_list.accessto), 'Share', 'Private'))","candidate_list.avail","users.name","candidate_list.cl_source","mg.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/'),tzRetQueryStringDTime('candidate_list.mtime','Date','/'),"");

			$ssFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto = 'ALL', 'Public',IF(LOCATE(',', candidate_list.accessto), 'Share', 'Private'))","candidate_list.avail","users.name","candidate_list.cl_source","mg.name","candidate_list.ctime","candidate_list.mtime","");
			
            if($ssFields[$gridSortCol]=='candidate_list.avail'){ // donot change the column name fetching
                $ostr ="ORDER BY IF(candidate_list.avail IN('Inactive','Immediate'),candidate_list.avail,DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d')) ".$gridSort ;
            }else{
                $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            }

 		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$CandiateCond = "";
		if($gridSearchFields[11] != "")
		{
			$CandiateCond.=" AND IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) = '".$gridSearchFields[11]."' ";
			$gridSearchFields[11] = "";
		}

		if($gridSearchFields[12] != "")
		{
			$CandiateCond = " AND manage.name = '".$gridSearchFields[12]."' ";
			$gridSearchFields[12] = "";
		}
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.wphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.wphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.mobile',$asFields)){
			$asFieldsKey = array_search("candidate_list.mobile", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
		}
		if($gridExtraFields['duplicate']!="yes")
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		else
			$qstr=$duplicateCheck;

		$tque=$gd->buildTQuery($tque,$qstr.$CandiateCond,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr.$CandiateCond,$ostr,$lstr,$gstr);

		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{

			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}

		$gridData=$gd->buildAdminCandidates($oque,$gridSortCol,$gridSort);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	//XAJAX grid in Admin-> Data Management-> Candidates
	function buildAdminCandidates($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			if((trim($row['fname']).trim($row['lname']))=="")
				$candAlert=trim($row['profiletitle']);
			else
				$candAlert=trim(trim($row['fname'])." ".trim($row['lname']));

			$cshare="Private";
			if($row['shrtype']==$username)
			{
				$cshare="Private";
			}
			else if(strtoupper($row['shrtype']) =='ALL')
			{
				$cshare="Public";
			}
			else if(strpos($row['shrtype'],",")>0)
			{
				$cshare="Share";
			}
			$row['shrtype'] = $cshare;

			$resume_link = "";
			if($row['resid']!="" && $row['resid']!=0)
				$resume_link="<a href=getresume.php?fsno=".$row['resid']." target='_top'><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";

			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row['sno']."|".$row['candtype']."|".$row['owner']."|".$row['shrtype']."|".html_tls_specialchars($candAlert,ENT_QUOTES)."|".$j."|".$row['username']."|".$row['emplstatus']."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
			$grid[$j][2]=$this->convertSpecChars($row['fname']);
			$grid[$j][3]=$this->convertSpecChars($row['lname']);
			$grid[$j][4]=$this->convertSpecChars($row['company']);
			$grid[$j][5]=$this->convertSpecChars($row['email']);
			$grid[$j][6]=$this->convertSpecChars($row['hphone']);
			$grid[$j][7]=$this->convertSpecChars($row['wphone']);
			$grid[$j][8]=$this->convertSpecChars($row['mobile']);			
			$grid[$j][9]=$this->convertSpecChars($row['city']);
			$grid[$j][10]=$this->convertSpecChars($row['state']);
			$grid[$j][11]=$this->convertSpecChars($row['zip']);			
			$grid[$j][12]=$this->convertSpecChars($row['candtype']);
			$grid[$j][13]=$this->convertSpecChars($row['mgname']);
			$grid[$j][14]=$this->convertSpecChars($row['shrtype']);
			$grid[$j][15]=$this->convertSpecChars($row['candavl']);
			$grid[$j][16]=$this->convertSpecChars($row['owname']);	
			$grid[$j][17]=$this->convertSpecChars($row['source']);			
			$grid[$j][18]=$this->convertSpecChars($row['sourcetype']);			

			$grid[$j][19]=$this->convertSpecChars($row['crdate']);
			$grid[$j][20]=$this->convertSpecChars($row['mddate']);
			$grid[$j][21]=$resume_link;
			$grid[$j][22]="";
			$grid[$j][23]="/BSOS/Marketing/Candidates/review.php?cno=".$row['sno']."&dest=0&module=Admin_Candidates";
			$j++;
		}

		return $grid;
	}
	

	//xajax grid for admin usermanagement New Employees -Kiran
	function getAdminUserManHireEmpData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{		
		global $maildb,$db,$username,$stat,$user_timezone,$acctype;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields=array("","CONCAT(emp_list.sno,' - ',emp_list.name)","department.deptname",
			"users.name",tzRetQueryStringDTime("emp_list.stime","DateTime","/"));	
		$ssFields=array("","emp_list.sno","department.deptname","users.name","emp_list.stime");

		if($acctype=="SSU")
		{
			$tque="SELECT count(DISTINCT applicants.username) FROM applicants  LEFT JOIN emp_list ON applicants.username = emp_list.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON users.username = emp_list.approveuser WHERE applicants.astatus = 'hire'  AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y'";

			$oque="SELECT applicants.username, emp_list.name, CONCAT(emp_list.sno,' - ',emp_list.name), department.deptname,  users.name, ".tzRetQueryStringDTime("emp_list.stime","DateTime","/")." FROM applicants  LEFT JOIN emp_list ON applicants.username = emp_list.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON users.username = emp_list.approveuser WHERE applicants.astatus = 'hire' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y'";
		}
		else
		{
			$tque="SELECT count(DISTINCT applicants.username) FROM applicants  LEFT JOIN emp_list ON applicants.username = emp_list.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON users.username = emp_list.approveuser WHERE applicants.astatus = 'hire'  AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y'";

			$oque="SELECT applicants.username, emp_list.name, CONCAT(emp_list.sno,' - ',emp_list.name), department.deptname,  users.name, ".tzRetQueryStringDTime("emp_list.stime","DateTime","/")." FROM applicants  LEFT JOIN emp_list ON applicants.username = emp_list.username LEFT JOIN department ON department.sno = emp_list.emp_department AND department.status = 'Active' LEFT JOIN users ON users.username = emp_list.approveuser WHERE applicants.astatus = 'hire' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y'";
		}

		$gstr=" GROUP BY applicants.username ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminUserManHireEmpData($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
		//xajax grid data for admin usermanagement New Employees -Kiran
	function buildAdminUserManHireEmpData($que)
	{
		global $maildb,$db,$stat,$acctype;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$j."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[2]);
			$grid[$j][2]=$this->convertSpecChars($row[3]);
			$grid[$j][3]=$this->convertSpecChars($row[4]);
			$grid[$j][4]=$this->convertSpecChars($row[5]);
			

			if($acctype=="SSU")
				$grid[$j][5]="<a href=ssuemp1.php?acctype=$acctype&multiuser=No&abstat=yes&addr=".$row[0]." target='_top'>Create User</a>";
			else
				$grid[$j][5]="<a href=newemp1.php?acctype=$acctype&multiuser=No&abstat=yes&addr=".$row[0]." target='_top'>Create User</a>";
			$j++;
		}
		
		return $grid;
	}
	
	
	//xajax grid for admin usermanagement New Consultants -Kiran
	function getAdminUserManNewConsultantData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("","consultant_list.name","IF(consultant_list.A2M = 'Y','CRM','Pipeline')",tzRetQueryStringDTime("consultant_list.stime","DateTime","/"),"users.name");
		$ssFields = array("","consultant_list.name","IF(consultant_list.A2M = 'Y','CRM','Pipeline')","consultant_list.stime","users.name");

		$tque="SELECT COUNT(1) FROM consultant_list LEFT JOIN users ON users.username=consultant_list.approveuser LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username WHERE TRIM(consultant_general.email)!='' AND consultant_list.astatus='ACTIVE' AND consultant_list.serial_no NOT IN (SELECT consultant_list.serial_no FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username WHERE users.type='cand') AND consultant_general.email NOT IN (select userid from users)";
		$oque="SELECT consultant_list.serial_no,consultant_list.name,IF(consultant_list.A2M = 'Y','CRM','Pipeline'),".tzRetQueryStringDTime("consultant_list.stime","DateTime","/").",users.name FROM consultant_list LEFT JOIN users ON users.username=consultant_list.approveuser LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username WHERE TRIM(consultant_general.email)!='' AND consultant_list.astatus='ACTIVE' AND consultant_list.serial_no NOT IN (SELECT consultant_list.serial_no FROM consultant_list LEFT JOIN api_consultant_list ON consultant_list.serial_no=api_consultant_list.consultant_id LEFT JOIN users ON users.username=api_consultant_list.username WHERE users.type='cand') AND consultant_general.email NOT IN (select userid from users)";
			
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminUserManNewConsultantData($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	//xajax grid data for admin usermanagement New Consultants -Kiran
	function buildAdminUserManNewConsultantData($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$j."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]="<a href=conacc.php?acctype=APP&addr=".$row[0]." target='_top'>Create User</a>";
			$j++;
		}		
		return $grid;
	}


	function buildPlacementspl($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{ 	
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$j."|".$row[19]."|".$row[6]."|".$row[15]."|".$row[34]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[8]); // Company name
			$grid[$j][2] = $this->convertSpecChars($row[3]); // Candidate Name
			$grid[$j][3] = $this->convertSpecChars($row[9]); // Job Location

			if($row[10] == '00/00/0000')
				$row[10] = "";

			$grid[$j][4] = $this->convertSpecChars($row[10]); //startdate

			if($row[11] == '00/00/0000')
				$row[11] = "";

			$grid[$j][5] = $this->convertSpecChars($row[11]); //end date
			$grid[$j][6] = $this->convertSpecChars($row[15]); // Job type

			if($row[16] == '00/00/0000')
				$row[16] = '';

			$grid[$j][7] = $this->convertSpecChars($row[16]); // Placed Date
			$grid[$j][8] = $this->convertSpecChars($row[17]); //Assignement ID
			$grid[$j][9] = $this->convertSpecChars($row[18]); // Assignment Name
			$grid[$j][10] = $this->convertSpecChars($row[19]); // Assignment Status
			$grid[$j][11] = $this->convertSpecChars($row[20]); // Date Ended

			if($grid[$j][11] == "00/00/0000")
				$grid[$j][11] = "";

			$grid[$j][12] = $this->convertSpecChars($row[31]); //Joborder Owner
			$grid[$j][13] = $this->convertSpecChars($row[22]); //cdate
			$grid[$j][14] = $this->convertSpecChars($row[12]); //cuser
			$grid[$j][15] = $this->convertSpecChars($row[24]); //mdate
			$grid[$j][16] = $this->convertSpecChars($row[13]); //muser
			$grid[$j][17] = '';
			$grid[$j][18] = "getdetails.php?sno=$row[6]&rec=$row[0]|15|$row[19]|$row[6]&candname=$row[3]&table=$row[34]&assg_status=$row[19]&rec1=$row[0]&jval=$j";

			$j++;
		}
		return $grid;
	}

	function getPlacementspl($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol == "")
			$gridSortCol = 1;

		$gridSearchFields[4] = strtoupper($gridSearchFields[4]);

		if($gridSearchFields[11]!="" && $gridSearchFields[11] == 'pending')
        {
			$pending = "AND empcon_jobs.assg_status='pending'";
			$pending1 = "AND placement_jobs.assg_status='Needs Approval'";
			$pending2 = "AND hrcon_jobs.ustatus='Needs Approval'";
			$gridSearchFields[11] = "";
        }
		else
		{
			$pending = "";
		}

		// If the search is job type then it has to display in unique way so added AND condition
		if($gridSearchFields[5]!="")
		{
			$jobtype = " AND (manage.name = '$gridSearchFields[5]')";
			$gridSearchFields[5] = "";
		}

		$gd = new gridData();

		$empcons_ssFields = array("","staffacc_cinfo.cname","trim(emp_list.name)","CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode)",tzRetQueryStringSTRTODate('empcon_jobs.s_date','%m-%d-%Y','Date','/'),tzRetQueryStringSTRTODate('empcon_jobs.e_date','%m-%d-%Y','Date','/'),"manage.name",tzRetQueryStringDTime('empcon_jobs.date_placed','Date','/'),"empcon_jobs.pusername","empcon_jobs.project","empcon_jobs.assg_status","if(".tzRetQueryStringDTime('empcon_jobs.date_ended','Date','/')."!='00/00/0000','','')","usersowner.name",tzRetQueryStringDTime('empcon_jobs.cdate','DateTime','/'),"cuser.name",tzRetQueryStringDTime('empcon_jobs.mdate','DateTime','/'),"muser.name");
		
		$hrcons_ssFields = array("","staffacc_cinfo.cname","trim(emp_list.name)","CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode)",tzRetQueryStringSTRTODate('hrcon_jobs.s_date','%m-%d-%Y','Date','/'),	tzRetQueryStringSTRTODate('hrcon_jobs.e_date','%m-%d-%Y','Date','/'),"manage.name",tzRetQueryStringDTime('hrcon_jobs.date_placed','Date','/'),"hrcon_jobs.pusername","hrcon_jobs.project","hrcon_jobs.ustatus","if(".tzRetQueryStringDTime('hrcon_jobs.date_ended','Date','/')."!='00/00/0000',".tzRetQueryStringDTime('hrcon_jobs.date_ended','Date','/').",'')","usersowner.name",tzRetQueryStringDTime('hrcon_jobs.cdate','DateTime','/'),"cuser.name",tzRetQueryStringDTime('hrcon_jobs.mdate','DateTime','/'),"muser.name");
		
		$placements_ssFields = array("","trim(a.cname)","CONCAT_WS(' ',candidate_list.fname,candidate_list.mname,candidate_list.lname)","CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode)",tzRetQueryStringSTRTODate('placement_jobs.s_date','%m-%d-Y','Date','/'),tzRetQueryStringSTRTODate('placement_jobs.e_date','%m-%d-Y','Date','/'),"manage.name",tzRetQueryStringDTime('placement_jobs.date_placed','Date','/'),"placement_jobs.pusername","placement_jobs.project","placement_jobs.assg_status","if(".tzRetQueryStringDTime('placement_jobs.date_ended','Date','/')."!='00/00/0000','','')","usersowner.name",tzRetQueryStringDTime('placement_jobs.cdate','DateTime','/'),"cuser.name",tzRetQueryStringDTime('placement_jobs.mdate','DateTime','/'),"muser.name");

		// For sorting the grid, union query doesn't takes field names to sort so used numbers for the field names
		// Numbers are taken as in the query, check the following for reference 
		// grid_data[0]->sno => emp_list.sno(positioned in the query as 1) so given as 0=>1
		// grid_data[1]->company => staffacc_cinfo.cname(positioned in the query as 9) so given as 1=>9
		// grid_data[2]->candidate => emp_list.name(positioned in the query as 4) so given as 2=>4
		// grid_data[3]->Type => empcon_w4.tax(positioned in the query as 26) so given as 3=>26

		$asFields	= array(0=>1,1=>9,2=>4,3=>10,4=>28,5=>29,6=>16,7=>36,8=>18,9=>19,10=>27,11=>37,12=>32,13=>30,14=>13,15=>31,16=>14);

		// empcon_jobs query
		$empcon_query = "SELECT 
							emp_list.sno,
							empcon_jobs.client,
							trim(emp_list.username),
							trim(emp_list.name),
							empcon_jobs.endclient,
							empcon_jobs.jtype,
							empcon_jobs.sno,
							empcon_jobs.jotype,
							trim(staffacc_cinfo.cname) CompanyName,
							CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode) Location,
							".tzRetQueryStringSTRTODate('empcon_jobs.s_date','%m-%d-%Y','Date','/').",
							".tzRetQueryStringSTRTODate('empcon_jobs.e_date','%m-%d-%Y','Date','/').",
							cuser.name cuser,
							muser.name muser,
							'',
							manage.name,
							".tzRetQueryStringDTime('empcon_jobs.date_placed','Date','/').",
							empcon_jobs.pusername 'Assignment ID',
							empcon_jobs.project 'Assignment Name',
							if(empcon_jobs.assg_status='approved','Active','Needs Approval') 'Assignment Status',
							'',
							empcon_jobs.owner,
							".tzRetQueryStringDTime('empcon_jobs.cdate','DateTime','/').",
							empcon_jobs.muser,
							".tzRetQueryStringDTime('empcon_jobs.mdate','DateTime','/').",
							'',
							empcon_jobs.assg_status,
							STR_TO_DATE(empcon_jobs.s_date,'%m-%d-%Y'),
							STR_TO_DATE(empcon_jobs.e_date,'%m-%d-%Y'),
							empcon_jobs.cdate,
							empcon_jobs.mdate,
							usersowner.name,
							'',
							'',
							if(empcon_jobs.assg_status IN('approved','pending'),'empcon','empcon'),
							empcon_jobs.date_placed,
							'' 
							FROM emp_list 
							LEFT JOIN empcon_jobs ON emp_list.username = empcon_jobs.username 
							LEFT JOIN staffacc_cinfo ON empcon_jobs.client=staffacc_cinfo.sno 
							LEFT JOIN staffacc_location jloc ON empcon_jobs.endclient=jloc.sno 
							LEFT JOIN users cuser ON cuser.username=empcon_jobs.owner 
							LEFT JOIN users muser ON muser.username=empcon_jobs.muser 
							LEFT JOIN manage ON empcon_jobs.jotype=manage.sno AND manage.type='jotype'  
							LEFT JOIN posdesc ON posdesc.posid = empcon_jobs.posid 
							LEFT JOIN users usersowner ON usersowner.username = posdesc.owner 
							WHERE emp_list.lstatus!='DA' 
							AND (empcon_jobs.assg_status IN('approved','pending')) 
							AND empcon_jobs.jtype!='' 
							AND empcon_jobs.jotype!=0 
							AND empcon_jobs.owner=$username";

		// hrcon_jobs query
		$hrcon_query = "SELECT 
							emp_list.sno,
							hrcon_jobs.client,
							trim(emp_list.username),
							trim(emp_list.name),
							hrcon_jobs.endclient,
							hrcon_jobs.jtype,
							hrcon_jobs.sno,
							hrcon_jobs.jotype,
							trim(staffacc_cinfo.cname) CompanyName,
							CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode) Location,
							".tzRetQueryStringSTRTODate('hrcon_jobs.s_date','%m-%d-%Y','Date','/').",
							".tzRetQueryStringSTRTODate('hrcon_jobs.e_date','%m-%d-%Y','Date','/').",
							cuser.name cuser,
							muser.name muser,
							'',
							manage.name,
							".tzRetQueryStringDTime('hrcon_jobs.date_placed','Date','/').",
							hrcon_jobs.pusername 'Assignment ID',
							hrcon_jobs.project 'Assignment Name',
							if(hrcon_jobs.ustatus='active','Active',if(hrcon_jobs.ustatus='cancel','Cancelled','Closed')) 'Assignment Status',
							".tzRetQueryStringDTime('hrcon_jobs.date_ended','Date','/')." 'Date Ended',
							hrcon_jobs.owner,
							".tzRetQueryStringDTime('hrcon_jobs.cdate','DateTime','/').",
							hrcon_jobs.muser,
							".tzRetQueryStringDTime('hrcon_jobs.mdate','DateTime','/').",
							'',
							hrcon_jobs.ustatus,
							STR_TO_DATE(hrcon_jobs.s_date,'%m-%d-%Y'),
							STR_TO_DATE(hrcon_jobs.e_date,'%m-%d-%Y'),
							hrcon_jobs.cdate,
							hrcon_jobs.mdate,
							usersowner.name,
							'',
							STR_TO_DATE(hrcon_jobs.e_date,'%m-%d-%Y'),
							if(hrcon_jobs.ustatus in ('closed','cancel'),'hrcon','hrcon'),
							hrcon_jobs.date_placed,
							hrcon_jobs.date_ended 
							FROM emp_list 
							LEFT JOIN hrcon_jobs ON emp_list.username = hrcon_jobs.username 
							LEFT JOIN staffacc_cinfo ON hrcon_jobs.client=staffacc_cinfo.sno 
							LEFT JOIN staffacc_location jloc ON hrcon_jobs.endclient=jloc.sno 
							LEFT JOIN users cuser ON cuser.username=hrcon_jobs.owner 
							LEFT JOIN users muser ON muser.username=hrcon_jobs.muser 
							LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno AND manage.type='jotype' 
							LEFT JOIN posdesc ON posdesc.posid = hrcon_jobs.posid 
							LEFT JOIN users usersowner ON usersowner.username = posdesc.owner 
							WHERE emp_list.lstatus!='DA' 
							AND (hrcon_jobs.ustatus in ('closed','cancel')) 
							AND hrcon_jobs.jtype!='' 
							AND hrcon_jobs.jotype!=0 
							AND hrcon_jobs.owner=$username ";

		$placements_query = "SELECT 
								placement_jobs.sno,
								'',
								trim(placement_jobs.username),
								CONCAT_WS(' ',candidate_list.fname,candidate_list.mname,candidate_list.lname),
								'',
								placement_jobs.jtype,
								placement_jobs.sno,
								placement_jobs.jotype,
								trim(a.cname) CompanyName,
								CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode) Location,
								".tzRetQueryStringSTRTODate("placement_jobs.s_date","%m-%d-%Y","Date","/").",
								".tzRetQueryStringSTRTODate('placement_jobs.e_date','%m-%d-%Y','Date','/').",
								cuser.name cuser,
								muser.name muser,
								'',
								manage.name,
								".tzRetQueryStringDTime('placement_jobs.date_placed','Date','/').",
								placement_jobs.pusername 'Assignment ID',
								placement_jobs.project 'Assignment Name',
								if(placement_jobs.assg_status='Needs Approval', 'Needs Approval' ,'') 'Assignment Status',
								'',
								placement_jobs.owner,
								".tzRetQueryStringDTime('placement_jobs.cdate','DateTime','/').",
								placement_jobs.muser,
								".tzRetQueryStringDTime('placement_jobs.mdate ','DateTime','/').",
								'',
								placement_jobs.assg_status,
								if(placement_jobs.s_date!='0-0-0',STR_TO_DATE(placement_jobs.s_date,'%m-%d-%Y'),''),
								if(placement_jobs.e_date!='0-0-0',STR_TO_DATE(placement_jobs.e_date,'%m-%d-%Y'),''),
								placement_jobs.cdate,
								placement_jobs.mdate,
								usersowner.name,
								'',
								'',
								if(placement_jobs.assg_status='Needs Approval','placement','placement'),
								placement_jobs.date_placed,
								'' 
								FROM candidate_list, placement_jobs 
								LEFT JOIN manage ON placement_jobs.jotype = manage.sno 
								LEFT JOIN staffacc_cinfo a ON a.sno = placement_jobs.client 
								LEFT JOIN staffacc_location jloc ON jloc.sno = placement_jobs.endclient 
								LEFT JOIN users cuser ON cuser.username = placement_jobs.owner 
								LEFT JOIN users muser ON muser.username = placement_jobs.muser 
								LEFT JOIN posdesc ON posdesc.posid = placement_jobs.posid 
								LEFT JOIN users usersowner ON usersowner.username = posdesc.owner 
								WHERE placement_jobs.candidate = candidate_list.username 
								AND candidate_list.candid NOT LIKE 'emp%' 
								AND candidate_list.candid != '' 
								AND candidate_list.candid IS NOT NULL 
								AND placement_jobs.jtype != '' 
								AND placement_jobs.jotype != '0' 
								AND placement_jobs.assg_status = 'Needs Approval' 
								AND placement_jobs.owner=$username";

		$empcon_group_by = " group by empcon_jobs.sno "; // group by empconjobs sno
		$hrcon_group_by = " group by hrcon_jobs.sno "; // group by hrconjobs sno
		$placement_group_by = " group by placement_jobs.sno "; // group by placementjobs sno

		$lstr = $gd->buildLimt($gridPage,$gridRecords); // Limit of the records display in the grid

		$emp_qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$empcons_ssFields).$jobtype.$pending; // For emp_con table sort fields
		$hr_qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$hrcons_ssFields).$jobtype.$pending2;  // For hrcon table sort
                if($gridSearchFields[9] == "pending"){
                    $gridSearchFields[9] = "";
                }
		$placement_qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$placements_ssFields).$jobtype.$pending1;  

		// For Placement table sort fields

        // Added group by condition
		$query_empcon = "$empcon_query $emp_qstr $empcon_group_by";
		$query_hrcon = "$hrcon_query $hr_qstr $hrcon_group_by";
		$query_placement = "$placements_query $placement_qstr $placement_group_by";

		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by Query
		$query	= "($query_empcon) UNION ($query_hrcon) UNION ($query_placement) $ostr $lstr"; // Final  Query
                $query_count	= "($query_empcon) UNION ($query_hrcon) UNION ($query_placement) $ostr";

		$fet_data = mysql_query($query,$db);	// Using the same query to find the count
                $fet_data_count = mysql_query($query_count,$db);	// Using the same query to find the count
		$total = mysql_num_rows($fet_data_count);				
		$gridData=$gd->buildPlacementspl($query);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$query,'#####');

		return $objResponse;
	}
	//////////// End of CRM - Placements /////////////

	// New Assignment Grid Query

	function getAssignments($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{		
		global $maildb,$db,$username,$user_timezone;

		$dque="select group_concat(sno) from department where FIND_IN_SET(CONCAT('+','".$username."','+'),REPLACE(CONCAT('+',permission,'+'),',','+,+'))>0";
		$dres=mysql_query($dque,$db);
		$drow=mysql_fetch_row($dres);
		$deptnos = $drow[0];

		if($deptnos=="")
			$deptnos="0";

		$gd=new gridData();
		$hrUstatusCond = "";
		$gridSearchFields[0] = strtolower($gridSearchFields[0]);
		$gridSearchFields[1]= strtolower($gridSearchFields[1]);
		//$gridSearchFields[2]= strtolower($gridSearchFields[2]);
		//print_r($gridSearchFields);
		if ($gridSearchFields[2]=="") {
			$gridSearchFields[2]="";
			$hrUstatusCond = "AND hrcon_jobs.ustatus in('active','pending','closed','cancel')";
		}
		else if($gridSearchFields[2]=="Active and Needs Approval")
		{
			$gridSearchFields[2]="";
			$showActivePending="Yes";
			$hrUstatusCond = "AND hrcon_jobs.ustatus in('active','pending')";
		}
		else{

			if ($gridSearchFields[2] == "Active") {
				$gridSearchFields[2] = "active";
			}
			else if($gridSearchFields[2] == "Needs Approval"){
				$gridSearchFields[2] = "pending";
			}
			else if($gridSearchFields[2] == "Closed"){
				$gridSearchFields[2] = "closed";
			}
			else if($gridSearchFields[2] == "Cancelled"){
				$gridSearchFields[2] = "cancel";
			}
			$hrUstatusCond = "AND hrcon_jobs.ustatus in('".$gridSearchFields[2]."')";
			$gridSearchFields[2]="";
		}
		// Condition for If Akkupay is enabled display the locations dropdown on Assignments grid
		$where_loc = "";
		if(DEFAULT_AKKUPAY=="Y")
		{
			if($gridExtraFields['locationId']!=0)
			{
				$where_loc = " AND emp_list.emp_locid=".$gridExtraFields['locationId']."";
			}
		}

		if($gridSortCol=="")
			$gridSortCol=1;
			
		$wherecond = "";
		$hrWherecond ="";
		$empWherecond ="";				
		$hr_ssFields = array("",
				"".getEntityDispName('staffacc_cinfo.sno', 'LOWER(staffacc_cinfo.cname)', 1)."",
				"".getEntityDispName('emp_list.sno', 'LOWER(emp_list.name)', 1)."",
				"(CASE 
			        WHEN hrcon_jobs.ustatus='active' THEN 'Active'
			        WHEN hrcon_jobs.ustatus='pending' THEN 'Needs Approval'
			        WHEN hrcon_jobs.ustatus='closed' THEN 'Closed'
			        WHEN hrcon_jobs.ustatus='cancel' THEN 'Cancelled'
			        ELSE hrcon_jobs.ustatus
			    END)",
				"manage.sno",
				"hrcon_jobs.pusername",
				"hrcon_jobs.project",
				"shift_setup.shiftname",
				"hrcon_jobs.shift_type",
				tzRetQueryStringSTRTODate('hrcon_jobs.s_date','%m-%d-%Y','Date','/'),
				"DATE_FORMAT(hrcon_jobs.exp_edate, '%m/%d/%Y')",
				tzRetQueryStringSTRTODate('hrcon_jobs.e_date','%m-%d-%Y','Date','/'),
				"CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode)",
				"if(manage.name IN ('Direct','Internal Direct'),if(hrcon_jobs.rate!='0.00',concat(hrcon_jobs.rate,' ',hrcon_jobs.rateper,'/',CASE hrcon_jobs.rateperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.rateperiod END ),''),if(hrcon_jobs.pamount!='0.00',concat(hrcon_jobs.pamount,' ',hrcon_jobs.pcurrency,'/',CASE hrcon_jobs.pperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.pperiod END ),''))", 
				"sagent.name",
				"corp_code.sno",			
				tzRetQueryStringDTime("hrcon_jobs.cdate","DateTime","/"),
				"users.name",
				tzRetQueryStringDTime("hrcon_jobs.mdate","DateTime","/"),
				"muser.name"
			); //For hrcon_jobs query

		if(THERAPY_SOURCE_ENABLED == "Y")
		{
			$asFields = array(
				0=>1,1=>32,2=>3,3=>5,4=>30,5=>6,6=>'getInvAsgnAlphaNum(AssignmentName)',7=>35,8=>39,9=>37,10=>21,11=>40,12=>22,13=>26,14=>23,15=>10,16=>34,17=>19,18=>16,19=>20,20=>18);
			
  			array_splice($hr_ssFields, 9, 0, "tsassignto");	

			$hrMain_Qry = " shift_setup.shiftname AS shift_name ,shift_setup.sno AS shift_sno, (GROUP_CONCAT(pihr.fname,' ',pihr.lname ORDER BY pihr.fname ASC )) AS tsassignto,emp_list.emp_locid AS emp_list_loc, hrcon_jobs.shift_type AS shiftType , DATE_FORMAT(hrcon_jobs.exp_edate, '%m/%d/%Y') AS expected_enddate";
			
			$hrCount_Qry = ", (GROUP_CONCAT(pihr.fname,' ',pihr.lname)) AS tsassignto ";

			$hrcon_query_Therapy = " LEFT JOIN persons_assignment ON (persons_assignment.asgnid = hrcon_jobs.sno AND persons_assignment.asgn_mode = 'hrcon' ) LEFT JOIN person_info pihr ON(persons_assignment.person_id = pihr.sno) ";
			if($gridSearchFields[8]!="")
			{
				//$wherecond.= " AND pi.lname LIKE '%".$gridSearchFields[7]."%' OR pi.fname LIKE '%".$gridSearchFields[7]."%'  ";
				$hrWherecond = " AND ((SELECT GROUP_CONCAT(a.fname,' ',a.lname) FROM person_info a,persons_assignment
								WHERE  a.hjobs_compid=hrcon_jobs.client AND a.location_id = hrcon_jobs.endclient 
								AND a.sno = persons_assignment.person_id  AND
								persons_assignment.`asgnid` = hrcon_jobs.sno AND persons_assignment.asgn_mode = 'hrcon'
								group by persons_assignment.`asgnid`) LIKE '%".$gridSearchFields[8]."%' ) ";
				
				$gridSearchFields[8] = "";
			}
			if($gridSearchFields[15]!="")
			{
				$wherecond = " AND corp_code.sno = '".$gridSearchFields[15]."' ";
				$gridSearchFields[15] = "";
			}
		}
		else
		{
			$asFields = array(0=>1,1=>32,2=>3,3=>5,4=>30,5=>6,6=>'getInvAsgnAlphaNum(AssignmentName)',7=>35,8=>38,9=>21,10=>39,11=>22,12=>26,13=>23,14=>10,15=>34,16=>19,17=>16,18=>20,19=>18);

			$hrcon_query_Therapy ="";
			$hrCount_Qry = "";
			$hrMain_Qry = " shift_setup.shiftname AS shift_name,shift_setup.sno AS shift_sno,emp_list.emp_locid AS emp_list_loc, hrcon_jobs.shift_type AS shiftType, DATE_FORMAT(hrcon_jobs.exp_edate, '%m/%d/%Y') AS expected_enddate ";
			if($gridSearchFields[14]!="")
			{
				$wherecond = " AND corp_code.sno = '".$gridSearchFields[14]."' ";
				$gridSearchFields[14] = "";
			}
		}

		$hrcon_query = " SELECT hrcon_jobs.sno".$hrCount_Qry." FROM emp_list 
		LEFT JOIN hrcon_jobs ON emp_list.username = hrcon_jobs.username
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno =hrcon_jobs.client
		LEFT JOIN staffacc_location as jloc ON jloc.sno = hrcon_jobs.endclient
		LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno
		LEFT JOIN users ON hrcon_jobs.owner =users.username
		LEFT JOIN users as muser ON hrcon_jobs.muser = muser.username
		LEFT JOIN users as sagent ON hrcon_jobs.owner =sagent.username
		LEFT JOIN corp_code ON hrcon_jobs.corp_code = corp_code.sno
		LEFT JOIN shift_setup ON hrcon_jobs.shiftid = shift_setup.sno
		".$hrcon_query_Therapy."
		WHERE emp_list.lstatus != 'DA' 
		AND emp_list.emp_department IN ($deptnos)
		".$hrUstatusCond.$where_loc.$wherecond.$hrWherecond;

		$hr_gstr = " group by hrcon_jobs.sno ";	 // For hrcon table 


		$hr_qstr =$gd->buildQSTR($gridSearchType,$gridSearchFields,$hr_ssFields);

		$hrcon_where_que = " $hrcon_query $hr_qstr $hr_gstr ";

		$final_query =  "$hrcon_where_que";

		$data = mysql_query($final_query,$db);
		$count = mysql_num_rows($data);

		$hrcon_query = " SELECT 
			hrcon_jobs.sno, 
			trim(staffacc_cinfo.cname) as Company, 
			trim(emp_list.name) AS EmpName, 
			'',
			(CASE 
		        WHEN hrcon_jobs.ustatus='active' THEN 'Active'
		        WHEN hrcon_jobs.ustatus='pending' THEN 'Needs Approval'
		        WHEN hrcon_jobs.ustatus='closed' THEN 'Closed'
		        WHEN hrcon_jobs.ustatus='cancel' THEN 'Cancelled'
		        ELSE hrcon_jobs.ustatus
		    END) AS Status,
			hrcon_jobs.pusername AS AssignmentID, 
			hrcon_jobs.project AS AssignmentName, 
			".tzRetQueryStringSTRTODate("hrcon_jobs.s_date","%m-%d-%Y","Date","/")." AS StartDate, 
			".tzRetQueryStringSTRTODate("hrcon_jobs.e_date","%m-%d-%Y","Date","/")." AS EndDate, 
			sagent.name as SalesAgent, 
			'', 
			emp_list.sno, 
			hrcon_jobs.username, 
			hrcon_jobs.owner, 
			".tzRetQueryStringDTime("hrcon_jobs.cdate","DateTime","/").", 
			users.name, 
			".tzRetQueryStringDTime("hrcon_jobs.mdate","DateTime","/").", 
			muser.name, 
			hrcon_jobs.cdate, 
			hrcon_jobs.mdate, 
			STR_TO_DATE(hrcon_jobs.s_date,'%m-%d-%Y'), 
			STR_TO_DATE(hrcon_jobs.e_date,'%m-%d-%Y'), 
			if(manage.name IN ('Direct', 'Internal Direct'),hrcon_jobs.rate, hrcon_jobs.pamount),if(manage.name IN ('Direct', 'Internal Direct'), hrcon_jobs.rateperiod, hrcon_jobs.pperiod), 
			hrcon_jobs.ustatus, 
			CONCAT(jloc.address1,' ',jloc.address2,' ',jloc.city,' ',jloc.state,' ',jloc.zipcode) as JobLocation, 
			if(manage.name IN ( 'Direct','Internal Direct'),if(hrcon_jobs.rate!='0.00',concat(hrcon_jobs.rate,' ',hrcon_jobs.rateper,'/', CASE hrcon_jobs.rateperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.rateperiod END ),''),if(hrcon_jobs.pamount!='0.00',concat(hrcon_jobs.pamount,' ',hrcon_jobs.pcurrency,'/',CASE hrcon_jobs.pperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.pperiod END),'')) As Rate, 
			".getEntityDispName('staffacc_cinfo.sno', 'staffacc_cinfo.cname', 1)." AS customername, 
			".getEntityDispName('emp_list.sno', 'emp_list.name', 1)." AS employeename, 
			manage.name AS jobtype,hrcon_jobs.assg_status as invoiceno, staffacc_cinfo.cname, emp_list.name,
			corp_code.name AS corp_code_name,
			".$hrMain_Qry."
		FROM emp_list
		LEFT JOIN hrcon_jobs ON emp_list.username = hrcon_jobs.username
		
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno =hrcon_jobs.client
		LEFT JOIN staffacc_location as jloc ON jloc.sno = hrcon_jobs.endclient
		LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno
		LEFT JOIN users ON hrcon_jobs.owner =users.username
		LEFT JOIN users as muser ON hrcon_jobs.muser = muser.username
		LEFT JOIN users as sagent ON hrcon_jobs.owner =sagent.username
		LEFT JOIN corp_code ON hrcon_jobs.corp_code = corp_code.sno
		LEFT JOIN shift_setup ON hrcon_jobs.shiftid = shift_setup.sno
		".$hrcon_query_Therapy."
		WHERE emp_list.lstatus != 'DA' 
		AND emp_list.emp_department IN ($deptnos)
		AND hrcon_jobs.jtype!='' AND hrcon_jobs.jotype!='0'
		".$hrUstatusCond.$where_loc.$wherecond.$hrWherecond;

		$hr_gstr = " group by hrcon_jobs.sno ";	 // For hrcon table 

		//Limit 
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		//WHERE condition fields
		$hr_qstr =$gd->buildQSTR($gridSearchType,$gridSearchFields,$hr_ssFields);  // For hrcon table query string
		$hrcon_where_que = " $hrcon_query $hr_qstr $hr_gstr ";

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by Query string

		$final_query =  "($hrcon_where_que) $ostr $lstr";

		$data = mysql_query($final_query,$db);	// Using the same query to find the count			
		$gridData=$gd->buildAssignments($final_query);		

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$count);

		return $objResponse;
	}

	//Added by Vijaya for the main page of Accounting->Assignments  on 04-10-2008
	############################################################################
	function buildAssignments($que)
	{ 
		global $maildb,$db,$crmpref,$username;		
		$grid=array();
		$j=0;
		
		$query_res=mysql_query($que,$db);
		
		while ($asg_result = @mysql_fetch_array($query_res))	
		{	
			if ($asg_result[4] == "Active") {
				$asg_status = "approved";
			}
			else if($asg_result[4] == "Needs Approval"){
				$asg_status = "pending";
			}
			else if($asg_result[4] == "Closed"){
				$asg_status = "closed";
			}
			else if($asg_result[4] == "Cancelled"){
				$asg_status = "cancelled";
			}else{
				$asg_status = $asg_result[4];
			} #For Edit window

			/*if($asg_result[4] == "" || $asg_result[4] =="Active")
				$asg_status = "approved";
			else if($asg_result[4] == "cancel")
				$asg_status = "cancelled";
			else
				$asg_status = $asg_result[4] ; #For Edit window*/

			// for display of start date.
			if(trim($asg_result[7]) == '00/00/0000' || $asg_result[7] == '0/0/0' ) # Do not show the records with 0 date
				$asg_result[7] = '';

			// for end date display
			if(trim($asg_result[8]) == '00/00/0000' || $asg_result[8] == '0/0/0') # Do not show the records with 0 date
				$asg_result[8] = '';

			// for display of expected end date.
			if(trim($asg_result['expected_enddate']) == '00/00/0000' || $asg_result['expected_enddate'] == '0/0/0' ) # Do not show the records with 0 date
				$asg_result['expected_enddate'] = '';

			$customersno = "0";
			if (trim($asg_result[27]) !="") {
				$customername = explode("-",trim($asg_result[27])); //Company Name
				$customersno = trim($customername[0]);
			}
			$shift_sno = 0;
			if (isset($asg_result['shift_sno'])) {
				if ($asg_result['shift_sno'] == "") {
					$shift_sno = 0;
				}else{
					$shift_sno = $asg_result['shift_sno'];
				}				
			}
			$hrcon_compen_loc = $asg_result['hrcon_compen_loc'];
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[]  OnClick=chk_clearTop_TimeSheet() value=".$asg_result[0]."|".$asg_status."|".$asg_result[11]."|".$asg_result['AssignmentID']."|".str_replace(" ","",$asg_result['jobtype'])."|".$asg_result['invoiceno']."|".$customersno."|".$shift_sno."|".$hrcon_compen_loc."><span class='checkmark'></span></label>"; //Check box
			if (THERAPY_SOURCE_ENABLED == "Y") {
				$grid[$j][1] = html_tls_specialchars(trim(stripslashes($asg_result[27])),ENT_QUOTES); //Company Name 
				$grid[$j][2] = html_tls_specialchars(trim(stripslashes($asg_result[28])),ENT_QUOTES); //Candidate Name 
				$grid[$j][3] = trim($asg_result[4]); // Status 
				$grid[$j][4] = html_tls_specialchars(trim(stripslashes($asg_result[29])),ENT_QUOTES); //Job Type 
				$grid[$j][5] = trim($asg_result[5]); //Assignment Id 
				$grid[$j][6] = stripslashes($asg_result[6]);  //Assignment Name 
				$grid[$j][7] = html_tls_specialchars(trim(stripslashes($asg_result['shift_name'])),ENT_QUOTES); //Shift Name
				$grid[$j][8] = ucwords(trim(stripslashes($asg_result['shiftType']))); //Shift Type
				$grid[$j][9] = html_tls_specialchars(trim(stripslashes($asg_result['tsassignto'])),ENT_QUOTES); //Assign To 
				$grid[$j][10] = $asg_result[7];  //Start Date 
				$grid[$j][11] = $asg_result['expected_enddate'];  //Expected End Date
				$grid[$j][12] = $asg_result[8];  //End Date 
				$grid[$j][13] = html_tls_specialchars(trim(stripslashes($asg_result[25])),ENT_QUOTES); // Job Location
				$grid[$j][14] = html_tls_specialchars(trim($asg_result[26]),ENT_QUOTES); // Pay Rate
				$grid[$j][15] = ucwords(trim(stripslashes($asg_result[9]))); // Sales Agent
				$grid[$j][16] = html_tls_specialchars(trim(stripslashes($asg_result['corp_code_name'])),ENT_QUOTES); //CORP CODE
				$grid[$j][17] = $asg_result[14];  // Created Date
				$grid[$j][18] = html_tls_specialchars(trim(stripslashes($asg_result[15])),ENT_QUOTES); //Created By
				$grid[$j][19] = $asg_result[16]; // Modified Date
				$grid[$j][20] = html_tls_specialchars(trim(stripslashes($asg_result[17])),ENT_QUOTES); // Modified By	
				$grid[$j][21] = "";
				$grid[$j][22] = trim($asg_result[0]."|"."15"."|".$asg_status."|".$asg_result[11]);	// Hidden var for popup. Don't change the constant 15 as it is being used in getnewconreg.php file for redirection purpose.	
			}else {
				$grid[$j][1] = html_tls_specialchars(trim(stripslashes($asg_result[27])),ENT_QUOTES); //Company Name 
				$grid[$j][2] = html_tls_specialchars(trim(stripslashes($asg_result[28])),ENT_QUOTES); //Candidate Name 
				$grid[$j][3] = trim(stripslashes($asg_result[4])); // Status 
				$grid[$j][4] = html_tls_specialchars(trim(stripslashes($asg_result[29])),ENT_QUOTES); //Job Type 
				$grid[$j][5] = trim($asg_result[5]); //Assignment Id 
				$grid[$j][6] = stripslashes($asg_result[6]);  //Assignment Name 
				$grid[$j][7] = stripslashes($asg_result['shift_name']); //Shift Name
				$grid[$j][8] = ucwords(trim(stripslashes($asg_result['shiftType']))); //Shift Type
				$grid[$j][9] = $asg_result[7];  //Start Date 
				$grid[$j][10] =	$asg_result['expected_enddate'];  //Expected End Date 
				$grid[$j][11] = $asg_result[8];  //End Date 
				$grid[$j][12] = html_tls_specialchars(trim(stripslashes($asg_result[25])),ENT_QUOTES); // Job Location
				$grid[$j][13] = html_tls_specialchars(trim($asg_result[26]),ENT_QUOTES); // Pay Rate
				$grid[$j][14] = ucwords(trim(stripslashes($asg_result[9]))); // Sales Agent
				$grid[$j][15] = html_tls_specialchars(trim(stripslashes($asg_result['corp_code_name'])),ENT_QUOTES); //CORP CODE
				$grid[$j][16] = $asg_result[14];  // Created Date
				$grid[$j][17] = html_tls_specialchars(trim(stripslashes($asg_result[15])),ENT_QUOTES); //Created By
				$grid[$j][18] = $asg_result[16]; // Modified Date
				$grid[$j][19] = html_tls_specialchars(trim(stripslashes($asg_result[17])),ENT_QUOTES); // Modified By	
				$grid[$j][20] = "";
				$grid[$j][21] = trim($asg_result[0]."|"."15"."|".$asg_status."|".$asg_result[11]);	// Hidden var for popup. Don't change the constant 15 as it is being used in getnewconreg.php file for redirection purpose.	
			}
			$j++;
		}	
		return $grid;
	}

	//Added by Vijaya for the main page of Accounting->Assignments  on 04-10-2008
	
	//UOM:Added SQL CASE
	
	
	
	// Added Build activities In Hrm,Accounting,Admin :-vipin kumar 31/10/08 	

	function buildCommonActivities($que)
	{
		global $maildb,$db,$con_id,$addr,$module_type_appoint;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$despath='';
			if($row[4]=="Sent Mail" || $row[4]=="Email")
				$despath="/BSOS/Activities/email/showemaildet.php?addr=".$addr."&reply=no&message=".$row[5]."&con_id=".$con_id."";
			else if($row[4]=="Received Mail" || $row[4]=="REmail" || ($row[4]=="ACA" && $row[6]=="Received Mail" ))												 $despath="/BSOS/Activities/email/showemaildet.php?addr=".$addr."&message=".$row[5]."&con_id=".$con_id."&emailid=".$row[6]."";
			else if($row[4]=="InvEmail")												 $despath="/BSOS/Accounting/Bill_Mngmt/emailInvoice.php?addr=".$addr."&email_id=".$row[5]."&con_id=".$con_id."&emailid=".$row[6]."&mode=resend";
			else if($row[4]=="Event" || $row[4]=="Submitted" || $row[4]=="Placed")
			$despath="/BSOS/Activities/event/editnotes.php?addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&emailid=".urlencode($row[6])."&do_action=editevent&moduletype=".$module_type_appoint."&act_type=".$row[4];
			else if($row[4]=="Document" || ($row[4]=="ACA" && (strstr($row[6],"POB") || strstr($row[6],"SIGNER"))))
				$despath="/BSOS/Activities/document/editdoc.php?addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&do_action=viewdoc&module=".$_GET['module'];
			else if($row[4]=="Task")
				$despath="/BSOS/Activities/task/edittask.php?module_type_appoint=".$module_type_appoint."&addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&do_action=edittask";
			else if($row[4]=="Appointment")
				$despath="/BSOS/Activities/appointment/editappoint.php?module_type_appoint=".$module_type_appoint."&addr=".$addr."&line=".$row[5]."&con_id=".$con_id."&do_action=editappoint";
			else if($row[4]=="Campaign")
				$despath="/BSOS/Marketing/Campaigns/showcampaigndet.php?frm=act&val=".$row[5]."";
			else if($row[4]=="Postings")
				$despath="/BSOS/Sales/Req_Post/postview.php?addr=".$addr."&val=".$row[5]."&con_id=".$con_id."";
			else if($row[4]=="Submissions")
				$despath="/BSOS/Sales/Req_Mngmt/subinfo.php?sno=".$addr."&val=".$row[5]."&con_id=".$con_id."";
			else if($row[4] == "Responded Details")
				$despath="/BSOS/Sales/Req_Mngmt/req_sub.php?frm=act&sno=".$row[5]."";
			else if($row[4] == "Notes")
				$despath="/BSOS/Sales/Req_Mngmt/notes_details.php?sno=".$row[5]."&con_id=".$con_id."&csno=".$row[0]."&module=".$_GET['module']."";
			else if($row[4]=="Data Export")
				$despath="/BSOS/Activities/document/getdoc.php?sno=".$row[5]."";


			if($module_type_appoint == 'HR->Employee_Management')
			{
				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0].'|'.$row[9]."'><span class='checkmark'></span></label>&nbsp;&nbsp;<br><br>".'||'.$despath;
			}
			else
			{
				$grid[$j][0] = '||'.$despath;
			}

			$grid[$j][1]=$this->convertSpecChars(strtolower($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			if(($row[3] == "") && ($row[4]=="Sent Mail" || $row[4]=="REmail") )
				$row[3]="No Subject";
			$grid[$j][3]=iconv("ISO-8859-1","UTF-8",$this->convertSpecChars($row[3]));

			if($row[4]=="REmail")
				$row[4]="Received Mail";
			else if($row[4]=="Campaign")
				$row[4]="eCampaign";
			else if($row[4]=="Submissions")
				$row[4]="Submission";
			else if($row[4]=="Postings")
            	$row[4]="Posting";
            else if($row[4]=="Textus Brdcst Sent")
            	$row[4]="TextUs Broadcast Sent";
                   
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=($row[4]=="Appointment")?$row[6]:$this->convertSpecChars($row[6]);
		    //Added the image for Icon Attachment - Jyothi 11/13/2104
			if($row[8] == 1 || $row[8] == '1')
			$grid[$j][6]="<img src=/BSOS/images/icons/attach.gif alt='attachment' border=0 width=16 heigh=16>";
			else
			$grid[$j][6] =""; 
			$grid[$j][7]="";
			
			if(($row[4]=="Document" || $row[4]=="ACA") && (strstr($row[6],"POB") || strstr($row[6],"SIGNER"))){
				$filedownloadpath="/BSOS/Activities/document/getdoc.php?sno=".$row[5]."";
				$fileviewpath="/BSOS/Activities/document/viewdoc.php?sno=".$row[5]."";				
				$grid[$j][7]="<a href='".$filedownloadpath."'><i alt='Download Document' class='fa fa-download'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href='javascript: previewDocumentFile(".$row[5].")'><i class='fa fa-tasks' alt='View Document'></i></a>";
				//$grid[$j][8]="";
				if($row[9] == '1'){
						$grid[$j][8] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
					}else{
						$grid[$j][8] = '';
					}
				$grid[$j][9]=$row[10];
				$grid[$j][10] = $row[11];
			}else{
				$grid[$j][8] = '';
				if($module_type_appoint == 'HR->Employee_Management')
				{
					if($row[9] == '1'){
						$grid[$j][8] ='<i class="fa fa-eye-slash" style="color:red" aria-hidden="true"></i>';
					}else{
						$grid[$j][8] = '';
					}
					$grid[$j][9] = $row[10];
					$grid[$j][10] = $row[11];
				}
			}
			
			$j++;
		}
		return $grid;
	}
  // Added get all activities In Hrm,Accounting,Admin :-vipin kumar 31/10/08 	
	function getCommonActivities($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
		global $maildb,$db,$username,$con_id,$e_type,$user_timezone,$conditionquery,$checkDomainCond_activities; //$checkDomainCond_activities variable is to check the domain name and to display the activities accordingly.

		$gd=new gridData();
		//Added the cmngmt_pr.email_attach_flag to osFields,asFields for Icon Attachment - Jyothi 11/13/2104
		$osFields=array("","sdate","users.name","subject","title","subtype","cmngmt_pr.email_attach_flag","tysno","cmngmt_pr.activity_status","cmngmt_pr.hidden_by","cmngmt_pr.hidden_date");
		$asFields=array("","cast(".tzRetQueryStringDTime('sdate','DateTimeSec','/')."AS CHAR)","users.name","subject","title","subtype","tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag","u.name","cast(".tzRetQueryStringDTime('hidden_date','DateTimeSec','/')."AS CHAR)"); 
		
		
			
		$tque="select count(distinct(cmngmt_pr.sno)) from cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username),users  where cmngmt_pr.lmuser = users.username $conditionquery and title in ('".$e_type."') $checkDomainCond_activities ";
		
		//Added the cmngmt_pr.email_attach_flag to oque for Icon Attachment - Jyothi 11/13/2104
		
		$oque="select cmngmt_pr.sno,".tzRetQueryStringDTime('sdate','DateTimeSec','/').",users.name,subject,CASE WHEN title = 'Email' THEN 'Sent Mail' WHEN title = 'AplcntDistri' THEN 'Applicant Distribution' ELSE title END as title,tysno,subtype,cmngmt_pr.username,cmngmt_pr.email_attach_flag,cmngmt_pr.activity_status,u.name,".tzRetQueryStringDTime('hidden_date','DateTimeSec','/')." from users,cmngmt_pr LEFT JOIN users u ON (cmngmt_pr.hidden_by = u.username) where cmngmt_pr.lmuser = users.username $conditionquery and title in ('".$e_type."') $checkDomainCond_activities ";
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$varActType="";
		if($gridSearchFields[3]=="Sent Mail")
		{
			$varActType="title='Email'";
			$gridSearchFields[3]="";
		}
		
		if($gridSearchFields[3]=="Received Mail")
		{
			$varActType="title='REmail'";

			$gridSearchFields[3]="";
		}
		if($gridSearchFields[3]=="Inv Mail")
		{
			$varActType="title='InvEmail'";

			$gridSearchFields[3]="";
		}
		if($gridSearchFields[7]=="0")
		{
			$varActType="activity_status='0'";
			$gridSearchFields[7]="";
		}
		if($gridSearchFields[7]=="1")
		{
			$varActType="activity_status='1'";
			$gridSearchFields[7]="";
		}
       
        
		// In the buildQSTR() function we used like % data % .In select box we have Email and REmail when i select only Email its  getting the results of Email and  also REmail.Thats the reason added these conditions.
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="" && $varActType!="")
        {
            $qstr=substr($qstr,0,(strlen($qstr)-1));
            $qstr.=" AND ".$varActType.")";
        }
        else if($qstr=="" && $varActType!="")
        {
            $qstr.=" AND (".$varActType.")";
        }

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque="$oque $qstr $ostr $lstr";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCommonActivities($oque);
		$objResponse = new xajaxResponse(CONVERT_DEFAULT_MAIL_CHAR,false);
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;

	}	
	
	
	/////////////// function for XAjax grid for Admin contactmanagement CONTACTS //////////////////////////////////////////
	function getAdminCntctMngmnt($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
        $osFields=array("","fname","lname","company","trim(nickname)","email");
		$asFields=array("","fname","lname","company","nickname","email");
		
			
		$tque="select count(1) from contacts where status='ER' ";
		
		
		$oque="select fname,company,nickname,email,serial_no,lname from contacts where status='ER'";

        //For checking contacts duplicates and displaying the search result on main grid.
		if($gridExtraFields['duplicate']== "yes")
        {
            $gridSearchFields[0] = $gd->gridSearchFieldConvert($gridSearchFields[0]);
            $gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
            $gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);
            
            $duplicateCheck = $gd->duplicateContactChecking($gridSearchFields[0],$gridSearchFields[1],$gridSearchFields[4]);
            $tque.=$duplicateCheck;
            $oque.=$duplicateCheck;
            $gridSearchFields[0] = "";
            $gridSearchFields[1] = "";
            $gridSearchFields[4] = "";
        }

        $gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmnt($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONTACTS Display ////////////////////////////////
	
	function buildAdminCntctMngmnt($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[4]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[5]);
			$grid[$j][3]=$this->convertSpecChars($row[1]);
			$grid[$j][4]=$this->convertSpecChars($row[2]);
			$grid[$j][5]=$this->convertSpecChars($row[3]);
			$grid[$j][6]='';
			$grid[$j][7]="eeditcontact.php?addr=".$row[4];
            $j++;
		}
        return $grid;
	}
	
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CUSTOMERS //////////////////////////////////////////
	
	function getAdminCntctMngmntCust($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
        $osFields=array("","staffacc_cinfo.cname","trim(CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname))","staffacc_contact.email","staffacc_ctype.company_type","staffacc_list.stime"); 
		$asFields=array("","staffacc_cinfo.cname","CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)","staffacc_contact.email","staffacc_ctype.company_type",tzRetQueryStringDTime('staffacc_list.stime','DateTime','/')); 		
			
		$contactType=getManageSno('Main Contact','contacttype');
		
		$tque="select count(1)  from staffacc_list LEFT JOIN staffacc_cinfo ON staffacc_list.username=staffacc_cinfo.username LEFT JOIN staffacc_contact ON staffacc_list.username=staffacc_contact.username LEFT JOIN staffacc_ctype ON staffacc_cinfo.ctype=staffacc_ctype.company_id where staffacc_list.status='ACTIVE' and staffacc_contact.ctype='".$contactType."' and staffacc_contact.acccontact='Y' ";
		
		
		$oque="select staffacc_list.username,staffacc_cinfo.cname,CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname),staffacc_contact.email,staffacc_ctype.company_type,". tzRetQueryStringDTime('staffacc_list.stime','DateTime','/').",staffacc_contact.sno from staffacc_list LEFT JOIN staffacc_cinfo ON staffacc_list.username=staffacc_cinfo.username LEFT JOIN staffacc_contact ON staffacc_list.username=staffacc_contact.username LEFT JOIN staffacc_ctype ON staffacc_cinfo.ctype=staffacc_ctype.company_id where staffacc_list.status='ACTIVE' and staffacc_contact.ctype='".$contactType."' and staffacc_contact.acccontact='Y' ";

        $gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntCust($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CUSTOMERS DISPLAY /////////////////////////////////
	function buildAdminCntctMngmntCust($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);			
			$grid[$j][6]='';
			$grid[$j][7]="port.php?addr=$row[0]|".$row[6];
            $j++;
		}
        return $grid;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONSULTANTS ////////////////////////////////////////
	
	function getAdminCntctMngmntCons($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		
        $osFields=array("","trim(CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname))","consultant_list.email","consultant_list.stime"); 
		
		$asFields=array("","CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname)","consultant_list.email",tzRetQueryStringDTime('consultant_list.stime','DateTime','/')); 
			
		$tque="select consultant_list.serial_no  from consultant_list LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username where (ISNULL(astatus) or consultant_list.astatus not in ('backup', 'INACT', 'DELE', 'ARCH', 'RARCH', 'INACTIVE'))";
		
		
		$oque="select consultant_list.serial_no,CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname),consultant_list.email,".tzRetQueryStringDTime('consultant_list.stime','DateTime','/')." from consultant_list LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username where (ISNULL(astatus) or consultant_list.astatus not in ('backup', 'INACT', 'DELE', 'ARCH', 'RARCH', 'INACTIVE')) ";
		
		$oque_grpby = " group by consultant_list.username ";

        $gstr = $oque_grpby;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$tque="SELECT count(1) FROM ( ".$tque." ) totl_tabl";


		$gstr = $oque_grpby;
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntCons($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONSULTANTS DISPLAY //////////////////////////////
	
	function buildAdminCntctMngmntCons($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]='';
			$grid[$j][5]="condetail.php?addr=".$row[0];
            $j++;
		}
        return $grid;
	}
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement EMPLOYEES //////////////////////////////////////////
	
	function getAdminCntctMngmntEmp($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		
        $osFields=array("","trim(CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname))","department.deptname","emp_list.email","emp_list.stime"); 
		
		$asFields=array("","CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname)","department.deptname","emp_list.email",tzRetQueryStringDTime('emp_list.stime','DateTime','/')); 
			
		$tque="select emp_list.sno from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN hrcon_general ON hrcon_general.username=emp_list.username where hrcon_general.ustatus='active' and emp_list.lstatus!='DA' and emp_list.lstatus!='INACTIVE' and emp_list.username!='".$username."' ";
		

		

		$oque="select emp_list.sno,CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname),department.deptname,emp_list.email,".tzRetQueryStringDTime('emp_list.stime','DateTime','/')." from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN hrcon_general ON hrcon_general.username=emp_list.username where hrcon_general.ustatus='active' and emp_list.lstatus!='DA' and emp_list.lstatus!='INACTIVE' and emp_list.username!='".$username."' ";
		
		
		$oque_grpby = " group by emp_list.username ";

        $gstr = $oque_grpby;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$tque="SELECT count(1) FROM ( ".$tque." ) totl_tabl";


		$gstr = $oque_grpby;
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntEmp($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement EMPLOYEES DISPLAY ///////////////////////////////
	function buildAdminCntctMngmntEmp($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]='';
			$grid[$j][6]="empdetail.php?addr=".$row[0];
            $j++;
		}
        return $grid;
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
	/////////////// function for XAjax grid for Admin contactmanagement CONTACTS VIEW ARCHIEVE /////////////////////////
	function getAdminCntctMngmntHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
        $osFields=array("","fname","lname","company","trim(nickname)","email");
		$asFields=array("","fname","lname","company","nickname","email");
		
			
		$tque="select count(1) from contacts where status='INACTIVE' ";
		
		
		$oque="select fname,company,nickname,email,serial_no,lname from contacts where status='INACTIVE'";
		

        $gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntHis($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONTACTS VIEW ARCHIEVE DISPLAY //////////////////////	
	function buildAdminCntctMngmntHis($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[4]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[5]);
			$grid[$j][3]=$this->convertSpecChars($row[1]);
			$grid[$j][4]=$this->convertSpecChars($row[2]);
			$grid[$j][5]=$this->convertSpecChars($row[3]);
			$grid[$j][6]='';
			$grid[$j][7]="contactreview.php?addr=".$row[4];
            $j++;
			/*$grid[$j][0]="<input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[4]."'>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars($row[2]);
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]='';			
			$grid[$j][6]="eeditcontact.php?addr=".$row[4];
            $j++;*/
		}
        return $grid;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CUSTOMERS VIEW ARCHIEVE /////////////////////////
	
	function getAdminCntctMngmntCustHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
        $osFields=array("","staffacc_cinfo.cname","trim(CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname))","staffacc_contact.email","staffacc_ctype.company_type","staffacc_list.stime"); 
		$asFields=array("","staffacc_cinfo.cname","CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)","staffacc_contact.email","staffacc_ctype.company_type",tzRetQueryStringDTime('staffacc_list.stime','DateTime','/')); 
		
			
		$tque="select count(1)  from staffacc_list LEFT JOIN staffacc_cinfo ON staffacc_list.username=staffacc_cinfo.username LEFT JOIN staffacc_contact ON staffacc_list.username=staffacc_contact.username LEFT JOIN staffacc_ctype ON staffacc_cinfo.ctype=staffacc_ctype.company_id where staffacc_list.status='INACTIVE' and staffacc_contact.acccontact='Y' ";
		
		
		$oque="select staffacc_list.username,staffacc_cinfo.cname,CONCAT_WS(' ',staffacc_contact.prefix,'.',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname),staffacc_contact.email,staffacc_ctype.company_type,". tzRetQueryStringDTime('staffacc_list.stime','DateTime','/').",staffacc_contact.sno from staffacc_list LEFT JOIN staffacc_cinfo ON staffacc_list.username=staffacc_cinfo.username LEFT JOIN staffacc_contact ON staffacc_list.username=staffacc_contact.username LEFT JOIN staffacc_ctype ON staffacc_cinfo.ctype=staffacc_ctype.company_id where staffacc_list.status='INACTIVE' and staffacc_contact.acccontact='Y' ";											


        $gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntCustHis($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CUSTOMERS VIEW ARCHIEVE DISPLAY/////////////////////////
	
	function buildAdminCntctMngmntCustHis($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);			
			$grid[$j][6]='';
			$grid[$j][7]="hisreviewmanage.php?addr=$row[0]";
            $j++;
		}
        return $grid;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONSULTANTS VIEW ARCHIEVE /////////////////////////
	
	function getAdminCntctMngmntConsHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		
        $osFields=array("","trim(CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname))","consultant_list.email","consultant_list.stime"); 
		
		$asFields=array("","CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname)","consultant_list.email",tzRetQueryStringDTime('consultant_list.stime','DateTime','/')); 
			
		$tque="select consultant_list.serial_no  from consultant_list LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username where consultant_list.astatus  in ('INACT', 'DELE', 'ARCH', 'RARCH', 'INACTIVE') ";
		
		
		$oque="select consultant_list.serial_no,CONCAT_WS(' ',consultant_general.fname,consultant_general.mname,consultant_general.lname),consultant_list.email,".tzRetQueryStringDTime('consultant_list.stime','DateTime','/')." from consultant_list LEFT JOIN consultant_general ON consultant_general.username=consultant_list.username where consultant_list.astatus  in ('INACT', 'DELE', 'ARCH', 'RARCH' , 'INACTIVE')";
		
		
		
		$oque_grpby = " group by consultant_list.username ";

        $gstr = $oque_grpby;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$tque="SELECT count(1) FROM ( ".$tque." ) totl_tabl";




		$gstr = $oque_grpby;
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntConsHis($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONSULTANTS VIEW ARCHIEVE DISPLAY /////////////////
	function buildAdminCntctMngmntConsHis($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]='';
			$grid[$j][5]="hirevcon.php?addr=".$row[0];
            $j++;
		}
        return $grid;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement EMPLOYEES VIEW ARCHIEVE /////////////////////////
	function getAdminCntctMngmntEmpHis($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		
        $osFields=array("","trim(CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname))","department.deptname","emp_list.email","emp_list.stime"); 
		
		$asFields=array("","CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname)","department.deptname","emp_list.email",tzRetQueryStringDTime('emp_list.stime','DateTime','/')); 
			
		$tque="select emp_list.sno from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN hrcon_general ON hrcon_general.username=emp_list.username where hrcon_general.ustatus='active' and emp_list.lstatus ='DA' and FIND_IN_SET('".$username."',department.permission)>0";		
		
		$oque="select distinct(emp_list.sno),CONCAT_WS(' ',hrcon_general.fname,hrcon_general.mname,hrcon_general.lname),department.deptname,emp_list.email,".tzRetQueryStringDTime('emp_list.stime','DateTime','/')." from emp_list LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN department ON hrcon_compen.dept=department.sno LEFT JOIN hrcon_general ON hrcon_general.username=emp_list.username where hrcon_general.ustatus='active' and emp_list.lstatus='DA' and FIND_IN_SET('".$username."',department.permission)>0";		
		
		
		$oque_grpby = " group by emp_list.sno ";

        $gstr = $oque_grpby;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); //Order by fields, append the where clause accordingly
       
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$tque="SELECT count(1) FROM ( ".$tque." ) totl_tabl";


		$gstr = $oque_grpby;
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminCntctMngmntEmpHis($oque);

        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	/////////////// function for XAjax grid for Admin contactmanagement CONTACTS VIEW ARCHIEVE DISPLAY /////////////////
	
	function buildAdminCntctMngmntEmpHis($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id=auids".$j." OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]='';
			$grid[$j][6]="hisconreg1.php?addr=".$row[0];
            $j++;
		}
        return $grid;
	}
	
	/* implement X-Ajax in location - vipin 12/01/09 */
	/*--prasadd-moved hrcon_jobs.ustatus term from where condition to left join itself and department_dynStr added...--*/
	function getLocation($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
		global $maildb,$db,$username,$user_timezone,$locname;
		$gd = new gridData();
		
        // Searching array
    	$asFields=array("","hrcon_general.fname","hrcon_general.lname","(select group_concat(a.skillname) from hrcon_skills a where a.username=hrcon_general.username and a.ustatus='active' and (a.lastused='Current' or a.skilllevel='Expert'))", "hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");
		
    	$ssFields=array("","hrcon_general.fname","hrcon_general.lname","(select group_concat(a.skillname) from hrcon_skills a where a.username=hrcon_general.username and a.ustatus='active' and (a.lastused='Current' or a.skilllevel='Expert'))", "hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");


		$tque = "select count(distinct(emp_list.sno))from emp_list
		LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active')
		LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 		   
		LEFT JOIN contact_manage ON contact_manage.serial_no=hrcon_compen.location		   	
		where contact_manage.serial_no='".$locname."' 
		and hrcon_compen.ustatus='active' 
		and hrcon_w4.ustatus='active' 
		and hrcon_general.ustatus='active' 
		and emp_list.lstatus not in('DA','INACTIVE')
		and emp_list.empterminated != 'Y'
		and contact_manage.status !='BP' ";

		$oque = "select emp_list.sno,hrcon_general.fname,hrcon_general.lname,(select group_concat(a.skillname) from hrcon_skills a where a.username=hrcon_general.username and a.ustatus='active' and (a.lastused='Current' or a.skilllevel='Expert')) sk_nm,hrcon_general.wphone,hrcon_general.email,IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OV','On Vacation',IF(hrcon_jobs.jtype='OP','Project',IF(hrcon_jobs.jtype='AS','Administrative Staff','')))) jtype, hrcon_w4.tax
		from emp_list
		LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active')
		LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 		   
		LEFT JOIN contact_manage ON contact_manage.serial_no=hrcon_compen.location		   	
		where contact_manage.serial_no='".$locname."' 
		and hrcon_compen.ustatus='active' 
		and hrcon_w4.ustatus='active' 
		and hrcon_general.ustatus='active' 
		and emp_list.lstatus not in('DA','INACTIVE')
		and emp_list.empterminated != 'Y'
		and contact_manage.status !='BP' ";

        $gstr = " group by emp_list.sno";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		
		if($qstr!="")
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		$tque=$gd->buildTQuery($tque,$qstr,'');
		
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildLocation($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	
	}	
	
	function buildLocation($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
				if($row[4] == "-" || $row[4] == "--" || $row[4] == "---")
					$row[4] = "";
				else
					$row[4] = $row[4];
					
				$grid[$j][0]="";
                $grid[$j][1]=$this->convertSpecChars($row[1]);
                $grid[$j][2]=$this->convertSpecChars($row[2]);
                $grid[$j][3]=$this->convertSpecChars($row[3]);
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
				$grid[$j][6]=$this->convertSpecChars($row[6]);
                $grid[$j][7]=$this->convertSpecChars($row[7]);
				$grid[$j][8]="";
                $j++;
		}
      
	    return $grid;
	}	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		
    //Function for getting data for Accounting->Employees
	/*--prasadd-moved hrcon_jobs_ustatus term from where condition to left join itself and $department_dynStr added...--*/
	function  getAccountingEmployees($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$accountingpref;
		if($gridSortCol=="")
		$gridSortCol=9;
		$gd=new gridData();


    	$asFields=array("","e.sno","concat_ws(' ',e.emp_fname,e.emp_lname)","e.emp_tax","CONCAT_WS(' - ',contact_manage.loccode,contact_manage.heading)","CONCAT_WS(' - ',department.depcode,department.deptname)","STR_TO_DATE(e.emp_date_hire,'%m-%d-%Y')","e.emp_jtype","IF(e.empterminated='N','Active','Terminated')","e.mtime");

    	$ssFields=array("","e.sno","concat_ws(' ',e.emp_fname,e.emp_lname)","e.emp_tax","CONCAT_WS(' - ',contact_manage.loccode,contact_manage.heading)","CONCAT_WS(' - ',department.depcode,department.deptname)",tzRetQueryStringSTRTODate('e.emp_date_hire','%m-%d-%Y','Date','/'),"e.emp_jtype","e.empterminated","DATE_FORMAT(CONVERT_TZ(e.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')");

        //$department_dynStr = " AND FIND_IN_SET('".$username."',department.permission)>0 ";
        $dque="select group_concat(sno) from department where FIND_IN_SET(CONCAT('+','".$username."','+'),REPLACE(CONCAT('+',permission,'+'),',','+,+'))>0";
		$dres=mysql_query($dque,$db);
		$drow=mysql_fetch_row($dres);
		$deptnos = $drow[0];

		if($deptnos=="")
			$deptnos="0";
		

		$tque = "SELECT count(1) FROM emp_list e
				LEFT JOIN users ON users.username = e.username
				LEFT JOIN department ON e.emp_department = department.sno AND department.status = 'Active'
				LEFT JOIN contact_manage ON e.emp_locid = contact_manage.serial_no
				WHERE e.lstatus not in('DA','INACTIVE') AND e.emp_department IN ($deptnos)";

		$oque = "SELECT e.sno,concat_ws(' ',e.emp_fname,e.emp_lname),e.emp_tax,CONCAT_WS(' - ',contact_manage.loccode,contact_manage.heading), CONCAT_WS(' - ',department.depcode,department.deptname) AS deptname,DATE_FORMAT(STR_TO_DATE(IF(e.emp_date_hire='0-0-0','00-00-0000',e.emp_date_hire),'%m-%d-%Y'),'%m/%d/%Y'),IF(e.emp_jtype='OB','On Bench',IF(e.emp_jtype='OP','On Assignment','')) jtype,IF(e.empterminated='N','Active','Terminated'),e.sno,UNIX_TIMESTAMP(DATE_FORMAT(e.tdate,'%Y-%m-%d')) tdate,e.mtime
			FROM emp_list e
			LEFT JOIN department ON e.emp_department = department.sno AND department.status = 'Active'
			LEFT JOIN contact_manage ON e.emp_locid = contact_manage.serial_no
			WHERE e.lstatus not in('DA','INACTIVE') AND e.emp_department IN ($deptnos)";

        $gstr = $dateString;
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		
		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
        }

		$tque=$gd->buildTQuery($tque,$qstr,'');
		
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAccountingEmployees($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;

	}

    //Function for displaying data for Accounting->Employees
	function buildAccountingEmployees($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
				if($row[5] == "00/00/0000")
					$row[5] = "";

				$grid[$j][0]="";
                $grid[$j][1]=$this->convertSpecChars($row[0]);
                $grid[$j][2]=$this->convertSpecChars(stripslashes($row[1]));
                $grid[$j][3]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][4]=$this->convertSpecChars(stripslashes($row[3]));
				$grid[$j][5]=$this->convertSpecChars(stripslashes($row[4]));
				$grid[$j][6]=$this->convertSpecChars($row[5]);
                $grid[$j][7]=$this->convertSpecChars($row[6]);

				if($row[7]=="Terminated")
				{
					if($row[9]>time())
						$row[7]="Active";
				}

				$grid[$j][8]=$this->convertSpecChars($row[7]);
				$grid[$j][9]="";
				$grid[$j][10]=$this->convertSpecChars($row[8]);
                $j++;
		}

	    return $grid;
	}
	//Function added for Accounts Payment Register on 18/2/2009 - Vijaya.T
	function getEmpPayRegister($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;		
		$cond = '';
		
		if($gridSortCol=="")
			$gridSortCol=2; //Default Sorting should be by date column
					
		$gd=new gridData();
		
		if($gridExtraFields['datedue']!="") //Client,fromdate, indate fields are coming as extra fields to the grid.
			$datedue = $gridExtraFields['datedue'];
		if($gridExtraFields['datein']!="")
			$datein = $gridExtraFields['datein'];		
		if($gridExtraFields['client']!='' && $gridExtraFields['client']!='none') //Search by client if client is not empty.
			$cond = " AND acc_reg.cename = '".$gridExtraFields['client']."'";	
		
		$asFields=array("","staffacc_cinfo.cname",tzRetQueryStringDTime('acc_reg.rdate','Date','/'),"bank_trans.paymethod",
		"bank_trans.checknumber","reg_category.name","acc_reg.amount");
       
	    $ssFields=array("","staffacc_cinfo.cname","acc_reg.rdate","bank_trans.paymethod",
		"IF(left(bank_trans.checknumber,1)>=0,CAST(bank_trans.checknumber AS SIGNED),0)","reg_category.name","acc_reg.amount");
		
		//For Total Records Count
		$tque = "SELECT count(*)
		FROM acc_reg 
		LEFT JOIN bank_trans ON acc_reg.source = CONCAT('Dep',bank_trans.sno)
		LEFT JOIN reg_category ON reg_category.sno = bank_trans.bankid
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = acc_reg.cename
		WHERE acc_reg.type = 'PMT' AND acc_reg.status = 'ER' 
		AND  DATE(acc_reg.rdate) >= '".$datein."' 
		AND  DATE(acc_reg.rdate) <= '".$datedue."' $cond ";
			
		$oque="SELECT acc_reg.sno, ".tzRetQueryStringDTime('acc_reg.rdate','Date','/').", acc_reg.cename, 
		acc_reg.type, IF(acc_reg.amount='',0,acc_reg.amount), 
		acc_reg.source, acc_reg.description, acc_reg.c_date, bank_trans.bankid, bank_trans.checknumber, bank_trans.memo, 	
		bank_trans.paymethod, reg_category.name, staffacc_cinfo.cname
		FROM acc_reg 
		LEFT JOIN bank_trans ON acc_reg.source = CONCAT('Dep',bank_trans.sno)
		LEFT JOIN reg_category ON reg_category.sno = bank_trans.bankid
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = acc_reg.cename
		WHERE acc_reg.type = 'PMT' AND acc_reg.status = 'ER' 
		AND  DATE(acc_reg.rdate) >= '".$datein."'	
		AND DATE(acc_reg.rdate) <= '".$datedue."' $cond ";
        
        $grpque = "";        
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
        $ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		
		//For the number od records count
		$tque=$gd->buildTQuery($tque,$qstr,'');		
		$total =$gd->getTotalRows($tque);
		
		$oque="$oque $grpque $qstr $ostr $lstr";		
		
    	$gridData=$gd->buildEmpPayRegister($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildEmpPayRegister($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);		
		while ($row=mysql_fetch_array($res))
		{			
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[13]);// Customer Name
			$grid[$j][2]=$this->convertSpecChars($row[1]); // Date
			$grid[$j][3]=$this->convertSpecChars($row[11]); // Payment Method
			$grid[$j][4]=$this->convertSpecChars($row[9]);// Check Number
			$grid[$j][5]=$this->convertSpecChars($row[12]); // Account Name
			$grid[$j][6]=$this->convertSpecChars($row[4]); // Amount
			$grid[$j][7] ="";
			$grid[$j][8]=$this->convertSpecChars($row[0]);
			$j++;
		}
		return $grid;
	}
	
	//added by prasadd to Admin->Job Board Accounts Grid optimization...
	function getAdminJobBoards($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$user_timezone;

		$gd = new gridData();

		$asFields=array("","trim(j.jobboard_name)","ja.nickname","ja.username","ja.company_id","ja.contact_id",tzRetQueryStringDTime('ja.cdate','DateTime','/'),"csr.name",tzRetQueryStringDTime('ja.mdate','DateTime','/'),"msr.name");
	    $ssFields = array("","trim(j.jobboard_name)","ja.nickname","ja.username","ja.password","ja.company_id","ja.contact_id","ja.cdate","csr.name","ja.mdate","msr.name");

		$tque = " SELECT count(ja.sno) FROM jobboard_accounts ja LEFT JOIN users msr ON ja.muser = msr.username,jobboards j,users csr where j.sno=ja.jobboard_id and ja.status='ACTIVE' and ja.cuser = csr.username";
		$oque = "SELECT ja.sno,j.jobboard_name,ja.nickname,ja.username,ja.password,".tzRetQueryStringDTime('ja.cdate','DateTime','/')." as crdate,csr.name as c_name,".tzRetQueryStringDTime('ja.mdate','DateTime','/')." as modate,msr.name as m_name,ja.jobboard_id,ja.company_id,ja.contact_id FROM jobboard_accounts ja  LEFT JOIN users msr ON ja.muser = msr.username,jobboards j,users csr where j.sno=ja.jobboard_id and ja.status='ACTIVE' and ja.cuser = csr.username";

		$gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminJobBoards($oque);
		
        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
	}

	//this  fun for assigning fetched data to grid...--added by prasad d
	function buildAdminJobBoards($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $row[5] = (trim($row[5])=='00/00/0000')?"":$row[5];
			$row[7] = (trim($row[7])=='00/00/0000')?"":$row[7];
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onclick='chk_clearTop()' value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); // job Board name
			$grid[$j][2]=$this->convertSpecChars($row[2]); //Nickname
			$grid[$j][3]=$this->convertSpecChars($row[3]); //username
			$grid[$j][4]=str_repeat("x",strlen($row[4])); //password
			$grid[$j][5]=$this->convertSpecChars($row[10]); //Company ID
			$grid[$j][6]=$this->convertSpecChars($row[11]); //Contact ID
			$grid[$j][7]=$row[5]; //created date
			$grid[$j][8]=$this->convertSpecChars($row[6]); //Created By
			$grid[$j][9]=$row[7]; //Modified date
			$grid[$j][10]=$this->convertSpecChars($row[8]); //Modified By
			$grid[$j][11]="";
			$grid[$j][12]="editjobaccount.php?jobBoardId=".$row[0]; //path for double click on record
            $j++;
		}
        return $grid;
	}
	
	//Function for Adding Job Board Accounts.
	function  getJobBoardAccount($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	 {
		global $maildb,$db,$username,$stat,$user_timezone;

        if($gridSortCol=="")
			$gridSortCol=1;
			
        $gd=new gridData();

				
		//$asFields=array("","a.jobboard_name","b.nickname","b.username","b.password","");
		//$ssFields=array("","a.jobboard_name","b.nickname","b.username","b.password","");
		$asFields=array("","jobboard_name","","","","");
		$ssFields=array("","jobboard_name","","","","");
		
		//$tque="select count(*) from jobboards a left join jobboard_accounts b on b.jobboard_id = a.sno where a.sno not in(select distinct(jobboard_id) from jobboard_accounts) and a.status='y'";
        
		//$oque="select a.sno,a.jobboard_name from jobboards a left join jobboard_accounts b on b.jobboard_id = a.sno where a.sno not in (select distinct(jobboard_id) from jobboard_accounts) and a.status='y'";
		$tque = "select count(*) from jobboards where status='Y'";
		$oque = "select sno,jobboard_name from jobboards where status='Y'";
		
        $gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        $total=$gd->getTotalRows($tque);
		$gridData=$gd->buildJobBoardAccount($oque);		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	//prasadd-added ids for text box things for job boards new level...
	//set the text box max size's--deepak
	function buildJobBoardAccount($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
        $res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id='checkSel".$j."' OnClick=chk_clearTop() value='".$row[0]."|".$j."|'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]="<input class=gridserbox type=text maxlength='255' name='txtnickname".$j."' id='txtnickname".$j."'>";
			$grid[$j][3]="<input class=gridserbox type=text maxlength='25' name='txtuid".$j."' id='txtuid".$j."'>";
			$grid[$j][4]="<input class=gridserbox type=password maxlength='25' name='txtpwd".$j."' id='txtpwd".$j."'>";
			$grid[$j][5]="<input class=gridserbox type=password maxlength='25' name='txtcpwd".$j."' id='txtcpwd".$j."'>";
			$grid[$j][6]="";
			$j++;
		}
		return $grid;
	}
	
	//Function for CRM->Active Clients
	function getCRMActiveClients($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		$aqstr=" 1=1 ";

		$asFields=array("","staffacc_cinfo.cname","staffacc_cinfo.city","staffacc_cinfo.state","manage.name");

		$ssFields=array("","staffacc_cinfo.cname","staffacc_cinfo.city","staffacc_cinfo.state","manage.name");
		
        /** sanghamitra: to get all the unique clients who have active assignments. (new query)**/
		$tque = "SELECT COUNT(staffacc_cinfo.cname) AS total_count,
					           staffacc_cinfo.username,
					           staffacc_cinfo.cname, 
							   staffacc_cinfo.city, 
							   staffacc_cinfo.state,
							   staffacc_cinfo.ctype,
							   manage.name,
							   staffacc_list.sno AS staffacc_list_sno,
							   staffacc_cinfo.sno AS staffacc_cinfo_sno
							FROM staffacc_list 
							LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = staffacc_list.username
							LEFT JOIN empcon_jobs ON empcon_jobs.client=staffacc_cinfo.sno
							LEFT JOIN emp_list ON empcon_jobs.username=emp_list.username 
							LEFT JOIN manage ON staffacc_cinfo.ctype = manage.sno AND manage.type = 'comptype'
							WHERE empcon_jobs.assg_status ='approved'
							AND empcon_jobs.jtype!='' 
							AND empcon_jobs.jotype!=0
							AND emp_list.lstatus!='DA'
							AND emp_list.empterminated = 'N'							
							AND empcon_jobs.owner='".$username."'";
		
	$oque = "SELECT staffacc_cinfo.username,
					           staffacc_cinfo.cname, 
							   staffacc_cinfo.city, 
							   staffacc_cinfo.state,
							   staffacc_cinfo.ctype,
							   manage.name,
							   staffacc_list.sno AS staffacc_list_sno,
							   staffacc_cinfo.sno AS staffacc_cinfo_sno
							FROM staffacc_list 
							LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = staffacc_list.username
							LEFT JOIN empcon_jobs ON empcon_jobs.client=staffacc_cinfo.sno
							LEFT JOIN emp_list ON empcon_jobs.username=emp_list.username 
							LEFT JOIN manage ON staffacc_cinfo.ctype = manage.sno AND manage.type = 'comptype'
							WHERE empcon_jobs.assg_status ='approved'
							AND empcon_jobs.jtype!='' 
							AND empcon_jobs.jotype!=0 
							AND emp_list.lstatus!='DA'
							AND emp_list.empterminated = 'N'
							AND empcon_jobs.owner='".$username."'";
			
        $grpque = " group by staffacc_cinfo.cname";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr,$grpque);
        $oque="$oque $qstr $grpque $ostr $lstr";
       	$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		$gridData=$gd->buildCRMActiveClients($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

    //Function for CRM->Active Clients
	function buildCRMActiveClients($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[7]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[5]);
			$grid[$j][5] ="";
			$grid[$j][6]="editclient.php?client_addr=".$row[0]."&editStatus=edit&srnum=".$row[0]."&crm_select=no";
			$j++;
		}
		return $grid;
	}
	
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Added by Sandeep Boora  on 07-05-2009 for HRM->Employee Mngmt->Processed PayData List
	//prasadd--modified query for display properly...
	function  getProcessedPayDataList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));
		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();
		
		$asFields=array("","paydata_fein","ac_empid","paydata_firstname","paydata_middlename","paydata_lastname","pdate");
		$ssFieldsRate=array("","paydata_fein","ac_empid","paydata_firstname","paydata_middlename","paydata_lastname",tzRetQueryStringDTime('mr.paydata_processed_date','Date','/'));

		$tque_rate = "SELECT paydata_sno,".tzRetQueryStringDTime('mr.paydata_processed_date','Date','/')." FROM madison_paydata ,madison_paydata_rate mr WHERE paydata_emp_status NOT IN ('DA','INACTIVE') AND madison_paydata.paydata_emp_terminated ='N' AND madison_paydata.paydata_sno=mr.paydata_id AND mr.paytype_status='ACTIVE' AND mr.paydata_processed_status='Y' AND mr.paydata_timesheet_id!=0 AND ".tzRetQueryStringDTime('mr.paydata_processed_date','YMDDate','-')." BETWEEN '".$minDateValue."' AND '".$maxDateValue."'";
		

		 $oque_rate = "SELECT paydata_sno,paydata_fein,el.sno AS ac_empid,paydata_firstname,paydata_middlename,paydata_lastname,".tzRetQueryStringDTime('mr.paydata_processed_date','Date','/').", mr.paydata_processed_date AS pdate FROM madison_paydata ,madison_paydata_rate mr,emp_list el  WHERE paydata_emp_status NOT IN ('DA','INACTIVE') AND madison_paydata.paydata_emp_terminated ='N' AND madison_paydata.paydata_sno=mr.paydata_id AND mr.paytype_status='ACTIVE' AND mr.paydata_processed_status='Y' AND mr.paydata_timesheet_id!=0 AND  madison_paydata.paydata_emp_username = el.username AND el.lstatus NOT IN ('DA','INACTIVE') AND ".tzRetQueryStringDTime('mr.paydata_processed_date','YMDDate','-')." BETWEEN '".$minDateValue."' AND '".$maxDateValue."'";


		$gstr = " GROUP BY paydata_sno";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstrRate=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFieldsRate);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		
		$tque_rate = "$tque_rate $qstrRate $gstr ";
		
		$oque_rate = "$oque_rate $qstrRate $gstr";
		
		$tque = $tque_rate;
		$oque = $oque_rate." ".$ostr." ".$lstr;
		
		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		
		$gridData=$gd->buildProcessedPayDataList($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildProcessedPayDataList($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clear_mainChkbox() value=\"$row[0]\"><span class='checkmark'></span></label>";
                $grid[$j][1]=$this->convertSpecChars($row[1]);
                $grid[$j][2]=$this->convertSpecChars($row[2]);
                $grid[$j][3]=$this->convertSpecChars($row[3]);
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
				$grid[$j][6]=$this->convertSpecChars($row[6]);
				$grid[$j][7]="";
				$grid[$j][8]=$row[0];
                $j++;
		}
	    return $grid;
	}
	

	//Function for checking duplicate contacts, and displaying result on the grid.
	function duplicateContactChecking($contFname,$contLname,$contEmailCheck)
	{
        $contactNameEmail = "";
        if($contFname!="" && $contLname!="" && $contEmailCheck!="")
        {
            $contactNameEmail = " and ((fname='".$contFname."' and lname='".$contLname."') or email='".$contEmailCheck."') ";

        }
        else if($contEmailCheck!="" && ($contFname=="" || $contLname==""))
        {
            $contactNameEmail=" and email='".$contEmailCheck."' ";
        }
        else if(($contFname!="" || $contLname!="") && $contEmailCheck=="")
        {
            if($contFname!="" && $contLname!="")
                $contactNameEmail = " and ((fname='".$contFname."' and lname='".$contLname."')) ";
            else if($contFname!="")
                $contactNameEmail = " and fname='".$contFname."' ";
            else if($contLname!="")
                $contactNameEmail = " and lname='".$contLname."' ";
        }

        return $contactNameEmail;
    }

    //Function for converting characters with single quotes.
    function gridSearchFieldConvert($gridSearchFieldsVal)
    {
        $gridSearchField=mysql_real_escape_string($gridSearchFieldsVal);
        $gridSearchField=str_replace("%","\%",$gridSearchField);
        //$gridSearchField=str_replace("_","\_",$gridSearchField);

        return $gridSearchField;
    }
	//Function added by vijaya
	//Function for checking duplicate contacts, and displaying result on the grid.
	function duplicateCandidateChecking($candFname,$candLname,$candEmail)
	{
		$candNameEmail = "";
		if($candFname!="" && $candLname!="" && $candEmail!="")
		{
			$candNameEmail = " AND ((candidate_list.fname='".$candFname."' AND candidate_list.lname='".$candLname."') OR candidate_list.email='".$candEmail."') ";
		}
		else if($candEmail!="" && ($candFname=="" || $candLname==""))
		{
			$candNameEmail=" AND candidate_list.email='".$candEmail."' ";
		}
		else if(($candFname!="" || $candLname!="") && $candEmail=="")
		{
			if($candFname!="" && $candLname!="")
				$candNameEmail= " AND ((candidate_list.fname='".$candFname."' AND candidate_list.lname='".$candLname."')) ";
			else if($candFname!="")
				$candNameEmail = " AND candidate_list.fname='".$candFname."' ";
			else if($candLname!="")
				$candNameEmail = " AND candidate_list.lname='".$candLname."' ";
		}
		return $candNameEmail;
	}

	function getHRMDepartments($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
    {
        global $maildb,$db,$username,$user_timezone,$locname;
        $gd = new gridData();
        
        // Searching array
        $asFields=array("","emp_list.emp_fname","emp_list.emp_lname","heading",         
        "deptname","emp_list.primary_phone", "emp_list.email",
        "IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OV','On Vacation',IF(hrcon_jobs.jtype='OP','Project',IF(hrcon_jobs.jtype='AS','Administrative Staff','')))) ","emp_list.emp_tax","emp_list.mtime");
        
        //Sorting Array
        $ssFields=array("","emp_list.emp_fname","emp_list.emp_lname","if(location.loccode!='',CONCAT_WS(' - ',location.loccode,location.heading),location.heading)", 
        "if(dept.depcode!='',CONCAT_WS(' - ',dept.depcode,dept.deptname),dept.deptname)","emp_list.primary_phone", "emp_list.email",
        "IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OV','On Vacation',IF(hrcon_jobs.jtype='OP','Project',IF(hrcon_jobs.jtype='AS','Administrative Staff','')))) ","emp_list.emp_tax","DATE_FORMAT(CONVERT_TZ(emp_list.mtime,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y')");
        
        $tque = "SELECT COUNT(DISTINCT(emp_list.sno)) 
        FROM emp_list 
        LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username AND hrcon_jobs.ustatus in ('active','closed','cancel')), 
        department dept
        LEFT JOIN contact_manage location ON (dept.loc_id=location.serial_no)
        WHERE 
        
         emp_list.lstatus NOT IN ('DA','INACTIVE')
        AND emp_list.empterminated != 'Y'
        AND FIND_IN_SET('".$username."',dept.permission)>0
        
        AND dept.status='Active'";
        
            
        $oque = "SELECT emp_list.sno, emp_list.username, emp_list.emp_fname, emp_list.emp_lname, if(location.loccode!='',CONCAT_WS(' - ',location.loccode,location.heading),location.heading) heading, if(dept.depcode!='',CONCAT_WS(' - ',dept.depcode,dept.deptname),dept.deptname) deptname, replace(emp_list.primary_phone,'---',''), emp_list.email, IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OV','On Vacation',IF(hrcon_jobs.jtype='OP','Project',IF(hrcon_jobs.jtype='AS','Administrative Staff',hrcon_jobs.jtype)))) jobstatus, emp_list.emp_tax         
        FROM emp_list
        LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username AND hrcon_jobs.ustatus in ('active','closed','cancel')), 
        department AS dept
        LEFT JOIN contact_manage AS location ON (dept.loc_id=location.serial_no)
        WHERE 
         emp_list.lstatus NOT IN ('DA','INACTIVE')
        AND emp_list.empterminated != 'Y' 
        
        AND FIND_IN_SET('".$username."',dept.permission)>0
         
        
        AND dept.status='Active'";
        
        //contact_manage ON contact_manage.serial_no=hrcon_compen.location  

        $gstr = " GROUP BY emp_list.username ";
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
        
        $tque=$gd->buildTQuery($tque,$qstr,'');
        
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildHRMDepartments($oque);
        $objResponse = new xajaxResponse();

        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

        return $objResponse;
    
    }   	
	
	function buildHRMDepartments($que)
	{
		global $maildb,$db,$stat;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
							
			if($row[6]=="---")
				$row[6]=str_replace("---","",$row[6]);
			else
				$row[6]=rtrim(substr_replace($row[6],'x',12,1),'x');
				
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[]  value=".$row[0]."|".$varuser." OnClick=chk_clearTop()><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[2]);
			$grid[$j][2]=$this->convertSpecChars($row[3]);
			$grid[$j][3]=$this->convertSpecChars($row[4]);
			$grid[$j][4]=$this->convertSpecChars($row[5]);
			$grid[$j][5]=$this->convertSpecChars($row[6]);
			$grid[$j][6]=$this->convertSpecChars($row[7]);			
			$grid[$j][7]=$this->convertSpecChars($row[8]);
			$grid[$j][8]=$this->convertSpecChars($row[9]);
			$grid[$j][9]="";
			$j++;
		}
      
	    return $grid;
	}
	
	//Function added for Accounts Main Payment Register From Master Table
	function getEmpMainPayRegister($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;		
		$cond = '';
		
		if($gridSortCol=="")
			$gridSortCol=2; //Default Sorting should be by date column
					
		$gd=new gridData();
		
		if($gridExtraFields['datedue']!="") //Client,fromdate, indate fields are coming as extra fields to the grid.
			$datedue = $gridExtraFields['datedue'];
		if($gridExtraFields['datein']!="")
			$datein = $gridExtraFields['datein'];		
		if($gridExtraFields['client']!='' && $gridExtraFields['client']!='none') //Search by client if client is not empty.
			$cond = " AND recieve_pay_master.entityRef = '".$gridExtraFields['client']."'";	
		
		if($gridSearchFields[0]!="")
		{
			$gridSearchFields[0]= strtolower($gridSearchFields[0]);	//customer
		}
		$asFields=array("","".getEntityDispName('staffacc_cinfo.sno', 'LOWER(staffacc_cinfo.cname)', 1)."",tzRetQueryStringDTime('recieve_pay_master.txnDate','Date','/'),"recieve_pay_master.payMethod",
		"recieve_pay_master.chkNumber","reg_category.name","recieve_pay_master.amount","IF(IFNULL(rc.name,'')!='',rc.name,'-')","IFNULL(ac2.amount,0)");
       
		$ssFields=array("","custname","recieve_pay_master.txnDate","recieve_pay_master.payMethod",
		"IF(left(recieve_pay_master.chkNumber,1)>=0,CAST(recieve_pay_master.chkNumber AS SIGNED),0)","reg_category.name","recieve_pay_master.amount","IF(IFNULL(rc.name,'')!='',rc.name,'-')","IFNULL(ac2.amount,0)");
		
		//For Total Records Count
		$tque = "SELECT count(*)
		FROM recieve_pay_master 
		LEFT JOIN reg_category ON reg_category.sno = recieve_pay_master.accountRef
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = recieve_pay_master.entityRef
		LEFT JOIN (SELECT amount, rec_pay_id, cate_id FROM acc_reg WHERE type = 'PMT-ADJ') ac2 ON (ac2.rec_pay_id = recieve_pay_master.sno)
		LEFT JOIN reg_category rc ON (rc.sno = ac2.cate_id)
		WHERE recieve_pay_master.type = 'PMT' 
		AND DATE(recieve_pay_master.txnDate) >= '".$datein."'	
		AND DATE(recieve_pay_master.txnDate) <= '".$datedue."' $cond ";
			
		$oque="SELECT recieve_pay_master.sno, DATE_FORMAT(recieve_pay_master.txnDate, '%m/%d/%Y'), recieve_pay_master.entityRef, 
		recieve_pay_master.type, IF(recieve_pay_master.amount='',0,recieve_pay_master.amount), recieve_pay_master.description, recieve_pay_master.txnDate, reg_category.name, staffacc_cinfo.cname, recieve_pay_master.payMethod, recieve_pay_master.chkNumber, ".getEntityDispName('staffacc_cinfo.sno', 'staffacc_cinfo.cname', 1)." AS custname,IFNULL(ac2.amount,0) AS adjAmount,IF(IFNULL(rc.name,'')!='',rc.name,'-') AS adjustment_type
		
		FROM recieve_pay_master 
		LEFT JOIN reg_category ON reg_category.sno = recieve_pay_master.accountRef
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.username = recieve_pay_master.entityRef
		LEFT JOIN (SELECT amount, rec_pay_id, cate_id FROM acc_reg WHERE type = 'PMT-ADJ') ac2 ON (ac2.rec_pay_id = recieve_pay_master.sno)
		LEFT JOIN reg_category rc ON (rc.sno = ac2.cate_id)
		WHERE recieve_pay_master.type = 'PMT' 
		AND DATE(recieve_pay_master.txnDate) >= '".$datein."'	
		AND DATE(recieve_pay_master.txnDate) <= '".$datedue."' $cond ";
        
        $grpque = "";        
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
        $ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		
		//For the number od records count
		$tque=$gd->buildTQuery($tque,$qstr,'');		
		$total =$gd->getTotalRows($tque);
		
		$oque="$oque $grpque $qstr $ostr $lstr";
		
    	$gridData=$gd->buildEmpMainPayRegister($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildEmpMainPayRegister($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);		
		$decimalPref    = getDecimalPreference();
		while ($row=mysql_fetch_array($res))
		{			
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[11]));// Customer Name
			$grid[$j][2]=$this->convertSpecChars($row[1]); // Date
			$grid[$j][3]=$this->convertSpecChars($row[9]); // Payment Method
			$grid[$j][4]=$this->convertSpecChars($row[10]);// Check Number
			$grid[$j][5]=$this->convertSpecChars($row[7]); // Account Name
			$grid[$j][6]=$this->convertSpecChars(number_format($row[4],$decimalPref,'.','')); // Amount
			$grid[$j][7] =$this->convertSpecChars(stripslashes($row[13])); // Adjustment Type
			$grid[$j][8]=$this->convertSpecChars(number_format($row[12],$decimalPref,'.','')); //Adjustment Amount
			
			$grid[$j][9] ="";
			$grid[$j][10]=$this->convertSpecChars($row[0]);
			$grid[$j][11]="Main";
			$j++;
		}
		return $grid;
	}
	//Accounting-->Workers Compensation...
	function getWCodes($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		$asFields=array("","wc.code","wc.title","wc.state","countries.country","rp.startdate","rp.enddate","rp.amount","wc.cdate","cusers.name","wc.mdate","musers.name");
		$ssFields=array("","wc.code","wc.title","wc.state","countries.country", tzRetQueryStringDTime('rp.startdate','Date','/'),tzRetQueryStringDTime('rp.enddate','Date','/'),"rp.amount",tzRetQueryStringDTime('wc.cdate','DateTime','/'),"cusers.name",tzRetQueryStringDTime('wc.mdate','DateTime','/'),"musers.name");
			
		$tque="SELECT count(1) FROM workerscomp wc LEFT JOIN users cusers ON (cusers.username = wc.cuser) LEFT JOIN rates_period rp ON (rp.parentid = wc.sno AND rp.parenttype = 'WORKERSCOMP') LEFT JOIN users musers ON (musers.username = wc.muser) LEFT JOIN countries ON(countries.sno = wc.country) WHERE wc.status = 'active' ";
		
		$oque="SELECT wc.code, wc.title, wc.state, countries.country, ".tzRetQueryStringDTime("rp.startdate","Date","/").", ".tzRetQueryStringDTime("rp.enddate","Date","/").", rp.amount, ".tzRetQueryStringDTime("wc.cdate","DateTime","/").", cusers.name,".tzRetQueryStringDTime("wc.mdate","DateTime","/").", musers.name,wc.sno FROM workerscomp wc LEFT JOIN rates_period rp ON (rp.parentid = wc.sno AND rp.parenttype = 'WORKERSCOMP') LEFT JOIN users cusers ON (cusers.username = wc.cuser) LEFT JOIN users musers ON (musers.username = wc.muser) LEFT JOIN countries ON(countries.sno = wc.country) WHERE wc.status = 'active'";
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildWCodes($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
		return $objResponse;
	}
	
	function buildWCodes($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[0]));
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][3]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][4]=$this->convertSpecChars(stripslashes($row[3]));
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]=$this->convertSpecChars($row[7]);
			$grid[$j][9]=$this->convertSpecChars(stripslashes($row[8]));
			$grid[$j][10]=$this->convertSpecChars($row[9]);
			$grid[$j][11]=$this->convertSpecChars(stripslashes($row[10]));
			$grid[$j][12]="";
			$grid[$j][13]=$row[11];
			$j++;
		}
        return $grid;
	}
	
	//Accounting-->Accounts...
	function getAccounts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{

		global $maildb,$db,$username,$user_timezone;
		
		$getArrParent = array();
		$getArrBalance = array();
		$getArrAccIds = array();
		$getArrAccType = array();
		$getSrtArrParent = array();
		$getExpDetails = explode("^",$gridExtraFields['getParBalAccIds']);
		
		foreach($getExpDetails as $key => $val)
		{
			$chkExpDetails = explode("|",$val);
			$getArrParent[$chkExpDetails[0]] = $chkExpDetails[1];
			$getArrAccIds[$chkExpDetails[0]] = $chkExpDetails[3];
			$getArrAccType[$chkExpDetails[0]] = $chkExpDetails[4];
			$getSrtArrParent[$chkExpDetails[0]] = strtolower($chkExpDetails[1]);
			
			if($getArrAccType[$chkExpDetails[0]]== '2' || $getArrAccType[$chkExpDetails[0]] == '4' || $getArrAccType[$chkExpDetails[0]] == '3')
				$getArrBalance[$chkExpDetails[0]] = number_format((-1 * $chkExpDetails[2]),2,'.','');
			else
				$getArrBalance[$chkExpDetails[0]] = number_format($chkExpDetails[2],2,'.','');
		}
		
		if($gridSort == "ASC" && ($gridSortCol == 3 || $gridSortCol == 5))
		{
			if($gridSortCol == 3)
			{
				asort($getSrtArrParent);
				$getBalKeys = implode(",",array_keys($getSrtArrParent));
			}
			else
			{
				asort($getArrBalance);
				$getBalKeys = implode(",",array_keys($getArrBalance));
			}
			$chkNewCond = "ORDER BY FIELD(reg_category.sno, $getBalKeys)";
		}
		else if($gridSort == "DESC" && ($gridSortCol == 3 || $gridSortCol == 5))
		{
			if($gridSortCol == 3)
			{
				arsort($getSrtArrParent);
				$getBalKeys = implode(",",array_keys($getSrtArrParent));
			}
			else
			{
				arsort($getArrBalance);
				$getBalKeys = implode(",",array_keys($getArrBalance));

			}
			$chkNewCond = "ORDER BY FIELD(reg_category.sno, $getBalKeys)";
		}
		
		$getCond = "";
		if($gridSearchFields[2] != "")
		{
			$getParentSnos = "";
			foreach($getArrParent as $key => $val)
			{
				if(strpos(strtolower($val),strtolower($gridSearchFields[2])) > -1)
				{
					if($getParentSnos == "")
						$getParentSnos = $key;
					else
						$getParentSnos .= ",".$key;
				}
			}
			$gridSearchFields[2] = "";
			$getCond = "AND reg_category.sno IN (".$getParentSnos.")";
		}
		
		if($gridSearchFields[4] != "")
		{
			$getBalanceSnos = "";
			foreach($getArrBalance as $key => $val)
			{
				if(strpos($val,$gridSearchFields[4]) > -1)
				{
					if($getBalanceSnos == "")
						$getBalanceSnos = $key;
					else
						$getBalanceSnos .= ",".$key;
				}
			}
			$gridSearchFields[4] = "";
			$getCond .= "AND reg_category.sno IN (".$getBalanceSnos.")";
		}
		if($gridSearchFields[3] != "")	//for category type drop list...
		{
			$getCond .= "AND ac_category.tdesc ='".$gridSearchFields[3]."'";
			$gridSearchFields[3] = "";
		}
		
		if($gridExtraFields['getFrmPage'] == "BANKING")
			$addQuery = "AND reg_category.type = 'BANK' AND ac_chart.AccountCatRef = '3'";
		else
			$addQuery = "";
		
		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();
		
		$asFields=array("", "reg_category.name", "reg_category.acc_number", "reg_category.parent", "ac_category.tdesc", "", "", "");
		
		$ssFields=array("", "reg_category.name", "reg_category.acc_number", "reg_category.parent", "ac_category.tdesc", "", "", "");
			
		$tque="SELECT count(1) 
		FROM reg_category,ac_chart 
		LEFT JOIN ac_category ON ac_category.s_no=ac_chart.AccountCatRef 
		WHERE ac_chart.ChartID = reg_category.sno 
		AND reg_category.status IN ('ER') $addQuery $getCond";
		
		$oque="SELECT reg_category.sno, reg_category.name, reg_category.acc_number, reg_category.parent, ac_category.tdesc, '' AS location, '' AS department, reg_category.c_date, reg_category.type, reg_category.status, ac_category.type_ref 
		FROM reg_category,ac_chart 
		LEFT JOIN ac_category ON ac_category.s_no=ac_chart.AccountCatRef 
		WHERE ac_chart.ChartID = reg_category.sno 
		AND reg_category.status IN ('ER') $addQuery $getCond";
		
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		if($gridSortCol != 5 && $gridSortCol != 3)
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		else
			$ostr=$chkNewCond;
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAccounts($oque,$getArrParent,$getArrBalance,$getArrAccIds);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
		return $objResponse;
	}
	
	function buildAccounts($que,$getArrParent,$getArrBalance,$getArrAccIds)
	{
		global $maildb,$db;
		$decimalPref    = getDecimalPreference();
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		
		//for getting the sno of the adjustment type accounts
		$query1	= "SELECT r.sno 
			    FROM reg_category r, ac_chart ac, ac_category acc
			    WHERE r.sno = ac.ChartID
			    AND r.status = 'ER'
			    AND acc.type = r.type
			    AND ac.deflt = 'Y'
			    AND r.parent = (
			    SELECT r.sno
			    FROM reg_category r
			    WHERE r.name = 'Allowance for Doubtful Accounts' or r.name = 'Adjustment Type')
			    ORDER BY r.name";

		$res1 	= mysql_query($query1, $db);
		$sno_arr = array();
		while($row1 = mysql_fetch_array($res1))
		{
			$sno_arr[] = $row1[0];
		}
		
		//for getting the sno of the master adjustment type account
		$query2	= "SELECT r.sno
			    FROM reg_category r
			    WHERE r.name = 'Allowance for Doubtful Accounts' or r.name = 'Adjustment Type'";

		$res2 	= mysql_query($query2, $db);
		$master_sno = mysql_fetch_row($res2);
		
		array_push($sno_arr, $master_sno[0]);
		//----------------------------------------

		
		
		while ($row=mysql_fetch_array($res))
		{
			$balanceDisplay = number_format($getArrBalance[$row[0]],$decimalPref,'.','');
			
			$disabled 	= "";
			$name		= $id		= "auids[]";
			
			if(in_array($row[0],$sno_arr))
			{
				$disabled = " disabled";
				$name		= $id		= "";
			}
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='".$name."' id='".$id."' OnClick='chk_clearTop();' value='".$row[0]."'"." $disabled><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars(stripslashes($getArrParent[$row[0]]));
			$grid[$j][4]=$this->convertSpecChars(stripslashes($row[4]));
			//$grid[$j][5]=$this->convertSpecChars($row[5]);
			//$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][5]=$this->convertSpecChars($balanceDisplay);
			$grid[$j][6]="";
			if(PAYROLL_PROCESS_BY == 'QB')
				$grid[$j][7]="javascript:void(0)";
			else
				$grid[$j][7]="javascript:doReceivePay('".$row[0]."','".$row[8]."','".$getArrAccIds[$row[0]]."')";
			$j++;
		}
		return $grid;
	}
	
	
	//Accounting-->Workers Compensation...
	function getMClasses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{

		global $maildb,$db,$username,$user_timezone;
		if($gridSortCol=="")
		$gridSortCol=1;
		$gd=new gridData();
		
			
		$asFields=array("cs.sno","cs.classname","cp.classname","cusers.name","cs.cdate","musers.name","cs.mdate");		   $ssFields=array("cs.sno","cs.classname","cp.classname","cusers.name",tzRetQueryStringDTime('cs.cdate','DateTime','/'),"musers.name",tzRetQueryStringDTime('cs.mdate','DateTime','/'));
			
		$tque="SELECT count(1) FROM class_setup cs LEFT JOIN class_setup cp ON (cs.parent=cp.sno)  LEFT JOIN users cusers ON (cusers.username = cs.cuser) LEFT JOIN users musers ON (musers.username = cs.muser) WHERE cs.status = 'ACTIVE' ";
	
		$oque="SELECT cs.sno, cs.classname, cp.classname, cusers.name, ".tzRetQueryStringDTime("cs.cdate","DateTime","/").", musers.name,".tzRetQueryStringDTime("cs.mdate","DateTime","/")." FROM class_setup cs LEFT JOIN class_setup cp ON (cs.parent=cp.sno) LEFT JOIN users cusers ON (cusers.username = cs.cuser) LEFT JOIN users musers ON (musers.username = cs.muser) WHERE cs.status = 'ACTIVE' ";
		$gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMClasses($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
		return $objResponse;
	}
	
	
    function buildMClasses($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[]  OnClick=chk_clearTop_TimeSheet() value=".$row[0]."><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$row[0];
			$j++;
		}
        return $grid;
	}
	
	function getDeletedTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)",tzRetQueryStringDTime('t.approvetime','DateTime24Sec','/'));
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)",tzRetQueryStringDTime('t.approvetime','DateTime24Sec','/'));
                
                // TimeSheet Grid Load Optimization 
                $timesheetFromDate =  $gridExtraFields['servicedate'];
                $timesheetToDate =  $gridExtraFields['servicedateto'];
                $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
                if($gd->isSearch($gridSearchFields)){
                    $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
                    $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
                    $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
                    $timesheetFromDate = $gridExtraFields['servicedatesearched'];
                    $timesheetToDate =  $gridExtraFields['servicedateto'];
                }else{
                    $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
                    $timesheetFromDate = $gridExtraFields['servicedate'];
                    $timesheetToDate =  $gridExtraFields['servicedateto'];
                }
                //TimeSheet Grid Load Optimization -Code Ends
                
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE t.status='Deleted' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('p.sdate','Date','/').",".tzRetQueryStringDate('p.edate','Date','/').",IF(p.template='Clockinout',t.hours,ROUND(SUM(t.hours),2)),CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM'  WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END,TRIM(u.name),".tzRetQueryStringDTime('MAX(t.approvetime)','DateTime24Sec','/').",p.username,".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate, IF(t.edate!='0000-00-00','Range','Daily') AS tab
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE t.status='Deleted' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);
		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildDeletedTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//Time Sheet Load Optimization
                 if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
                    $timesheetFromDate = $searchFromDate;
                    $timesheetToDate = $searchToDate;
                 }
        $objResponse->addScriptCall("updateGridDateDisplay",$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////

		return $objResponse;
	}
	
	function buildDeletedTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars(stripslashes($row[9]));
			if($row[10] == 'Clock In & Out'){
				$grid[$j][10]=$row[10];
			}
			else{
				$grid[$j][10]=$this->convertSpecChars($row[10])."(".$this->convertSpecChars($row[16]).")";
			}
			$grid[$j][11]=$this->convertSpecChars($row[11]);
			$grid[$j][12]=$this->convertSpecChars($row[12]);
			$grid[$j][13]=$row[0]."|".$row[10];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization
			$j++;
		}
        // TimeSheet Grid Load Optimization 
            asort($mindatearray);
            asort($maxdatearray);
            $mindate = reset($mindatearray);
            $maxdate = end($maxdatearray);
            unset($midate);
            unset($mindatearray);
            unset($maxdatearray);
            unset($madate);
            $grid['totalCount'] = mysql_num_rows($res);
            $grid['maxdate'] = $maxdate;
            $grid['mindate'] = $mindate;
            // TimeSheet Grid Load Optimization 
      
	    return $grid;
	}

	function buildDeletedHisTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]=$row[0];
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]="";
			$grid[$j][8]=$row[6];
			$j++;
		}
      
	    return $grid;
	}
	
	function  getDeletedExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$parTimeUsername = $gridExtraFields['addr'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));
		$decimalPref    = getDecimalPreference();      

		
		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();
		
		if($parTimeUsername != "")
		{		$asFields=array("",tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/'),tzRetQueryStringDate('MAX(par_expense.edate)','Date','/'),"ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)","ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)","users.name",tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24','/'));
			$ssFields=array("","MIN(par_expense.sdate)","MAX(par_expense.edate)","ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)","ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)","users.name",tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24','/'));
	
			$tque = "SELECT COUNT(1) FROM (SELECT '', ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), users.name, ".tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24','/').", expense.parid FROM par_expense LEFT JOIN expense ON expense.parid=par_expense.sno LEFT JOIN users ON users.username=expense.approveuser WHERE par_expense.username='".$parTimeUsername."' AND par_expense.astatus = 'Deleted' AND expense.status = 'Deleted' AND ".tzRetQueryStringDate('par_expense.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_expense.edate','YMDDate','-')."<='".$maxDateValue."'";
			
			$oque = "SELECT par_expense.sno, ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), users.name, ".tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24','/').", expense.parid FROM par_expense LEFT JOIN expense ON expense.parid=par_expense.sno LEFT JOIN users ON users.username=expense.approveuser WHERE par_expense.username='".$parTimeUsername."' AND par_expense.astatus = 'Deleted' AND expense.status = 'Deleted' AND ".tzRetQueryStringDate('par_expense.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_expense.edate','YMDDate','-')."<='".$maxDateValue."'";
	
			$grp_str = " GROUP BY par_expense.sno";
			$lstr = $gd->buildLimt($gridPage,$gridRecords);
			$qstr1 = $gd->buildQSTRTimeSht($gridSearchType,$gridSearchFields,$asFields);
			$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
	
			$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1.')a');
		}
		else
		{	$asFields=array("","emp_list.name","emp_list.sno",tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/'),tzRetQueryStringDate('MAX(par_expense.edate)','Date','/'),"ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)"," ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)");
			$ssFields=array("","trim(emp_list.name)","emp_list.sno","MIN(par_expense.sdate)","MAX(par_expense.edate)","ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)"," ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)");
	
			$tque = "SELECT COUNT(1) FROM (SELECT '', emp_list.name, emp_list.sno, ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').",". tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), par_expense.username FROM par_expense LEFT JOIN emp_list ON emp_list.username=par_expense.username LEFT JOIN expense ON expense.parid=par_expense.sno WHERE par_expense.astatus = 'Deleted' AND par_expense.username=emp_list.username AND expense.status = 'Deleted' AND ".tzRetQueryStringDate('expense.edate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('expense.edate','YMDDate','-')."<='".$maxDateValue."'";
			
			 $oque = "SELECT par_expense.sno, emp_list.name, emp_list.sno, ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').",". tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), par_expense.username FROM par_expense LEFT JOIN emp_list ON emp_list.username=par_expense.username LEFT JOIN expense ON expense.parid=par_expense.sno WHERE par_expense.astatus = 'Deleted' AND par_expense.username=emp_list.username AND expense.status = 'Deleted' AND ".tzRetQueryStringDate('expense.edate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('expense.edate','YMDDate','-')."<='".$maxDateValue."'";
	
			$grp_str = " GROUP BY par_expense.username";
			$lstr = $gd->buildLimt($gridPage,$gridRecords);
			$qstr1 = $gd->buildQSTRTimeSht($gridSearchType,$gridSearchFields,$asFields);
			$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
	
			$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1.')a');
		}
		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";
		
    	$total = $gd->getTotalRows($tque);
		$gridData = $gd->buildDeletedExpenses($oque);
		
		$objResponse = new xajaxResponse();
		
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}

	function buildDeletedExpenses($que)
	{

		global $maildb,$db;

		$j=0;
		$grid=array();
		
		$decimalPref    = getDecimalPreference();
		
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]="";
			$grid[$j][9]=$row[8];
			$j++;
		}
      
	    return $grid;
	}
	
	// Short List 
	function getShortList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$user_timezone,$cvsid;
		$seltab = $gridExtraFields['selected_tab'];
		$posid = $gridExtraFields['posid'];
		$jobType = $gridExtraFields['jobType'];
		$selected_tab = $gridExtraFields['selected_tab'];
		$jo_shift_type = $gridExtraFields['jo_shift_type'];
		$module = $gridExtraFields['module'];
		$gd=new gridData();

		if($aqstr=="")
			$aqstr=" 1=1 ";
			
		$setHeapSizeQry = "SET SESSION max_heap_table_size=1073740800";
		mysql_query($setHeapSizeQry,$db);
					
		$setTmpTableSizeQry = "SET SESSION tmp_table_size=1073740800";
		mysql_query($setTmpTableSizeQry,$db);

		$cand_sub_query="(select concat(res_id,'-',shift_id) from resume_status, manage WHERE manage.sno = resume_status.status AND req_id='$posid' AND manage.name NOT IN ('Closed','Cancelled') AND resume_status.pstatus!='A')";
		$shifname_qry = "";
		$shiftname_cols = ""; 
		
		/*
			Author : Sunil Kumar VC - 25-09-2014
			Fetching all the columns from 'udv_grid_columns' 	
		*/
		$custom_grid_function_obj = new CustomGridFunctions();
		$grid_details = $custom_grid_function_obj->getGridName("Manage Shortlist",$username,$cvsid);	
		
		$deletescores = mysql_query("delete from candidates_matchingscore where DATE_FORMAT(ctime,'%Y-%m-%d') < DATE_FORMAT(NOW(),'%Y-%m-%d') ",$db);
	    $deletescores = mysql_query("delete from candidates_matchingscore where username='".$username."' and posid =".$posid." and module='sl' ",$db);
				
		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			//require("searchdatabase.inc");

			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);

			require("quickSubCandidates.inc");
			
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			$customesearch = true;
			
			require("visualsearch_slcandidates.php");
			require("database.inc");
		}
		
		if(!empty($gridExtraFields['scheduleviewtype']) && !empty($gridExtraFields['schedulesearchtype'])){
			
			// All distinct job order shift dates stored in this array
			$jo_shifts_arr = array();
			
			// Stores Candidate's Details
			$candidates_details = array();
			
			// Stores Candidate's Username
			$candidates_usernames = array();
			
			//Show only those shift dates which are present in selected shift
			if(!empty($gridExtraFields['sm_shift_snos'])){
				$selShiftCond = " AND sm_sno IN (".$gridExtraFields['sm_shift_snos'].") ";
				$selPerdiemShiftCond = " AND shift_id IN (".$gridExtraFields['sm_shift_snos'].") ";
			}
			
			// Find distinct shift schedule dates for job order. Required to map the data correctly with the columns in the grid. Considers 90 Days only starting from yesterday.		
			if($jo_shift_type == "perdiem")
			{
				$jo_sel_shifts = "SELECT DISTINCT(DATE_FORMAT(shift_startdate,'%m/%d/%Y')) as shift_date FROM jo_perdiem_shift_sch WHERE posid = '".$posid."'  AND shift_startdate >= DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ".$selPerdiemShiftCond." ORDER BY shift_startdate ASC LIMIT 0,90 ";
			}	
			else
			{
			 	$jo_sel_shifts = "SELECT DISTINCT(DATE_FORMAT(shift_date,'%m/%d/%Y')) as shift_date FROM posdesc_sm_timeslots WHERE pid = '".$posid."'  AND shift_date >= DATE_SUB(CURDATE(), INTERVAL 2 MONTH) ".$selShiftCond." ORDER BY shift_date ASC LIMIT 0,90";
			}
			
			$jo_res_shifts = mysql_query($jo_sel_shifts,$db);
		
			while($jo_row_shifts = mysql_fetch_array($jo_res_shifts)){
				$jo_shifts_arr[] = $jo_row_shifts['shift_date'];
			}	
			
			usort($jo_shifts_arr, array($this, "sort_shift_dates"));
			$jo_shifts_arr_len = count($jo_shifts_arr);		
			
			if($jo_shifts_arr_len > 0){
				$search_module = 'schedulesearch';			

				if($jo_shift_type == "perdiem")
				{
					$candidates_details = $gd->getCandidatesMatchingJOPerdiemShifts($posid, $jo_shifts_arr, $gridExtraFields);	
				}
				else{
									
					$candidates_details = $gd->getCandidatesMatchingJOShifts($posid, $jo_shifts_arr, $gridExtraFields,$search_module);
				}
				$candidates_usernames = array_keys($candidates_details);
			}
			$ss_cand_sub_query = " AND candidate_list.username IN ('".implode("','",$candidates_usernames)."') ";
		}
		if($selected_tab == 1){
			$gstr = "GROUP BY candidate_list.sno";
		}else {
			$gstr = " ";
		}
		

		if(!empty($grid_details))
		{
			$strQryString = $custom_grid_function_obj->getCustomizeColumns("Manage Shortlist",$username,$cvsid);
			if($strQryString != '')
			{
				 $whereCondition = " WHERE ".$aqstr.$ss_cand_sub_query." 
					AND short_lists.reqid=".$posid." 
					AND candidate_list.status='ACTIVE' 
					AND concat(candidate_list.sno,'-',IF(shift_setup.sno IS NULL,0,shift_setup.sno)) NOT IN ".$cand_sub_query; 
				$arrExp = explode("@@@",$strQryString);

				// Budiling the SELECT Query with WHERE Conditions
				$oque = $arrExp[0]." LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.posid = $posid and cm.module='sl' ) 
				LEFT JOIN shift_setup ON (shift_setup.sno = short_lists.shift_id)".$whereCondition;
				
				// Budiling the Count(1) SELECT Query with WHERE Conditions
				$tque = $arrExp[1]." LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.posid = $posid and cm.module='sl' ) 
				LEFT JOIN shift_setup ON (shift_setup.sno = short_lists.shift_id)".$whereCondition;
				
				// Sunil written function for manageshortlist customize grid.
				$asFields = $custom_grid_function_obj->getAsFields("Manage Shortlist", $username, $cvsid);
					array_push($asFields, "cm.score");
					$as_string = implode("^",$asFields);
					$as_zip_pos = strpos($as_string, "zip");
			if($as_zip_pos > 0)
			{
				$as_zip_pos = (strpos($as_string, "zip")+strlen("zip"))+1;
				
				if($as_zip_pos == (strlen($as_string)+1))
					$as_string = substr($as_string, 0, $as_zip_pos)."^ZCR ".substr($as_string, $as_zip_pos, strlen($as_string));
				else
					$as_string = substr($as_string, 0, $as_zip_pos)."ZCR^".substr($as_string, $as_zip_pos, strlen($as_string));
				$asFields = explode("^",$as_string);
			}

			$as_acr_pos = strpos($as_string, "hphone");
			if($as_acr_pos > 0)
			{
				$as_acr_pos = (strpos($as_string, "hphone")+strlen("hphone"))+1;
				
				if($as_acr_pos == (strlen($as_string)+1))
					$as_string = substr($as_string, 0, $as_acr_pos)."^ACR ".substr($as_string, $as_acr_pos, strlen($as_string));
				else
					$as_string = substr($as_string, 0, $as_acr_pos)."ACR^".substr($as_string, $as_acr_pos, strlen($as_string));
				$asFields = explode("^",$as_string);
			}
				$ssFields=$custom_grid_function_obj->getSsFields("Manage Shortlist", $username, $cvsid);				
					array_push($ssFields, "cm.score" );	
					$ss_string = implode("^",$ssFields);
			$ss_zip_pos = strpos($ss_string, "zip");
			if($ss_zip_pos > 0)
			{
				$ss_zip_pos = (strpos($ss_string, "zip")+strlen("zip"))+1;
				
				if($ss_zip_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."^ZCR ".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."ZCR^".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}

			$ss_acr_pos = strpos($ss_string, "hphone");
			if($ss_acr_pos > 0)
			{
				$ss_acr_pos = (strpos($ss_string, "hphone")+strlen("hphone"))+1;
				
				if($ss_acr_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."^ACR ".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."ACR^".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}					
				$lstr=$gd->buildLimt($gridPage,$gridRecords);	
				if(trim($gridExtraFields['resume'])=="" || ($gridExtraFields['SpeedSearchString']=='' && $gridExtraFields['SpeedSearchString']=='?'))
				{
					// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
					foreach($ssFields as $ssFields_key => $ssFields_value) {
						if (strpos($ssFields_value, 'desirejob') !== false) {
						   $asFieldsKey = $ssFields_key;
						   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
						}
					}
				}
				// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
				if(in_array('candidate_list.hphone',$asFields)){
					$asFieldsKey = array_search("candidate_list.hphone", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
				}
				if(in_array('candidate_list.wphone',$asFields)){
					$asFieldsKey = array_search("candidate_list.wphone", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
				}
				if(in_array('candidate_list.mobile',$asFields)){
					$asFieldsKey = array_search("candidate_list.mobile", $asFields);
					$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
					$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
				}
				$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
				
				if($gridSortCol == 150)
				{
					$ostr = " ORDER BY short_lists.sdate DESC";					
				}
				else
				{
					$sortFlag = 0;				
					if(is_array($ssFields))
					{
						if($ssFields[$gridSortCol] == 'last_modified')
						{
							$ostr = " ORDER BY candidate_list.mtime ".$gridSort;
							$sortFlag =1;
						}
						if($ssFields[$gridSortCol] == 'listed_date')
						{
							$ostr = " ORDER BY short_lists.sdate ".$gridSort;	
							$sortFlag =1;
						}
                        if(strpos($ssFields[$gridSortCol], 'availsdate') !== false){
                            $tableAliasValue = explode('.availsdate',substr($ssFields[$gridSortCol],3,20)); 
                            $ostr ="ORDER BY IF(".$tableAliasValue[0].".availsdate = 'inactive', 'Inactive', IF((".$tableAliasValue[0].".availsdate = '0-0-0' OR ".$tableAliasValue[0].".availsdate = '' OR ".$tableAliasValue[0].".availsdate IS NULL OR ".$tableAliasValue[0].".availsdate = 'immediate'),'Immediate', IF((datediff(".$tableAliasValue[0].".availsdate, now())) < 0,'Immediate', DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availsdate, '%Y-%m-%d'), '%Y-%m-%d')))) ".$gridSort ;
                            $sortFlag =1;
                        } 
                        if(strpos($ssFields[$gridSortCol], 'availedate') !== false){
                                $tableAliasValue = explode('.availedate',substr($ssFields[$gridSortCol],4,20)); 
                                $ostr ="ORDER BY IF((".$tableAliasValue[0].".availedate = '0-0-0' OR ".$tableAliasValue[0].".availedate = '' OR ".$tableAliasValue[0].".availedate IS NULL),'' ,DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availedate, '%Y-%m-%d'), '%Y-%m-%d')) ".$gridSort;
                                $sortFlag =1;
                        }
					}					
					if($sortFlag == 0)
					{
						$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
					}
				}

				//$tque=$gd->buildTQuery($tque,$qstr.$duplicateCheck,$gstr);
				//$oque=$gd->buildOQuery($oque,$qstr.$duplicateCheck,$ostr,$lstr,$gstr);
			}
		}
		else
		{
			// Below is the restore view code.
			$tque="SELECT COUNT(DISTINCT CONCAT(candidate_list.sno,'-',short_lists.shift_id)) FROM candidate_list 
			LEFT JOIN short_lists ON  short_lists.candid = candidate_list.sno
			LEFT JOIN manage spriority ON short_lists.priority = spriority.sno and spriority.type='slpriority'
			LEFT JOIN users slmuser ON slmuser.username = short_lists.suser
			LEFT JOIN users muser ON muser.username = candidate_list.muser
			LEFT JOIN manage ON manage.sno = candidate_list.jobcatid AND manage.type='candjobcat' 
			LEFT JOIN manage msource ON msource.sno = candidate_list.cl_sourcetype AND msource.type='candsourcetype'
			LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.posid = $posid and cm.module='sl')
			LEFT JOIN shift_setup ON (shift_setup.sno = short_lists.shift_id)
			WHERE ".$aqstr.$ss_cand_sub_query." 
			AND short_lists.reqid='$posid' 
			AND candidate_list.status='ACTIVE' 
			AND concat(candidate_list.sno,'-',IF(shift_setup.sno IS NULL,0,shift_setup.sno)) NOT IN  ".$cand_sub_query;
			
			/* Added columns to solved incorrect data display in record columns */

			$oque="SELECT 
			candidate_list.sno, 
			candidate_list.username, 
			candidate_list.profiletitle, 
			CONCAT_WS(' ', candidate_list.fname,candidate_list.mname,candidate_list.lname) as candname,
			manage.name as category,
			candidate_list.recentemp as company, 
			candidate_list.hphone as pno,
            candidate_list.wphone as spno,
            candidate_list.mobile as mobile,			
			candidate_list.city, 
			candidate_list.cand_sourcetype, 
			candidate_list.state, 
			candidate_list.zip, 
			spriority.name as priority,
			".tzRetQueryStringDTime('candidate_list.mtime','DateTime','/')." as candmdate,
			muser.name as candmuser,
			".tzRetQueryStringDTime('short_lists.sdate','DateTime','/')." as sldate,
			slmuser.name as sluser, 
			candidate_list.resid, 
			candidate_list.cl_source as source,
			msource.name as sourcetype,
			(SELECT status FROM viInterviews WHERE posid='".$posid."' and candid=candidate_list.sno ORDER BY mdate DESC limit 1) as IntStatus,
			(SELECT slink FROM viInterviews WHERE posid='".$posid."' and candid=candidate_list.sno AND slink!='' ORDER BY mdate DESC limit 1) as SLink,
			cm.score as score,
			shift_setup.shiftname AS shiftname,
         	IF(shift_setup.sno IS NULL,0,shift_setup.sno) AS shiftid
			FROM candidate_list 
			LEFT JOIN short_lists ON short_lists.candid = candidate_list.sno
			LEFT JOIN manage spriority ON short_lists.priority = spriority.sno and spriority.type='slpriority'
			LEFT JOIN users slmuser ON slmuser.username = short_lists.suser
			LEFT JOIN users muser ON muser.username = candidate_list.muser
			LEFT JOIN manage ON manage.sno = candidate_list.jobcatid AND manage.type='candjobcat' 
			LEFT JOIN manage msource ON msource.sno = candidate_list.cl_sourcetype AND msource.type='candsourcetype'
			LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.posid = $posid and cm.module='sl')
			LEFT JOIN shift_setup ON (shift_setup.sno = short_lists.shift_id)
			WHERE ".$aqstr.$ss_cand_sub_query." 
			AND short_lists.reqid='$posid' 
			AND candidate_list.status='ACTIVE' 
			AND concat(candidate_list.sno,'-',IF(shift_setup.sno IS NULL,0,shift_setup.sno)) NOT IN  ".$cand_sub_query;

			// Custom view logic === CONCAT_WS(" ", candidate_list.fname,candidate_list.mname, candidate_list.lname)
			$asFields=array("","candidate_list.profiletitle","shift_setup.shiftname","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","manage.name","candidate_list.recentemp","IF(candidate_list.hphone='---','',candidate_list.hphone)","IF(candidate_list.wphone='---','',candidate_list.wphone)","IF(candidate_list.mobile='---','',candidate_list.mobile)","ACR","candidate_list.city","candidate_list.state","candidate_list.zip","ZCR","candidate_list.cl_source","msource.name","spriority.name","(SELECT status FROM viInterviews WHERE posid='$posid' and candid=candidate_list.sno ORDER BY mdate DESC limit 1)",tzRetQueryStringDTime('candidate_list.mtime','DateTime','/'),"muser.name",tzRetQueryStringDTime('short_lists.sdate','DateTime','/'),"slmuser.name","cm.score","");
			$ssFields=array("","candidate_list.profiletitle","shift_setup.shiftname","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')","manage.name","candidate_list.recentemp","IF(candidate_list.hphone='---','',candidate_list.hphone)","IF(candidate_list.wphone='---','',candidate_list.wphone)","IF(candidate_list.mobile='---','',candidate_list.mobile)","ACR","candidate_list.city","candidate_list.state","candidate_list.zip","ZCR","candidate_list.cl_source","msource.name","spriority.name","(SELECT status FROM viInterviews WHERE posid='$posid' and candid=candidate_list.sno ORDER BY mdate DESC limit 1)","candidate_list.mtime","muser.name","short_lists.sdate","slmuser.name","cm.score","");
			
			if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
			{
				$gridSortCol = 20;
			}
			else{
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
				foreach($ssFields as $ssFields_key => $ssFields_value) {
					if (strpos($ssFields_value, 'desirejob') !== false) {
					   $asFieldsKey = $ssFields_key;
					   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
					}
				}
			}
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array("IF(candidate_list.hphone='---','',candidate_list.hphone)",$asFields)){
				$asFieldsKey = array_search("IF(candidate_list.hphone='---','',candidate_list.hphone)", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("IF(candidate_list.hphone='---','',candidate_list.hphone)",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("IF(candidate_list.hphone='---','',candidate_list.hphone)",$gridSearchFields,$asFieldsKey);
			}
			if(in_array("IF(candidate_list.wphone='---','',candidate_list.wphone)",$asFields)){
				$asFieldsKey = array_search("IF(candidate_list.wphone='---','',candidate_list.wphone)", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("IF(candidate_list.wphone='---','',candidate_list.wphone)",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("IF(candidate_list.wphone='---','',candidate_list.wphone)",$gridSearchFields,$asFieldsKey);
			}
			if(in_array("IF(candidate_list.mobile='---','',candidate_list.mobile)",$asFields)){
				$asFieldsKey = array_search("IF(candidate_list.mobile='---','',candidate_list.mobile)", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("IF(candidate_list.mobile='---','',candidate_list.mobile)",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("IF(candidate_list.mobile='---','',candidate_list.mobile)",$gridSearchFields,$asFieldsKey);
			}

			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);				
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

			//$tque=$gd->buildTQuery($tque,$qstr.$duplicateCheck,$gstr);
			//$oque=$gd->buildOQuery($oque,$qstr.$duplicateCheck,$ostr,$lstr,$gstr);			
		}
		
		if($gridExtraFields['tabname'] == "schedulesearch"){
			
			$asFields=array("","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')");
		
			$ssFields=array("","REPLACE(CONCAT_WS(' ', candidate_list.fname,candidate_list.mname, candidate_list.lname),'  ',' ')");				
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
	
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);				
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		}

		$tque=$gd->buildTQuery($tque,$qstr.$duplicateCheck,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr.$duplicateCheck,$ostr,$lstr,$gstr);
		
		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}
		
		if($gridExtraFields['tabname'] == "schedulesearch"){
			if($gridExtraFields['scheduleviewtype'] == 2){
			$gridData=$gd->builShortListScheduleSearchDailyDetailsView($oque,$posid,$gridExtraFields,$candidates_details);
			}else{				
				$gridData=$gd->buildShortListScheduleSearch($oque,$posid,$gridExtraFields,$jo_shifts_arr,$candidates_details,$jo_shift_type);
			}
		}else{		
		// ZCR order by condition 
		if(isset($_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']))
		{
			if(isset($_SESSION['ZCR_SPHINX_SLCandidates'])){
				$zipMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']);
				$ZcrSortArr = $_SESSION['ZCR_SPHINX_SLCandidates'];

				asort($ZcrSortArr[$zipMilesArr[1]]);

				$ZcrOrderByQry = "'".implode("','",array_keys($ZcrSortArr[$zipMilesArr[1]]))."'";

				$oque = str_replace("ZCR","field(candidate_list.zip,".$ZcrOrderByQry.")",$oque);
				}else {
				$oque = str_replace("ZCR","candidate_list.zip",$oque);
			}
			
		} else {
			$oque = str_replace("ZCR","candidate_list.zip",$oque);
		}

		// ACR order by condition 
		if(isset($_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']))
		{
			if(isset($_SESSION['ACR_SPHINX_SLCandidates'])){
				$areaMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']);
				$AcrSortArr = $_SESSION['ACR_SPHINX_SLCandidates'];

				asort($AcrSortArr[$areaMilesArr[1]]);

				$AcrOrderByQry = "'".implode("','",array_keys($AcrSortArr[$areaMilesArr[1]]))."'";

				$oque = str_replace("ACR","field(candidate_list.hareacode,".$AcrOrderByQry.")",$oque);
			}
			else {
				$oque = str_replace("ACR","candidate_list.hareacode",$oque);
			}
		} else {
			$oque = str_replace("ACR","candidate_list.hareacode",$oque);
		}	
			$gridData=$gd->buildShortList($oque,$posid,'',$module);			
		}
		$objResponse = new xajaxResponse();		
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
	
	// Short List Candidates Grid Data
	function buildShortList($que,$posid,$cvsid,$module)
	{
		global $maildb,$db,$username;		
		$gd=new gridData();
		$j=0;
		$grid=array();$arrResumeVal = array();
		$custom_grid_function_obj = new CustomGridFunctions();
        $grid_details = $custom_grid_function_obj->getGridName("Manage Shortlist",$username,$cvsid);	
		$res=mysql_query($que,$db);
		$k = 1;
		$grid_header = array();
		if(!empty($grid_details))
		{
			// Fetching the headers
			$res_grid_headers = mysql_query($que,$db);			
			while($rec_grid_headers = mysql_fetch_field($res_grid_headers))
			{
				$grid_header[] = strtolower($rec_grid_headers->name);
			}
			unset($grid_header[array_search( 'shiftid', $grid_header )] );
			
			$grid_cols = 0;
			while($row=mysql_fetch_row($res))
			{ 
				
			    $intCntRw = count($row);
		
				for($i=0;$i<$intCntRw;$i++)
				{ 
					if($i == 0)
					{  
						$grid[$j][0]="<label for='newuichk_".$j."' class='container-chk'><input type=hidden name=cand[] value='".$row[0]."'><input type=checkbox name=auids[] id='newuichk_".$j."' OnClick='chk_clearTop()' value='".$row[2]."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row[0]."'><input type=hidden name=shiftids[] value='".$row[3]."'>";
					}
					else
					{
						// Skipping the first three columns values
						if($i !=1 && $i !=2 && $i !=3)
						{ 

							if($grid_header[$i] == 'candidate_name')
							{
								$grid[$j][$k]= "<a href=javascript:winopennew('review.php?type=cand&posid=$posid&cno=".$row['0']."&module=$module')><font class=linkrow>".html_tls_specialchars(trim($row[$i]),ENT_QUOTES)."</font></a>";
							}
							if($grid_header[$i] == "desirejob")
							{
								
								if($row[$i] == ''){
									$grid[$j][$k] = '';
								}else{
									$desiredJob = explode('|',$row[$i]);
									$desiredJob = array_filter($desiredJob);
									$grid[$j][$k] = implode(',',$desiredJob);
								}
							}
							else
							{
								$grid[$j][$k]= $this->convertSpecChars($row[$i]);
							}
							// Zipcode Radius (ZCR) Condition
						if(strtolower($grid_header[$i]) == "zip")
						{
						$k++;
							if(isset($_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_SLCandidates']))
							{
								$zipMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']);
								$grid[$j][$k] = $_SESSION['ZCR_SPHINX_SLCandidates'][$zipMilesArr[1]][$row[$i]];
							} else {
								$grid[$j][$k]='';
							}
						}
						// Areacode Radius (ACR) Condition
						if(strtolower($grid_header[$i]) == "hphone")
						{
						$k++;
							if(isset($_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_SLCandidates']))
							{
								$areaMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']);
								$grid[$j][$k] = $gd->getAreaCodeRadiusPSM($row[0],'candidate_list',$areaMilesArr[1],'ACR_SPHINX_SLCandidates');                           
							} else {
								$grid[$j][$k]="";
							}
						}
					
							$k++;	
						}
						elseif($i == 2)
						{
							if($grid_header[$i] == 'resid')
							{
								if($row[$i]=="" || $row[$i]==0)
								{
									$arrResumeVal ="";
								}
								else
								{
									$resno=$row[$i];
									$que_resume="select sno,res_name,markadd,filetype from con_resumes where sno=".$resno;
									$result_resume=mysql_query($que_resume,$db);
									$row_resume=mysql_fetch_row($result_resume);

									if($row_resume[2]=="")
										$res_name=$row_resume[1].".doc";
									else
										$res_name=$row_resume[2];

									$Ext_info = pathinfo($res_name);
									$Ext_name= $Ext_info['extension'];

									if($Ext_name=="htm" || $Ext_name=="xhtml" || $Ext_name=="xml" || $Ext_name=="html")
										$arrResumeVal ="<a href=javascript:candResumeOpen('getresume.php?fsno=$resno','resm')><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
									else
										$arrResumeVal="<a href=getresume.php?fsno=".$resno."><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
								}
							}
						}

						if($i == $intCntRw-1)
						{
							$grid[$j][$k] = $arrResumeVal;
							$grid[$j][$k+1] = "review.php?cno=".$row['0']."&posid=$posid&dest=0&module=$module";
						}
					}
				}

				$k=1;
				$j++;
			}
		}
		else
		{
			while ($row=mysql_fetch_array($res))
			{
			    /* Added grids to solved incorrect data display in record columns */
				
				$grid[$j][0]="<label for='newuichk_".$j."' class='container-chk'><input type=hidden name=cand[] value='".$row['sno']."'><input type=checkbox name=auids[] id='newuichk_".$j."' OnClick='chk_clearTop()' value='".$row['resid']."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row['sno']."'><input type=hidden name=shiftids[] value='".$row['shiftid']."'>";
				$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
				$grid[$j][2]=$this->convertSpecChars($row['shiftname']);
				$grid[$j][3]="<a href=javascript:winopennew('review.php?type=cand&posid=$posid&cno=".$row['sno']."&module=$module')><font class=linkrow>".html_tls_specialchars(trim($row['candname']),ENT_QUOTES)."</font></a>";
				$grid[$j][4]=$this->convertSpecChars($row['category']);
				$grid[$j][5]=$this->convertSpecChars($row['company']);
				$grid[$j][6]=$this->convertSpecChars($row['pno']);
				$grid[$j][7]=$this->convertSpecChars($row['spno']);
				$grid[$j][8]=$this->convertSpecChars($row['mobile']);
				// Areacode Radius (ACR) Condition
				if(isset($_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_SLCandidates']))
				{
					$areaMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['saveareacodePSM']);
					if(isset($_SESSION['ACR_SPHINX_SLCandidates'][$areaMilesArr[1]][$row['hareacode']]))
					{
						$grid[$j][9] = $_SESSION['ACR_SPHINX_SLCandidates'][$areaMilesArr[1]][$row['hareacode']];
					} else if(isset($_SESSION['ACR_SPHINX_SLCandidates'][$areaMilesArr[1]][$row['wareacode']])) {
						$grid[$j][9] = $_SESSION['ACR_SPHINX_SLCandidates'][$areaMilesArr[1]][$row['wareacode']];
					} else {
						$grid[$j][9] = $_SESSION['ACR_SPHINX_SLCandidates'][$areaMilesArr[1]][$row['mareacode']];
					}
				} else {
					$grid[$j][9]="";
				}
				$grid[$j][10]=$this->convertSpecChars($row['city']);
				$grid[$j][11]=$this->convertSpecChars($row['state']);
				$grid[$j][12]=$this->convertSpecChars($row['zip']);
				// Zipcode Radius (ZCR) Condition
				if(isset($_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_SLCandidates']))
				{
					$zipMilesArr = explode("|", $_SESSION['SPHINX_SLCandidates_sub']['savezipCODE']);
					$grid[$j][13] = $_SESSION['ZCR_SPHINX_SLCandidates'][$zipMilesArr[1]][$row['zip']];
				} else {
					$grid[$j][13]="";
				}
				$grid[$j][14]=$this->convertSpecChars($row['source']);
				$grid[$j][15]=$this->convertSpecChars($row['sourcetype']);
				$grid[$j][16]=$this->convertSpecChars($row['priority']);

				if(strtolower($row['IntStatus'])=="completed" && $row['SLink']!="")
					$grid[$j][17]="<a href='".stripslashes($row['SLink'])."' target=_blank><font class=linkrow>".ucfirst($this->convertSpecChars($row['IntStatus']))."</font></a>";
				else
					$grid[$j][17]=ucfirst($this->convertSpecChars($row['IntStatus']));

				$grid[$j][18]=$this->convertSpecChars($row['candmdate']);
				$grid[$j][19]=$this->convertSpecChars($row['candmuser']);
				$grid[$j][20]=$this->convertSpecChars($row['sldate']);
				$grid[$j][21]=$this->convertSpecChars($row['sluser']);
				$grid[$j][22]=$this->convertSpecChars($row['score']);
				$grid[$j][23]="";
				$grid[$j][24]="";

				if($row['resid']=="" || $row['resid']==0)
				{
					$grid[$j][23]="";
				}
				else
				{
					$resno=$row['resid'];
					$que_resume="select sno,res_name,markadd,filetype from con_resumes where sno=".$resno;
					$result_resume=mysql_query($que_resume,$db);
					$row_resume=mysql_fetch_row($result_resume);

					if($row_resume[2]=="")
						$res_name=$row_resume[1].".doc";
					else
						$res_name=$row_resume[2];

					$Ext_info = pathinfo($res_name);
					$Ext_name= $Ext_info['extension'];

					if($Ext_name=="htm" || $Ext_name=="xhtml" || $Ext_name=="xml" || $Ext_name=="html")
						$grid[$j][23]="<a href=javascript:candResumeOpen('getresume.php?fsno=$resno','resm')><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
					else
						$grid[$j][23]="<a href=getresume.php?fsno=".$resno."><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
				}
				$grid[$j][24]="review.php?cno=".$row['sno']."&posid=$posid&dest=0&module=$module";
				$j++;
			}
		}
		return $grid;
	}
	
	// Full Schedule View in Shortlisted Candidates Schedule Search
	function buildShortListScheduleSearch($que,$posid,$gridExtraFields,$jo_shifts_arr,$candidates_details,$jo_shift_type)
	{ 
		global $maildb,$db,$username;		
		$j=0;
		$grid=array();$arrResumeVal = array();
		
		$jo_shifts_arr_uniq = array_values(array_unique($jo_shifts_arr)) ;
		$jo_shifts_arr_len = count($jo_shifts_arr_uniq);
		$sm_sno = $gridExtraFields['sm_shift_snos'];
		$sch_search_type = $gridExtraFields['schedulesearchtype'];
		$append_hours = 0;
		
		// Match Options selected - Exact Match, Partial Match or Extend Match + Hours
		if($sch_search_type == 3)
		{
			$append_hours = $gridExtraFields['appendhours']; // For Option 3: Extend Match + Hours. Currently set to 1 Hour	
		}
		
		$res = mysql_query($que,$db);
		$k = 1;
		$cand_avail_dates = array();	 
		while ($row=mysql_fetch_array($res))
		{	
			$grid[$j][0]="<input type=hidden name=cand[] value='".$row[0]."'><label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='chk_clearTop()' value='".$row['resid']."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row[0]."'>";
								
			// Get Candidate Name
			$cand_query = "SELECT CONCAT_WS(' ', candidate_list.fname,candidate_list.mname,candidate_list.lname) AS candname FROM candidate_list WHERE candidate_list.username = '".$row['username']."'";
			$cand_res = mysql_query($cand_query,$db);
			$cand_row = mysql_fetch_assoc($cand_res);
			$grid[$j][1]="<a href=javascript:winopennew('review.php?type=cand&posid=$posid&cno=".$row[0]."')><font class=linkrow>".html_tls_specialchars(trim($cand_row['candname']),ENT_QUOTES)."</font></a>";
		
			$candname = str_replace(' ','_',$cand_row['candname']); 
			
			$grid[$j][2]="<a style='padding: 1px 0px 0px 30px;' href=javascript:displayTimeFrameWindow('/include/shift_schedule/viewalltimeframes.php?refid=".$row['username']."&posid=$posid&module=Req_Mngmt&smsno=$sm_sno&schtype=$sch_search_type&candname=$candname&append_hours=$append_hours&shift_type=$jo_shift_type')><font class=linkrow><i class='fa fa-info-circle'></i></font></a>";
			
			// Finds this current candidate's availability details.
			$candidate_username = $row['username'];
			$avail_dates = $candidates_details[$candidate_username];
			foreach ($avail_dates as $key => $value){
				
				$avail_shift_date = explode('|',$value,2);
				$cand_avail_dates[$key] = $avail_shift_date[0];
			}
		
			// Displays Full Schedule View - for 90 Days starting from current date 
			for($k = 0; $k<$jo_shifts_arr_len; $k++){
				if(in_array($jo_shifts_arr_uniq[$k],$cand_avail_dates)){
					$cand_avail_keys = array();
					$shift_div_content = "";
					$cand_avail_keys = array_keys($cand_avail_dates,$jo_shifts_arr_uniq[$k]);
					$cand_avail_keys_count = count($cand_avail_keys);
					$tot_shift_width = 100;
					$width_each_shift = 100/$cand_avail_keys_count;
					
					foreach($cand_avail_keys as $ky=>$val){
						$shif_data = $avail_dates[$val];
						$avail_shift_data = explode('|',$shif_data);
						$shift_color =  $avail_shift_data[2];
						$shift_div_content .= "<div style='background-color:{$shift_color};display: inline-block;width: {$width_each_shift}px;height:100%'>&nbsp;</div>";
					}
					
					$grid[$j][$k+3] = $shift_div_content;	
				}
				else
				{
					$grid[$j][$k+3] = "";
				}
			}			
			if($jo_shifts_arr_len > 0){
				$updated_index = $jo_shifts_arr_len+3;
			}else{
				$updated_index = 3;
			}
			$grid[$j][$updated_index] = "";
			$grid[$j][$updated_index+1] = "review.php?cno=".$row[0]."&posid=$posid&dest=0";
			$j++;
		}					
		return $grid;
	}

	// Daily Details View in Shortlisted Candidates Schedule Search
	function builShortListScheduleSearchDailyDetailsView($que,$posid,$gridExtraFields,$candidates_details)
	{ 
		global $maildb,$db,$username;		

		$j=0;
		$grid=array();$arrResumeVal = array();
		$custom_grid_function_obj = new CustomGridFunctions();
		$grid_details = $custom_grid_function_obj->getGridName("Manage Shortlist",$username);
		
		// User Selected Date		
		$user_sel_date = $gridExtraFields['user_sel_date'];		
		
		$res = mysql_query($que,$db);	
		
		while ($row=mysql_fetch_array($res))
		{
			$style = "";			
			$cand_avail_exists_str = "";
			$color_code = "";
			$fromTF = array();
			$toTF = array();
			$shiftColor = array();
			$grid[$j][0]="<input type=hidden name=cand[] value='".$row[0]."'><label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='chk_clearTop()' value='".$row['resid']."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row[0]."'>";
			
			// Get Candidate Name
			$cand_query = "SELECT CONCAT_WS(' ', candidate_list.fname,candidate_list.mname,candidate_list.lname) AS candname FROM candidate_list WHERE candidate_list.username = '".$row['username']."'";
			$cand_res = mysql_query($cand_query,$db);
			$cand_row = mysql_fetch_assoc($cand_res);
				
			$grid[$j][1]="<a href=javascript:winopennew('review.php?type=cand&posid=$posid&cno=".$row[0]."')><font class=linkrow>".html_tls_specialchars(trim($cand_row['candname']),ENT_QUOTES)."</font></a>";
			
			$candidate_username = $row['username'];
			$cand_avail_details = $candidates_details[$candidate_username][0];
			
			$cand_avail_details_arr = explode(",",$cand_avail_details);
			$avail_time = array();
			$shiftColor = array();	
			foreach($cand_avail_details_arr as $cand_avail){
				$avail_time			=	explode("|",$cand_avail);
				list($stime,$etime) = explode("TO",$avail_time[0]);

				$expSTime		= explode(' ',$stime);
				$getSTimeHourMins	= '0000-00-00 '.$expSTime[1];
				$fromTF[] = (( date("H",strtotime($getSTimeHourMins)) * 60 ) + ( date("i",strtotime($getSTimeHourMins))));

				$expETime		= explode(' ',$etime);
				$getETimeHourMins	= '0000-00-00 '.$expETime[1];
				$toTF[] = (( date("H",strtotime($getETimeHourMins)) * 60 ) + ( date("i",strtotime($getETimeHourMins))));
				$shiftColor[] = $avail_time[2];
			}			

			$html_content = "<div class='timegridcontainer' id='timegridmaindiv$j'>";			
								
			for($k=0;$k<1439;)
			{				
								
				$fill_color = $this->fillShiftColors($k,$fromTF,$toTF,$shiftColor);
				
				if($fill_color){
					$style = "style='background-color: ".$fill_color."' ";
					$cand_avail_exists_str .= $style;
				}else{
					$style = "";
				}

				if($k == 1425){
					$k = $k+14;
				}else{
					$k = $k+15;
				}

				if($k == 1439)
				{
					//$html_content .= "<div class='timegridlast' id='grid_$j_$k' $style>&nbsp;</div>";
					$html_content .= "<div class='timegrid' id='grid_$j_$k' $style>&nbsp;</div>";
				}
				else
				{
					$html_content .= "<div class='timegrid' id='grid_$j_$k' $style>&nbsp;</div>";				
				}				
			}
													
			$html_content .= "</div>";							
			
			$grid[$j][2]= $html_content;						
			
			$grid[$j][3] = "";
			$grid[$j][4] = "review.php?cno=".$row[0]."&posid=$posid&dest=0";
			$j++;
		}
		
		return $grid;
	}	
	
	//added by Suneel to Admin->Sourcing Accounts Grid optimization...
	function getAdminSourcingMgmt($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{ 
        global $maildb,$db,$user_timezone;
		$gd = new gridData();
        // Searching array
		$asFields=array("","trim(j.source_name)","ja.nickname","ja.username","ja.company_id","ja.contact_id",tzRetQueryStringDTime('ja.cdate','DateTime','/'),"csr.name",tzRetQueryStringDTime('ja.mdate','DateTime','/'),"msr.name");
        
		//ordering array
	    $ssFields = array("","trim(j.source_name)","ja.nickname","ja.username","ja.password","ja.company_id","ja.contact_id","ja.cdate","csr.name","ja.mdate","msr.name");
		
		//count query for admin job boards...
		$tque = " SELECT count(ja.sno) FROM jobsourcing_accounts ja LEFT JOIN users msr ON ja.muser = msr.username, jobsourcing j,users csr where j.sno=ja.jobsourcing_id and ja.status='ACTIVE' and ja.cuser = csr.username";

        //fetching records query ...
		$oque = "SELECT ja.sno,j.source_name,ja.nickname,ja.username,ja.password,".tzRetQueryStringDTime('ja.cdate','DateTime','/')." as crdate,csr.name as c_name,".tzRetQueryStringDTime('ja.mdate','DateTime','/')." as modate,msr.name as m_name,ja.jobsourcing_id,ja.company_id,ja.contact_id FROM jobsourcing_accounts ja  LEFT JOIN users msr ON ja.muser = msr.username, jobsourcing j,users csr where j.sno=ja.jobsourcing_id and ja.status='ACTIVE' and ja.cuser = csr.username";
		
		$gstr = "";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildAdminSourcingMgmt($oque);
		
        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
	}

	// Displaying CRM Group main grid.
	function getCrmGroups($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username, $stat, $callFromAdmin;
		
		$gd=new gridData();
		
		if($callFromAdmin == 'No')
		{
			$whereCond =  "(crmgroups.owner='$username' OR FIND_IN_SET('$username', crmgroups.accessto )>0 OR crmgroups.accessto='ALL') AND crmgroups.status='".$stat."'" ;
			$whereCond.= ($stat == 'INACTIVE') ? " AND crmgroups.owner = $username" : "";
			$groupAccessTo = "IF(crmgroups.accessto='ALL','Public',IF(crmgroups.accessto='$username','Private','Share'))";
			$groupModule = 'CRM';
		}
		else
		{
			$whereCond = ($stat == 'INACTIVE') ? " crmgroups.status = 'INACTIVE'" : "crmgroups.status = 'ACTIVE'";
			$groupAccessTo = "IF(crmgroups.accessto = 'ALL' or crmgroups.accessto = '' or crmgroups.accessto is null,'Public',IF(locate(',',crmgroups.accessto)>0,'Share','Private'))";
			$groupModule = 'Admin';
		}	
	
		$asFields = array("", "crmgroups.name", "crmgroups.grouptype", "crmgroups.description", "getGroupDetailsCount(crmgroups.sno, crmgroups.grouptype, '".$username."', '".$groupModule."')", $groupAccessTo, "Owner.name", tzRetQueryStringDTime('crmgroups.cdate','Date','/'), "CreatedUser.name", tzRetQueryStringDTime('crmgroups.mdate','Date','/'), "ModifiedUser.name");
				
		$ssFields=array("", "crmgroups.name", "crmgroups.grouptype", "crmgroups.description", "getGroupDetailsCount(crmgroups.sno, crmgroups.grouptype, '".$username."', '".$groupModule."')", $groupAccessTo, "Owner.name", "crmgroups.cdate", "CreatedUser.name", "crmgroups.mdate", "ModifiedUser.name");
		
		$tque="SELECT count(1) 
		FROM crmgroups 
		LEFT JOIN users Owner ON Owner.username = crmgroups.owner
		LEFT JOIN users CreatedUser ON CreatedUser.username = crmgroups.cuser
		LEFT JOIN users ModifiedUser ON ModifiedUser.username = crmgroups.muser		
		WHERE ".$whereCond;	
	
		$oque="SELECT crmgroups.sno, crmgroups.name, crmgroups.grouptype, IFNULL(crmgroups.description,'') AS description, crmgroups.owner, 
		".$groupAccessTo." AS shareType,
		Owner.name as ownername, CreatedUser.name AS createdUser, ModifiedUser.name AS modifiedUser, 
		".tzRetQueryStringDTime('crmgroups.mdate','Date','/')." as mdate,
		".tzRetQueryStringDTime('crmgroups.cdate','Date','/')." as cdate,
		 getGroupDetailsCount(crmgroups.sno, crmgroups.grouptype, '".$username."', '".$groupModule."') AS refCount, crmgroups.status
		FROM crmgroups 
		LEFT JOIN users Owner ON Owner.username = crmgroups.owner
		LEFT JOIN users CreatedUser ON CreatedUser.username = crmgroups.cuser
		LEFT JOIN users ModifiedUser ON ModifiedUser.username = crmgroups.muser		
		WHERE ".$whereCond;		
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		
		$qstr=$gd->buildQSTR($gridSearchType, $gridSearchFields, $asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCrmGroups($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
	  
	function buildCrmGroups($que)
	{
		global $maildb,$db,$callFromAdmin;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$chboxValues = $row['sno'].'|'.$row['owner'].'|'.$j.'|'.html_tls_specialchars($row['name'],ENT_QUOTES).'|'.$row['grouptype'].'|'.$row['refCount'];
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>"; 
			$grid[$j][1]=$this->convertSpecChars($row['name']); 
			$grid[$j][2]=$this->convertSpecChars($row['grouptype']); 
			$grid[$j][3]=$this->convertSpecChars($row['description']); 
			$grid[$j][4]=$this->convertSpecChars($row['refCount']);
			$grid[$j][5]=$this->convertSpecChars($row['shareType']);
			$grid[$j][6]=$this->convertSpecChars($row['ownername']); 
			$grid[$j][7]=$this->convertSpecChars($row['cdate']); 
			$grid[$j][8]=$this->convertSpecChars($row['createdUser']);
			$grid[$j][9]=$this->convertSpecChars($row['mdate']);
			$grid[$j][10]=$this->convertSpecChars($row['modifiedUser']); 
			$grid[$j][11]="";
			if($row['status'] == 'ACTIVE')
			{
				if($callFromAdmin == "Yes"){
				
					if($row['grouptype'] == "Candidate"){
						
						$grid[$j][12]="/BSOS/Admin/Data_Mngmt/Candidates/Candidates.php?groupId=".$row['sno']."&pageFrom=crmGroups";
					}else{
						
						$grid[$j][12]="/BSOS/Admin/Data_Mngmt/Lead_Mngmt/newmanage.php?groupId=".$row['sno']."&pageFrom=crmGroups";
					}
				}else{
					if($row['grouptype'] == "Candidate"){
						
						$grid[$j][12]="/BSOS/Marketing/Candidates/Candidates.php?groupId=".$row['sno']."&pageFrom=crmGroups";
					}else{
						
						$grid[$j][12]="/BSOS/Marketing/Lead_Mngmt/newmanage.php?groupId=".$row['sno']."&pageFrom=crmGroups";
					}
				}
			}
			else
			{
				$grid[$j][12]="javascript: void(0);";		
			}
			
			$j++;
		}
		return $grid;
	}

//this  fun for assigning fetched data to grid...--added by prasad d
	function buildAdminSourcingMgmt($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
            $row[5] = (trim($row[5])=='00/00/0000')?"":$row[5];
			$row[7] = (trim($row[7])=='00/00/0000')?"":$row[7];
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onclick='chk_clearTop()' value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); // job Board name
			$grid[$j][2]=$this->convertSpecChars($row[2]); //Nickname
			$grid[$j][3]=$this->convertSpecChars($row[3]); //username
			$grid[$j][4]=str_repeat("x",strlen($row[4])); //password
			$grid[$j][5]=$this->convertSpecChars($row[10]); //Company ID
			$grid[$j][6]=$this->convertSpecChars($row[11]); //Contact ID
			$grid[$j][7]=$row[5]; //created date
			$grid[$j][8]=$this->convertSpecChars($row[6]); //Created By
			$grid[$j][9]=$row[7]; //Modified date
			$grid[$j][10]=$this->convertSpecChars($row[8]); //Modified By
			$grid[$j][11]="";
			$grid[$j][12]="editsourceaccount.php?sourceId=".$row[0]; //path for double click on record
            $j++;
		}
        return $grid;
	}
	
	function getCandidateDataH($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		
		if($gridSortCol=="")
			$gridSortCol=1;
		$gd=new gridData();
		//Sorting Fields..				
$asFields=array("","candidate_list.profiletitle","CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname)","candidate_list.hphone","candidate_list.city","candidate_list.state"," IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) )","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share'))","candidate_list.cl_source","mg.name","users.name","us.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/') );
		
		//Searching  Fields..								                                     		
$ssFields=array("","candidate_list.profiletitle","CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname)","candidate_list.hphone","candidate_list.city","candidate_list.state"," IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) )","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share'))","candidate_list.cl_source","mg.name","users.name","us.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/') );

		$tque="
			SELECT count(candidate_list.sno) 
			FROM candidate_list 
			LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN users AS us ON candidate_list.cuser=us.username
			LEFT JOIN users on (candidate_list.owner = users.username) 
			WHERE candidate_list.status='DUPLICATE' AND candidate_list.owner IN (0,'','".$username."')";
		
		$oque="
			SELECT 
			candidate_list.sno, 
			candidate_list.username, 
			candidate_list.profiletitle, 
			CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname), 
			candidate_list.hphone, 
			candidate_list.city, 
			candidate_list.state, 
			IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) ),
			IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')), 
			IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share')), 
			users.name, 
			candidate_list.resid, 
			CONCAT_WS(' ', candidate_list.amount, candidate_list.currency, candidate_list.period), 
			candidate_list.status, 
			'skills', 
			candidate_list.vcount, 		
			".tzRetQueryStringDTime('candidate_list.ctime','Date','/')." , 
			us.name, 
			candidate_list.cl_source, 
			mg.name 
			FROM candidate_list 
			LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN users AS us ON candidate_list.cuser=us.username
			LEFT JOIN users on (candidate_list.owner = users.username) 
			WHERE candidate_list.status='DUPLICATE' AND candidate_list.owner IN (0,'','".$username."')";

		$grpque=" group by candidate_list.username ";
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$CandiateCond = "";
		
		if($gridSearchFields[6] != "")
		{
			$CandiateCond = " AND IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) = '".$gridSearchFields[6]."' ";
			$gridSearchFields[6] = "";
		}
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$ssFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $ssFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$ssFields[$asFieldsKey] = $asFields[$asFieldsKey];
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
	
		$tque=$gd->buildTQuery($tque,$qstr.$CandiateCond,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr.$CandiateCond,$ostr,$lstr,$gstr,$grpque);
	
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCandidateDataH($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
		
	
	function buildCandidateDataH($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
		
				if($row['resid']!="" && $row['resid']!=0)
				$resume_link="<a href=getresume.php?fsno=".$row[11]." target='_top'><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
				
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $row[2]; //profile title
			$grid[$j][2] = $row[3]; //Candidate Name
			$grid[$j][3] = $row[4]; //Phone
			$grid[$j][4] = $row[5]; //City
			$grid[$j][5] = $row[6]; //State
			$grid[$j][6] = $row[7]; //Availabilty
			$grid[$j][7] = $row[8]; //Candidate Type
			$grid[$j][8] = $row[9]; //type (public, private etc..)			
			$grid[$j][9] = $row[18]; //Source
			$grid[$j][10] = $row[19]; //Source Type			
			$grid[$j][11] = $row[10]; //Owner			
			$grid[$j][12] = $row[17]; //Created by						
			$grid[$j][13] = $row[16]; //Created Date
			$grid[$j][14] = $resume_link; //Resume
			$grid[$j][15] = ""; //Resume
			$grid[$j][16] = "makeavailable.php?type=cand&addr=cand".$row[0]; //summary screen
			$j++;
		}
		return 	$grid;
	}	
	
//Function for Adding Souring Accounts.
	function  getSourcingAccount($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	 {
		global $maildb,$db,$username,$stat,$user_timezone;

        if($gridSortCol=="")
			$gridSortCol=1;
			
        $gd=new gridData();
				
		$asFields=array("","source_name","","","","");
		$ssFields=array("","source_name","","","","");
		
		$tque = "select count(*) from jobsourcing where status='Y'";
		$oque = "select sno,source_name from  jobsourcing where status='Y'";
		
        $gstr="";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        $total=$gd->getTotalRows($tque);
		$gridData=$gd->buildSourcingAccount($oque);		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	function buildSourcingAccount($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
        $res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id='checkSel".$j."' OnClick=chk_clearTop() value='".$row[0]."|".$j."|'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]="<input class=gridserbox type=text maxlength='255' name='txtnickname".$j."' id='txtnickname".$j."'>";
			$grid[$j][3]="<input class=gridserbox type=text maxlength='25' name='txtuid".$j."' id='txtuid".$j."'>";
			$grid[$j][4]="<input class=gridserbox type=password maxlength='25' name='txtpwd".$j."' id='txtpwd".$j."'>";
			$grid[$j][5]="<input class=gridserbox type=password maxlength='25' name='txtcpwd".$j."' id='txtcpwd".$j."'>";
			$grid[$j][6]="";
			$j++;
		}
		return $grid;
	}	
	
	function getAdminCandidateDup($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		
		if($gridSortCol=="")
			$gridSortCol=1;
		$gd=new gridData();
		//Sorting Fields..				
$asFields=array("","candidate_list.profiletitle","CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname)","candidate_list.hphone","candidate_list.city","candidate_list.state"," IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) )","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share'))","candidate_list.cl_source","mg.name","users.name","us.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/') );
		
		//Searching  Fields..								                                     		
$ssFields=array("","candidate_list.profiletitle","CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname)","candidate_list.hphone","candidate_list.city","candidate_list.state"," IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) )","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share'))","candidate_list.cl_source","mg.name","users.name","us.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/') );

		$tque="
			SELECT count(candidate_list.sno) 
			FROM candidate_list 
			LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN users AS us ON candidate_list.cuser=us.username 
			LEFT JOIN users on (candidate_list.owner = users.username)
			WHERE candidate_list.status='DUPLICATE' ";
		
		$oque="
			SELECT 
			candidate_list.sno, 
			candidate_list.username, 
			candidate_list.profiletitle, 
			CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname), 
			candidate_list.hphone, 
			candidate_list.city, 
			candidate_list.state, 
			IF( (candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate', ".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')." ) ),
			IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')), 
			IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share')), 
			users.name, 
			candidate_list.resid, 
			CONCAT_WS(' ', candidate_list.amount, candidate_list.currency, candidate_list.period), 
			candidate_list.status, 
			'skills', 
			candidate_list.vcount, 		
			".tzRetQueryStringDTime('candidate_list.ctime','Date','/')." , 
			us.name, 
			candidate_list.cl_source, 
			mg.name 
			FROM  candidate_list 
			LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN users AS us ON candidate_list.cuser=us.username 
			LEFT JOIN users ON candidate_list.owner = users.username
			WHERE  candidate_list.status='DUPLICATE' ";

		$grpque=" group by candidate_list.username ";
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$CandiateCond = "";
		
		if($gridSearchFields[6] != "")
		{
			$CandiateCond = " AND IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) = '".$gridSearchFields[6]."' ";
			$gridSearchFields[6] = "";
		}
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$ssFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $ssFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$ssFields[$asFieldsKey] = $asFields[$asFieldsKey];
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
	
		$tque=$gd->buildTQuery($tque,$qstr.$CandiateCond,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr.$CandiateCond,$ostr,$lstr,$gstr,$grpque);
	
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminCandidateDup($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
		
	function buildAdminCandidateDup($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while($row=mysql_fetch_array($res))
		{
		
				if($row['resid']!="" && $row['resid']!=0)
				$resume_link="<a href=getresume.php?fsno=".$row[11]." target='_top'><img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0></a>";
				
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $row[2]; //profile title
			$grid[$j][2] = $row[3]; //Candidate Name
			$grid[$j][3] = $row[4]; //Phone
			$grid[$j][4] = $row[5]; //City
			$grid[$j][5] = $row[6]; //State
			$grid[$j][6] = $row[7]; //Availabilty
			$grid[$j][7] = $row[8]; //Candidate Type
			$grid[$j][8] = $row[9]; //type (public, private etc..)			
			$grid[$j][9] = $row[18]; //Source
			$grid[$j][10] = $row[19]; //Source Type			
			$grid[$j][11] = $row[10]; //Owner			
			$grid[$j][12] = $row[17]; //Created by						
			$grid[$j][13] = $row[16]; //Created Date
			$grid[$j][14] = $resume_link; //Resume
			$grid[$j][15] = ""; //Resume
			$grid[$j][16] = "makeavailable.php?type=cand&addr=cand".$row[0]; //summary screen
			$j++;
		}
		return 	$grid;
	}

	function getApprovedTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)",tzRetQueryStringDTime('t.approvetime','DateTime24Sec','/'));
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)","MAX(t.approvetime)");

		$ins_query  = mysql_query("select ExportedTimesheet from company_info",$db);
		$ins_row=mysql_fetch_array($ins_query);
		if($ins_row[0]=="YES")
             $exportCond="t.exported_status!='YES' AND ";
		else
             $exportCond="";
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedate'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }
                
        ////////////////// Code Ends //////////////
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE ".$exportCond." p.astatus IN ('Approved','Billed','ER', 'Rejected') AND t.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('p.sdate','Date','/').",".tzRetQueryStringDate('p.edate','Date','/').",IF(p.template='Clockinout',t.hours,ROUND(SUM(t.hours),2)),CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END,TRIM(u.name),".tzRetQueryStringDTime('MAX(t.approvetime)','DateTime24Sec','/').",p.username,".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate,IF(t.edate!='0000-00-00','Range','Daily') AS tab 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE ".$exportCond." p.astatus IN ('Approved','Billed','ER', 'Rejected') AND t.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildApprovedTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        //Time Sheet Load Optimization-
         if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
         }
        $objResponse->addScriptCall("updateGridDateDisplay",$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////
		return $objResponse;
	}
	function buildApprovedTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
        $mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 

		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
			$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			if($row[10] == 'Clock In & Out'){
				$grid[$j][10]=$row[10];
			}
			else{
				$grid[$j][10]=$this->convertSpecChars(stripslashes($row[10]))."(".$this->convertSpecChars($row[16]).")";
			
			}
			$grid[$j][11]=$this->convertSpecChars(stripslashes($row[11]));
			$grid[$j][12]=$this->convertSpecChars($row[12]);
			$grid[$j][13]=$row[0]."|".$row[10];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization 
			$j++;
		}
        // TimeSheet Grid Load Optimization 
            asort($mindatearray);
            asort($maxdatearray);
            $mindate = reset($mindatearray);
            $maxdate = end($maxdatearray);
            unset($midate);
            unset($mindatearray);
            unset($maxdatearray);
            unset($madate);
            $grid['totalCount'] = mysql_num_rows($res);
            $grid['maxdate'] = $maxdate;
            $grid['mindate'] = $mindate;
            // TimeSheet Grid Load Optimization 
	    return $grid;
	}
	
	function getNewTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();		

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.template",tzRetQueryStringDTime('p.stime','DateTime24Sec','/'));
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.template","MAX(p.stime)");
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedate'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }
        ///// TimeSheet Grid Load Optimization code ends ///////
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
		WHERE p.rstatus='' AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('p.sdate','Date','/').",".tzRetQueryStringDate('p.edate','Date','/').",IF(p.template='Clockinout',t.hours,ROUND(SUM(t.hours),2)),CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END,".tzRetQueryStringDTime('MAX(p.stime)','DateTime24Sec','/').",p.username, ".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate,IF(t.edate!='0000-00-00','Range','Daily') AS tab, t.sno AS ts_sno
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
		WHERE p.rstatus='' AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildNewTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
        $objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        // TimeSheet Grid Load Optimization 
        $buildGridHeadValue = $gd->buildGridHeadData($qstr,$ostr,$gstr,$gridExtraFields,$timesheetFromDate,$timesheetToDate,$gridSearchFields,$searchFromDate,$searchToDate,$totalSearchCount);
        if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
        }
        $objResponse->addScriptCall("updateGridDataDisplay",$buildGridHeadValue,$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////
		return $objResponse;
	}

	function buildNewTimeSheets($que)
	{
		global $db;

		$j=0;
        $mindatearray =array();
        $maxdatearray = array();
		$grid=array();
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][3]=$this->convertSpecChars(stripslashes($row[3]));
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
			$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			if($row[10] == 'Clock In & Out'){
				$grid[$j][10]=$row[10];
			}
			else{
				$grid[$j][10]=$row[10]."(".$this->convertSpecChars($row[15]).")";
			}
			$grid[$j][11]=$this->convertSpecChars($row[11]);
			$grid[$j][12]=$row[12];
			$grid[$j][13]=$row[0];
			$grid[$j][14]=$row[16];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization 

			$j++;
		}
      
        // TimeSheet Grid Load Optimization 
        asort($mindatearray);
        asort($maxdatearray);
        $mindate = reset($mindatearray);
        $maxdate = end($maxdatearray);
        unset($midate);
        unset($mindatearray);
        unset($maxdatearray);
        unset($madate);
        $grid['totalCount'] = mysql_num_rows($res);
        $grid['maxdate'] = $maxdate;
        $grid['mindate'] = $mindate;
        // TimeSheet Grid Load Optimization 
	    return $grid;
	}
	function getSubmittedTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		$sno = $gridExtraFields['sno'];

		if($gridSortCol=="")
			$gridSortCol=1;
			
		
		//For TimeInTimeOut Check
		$tito_clause	= '';

		if (!empty($gridSearchFields[3])) {

			$flag	= strtolower($gridSearchFields[3]);
			$flag	= ($flag == 'in & out') ? 'TimeInTimeOut' : (($flag == 'uom') ? 'UOM' :'Regular');

			$tito_clause .= " AND par_timesheet.template ='$flag' ";

			$gridSearchFields[3]	= "";
		}

		$gd=new gridData();

		$asFields = array("", tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/'), tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/'), "ROUND(SUM(timesheet_hours.hours),2)", "CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END");

		$ssFields = array("","MIN(par_timesheet.sdate)", "MAX(par_timesheet.edate)","ROUND(SUM(timesheet_hours.hours),2)", "CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END");

		$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON timesheet_hours.parid=par_timesheet.sno WHERE par_timesheet.username='".$sno."' AND par_timesheet.rstatus='' AND timesheet_hours.status = 'ER' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'".$tito_clause;
		 $oque = "SELECT par_timesheet.sno,".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').",sum(timesheet_hours.hours),par_timesheet.astatus,par_timesheet.pstatus , par_timesheet.username ,timesheet_hours.parid, CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END FROM par_timesheet LEFT JOIN timesheet_hours ON timesheet_hours.parid=par_timesheet.sno WHERE par_timesheet.username='".$sno."' AND par_timesheet.rstatus='' AND timesheet_hours.status = 'ER' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'".$tito_clause;			 

		$grp_str = " GROUP BY timesheet_hours.parid";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr1 = $gd->buildQSTRTimeSht($gridSearchType, $gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);
		$oque_Count = "$oque $qstr $grp_str $qstr1 $ostr";
		$total = $gd->getTotalCount($oque_Count);

		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";
		//$total = $gd->getTotalRows($tque);
		//echo $oque;

		$gridData = $gd->buildSubmittedTimeSheets($oque);
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
	function buildSubmittedTimeSheets($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";			
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars(number_format($row[3],2));
			$grid[$j][4]=$this->convertSpecChars($row[8]);
			$grid[$j][5]="";
			$grid[$j][6]=$row[0]."|".$row[8];
			$j++;
		}
      
	    return $grid;
	}
	function getApprovedDetailTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));
		
		$addr = $gridExtraFields['addr'];
		
		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();
						
		$asFields = array("",tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/'), tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/'), "ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END","TRIM(users.name)", tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/'));
		
		$ssFields = array("","MIN(par_timesheet.sdate)", "MAX(par_timesheet.edate)", "ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END","TRIM(users.name)","MAX(timesheet_hours.approvetime)");

		//For TimeInTimeOut Check
		$tito_clause	= '';

		if (!empty($gridSearchFields[3])) {

			$flag	= strtolower($gridSearchFields[3]);
			$flag	= ($flag == 'in & out') ? 'TimeInTimeOut' : (($flag == 'uom') ? 'UOM' :'Regular');

			$tito_clause .= " AND par_timesheet.template ='$flag' ";

			$gridSearchFields[3]	= "";
		}

		$getCond = '';
		if($gridSearchFields[4] != "")	//for Approved By.
		{
			$getCond .= "AND  users.name LIKE '%".$gridSearchFields[4]."%'";

			$gridSearchFields[4] = "";
		}

		// code to get Exported Timesheet value -- jyothi
        $ins_query  = mysql_query("select ExportedTimesheet from company_info",$db);
		$ins_row=mysql_fetch_array($ins_query);
		if($ins_row[0] == 'YES')
             $accountingExport1 = 'Exported';
		else {
		     $accountingExport1 = '';
		
		}
		
	
         if($accountingExport1 == 'Exported')
		{
		
		$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status != 'YES' AND par_timesheet.astatus IN ('Approved','Billed','ER','Rejected')
  AND timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'";   		



		$oque ="SELECT ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", SUM(timesheet_hours.hours), CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM'  WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END, TRIM(users.name), ".tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/').", par_timesheet.sno FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status != 'YES' AND  par_timesheet.astatus IN ('Approved','Billed','ER','Rejected')
  AND timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond $tito_clause"; 
		
		} else
		{
		
		$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE  par_timesheet.astatus IN ('Approved','Billed','ER','Rejected')
  AND timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'";   		



		$oque ="SELECT ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", SUM(timesheet_hours.hours), CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END, TRIM(users.name), ".tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/').", par_timesheet.sno FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE  par_timesheet.astatus IN ('Approved','Billed','ER','Rejected')
  AND timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond $tito_clause"; 
		
		
		}  

		$grp_str = " GROUP BY par_timesheet.sno";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);

		$qstr1 = $gd->buildQSTRTimeSht($gridSearchType, $gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count = "$oque $qstr $grp_str $qstr1 $ostr";
		$total = $gd->getTotalCount($oque_Count);

		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";
		//$total = $gd->getTotalRows($tque);
		//echo $oque;

		$gridData = $gd->buildApprovedDetailTimeSheets($oque);
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		return $objResponse;
	}
	function buildApprovedDetailTimeSheets($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[6]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars(number_format($row[2],2));
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]="";
			$grid[$j][8]=$row[6]."|".$row[3];
			$j++;
		}
      
	    return $grid;
	}
	
	function getManageRoles($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username;
		
		if($gridSortCol=="")
			$gridSortCol=2;

		$gd	= new gridData();

		$asFields = array("","cd.sno", "cd.roletitle", "cd.enableUserInput", tzRetQueryStringDTime("rp.startdate","Date","/"), tzRetQueryStringDTime("rp.enddate","Date","/"), "cd.status", "cu.name", tzRetQueryStringDTime("cd.cdate","DateTime","/"),"mu.name", tzRetQueryStringDTime("cd.mdate","DateTime","/"));

		$ssFields = array("","cd.sno", "cd.roletitle", "cd.enableUserInput", "rp.startdate", "rp.enddate", "cd.status","cu.name", "cd.cdate", "mu.name", "cd.mdate");

		$getCond = "";

		if($gridSearchFields[2] != "")	//for user Input column
		{
			$getCond .= " AND cd.enableUserInput = '".$gridSearchFields[2]."'";
			$gridSearchFields[2] = "";
		}

		if($gridSearchFields[5] != "")	//for Status.
		{
			$getCond .= " AND cd.status = '".$gridSearchFields[5]."'";
			$gridSearchFields[5] = "";
		}
		
		
		$tque = "SELECT
				COUNT(1)
			FROM
				company_commission cd
			LEFT JOIN
				rates_period rp ON (rp.parentid = cd.sno AND rp.parenttype = 'COMMISSION')
			LEFT JOIN
				users cu ON cu.username = cd.cuser
			LEFT JOIN
				users mu ON mu.username = cd.muser
			WHERE
				1=1 $getCond";

		$oque ="SELECT
				cd.sno AS cdSno,
				cd.roletitle AS RoleTitle,
				IF(cd.enableUserInput = 'N','Disable','Enable') AS userInput, 
				".tzRetQueryStringDTime("MIN(rp.startdate)","Date","/")." AS startDate,
				IF(COUNT(rp.sno) = COUNT(NULLIF(rp.enddate!= '0000-00-00 00:00:00', 0)),".tzRetQueryStringDTime("MAX(rp.enddate)","Date","/").",'')  AS endDate,
				IF(cd.status = 'active','Active','Inactive') AS status, 
				cu.name AS createduser,
				".tzRetQueryStringDTime('cd.cdate','DateTime','/')." AS cdate,
				mu.name AS modifiedUser,
				".tzRetQueryStringDTime('cd.mdate','DateTime','/')." AS mdate 
			FROM
				company_commission cd
			LEFT JOIN
				rates_period rp ON (rp.parentid = cd.sno AND rp.parenttype = 'COMMISSION')
			LEFT JOIN
				users cu ON cu.username = cd.cuser
			LEFT JOIN
				users mu ON mu.username = cd.muser
			WHERE
				1=1 $getCond";

		$grp_str = "GROUP BY cd.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		
		$qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str);	
		$oque_Count = "$oque $qstr $grp_str $ostr";
		$total = $gd->getTotalCount($oque_Count);
				
		$oque = "$oque $qstr $grp_str $ostr $lstr";		
		
		$gridData = $gd->buildManageRoles($oque);
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
	
	function buildManageRoles($que)
	{
		global $maildb,$db;
		$grid=array();
		$j=0;
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$edit_link = ($row['Status'] == "Active") ? "<a href='javascript:doCommission(\"edit\",\"$row[0]\",\"$row[rpSno]\");'><img hspace='0' height='12' width='12' vspace='0' border='0' align='center' title='Click to edit' alt='Click to edit' src='/BSOS/images/us/edit_icon.gif'></a>" : "";
			
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row['cdSno']);//role id
			$grid[$j][2]=$this->convertSpecChars($row['RoleTitle']);//role title
			$grid[$j][3]=$this->convertSpecChars($row['userInput']);//user input
			$grid[$j][4]=$this->convertSpecChars($row['startDate']);//start date
			$grid[$j][5]=$this->convertSpecChars($row['endDate']);//end date
			$grid[$j][6]=$this->convertSpecChars($row['status']);//status
			$grid[$j][7]=$this->convertSpecChars($row['createduser']);//created by
			$grid[$j][8]=$this->convertSpecChars($row['cdate']);//created date
			$grid[$j][9]=$this->convertSpecChars($row['modifiedUser']);//modified by
			$grid[$j][10]=$this->convertSpecChars($row['mdate']);//modified date
            $grid[$j][11]="";//search or reset 
            $grid[$j][12]=$row[rpSno];
			$j++;
		}
	    return $grid;
	}	

	// HRM Deductions Piyush R
	function getDeductions($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username;

		if($gridSortCol=="")
			$gridSortCol=1;

		$acs="";//variable for passing access permissions
		$gd=new gridData();

		//Search Fields
		 $ssFields=array("","vprt_deduct.name","Concat( deductions.name, ' (', deductions.type, ')')","vprt_deduct.tot_dollar_amt");	

		// Order By fields 	
		$asFields=array("","vprt_deduct.name","Concat( deductions.name, ' (', deductions.type, ')')","vprt_deduct.tot_dollar_amt");

		$tque = "SELECT count(1) FROM vprt_deduction vprt_deduct 
		         LEFT JOIN deductions ON ( deductions.sno = vprt_deduct.item_type )
				 WHERE 1=1 ";

		$oque = "SELECT vprt_deduct.sno, vprt_deduct.name, Concat( deductions.name, ' (', deductions.type, ')' ) , vprt_deduct.tot_dollar_amt
				 FROM vprt_deduction vprt_deduct
				 LEFT JOIN deductions ON ( deductions.sno = vprt_deduct.item_type )
				 WHERE 1=1 ";// where status='ER' 

        $gstr = "";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);//Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildDeductions($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}
	
	function buildDeductions($que)
	{
		global $maildb,$db,$stat, $fromHRM;
		
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_row($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop(); value=".$row[0]."><span class='checkmark'></span></label>";	
			$grid[$j][1]=$this->convertSpecChars($row[1]); // Location code
			$grid[$j][2]=$this->convertSpecChars($row[2]); // Location name
			$grid[$j][3]=$this->convertSpecChars($row[3]); // amount
			$grid[$j][4]="";								// Search reset
			$grid[$j][5]=$row[0];							// Double click value
			$j++;
		}
        return $grid;
	}
	
	// code for exported timesheet -- jyothi
	
	function getExportedTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.template","u1.name",tzRetQueryStringDTime('t.exported_time','DateTime24Sec','/'));
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.template","u1.name","MAX(t.exported_time)");
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedate'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }
        // TimeSheet Grid Load Optimization--Code Ends
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
			LEFT JOIN users u1 ON u1.username=t.exported_user
		WHERE t.exported_status='YES' AND t.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('p.sdate','Date','/').",".tzRetQueryStringDate('p.edate','Date','/').",ROUND(SUM(t.hours),2),CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END,".tzRetQueryStringDTime('MAX(t.exported_time)','DateTime24Sec','/').",p.username,".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate,IF(t.edate!='0000-00-00','Range','Daily') AS tab, u1.name
		
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
			LEFT JOIN users u1 ON u1.username=t.exported_user
		WHERE t.exported_status='YES' AND t.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildExportedTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
       //Time Sheet Load Optimization-
         if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
         }
        $objResponse->addScriptCall("updateGridDateDisplay",$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////

		return $objResponse;
	}	

	function buildExportedTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
        $mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
			$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			if($row[10] == 'Clock In & Out'){
				$grid[$j][10]=$row[10];
			}
			else{
				$grid[$j][10]=$this->convertSpecChars($row[10])."(".$this->convertSpecChars($row[15]).")";
			}
			$grid[$j][11]=$this->convertSpecChars($row[16]);
			$grid[$j][12]=$this->convertSpecChars($row[11]);
			$grid[$j][13]=$row[0]."|".$row[10];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization 
			$j++;
		}
        // TimeSheet Grid Load Optimization 
        asort($mindatearray);
        asort($maxdatearray);
        $mindate = reset($mindatearray);
        $maxdate = end($maxdatearray);
        unset($midate);
        unset($mindatearray);
        unset($maxdatearray);
        unset($madate);
        $grid['totalCount'] = mysql_num_rows($res);
        $grid['maxdate'] = $maxdate;
        $grid['mindate'] = $mindate;
        // TimeSheet Grid Load Optimization 

	    return $grid;
	}
	
	function getExportedDetailTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		$addr = $gridExtraFields['addr'];

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("",tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/'), tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/'), "ROUND(SUM(timesheet_hours.hours),2)","TRIM(users.name)", tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/'));

		$ssFields = array("","MIN(par_timesheet.sdate)", "MAX(par_timesheet.edate)", "ROUND(SUM(timesheet_hours.hours),2)","TRIM(users.name)","MAX(timesheet_hours.approvetime)");

		$getCond = '';	

		if($gridSearchFields[3] != "")	//for Approved By.
		{
			$getCond .= "AND  users.name LIKE '%".$gridSearchFields[3]."%'";
			$gridSearchFields[3] = "";
		}

		$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status = 'YES' AND  timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'";   		

		$oque ="SELECT ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", SUM(timesheet_hours.hours), TRIM(users.name), ".tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/').", par_timesheet.sno FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status = 'YES' AND timesheet_hours.status IN ('Approved','Billed') AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond";   

		$grp_str = " GROUP BY par_timesheet.sno";

		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr1 = $gd->buildQSTRTimeSht($gridSearchType, $gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count = "$oque $qstr $grp_str $qstr1 $ostr";
		$total = $gd->getTotalCount($oque_Count);
		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";

		$gridData = $gd->buildExportedDetailTimeSheets($oque);

		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildExportedDetailTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[5]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars(number_format($row[2],2));
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]="";
			$grid[$j][7]=$row[5];
			$j++;
		}

	    return $grid;
	}

	function getRejectedTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)",tzRetQueryStringDTime('t.approvetime','DateTime24Sec','/'));
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.template","TRIM(u.name)",tzRetQueryStringDTime('t.approvetime','DateTime24Sec','/'));

		$ins_query  = mysql_query("select ExportedTimesheet from company_info",$db);
		$ins_row=mysql_fetch_array($ins_query);
		if($ins_row[0]=="YES")
             $exportCond="t.exported_status!='YES' AND ";
		else
             $exportCond="";
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedate'];
            $timesheetToDate =  $gridExtraFields['servicedateto'];
        }
        //// TimeSheet Grid Load Optimization -code ends//
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE ".$exportCond." t.status='Rejected' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('p.sdate','Date','/').",".tzRetQueryStringDate('p.edate','Date','/').",IF(p.template='Clockinout',t.hours,ROUND(SUM(t.hours),2)),CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out'  END,TRIM(u.name),".tzRetQueryStringDTime('MAX(t.approvetime)','DateTime24Sec','/').",p.username,".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate,IF(t.edate!='0000-00-00','Range','Daily') AS tab, t.sno AS ts_sno
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
			LEFT JOIN users u ON t.auser=u.username
		WHERE ".$exportCond." t.status='Rejected' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildRejectedTimeSheets($oque);
         // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        //Time Sheet Load Optimization
        if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
         }
        $objResponse->addScriptCall("updateGridDateDisplay",$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////

		return $objResponse;
	}

	function buildRejectedTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
			$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			if($row[10] == 'Clock In & Out'){
				$grid[$j][10]=$row[10];
			}
			else{
				$grid[$j][10]=$this->convertSpecChars($row[10])."(".$this->convertSpecChars($row[16]).")";
			}
			$grid[$j][11]=$this->convertSpecChars(stripslashes($row[11]));
			$grid[$j][12]=$this->convertSpecChars($row[12]);
			$grid[$j][13]=$row[0]."|".$row[10];
			$grid[$j][14]=$row[17];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization
			$j++;
		}
        // TimeSheet Grid Load Optimization 
            asort($mindatearray);
            asort($maxdatearray);
            $mindate = reset($mindatearray);
            $maxdate = end($maxdatearray);
            unset($midate);
            unset($mindatearray);
            unset($maxdatearray);
            unset($madate);
            $grid['totalCount'] = mysql_num_rows($res);
            $grid['maxdate'] = $maxdate;
            $grid['mindate'] = $mindate;
            // TimeSheet Grid Load Optimization 
      
	    return $grid;
	}

	function getRejectedDetailTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		$addr = $gridExtraFields['addr'];

		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();
						
		$asFields = array("",tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/'), tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/'), "ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END","TRIM(users.name)", tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/'));
		$ssFields = array("","MIN(par_timesheet.sdate)", "MAX(par_timesheet.edate)", "ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END","TRIM(users.name)","MAX(timesheet_hours.approvetime)");

		$getCond = '';
		
		//For TimeInTimeOut Check
		$tito_clause	= '';

		if (!empty($gridSearchFields[3])) {

			$flag	= strtolower($gridSearchFields[3]);
			$flag	= ($flag == 'in & out') ? 'TimeInTimeOut' : (($flag == 'uom') ? 'UOM' :'Regular');

			$tito_clause .= " AND par_timesheet.template ='$flag' ";

			$gridSearchFields[3]	= "";
		}
		
		if($gridSearchFields[4] != "")	//for Approved By.
		{
			$getCond .= "AND  users.name LIKE '%".$gridSearchFields[3]."%'";
			$gridSearchFields[4] = "";
		}

		// code to get Exported Timesheet value -- jyothi
        $ins_query  = mysql_query("select ExportedTimesheet from company_info",$db);
		$ins_row=mysql_fetch_array($ins_query);
		if($ins_row[0] == 'YES')
             $accountingExport1 = 'Exported';
		else
		     $accountingExport1 = '';

		if($accountingExport1 == 'Exported')
		{
			$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status != 'YES' AND timesheet_hours.status = 'Rejected' AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'".$tito_clause;
			$oque ="SELECT ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", SUM(timesheet_hours.hours), CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END, TRIM(users.name), ".tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/').", par_timesheet.sno FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.exported_status != 'YES' AND timesheet_hours.status = 'Rejected' AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond".$tito_clause;
		}
		else
		{
			$tque = "SELECT count(par_timesheet.sno) FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE   timesheet_hours.status ='Rejected' AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond".$tito_clause;
			$oque ="SELECT ".tzRetQueryStringDate('MIN(par_timesheet.sdate)','Date','/').",".tzRetQueryStringDate('MAX(par_timesheet.edate)','Date','/').", SUM(timesheet_hours.hours),CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END, TRIM(users.name), ".tzRetQueryStringDTime('MAX(timesheet_hours.approvetime)','DateTime24Sec','/').", par_timesheet.sno FROM par_timesheet LEFT JOIN timesheet_hours ON par_timesheet.sno=timesheet_hours.parid LEFT JOIN users ON timesheet_hours.auser = users.username WHERE timesheet_hours.status = 'Rejected' AND par_timesheet.username='".$addr."' AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."' $getCond".$tito_clause;
		}

		$grp_str = " GROUP BY par_timesheet.sno";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);

		$qstr1 = $gd->buildQSTRTimeSht($gridSearchType, $gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count = "$oque $qstr $grp_str $qstr1 $ostr";
		$total = $gd->getTotalCount($oque_Count);

		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";		

		$gridData = $gd->buildRejectedDetailTimeSheets($oque);
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildRejectedDetailTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[6]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$this->convertSpecChars(number_format($row[2],2));
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]="";
			$grid[$j][8]=$row[6]."|".$row[3];
			$j++;
		}

	    return $grid;
	}

	function getCandidatesArc($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		// Searching array
		$asFields = array("candidate_list.sno","candidate_list.profiletitle","CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname)", "candidate_list.hphone", "candidate_list.city", "candidate_list.state", "IF((candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'),'Immediate',IF ( (datediff(candidate_prof.availsdate, now( ) )) <0, 'Immediate',".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/')."))", "IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))", "IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share'))", "users.name");

		//ordering array
		$ssFields = array("candidate_list.sno","candidate_list.profiletitle","fullname", "candidate_list.hphone", "candidate_list.city", "candidate_list.state", "candidateaval", "ctype", "accessto", "users.name");

		$tque="SELECT COUNT(1) 
		FROM users, candidate_list 
		LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
		WHERE 
		candidate_list.owner = users.username 
		AND candidate_list.status='INACTIVE' 
		and candidate_list.owner = '".$username."'";

		$oque="SELECT candidate_list.sno, candidate_list.username, candidate_list.profiletitle,
		CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname) as fullname,
		candidate_list.hphone, candidate_list.city, candidate_list.state,IF((candidate_prof.availsdate='0-0-0' or candidate_prof.availsdate='' or candidate_prof.availsdate IS NULL or candidate_prof.availsdate='immediate'), 'Immediate', IF((datediff(candidate_prof.availsdate, now())) <0, 'Immediate',".tzRetQueryStringSelBoxDate('STR_TO_DATE(candidate_prof.availsdate,\'%Y-%m-%d\')','Date','/').")) as candidateaval,IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as ctype,IF (candidate_list.accessto = 'ALL', 'Public',IF (candidate_list.accessto = '".$username."', 'Private', 'Share')) accessto,users.name, candidate_list.resid, CONCAT_WS(' ', candidate_list.amount, candidate_list.currency, candidate_list.period) as candamount,candidate_list.status, 'skills', candidate_list.vcount 
		FROM users, candidate_list 
		LEFT JOIN candidate_prof ON candidate_list.username=candidate_prof.username 
		WHERE 
		candidate_list.owner = users.username 
		AND candidate_list.status='INACTIVE' 
		and candidate_list.owner = '".$username."'";

		$gstr = "";
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCandidatesArc($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCandidatesArc($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$gd = new gridData();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[1]."|".$row[8]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[2]);// Profile Title
			$grid[$j][2] = $this->convertSpecChars($row[3]);// Candidate Name
			$grid[$j][3] = $this->convertSpecChars($row[4]);// Phone
			$grid[$j][4] = $this->convertSpecChars($row[5]);// City
			$grid[$j][5] = $this->convertSpecChars($row[6]);// State
			$grid[$j][6] = $this->convertSpecChars($row[7]);// Availability
			$grid[$j][7] = $this->convertSpecChars($row[8]);// Candidate Type
			$grid[$j][8] = $this->convertSpecChars($row[9]);// Type
			$grid[$j][9] = $this->convertSpecChars($row[10]);// Owner
			$grid[$j][10] = ($row[11] == "" || $row[11] == 0) ? "" : "<a href='getresume.php?fsno=".$row[11]."><img src='/BSOS/images/icons/download.gif' alt='View&nbsp;Resume' border=0></a>";// Resume
			$grid[$j][11] = '';
			$grid[$j][13] = 'hirevcon.php?type=cand&addr='.$row[1];
			$j++;
		}
		return $grid;
	}

	function getJobordersArc($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		// Searching array
		$asFields = array("","posdesc.postitle","staffoppr_cinfo.cname","IF(req_pref.brateopen='Y','Open',CONCAT(req_pref.bamount,'-',req_pref.bcurrency,'/',req_pref.bperiod))","posdesc.refcode","users.name");

		//ordering array
		$ssFields = array("","posdesc.postitle","staffoppr_cinfo.cname","rate","posdesc.refcode","users.name");

		$tque="SELECT COUNT(1) 
		FROM 
		posdesc 
		LEFT JOIN staffoppr_cinfo ON (posdesc.company = staffoppr_cinfo.sno) 
		LEFT JOIN req_pref ON posdesc.posid=req_pref.posid
		JOIN users ON users.username = posdesc.owner
		WHERE 
		posdesc.owner = '".$username."' 
		AND posdesc.STATUS IN ('deleted')";

		$oque="SELECT 
		posdesc.posid,
		posdesc.postitle,
		CONCAT('<a href=javascript:showComp(',staffoppr_cinfo.sno,',\'CRM\')>', staffoppr_cinfo.cname, '</a>') as cname,
		IF(req_pref.brateopen='Y','Open',CONCAT(req_pref.bamount,'-',req_pref.bcurrency,'/',CASE req_pref.bperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE req_pref.bperiod END)) rate,
		posdesc.refcode,
		users.name
		FROM 
		posdesc 
		LEFT JOIN staffoppr_cinfo ON ( posdesc.company = staffoppr_cinfo.sno ) 
		LEFT JOIN req_pref ON posdesc.posid=req_pref.posid
		JOIN users ON users.username = posdesc.owner
		WHERE 
		posdesc.owner = '".$username."' 
		AND posdesc.STATUS IN ('deleted')";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildJobordersArc($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildJobordersArc($que)
	{
		global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop()' value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]);// Title
			$grid[$j][2] = $row[2];// Company
			$grid[$j][3] = $this->convertSpecChars($row[3]);// Rate
			$grid[$j][4] = $this->convertSpecChars($row[4]);// Skills
			$grid[$j][5] = $this->convertSpecChars($row[5]);// Owner
			$grid[$j][6] = '';
			$grid[$j][7] = $row[0];//'hirevcon.php?type=cand&addr='.$row[1];//
			$j++;
		}
		return $grid;
	}

	function getJobPostings($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		// Searching array
		$asFields = array("","trim(posdesc.postitle)","", "", "", "IF(posdesc.accessto = 'all', 'Public', IF (posdesc.accessto != '".$username."', 'Share', 'Private'))", "users.name", tzRetQueryStringDTime("job_post_det.senddate","DateTime","/"));

		//ordering array
		$ssFields = array("","trim(posdesc.postitle)","", "", "", "IF(posdesc.accessto = 'all', 'Public', IF (posdesc.accessto != '".$username."', 'Share', 'Private'))", "users.name", tzRetQueryStringDTime("job_post_det.senddate","DateTime","/"));

		$tque="SELECT COUNT(1) 
		FROM job_post_det, posdesc 
		LEFT JOIN manage ON posdesc.posstatus = manage.sno 
		LEFT JOIN users ON posdesc.owner = users.username 
		WHERE posdesc.posid = job_post_det.posid 
		AND posdesc.status IN ('approve', 'Accepted') 
		AND manage.type='jostatus' AND manage.name NOT IN ('Closed','Cancelled')";

		$oque="SELECT posdesc.posid,posdesc.postitle,".tzRetQueryStringDTime("job_post_det.senddate","DateTime","/").",IF(posdesc.accessto = 'all', 'Public', IF (posdesc.accessto != '".$username."', 'Share', 'Private')),users.name,'',posdesc.vcount 
		FROM job_post_det, posdesc
		LEFT JOIN manage ON posdesc.posstatus = manage.sno 
		LEFT JOIN users ON posdesc.owner = users.username 
		WHERE posdesc.posid = job_post_det.posid 
		AND posdesc.status IN ('approve', 'Accepted') 
		AND manage.type='jostatus' AND manage.name NOT IN ('Closed','Cancelled')";

		$gstr = " GROUP BY posdesc.posid ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildJobPostings($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildJobPostings($que)
	{
		global $maildb,$db;

		$j=0;

		$grid=array();
		$gd = new gridData();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$inquiries = 0;
			$responses = 0;

			$seq_Query = "SELECT seqnumber FROM job_post_det WHERE posid = '$row[0]' AND par_id = '0'";
			$seq_Result = mysql_query($seq_Query,$db);			
			while ($seq_Row = mysql_fetch_row($seq_Result))
			{
				$inq_Query = "SELECT count(*) FROM process_mail_headers WHERE folder = 'ReqPost' AND subject LIKE '%".$seq_Row[0]."%'";
				$inq_Result = mysql_query($inq_Query,$db);
				$inq_Row = mysql_fetch_row($inq_Result);
				$inquiries += $inq_Row[0];

				$resp_Query = "SELECT count(*) FROM process_mail_headers WHERE folder = 'ReqPostResponses' AND subject LIKE '%".$seq_Row[0]."%' ";
				$resp_Result = mysql_query($resp_Query,$db);
				$resp_Row = mysql_fetch_row($resp_Result);
				$responses += $resp_Row[0];
			}

			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=".$row[0]."><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]);
			$grid[$j][2] =  ($inquiries == 0) ? '' : trim($inquiries);
			$grid[$j][3] = "<a href=javascript:showPost(".$row[0].")><i class='fa fa-arrow-up' title='Show All Postings'></i></a>";
			$grid[$j][4] = ($responses == 0) ? '' : trim($responses);
			$grid[$j][5] = $row[3];
			$grid[$j][6] = $this->convertSpecChars($row[4]);
			$grid[$j][7] = $row[2];
			$grid[$j][8] = '';
			$grid[$j][9] = $row[0];
			$j++;
		}

		return $grid;
	}

	// Function for Hiring Managment's XAJAX Grid Outputs - Added by Sandeep Boora
	function buildBenefits($que)
	{
		global $maildb,$db;

		$j	= 0;
		$grid	= array();

		$res	= mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{

			$grid[$j][0]	= "<label class='container-chk'><input type='checkbox' name='auids[]' OnClick='chk_clearTop()' value='".$row[0]."'><span class='checkmark'></span></label>".$gif;
			$grid[$j][1]	= $this->convertSpecChars($row[1]);
			$grid[$j][2]	= $this->convertSpecChars($row[2]);
			$grid[$j][3]	= $this->convertSpecChars($row[0]);

			$j++;
		}

		return $grid;
	}
	
	// Function for Benefits XAJAX Grid Inputs and Queries - Added by Jyothi Chundi
	function getBenefits($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol == "")
			$gridSortCol = 1;

		$gd		= new gridData();
		$asFields	= array("","eartype","EarnedBenefit");
		$ssFields	= array("","eartype","EarnedBenefit");

		$tque		= " SELECT COUNT(1) FROM (SELECT sno,eartype,'EarnedBenefit' FROM companyear UNION SELECT sno,name,'OtherBenefit' FROM companycon WHERE status='active') AS Benefits WHERE 1 = 1 ";

		$oque		= " SELECT * FROM (SELECT CONCAT('e_',sno),eartype,'EarnedBenefit' FROM companyear UNION SELECT CONCAT('c_',sno),name,'OtherBenefit' FROM companycon WHERE status='active') AS Benefits WHERE 1 = 1 ";

		$grpque		= "";
		$qstr 		= "";

		$lstr		= $gd->buildLimt($gridPage,$gridRecords);
		$qstr		= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$qstr 		.= $qstr1;

		$ostr		= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque		= $gd->buildTQuery($tque,$qstr,$grpque);
		$oque		= "$oque $qstr $grpque $ostr $lstr";	//For Total Records Data

		$total		= $gd->getTotalRows($tque);
		$gridData	= $gd->buildBenefits($oque);

		$objResponse 	= new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse; 		
	}
	
	// Function for Departmet XAJAX Grid Outputs - Added by Sandeep Boora
	function buildHistoryDepartment($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>".$gif;
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[0]);
			
			$j++;
		}
		return $grid;
	}
	
	// Function for  XAJAX  Department Grid Inputs and Queries - Added by Jyothi Chundi
	function getHistoryDepartment($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields=array("","hrcon_general.fname","hrcon_general.lname","hrcon_skills.skillname","hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");
	    $ssFields=array("","hrcon_general.fname","hrcon_general.lname","hrcon_skills.skillname","hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");

		$tque="SELECT count(1) FROM emp_list LEFT JOIN hrcon_general ON emp_list.username=hrcon_general.username LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username AND hrcon_jobs.ustatus='active') LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN hrcon_skills ON (emp_list.username=hrcon_skills.username AND hrcon_skills.ustatus='active') WHERE  hrcon_w4.ustatus='active' AND hrcon_compen.ustatus='active' AND hrcon_general.ustatus='active' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y'  ";

		$oque="SELECT emp_list.sno,hrcon_general.fname,hrcon_general.lname,hrcon_skills.skillname,hrcon_general.wphone,hrcon_general.email,IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OP','On Assignment','')) jtype,hrcon_w4.tax FROM emp_list LEFT JOIN hrcon_general ON emp_list.username=hrcon_general.username LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username AND hrcon_jobs.ustatus='active') LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username LEFT JOIN hrcon_compen ON emp_list.username=hrcon_compen.username LEFT JOIN hrcon_skills ON (emp_list.username=hrcon_skills.username AND hrcon_skills.ustatus='active') WHERE  hrcon_w4.ustatus='active' AND hrcon_compen.ustatus='active' AND hrcon_general.ustatus='active' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y' ";

		if($gridExtraFields['edeptname'] != '')
		{			
			$oque .= " AND hrcon_compen.dept IN (".$gridExtraFields['edeptname'].")";
			$tque .= " AND hrcon_compen.dept IN (".$gridExtraFields['edeptname'].")";		
		}

	    $gstr = " group by emp_list.sno";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
                $tque="SELECT COUNT(1) FROM (".$tque.") as emp_count";
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildHistoryDepartment($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	// Function for Hiring_review XAJAX Grid Outputs - Added by Sandeep Boora
	function buildHiring_review($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>".$gif;
			$grid[$j][1]=$this->convertSpecChars($row[1]);

			if($this->convertSpecChars($row[3]) !='Not Available')
			{
				$url="../Hiring_Mngmt/showreqdet.php?addr=".$this->convertSpecChars($row[2]);
				$grid[$j][2]="<a href=javascript:winopen('".$url."')>".$this->convertSpecChars($row[3])."</a>";
			}
			else 
			{
				$grid[$j][2]=$this->convertSpecChars($row[3]);
			}

			$grid[$j][3]=$this->convertSpecChars($row[7]);
			$grid[$j][4]=$this->convertSpecChars($row[6]);

			$noassign="";
			if($this->convertSpecChars($row[8]) !='sub' && $this->convertSpecChars($row[8]) !='con')
				$noassign="S";

			if($noassign == "")
				$grid[$j][5]=$this->convertSpecChars($row[5]);
			else
				$grid[$j][5]=trim($this->convertSpecChars($row[5])."|".$noassign);

			$j++;
		}
		return $grid;
	}
	
	// Function for  XAJAX  Department Grid Inputs and Queries - Added by Jyothi Chundi
	function getHiring_review($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
	
		$asFields=array("","applicants.name","posdesc.postitle","applicants.type","if(applicants.apmark ='$username','Self',if(applicants.apmark = '','Not Available',users.name))");
	    $ssFields=array("","applicants.name","posdesc.postitle","applicants.type","if(applicants.apmark ='$username','Self',if(applicants.apmark = '','Not Available',users.name))");


		$tque="SELECT COUNT(1) 
		FROM applicants 
		LEFT JOIN posdesc ON applicants.jobtitle = posdesc.posid 
		LEFT JOIN users ON applicants.username = users.username 
		WHERE admin='".$username."+F' ";

		$oque="SELECT applicants.serial_no,applicants.name,posdesc.posid,if(posdesc.postitle ='','Not Available',posdesc.postitle) as pos ,applicants.type,applicants.username,if(applicants.apmark ='$username','Self',if(applicants.apmark = '','Not Available',users.name)) as source ,if(applicants.type = 'sub','Sub Contractor',if(applicants.type = 'con','Independent Consultant','Present Employee')) as distype,applicants.type 
		FROM applicants 
		LEFT JOIN posdesc ON applicants.jobtitle = posdesc.posid 
		LEFT JOIN users ON applicants.username = users.username 
		WHERE admin='".$username."+F' ";

   	    $gstr = " ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildHiring_review($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;		
	}

	// Function for Hiring_review XAJAX Grid Outputs - Added by Sandeep Boora
	function buildHiring_reviewHistory($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>".$gif;
			$grid[$j][1]=$this->convertSpecChars($row[2]);
			$std = $this->convertSpecChars($row[9])."-".$this->convertSpecChars($row[13])."(".$this->convertSpecChars($row[11]).")";
			$dd = $this->convertSpecChars($row[12]);
			$grid[$j][2]=html_tls_specialchars(addslashes(trim($std)),ENT_QUOTES)." ".html_tls_specialchars(addslashes(trim($dd)),ENT_QUOTES);
			$grid[$j][3]=$this->convertSpecChars($row[0]);
			$j++;
		}

		return $grid;
	}

	// Function for  XAJAX  Department Grid Inputs and Queries - Added by Jyothi Chundi
	function getHiring_reviewHistory($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
	
		$asFields=array("","applicants.name","pdate");
	    $ssFields=array("","applicants.name","pdate");

		$tque="SELECT COUNT(1) 
		FROM applicants 
		LEFT JOIN apphistory ON applicants.username=apphistory.username AND apphistory.status='Rejected' 
		LEFT JOIN emp_list ON apphistory.appuser=emp_list.username 
		WHERE admin='".$username."+RJ'";

		$oque="SELECT applicants.serial_no,applicants.username,applicants.name,applicants.status,applicants.avail,applicants.rate,applicants.reffered,applicants.jobtitle,apphistory.sno,date_format(apphistory.sdate,'%m/%d/%Y') as pdate,apphistory.appuser,apphistory.status,apphistory.notes,emp_list.name 
		FROM applicants 
		LEFT JOIN apphistory ON applicants.username=apphistory.username AND apphistory.status='Rejected' 
		LEFT JOIN emp_list ON apphistory.appuser=emp_list.username 
		WHERE admin='".$username."+RJ'";
	  
   	    $gstr = " GROUP BY applicants.username ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildHiring_reviewHistory($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	// Function for Departmet XAJAX Grid Outputs - Added by Sandeep Boora
	function buildEmployee_review($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[0]);			
			$j++;
		}
		return $grid;
	}
	
	// Function for  XAJAX  Department Grid Inputs and Queries - Added by Jyothi Chundi
	function getEmployee_review($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		$asFields=array("","hrcon_general.fname","hrcon_general.lname","hrcon_skills.skillname","hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");
	    $ssFields=array("","hrcon_general.fname","hrcon_general.lname","hrcon_skills.skillname","hrcon_general.wphone","hrcon_general.email","jtype","hrcon_w4.tax");

		$tque="SELECT distinct(emp_list.sno) 
		FROM emp_list 
		LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active') 
		LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		LEFT JOIN hrcon_skills ON (emp_list.username=hrcon_skills.username AND hrcon_skills.ustatus='active') 
		WHERE (datediff(DATE_ADD(str_to_date(hrcon_compen.date_hire,'%m-%d-%Y'),INTERVAL IF(hrcon_compen.rev_period='',NULL,hrcon_compen.rev_period) MONTH),current_date())<0) 
		AND hrcon_w4.ustatus='active' 
		AND hrcon_general.ustatus='active' 
		AND emp_list.lstatus NOT IN ('DA','INACTIVE') 
		AND emp_list.empterminated != 'Y' 
		AND FIND_IN_SET('".$username."',department.permission)>0 
		AND hrcon_compen.ustatus='active' ";

		$oque="SELECT distinct(emp_list.sno),hrcon_general.fname,hrcon_general.lname,hrcon_skills.skillname,hrcon_general.wphone,hrcon_general.email,IF(hrcon_jobs.jtype='OB','On Bench',IF(hrcon_jobs.jtype='OP','On Assignment','')) jtype,hrcon_w4.tax,hrcon_general.username 
		FROM emp_list 
		LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		LEFT JOIN hrcon_jobs ON (emp_list.username=hrcon_jobs.username and hrcon_jobs.ustatus='active') 
		LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		LEFT JOIN hrcon_skills ON (emp_list.username=hrcon_skills.username AND hrcon_skills.ustatus='active') 
		WHERE (datediff(DATE_ADD(str_to_date(hrcon_compen.date_hire,'%m-%d-%Y'),INTERVAL IF(hrcon_compen.rev_period='',NULL,hrcon_compen.rev_period) MONTH),current_date())<0) 
		AND hrcon_w4.ustatus='active' 
		AND hrcon_general.ustatus='active' 
		AND emp_list.lstatus NOT IN ('DA','INACTIVE') 
		AND emp_list.empterminated != 'Y' 
		AND FIND_IN_SET('".$username."',department.permission)>0 
		AND hrcon_compen.ustatus='active' ";

	    $gstr = " group by emp_list.sno ";
	    // Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('hrcon_general.wphone',$ssFields)){
			$asFieldsKey = array_search("hrcon_general.wphone", $ssFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("hrcon_general.wphone",$asFieldsKey);
			$ssFields[$asFieldsKey] = $asFields[$asFieldsKey];
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("hrcon_general.wphone",$gridSearchFields,$asFieldsKey);
		}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildEmployee_review($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;	
	}


	function getMyJobs($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		// Searching array
		$asFields = array("","hrcon_jobs.pusername","hrcon_jobs.project","CONCAT(staffacc_location.address1, ' ', staffacc_location.address2, ' ', staffacc_location.city, ' ',staffacc_location.state, ' ',staffacc_location.zipcode)", "concat(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)", tzRetQueryStringSTRTODate("hrcon_jobs.s_date","%m-%d-%Y","Date","-"),tzRetQueryStringSTRTODate("hrcon_jobs.e_date","%m-%d-%Y","Date","-"));

		//ordering array
		$ssFields = array("","hrcon_jobs.pusername","hrcon_jobs.project","CONCAT(staffacc_location.address1, ' ', staffacc_location.address2, ' ', staffacc_location.city, ' ',staffacc_location.state, ' ',staffacc_location.zipcode)", "concat(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname)", tzRetQueryStringSTRTODate("hrcon_jobs.s_date","%m-%d-%Y","Date","-"),tzRetQueryStringSTRTODate("hrcon_jobs.e_date","%m-%d-%Y","Date","-"));

		$tque="SELECT COUNT(1) 
			FROM hrcon_jobs
			LEFT JOIN staffacc_location ON staffacc_location.sno = hrcon_jobs.`endclient`
			LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno=hrcon_jobs.endclient
			LEFT JOIN staffacc_contact ON staffacc_contact.sno=hrcon_jobs.manager
			WHERE hrcon_jobs.username='".$username."' AND hrcon_jobs.ustatus IN ('active','closed')";

		$oque="SELECT hrcon_jobs.sno,hrcon_jobs.pusername,hrcon_jobs.project,
			CONCAT(staffacc_location.address1, ' ', staffacc_location.address2, ' ', staffacc_location.city, ' ',staffacc_location.state, ' ',staffacc_location.zipcode),
			CONCAT(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname),
			DATE_FORMAT(STR_TO_DATE(IF(hrcon_jobs.s_date='0-0-0','00-00-0000',hrcon_jobs.s_date),'%m-%d-%Y'),'%m-%d-%Y'),
			DATE_FORMAT(STR_TO_DATE(IF(hrcon_jobs.e_date='0-0-0','00-00-0000',hrcon_jobs.e_date),'%m-%d-%Y'),'%m-%d-%Y')
			FROM hrcon_jobs
			LEFT JOIN staffacc_location ON staffacc_location.sno = hrcon_jobs.`endclient`
			LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno=hrcon_jobs.endclient
			LEFT JOIN staffacc_contact ON staffacc_contact.sno=hrcon_jobs.manager
			WHERE hrcon_jobs.username='".$username."' AND hrcon_jobs.ustatus IN ('active','closed')";


		/*SELECT hrcon_jobs.sno,hrcon_jobs.pusername,hrcon_jobs.project,staffacc_cinfo.cname,concat(' ',staffacc_contact.fname,staffacc_contact.mname,staffacc_contact.lname),".tzRetQueryStringSTRTODate("hrcon_jobs.s_date","%m-%d-%Y","Date","-").",".tzRetQueryStringSTRTODate("hrcon_jobs.e_date","%m-%d-%Y","Date","-")." 
		FROM hrcon_jobs 
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno=hrcon_jobs.endclient 
		LEFT JOIN staffacc_contact ON staffacc_contact.sno=hrcon_jobs.manager		
		WHERE hrcon_jobs.username='".$username."' AND hrcon_jobs.ustatus IN ('active','closed')
		*/

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMyJobs($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildMyJobs($que)
	{
		global $maildb,$db;

		$j=0;

		$grid=array();
		$gd = new gridData();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "";
			$grid[$j][1] = $this->convertSpecChars($row[1]);
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = "";
			$grid[$j][8] = $row[0];
			$j++;
		}

		return $grid;
	}

	function getMyExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$tod=$gridExtraFields['tod'];
		$todaf=$gridExtraFields['todaf'];

		if($tod!="" && $todaf!="")
			$dstr=" AND par_expense.sdate >='".$tod."' AND par_expense.edate<='".$todaf."' ";

		// Searching array
		$asFields = array("",tzRetQueryStringSelBoxDate("par_expense.sdate","Date","/"),tzRetQueryStringSelBoxDate("par_expense.edate","Date","/"),"","","","getExpStat(expense.status,par_expense.pstatus)");

		//ordering array
		$ssFields = array("",tzRetQueryStringSelBoxDate("par_expense.sdate","Date","/"),tzRetQueryStringSelBoxDate("par_expense.edate","Date","/"),"","","","getExpStat(expense.status,par_expense.pstatus)");

		$tque="SELECT COUNT(1) 
		FROM par_expense 
		LEFT JOIN expense ON expense.parid=par_expense.sno 
		WHERE par_expense.username='".$username."' 
		AND expense.status IN ('ER', 'Saved', 'Rejected') 
		AND par_expense.astatus IN ('Rejected', 'Saved', 'ER','Approved')";

		$oque="SELECT par_expense.sno,".tzRetQueryStringSelBoxDate("MIN(par_expense.sdate)","Date","/").",".tzRetQueryStringSelBoxDate("MAX(par_expense.edate)","Date","/").",sum(expense.unitcost * expense.quantity),sum(expense.advance),getExpStat(expense.status,par_expense.pstatus),expense.status 
		FROM par_expense 
		LEFT JOIN expense ON expense.parid=par_expense.sno 
		WHERE par_expense.username='".$username."' 
		AND expense.status IN ('ER', 'Saved', 'Rejected') 
		AND par_expense.astatus IN ('Rejected', 'Saved', 'ER','Approved')";

		$tque=$tque.$dstr;
		$oque=$oque.$dstr;

		$gstr = " GROUP BY par_expense.sno,expense.status ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildMyExpenses($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildMyExpenses($que)
	{
		global $maildb,$db;

		$j=0;

		$grid=array();
		$gd = new gridData();
		$decimalPref    = getDecimalPreference();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] Onclick=chk_clearTop_TimeSheet() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]);
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars(number_format($row[3],$decimalPref,'.',''));
			$grid[$j][4] = $this->convertSpecChars(number_format($row[4],$decimalPref,'.',''));
			$grid[$j][5] = $this->convertSpecChars(number_format(($row[3]-$row[4]),$decimalPref,'.',''));
			$grid[$j][6] = $this->convertSpecChars(($row[5] == 'ER') ?  'Submitted to Accounts' : $row[5]);
			$grid[$j][7] = "";
			$grid[$j][8] = "showexpense.php?id=".$row[0]."&clistatus=".$row[6];
			$j++;
		}

		return $grid;
	}

	function getCRMCompaniesAllJobOrders($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$compid = $gridExtraFields['compid'];
		$module = $gridExtraFields['module'];
		if($compid != '')
		{
			$AllContacts='';
			$All_Act_ids='com'.$compid."((,)|($))";

			$All_Contacts="SELECT sno FROM staffoppr_contact WHERE csno='".$compid."' AND crmcontact='Y' AND status='ER' AND (FIND_IN_SET('".$username."',accessto)>0 OR owner='".$username."' OR accessto='ALL') GROUP BY sno";
			$All_Contcats_Res=mysql_query($All_Contacts,$db);
			while($All_Contcats_Data=mysql_fetch_row($All_Contcats_Res))
			{
				if($AllContactSnos=='')
					$AllContactSnos=$All_Contcats_Data[0];
				else
					$AllContactSnos.=",".$All_Contcats_Data[0];

				$All_Act_ids.="|oppr".$All_Contcats_Data[0]."((,)|($))";
			}
		}
 
		$asFields = array("", "postitle", "posstartdate", "stage", "terms", "stime");
		$ssFields = array("", "postitle", "strtdate", "stage", "terms", "cdate");

		$oque1 = "SELECT
		posdesc.posid,
		CONCAT(posdesc.posid,'-',posdesc.postitle) AS postitle,
		".tzRetQueryStringSelBoxDate("posdesc.posstartdate","Date","/")." AS strtdate,
		(select name from manage where sno=posdesc.jostage) AS stage,
		IF( posdesc.company = '".$compid."','Received','') AS terms,
		".tzRetQueryStringDTime('posdesc.stime','DateTime','/')." AS cdate,
		posdesc.posstartdate,
		posdesc.stime
		FROM 
		users ,posdesc
		LEFT JOIN job_post_det ON job_post_det.posid=posdesc.posid
		WHERE
		posdesc.company = '$compid' 
		AND posdesc.status in ('approve','Accepted')
		AND posdesc.owner=users.username
		GROUP BY posdesc.posid
		UNION ALL
		SELECT 
		posdesc.posid,
		CONCAT(posdesc.posid,'-',posdesc.postitle) AS postitle,
		posdesc.posstartdate,
		".tzRetQueryStringSelBoxDate("posdesc.posstartdate","Date","/")." AS strtdate,
		(select name from manage where sno=posdesc.jostage) AS stage,
		IF((sendlist REGEXP '".$All_Act_ids."')>0,'Broadcast','') AS terms,
		".tzRetQueryStringDTime('posdesc.stime','DateTime','/')." AS cdate,
		posdesc.stime
		FROM
		users ,posdesc 
		LEFT JOIN job_post_det ON job_post_det.posid=posdesc.posid 
		WHERE 
		((sendlist REGEXP '".$All_Act_ids."')>0 ) 
		AND posdesc.status in ('approve','Accepted') 
		AND posdesc.owner=users.username
		GROUP BY posdesc.posid";

		$oque = "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
		$tque="SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";

		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$ssFields,'3');

		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCRMCompaniesAllJobOrders($oque,$module);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCRMCompaniesAllJobOrders($que,$module)
	{
		global $maildb,$db;

		$j = 0;
		$grid = array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[2] == '00/00/0000')
                $row[2] = '';

			$grid[$j][0] = '';
			$grid[$j][1] = $this->convertSpecChars($row[1]);
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = '';
			$grid[$j][7] = '/BSOS/Sales/Req_Mngmt/redirectjob.php?addr='.$row[0].'&module='.$module;
			$j++;
		}

		return $grid;
	}

	function getCRMCompaniesAllCandidates($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$compid = $gridExtraFields['compid'];
		$module = $gridExtraFields['module'];
		$asFields = array("", "candcrtime", "cand_name", "title", "type");
		$ssFields = array("", "sdate", "cand_name", "title", "type");

		$oque1 = "SELECT 
		candidate_list.sno,
		".tzRetQueryStringDTime("reqresponse.rdate","Date","/")." sdate,
		CONCAT_WS(' ',candidate_list.fname, candidate_list.mname, candidate_list.lname) cand_name,
		candidate_list.profiletitle title,
		manage.name type,
		reqresponse.rdate AS candcrtime
		FROM 
		posdesc,reqresponse,candidate_list
		LEFT JOIN resume_status ON resume_status.res_id=candidate_list.sno
		LEFT JOIN manage ON resume_status.status=manage.sno
		WHERE
		posdesc.company = '".$compid."' 
		AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid)>0
		AND posdesc.posid=reqresponse.posid
		AND resume_status.req_id=reqresponse.posid
		AND resume_status.seqnumber=reqresponse.seqnumber
	    AND reqresponse.shift_id=resume_status.shift_id
		UNION ALL
		SELECT 
		candidate_list.sno,
		".tzRetQueryStringDTime("candidate_list.ctime","Date","/")." as sdate,
		CONCAT_WS(' ',candidate_list.fname,candidate_list.mname,candidate_list.lname) cand_name,
		candidate_list.profiletitle title,
		'Received' type,
		candidate_list.ctime AS candcrtime
		FROM
		candidate_list 
		WHERE 
		candidate_list.status='ACTIVE' 
		AND (candidate_list.owner = '".$username."' OR FIND_IN_SET( '".$username."', candidate_list.accessto ) >0 OR candidate_list.accessto = 'ALL') 
		AND candidate_list.supid IN (select sno from staffoppr_contact where csno='".$compid."' AND crmcontact='Y' AND status='ER')";

		$oque = "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
		$tque="SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		
		$gstr = '';

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$ssFields,'3');

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCRMCompaniesAllCandidates($oque,$module);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCRMCompaniesAllCandidates($que,$module)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[1] == '00/00/0000')
				$row[1] = '';

			$grid[$j][0] = '';
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = '';
			$grid[$j][6] = '../Candidates/review.php?cno='.$row[0].'&module='.$module;
			$j++;
		}

		return $grid;
	}

	function getRespondInquiries($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone, $sno;

		$gd = new gridData();

		$asFields = array("", tzRetQueryStringDTime("campaign_res.sdate","DateTime","/"), "campaign_res.email", "campaign_res.subject", "IF (users.username != '".$username."', users.name, 'Self')");
		$ssFields = array("","sdate","email","subject","uname");

		$tque="SELECT 
		COUNT(1) 
		FROM 
		campaign_list, campaign_res
		LEFT JOIN users ON campaign_res.username = users.username
		WHERE 
		campaign_res.sno=campaign_list.par_id 
		AND campaign_res.campaignsno='".$sno."'";

		$oque="SELECT 
		campaign_res.sno,
		".tzRetQueryStringDTime("campaign_res.sdate","DateTime","/")." sdate,
		campaign_res.email email,
		campaign_res.subject subject,
		IF (users.username != '".$username."', users.name, 'Self')	uname
		FROM 
		campaign_list, campaign_res
		LEFT JOIN users ON campaign_res.username = users.username
		WHERE 
		campaign_res.sno=campaign_list.par_id 
		AND campaign_res.campaignsno='".$sno."'";

		$gstr = '';

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildRespondInquiries($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildRespondInquiries($que)
	{
		global $maildb,$db, $frm,$sno,$addr,$type;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[1] == '00/00/0000')
                    $row[1] = '';
			$grid[$j][0] = '';
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = '';
			if($addr == '')
				$grid[$j][6] = 'viewrescampaign.php?addr='.$sno.'&frm='.$frm.'&sno='.$row[0];
			else
				$grid[$j][6] = '<a href=viewrescampaign.php?type='.$type.'&val='.$sno.'&addr='.$addr.'&frm='.$frm.'&sno='.$row[0].'><img src=\'/BSOS/images/icons/respond.gif\' alt=\'Response\' title=\'Response\' border=0></a>';

			$j++;
		}

		return $grid;
	}

	function getNewInquiries($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$Subject,$folder;

		$gd = new gridData();

		$asFields = array('', '',  'fromadd', 'subject',  tzRetQueryStringDTime("STR_TO_DATE( FROM_UNIXTIME( udate, '%Y-%m-%d %h:%i:%s' ) , '%Y-%m-%d %h:%i:%s' )","DateTime","/"));
		$ssFields = array('', 'emp', 'fromadd',  'subject',  'udate');

		$tque="SELECT 
		COUNT(1) 
		FROM 
		process_mail_headers
		WHERE 
		folder='".$folder."'
		AND subject like '%".$Subject."%'
		AND status='Active'";

		$oque="SELECT 
		messageid,
		''  emp,
		seen,
		fromadd,
		toadd,
		subject,
		date,
		".tzRetQueryStringDTime("STR_TO_DATE( FROM_UNIXTIME( udate, '%Y-%m-%d %h:%i:%s' ) , '%Y-%m-%d %h:%i:%s' )","DateTime","/")." as udate,
		mailid
		FROM 
		process_mail_headers
		WHERE 
		folder='".$folder."'
		AND subject like '%".$Subject."%'
		AND status='Active'";

		$gstr = '';

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly       
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildNewInquiries($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildNewInquiries($que)
	{
		global $maildb, $db, $folder;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$seen = "<i class='fa fa-envelope-o'></i>";
			if($row[2]=="U" || $row[1]=="N")
				$seen = "<i class='fa fa-envelope'></i>";

			$sender = $row[3];
			$arr = explode(",",$row[3]);
			$leftencode = explode("<",$arr[0]);
			if($leftencode[0] == "")
			{
				$rightencode = explode(">",$leftencode[1]);
				$fname = $rightencode[0];
			}
			else
			{
				$fname = $leftencode[0];
			}
			
			$subject = ($row[5] == '') ? 'No Subject' : $row[5];

			$grid[$j][0] = '<label class=\'container-chk\'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=\''.$row[8].'\'><label class=\'container-chk\'>';			
			$grid[$j][1] = $seen; 
			$grid[$j][2] = $this->convertSpecChars($fname);
			$grid[$j][3] = $this->convertSpecChars($subject);
			$grid[$j][4] = $this->convertSpecChars($row[7]);
			$grid[$j][5] = '';
			$grid[$j][6] = 'ReadMessageS.php?folder='.$folder.'&message='.$row[8];
			
			$j++;
		}

		return $grid;
	}

	function getShowCampaignList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$val;

		$gd	= new gridData();

		$asFields	= array("", "name", "email", "mailstatus");
		$ssFields	= array("", "name", "email", "mailstatus");

		$sel_cam_query	= "SELECT id FROM campaign_userinfo WHERE campaign_sno=".$val;
		$res_cam_query	= mysql_query($sel_cam_query, $db);

		if (mysql_num_rows($res_cam_query) <= 0) {

			$que	= "SELECT tolist FROM campaign_list WHERE sno='".$val."'";
			$res	= mysql_query($que,$db);
			$row	= mysql_fetch_row($res);

			$delelements		= array();
			$contelements_array	= array();
			$candelements_array	= array();
			$sendlist_array		= array();
			$addrbookelements_array=array();

			$sendlist_array	= explode(",",$row[0]);
			$mail_status	= "'NA' AS mailstatus";

			for($i=0;$i<count($sendlist_array);$i++)
			{
				if(substr($sendlist_array[$i],0,4) == 'oppr')
					array_push($contelements_array,substr($sendlist_array[$i],4));
				if(substr($sendlist_array[$i],0,4) == 'cand')
					array_push($candelements_array,substr($sendlist_array[$i],4));
				if(substr($sendlist_array[$i],0,2) == 'ab')
					array_push($addrbookelements_array,substr($sendlist_array[$i],2));
			}

			$contelements = implode(",",$contelements_array);
			$candelements = implode(",",$candelements_array);
			$addrbookelements=implode(",",$addrbookelements_array);

			if($contelements=="")
				$contelements=0;

			if($candelements=="")
				$candelements=0;

			if($addrbookelements=="")
				$addrbookelements=0;

			$oque1="SELECT staffoppr_contact.sno as sno,CONCAT_WS(' ',staffoppr_contact.fname,staffoppr_contact.mname,staffoppr_contact.lname) as name,staffoppr_contact.email as email,staffoppr_contact.status as status,'' as username,'oppr' as type, ".$mail_status."
			FROM staffoppr_contact WHERE staffoppr_contact.sno IN (".$contelements.")
			UNION ALL
			SELECT candidate_list.sno as sno,CONCAT_WS(' ',candidate_list.fname,candidate_list.mname,candidate_list.lname) as name,candidate_list.email as email,candidate_list.status,candidate_list.username as username,'cand' as type, ".$mail_status."
			FROM candidate_list 
			WHERE candidate_list.sno IN (".$candelements.")
			UNION ALL
			SELECT contacts.serial_no as sno,CONCAT_WS(' ',contacts.fname,contacts.mname,contacts.lname) as name,contacts.email as email,contacts.status as status,contacts.userid as username,'ab' as type, ".$mail_status."
			FROM contacts 
			WHERE contacts.serial_no IN (".$addrbookelements.")";

		} else {

			$oque1	= "SELECT 
						cu.recipient_sno AS sno, CONCAT_WS(' ', cu.first_name, cu.middle_name, cu.last_name) AS name,
						cu.email, IF(recipient_type = 'contact', sc.status, IF(recipient_type = 'candidate', cl.status, cs.status)) AS status, 
						IF(recipient_type = 'contact', '', IF(recipient_type = 'candidate', cl.username, cs.userid)) AS username, 
						IF(recipient_type = 'contact', 'oppr', IF(recipient_type = 'candidate', 'cand', 'ab')) AS type, 
						mail_status AS mailstatus
					FROM 
						campaign_userinfo cu
						LEFT JOIN staffoppr_contact sc ON (sc.sno = cu.recipient_sno)
						LEFT JOIN candidate_list cl ON (cl.sno = cu.recipient_sno)
						LEFT JOIN contacts cs ON (cs.serial_no = cu.recipient_sno)
					WHERE
						cu.campaign_sno=".$val;
		}

		$tque	= "SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		$oque	= "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
		$gstr	= '';

		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque	= $gd->buildTQuery($tque,$qstr,$gstr);
		$oque	= $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total		= $gd->getTotalRows($tque);
		$gridData	= $gd->buildShowCampaignList($oque);

		$objResponse	= new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildShowCampaignList($que)
	{
		global $maildb,$db;

		$j		= 0;
		$grid	= array();
		$res	= mysql_query($que,$db);

		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0]	= '';
			$grid[$j][1]	= $this->convertSpecChars($row[1]);
			$grid[$j][2]	= $this->convertSpecChars($row[2]);
			$mail_status	= trim($row[6]);

			if ($mail_status != 'NA') {

				if ($mail_status != 'inprogress')
				$mail_status	= ucfirst($mail_status);
				else
				$mail_status	= 'In Progress';
			}

			$grid[$j][3]	= $mail_status;
			$grid[$j][4]	= '';

			if($row[5]=="oppr")
			{
				if ($row[3] == "ER")
				$grid[$j][5]	= "/BSOS/Marketing/Lead_Mngmt/reviewContact.php?addr=".$row[0]."&contasno=".$row[0]."&sesvar=new";
				else
				$grid[$j][5]	= "/BSOS/Marketing/Lead_Mngmt/hisreviewmanage.php?addr=".$row[0]."&contasno=".$row[0];

			} elseif ($row[5]=="cand") {

				if ($row[3] == "ACTIVE")
				$grid[$j][5]	= "/BSOS/Marketing/Candidates/review.php?cno=".$row[0]."&dest=0&val_inc=yes";
				else
				$grid[$j][5]	= "/BSOS/Marketing/Candidates/hirevcon.php?type=cand&addr=".$row[4];

			} else {

				$grid[$j][5]	= "/BSOS/Collaboration/Contacts/viewaddrbookcontact.php?addr=".$row[0];
			}

			$j++;
		}

		return $grid;
	}


	function getCRMContactsAllJobOrders($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();
		$module = $gridExtraFields['module'];
		$conid = $gridExtraFields['conid'];

		$ssFields = array("", "CONCAT(posdesc.posid,'-',posdesc.postitle)", "IF(DATE_FORMAT(posstartdate,'%c/%e/%Y')='0/0/0000','',".tzRetQueryStringSelBoxDate("posdesc.posstartdate","Date","/").")", "manage.name", "IF(FIND_IN_SET('".$conid."',posdesc.contact)>0,'Received',IF(FIND_IN_SET('oppr".$conid."',job_post_det.sendlist)>0,'Broadcast',''))","".tzRetQueryStringDTime('posdesc.stime','DateTime','/')."");

		$asFields = array("", "CONCAT(posdesc.posid,'-',posdesc.postitle)", "posdesc.posstartdate", "manage.name", "IF(FIND_IN_SET('".$conid."',posdesc.contact)>0,'Received',IF(FIND_IN_SET('oppr".$conid."',job_post_det.sendlist)>0,'Broadcast',''))","posdesc.stime");

		$tque="SELECT COUNT(1) 
		FROM users,posdesc 
		LEFT JOIN job_post_det ON job_post_det.posid=posdesc.posid 
		LEFT JOIN manage ON posdesc.jostage=manage.sno 
		WHERE posdesc.owner=users.username 
		AND  posdesc.status in ('approve','Accepted') 
		AND (FIND_IN_SET('".$conid."',posdesc.accessto)>0 OR posdesc.owner='".$username."' OR posdesc.accessto='all' OR  posdesc.type='staffoppr') 
		AND (FIND_IN_SET('".$conid."',posdesc.contact)>0 OR FIND_IN_SET('oppr".$conid."',job_post_det.sendlist)>0)";

		$oque = "SELECT 
		posdesc.posid,
		CONCAT(posdesc.posid,'-',posdesc.postitle),
		IF(DATE_FORMAT(posdesc.posstartdate,'%c/%e/%Y')='0/0/0000','',".tzRetQueryStringSelBoxDate("posdesc.posstartdate","Date","/")."),
		manage.name,
		IF(FIND_IN_SET('".$conid."',posdesc.contact)>0,'Received',IF(FIND_IN_SET('oppr".$conid."',job_post_det.sendlist)>0,'Broadcast','')),
		".tzRetQueryStringDTime('posdesc.stime','DateTime','/')." AS cdate

		FROM users,posdesc 
		LEFT JOIN job_post_det ON job_post_det.posid=posdesc.posid 
		LEFT JOIN manage ON posdesc.jostage=manage.sno 
		WHERE posdesc.owner=users.username 
		AND  posdesc.status in ('approve','Accepted') 
		AND (FIND_IN_SET('".$conid."',posdesc.accessto)>0 OR posdesc.owner='".$username."' OR posdesc.accessto='all' OR  posdesc.type='staffoppr') 
		AND (FIND_IN_SET('".$conid."',posdesc.contact)>0 OR FIND_IN_SET('oppr".$conid."',job_post_det.sendlist)>0) ";

		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$ssFields,'3');

		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCRMContactsAllJobOrders($oque,$module);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCRMContactsAllJobOrders($que,$module)
	{
		global $maildb,$db;

		$j = 0;
		$grid = array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[2] == '00/00/0000')
                $row[2] = '';

			$grid[$j][0] = '';
			$grid[$j][1] =  $this->convertSpecChars($row[1]);
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = '';
			$grid[$j][7] = '/BSOS/Sales/Req_Mngmt/redirectjob.php?addr='.$row[0].'&module='.$module;
			$j++;
		}

		return $grid;
	}

	function getCRMContactsAllCandidates($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();
		$module = $gridExtraFields['module'];
		$conid = $gridExtraFields['conid'];

		$asFields = array("", "crdate", "cand_name", "title", "type");
		$ssFields = array("", "sdate", "cand_name", "title", "type");

		$oque1 = "SELECT 
		candidate_list.sno,
		".tzRetQueryStringDTime("reqresponse.rdate","Date","/")." sdate,
		CONCAT_WS(' ',candidate_list.fname,candidate_list.mname,candidate_list.lname) cand_name,
		candidate_list.profiletitle title,
		manage.name type,
		reqresponse.rdate AS crdate
		FROM reqresponse,posdesc,candidate_list 
		LEFT JOIN resume_status ON (resume_status.res_id=candidate_list.sno) 
		LEFT JOIN manage ON resume_status.status=manage.sno where posdesc.contact='".$conid."' 
		AND FIND_IN_SET(candidate_list.username,reqresponse.resumeid)>0 
		AND posdesc.posid=reqresponse.posid 
		AND resume_status.req_id=posdesc.posid 
		AND resume_status.seqnumber=reqresponse.seqnumber 
		UNION ALL 
		SELECT 
		candidate_list.sno,
		".tzRetQueryStringDTime("candidate_list.ctime","Date","/")." sdate,
		CONCAT_WS(' ', candidate_list.fname, candidate_list.mname, candidate_list.lname) cand_name, 
		candidate_list.profiletitle title,
		'Received' type,
		candidate_list.ctime AS crdate
		FROM candidate_list 
		WHERE candidate_list.status='ACTIVE' 
		AND (candidate_list.owner = '".$username."' OR FIND_IN_SET( '".$username."', candidate_list.accessto ) >0 OR candidate_list.accessto = 'ALL') 
		AND candidate_list.supid='".$conid."'";

		$oque = "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
		$tque="SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		
		$gstr = '';

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$ssFields,'3');

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCRMContactsAllCandidates($oque,$module);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

		return $objResponse;
	}

	function buildCRMContactsAllCandidates($que,$module)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[1] == '00/00/0000')
				$row[1] = '';

			$grid[$j][0] = '';
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = '';
			$grid[$j][6] = '../Candidates/review.php?cno='.$row[0].'&module='.$module;
			$j++;
		}

		return $grid;
	}

	function getCSSJobOrders($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$sqlSelfPref="select * from selfservice_pref  where username='$username'";
		$resSelfPref=mysql_query($sqlSelfPref,$db);
		$userPref=mysql_fetch_row($resSelfPref);  

		$asFields = $asFields = array("", "postitle", "posstatus", "postype", "openpos", "", "cdate", "mdate", "");
		$ssFields = $asFields = array("", "postitle", "posstatus", "postype", "openpos", "", "scdate", "smdate", "");

		if(strpos($userPref[2],"+2+"))	
		{
			$oque1="SELECT d.posid,d.postitle,(select name from manage where sno=d.posstatus) posstatus,(select name from manage where sno=d.postype) postype,if(d.no_of_pos - d.closepos <0,0,d.no_of_pos - d.closepos) openpos,".tzRetQueryStringDTime('d.stime','DateTime','/')." cdate,".tzRetQueryStringDTime('d.mdate','DateTime','/')." mdate, d.stime scdate, d.mdate smdate
			FROM staffacc_contact a, staffacc_contactacc b, staffoppr_contact c, posdesc d
			WHERE a.sno = b.con_id 
			AND a.sno = c.acc_cont 
			AND d.contact = c.sno
			AND b.username ='".$username."' 
			AND d.status in ('approve','Accepted') ";
		}
		else
		{
			$oque1="SELECT e.posid,e.postitle,(select name from manage where sno=e.posstatus) posstatus,(select name from manage where sno=e.postype) postype,if(e.no_of_pos - e.closepos <0,0,e.no_of_pos - e.closepos) openpos,".tzRetQueryStringDTime('e.stime','DateTime','/')." cdate,".tzRetQueryStringDTime('e.mdate','DateTime','/')." mdate, e.stime scdate, e.mdate smdate
			FROM staffacc_contact a, staffacc_contactacc b, staffacc_cinfo c, staffoppr_cinfo d, posdesc e
			WHERE b.username ='".$username."' 
			AND b.con_id = a.sno 
			AND a.username = c.username 
			AND c.sno = d.acc_comp
			AND d.sno = e.company 
			AND e.status in ('approve','Accepted') 
			AND c.type IN ('CUST', 'BOTH') ";
		}

		$tque="SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		$oque="SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";

		$gstr = '';

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCSSJobOrders($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildCSSJobOrders($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
        	$que1="select posid,count(posid) from reqresponse where posid = '".$row[0]."' and par_id='0' group by posid";
			$res1=mysql_query($que1,$db);
        	$row1=mysql_fetch_row($res1);
        	$rescount=$row1[1];

			$count = 0;			
			$sqlReq = "select resumeid from reqresponse where posid = ".$row[0]." and par_id= '0'";
			$rsReq = mysql_query($sqlReq,$db);
			while($rowReq = mysql_fetch_array($rsReq))
			{
				$conlist_array = explode(",",$rowReq['resumeid']);
				$count += count($conlist_array);
			}

			$grid[$j][0] = '';
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = "$count";
			$grid[$j][6] = $row[5];
			$grid[$j][7] = $row[6];

			if($rescount != '0' && $rescount != '')
				$grid[$j][8] = "<a href='javascript:link({$row[0]})'><img src=/BSOS/images/icons/up.gif alt='Submissions' border=0></a>";
			else
				$grid[$j][8] = "";
			$grid[$j][9] = "";
			$grid[$j][10] = $row[0];
			$j++;
		}

		return $grid;
	}

	function getCSSSubmissions($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$posid=$gridExtraFields['posid'];

		$asFields = $asFields = array("","posdesc.postitle",tzRetQueryStringDTime('reqresponse.rdate','DateTime','/'),"manage.name");
		$ssFields = $asFields = array("","posdesc.postitle",tzRetQueryStringDTime('reqresponse.rdate','DateTime','/'),"manage.name");

		$tque="select COUNT(1) FROM posdesc LEFT JOIN reqresponse ON reqresponse.posid=posdesc.posid LEFT JOIN manage ON manage.sno=reqresponse.stage AND manage.type='interviewstatus' WHERE reqresponse.posid=$posid AND reqresponse.par_id='0'";
		$oque="select reqresponse.sno,".tzRetQueryStringDTime('reqresponse.rdate','DateTime','/').",posdesc.postitle,reqresponse.seqnumber,reqresponse.par_id,posdesc.posid,manage.name FROM posdesc LEFT JOIN reqresponse ON reqresponse.posid=posdesc.posid LEFT JOIN manage ON manage.sno=reqresponse.stage AND manage.type='interviewstatus' WHERE reqresponse.posid=$posid AND reqresponse.par_id='0'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCSSSubmissions($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildCSSSubmissions($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "";
			$grid[$j][1] = $this->convertSpecChars($row[2]); 
			$grid[$j][2] = $this->convertSpecChars($row[1]);
			$grid[$j][3] = $this->convertSpecChars($row[6]);

			if($row[6]!="Placed")
				$grid[$j][4] = "subinfo.php?val=".$row[0];
			else
				$grid[$j][4] = "";
			$j++;
		}

		return $grid;
	}

	function getCSSAssignments($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
	
		$gd = new gridData();
	
		$ustatus				= stripslashes($gridExtraFields['ustatus']);
		$conJoin				= stripslashes($gridExtraFields['conJoin']);
		$asgnBillContactCond 	= stripslashes($gridExtraFields['asgnBillContactCon']);
		
		$asgnBillContactUnion	= "";
		if($asgnBillContactCond == "YES")
		{
			$query 	= "SELECT con_id FROM staffacc_contactacc WHERE username='$username'";
			$rs 	= mysql_query($query,$db);
			$row	= mysql_fetch_row($rs);
						
			$asgnBillContactUnion	= "UNION
						(
							SELECT 
								DISTINCT(hrcon_jobs.sno) AS hrcon_jobs_sno,
								TRIM(emp_list.name) AS emp_list_name,
								emp_list.sno  AS emp_list_sno,
								hrcon_jobs.project AS hrcon_jobs_project,
								hrcon_jobs.pusername AS hrcon_jobs_pusername,
								manage.name AS manage_name,
								hrcon_jobs.cdate AS hrcon_jobs_cdate,
								CONCAT(l.address1, ' ',l.address2, ' ',l.city, ' ',l.state) AS address,
								if(manage.name IN ('Direct','Internal Direct'),concat(hrcon_jobs.rate,'/',CASE hrcon_jobs.rateperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.rateperiod END),concat(hrcon_jobs.bamount,'/',CASE hrcon_jobs.bperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.bperiod END)) AS hrcon_jobs_bperiod,
								hrcon_jobs.placement_fee AS hrcon_jobs_placement_fee,
								hrcon_jobs.s_date AS hrcon_jobs_sdate,
								hrcon_jobs.exp_edate AS hrcon_jobs_exp_edate,
								hrcon_jobs.e_date AS hrcon_jobs_edate,
								hrcon_jobs.ustatus AS hrcon_jobs_ustatus
							FROM hrcon_jobs 
							LEFT JOIN emp_list ON hrcon_jobs.username=emp_list.username
							LEFT JOIN staffacc_contact ON staffacc_contact.acccontact='Y' and staffacc_contact.username!=''
							LEFT JOIN staffacc_contactacc ON staffacc_contactacc.con_id=staffacc_contact.sno 
							LEFT JOIN staffacc_cinfo ON hrcon_jobs.client=staffacc_cinfo.sno
							LEFT JOIN staffacc_location l ON hrcon_jobs.endclient=l.sno
							LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno AND manage.type='jotype'
							WHERE
								hrcon_jobs.ustatus='$ustatus' 
								AND emp_list.lstatus != 'DA' 
								AND emp_list.lstatus != 'INACTIVE' 
								AND staffacc_cinfo.type IN ('CUST', 'BOTH') 
								AND staffacc_cinfo.username=staffacc_contact.username 
								AND hrcon_jobs.bill_contact='$row[0]'
							GROUP BY hrcon_jobs.sno
						)";
		}
	
		$asFields 		= array("","TRIM(result.emp_list_name)","result.emp_list_sno","result.hrcon_jobs_project","result.hrcon_jobs_pusername","result.manage_name",tzRetQueryStringDTime("result.hrcon_jobs_cdate","DateTime","/"),"result.address","result.hrcon_jobs_bperiod","result.hrcon_jobs_placement_fee",tzRetQueryStringSTRTODate("result.hrcon_jobs_sdate","%m-%d-%Y","Date","-"),tzRetQueryStringDTime('result.hrcon_jobs_exp_edate','Date','-'),tzRetQueryStringSTRTODate("result.hrcon_jobs_edate","%m-%d-%Y","Date","-"));

		$ssFields 		= array("","TRIM(result.emp_list_name)","result.emp_list_sno","result.hrcon_jobs_project","result.hrcon_jobs_pusername","result.manage_name","result.hrcon_jobs_cdate","result.address","result.hrcon_jobs_bperiod","result.hrcon_jobs_placement_fee",tzRetQueryStringSTRTODate("result.hrcon_jobs_sdate","%m-%d-%Y","Date","-"),tzRetQueryStringDTime('result.hrcon_jobs_exp_edate','Date','-'),tzRetQueryStringSTRTODate("result.hrcon_jobs_edate","%m-%d-%Y","Date","-"));
	
		$tque	= "SELECT
				COUNT(1)
			FROM
			(
				
				(
					SELECT
						DISTINCT(hrcon_jobs.sno) AS hrcon_jobs_sno,
						TRIM(emp_list.name) AS emp_list_name,
						emp_list.sno AS emp_list_sno,
						hrcon_jobs.project AS hrcon_jobs_project,
						hrcon_jobs.pusername AS hrcon_jobs_pusername,
						manage.name AS manage_name,
						hrcon_jobs.cdate AS hrcon_jobs_cdate,
						CONCAT(l.address1, ' ',l.address2, ' ',l.city, ' ',l.state) AS address,
						if(manage.name IN ('Direct','Internal Direct'),concat(hrcon_jobs.rate,'/',CASE hrcon_jobs.rateperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.rateperiod END),concat(hrcon_jobs.bamount,'/',CASE hrcon_jobs.bperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.bperiod END)) AS hrcon_jobs_bperiod,
						hrcon_jobs.placement_fee AS hrcon_jobs_placement_fee,
						hrcon_jobs.s_date AS hrcon_jobs_sdate,
						hrcon_jobs.exp_edate AS hrcon_jobs_exp_edate,
						hrcon_jobs.e_date AS hrcon_jobs_edate,
						hrcon_jobs.ustatus AS hrcon_jobs_ustatus
					FROM hrcon_jobs 
					LEFT JOIN emp_list ON hrcon_jobs.username=emp_list.username
					LEFT JOIN staffacc_contact ON staffacc_contact.acccontact='Y' and staffacc_contact.username!=''
					LEFT JOIN staffacc_contactacc ON staffacc_contactacc.con_id=staffacc_contact.sno 
					LEFT JOIN staffacc_cinfo ON hrcon_jobs.client=staffacc_cinfo.sno
					LEFT JOIN staffacc_location l ON hrcon_jobs.endclient=l.sno
					LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno AND manage.type='jotype'
					WHERE hrcon_jobs.ustatus='$ustatus' 
					AND emp_list.lstatus != 'DA' 
					AND emp_list.lstatus != 'INACTIVE' 
					AND staffacc_cinfo.type IN ('CUST', 'BOTH') 
					AND staffacc_cinfo.username=staffacc_contact.username 
					AND $conJoin
					GROUP BY hrcon_jobs.sno
				)
				$asgnBillContactUnion
			) result WHERE 1=1";
	
		$oque	="SELECT
				result.hrcon_jobs_sno,
				result.emp_list_name,
				result.emp_list_sno,
				result.hrcon_jobs_project,
				result.hrcon_jobs_pusername,
				result.manage_name,
				".tzRetQueryStringDTime("result.hrcon_jobs_cdate","DateTime","/").",
				result.address,
				result.hrcon_jobs_bperiod,
				result.hrcon_jobs_placement_fee,
				".tzRetQueryStringSTRTODate("result.hrcon_jobs_sdate","%m-%d-%Y","Date","-").",
				".tzRetQueryStringDTime('result.hrcon_jobs_exp_edate','Date','-').",
				".tzRetQueryStringSTRTODate("result.hrcon_jobs_edate","%m-%d-%Y","Date","-").",
				result.hrcon_jobs_ustatus
			FROM
			(
				
				(
					SELECT 
						DISTINCT(hrcon_jobs.sno) AS hrcon_jobs_sno,
						TRIM(emp_list.name) AS emp_list_name,
						emp_list.sno AS emp_list_sno,
						hrcon_jobs.project AS hrcon_jobs_project,
						hrcon_jobs.pusername AS hrcon_jobs_pusername,
						manage.name AS manage_name,
						hrcon_jobs.cdate AS hrcon_jobs_cdate,
						CONCAT(l.address1, ' ',l.address2, ' ',l.city, ' ',l.state) AS address,
						if(manage.name IN ('Direct','Internal Direct'),concat(hrcon_jobs.rate,'/',CASE hrcon_jobs.rateperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.rateperiod END),concat(hrcon_jobs.bamount,'/',CASE hrcon_jobs.bperiod WHEN 'UOM_DAY' THEN 'DAY*' WHEN 'UOM_MILE' THEN 'MILE*' WHEN 'UOM_UNIT' THEN 'UNIT*' ELSE hrcon_jobs.bperiod END)) AS hrcon_jobs_bperiod,
						hrcon_jobs.placement_fee AS hrcon_jobs_placement_fee,
						hrcon_jobs.s_date AS hrcon_jobs_sdate,
						hrcon_jobs.exp_edate AS hrcon_jobs_exp_edate,
						hrcon_jobs.e_date AS hrcon_jobs_edate,
						hrcon_jobs.ustatus AS hrcon_jobs_ustatus
					FROM hrcon_jobs 
					LEFT JOIN emp_list ON hrcon_jobs.username=emp_list.username
					LEFT JOIN staffacc_contact ON staffacc_contact.acccontact='Y' and staffacc_contact.username!=''
					LEFT JOIN staffacc_contactacc ON staffacc_contactacc.con_id=staffacc_contact.sno 
					LEFT JOIN staffacc_cinfo ON hrcon_jobs.client=staffacc_cinfo.sno
					LEFT JOIN staffacc_location l ON hrcon_jobs.endclient=l.sno
					LEFT JOIN manage ON hrcon_jobs.jotype=manage.sno AND manage.type='jotype'
					WHERE hrcon_jobs.ustatus='$ustatus' 
					AND emp_list.lstatus != 'DA' 
					AND emp_list.lstatus != 'INACTIVE' 
					AND staffacc_cinfo.type IN ('CUST', 'BOTH') 
					AND staffacc_cinfo.username=staffacc_contact.username 
					AND $conJoin
					GROUP BY hrcon_jobs.sno
				)
				$asgnBillContactUnion
				
			) result WHERE 1=1 ";
		
		$gstr = " GROUP BY result.hrcon_jobs_sno ";
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildCSSAssignments($oque);
	
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
	
		return $objResponse;
	}
	
	function buildCSSAssignments($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);
			$grid[$j][9] = $this->convertSpecChars($row[9]);
			$grid[$j][10] = $this->convertSpecChars($row[10]);
			$grid[$j][11] = $this->convertSpecChars($row[11]);
			$grid[$j][12] = $this->convertSpecChars($row[12]);
			$grid[$j][13] = "";
			$grid[$j][14] = $row[0]."^".$row[13];

			$j++;
		}

		return $grid;
	}
	

	function getCSSTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();

		$condCk_comp 		= stripslashes($gridExtraFields['condCk_comp']);
		$condCk				= stripslashes($gridExtraFields['condCk']);
		$bill				= stripslashes($gridExtraFields['bill']);
		$tod				= stripslashes($gridExtraFields['tod']);
		$todaf				= stripslashes($gridExtraFields['todaf']);
		$conJoin			= stripslashes($gridExtraFields['conJoin']);
		$val				= stripslashes($gridExtraFields['val']);
		$condCk_comp_bill 	= stripslashes($gridExtraFields['condCk_comp_bill']);
		$tsBillContactCon 	= stripslashes($gridExtraFields['tsBillContactCon']);
		
		
		if(isset($val) && $val!="")
			$time_clause	= " AND par_timesheet.sdate>='".$tod."' AND par_timesheet.edate<='".$todaf."' ";
			
		$processed_ts_cond = "";
		$ts_rules_flag = getTimesheetRulesStatus();
		if($ts_rules_flag){
				$processed_ts_cond = "AND par_timesheet.rstatus = IF(par_timesheet.template='Regular','Applied','')";
		}
		
		$tsBillContactUnion = "";
		if ($tsBillContactCon =="YES")
		{
			$conJoinBill	  	= $gridExtraFields['conJoinBill'];
			$tsBillContactUnion	= "UNION
						(
							SELECT 
								par_timesheet.sno AS par_timesheet_sno, 
								par_timesheet.username AS par_timesheet_username,
								timesheet_hours.client AS timesheet_hours_client,
								TRIM(emp_list.name) AS emp_list_name, 
								emp_list.sno AS emp_list_sno,
								par_timesheet.sdate AS par_timesheet_sdate, 
								par_timesheet.edate AS par_timesheet_edate, 
								SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))) AS tot_hours,
								 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
								getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
								timesheet_hours.status AS timesheet_hours_status,
								MAX(par_timesheet.stime) AS ts_submitted_time,
								IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,timesheet_hours.sno AS ts_sno
							FROM
								timesheet_hours 
							LEFT JOIN
								par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
							LEFT JOIN
								hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoinBill 
							LEFT JOIN
								emp_list ON emp_list.username = par_timesheet.username 
							WHERE
								$condCk_comp_bill $bill
								timesheet_hours.status IN  ('ER','Rejected') 
								AND hrcon_jobs.pusername = timesheet_hours.assid 
								AND hrcon_jobs.ustatus in ('active','closed','cancel') 
								$time_clause
								$processed_ts_cond
							GROUP BY
								timesheet_hours.parid,
								timesheet_hours.client,
								timesheet_hours.status )";
		}

		$asFields = array("","result.emp_list_name","result.emp_list_sno",tzRetQueryStringDate('result.par_timesheet_sdate','Date','/'),tzRetQueryStringDate('result.par_timesheet_edate','Date', '/'),"result.tot_hours","result.ts_layout","result.getTimeStat",tzRetQueryStringDate('result.ts_submitted_time','Date', '/'));

		$ssFields = array("","result.emp_list_name","result.emp_list_sno","result.par_timesheet_sdate","result.par_timesheet_edate","result.tot_hours","result.ts_layout","result.getTimeStat","result.ts_submitted_time");
			
			

		$tque	= "SELECT
					result.par_timesheet_sno
				FROM
				(
					
					(
						SELECT 
							par_timesheet.sno AS par_timesheet_sno, 
							par_timesheet.username AS par_timesheet_username,
							timesheet_hours.client AS timesheet_hours_client,
							TRIM(emp_list.name) AS emp_list_name, 
							emp_list.sno AS emp_list_sno,
							par_timesheet.sdate AS par_timesheet_sdate, 
							par_timesheet.edate AS par_timesheet_edate, 
							SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))) AS tot_hours,
							 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
							getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
							timesheet_hours.status AS timesheet_hours_status,
							MAX(par_timesheet.stime) AS ts_submitted_time,
							IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,timesheet_hours.sno AS ts_sno
						FROM
							timesheet_hours 
						LEFT JOIN
							par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
						LEFT JOIN
							hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoin 
						LEFT JOIN
							emp_list ON emp_list.username = par_timesheet.username 
						WHERE
							$condCk_comp $condCk $bill
							timesheet_hours.status IN  ('ER','Rejected') 
							AND hrcon_jobs.pusername = timesheet_hours.assid 
							AND hrcon_jobs.ustatus in ('active','closed','cancel') 
							$time_clause
							$processed_ts_cond
						GROUP BY timesheet_hours.parid,timesheet_hours.status 
					)
					$tsBillContactUnion
					
				) result WHERE 1=1 ";

		$oque	="SELECT
				result.par_timesheet_sno,
				result.par_timesheet_username,
				result.timesheet_hours_client,
				result.emp_list_name,
				result.emp_list_sno,
				".tzRetQueryStringDate('result.par_timesheet_sdate','Date','/').",
				".tzRetQueryStringDate('result.par_timesheet_edate','Date','/').",
				ROUND(result.tot_hours,2),
				result.ts_layout,
				result.getTimeStat,
				result.timesheet_hours_status,
				".tzRetQueryStringDTime('result.ts_submitted_time','DateTime24Sec','/').",
				result.tab,
				result.ts_sno
			FROM
			(
				
				(
					SELECT 
						par_timesheet.sno AS par_timesheet_sno, 
						par_timesheet.username AS par_timesheet_username,
						timesheet_hours.client AS timesheet_hours_client,
						TRIM(emp_list.name) AS emp_list_name, 
						emp_list.sno AS emp_list_sno,
						par_timesheet.sdate AS par_timesheet_sdate, 
						par_timesheet.edate AS par_timesheet_edate, 
						SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))) AS tot_hours,
						 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
						getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
						timesheet_hours.status AS timesheet_hours_status,
						MAX(par_timesheet.stime) AS ts_submitted_time,
						IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,timesheet_hours.sno AS ts_sno
					FROM
						timesheet_hours 
					LEFT JOIN
						par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
					LEFT JOIN
						hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoin 
					LEFT JOIN
						emp_list ON emp_list.username = par_timesheet.username 
					WHERE
						$condCk_comp $condCk $bill
						timesheet_hours.status IN  ('ER','Rejected') 
						AND hrcon_jobs.pusername = timesheet_hours.assid 
						AND hrcon_jobs.ustatus in ('active','closed','cancel') 
						$time_clause
						$processed_ts_cond
					GROUP BY timesheet_hours.parid,timesheet_hours.status 
				)
				$tsBillContactUnion
				
			) result WHERE 1=1 ";

		$gstr = " GROUP BY result.par_timesheet_sno,result.timesheet_hours_client,result.timesheet_hours_status ";

		$lstr		= $gd->buildLimt($gridPage,$gridRecords);
		$qstr		= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr		= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque		= $gd->buildTQuery($tque,$qstr,$gstr);
		$oque		= $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total		= $gd->getTotalCount($tque);
		$gridData	= $gd->buildCSSTimeSheets($oque);

		$objResponse 	= new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	function buildCSSTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] Onclick=chk_clearTop_TimeSheet() value='".$row[0]."|".$row[1]."|".$row[2]."|".$row[10]."|".$row[8]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[3]); 
			$grid[$j][2] = $this->convertSpecChars($row[4]);
			$grid[$j][3] = $this->convertSpecChars($row[5]);
			$grid[$j][4] = $this->convertSpecChars($row[6]);
			$grid[$j][5] = $this->convertSpecChars($row[7]);
			if($row[8] == 'Clock In & Out'){
				$grid[$j][6]=$row[8];
			}
			else{
				$grid[$j][6] = $this->convertSpecChars($row[8])."(".$this->convertSpecChars($row[12]).")";
			}
			$grid[$j][7] = $this->convertSpecChars($row[9]);
			$grid[$j][8] = $this->convertSpecChars($row[11]);
			$grid[$j][9] = "";
			$grid[$j][10] = $row[0]."|".$row[1]."|".$row[2]."|".$row[10]."|".$row[8];
			$grid[$j][11] = $row[13];
			$j++;
		}

		return $grid;
	}
	
	function getCSSADTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
	
		$gd 		= new gridData();
	
		$condCk_comp 		= stripslashes($gridExtraFields['condCk_comp']);
		$condCk				= stripslashes($gridExtraFields['condCk']);
		$bill				= stripslashes($gridExtraFields['bill']);
		$tod				= stripslashes($gridExtraFields['tod']);
		$todaf				= stripslashes($gridExtraFields['todaf']);
		$conJoin			= stripslashes($gridExtraFields['conJoin']);
		$val				= stripslashes($gridExtraFields['val']);
		$tStatus			= stripslashes($gridExtraFields['tStatus']);		
		$condCk_comp_bill 	= stripslashes($gridExtraFields['condCk_comp_bill']);
		$tsBillContactCon 	= stripslashes($gridExtraFields['tsBillContactCon']);
		
		if(isset($val) && $val!="")
			$time_clause	= " AND par_timesheet.sdate>='".$tod."' AND par_timesheet.edate<='".$todaf."' ";
			
		if($tStatus == "Deleted")
		{
			$tstat	= " timesheet_hours.status = 'Deleted' ";
		}
		else
		{
			$tstat	= " timesheet_hours.status IN ('Approved','Billed') ";
		}
		
		$tsBillContactUnion = "";
		if ($tsBillContactCon =="YES")
		{
			$conJoinBill	  	= $gridExtraFields['conJoinBill'];
			$tsBillContactUnion	= "UNION
						(
							SELECT 
								par_timesheet.sno AS par_timesheet_sno, 
								par_timesheet.username AS par_timesheet_username,
								timesheet_hours.client AS timesheet_hours_client,
								TRIM(emp_list.name) AS emp_list_name, 
								emp_list.sno AS emp_list_sno,
								par_timesheet.sdate AS par_timesheet_sdate, 
								par_timesheet.edate AS par_timesheet_edate, 
								SUM(timesheet_hours.hours) AS tot_hours,
								 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
								getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
								timesheet_hours.status AS timesheet_hours_status,
								IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab
							FROM
								timesheet_hours 
							LEFT JOIN
								par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
							LEFT JOIN
								hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoinBill 
							LEFT JOIN
								emp_list ON emp_list.username = par_timesheet.username 
							WHERE
								$condCk_comp_bill $bill
								$tstat
								AND hrcon_jobs.pusername = timesheet_hours.assid 
								AND hrcon_jobs.ustatus in ('active','closed','cancel') 
								$time_clause
								GROUP BY
								timesheet_hours.parid,
								timesheet_hours.client,
								timesheet_hours.status )";
		}
	
		$asFields 	= array("","result.emp_list_name","result.emp_list_sno",tzRetQueryStringDate('result.par_timesheet_sdate','Date','/'),tzRetQueryStringDate('result.par_timesheet_edate','Date', '/'),"result.tot_hours","result.ts_layout","result.getTimeStat");
	
		$ssFields 	= array("","result.emp_list_name","result.emp_list_sno","result.par_timesheet_sdate","result.par_timesheet_edate","result.tot_hours","result.ts_layout","result.getTimeStat");
		
	
		$tque	= "SELECT
					result.par_timesheet_sno
				FROM
				(
					
					(
						SELECT 
							par_timesheet.sno AS par_timesheet_sno, 
							par_timesheet.username AS par_timesheet_username,
							timesheet_hours.client AS timesheet_hours_client,
							TRIM(emp_list.name) AS emp_list_name, 
							emp_list.sno AS emp_list_sno,
							par_timesheet.sdate AS par_timesheet_sdate, 
							par_timesheet.edate AS par_timesheet_edate, 
							SUM(timesheet_hours.hours) AS tot_hours,
							CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
							getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
							timesheet_hours.status AS timesheet_hours_status,
							IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab
						FROM
							timesheet_hours 
						LEFT JOIN
							par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
						LEFT JOIN
							hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoin 
						LEFT JOIN
							emp_list ON emp_list.username = par_timesheet.username 
						WHERE
							$condCk_comp $condCk $bill
							$tstat
							AND hrcon_jobs.pusername = timesheet_hours.assid 
							AND hrcon_jobs.ustatus in ('active','closed','cancel') 
							$time_clause
						GROUP BY timesheet_hours.parid,timesheet_hours.status 
					)
					$tsBillContactUnion
					
				) result WHERE 1=1 ";
	
		$oque	="SELECT
				result.par_timesheet_sno,
				result.par_timesheet_username,
				result.timesheet_hours_client,
				result.emp_list_name,
				result.emp_list_sno,
				".tzRetQueryStringDate('result.par_timesheet_sdate','Date','/').",
				".tzRetQueryStringDate('result.par_timesheet_edate','Date', '/').",
				ROUND(result.tot_hours,2),
				result.ts_layout,
				result.getTimeStat,
				result.timesheet_hours_status,
				result.tab
			FROM
			(
				
				(
					SELECT 
						par_timesheet.sno AS par_timesheet_sno, 
						par_timesheet.username AS par_timesheet_username,
						timesheet_hours.client AS timesheet_hours_client,
						TRIM(emp_list.name) AS emp_list_name, 
						emp_list.sno AS emp_list_sno,
						par_timesheet.sdate AS par_timesheet_sdate, 
						par_timesheet.edate AS par_timesheet_edate, 
						SUM(timesheet_hours.hours) AS tot_hours,
						 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
						getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
						timesheet_hours.status AS timesheet_hours_status,
						IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab
					FROM
						timesheet_hours 
					LEFT JOIN
						par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
					LEFT JOIN
						hrcon_jobs ON par_timesheet.username = hrcon_jobs.username $conJoin 
					LEFT JOIN
						emp_list ON emp_list.username = par_timesheet.username 
					WHERE
						$condCk_comp $condCk $bill
						$tstat
						AND hrcon_jobs.pusername = timesheet_hours.assid 
						AND hrcon_jobs.ustatus in ('active','closed','cancel') 
						$time_clause
					GROUP BY timesheet_hours.parid,timesheet_hours.status 
				)
				$tsBillContactUnion
				
			) result WHERE 1=1 ";
	
		$gstr = " GROUP BY result.par_timesheet_sno,result.timesheet_hours_client,result.timesheet_hours_status ";
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildCSSADTimeSheets($oque);
	
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
	
		return $objResponse;
	}

	function buildCSSADTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] Onclick=chk_clearTop_TimeSheet() value='".$row[0]."|".$row[1]."|".$row[2]."|".$row[10]."|".$row[8]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[3]); 
			$grid[$j][2] = $this->convertSpecChars($row[4]);
			$grid[$j][3] = $this->convertSpecChars($row[5]);
			$grid[$j][4] = $this->convertSpecChars($row[6]);
			$grid[$j][5] = $this->convertSpecChars($row[7]);
			if($row[8] == 'Clock In & Out'){
				$grid[$j][6]=$row[8];
			}
			else{
				$grid[$j][6] = $this->convertSpecChars($row[8])."(".$this->convertSpecChars($row[11]).")";
			}
			
			$grid[$j][7] = $this->convertSpecChars($row[9]);
			$grid[$j][8] = "";
			$grid[$j][9] = $row[0]."|".$row[1]."|".$row[2]."|".$row[10]."|".$row[8];

			$j++;
		}

		return $grid;
	}

	function getCSSExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();
		$decimalPref    = getDecimalPreference();
		
		$condCk_comp 			= stripslashes($gridExtraFields['condCk_comp']);
		$condCk					= stripslashes($gridExtraFields['condCk']);
		$bill					= stripslashes($gridExtraFields['bill']);
		$tod					= stripslashes($gridExtraFields['tod']);
		$todaf					= stripslashes($gridExtraFields['todaf']);
		$conJoin				= stripslashes($gridExtraFields['conJoin']);
		$val					= stripslashes($gridExtraFields['val']);
		$condCk_comp_bill 		= stripslashes($gridExtraFields['condCk_comp_bill']);
		$expnBillContactCon 	= stripslashes($gridExtraFields['expnBillContactCon']);
		
		if(isset($val) && $val!="")
			$time_clause=" AND par_expense.sdate>='".$tod."' AND par_expense.edate<='".$todaf."' ";
			
		$dateString 	= "";
		if($gridExtraFields['servicedate'] != "")
		{
			$fromArr	= explode("/",$gridExtraFields['servicedate']);
			$fromDate	= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
			$sDate		= date("Y-m-d",$fromDate);
			$dateString 	.= " AND par_expense.sdate >='".$sDate."'";
		}
		if($gridExtraFields['servicedateto']!="")
		{
			$toArr		= explode("/",$gridExtraFields['servicedateto']);
			$toDate		= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
			$todaf		= date("Y-m-d",$toDate);
			$dateString 	.= " AND par_expense.edate <='".$todaf."'";
		}
		

		$asFields = array("","TRIM(result.emp_list_name)","result.emp_list_sno",tzRetQueryStringDate('result.par_expense_sdate','Date','/'),tzRetQueryStringDate('result.par_expense_sdate','Date', '/'),"result.expn_total","result.expn_balance","result.expn_status");

		$ssFields = array("","TRIM(result.emp_list_name)","result.emp_list_sno","result.par_expense_sdate","result.par_expense_edate","result.expn_total","result.expn_balance","result.expn_status");
		
		$expnBillContactUnion = "";
		if ($expnBillContactCon =="YES")
		{
			$conJoinBill	  	= $gridExtraFields['conJoinBill'];
			$expnBillContactUnion	= "UNION
						(
							SELECT 
								par_expense.sno AS par_expense_sno, 
								par_expense.username AS par_expense_username,
								expense.client AS expense_client,
								expense.status AS expense_status,
								emp_list.name AS emp_list_name,
								emp_list.sno AS emp_list_sno,
								MIN(par_expense.sdate) AS par_expense_sdate,
								MAX(par_expense.edate) AS par_expense_edate,
								round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
								(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
								getCSSUserExpStat(expense.status,par_expense.pstatus) AS expn_status,
								expense.parid AS expense_parid
							FROM
								expense 
							LEFT JOIN
								par_expense ON expense.parid = par_expense.sno 
							LEFT JOIN
								hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoinBill 
							LEFT JOIN
								emp_list ON emp_list.username = par_expense.username 
							WHERE
								$condCk_comp_bill $bill 
								par_expense.astatus IN ('ER','Rejected') 
								AND expense.status IN  ('ER','Rejected') 
								AND hrcon_jobs.pusername = expense.assid 
								AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
								$dateString
							GROUP BY
								expense.parid,
								expense.client,
								expense.status 
						)";
		}


		$tque	= "SELECT
				result.par_expense_sno
			FROM
			(
				
				(SELECT 
					par_expense.sno AS par_expense_sno, 
					par_expense.username AS par_expense_username,
					expense.client AS expense_client,
					expense.status AS expense_status,
					emp_list.name AS emp_list_name,
					emp_list.sno AS emp_list_sno,
					MIN(par_expense.sdate) AS par_expense_sdate,
					MAX(par_expense.edate) AS par_expense_edate,
					round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
					(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
					getCSSUserExpStat(expense.status,par_expense.pstatus) AS expn_status,
					expense.parid AS expense_parid
				FROM
					expense 
				LEFT JOIN
					par_expense ON expense.parid = par_expense.sno 
				LEFT JOIN
					hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoin 
				LEFT JOIN
					emp_list ON emp_list.username = par_expense.username 
				WHERE
					$condCk_comp $condCk $bill 
					par_expense.astatus IN ('ER','Rejected') 
					AND expense.status IN  ('ER','Rejected') 
					AND hrcon_jobs.pusername = expense.assid 
					AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
					$dateString
				GROUP BY
					expense.parid,
					expense.status)
				$expnBillContactUnion
			) result WHERE 1=1 ";

		$oque	= "SELECT
				result.par_expense_sno,
				result.par_expense_username,
				result.expense_client,
				result.expense_status,
				result.emp_list_name,
				result.emp_list_sno,
				".tzRetQueryStringDate('result.par_expense_sdate','Date','/').",
				".tzRetQueryStringDate('result.par_expense_edate','Date', '/').",
				result.expn_total,
				result.expn_balance,
				result.expn_status
			FROM
			(
				
				(SELECT 
					par_expense.sno AS par_expense_sno, 
					par_expense.username AS par_expense_username,
					expense.client AS expense_client,
					expense.status AS expense_status,
					emp_list.name AS emp_list_name,
					emp_list.sno AS emp_list_sno,
					MIN(par_expense.sdate) AS par_expense_sdate,
					par_expense.edate AS par_expense_edate,
					round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
					(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
					getCSSUserExpStat(expense.status,par_expense.pstatus) AS expn_status,
					expense.parid AS expense_parid
				FROM
					expense 
				LEFT JOIN
					par_expense ON expense.parid = par_expense.sno 
				LEFT JOIN
					hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoin 
				LEFT JOIN
					emp_list ON emp_list.username = par_expense.username 
				WHERE
					$condCk_comp $condCk $bill 
					par_expense.astatus IN ('ER','Rejected') 
					AND expense.status IN  ('ER','Rejected') 
					AND hrcon_jobs.pusername = expense.assid 
					AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
					$dateString
				GROUP BY
					expense.parid,
					expense.status)
				$expnBillContactUnion
			) result WHERE 1=1 ";

		
	
		$gstr = " GROUP BY result.expense_parid,result.expense_client,result.expense_status ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildCSSExpenses($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildCSSExpenses($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		
		$decimalPref    = getDecimalPreference();
		
		
		

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] Onclick=chk_clearTop_TimeSheet() value=".$row[0]."|".$row[1]."|".$row[2]."|".$row[3]."><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[4]); 
			$grid[$j][2] = $this->convertSpecChars($row[5]);
			$grid[$j][3] = $this->convertSpecChars($row[6]);
			$grid[$j][4] = $this->convertSpecChars($row[7]);
			//$grid[$j][5] = $this->convertSpecChars($row[8]);
			$grid[$j][5] = $this->convertSpecChars(number_format($row[8],$decimalPref));
			$grid[$j][6] = $this->convertSpecChars($row[9]);
			$grid[$j][7] = $this->convertSpecChars($row[10]);
			$grid[$j][8] = "";
			$grid[$j][9] = $row[0]."|".$row[1]."|".$row[2]."|".$row[3];

			$j++;
		}

		return $grid;
	}

	function getCSSADExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;

		$gd = new gridData();
        $decimalPref    	= getDecimalPreference();
		$condCk_comp 		= stripslashes($gridExtraFields['condCk_comp']);
		$condCk				= stripslashes($gridExtraFields['condCk']);
		$bill				= stripslashes($gridExtraFields['bill']);
		$tod				= stripslashes($gridExtraFields['tod']);
		$todaf				= stripslashes($gridExtraFields['todaf']);
		$conJoin			= stripslashes($gridExtraFields['conJoin']);
		$val				= stripslashes($gridExtraFields['val']);
		$eStatus			= stripslashes($gridExtraFields['eStatus']);
		$condCk_comp_bill 	= stripslashes($gridExtraFields['condCk_comp_bill']);
		$expnBillContactCon = stripslashes($gridExtraFields['expnBillContactCon']);

		$asFields = array("","TRIM(result.emp_list_name)","result.emp_list_sno","result.par_expense_sdate","result.par_expense_edate","result.expn_total","result.expn_balance","result.expn_status");
		$ssFields = array("","TRIM(result.emp_list_name)","result.emp_list_sno","result.par_expense_sdate","result.par_expense_edate","result.expn_total","result.expn_balance","result.expn_status");

		if(isset($val) && $val!="")
			$time_clause=" AND par_expense.sdate>='".$tod."' AND par_expense.edate<='".$todaf."' ";

		if($eStatus == "Deleted")
		{
			$pstat=" par_expense.astatus = 'Deleted' ";
			$tstat=" AND expense.status = 'Deleted' ";
		}
		else
		{
			$pstat=" par_expense.astatus IN ('ER', 'Approved', 'Billed') ";
			$tstat=" AND expense.status IN ('Approved', 'Billed') ";
		}
		
		$expnBillContactUnion = "";
		if ($expnBillContactCon =="YES")
		{
			$conJoinBill	  	= $gridExtraFields['conJoinBill'];
			$expnBillContactUnion	= "UNION
						(
							SELECT 
								par_expense.sno AS par_expense_sno, 
								par_expense.username AS par_expense_username,
								expense.client AS expense_client,
								expense.status AS expense_status,
								emp_list.name AS emp_list_name,
								emp_list.sno AS emp_list_sno,
								".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/')." AS par_expense_sdate,
								".tzRetQueryStringDate('MAX(par_expense.edate)','Date', '/')." AS par_expense_edate,
								round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
								(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
								getCSSUserExpStat(par_expense.pstatus,expense.status) AS expn_status,
								expense.parid AS expense_parid
							FROM
								expense 
							LEFT JOIN
								par_expense ON expense.parid = par_expense.sno 
							LEFT JOIN
								hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoinBill 
							LEFT JOIN
								emp_list ON emp_list.username = par_expense.username 
							WHERE
								$condCk_comp_bill $bill 
								$pstat
								$tstat
								AND hrcon_jobs.pusername = expense.assid 
								AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
							GROUP BY
								expense.parid,
								expense.client,
								expense.status 
						)";
		}
	
		$tque	= "SELECT
				result.par_expense_sno
			FROM
			(
				
				(SELECT 
					par_expense.sno AS par_expense_sno, 
					par_expense.username AS par_expense_username,
					expense.client AS expense_client,
					expense.status AS expense_status,
					emp_list.name AS emp_list_name,
					emp_list.sno AS emp_list_sno,
					".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/')." AS par_expense_sdate,
					".tzRetQueryStringDate('MAX(par_expense.edate)','Date', '/')." AS par_expense_edate,
					round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
					(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
					getCSSUserExpStat(par_expense.pstatus,expense.status) AS expn_status,
					expense.parid AS expense_parid
				FROM
					expense 
				LEFT JOIN
					par_expense ON expense.parid = par_expense.sno 
				LEFT JOIN
					hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoin 
				LEFT JOIN
					emp_list ON emp_list.username = par_expense.username 
				WHERE
					$condCk_comp $condCk $bill 
					$pstat
					$tstat
					AND hrcon_jobs.pusername = expense.assid 
					AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
				GROUP BY
					expense.parid,
					expense.status)
				$expnBillContactUnion
			) result WHERE 1=1 ";


		$oque	= "SELECT
				result.par_expense_sno,
				result.par_expense_username,
				result.expense_client,
				result.expense_status,
				result.emp_list_name,
				result.emp_list_sno,
				result.par_expense_sdate,
				result.par_expense_edate,
				result.expn_total,
				result.expn_balance,
				result.expn_status
			FROM
			(
				
				(SELECT 
					par_expense.sno AS par_expense_sno, 
					par_expense.username AS par_expense_username,
					expense.client AS expense_client,
					expense.status AS expense_status,
					emp_list.name AS emp_list_name,
					emp_list.sno AS emp_list_sno,
					".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/')." AS par_expense_sdate,
					".tzRetQueryStringDate('MAX(par_expense.edate)','Date', '/')." AS par_expense_edate,
					round(sum(expense.quantity * expense.billrate), ".$decimalPref.") AS expn_total,
					(round((sum(expense.quantity * expense.billrate)), ".$decimalPref.")) AS expn_balance,
					getCSSUserExpStat(par_expense.pstatus,expense.status) AS expn_status,
					expense.parid AS expense_parid
				FROM
					expense 
				LEFT JOIN
					par_expense ON expense.parid = par_expense.sno 
				LEFT JOIN
					hrcon_jobs ON par_expense.username = hrcon_jobs.username $conJoin 
				LEFT JOIN
					emp_list ON emp_list.username = par_expense.username 
				WHERE
					$condCk_comp $condCk $bill 
					$pstat
					$tstat
					AND hrcon_jobs.pusername = expense.assid 
					AND hrcon_jobs.ustatus in ('active', 'closed','cancel')
				GROUP BY
					expense.parid,
					expense.status)
				$expnBillContactUnion
			) result WHERE 1=1 ";

		$gstr = " GROUP BY result.par_expense_sno,result.expense_client ";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildCSSADExpenses($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$eStatus,$oque);

		return $objResponse;
	}

	function buildCSSADExpenses($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$decimalPref    = getDecimalPreference();
		

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] Onclick=chk_clearTop_TimeSheet() value=".$row[0]."|".$row[1]."|".$row[2]."|".$row[3]."><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[4]); 
			$grid[$j][2] = $this->convertSpecChars($row[5]);
			$grid[$j][3] = $this->convertSpecChars($row[6]);
			$grid[$j][4] = $this->convertSpecChars($row[7]);
			$grid[$j][5] = $this->convertSpecChars($row[8]);
			//$grid[$j][6] = $this->convertSpecChars(number_format($row[9],$decimalPref));
			$grid[$j][6] = $this->convertSpecChars($row[9]);
			$grid[$j][7] = $this->convertSpecChars($row[10]);
			$grid[$j][8] = "";
			$grid[$j][9] = $row[0]."|".$row[1]."|".$row[2]."|".$row[3];

			$j++;
		}

		return $grid;
	}
	
	function getDevTotalRows($que)
	{
		global $maildb,$db;
		return mysql_num_rows(mysql_query($que, $db));
	}
	
	////////////////////////// UDF RELATED FUNCTIONS ///////////////////////////////
	function getCustomFields($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$invlocation,$invdept,$invclient,$invservicedate,$invservicedateto;
		
		if($gridSortCol=="")
			$gridSortCol=2;
		
		$gd=new gridData();
		
		$asFields = array("","t1.element_name", "element_desc", "module_desc", "t1.required", "t1.status", "IF(t1.element='textarea','De-active',IF((t1.sphinx_indexing='0' and t1.status='Active'),'Pending',IF((t1.sphinx_indexing='1' and t1.status='Active'),'Indexed','De-active')))", "IF(t1.sphinx_searchable='1','Yes','No')",  "t2.name", "DATE_FORMAT(CONVERT_TZ(t1.cdate,'SYSTEM','EST5EDT'),'%m/%d/%Y')", "t2.name", "DATE_FORMAT(CONVERT_TZ(t1.mdate,'SYSTEM','EST5EDT'),'%m/%d/%Y')");
		
		$ssFields = array("","element_name", "element_desc", "module_desc", "t1.required", "t1.status", "indexing", "searchable", "t2.name",  "t1.cdate", "t2.name", "t1.mdate");
		
		//$tque = "SELECT COUNT(1) from custom_form_details";
		
		$tque ="select count(1) FROM udf_form_details t1 LEFT JOIN users t2 ON t1.cuser = t2.username LEFT JOIN udf_form_modules t4 ON t1.module = t4.module_id INNER JOIN udf_form_elements t5 ON t5.element_name = t1.element WHERE 1 =1";

		$oque ="SELECT t1.id, t1.element_name, element_desc, module_desc modules, t1.required, t1.status, t2.name, ".tzRetQueryStringDTime('t1.cdate','Date','/')." as createddate, t2.name, ".tzRetQueryStringDTime('t1.mdate','Date','/')." as modifieddate,IF(t1.element='textarea','De-active',IF((t1.sphinx_indexing='0' and t1.status='Active'),'Pending',IF((t1.sphinx_indexing='1' and t1.status='Active'),'Indexed','De-active'))) as indexing,IF(t1.sphinx_searchable='1','Yes','No') as searchable,t4.module_id as moduleid 
			FROM udf_form_details t1 LEFT JOIN users t2 ON t1.cuser = t2.username 
			LEFT JOIN udf_form_modules t4 ON t1.module = t4.module_id INNER JOIN udf_form_elements t5 ON t5.element_name = t1.element WHERE 1 =1";
		
		//$grp_str = " group by t1.id";
		$grp_str = " group by t1.id";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		
		$qstr = $gd->buildUDFQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count = "$oque $qstr $qstr $ostr";
		$total = $gd->getTotalCount($oque_Count);
				
		$oque = "$oque $qstr $grp_str $ostr $lstr";		
		
		$gridData = $gd->buildCustomFields($oque);
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total, $tque, $oque);
		return $objResponse;
	}
	
	
	
	function buildCustomFields($que)
	{
		global $maildb,$db;
		$grid=array();
		$j=0;
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><input type='hidden' name='modules[]' id='modules[]' value='".$row[12]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=stripslashes(urldecode($row[1]));
			$grid[$j][2]=$row[2];
			$grid[$j][3]=$row[3];
			$grid[$j][4]=$row[4];
			$grid[$j][5]=$row[5];
			$grid[$j][6]=$row[10];
			$grid[$j][7]=$row[11];
			$grid[$j][8]=$row[6];
			$grid[$j][9]=$row[7];
			$grid[$j][10]=$row[8];
			$grid[$j][11]=$row[9];
			$grid[$j][12]='';
			$grid[$j][13]="../../../../include/custom/addformfield.php?val=".$row[0];
			$j++;
		}
		return $grid;
	}
	////////////////////////// END OF UDF RELATED FUNCTIONS ///////////////////////////////
	
	
	
	///////////// MANAGE SKILLS RELATED FUNCTIONS CODE /////////////////
	
	function getManageSkills($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username;

		$gd=new gridData();
		// Always we have to use the actual column names in asFields array. We should not use Column Aliases as they do not work with WHERE clause. The 0th column must be empty if it been used for checxbox in grids.
		$asFields = array("", "ms.skill_name", "ma.name", "dept.deptname","maa.name", "ms.status", "users.name", tzRetQueryStringDate('ms.cdate','Date','/'), "musers.name", tzRetQueryStringDate('ms.mdate','Date','/'));

		// 0th column shoud be empty if it is been used for checkbox. We can use either actual column of table or alias as ORDER BY works with both
		$ssFields = array("", "ms.skill_name", "category", "Departments","Specialities", "Status", "users.name", "ms.cdate", "musers.name", "ms.mdate");

		if ($gridSearchFields[4] == 'ACTIVE') {

			$status_and_clause	= " AND ms.status='ACTIVE' ";
			$gridSearchFields[4] = "";

		} elseif ($gridSearchFields[4] == 'INACTIVE') {

			$status_and_clause	= " AND ms.status='INACTIVE' ";
			$gridSearchFields[4] = "";
		}	
		$oque = "SELECT ms.sno AS 'SkillID', ms.skill_name AS 'SkillName', 		
		GROUP_CONCAT(DISTINCT(ma.name) ORDER BY ma.name ASC) AS 'category',
		GROUP_CONCAT(DISTINCT(dept.deptname) ORDER BY dept.deptname ASC) as Departments,
		GROUP_CONCAT(DISTINCT(maa.name) ORDER BY maa.name ASC) as Specialities,
		 ms.status, users.name AS 'Created By', ".tzRetQueryStringDate('ms.cdate','Date','/')."
		 AS 'Created Date', musers.name AS 'Modified By', 
		".tzRetQueryStringDate('ms.mdate','Date','/')." AS 'Modified Date' 
		FROM manage_skills ms 
		LEFT JOIN manage_skills_relation msr ON ms.sno = msr.manage_skills_sno 
		LEFT JOIN manage ma ON ma.sno = msr.manage_sno AND ma.type = 'jobskillcat'
		LEFT JOIN manage maa ON maa.sno = msr.speciality_sno AND maa.type = 'jobskillspeciality' 
		LEFT JOIN department dept ON dept.sno = msr.department_sno 
		LEFT JOIN users users ON ms.cuser = users.username 
		LEFT JOIN users musers ON ms.muser = musers.username 
		WHERE 1=1 {$status_and_clause}"; 

		$grp_str = " GROUP BY ms.sno"; // We have to specify the default group by here 

		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,"4"); // If no group concat in query fields then 4th element is not required. If any then we need to pass those column ids by subtracting with 1 and concatnated by | symbol. In this function Category and Departments are group_concatnated. Grid coulmn ids for them are 3 and 4
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); 
		
		// This query will give us the total number of records, for that we will remove the limit string.
		$totalrows_query = "$oque $qstr $grp_str $ostr"; 
		
		// This function will give us the total number of records.
		$total_rows = $gd->getDevTotalRows($totalrows_query); 
		
		$oque = "$oque $qstr $grp_str $ostr $lstr";	
		
		$gridData = $gd->buildManageSkills($oque);		
		
		$objResponse = new xajaxResponse();	
		
		// This is for production. This won't display the queries in front end
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total_rows); 
		
		// For DEBUGING. Will display both the queries in browser for DEBUGGING
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total_rows,$totalrows_query,$oque); 

		return $objResponse;
	}
	
	function buildManageSkills($que)
	{
		global $maildb,$db;
		$grid=array();
		$j=0;
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			//$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			$grid[$j][10]="";
			$grid[$j][11] = "skill_new.php?skillid=".$this->convertSpecChars($row[0]); //Opens Edit on double click 
			$j++;
		}
	    return $grid;
	}
	
	///////////// END MANAGE SKILLS RELATED FUNCTIONS CODE //////////////
	
	///////////// MANAGE VIEWS RELATED FUNCTIONS CODE /////////////////
	
	function getManageViews($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username;

		$gd=new gridData();

		// Always we have to use the actual column names in asFields array. We should not use Column Aliases as they do not work with WHERE clause. The 0th column must be empty if it been used for checxbox in grids.
		$asFields = array("", "cg.grid_name", "users.name", "cg.cdate", "musers.name", "cg.mdate");

		// 0th column shoud be empty if it is been used for checkbox. We can use either actual column of table or alias as ORDER BY works with both
		$ssFields = array("", "cg.grid_name", "users.name", "cg.cdate", "musers.name", "cg.mdate");
				
		$oque = "SELECT cg.id, cg.grid_name, users.name as 'Created By', DATE_FORMAT(cg.cdate, '%m/%e/%Y') as 'Created Date', musers.name as 'Modified By',DATE_FORMAT(cg.mdate, '%m/%e/%Y') as 'Modified Date'
		FROM `custom_grids` cg
		LEFT JOIN users users ON cg.cuser = users.username 
		LEFT JOIN users musers ON cg.muser = musers.username  
		WHERE 1=1"; 

		$grp_str = ""; // We have to specify the default group by here 

		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTRCommon($gridSearchType,$gridSearchFields,$asFields,""); 
				
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); 
		
		// This query will give us the total number of records, for that we will remove the limit string.
		$totalrows_query = "$oque $qstr $grp_str $ostr"; 
		
		// This function will give us the total number of records.
		$total_rows = $gd->getDevTotalRows($totalrows_query); 
		
		$oque = "$oque $qstr $grp_str $ostr $lstr";	
		
		$gridData = $gd->buildManageViews($oque);		
		
		$objResponse = new xajaxResponse();	
		
		// This is for production. This won't display the queries in front end
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total_rows); 
		
		// For DEBUGING. Will display both the queries in browser for DEBUGGING
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total_rows,$totalrows_query,$oque); 

		return $objResponse;
	}
	
	function buildManageViews($que)
	{
		global $maildb,$db;
		$grid=array();
		$j=0;
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			//$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]="";
			$grid[$j][7] = "custom_grid_columns.php?viewid=".$this->convertSpecChars($row[0]); //Opens Edit on double click 
			$j++;
		}
	    return $grid;
	}
	
	///////////// END MANAGE VEIWS RELATED FUNCTIONS CODE //////////////

	///////////// MANAGE JOBTITLES RELATED FUNCTIONS CODE /////////////////

	function getManageJobOrderTitles($gridSortCol, $gridSort, $gridPage, $gridRecords, $gridSearchType, $gridSearchFields, $gridExtraFields) {

		global $db, $username;

		$gd	= new gridData();

		// Always we have to use the actual column names in asFields array. We should not use Column Aliases as they do not work with WHERE clause. The 0th column must be empty if it been used for checxbox in grids.
		$asFields	= array('', 'jotitle', 'jotypes', 'departments', 'cuser', tzRetQueryStringDate('cdate','Date','/'), 'muser', tzRetQueryStringDate('mdate','Date','/'));

		// 0th column shoud be empty if it is been used for checkbox. We can use either actual column of table or alias as ORDER BY works with both
		$ssFields	= array('', 'jotitle', 'jotypes', 'departments', 'cuser', 'cdate', 'muser', 'mdate');

		if ($gridExtraFields['status'] == 'ACTIVE') {

			$status_and_clause	= "  mj.status='ACTIVE' ";

		} elseif ($gridExtraFields['status'] == 'INACTIVE') {

			$status_and_clause	= "  mj.status='INACTIVE' ";
		}


		$oque	= "SELECT joid,jotitle,cuser,cdate,muser,mdate,status,jotypes,departments FROM (SELECT mj.sno AS 'joid',
					mj.jobtitle AS 'jotitle',
					cu.name AS 'cuser',
					mj.cdate AS 'cdate',
					mu.name AS 'muser',
					mj.mdate AS 'mdate',
					mj.status AS 'status',
					(SELECT GROUP_CONCAT(DISTINCT(m.name)) FROM manage_jobtitles_relation mjr LEFT JOIN manage m ON mjr.manage_sno=m.sno WHERE m.type='jotype' AND manage_jobtitles_sno=mj.sno) AS 'jotypes',
					(SELECT GROUP_CONCAT(DISTINCT(d.deptname)) FROM manage_jobtitles_relation mjr LEFT JOIN department d ON mjr.department_sno=d.sno WHERE manage_jobtitles_sno=mj.sno) as 'departments'
					FROM manage_jobtitles mj
					LEFT JOIN users cu ON mj.cuser = cu.username
					LEFT JOIN users mu ON mj.muser = mu.username
					WHERE $status_and_clause) as jolist
					WHERE 1=1 ";
		

		$grp_str	= " "; // We have to specify the default group by here

		$lstr	= $gd->buildLimt($gridPage, $gridRecords);
		$qstr	= $gd->buildQSTRCommon($gridSearchType, $gridSearchFields, $asFields, (count($asFields)+1));
		$ostr	= $gd->buildOSTR($gridSortCol, $gridSort, $ssFields);

		// This query will give us the total number of records, for that we will remove the limit string.
		$totalrows_query = "$oque $qstr $grp_str $ostr";

		// This function will give us the total number of records.
		$total_rows = $gd->getDevTotalRows($totalrows_query);

		$oque = "$oque $qstr $grp_str $ostr $lstr";

		$gridData = $gd->buildManageJobOrderTitles($oque);

		$objResponse = new xajaxResponse();

		// This is for production. This won't display the queries in front end
		$objResponse->addScriptCall('updateGrid', $objResponse->phpToJS($gridData), $total_rows);

		// For DEBUGING. Will display both the queries in browser for DEBUGGING
		//$objResponse->addScriptCall('updateGridPrint', $objResponse->phpToJS($gridData), $total_rows, $totalrows_query, $oque);

		return $objResponse;
	}

	function buildManageJobOrderTitles($que) {

		global $db;

		$j	= 0;
		$grid	= array();
		$res	= mysql_query($que, $db);

		while ($row=mysql_fetch_array($res)) {

			$grid[$j][0]	= "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=selectCheckBox(); value='".$row[0]."'><span class='checkmark'></span></label>"; // sno
			$grid[$j][1]	= $this->convertSpecChars($row[1]); // jobtitle
			$grid[$j][2]	= $this->convertSpecChars($row[7]); // jobtype
			$grid[$j][3]	= $this->convertSpecChars($row[8]); // departments
			$grid[$j][4]	= $this->convertSpecChars($row[2]); // created by
			$grid[$j][5]	= $this->convertSpecChars($row[3]); // created date
			$grid[$j][6]	= $this->convertSpecChars($row[4]); // modified by
			$grid[$j][7]	= $this->convertSpecChars($row[5]); // modi date
			$grid[$j][8]	= "";

			//Opens Edit on double click
			if ($row[6] == 'ACTIVE') {

				$grid[$j][9]	= "joborder_titles_new.php?action_type=edit&jobtitleid=".$this->convertSpecChars($row[0]);

			} elseif ($row[6] == 'INACTIVE') {

				$grid[$j][9]	= "view_jobtitle.php?action_type=view&jobtitleid=".$this->convertSpecChars($row[0]);
			}

			$j++;
		}

		return $grid;
	}

	///////////// END MANAGE JOBTITLES RELATED FUNCTIONS CODE //////////////

	function getOnBoard($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$posid=$gridExtraFields['posid'];

		$asFields = array("","hg.name","ob.userid","uc.name",tzRetQueryStringDate('ob.cdate','Date','/'),"um.name",tzRetQueryStringDate('ob.mdate','Date','/'));
		$ssFields = array("","hg.name","ob.userid","uc.name","ob.cdate","um.name","ob.mdate");

		$tque="SELECT COUNT(1) FROM obUsers ob LEFT JOIN users hg ON hg.username=ob.username LEFT JOIN users uc ON uc.username=ob.cuser LEFT JOIN users um ON um.username=ob.muser WHERE ob.status='A'";
		$oque="SELECT ob.sno, hg.name, ob.userid, uc.name, ".tzRetQueryStringDate('ob.cdate','Date','/').", um.name, ".tzRetQueryStringDate('ob.mdate','Date','/')." FROM obUsers ob LEFT JOIN users hg ON hg.username=ob.username LEFT JOIN users uc ON uc.username=ob.cuser LEFT JOIN users um ON um.username=ob.muser WHERE ob.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildOnBoard($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildOnBoard($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = "editob.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}
	
	//Function added for Accounts Credits Register on 04/11/2014 - Kumar Raju K.
	function getCustomerCreditsRegister($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;		
		$cond = '';
		
		if($gridSortCol == "") {
			$gridSortCol = 3; //Default Sorting should be by date column
		}
					
		$gd = new gridData();
		
		if($gridExtraFields['datedue'] != "") { //Client,fromdate, indate fields are coming as extra fields to the grid.
			$datedue = $gridExtraFields['datedue'];
		}

		if($gridExtraFields['datein'] != "") {
			$datein = $gridExtraFields['datein'];		
		}

		if($gridExtraFields['client'] != '' && $gridExtraFields['client'] != 'none') { //Search by client if client is not empty.
			$cond = " AND sacc.username = '".$gridExtraFields['client']."'";
		}

		$asFields = array("","inv.invoice_number","CONCAT(sacc.sno,'-',sacc.cname)",tzRetQueryStringDTime('inv.stime','Date','/'),"DATE_FORMAT(CONVERT_TZ(cmt.credit_adate, 'SYSTEM', 'EST5EDT'), '%m/%d/%Y')","tmp.paymethod","CONCAT_WS('','CR',credit_id)","total_credit_amount","usedamt","Consumption");
       
		$ssFields = array("","inv.invoice_number","CONCAT(sacc.sno,'-',sacc.cname)",tzRetQueryStringDTime('inv.stime','Date','/'),"DATE_FORMAT(CONVERT_TZ(cmt.credit_adate, 'SYSTEM', 'EST5EDT'), '%m/%d/%Y')","tmp.paymethod","cm.credit_id","total_credit_amount","tmp.usedamt","Consumption");

		//For Total Records Count
		$tque = "SELECT COUNT(1)
		FROM credit_memo_trans cmt 
		LEFT JOIN credit_memo cm ON (cm.credit_id = cmt.credit_memo_sno) 
		LEFT JOIN invoice inv ON (inv.sno = cmt.inv_bill_sno) 
		LEFT JOIN staffacc_cinfo sacc ON (sacc.sno = cm.credit_source)
		WHERE inv.deliver = 'yes' 
		AND inv.status = 'ACTIVE'  
		AND inv.total > 0 
		AND DATE(inv.stime) >= '".$datein."' 
		AND DATE(inv.stime) <= '".$datedue."' $cond ";
	
		
		$oque = "SELECT 
					tmp.cmtsno,
					tmp.invstime,
					tmp.customername,
					tmp.usedamt,
					tmp.invoice_number,
					tmp.stime,
					tmp.paymethod,
					tmp.crdid,
					tmp.total_credit_amount,
					tmp.credit_bal_amts,
					tmp.Consumption,
					@lastSN as chk_val,
					if( @lastSN = tmp.crdid,@c := @c-tmp.usedamt,@c := tmp.total_credit_amount-tmp.usedamt) as 'consumption_amt',
					@lastSN := tmp.crdid as lastcrdid,
					@lastValue := @c as balance,
					tmp.applieddate


					FROM 
					(SELECT cmt.sno as cmtsno,
						   DATE_FORMAT(inv.stime, '%m/%d/%Y') as invstime,
						   CONCAT(sacc.sno, '-', sacc.cname) as customername,
						   IF(cmt.used_amount = '', 0, cmt.used_amount) as usedamt,
						   inv.invoice_number,
						   inv.stime,
						   'Credit' AS 'paymethod',cm.credit_id as crdid,s.credit_balance+cm.credit_amount as total_credit_amount,(s.credit_balance+cm.credit_amount)-cmt.used_amount as credit_bal_amts
						  , if( @lastSN = cm.credit_id, @c := @c-(IF(cmt.used_amount = '', 0, cmt.used_amount)),@c := (s.credit_balance+cm.credit_amount)-cmt.used_amount ) as Consumption,".tzRetQueryStringDTime('cmt.credit_adate','Date','/')."
                  AS applieddate
						FROM credit_memo_trans cmt
						   LEFT JOIN credit_memo cm ON (cm.credit_id = cmt.credit_memo_sno)
						   LEFT JOIN invoice inv ON (inv.sno = cmt.inv_bill_sno)
						   LEFT JOIN staffacc_cinfo sacc ON (sacc.sno = cm.credit_source)
						   LEFT JOIN (
					  SELECT credit_memo_sno,sum(cmt1.used_amount) AS credit_balance
					  FROM credit_memo_trans cmt1
					  GROUP BY cmt1.credit_memo_sno
					) s ON (cmt.credit_memo_sno = s.credit_memo_sno)
					 WHERE     inv.deliver = 'yes'
						   AND inv.status = 'ACTIVE'
						   AND DATE(inv.stime) >= '".$datein."'
						   AND DATE(inv.stime) <= '".$datedue."' $cond ";
		

		$grpque = "";        
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		//For the number od records count
		$tque = $gd->buildTQuery($tque,$qstr,'');		
		$total = $gd->getTotalRows($tque);
		
		//$oque = "$oque $grpque $qstr $ostr $lstr";	
        $oque = "$oque $grpque $qstr
					ORDER BY inv.invoice_number DESC,cm.credit_id ASC) as tmp
					CROSS JOIN
					( select @lastSN := 0,@lastValue := 0, @c := 0  ) SQLVars $lstr";		
		
		$gridData=$gd->buildCustomerCreditsRegister($oque);
		
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	
	function buildCustomerCreditsRegister($que)
	{
		global $maildb,$db;
		$j = 0;
		$grid = array();
		$res = mysql_query($que,$db);		
		while ($row = mysql_fetch_array($res)) {

			$grid[$j][0]="";
			$grid[$j][1]=$this->convertSpecChars($row[4]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);// Customer Name
			$grid[$j][3]=$this->convertSpecChars($row[1]); // Date
			$grid[$j][4]=$this->convertSpecChars($row[15]);
			$grid[$j][5]=$this->convertSpecChars($row[paymethod]); // Payment Method
			$grid[$j][6]=$this->convertSpecChars('CR'.$row[7]);
			$grid[$j][7]=$this->convertSpecChars(number_format($row[8], 2,'.', ''));
			$grid[$j][8]=$this->convertSpecChars(number_format($row[3], 2,'.', '')); // Amount
			$grid[$j][9]=$this->convertSpecChars(number_format($row[14], 2,'.', ''));
			$grid[$j][10]="";
			$j++;
		}
		return $grid;
	}

	///////////// TALENT POOL APPLICANTS RELATED FUNCTIONS CODE /////////////////

	function getTalentPoolApplicants($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		$gd	= new gridData();

		/* SEARCH ARRAY - Always we have to use the actual column names in asFields array. We should not use 
		* Column Aliases as they do not work with WHERE clause. The 0th column must be empty if it been 
		* used for checxbox in grids.
		*/
		$asFields	= array("", "trim(tpl.fname)", "trim(tpl.lname)", "trim(tpl.email)", "trim(tpl.phone)", "trim(cts.country)", "trim(tpl.state)", "trim(tpl.zip)", "trim(tpl.job_alerts)", "IF(tpl.A2M = 'Y', 'CRM', 'Pipeline')", "IF(tpl.jobboards_optin_email = 'Y', 'Yes', 'No')", tzRetQueryStringDTime('tpl.stime','Date','/'), tzRetQueryStringDTime('tpl.mtime','Date','/'), "");

		/* ORDERING ARRAY - 0th column shoud be empty if it is been used for checkbox. We can use either 
		* actual column of table or alias as ORDER BY works with both
		*/
		$ssFields	= array("", "trim(tpl.fname)", "trim(tpl.lname)", "trim(tpl.email)", "trim(tpl.phone)", "trim(cts.country)", "trim(tpl.state)", "trim(tpl.zip)", "trim(tpl.job_alerts)", "IF(tpl.A2M = 'Y', 'CRM', 'Pipeline')", "IF(tpl.jobboards_optin_email = 'Y', 'Yes', 'No')", "tpl.stime", "tpl.mtime", "");

		$and_clause	= '';

		if ($gridSearchFields[8] != "") {

			$stg_flag	= ($gridSearchFields[8] == 'crm') ? 'Y' : 'N';

			$and_clause	.= " AND tpl.A2M = '$stg_flag' ";

			$gridSearchFields[8]	= "";
		}

		if ($gridSearchFields[9] != "") {

			$sub_flag	= trim(strtolower($gridSearchFields[9]));
			$sub_flag	= ($sub_flag == 'yes') ? 'Y' : 'N';

			$and_clause	.= " AND tpl.jobboards_optin_email = '$sub_flag' ";

			$gridSearchFields[9]	= "";
		}

		$tque	= "SELECT 
						COUNT(1) 
					FROM 
						talentpool_list tpl 
						LEFT JOIN talentpool_resumes tpr ON tpl.id = tpr.talentpool_id
						LEFT JOIN countries cts ON tpl.country = cts.sno
						WHERE 1=1 $and_clause ";

		$oque	= "SELECT
						tpl.id, tpl.fname, tpl.lname, tpl.email, tpl.phone, cts.country, tpl.state, tpl.zip,
						tpl.job_alerts, IF(tpl.A2M='Y', 'CRM', 'Pipeline') AS A2M,
						IF(tpl.jobboards_optin_email='Y', 'Yes', 'No') AS subscription,
						".tzRetQueryStringDTime('tpl.stime','Date','/')." as stime,".tzRetQueryStringDTime('tpl.mtime','Date','/')." as mtime, tpr.id
					FROM
						talentpool_list tpl
						LEFT JOIN talentpool_resumes tpr ON tpl.id = tpr.talentpool_id
						LEFT JOIN countries cts ON tpl.country = cts.sno
						WHERE 1=1 $and_clause ";

		// We have to specify the default group by here
		$gstr	= " GROUP BY tpl.id";
		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('trim(tpl.phone)',$asFields)){
			$asFieldsKey = array_search("trim(tpl.phone)", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("trim(tpl.phone)",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("trim(tpl.phone)",$gridSearchFields,$asFieldsKey);
		}
		$lstr	= $gd->buildLimt($gridPage, $gridRecords);
		$qstr	= $gd->buildQSTR($gridSearchType, $gridSearchFields, $asFields);
		$ostr	= $gd->buildOSTR($gridSortCol, $gridSort, $ssFields);

		$tque	= $gd->buildTQuery($tque, $qstr, $gstr);
		$oque	= $gd->buildOQuery($oque, $qstr, $ostr, $lstr, $gstr);

		// This function will give us the total number of records.
		$total_rows	= $gd->getDevTotalRows($tque);
		$gridData	= $gd->buildTalentPoolApplicants($oque);

		$objResponse	= new xajaxResponse();
		$objResponse->addScriptCall("updateGrid", $objResponse->phpToJS($gridData), $total_rows);

		// For DEBUGING. Will display both the queries in browser for DEBUGGING
		//$objResponse->addScriptCall("updateGridPrint", $objResponse->phpToJS($gridData), $total_rows, $tque, $oque);

		return $objResponse;
	}

	function buildTalentPoolApplicants($que)
	{
		global $db;

		$j	= 0;

		$grid	= array();
		$gd		= new gridData();
		$res	= mysql_query($que,$db);

		while($row = mysql_fetch_array($res))
		{
			$grid_cols	= 0;

			$grid[$j][$grid_cols++]	= "<label class='container-chk'><input type=checkbox name=auids[] onClick=clearCheckBox() value=".$row[0]."><span class='checkmark'></span></label>";
			$grid[$j][$grid_cols++]	= $this->convertSpecChars($row[1]);
			$grid[$j][$grid_cols++]	= $this->convertSpecChars($row[2]);
			$grid[$j][$grid_cols++]	= $row[3];
			$grid[$j][$grid_cols++]	= $row[4];
			$grid[$j][$grid_cols++]	= $row[5];
			$grid[$j][$grid_cols++]	= $row[6];
			$grid[$j][$grid_cols++]	= $row[7];
			$grid[$j][$grid_cols++]	= $this->convertSpecChars($row[8]);
			$grid[$j][$grid_cols++]	= $row[9];
			$grid[$j][$grid_cols++]	= $row[10];
			$grid[$j][$grid_cols++]	= $row[11];
			$grid[$j][$grid_cols++]	= $row[12];

			$resume_link	= "";

			if ($row[13] != 0) {

				$resume_link	= "
				<a href=getresume.php?id=".$row[13]." target='_top'>
					<img src=/BSOS/images/icons/download.gif title='View&nbsp;Resume' border=0>
				</a>";
			}

			$grid[$j][$grid_cols++]	= $resume_link;
			$grid[$j][$grid_cols++]	= $row[0];
			$j++;
		}

		return $grid;
	}

	function getVInterview($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","hg.name","vi.userid","uc.name",tzRetQueryStringDate('vi.cdate','Date','/'),"um.name",tzRetQueryStringDate('vi.mdate','Date','/'));
		$ssFields = array("","hg.name","vi.userid","uc.name","vi.cdate","um.name","vi.mdate");

		$tque="SELECT COUNT(1) FROM viUsers vi LEFT JOIN users hg ON hg.username=vi.username LEFT JOIN users uc ON uc.username=vi.cuser LEFT JOIN users um ON um.username=vi.muser WHERE vi.status='A'";
		$oque="SELECT vi.sno, hg.name, vi.userid, uc.name, ".tzRetQueryStringDate('vi.cdate','Date','/').", um.name, ".tzRetQueryStringDate('vi.mdate','Date','/')." FROM viUsers vi LEFT JOIN users hg ON hg.username=vi.username LEFT JOIN users uc ON uc.username=vi.cuser LEFT JOIN users um ON um.username=vi.muser WHERE vi.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildVInterview($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildVInterview($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = "editvi.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}

	function getWebsites($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		if(AOB_ENABLED == 'Y'){
		    // When AOB is enabled
			$asFields = array("","w.title","w.domain","fg.group_name","uc.name", tzRetQueryStringDate('w.cdate','Date','/'),"um.name",tzRetQueryStringDate('w.mdate','Date','/'));
			$ssFields = array("","w.title","w.domain","fg.group_name","uc.name","w.cdate","um.name","w.mdate");
		}
		else{
		   // When AOB is disabled
		   $asFields = array("","w.title","w.domain","uc.name",tzRetQueryStringDate('w.cdate','Date','/'),"um.name",tzRetQueryStringDate('w.mdate','Date','/'));
		   $ssFields = array("","w.title","w.domain","uc.name","w.cdate","um.name","w.mdate");
		}

		$tque="SELECT COUNT(1) FROM seo_websites w LEFT JOIN users uc ON uc.username=w.cuser LEFT JOIN users um ON um.username=w.muser LEFT JOIN apt_forms_groups fg ON w.apt_group_id = fg.sno WHERE w.status='A'";
		$oque="SELECT w.sno, w.title, w.domain, fg.group_name, uc.name, ".tzRetQueryStringDate('w.cdate','Date','/').", um.name, ".tzRetQueryStringDate('w.mdate','Date','/')." FROM seo_websites w LEFT JOIN users uc ON uc.username=w.cuser LEFT JOIN users um ON um.username=w.muser LEFT JOIN apt_forms_groups fg ON w.apt_group_id = fg.sno WHERE w.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildWebsites($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildWebsites($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			
			if(AOB_ENABLED == 'Y'){
			    // When AOB is enabled
				$grid[$j][3] = $this->convertSpecChars($row[3]);
				$grid[$j][4] = $this->convertSpecChars($row[4]);
				$grid[$j][5] = $this->convertSpecChars($row[5]);
				$grid[$j][6] = $this->convertSpecChars($row[6]);
				$grid[$j][7] = $this->convertSpecChars($row[7]);
				$grid[$j][8] = "editweb.php?addr=".$row[0];
			}else{
			    // When AOB is disabled
				$grid[$j][3] = $this->convertSpecChars($row[4]);
				$grid[$j][4] = $this->convertSpecChars($row[5]);
				$grid[$j][5] = $this->convertSpecChars($row[6]);
				$grid[$j][6] = $this->convertSpecChars($row[7]);
				$grid[$j][7] = "editweb.php?addr=".$row[0];
			}
			$j++;
		}

		return $grid;
	}

	function getManVInterview($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$posid=$gridExtraFields['posid'];

		$asFields = array("","vi.name","vi.email","vi.itype","vi.status","vi.cstatus","vi.dline","vi.iwith",tzRetQueryStringDate('vi.cdate','Date','/'),"vi.slink");
		$ssFields = array("","vi.name","vi.email","vi.itype","vi.status","vi.cstatus","vi.dline","vi.iwith","vi.cdate","vi.slink");

		$tque="SELECT COUNT(1) FROM viInterviews vi WHERE vi.posid='$posid'";
		$oque="SELECT vi.iuuid, vi.name, vi.email, vi.itype, vi.status, vi.cstatus, vi.dline, vi.iwith, ".tzRetQueryStringDate('vi.cdate','Date','/').", vi.slink, vi.posid, vi.juuid FROM viInterviews vi WHERE vi.posid='$posid'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildManVInterview($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildManVInterview($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label><input type=hidden name=vistatus[] value='".strtolower($row[4])."'>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);

			if($row[9]!="")
				$grid[$j][9] = "<a href='".stripslashes($row[9])."' target=_blank><font class=linkrow>".stripslashes($row[9])."</font></a>";
			else
				$grid[$j][9] = "";
			
			$grid[$j][10] = "videtails.php?posid=".$row[10]."&iuuid=".$row[0];
			$j++;
		}

		return $grid;
	}
	
	
	// Function to get the list of burden types.
	function getBurdenTypes($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		$asFields = array("", "bt.burden_type_name", "bt.billable_status", "bt.bt_status", "bt.calc_burden_on", "IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',cu.name)", tzRetQueryStringDTime('bt.cdate','DateTime','/'), "IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',mu.name)", tzRetQueryStringDTime('bt.mdate','DateTime','/'));
				
		$ssFields = array("", "bt.burden_type_name", "bt.billable_status", "bt.bt_status", "bt.calc_burden_on", "IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',cu.name)", "bt.cdate", "IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',mu.name)", "bt.mdate");
	
                $whereCond = '';
                
		if($gridSearchFields[2] != "") 
		{
                    $stg_flag	= ($gridSearchFields[2] == 'Active') ? 'Active' : 'De-active';
                    $whereCond	.= " bt.bt_status = '".$stg_flag."' ";
		}
                else
                {
                    $whereCond .= " bt.bt_status IN ('Active','De-active') ";
                }
		$tque="SELECT count(1) 
		FROM burden_types bt	
		LEFT JOIN users cu ON cu.username = bt.cuser
		LEFT JOIN users mu ON mu.username = bt.muser
		WHERE ".$whereCond;
	
		$oque="SELECT bt.sno, 
				bt.burden_type_name,
				bt.ratetype,
				bt.bt_status,
				IF(bt.calc_burden_on='Other','Selected Rates','Regular Rate') AS calcBurdenOn,
				IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',cu.name) AS createduser,
				".tzRetQueryStringDTime('bt.cdate','DateTime','/')." AS cdate,
				IF(bt.burden_type_name = 'Zero Pay Burden' OR bt.burden_type_name = 'Zero Bill Burden','System',mu.name) AS modifiedUser,
				".tzRetQueryStringDTime('bt.mdate','DateTime','/')." AS mdate,
				bt.assigned,
				bt.billable_status 
			FROM burden_types bt
			LEFT JOIN users cu ON cu.username = bt.cuser
			LEFT JOIN users mu ON mu.username = bt.muser		
			WHERE ".$whereCond;

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		//$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildBurdenTypes($oque);
		$total = count($gridData);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;		
	}
	// Function to build the list of burden types.
	function buildBurdenTypes($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			if($row[3] == 'De-active')
			{
				$row[3] = 'Inactive';
			}
			$chboxValues = $row[0];			
			if($chboxValues == 1 || $row[9] == 'yes' || $row[1] == 'Zero Bill Burden')
			{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids_disabled[] OnClick=chk_clearTop() value='".$chboxValues."' disabled ><span class='checkmark'></span></label>"; 
			}
			else
			{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>"; 
			}
			$grid[$j][1]=$this->convertSpecChars($row[1]); 
			$grid[$j][2]=$this->convertSpecChars($row[10]); 
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]="";
			if($chboxValues == 1 || $row[1] == 'Zero Bill Burden')
			{
				$grid[$j][10] = "disabled";
			}
			else
			{			
				$grid[$j][10] = "burdenitemslist.php?mode=mbi&btsno=".$row[0];
			}			
			$j++;
		}
		return $grid;
	}
	
	// Function to get the list of burden Items.
	function getBurdenItems($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		
		$whereCond = " bi.bi_status = 'Active' and bi.burden_item_name NOT IN ('Zero Pay Burden', 'Zero Bill Burden') ";
	
		$asFields = array("", "bi.burden_item_name", "bi.burden_value", "bi.burden_mode", "bi.ratetype", "bi.max_earned_amnt", "bi.billable_status", "bt.sno", "cu.name", tzRetQueryStringDTime('bi.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('bi.mdate','DateTime','/'));
				
		$ssFields = array("", "bi.burden_item_name", "bi.burden_value", "bi.burden_mode", "bi.ratetype", "bi.max_earned_amnt", "bi.billable_status", "bt.sno", "cu.name", "bi.cdate", "mu.name", "bi.mdate");
		
		$btsno = $gridExtraFields['btsnoval'];
		$mode = $gridExtraFields['modeval'];
		if($btsno != "" && $mode == 'mbi')
		{
			$whereCond .= " AND bim.bt_id = '".$btsno."'";
		}
		else if($btsno != "" && $mode == 'nmbi')
		{					
			$whereCond .= " AND bi.sno NOT IN (SELECT bi_id FROM burden_items_map WHERE bt_id = '".$btsno."')";
		}
		
		$tque="SELECT count(1) 
		FROM burden_items bi
		LEFT JOIN burden_items_map bim ON bim.bi_id = bi.sno
		LEFT JOIN burden_types bt ON bt.sno = bim.bt_id
		LEFT JOIN users cu ON cu.username = bi.cuser
		LEFT JOIN users mu ON mu.username = bi.muser	
		WHERE ".$whereCond;
	
		$oque="SELECT bi.sno,
					  GROUP_CONCAT(bim.bt_id),
					  GROUP_CONCAT(bt.burden_type_name),
					  bi.burden_item_name,
					  bi.burden_value,
					  bi.burden_mode,
					  bi.ratetype,
					  bi.max_earned_amnt,
					  bi.billable_status,
					  cu.name,
					  ".tzRetQueryStringDTime('bi.cdate','DateTime','/')." AS cdate,
					  mu.name,
					  ".tzRetQueryStringDTime('bi.mdate','DateTime','/')." AS mdate,
					  bt.bt_status,
                      bi.assigned
					FROM burden_items bi
					LEFT JOIN burden_items_map bim ON bim.bi_id = bi.sno
					LEFT JOIN burden_types bt ON bt.sno = bim.bt_id
					LEFT JOIN users cu ON cu.username = bi.cuser
					LEFT JOIN users mu ON mu.username = bi.muser		
					WHERE ".$whereCond."					
					";
		
		$gstr = "GROUP BY bi.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		//$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		//$total=$gd->getTotalRows($tque);
		
		$gridData=$gd->buildBurdenItems($oque,$btsno,$mode);
		$total = count($gridData);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;		
	}
	// Function to build the list of burden items.
	function buildBurdenItems($que,$btsnoval,$modeval)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			if($row[5] == 'percentage')
			{
				$row[5] = '%';
			}
			else if($row[5] == 'flat')
			{
				$row[5] = 'Flat Amount';
			}
			$rate_type	= '';
			if ($row[6] == 'payrate') {

				$rate_type = 'Pay Rate';

			} elseif ($row[6] == 'billrate') {

				$rate_type = 'Bill Rate';
			}
			elseif ($row[6] == 'hours') {

				$rate_type = 'Hours';
			}
			elseif ($row[6] == 'uom_units') {

				$rate_type = 'Units';
			}	
			if($row[13] != 'Removed')
			{
				$chboxValues = $row[0];
				if($row[14] == 'yes' && $modeval != 'nmbi' && $modeval != 'createbt')
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids_disabled[] OnClick=chk_clearTop() value='".$chboxValues."' disabled ><span class='checkmark'></span></label><input type='hidden' name='billablestatus[]' id='billable_status' value='".$row[8]."'>"; 
				}
				else
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label><input type='hidden' name='billablestatus[]' id='billable_status' value='".$row[8]."'>";
				}
				
				$grid[$j][1]=$this->convertSpecChars($row[3]); 
				$grid[$j][2]=$this->convertSpecChars($row[4]); 
				$grid[$j][3]=$this->convertSpecChars($row[5]); 
				$grid[$j][4]=$this->convertSpecChars($rate_type); 
				$grid[$j][5]=$this->convertSpecChars($row[7]);
				$grid[$j][6]=$this->convertSpecChars($row[8]);
				$grid[$j][7]=$this->convertSpecChars($row[2]);
				$grid[$j][8]=$this->convertSpecChars($row[9]);
				$grid[$j][9]=$this->convertSpecChars($row[10]);
				$grid[$j][10]=$this->convertSpecChars($row[11]);
				$grid[$j][11]=$this->convertSpecChars($row[12]);				
				$grid[$j][12]="";
				$grid[$j][13] = $row[0];			
				$j++;
			}
		}
		return $grid;
	}
	
	//enable or disable check boxes if custom rates are associate wiht any one of job order or assignment.
	function enableInputPayRates($rateid)
	{
		global $db;
		$returnVal = true;
		$queJO = "SELECT COUNT(1) FROM multiplerates_joborder WHERE ratemasterid = '".$rateid."' AND status = 'ACTIVE'";
		$resJO = mysql_query($queJO,$db);
		$resJO = mysql_fetch_row($resJO);
		
		$queASG = "SELECT COUNT(1)  FROM multiplerates_assignment WHERE ratemasterid = '".$rateid."' AND status = 'ACTIVE'";
		$resASG = mysql_query($queASG,$db);
		$resASG = mysql_fetch_row($resASG);
		
		if($resJO[0] > 0 || $resASG[0] > 0){
			$returnVal = false;
		}
		return $returnVal;
	}
	
	function buildCustomRatesQSTR($gridSearchType,$gridSearchFields,$asFields)
	{
            $qstr="";
            if($this->isSearch($gridSearchFields))
            {
                $qstr=" AND (";
                for($i=0;$i<count($gridSearchFields);$i++)
                {
                    $gridSearchField=mysql_real_escape_string(addslashes($gridSearchFields[$i]));
                    $gridSearchField=str_replace("%","\%",$gridSearchField);
                    $gridSearchField=str_replace("_","\_",$gridSearchField);

                    if($gridSearchFields[$i]!=""){
                        if($i == 2 || $i == 4 || $i == 5)
                        {
                            $qstr.=$asFields[$i+1]." = '".$gridSearchField."' $gridSearchType ";
                        }
                        else
                        {
                            $qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
                        }
                    }
                }
                $qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
                $qstr.=")";
            }
            return $qstr;
	}
	
	
	// Function to get the list of Custom Rates.
	function getCustomRates($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
            global $db;

            $gd=new gridData();

            $whereCond = " mm.status != 'DELETED' AND mm.status != 'BACKUP'";

            $asFields = array("", "mm.name", "IF(mm.sno=1 OR mm.sno=4,'',mm.pvalue)", "mm.poption", "IF(mm.sno=1 OR mm.sno=4,'',mm.bvalue)", "mm.boption", "mm.status", "IF(mm.sno<=4,'System',cu.name)", tzRetQueryStringDTime('mm.cdate','DateTime','/'), "IF(mm.sno=1 OR mm.sno=4,'System',mu.name)", tzRetQueryStringDTime('mm.mdate','DateTime','/'));

            $ssFields = array("", "mm.name", "IF(mm.sno=1 OR mm.sno=4,'',mm.pvalue)", "mm.poption", "IF(mm.sno=1 OR mm.sno=4,'',mm.bvalue)", "mm.boption", "mm.status", "IF(mm.sno<=4,'System',cu.name)", "mm.cdate", "IF(mm.sno=1 OR mm.sno=4,'System',mu.name)", "mm.mdate");

            $tque="SELECT count(1) 
            FROM multiplerates_master mm	
            LEFT JOIN users cu ON cu.username = mm.cuser
            LEFT JOIN users mu ON mu.username = mm.muser
            WHERE ".$whereCond;

            $oque="SELECT mm.sno, 
                    mm.name,
                    IF(mm.sno=1 OR mm.sno=4,'',mm.pvalue) as pvalue,
                    IF(mm.poption = 'B', 'Yes', 'No') poption,
                    IF(mm.sno=1 OR mm.sno=4,'',mm.bvalue) as bvalue,
                    IF(mm.boption = 'T', 'Yes', 'No') boption,
                    mm.status,
                    IF(mm.sno<=4,'System',cu.name) AS createduser,
                    ".tzRetQueryStringDTime('mm.cdate','DateTime','/')." AS cdate,
                    IF(mm.sno=1 OR mm.sno=4,'System',mu.name) AS modifiedUser,
                    ".tzRetQueryStringDTime('mm.mdate','DateTime','/')." AS mdate,
                    mm.rateid
                    FROM multiplerates_master mm
                    LEFT JOIN users cu ON cu.username = mm.cuser
                    LEFT JOIN users mu ON mu.username = mm.muser		
                    WHERE ".$whereCond;
            $gstr = "";

            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildCustomRatesQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildCustomRates($oque);

            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);

            return $objResponse;		
    }

    // Function to build the list of Custom Rates.
    function buildCustomRates($que)
    {
        global $db;
        $j=0;
        $grid = array();
        $res = mysql_query($que,$db);
        $musername = "";
        while ($row=mysql_fetch_array($res))
        {
            $chboxValues = $row[0];
			if($row[6] == 'DEACTIVE')
			{
				$row[6] = 'Inactive';
			}
			else if($row[6] == 'ACTIVE')
			{
				$row[6] = 'Active';
			}
            $inchkbox = "<label class='container-chk'><input type=checkbox";
            if($row[0]>4&&$this->enableInputPayRates($row[11])){$inchkbox.= " class='payrates' name=auids[]";}else{$inchkbox.= " disabled='disabled' name=auids_disabled[] ";}
            $inchkbox.= " OnClick='chk_clearTop()' value='".$chboxValues."'><span class='checkmark'></span></label>";
            $grid[$j][0]=$inchkbox;
            $grid[$j][1]=$this->convertSpecChars($row[1]);
            $grid[$j][2]=$this->convertSpecChars($row[2]); 
            $grid[$j][3]=$this->convertSpecChars($row[3]); 
            $grid[$j][4]=$this->convertSpecChars($row[4]);
            $grid[$j][5]=$this->convertSpecChars($row[5]);
            $grid[$j][6]=$this->convertSpecChars($row[6]);
            $grid[$j][7]=$this->convertSpecChars($row[7]);
            $grid[$j][8]=$this->convertSpecChars($row[8]);
            $grid[$j][9]=$this->convertSpecChars($row[9]);
            $grid[$j][10]=$this->convertSpecChars($row[10]);
            $grid[$j][11]="";
            $grid[$j][12] = "add_edit_ratetypes.php?sno=".$row[0];
            $j++;
        }
        return $grid;
    }

	function getCEA($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$posid=$gridExtraFields['posid'];

		$asFields = array("","hg.name","cea.user_name","cea.authentication","uc.name",tzRetQueryStringDate('cea.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('cea.mdate','Date','/'));
		$ssFields = array("","hg.name","cea.user_name","cea.authentication","uc.name","cea.cdate","um.name","cea.mdate");

		$tque="SELECT COUNT(1) FROM ceaUsers cea LEFT JOIN users hg ON hg.username=cea.username LEFT JOIN users uc ON uc.username=cea.cuser LEFT JOIN users um ON um.username=cea.muser WHERE cea.status='A'";
		$oque="SELECT cea.sno, hg.name, cea.user_name, cea.authentication, uc.name, ".tzRetQueryStringDate('cea.cdate','DateTime','/').", um.name, ".tzRetQueryStringDate('cea.mdate','Date','/')." FROM ceaUsers cea LEFT JOIN users hg ON hg.username=cea.username LEFT JOIN users uc ON uc.username=cea.cuser LEFT JOIN users um ON um.username=cea.muser WHERE cea.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCEA($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildCEA($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = "editcea.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}

	function getCEABCasts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","bc.bname","IF(bc.btype='S','SMS','Announcement')","bc.bstatus",tzRetQueryStringDate('bc.stime','DateTime','/'),tzRetQueryStringDate('bc.ctime','DateTime','/'),"u.name");
		$ssFields = array("","bc.bname","IF(bc.btype='S','SMS','Announcement')","bc.bstatus","bc.stime","bc.ctime","u.name");

		$tque="SELECT COUNT(1) FROM ceaBCInfo bc LEFT JOIN users u ON bc.username=u.username WHERE 1=1";
		$oque="SELECT bc.bcid, bc.bname, IF(bc.btype='S','SMS','Announcement'), bc.bstatus,".tzRetQueryStringDate('bc.stime','DateTime','/').", ".tzRetQueryStringDate('bc.ctime','DateTime','/').",u.name FROM ceaBCInfo bc LEFT JOIN users u ON bc.username=u.username WHERE 1=1";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCEABCasts($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildCEABCasts($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "&nbsp;";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $row[0];

			$j++;
		}

		return $grid;
	}


	function getCEABCInfo($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$bcid=$gridExtraFields['bcid'];

		$asFields = array("","bc.fname","bc.lname","bc.phone","bc.cstatus",tzRetQueryStringDate('bc.ctime','DateTime','/'),"cm.message",tzRetQueryStringDate('cm.received_at','DateTime','/'));
		$ssFields = array("","bc.fname","bc.lname","bc.phone","bc.cstatus","bc.ctime","cm.message","cm.received_at");

		$tque="SELECT COUNT(1) FROM ceaBCDetails bc LEFT JOIN ceaMessages cm ON bc.bcid=cm.broadcast_id AND bc.phone=cm.phone_number AND cm.message_type='broadcast-reply' WHERE bc.bcid='$bcid'";
		$oque="SELECT bc.sno, bc.fname, bc.lname, bc.phone, bc.cstatus, ".tzRetQueryStringDate('bc.ctime','DateTime','/').",bc.notes,cm.message, ".tzRetQueryStringDate('cm.received_at','DateTime','/')." FROM ceaBCDetails bc LEFT JOIN ceaMessages cm ON bc.bcid=cm.broadcast_id AND bc.phone=cm.phone_number AND cm.message_type='broadcast-reply' WHERE bc.bcid='$bcid'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCEABCInfo($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildCEABCInfo($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "&nbsp;";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[7]);
			$grid[$j][7] = $this->convertSpecChars($row[8]);

			if($row[6]!="")
				$grid[$j][8] = "redirect.php?recid=".$row[6];
			else
				$grid[$j][8] = "";

			$j++;
		}

		return $grid;
	}

	function getCEABCResponses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$bcid=$gridExtraFields['bcid'];

		$asFields = array("","bc.fname","bc.lname","bc.phone","br.response",tzRetQueryStringDate('br.rtime','DateTime','/'));
		$ssFields = array("","bc.fname","bc.lname","bc.phone","br.response","br.rtime");

		$tque="SELECT COUNT(1) FROM ceaBCResponses br LEFT JOIN ceaBCDetails bc ON br.bcid=bc.bcid WHERE br.phone=bc.phone AND br.bcid='$bcid'";
		$oque="SELECT br.trid, bc.fname, bc.lname, bc.phone, br.response, ".tzRetQueryStringDate('br.rtime','DateTime','/').",bc.notes FROM ceaBCResponses br LEFT JOIN ceaBCDetails bc ON br.bcid=bc.bcid WHERE br.phone=bc.phone AND br.bcid='$bcid'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildCEABCResponses($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildCEABCResponses($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "&nbsp;";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);

			if($row[6]!="")
				$grid[$j][6] = "redirect.php?recid=".$row[6];
			else
				$grid[$j][6] = "";

			$j++;
		}

		return $grid;
	}
	
	// Function to get the list of Shift Names.
	function getShiftManagement($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		
		$whereCond = " sm.shiftstatus IN ('active','deactive','system') ";
	
		$asFields = array("", "sm.shiftname", "sm.shiftcode", "sm.shiftstatus", "IF(sm.sno=1,'System',cu.name)", tzRetQueryStringDTime('sm.cdate','DateTime','/'), "IF(sm.sno=1,'System',mu.name)", tzRetQueryStringDTime('sm.mdate','DateTime','/'));
				
		$ssFields = array("", "sm.shiftname","sm.shiftcode", "sm.shiftcolor", "sm.shiftstatus", "IF(sm.sno=1,'System',cu.name)", "sm.cdate", "IF(sm.sno=1,'System',mu.name)", "sm.mdate");
		
		$and_clause	= '';

		if($gridSearchFields[2] != "") 
		{
			$stg_flag	= $gridSearchFields[2];
			$and_clause	.= " AND sm.shiftstatus = '".$stg_flag."' ";
			$gridSearchFields[2]	= "";
		}
		$tque="SELECT count(1) 
		FROM shift_setup sm	
		LEFT JOIN users cu ON cu.username = sm.cuser
		LEFT JOIN users mu ON mu.username = sm.muser
		WHERE ".$whereCond;
	
		$oque="SELECT
			sm.sno, 
			sm.shiftname,
            sm.shiftcode,
			sm.shiftcolor,
			sm.shiftstatus,
			cu.name,
			".tzRetQueryStringDTime('sm.cdate','DateTime','/')." AS cdate,
			mu.name,
			".tzRetQueryStringDTime('sm.mdate','DateTime','/')." AS mdate
			FROM shift_setup sm
			LEFT JOIN users cu ON cu.username = sm.cuser
			LEFT JOIN users mu ON mu.username = sm.muser		
			WHERE ".$whereCond.$and_clause;
		
		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
		$gridData=$gd->buildShiftManagement($oque);
		$total = count($gridData);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;		
	}
	// Function to build the list of Shift Names.
	function buildShiftManagement($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			if($row[4] == 'deactive')
			{
				$row[4] = 'Inactive';
			}
			$chboxValues = $row[0];			
			
			$inchkbox = "<label class='container-chk'><input type=checkbox";
			if($row[0]!=1 && $this->enableDisableCheckboxShift($chboxValues)){
				$inchkbox.= " class='payrates' name=auids[]";
			}else{
				$inchkbox.= " disabled='disabled' name=auids_disabled[] ";
			}
			$inchkbox.= " OnClick='chk_clearTop()' value='".$chboxValues."'><span class='checkmark'></span></label>";
					
			$grid[$j][0]=$inchkbox;
			$grid[$j][1]=$this->convertSpecChars($row[1]);
            $grid[$j][2]=$this->convertSpecChars($row[2]);
			$css_colorcode = str_replace("#","",$this->convertSpecChars($row[3]));			
			$shift_color_disp = "<div title='".$this->convertSpecChars($row[3])."' class='shiftcss_".$css_colorcode."'></div>";
			$grid[$j][3]=$shift_color_disp; 
			$grid[$j][4]=ucfirst($this->convertSpecChars($row[4])); 
			$grid[$j][5]=($chboxValues == 1 ? 'System':$this->convertSpecChars($row[5]));
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=($chboxValues == 1 ? 'System':$this->convertSpecChars($row[7]));
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]="";
			$grid[$j][10] = $row[0];
					
			$j++;
		}
		return $grid;
	}
	
	//enable or disable check boxes if shifts are associated with any job order, placement or assignment.
	function enableDisableCheckboxShift($shiftsno)
	{
		global $db;
		$returnVal = true;
		
		$queJO = "SELECT COUNT(1) FROM posdesc_sm_timeslots WHERE sm_sno = '".$shiftsno."'";
		$resJO = mysql_query($queJO,$db);
		$resJO = mysql_fetch_row($resJO);
		
		$quePL = "SELECT COUNT(1) FROM placement_sm_timeslots WHERE sm_sno = '".$shiftsno."'";
		$resPL = mysql_query($queJO,$db);
		$resPL = mysql_fetch_row($resJO);
		
		$queASG = "SELECT COUNT(1) FROM hrconjob_sm_timeslots WHERE sm_sno = '".$shiftsno."'";
		$resASG = mysql_query($queASG,$db);
		$resASG = mysql_fetch_row($resASG);

		$queJONewShiftQry = "SELECT COUNT(1) FROM posdesc WHERE shiftid = '".$shiftsno."'";
		$queJONewShiftRes = mysql_query($queJONewShiftQry,$db);
		$queJONewShiftRow = mysql_fetch_row($queJONewShiftRes);

		$quePLNewShiftQry = "SELECT COUNT(1) FROM placement_jobs WHERE shiftid = '".$shiftsno."'";
		$quePLNewShiftRes = mysql_query($quePLNewShiftQry,$db);
		$quePLNewShiftRow = mysql_fetch_row($quePLNewShiftRes);

		$queASGNewShiftQry = "SELECT COUNT(1) FROM hrcon_jobs WHERE shiftid = '".$shiftsno."'";
		$queASGNewShiftRes = mysql_query($queASGNewShiftQry,$db);
		$queASGNewShiftRow = mysql_fetch_row($queASGNewShiftRes);
		
		if($resJO[0] > 0 || $resPL[0] > 0 || $resASG[0] > 0 || $queJONewShiftRow[0] > 0 || $quePLNewShiftRow[0] > 0 || $queASGNewShiftQry[0] > 0){
			$returnVal = false;
		}
		return $returnVal;
	}
	
	//Following is function to generate query for manage commissions
	function getManageCommissions($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd	= new gridData();
	
		$asFields = array("", "mc.emp_nick_name", "el.name", tzRetQueryStringDTime('mc.startdate','Date','/'), tzRetQueryStringDTime('mc.enddate','Date','/'), "mc.status", tzRetQueryStringDTime('mc.cdate','DateTime','/'), "cu.name", tzRetQueryStringDTime('mc.mdate','DateTime','/'), "mu.name");
				
		$ssFields = array("", "mc.emp_nick_name", "el.name", "mc.startdate", "mc.enddate", "mc.status", "mc.cdate", "cu.name", "mc.mdate", "mu.name");

		if($gridSearchFields[4] != "") 
		{
			$stg_flag		= ($gridSearchFields[4] == 'active') ? 'active' : 'deactive';
			$whereCond		= " mc.status = '".$stg_flag."' ";
			$gridSearchFields[4]	= "";
		}
		else {
			$whereCond = " mc.status IN ('active','deactive') ";
		}

		$tque	= "SELECT
				count(1) 
				FROM
					manage_commission mc
				LEFT JOIN
					emp_list el ON el.sno = mc.employee_id 	
				LEFT JOIN
					users cu ON cu.username = mc.cuser
				LEFT JOIN
					users mu ON mu.username = mc.muser
				WHERE
					".$whereCond;
	
		$oque		= "SELECT
					mc.sno, 
					mc.emp_nick_name,
					el.name AS empname,
					IF(mc.startdate = '0000-00-00','',".tzRetQueryStringDTime('mc.startdate','Date','/').") AS sdate,
					IF(mc.enddate = '0000-00-00','',".tzRetQueryStringDTime('mc.enddate','Date','/').") AS edate,
					IF(mc.status = 'active','Active','Inactive') AS status,
					".tzRetQueryStringDTime('mc.cdate','DateTime','/')." AS cdate,
					cu.name AS createduser,
					".tzRetQueryStringDTime('mc.mdate','DateTime','/')." AS mdate, 
					mu.name AS modifieduser 
				FROM
					manage_commission mc
				LEFT JOIN
					emp_list el ON el.sno = mc.employee_id 
				LEFT JOIN
					users cu ON cu.username = mc.cuser
				LEFT JOIN
					users mu ON mu.username = mc.muser		
				WHERE
					".$whereCond;

		$grp_str	= "";
		$lstr		= $gd->buildLimt($gridPage,$gridRecords);
		
		$qstr1		= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr		= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque		= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count	= "$oque $qstr $grp_str $qstr1 $ostr";
		$total		= $gd->getTotalCount($oque_Count);

		$oque		= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		
		
		$gridData	= $gd->buildManageCommissions($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
        
	function buildManageCommissions($que)
	{
		global $maildb,$db;

		$grid	= array();
		$j	= 0;
		$res	= mysql_query($que,$db);

		while ($row = mysql_fetch_array($res))
		{
			$grid[$j][0]	= "<label class='container-chk'><input type=checkbox  name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row['sno']."'><span class='checkmark'></span></label>";
			$grid[$j][1]	= $this->convertSpecChars($row['emp_nick_name']);
			$grid[$j][2]	= $this->convertSpecChars($row['empname']);
			$grid[$j][3]	= $this->convertSpecChars($row['sdate']);
			$grid[$j][4]	= $this->convertSpecChars($row['edate']);
			$grid[$j][5]	= $this->convertSpecChars($row['status']);
			$grid[$j][6]	= $this->convertSpecChars($row['cdate']);
			$grid[$j][7]	= $this->convertSpecChars($row['createduser']);
			$grid[$j][8]	= $this->convertSpecChars($row['mdate']);
			$grid[$j][9]	= $this->convertSpecChars($row['modifieduser']);
			$grid[$j][10]	= $row['sno'];
			$grid[$j][11]	= "";

			$j++;
		}
		return $grid;
	}
    
	//Following is function to generate query for Manage Commissions Split Tiers
	function getManageCommissionSplitTiers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd	= new gridData();
	
		$asFields = array("", "cl.commission_level", "cl.status", "cu.name", tzRetQueryStringDTime('cl.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('cl.mdate','DateTime','/'));
				
		$ssFields = array("", "cl.commission_level", "cl.status", "cu.name", "cl.cdate", "mu.name", "cl.mdate");

		if($gridSearchFields[1] != "") 
		{
			$stg_flag	= ($gridSearchFields[1] == 'active') ? 'active' : 'deactive';
			$whereCond	= " cl.status = '".$stg_flag."' ";

			$gridSearchFields[1]	= "";
		}
		else {
			$whereCond	= " cl.status IN ('active','deactive') ";
		}

		$tque	= "SELECT count(1) 
				FROM
					commission_levels cl	
				LEFT JOIN
					users cu ON cu.username = cl.cuser
				LEFT JOIN
					users mu ON mu.username = cl.muser
				WHERE
					".$whereCond;
	
		$oque	= "SELECT cl.sno, 
					cl.commission_level,
					If(cl.status = 'active','Active','Inactive') AS status,
					cu.name AS createduser,
					".tzRetQueryStringDTime('cl.cdate','DateTime','/')." AS cdate,
					mu.name AS modifiedUser,
					".tzRetQueryStringDTime('cl.mdate','DateTime','/')." AS mdate		
				FROM
					commission_levels cl
				LEFT JOIN
					users cu ON cu.username = cl.cuser
				LEFT JOIN
					users mu ON mu.username = cl.muser		
				WHERE
					".$whereCond;

		$grp_str	= "";
		$lstr		= $gd->buildLimt($gridPage,$gridRecords);
		
		$qstr1		= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr		= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque		= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count	= "$oque $qstr $grp_str $qstr1 $ostr";
		$total		= $gd->getTotalCount($oque_Count);
				
		$oque		= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		

		$gridData	= $gd->buildManageCommissionSplitTiers($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
        
	//Function to check if any commission tier is mapped to manage commissions.returns FALSE if any tier is mapped
	function checkCommTierAssigned($sno)
        {
		global $db;
		$periods_query		= "SELECT sno FROM manage_commission_periods WHERE commission_level_sno = ".$sno." LIMIT 1";
		$splits_query		= "SELECT sno FROM manage_commission_splits WHERE commission_level_sno = ".$sno." LIMIT 1";
		$periods_res	= mysql_query($periods_query, $db);
		$splits_res	= mysql_query($splits_query, $db);

		if(mysql_num_rows($periods_res) > 0 || mysql_num_rows($splits_res) > 0)
		{
			return false;
		}
		else
		{
			return true;
		}
        }
	
	function buildManageCommissionSplitTiers($que)
	{
		global $maildb,$db;

		$grid	= array();
		$j	= 0;

		$res	= mysql_query($que,$db);

		while ($row = mysql_fetch_array($res))
		{
			if($this->checkCommTierAssigned($row[0]))
			{
				$grid[$j][0]	= "<label class='container-chk'><input type=checkbox  name='auids[]' id='auids[]' OnClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			}
			else
			{
				$grid[$j][0]	= "<label class='container-chk'><input type=checkbox  disabled='disabled' name='auids_disabled[]'><span class='checkmark'></span></label>";
			}
			$grid[$j][1]	= $this->convertSpecChars($row[1]);
			$grid[$j][2]	= $this->convertSpecChars($row['status']);
			$grid[$j][3]	= $this->convertSpecChars($row[3]);
			$grid[$j][4]	= $this->convertSpecChars($row[4]);
			$grid[$j][5]	= $this->convertSpecChars($row[5]);
			$grid[$j][6]	= $this->convertSpecChars($row[6]);
			$grid[$j][7]	= $row[0];
			$grid[$j][8]	= "";

			$j++;
		}
		return $grid;
	}

	/*** Coded by Naresh Reddy to display DocuSign Users ***/
	function getDocuSignPOBManagement($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username, $companyuser;

		$gd = new gridData();
		
		$whereCond = " AND dsu.status IN ('active','inactive','pending') ";
		
		$and_clause	= '';
		
		if($gridSearchFields[3] != "") 
		{
			$stg_flag	= $gridSearchFields[3];
			$and_clause	.= " AND dsu.status = '".$stg_flag."' ";
			$gridSearchFields[3]	= "";
		}
		
		$asFields = array("","dsu.username","dsu.fullname","dsu.emailid","dsu.status",tzRetQueryStringDTime('dsu.cdate','DateTime','/'),"cu.name",tzRetQueryStringDTime('dsu.mdate','DateTime','/'),"mu.name","","dsu.connection_status","");
		$ssFields = array("","dsu.username","dsu.fullname","dsu.emailid","dsu.status","dsu.cdate","cu.name","dsu.mdate","mu.name","","dsu.connection_status","");

		$tque="SELECT COUNT(1) FROM docusign_users dsu LEFT JOIN users cu ON cu.username = dsu.cuser LEFT JOIN users mu ON mu.username = dsu.muser WHERE dsu.company_id = '".$companyuser."'".$whereCond.$and_clause;
		$oque="SELECT dsu.sno, dsu.username, dsu.fullname, dsu.emailid, dsu.status, ".tzRetQueryStringDTime('dsu.cdate','DateTime','/').", cu.name, ".tzRetQueryStringDTime('dsu.mdate','DateTime','/').", mu.name, dsu.reactiveflag,dsu.connection_status,dsu.passwd FROM docusign_users dsu LEFT JOIN users cu ON cu.username = dsu.cuser LEFT JOIN users mu ON mu.username = dsu.muser WHERE dsu.company_id = '".$companyuser."'".$whereCond.$and_clause;

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildDocuSignPOBManagement($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildDocuSignPOBManagement($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$val = $row[0]."-".$row[4];
			$docu_passwd = base64_encode($row[11]); 
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$val."'><input type=hidden class='docu_passwd' value='".$docu_passwd."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = ucfirst($this->convertSpecChars($row[4]));
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);			
			if($grid[$j][4] == 'Active'){
				$grid[$j][9] = "<a href=\"javascript:doPassword(".$row[0].", '".addslashes($row[2])."')\"><img src=/BSOS/images/icons/password.gif title='Reset&nbsp;Password' border=0></a>";
                if($row[9] == 1) {
                    $grid[$j][9].= "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=/BSOS/images/icons/Priority.gif title='Reactivate User' border=0>";
                }
			}else{
				$grid[$j][9] = "";
			}
			if($row[10] != ''){
				if($row[10] == 'success'){
					$grid[$j][10] = "<i class='fa fa-check'></i>";
				}else{
					$grid[$j][10] = "<i class='fa fa-times' title='".$row[10]."'></i>";
				}
			}else{
				$grid[$j][10] = "";
			}
			$grid[$j][11] = "";
			$grid[$j][12] = $row[0];
			$j++;
		}

		return $grid;
	}
	
	/*** End Naresh reddy ***/
	
	/* Time Sheet Rules*/
	function getConTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['rsdate'];
		$maxDateValue = $gridExtraFields['redate'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();		

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)","p.rstatus");
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","p.sdate","p.edate","ROUND(SUM(t.hours),2)","p.rstatus");
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['rsdate'];
        $timesheetToDate =  $gridExtraFields['redate'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['redate'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['rsdate'];
            $timesheetToDate =  $gridExtraFields['redate'];
        }
         ///// TimeSheet Grid Load Optimization code ends ///////
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 

		WHERE p.template='Regular' AND p.rstatus IN ('Rules','Conflict') AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT 
		p.sno,
		e.sno,
		TRIM(e.name),
		GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),
		GROUP_CONCAT(DISTINCT(s.sno)),
		TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),
		TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),
		".tzRetQueryStringDate('p.sdate','Date','/').",
		".tzRetQueryStringDate('p.edate','Date','/').",
		ROUND(SUM(t.hours),2),
		IF(p.rstatus='Rules','Not Processed',p.rstatus),
		getTSConflictStatus(p.tscou,p.asgcou),
		p.username,
		p.template,
		".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, 
		".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate,
		p.customratesflag 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
		WHERE p.template='Regular' AND p.rstatus IN ('Rules','Conflict') AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildConTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//Time Sheet Load Optimization
        $buildGridHeadValue = $gd->buildGridHeadData($qstr,$ostr,$gstr,$gridExtraFields,$timesheetFromDate,$timesheetToDate,$gridSearchFields,$searchFromDate,$searchToDate,$totalSearchCount);
        if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
         }
        $objResponse->addScriptCall("updateGridDataDisplay",$buildGridHeadValue,$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////

		return $objResponse;
	}

	function buildConTimeSheets($que)
	{
		global $db;

		$j=0;
		$grid=array();
        $mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);

			if($row[10]=="Conflict"){
                if($row[11]!='' && $row[16]=='YES'){
                    $grid[$j][10]=$this->convertSpecChars($row[10]." - ".$row[11].' and Custom Rates');
                }else if($row[16]=='YES'){
                    $grid[$j][10]=$this->convertSpecChars($row[10]." - Custom Rates");
                }else if($row[11]!=''){
                    $grid[$j][10]=$this->convertSpecChars($row[10]." - ".$row[11]);
                }
            }else {
            	$grid[$j][10]=$this->convertSpecChars($row[10]);
            }

			$grid[$j][11]=$row[0];
			$grid[$j][12]=$row[12];
			$grid[$j][13]=$row[13];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization 

			$j++;
		}
        // TimeSheet Grid Load Optimization 
            asort($mindatearray);
            asort($maxdatearray);
            $mindate = reset($mindatearray);
            $maxdate = end($maxdatearray);
            unset($midate);
            unset($mindatearray);
            unset($maxdatearray);
            unset($madate);
            $grid['totalCount'] = mysql_num_rows($res);
            $grid['maxdate'] = $maxdate;
            $grid['mindate'] = $mindate;
            // TimeSheet Grid Load Optimization 

		return $grid;
	}

	function buildSelectList($asgnids)
	{
		global $db;

		$sasgnids=explode("|ASPLIT|",$asgnids);

		if(count($sasgnids)>1)
		{
			$selList="<select name='otids[]' id='otids[]'>";
			$selList.="<option value=''>-- Select Assignment --</option>";
			for($i=0;$i<count($sasgnids);$i++)
			{
				$ssasgn=explode("|ISPLIT|",$sasgnids[$i]);
				$selList.="<option value='".$ssasgn[0]."' title='".addslashes($ssasgn[0]." - ".$ssasgn[1])."'>".$ssasgn[0]." - ".$ssasgn[1]."</option>";
			}
			$selList.="</select>";
		}
		else
		{
			$ssasgn=explode('|ISPLIT|',$sasgnids[0]);
			$selList=$ssasgn[0]." - ".$ssasgn[1]."<input type=hidden name='otids[]' id='otids[]' value='".$ssasgn[0]."'>";
		}

		return $selList;
	}


	function getAppTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;

		$minDateValue = $gridExtraFields['rsdate'];
		$maxDateValue = $gridExtraFields['redate'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();		

		$asFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))",tzRetQueryStringDate('p.sdate','Date','/'),tzRetQueryStringDate('p.edate','Date','/'),"ROUND(SUM(t.hours),2)",tzRetQueryStringDTime('p.rtime','DateTime24Sec','/'),"CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out'  END");
		$ssFields = array("","e.sno","TRIM(e.name)","GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername)))","GROUP_CONCAT(DISTINCT(s.sno))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state)))","MIN(p.sdate)","MAX(p.edate)","ROUND(SUM(t.hours),2)",tzRetQueryStringDTime('p.rtime','DateTime24Sec','/'),"CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out'  END");
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['rsdate'];
        $timesheetToDate =  $gridExtraFields['redate'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
        if($gd->isSearch($gridSearchFields)){
            $defaultminDateValue  = $gridExtraFields['servicedatesearched'];
            $defaultminDateValue = date("Y-m-d",strtotime($defaultminDateValue));
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$defaultminDateValue."'";
            $timesheetFromDate = $gridExtraFields['servicedatesearched'];
            $timesheetToDate =  $gridExtraFields['redate'];
        }else{
            $searchDateCheck = "AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."'";
            $timesheetFromDate = $gridExtraFields['rsdate'];
            $timesheetToDate =  $gridExtraFields['redate'];
        }
        ///// TimeSheet Grid Load Optimization code ends ///////
		$tque = "SELECT p.sno 
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
		WHERE p.astatus='ER' AND p.rstatus='Applied' AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$oque = "SELECT p.sno,e.sno,TRIM(e.name),GROUP_CONCAT(DISTINCT(IF(t.type='EARN',t.client,j.pusername))),GROUP_CONCAT(DISTINCT(s.sno)),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(l.state))),".tzRetQueryStringDate('MIN(p.sdate)','Date','/').",".tzRetQueryStringDate('MAX(p.edate)','Date','/').",COUNT(DISTINCT(t.assid)),ROUND(SUM(t.hours),2),".tzRetQueryStringDTime('p.rtime','DateTime24Sec','/').",CASE p.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END ,".tzRetQueryStringDate('min(p.sdate)','Date','/')." as mindate, ".tzRetQueryStringDate('max(p.edate)','Date','/')." as maxdate
			FROM timesheet_hours t 
			LEFT JOIN par_timesheet p ON t.parid=p.sno 
			LEFT JOIN emp_list e ON e.username=p.username 
			LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
		WHERE p.astatus='ER' AND p.rstatus='Applied' AND t.status = 'ER' ".$searchDateCheck." AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' ";

		$gstr=" GROUP BY p.sno ";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildAppTimeSheets($oque);
        // TimeSheet Grid Load Optimization
        $searchFromDate = date("m/d/Y",$gridData['mindate']);
        $searchToDate = date("m/d/Y",$gridData['maxdate']);
        $totalSearchCount= $gridData['totalCount'];
        unset($gridData['maxdate']);
        unset($gridData['mindate']);
        unset($gridData['totalCount']);
        ///// TimeSheet Grid Load Optimization code ends ///////
		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// TimeSheet Grid Load Optimization 
		$buildGridHeadValue = $gd->buildGridHeadData($qstr,$ostr,$gstr,$gridExtraFields,$timesheetFromDate,$timesheetToDate,$gridSearchFields,$searchFromDate,$searchToDate,$totalSearchCount);
        if($gd->isSearch($gridSearchFields) && $totalSearchCount>0){
            $timesheetFromDate = $searchFromDate;
            $timesheetToDate = $searchToDate;
         }
        $objResponse->addScriptCall("updateGridDataDisplay",$buildGridHeadValue,$timesheetFromDate,$timesheetToDate);
        ///// TimeSheet Grid Load Optimization code ends ///////

		return $objResponse;
	}

	function buildAppTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
        $mindatearray =array();// TimeSheet Grid Load Optimization 
        $maxdatearray = array();// TimeSheet Grid Load Optimization 
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[10]);
			$grid[$j][10]=$this->convertSpecChars($row[11]);
			$grid[$j][11]=$this->convertSpecChars($row[12]);
			$grid[$j][12]=$row[0];
            $mindatearray[$j]=$this->convertSpecChars(strtotime($row['mindate']));// TimeSheet Grid Load Optimization 
            $maxdatearray[$j]=$this->convertSpecChars(strtotime($row['maxdate']));// TimeSheet Grid Load Optimization 
			$j++;
		}
	    // TimeSheet Grid Load Optimization 
	        asort($mindatearray);
	        asort($maxdatearray);
	        $mindate = reset($mindatearray);
	        $maxdate = end($maxdatearray);
	        unset($midate);
	        unset($mindatearray);
	        unset($maxdatearray);
	        unset($madate);
	        $grid['totalCount'] = mysql_num_rows($res);
	        $grid['maxdate'] = $maxdate;
	        $grid['mindate'] = $mindate;
	        // TimeSheet Grid Load Optimization 
		return $grid;
	}

	function getStateRules($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();		

		$asFields = array("","TRIM(r.state)","r.maxregularhours","r.maxovertimehours","r.maxregularhours_perweek","r.maxovertimehours_perweek","c.name",tzRetQueryStringDate('r.cdate','Date','/'),"m.name",tzRetQueryStringDate('r.mdate','Date','/'));
		$ssFields = array("","TRIM(r.state)","r.maxregularhours","r.maxovertimehours","r.maxregularhours_perweek","r.maxovertimehours_perweek","c.name",tzRetQueryStringDate('r.cdate','Date','/'),"m.name",tzRetQueryStringDate('r.mdate','Date','/'));

		$tque = "SELECT COUNT(1)  
			FROM ts_state_rules r 
			LEFT JOIN users c ON r.cuser=c.username 
			LEFT JOIN users m ON r.muser=m.username 
		WHERE r.status='ACTIVE' ";

		$oque = "SELECT r.sno,r.state,r.maxregularhours,r.maxovertimehours,r.maxregularhours_perweek,r.maxovertimehours_perweek,c.name,".tzRetQueryStringDate('r.cdate','Date','/').",m.name,".tzRetQueryStringDate('r.mdate','Date','/')."
			FROM ts_state_rules r 
			LEFT JOIN users c ON r.cuser=c.username 
			LEFT JOIN users m ON r.muser=m.username 
		WHERE r.status='ACTIVE' ";

		$gstr="";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr = $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalRows($tque);

		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildStateRules($oque);

		$objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$oque,$tque);

		return $objResponse;
	}

	function buildStateRules($que)
	{
		global $db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$this->convertSpecChars($row[9]);
			$grid[$j][10]="editrule.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}
	/* End Time Sheet Rules*/
	
	/* functions for APT Form Group */
	
		// Function to get the list of burden types.
	function getformGroups($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		$gd=new gridData();
		$asFields = array("", "fg.group_name", "fg.default_firstform", "fg.status", "IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',cu.name)", 
		tzRetQueryStringDTime('fg.cdate','DateTime','/'), "IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',mu.name)",  tzRetQueryStringDTime('fg.mdate','DateTime','/'));
				
		$ssFields = array("", "fg.group_name", "fg.default_firstform", "fg.status", "IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',cu.name)", "fg.cdate", "IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',mu.name)",  "fg.mdate");
	
        $whereCond = '';

		//search condition for default form
		if($gridSearchFields[1] != "") 
		{
			$default_form_flag	= $gridSearchFields[1];
            $whereCond	.= "  fg.default_firstform = '".$default_form_flag."' ";
		}
        else
        {
            $whereCond .= " fg.default_firstform IN ('0', '1', '2') ";
        }
		
		//search condition for status
		if($gridSearchFields[2] != "") 
		{
            $stg_flag	= ($gridSearchFields[2] == 'Y') ? 'Y' : 'N';
            $whereCond	.= " and fg.status = '".$stg_flag."' ";
		}
        else
        {
            $whereCond .= " and fg.status IN ('Y', 'N') ";
        }
		$tque="SELECT count(1) 
		FROM apt_forms_groups fg
        LEFT JOIN users cu ON cu.username = fg.cuser
		LEFT JOIN users mu ON mu.username = fg.muser		
		WHERE ".$whereCond;
	
		$oque="SELECT fg.sno, 
					  fg.group_name,
					  fg.default_firstform,
					  IF( fg.status = 'Y' , 'Active', 'Deactive' ) as status, 
                      IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',cu.name) AS cname,					  
					  ".tzRetQueryStringDTime('fg.cdate','DateTime','/')." AS cdate, 
					  IF(fg.group_name = 'Long Form' OR fg.group_name = 'Quick Form','System',mu.name) AS mname, 
					  ".tzRetQueryStringDTime('fg.mdate','DateTime','/')." AS mdate,
					  IF( fg.sno = sw.apt_group_id, 'yes', 'no' ) sw_assign,
					  IF( fg.sno = hj.apt_group_id , 'yes', 'no' ) hj_assign,
                      IF( fg.sno = aj.apt_group_id , 'yes', 'no' ) aj_assign,
                      IF( fg.sno = jp.apt_group_id , 'yes', 'no' ) jp_assign
					FROM apt_forms_groups fg
					LEFT JOIN seo_websites sw ON fg.sno = sw.apt_group_id
					LEFT JOIN api_jobs aj ON fg.sno = aj.apt_group_id
					LEFT JOIN hotjobs hj ON (fg.sno = hj.apt_group_id AND aj.req_id = hj.sno)
					LEFT JOIN jobposting_pref jp ON fg.sno = jp.apt_group_id
					LEFT JOIN users cu ON cu.username = fg.cuser
					LEFT JOIN users mu ON mu.username = fg.muser					
					WHERE ".$whereCond;
					
	    $gstr = "GROUP BY fg.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		//$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildformGroups($oque);
		$total=$gd->getTotalRows($tque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;		
	}
	
	// Function to build the list of burden types.
	function buildformGroups($que)
	{
		global $db, $companyuser;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		$defaultfirstformval	= '';
		while ($row=mysql_fetch_array($res))
		{

			$chboxValues = $row[0];			
			if($row[8] == 'yes' || $row[9] == 'yes' || $row[10] == 'yes' || $row[11] == 'yes' || $row[0] == 1 || $row[0] == 2)
			{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids_disabled[] OnClick=chk_clearTop() value='".$chboxValues."' disabled ><span class='checkmark'></span></label>"; 
			}
			else
			{
				$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>"; 
			}
			
			$aptgroupname = str_replace("'","",strtolower(str_replace(" ","-",str_replace("/","-",$row[1]))));
			
			//Live URL
			$aoburl = "https://aob-".$companyuser.".akken.com/custom-form-".$row[0]."/".$aptgroupname."/static/"; 
			
			if($row[2] == '0'){
				$defaultfirstformval	=	'';
			}
			else if($row[2] == '1'){
				$defaultfirstformval	=	'Long Form';
			}
			else if($row[2] == '2'){
				$defaultfirstformval	=	'Quick Form';
			}
					
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$defaultfirstformval; 
			$grid[$j][3]=$this->convertSpecChars($row[3]); 
			$grid[$j][4]=$this->convertSpecChars($row[4]); 
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			if($row[0] == 1 || $row[0] == 2)
			{
				$grid[$j][8]="";
				$grid[$j][9]="";
			}else
			{
				$grid[$j][8]="<a href=javascript:aobformPreview('".$aoburl."')>View Web Form</a>";
				$grid[$j][9]="<a href=javascript:copyAobformURL('".$aoburl."')>Copy Web Form URL</a>";
			}		
			$grid[$j][10] = "forms_order.php?mode=mbi&fgsno=".$row[0];
			$j++;
		}
		return $grid;
	}
	
	// Function to get the list of forms mapped form groups.
	function getFormGroupForms($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		
		$whereCond = " f.status IN ('Y', 'N')";
	
		$asFields = array("", "f.form_name", "fg.group_name", "cu.name", tzRetQueryStringDTime('f.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('f.mdate','DateTime','/'));
				
		$ssFields = array("", "f.form_name", "fg.group_name", "cu.name", "f.cdate", "mu.name", "f.mdate");
		
		$fgsno = $gridExtraFields['fgsnoval'];
		$mode = $gridExtraFields['modeval'];
		
		if($fgsno != "" && $mode == 'mbi')
		{
			$whereCond .= " AND fg.sno = '".$fgsno."'";
		}
		else if($fgsno != "" && $mode == 'nmbi')
		{					
			$whereCond .= " AND f.sno NOT IN (SELECT group_id FROM apt_forms WHERE group_id = '".$fgsno."')";
		}
		
	    $tque= "SELECT count(DISTINCT f.sno) 
				FROM apt_forms f
				LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id AND ff.status = 'A'
				LEFT JOIN apt_forms_groups fg ON fg.sno	= ff.group_id
				LEFT JOIN users cu ON cu.username = f.cuser
				LEFT JOIN users mu ON mu.username = f.muser	
				WHERE ".$whereCond;	
		
	
		$oque="SELECT f.sno, f.form_name, 
					  GROUP_CONCAT(fg.group_name SEPARATOR ', ') as group_name, cu.name,
					  ".tzRetQueryStringDTime('f.cdate','DateTime','/')." AS cdate,
					  mu.name, ".tzRetQueryStringDTime('f.mdate','DateTime','/')." AS mdate, fg.sno
					FROM apt_forms f
					LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id AND ff.status = 'A'
					LEFT JOIN apt_forms_groups fg ON fg.sno	= ff.group_id			
					LEFT JOIN users cu ON cu.username = f.cuser
					LEFT JOIN users mu ON mu.username = f.muser		
					WHERE ".$whereCond."					
					";
		
		$gstr = "GROUP BY f.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		$gridData=$gd->buildFormGroupForms($oque,$btsno,$mode);
		$total=$gd->getTotalRows($tque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;		
	}
	
	// function to get set of form id depending on the form group	
	function getFormsetchk($fsno){
			global $db;
			$selQry = "SELECT GROUP_CONCAT(group_id SEPARATOR ',') FROM apt_formsgroups_forms WHERE status = 'A' and form_id = ".$fsno."";
			$res = mysql_query($selQry,$db);
			$return = '';
			if(mysql_num_rows($res) > 0 ){
				$row = mysql_fetch_row($res);
				$return = $row[0];
			}	

			if($return !=''){
			
				$selswQry = "SELECT COUNT(*) as count FROM seo_websites WHERE apt_group_id IN  (".$return.")";
				$ressw = mysql_query($selswQry,$db);
				$swrow = mysql_fetch_row($ressw);
				$swchk = $swrow[0];
				
				$selhjQry = "SELECT COUNT(*) as count FROM hotjobs WHERE apt_group_id IN  (".$return.")";
				$reshj = mysql_query($selhjQry,$db);
				$hjrow = mysql_fetch_row($reshj);
				$hjchk = $hjrow[0];
				
				$ajselQry = "SELECT COUNT(*) as count FROM api_jobs WHERE apt_group_id IN  (".$return.")";
				$ajres = mysql_query($ajselQry,$db);
				$ajrow = mysql_fetch_row($ajres);
				$ajchk = $ajrow[0];
				
				$jpselQry = "SELECT COUNT(*) as count FROM jobposting_pref WHERE apt_group_id IN  (".$return.")";
				$jpres = mysql_query($jpselQry,$db);
				$jprow = mysql_fetch_row($jpres);
				$jpchk = $jprow[0];
				if($swchk > 0 || $hjchk > 0 || $ajchk > 0 || $jpchk > 0){
				  $formchk = 'yes';
				}
			}else{
			    $formchk = 'no';
			}
			return $formchk;
	}
	
	// Function to build the list of forms.
	function buildFormGroupForms($que,$btsnoval,$modeval)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{

				$chboxValues = $row[0];
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
				
				
				$grid[$j][1]=$this->convertSpecChars($row[1]); 
				$grid[$j][2]=$this->convertSpecChars($row[2]); 
				$grid[$j][3]=$this->convertSpecChars($row[3]); 
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
				$grid[$j][6]=$this->convertSpecChars($row[6]);
                $grid[$j][7]="";
				$grid[$j][8] = $row[0];
                $grid[$j][9] = "editform.php?addr=".$row[0];				
				$j++;
		}
		return $grid;
	}
	
	// Function to get the list of forms.
	function getForms($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		
		$whereCond = " f.status IN ('Y', 'N')";
	
		$asFields = array("", "f.form_name","cu.name", tzRetQueryStringDTime('f.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('f.mdate','DateTime','/'));
				
		$ssFields = array("", "f.form_name","cu.name", "f.cdate", "mu.name", "f.mdate");
		
		$tque="SELECT count(DISTINCT f.sno) FROM apt_forms f 
		       LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id and ff.status = 'A'
		       LEFT JOIN users cu ON cu.username = f.cuser
			   LEFT JOIN users mu ON mu.username = f.muser 
			   WHERE ".$whereCond;
	
		$oque="SELECT f.sno, f.form_name,
					  cu.name,
					  ".tzRetQueryStringDTime('f.cdate','DateTime','/')." AS cdate,
					  mu.name,
					  ".tzRetQueryStringDTime('f.mdate','DateTime','/')." AS mdate					  
					FROM apt_forms f		
                    LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id and ff.status = 'A'					
					LEFT JOIN users cu ON cu.username = f.cuser
					LEFT JOIN users mu ON mu.username = f.muser                   				
					WHERE ".$whereCond."					
					";
		
		$gstr = " GROUP BY f.sno";
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		
		$gridData=$gd->buildForms($oque);
		$total=$gd->getTotalRows($tque);
		$objResponse = new xajaxResponse();		
		
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;		
	}
	
	// Function to build the list of forms.
	function buildForms($que,$btsnoval,$modeval)
	{
		global $db;
		$j=0;
		$grid = array();		
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{

				$chboxValues = $row[0];
				$gd=new gridData();
				$formschk = $gd->getFormsetchk($row[0]);			
				if($formschk == 'yes')
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids_disabled[] OnClick=chk_clearTop() value='".$chboxValues."' disabled ><span class='checkmark'></span></label>"; 
				}
				else
				{
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
				}
				
				$grid[$j][1]=$this->convertSpecChars($row[1]); 
				$grid[$j][2]=$this->convertSpecChars($row[2]); 
				$grid[$j][3]=$this->convertSpecChars($row[3]); 
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
                $grid[$j][6]="";
                 $grid[$j][7] = "editform.php?addr=".$row[0];				
				$j++;
		}
		return $grid;
	}
	
	// Function to get the list of forms with form order.
	function getformsOrder($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
	
		global $db;
		
		$gd=new gridData();
		
		$whereCond = " f.status IN ('Y', 'N') AND ff.status = 'A'";
	
		$asFields = array("", "f.form_name", "fg.group_name", "cu.name", tzRetQueryStringDTime('f.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('f.mdate','DateTime','/'), "ff.form_order");
				
		$ssFields = array("", "f.form_name", "fg.group_name",  "cu.name", "f.cdate", "mu.name", "f.mdate", "ff.form_order");
		
		$fgsno = $gridExtraFields['fgsnoval'];
		$mode = $gridExtraFields['modeval'];
		if($fgsno != "" && $mode == 'mbi')
		{
			$whereCond .= " AND fg.sno = '".$fgsno."'";
		}
		else if($fgsno != "" && $mode == 'nmbi')
		{					
			$whereCond .= " AND f.sno NOT IN (SELECT group_id FROM apt_forms WHERE group_id = '".$fgsno."')";
		}
		
		$tque= "SELECT count(1)
				FROM apt_forms f
				LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id 
				LEFT JOIN apt_forms_groups fg ON fg.sno = ff.group_id
				LEFT JOIN users cu ON cu.username = f.cuser
				LEFT JOIN users mu ON mu.username = f.muser
				WHERE ".$whereCond;
	
		$oque="SELECT f.sno, f.form_name,  
				  GROUP_CONCAT(fg.group_name SEPARATOR ', ') as group_name, cu.name,			  
				  ".tzRetQueryStringDTime('ff.created_date','DateTime','/')." AS cdate,
				  mu.name,
				  ".tzRetQueryStringDTime('f.mdate','DateTime','/')." AS mdate, ff.form_order,	  
				  fg.sno as group_id
				FROM apt_forms f
				LEFT JOIN apt_formsgroups_forms ff ON f.sno = ff.form_id 
				LEFT JOIN apt_forms_groups fg ON fg.sno = ff.group_id
				LEFT JOIN users cu ON cu.username = f.cuser
				LEFT JOIN users mu ON mu.username = f.muser
				WHERE ".$whereCond."					
				";
		
		$gstr = "GROUP BY f.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
	
		$gridData=$gd->buildformsOrder($oque,$btsno,$mode);
		$total=$gd->getTotalRows($tque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;		
	}
	
	// Function to build the list of forms.
	function buildformsOrder($que,$btsnoval,$modeval)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		$num = mysql_num_rows($res);
		while ($row=mysql_fetch_array($res))
		{

				$chboxValues = $row[0];
				
					$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";				
				
				$grid[$j][1]=$this->convertSpecChars($row[1]); 
				$grid[$j][2]=$this->convertSpecChars($row[2]); 
				$grid[$j][3]=$this->convertSpecChars($row[3]); 
				$grid[$j][4]=$this->convertSpecChars($row[4]);
				$grid[$j][5]=$this->convertSpecChars($row[5]);
				$grid[$j][6]=$this->convertSpecChars($row[6]);

				if($row[7] !='' )
				{
				
				if($num == 1){
				$htmlappend = "";
				}
				else if($j == 0){
				$htmlappend = "<span onclick=changeOrder(".$row[0].",".$j.",".$row[7].",".$row[8].",'d'); style='padding-top:5px;padding-left:44px;' class='orderarrow' title='click here to decrease the Form order'><i class='fa fa-arrow-down' aria-hidden='true'></i></span>";
				}
				else if($j == ($num - 1)){
				
				$htmlappend = "<span onclick=changeOrder(".$row[0].",".$j.",".$row[7].",".$row[8].",'a');  class='orderarrow' style='padding-left:30px;' title='click here to increase the Form order'><i class='fa fa-arrow-up' aria-hidden='true'></i></span>";
				}
				else{
				 $htmlappend = "<span onclick=changeOrder(".$row[0].",".$j.",".$row[7].",".$row[8].",'a');  class='orderarrow' style='padding-left:30px;padding-top:5px;' title='click here to increase the Form order'><i class='fa fa-arrow-up' aria-hidden='true'></i></span><span onclick=changeOrder(".$row[0].",".$j.",".$row[7].",".$row[8].",'d'); style='padding-left:5px;padding-top:5px;' class='orderarrow' title='click here to decrease the Form order'><i class='fa fa-arrow-down' aria-hidden='true'></i></span>";				    
				}
				$grid[$j][7]= $htmlappend;
				}				
                $grid[$j][8] = "";				
                $grid[$j][9] = "editform.php?addr=".$row[0];				
				$j++;
		}
		return $grid;
	}
	
	//This is to display the student name for Theraphy Source
	function getPersonDetails($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		if($gridSearchFields[3] != "") 
		{
			$stg_flag		= ($gridSearchFields[3] == 'Active') ? 'Active' : 'Inactive';
			$whereCond	= " AND pi.status  = '".$stg_flag."' ";
			$gridSearchFields[3]	= "";
		}
		else {
			$whereCond = " AND pi.status IN ('Active', 'Inactive') ";
		}
		//$whereCond = " AND pi.status IN ('Active', 'Inactive') ";
	
		$asFields = array("", "pi.person_id", "pi.fname", "pi.lname","pi.status", "us.name", tzRetQueryStringDTime('pi.mdate','DateTime','/'));
				
		$ssFields = array("", "pi.person_id", "pi.fname",  "pi.lname", "pi.status",  "us.name", "pi.mdate");
		
		$compid = $gridExtraFields['compid'];
		$joblocid = $gridExtraFields['joblocid'];
		$from = $gridExtraFields['from'];
		$person_ids = $gridExtraFields['personids'];

		if($compid != "" && $joblocid != "")
		{
			
			$whereCond .= " AND pi.location_id='".$joblocid."' AND pi.hjobs_compid='".$compid."' AND person_type='".$from."'";
		}
		if($person_ids !=""){
			//$whereCond .= " AND pi.sno NOT IN (".$person_ids.")";
		}	
		$tque="SELECT count(1) 
			FROM person_info pi 
			LEFT JOIN users us ON(us.username = pi.muser) 
			WHERE 1=1 ".$whereCond;
	
		$oque="SELECT pi.sno,pi.person_id,pi.fname,pi.lname,pi.status,us.name,".tzRetQueryStringDTime('pi.mdate','DateTime','/')." AS mdate,pi.location_id,'".$person_ids."' AS selectedPersonIds 
			FROM person_info pi 
			LEFT JOIN users us ON(us.username = pi.muser) 
			WHERE 1=1 ".$whereCond." ";
		
		$gstr = "GROUP BY pi.sno";
		$grp_str	= "";
		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr1	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$ostr = str_replace($ssFields,"trim"."(".$ssFields[$gridSortCol].")",$ostr);
		$tque	= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count= "$oque $qstr $grp_str $qstr1 $ostr";
		$total	= $gd->getTotalCount($oque_Count);
		$oque	= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		
		$gridData	= $gd->buildPersonDetails($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
	
	// Function to build the list of burden items.
	function buildPersonDetails($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{	
			$chboxValues = $row[0];
			$name="name=auids[]";
			if(!empty($row[8])) {
				$person_id = explode(",",$row[8]);
				if(in_array($row[0],$person_id)){
					$isdisabled ="disabled='disabled'";
					$name="name=auids_disabled[]";
				}
			}
			$grid[$j][0]="<label class='container-chk'><input type=checkbox ".$isdisabled." ".$name." OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); 
			$grid[$j][2]=$this->convertSpecChars($row[2]); 
			$grid[$j][3]=$this->convertSpecChars($row[3]); 
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7] = "";
			$grid[$j][8] = "/BSOS/Accounting/Time_Mngmt/Custom_Timesheet/addEditCustomName.php?studSno=".$row[0]."&type=edit&locid=".$row[7];	
			$j++;
			$isdisabled='';
		}
		return $grid;
	}
	//This is to display the Custom Type for Theraphy Source
	function getCustomTypeDetails($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
		//print_r($gridSearchFields);
		$whereCond	="";
		if($gridSearchFields[0] != "") 
		{
			$whereCond.= " AND type_name  LIKE '%".$gridSearchFields[0]."%' ";
			$gridSearchFields[0]	= "";
		}
		if($gridSearchFields[1] != "") 
		{
			
			$whereCond.= " AND code  LIKE '%".$gridSearchFields[1]."%' ";
			$gridSearchFields[1]	= "";
		}
		if($gridSearchFields[3] != "") 
		{
			
			$whereCond.= " AND uss.name  LIKE '%".$gridSearchFields[3]."%' ";
			$gridSearchFields[3]	= "";
		}
		
		if($gridSearchFields[5] != "") 
		{
			
			$whereCond.= " AND us.name  LIKE '%".$gridSearchFields[5]."%' ";
			$gridSearchFields[5]	= "";
		}
		
		
		$asFields = array("","type_name", "code","","uss.name", tzRetQueryStringDTime('ct.cdate','DateTime','/') , "us.name", tzRetQueryStringDTime('ct.mdate','DateTime','/'));
				
		$ssFields = array("","type_name","code","",3, "cdate", 5, "mdate");
		if($gridSearchFields[4] != "") 
		{
			
			$whereCond.= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);			
			$gridSearchFields[4]	= "";
		}
		if($gridSearchFields[6] != "") 
		{
			
			$whereCond.= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			$gridSearchFields[6]	= "";
		}
		
		$compid = $gridExtraFields['compid'];
		$joblocid = $gridExtraFields['joblocid'];
		$type_ids = $gridExtraFields['typeids'];

		$custTypeids ='';
		if ($type_ids !=0) {
			$custTypeids = $type_ids;
		}
	
		$oque="SELECT
				ct.sno,ct.type_name,ct.code,uss.name,".tzRetQueryStringDTime('ct.cdate','DateTime','/')." AS cdate,us.name,".tzRetQueryStringDTime('ct.mdate','DateTime','/')." AS mdate,'".$custTypeids."' AS CustomTypeId,
				(
					SELECT GROUP_CONCAT(DISTINCT(th.cust_type)) FROM timesheet_hours th 
					WHERE th.cust_type !=0 
				) AS timesheetTypeIds,ct.type_display AS displayStatus
				FROM custom_type ct
				LEFT JOIN users us ON(us.username = ct.muser) 
				LEFT JOIN users uss ON(uss.username = ct.cuser) 
				WHERE 1=1 AND ct.status IN ('Active')   
				AND ct.type_display ='Y' ".$whereCond." 

				UNION 

				SELECT
				ct.sno,ct.type_name,ct.code,uss.name,".tzRetQueryStringDTime('ct.cdate','DateTime','/')." AS cdate,us.name,".tzRetQueryStringDTime('ct.mdate','DateTime','/')." AS mdate ,'".$custTypeids."' AS CustomTypeId,
				(
					SELECT GROUP_CONCAT(DISTINCT(th.cust_type)) FROM timesheet_hours th 
					WHERE th.cust_type !=0 
				) AS timesheetTypeIds,ct.type_display AS displayStatus
				FROM custom_type ct
				LEFT JOIN users us ON(us.username = ct.muser) 
				LEFT JOIN users uss ON(uss.username = ct.cuser) 
				JOIN custom_type_assoc cta ON (cta.type_id = ct.sno AND cta.hjobs_compid='".$compid."' AND cta.location_id
				='".$joblocid."')
				WHERE 1=1 AND ct.status IN ('Active')   
				AND ct.type_display ='N' ".$whereCond;
		
		$grp_str = "GROUP BY ct.sno";
		$tque="SELECT count(1) FROM (".$oque.") DUMMY WHERE 1=1";

		//$grp_str	= "";
		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr1	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque	= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count= "$oque $qstr $grp_str $qstr1 $ostr";
		$total	= $gd->getTotalCount($oque_Count);
		$oque	= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		
		$gridData	= $gd->buildCustomTypeDetails($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
	
	// Function to build the list of Custom Type items.
	function buildCustomTypeDetails($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{	
			$chboxValues = $row[0];
			$name="name=auids[]";
			if(!empty($row[7])) {
				$type_id = explode(",",$row[7]);
				if(in_array($row[0],$type_id)){
					$isdisabled ="disabled='disabled'";
					$name="name=auids_disabled[]";
				}
			}
			if(!empty($row[8])) {
				$cust_type_id = explode(",",$row[8]);
				if(in_array($row[0],$cust_type_id)){
					$isdisabled ="disabled='disabled'";
					$name="name=auids_disabled[]";
				}
			}
			$customerForAll = "";
			if(!empty($row[9]) && $row[9]=='Y') {
				$customerForAll = "<span style='margin:8px 33px 0px;position:absolute;'><i class='fa fa-check-square-o'></i></span>";
			}

			$grid[$j][0]="<label class='container-chk'><input type=checkbox ".$isdisabled." ".$name." OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); // type_name
			$grid[$j][2]=$this->convertSpecChars($row[2]); // type code
			$grid[$j][3] = $customerForAll;
			$grid[$j][4]=$this->convertSpecChars($row[3]); // created user
			$grid[$j][5]=$this->convertSpecChars($row[4]); // created date
			$grid[$j][6]=$this->convertSpecChars($row[5]); // modified user
			$grid[$j][7]=$this->convertSpecChars($row[6]); // modified date
			$grid[$j][8] = "";
			$grid[$j][9] = $this->convertSpecChars($row[0]);
			$j++;
			$isdisabled='';
		}
		return $grid;
	}

	function getPayBatches($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("b.sno","b.mpbnum","b.paybtype","b.paybname",tzRetQueryStringDate('b.paydate','Date','/'),"b.gpamount","c.name",tzRetQueryStringDate('b.cdate','DateTime','/'),"b.process",tzRetQueryStringDate('b.pdate','DateTime','/'));
		$ssFields = array("b.sno","b.mpbnum","b.paybtype","b.paybname","b.paydate","b.gpamount","c.name","b.cdate","b.process","b.pdate");

		$tque="SELECT COUNT(1) FROM mpHR_payUnitBatch b LEFT JOIN users c ON c.username=b.cuser LEFT JOIN mpHR_payGroups g ON b.sno=g.parid LEFT JOIN apUsers a ON FIND_IN_SET(g.locid,a.locids) WHERE 1=1 AND a.username='$username' ";
		$oque="SELECT b.sno, b.mpbnum, b.paybtype, b.paybname, ".tzRetQueryStringDate('b.paydate','Date','/').",b.gpamount,c.name,".tzRetQueryStringDate('b.cdate','DateTime','/').", b.process, ".tzRetQueryStringDate('b.pdate','DateTime','/')." FROM mpHR_payUnitBatch b LEFT JOIN users c ON c.username=b.cuser LEFT JOIN mpHR_payGroups g ON b.sno=g.parid LEFT JOIN apUsers a ON FIND_IN_SET(g.locid,a.locids) WHERE 1=1 AND a.username='$username' ";

		$gstr = "GROUP BY b.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildPayBatches($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildPayBatches($que)
	{
		global $db,$pstatus;

		$pstatus = array('S' => 'Saved', 'N' => 'Scheduled','I' => 'Initiated','F' => 'Batch Creation Failed', 'P' => 'Pushed - Partial Failure', 'C' => 'Pushed - Data Conflicts', 'Y' => 'Pushed - Complete');

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[8]=="N" || $row[8]=="F" || $row[8]=="S")
				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] value='".$row[0]."'><span class='checkmark'></span></label>";
			else
				$grid[$j][0] = "&nbsp;";

			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($pstatus[$row[8]]);
			$grid[$j][9] = $this->convertSpecChars($row[9]);

			if($row[2]=="Quick")
				$grid[$j][10] = "showqdata.php?sno=".$row[0];
			else
				$grid[$j][10] = "showbdata.php?sno=".$row[0];
			$j++;
		}

		return $grid;
	}

	function getPayGroups($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("b.sno","CONCAT(l.loccode,' - ',l.heading)","b.payunit",tzRetQueryStringDate('b.paysdate','Date','/'),tzRetQueryStringDate('b.payedate','Date','/'),"c.name",tzRetQueryStringDate('b.cdate','DateTime','/'),"m.name",tzRetQueryStringDate('b.pdate','DateTime','/'));
		$ssFields = array("b.sno","CONCAT(l.loccode,' - ',l.heading)","b.payunit","b.paysdate","b.payedate","c.name","b.cdate","m.name","b.pdate");

		$tque="SELECT COUNT(1) FROM contact_manage l, mpHR_payGroups b LEFT JOIN users c ON c.username=b.cuser LEFT JOIN users m ON m.username=b.muser LEFT JOIN apUsers a ON FIND_IN_SET(b.locid,a.locids) WHERE FIND_IN_SET(l.serial_no,b.locid) AND b.parid=0 AND a.username='$username' ";
		$oque="SELECT b.sno, GROUP_CONCAT(CONCAT(l.loccode,' - ',l.heading)), b.payunit, ".tzRetQueryStringDate('b.paysdate','Date','/').",".tzRetQueryStringDate('b.payedate','Date','/').",c.name,".tzRetQueryStringDate('b.cdate','DateTime','/').", m.name, ".tzRetQueryStringDate('b.pdate','DateTime','/').",b.parid FROM contact_manage l, mpHR_payGroups b LEFT JOIN users c ON c.username=b.cuser LEFT JOIN users m ON m.username=b.muser LEFT JOIN apUsers a ON FIND_IN_SET(b.locid,a.locids) WHERE FIND_IN_SET(l.serial_no,b.locid) AND b.parid=0 AND a.username='$username' ";

		$gstr = "GROUP BY b.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalCount($tque);
		$gridData=$gd->buildPayGroups($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildPayGroups($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			if($row[9]==0)
				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] value='".$row[0]."'><span class='checkmark'></span></label>";
			else
				$grid[$j][0] = "&nbsp;";

			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);
			$grid[$j][9] = $this->convertSpecChars($row[9]);
			$grid[$j][10] = "showpdata.php?sno=".$row[0];

			$j++;
		}

		return $grid;
	}


	function getAkkuPayUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","hg.name","ap.userid","uc.name",tzRetQueryStringDate('ap.cdate','Date','/'),"um.name",tzRetQueryStringDate('ap.mdate','Date','/'));
		$ssFields = array("","hg.name","ap.userid","uc.name","vi.cdate","um.name","ap.mdate");

		$tque="SELECT COUNT(1) FROM apUsers ap LEFT JOIN users hg ON hg.username=ap.username LEFT JOIN users uc ON uc.username=ap.cuser LEFT JOIN users um ON um.username=ap.muser WHERE ap.status='A'";
		$oque="SELECT ap.sno, hg.name, ap.userid, uc.name, ".tzRetQueryStringDate('ap.cdate','Date','/').", um.name, ".tzRetQueryStringDate('ap.mdate','Date','/')." FROM apUsers ap LEFT JOIN users hg ON hg.username=ap.username LEFT JOIN users uc ON uc.username=ap.cuser LEFT JOIN users um ON um.username=ap.muser WHERE ap.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAkkuPayUsers($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildAkkuPayUsers($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = "editap.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}

	function getAreaCodeRadiusPSM($sno,$dbTable,$areaCodeSearchMiles,$ACR_Session)
	{
		global $db;

		$que = "SELECT hareacode,wareacode,mareacode FROM `".$dbTable."` WHERE sno=".$sno.";";
		$res = mysql_query($que,$db);
		$row = mysql_fetch_assoc($res);
		$acr_distance = "";

		if(isset($_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['hareacode']])){
			$acr_distance = $_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['hareacode']];
		} elseif (isset($_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['wareacode']])) {
			$acr_distance = $_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['wareacode']];
		} elseif(isset($_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['mareacode']])) {
			$acr_distance = $_SESSION[$ACR_Session][$areaCodeSearchMiles][$row['mareacode']];
		} else {
			$acr_distance = "";
		}

		return $acr_distance;
	}
	function getAdminAkkenbiManagementData($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone,$acctype;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		
			$asFields=array("","emp_list.name","users.userid","users.usertype","department.deptname",tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/"),tzRetQueryStringDTime("max(userlog_acc.last_access)","DateTime","/"),tzRetQueryStringDTime("users.cdate","DateTime","/"),"create_user.name",tzRetQueryStringDTime("users.um_mdate","DateTime","/"),"modified_user.name");
			$ssFields=array("","TRIM(users.name)","users.userid","users.usertype","department.deptname","max(userlog_acc.last_login)","max(userlog_acc.last_access)","users.cdate","create_user.name","users.um_mdate","modified_user.name","","","","","","","");

			if($acctype=="PUS" || $acctype=="")
			{
				$tque="SELECT count(1) CNT FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username AND hrcon_compen.ustatus='active' LEFT JOIN department ON hrcon_compen.dept = department.sno LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN bi_pref ON bi_pref.username = users.username
					LEFT JOIN users modified_user ON bi_pref.modified_user = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype!=''";
				$oque="SELECT emp_list.sno SNO,
				       emp_list.username,
				       emp_list.name,
				       department.deptname,
				       users.type,
				       users.userid,
				       sysuser.collaboration,
				       users.last_login,
				       ".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",".tzRetQueryStringDTime('users.cdate','DateTime','/').",create_user.name,".tzRetQueryStringDTime('bi_pref.mdate','DateTime','/').",modified_user.name, users.usertype 
					FROM emp_list 
					LEFT JOIN sysuser ON emp_list.username = sysuser.username
					LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username AND hrcon_compen.ustatus='active' 
					LEFT JOIN department ON hrcon_compen.dept = department.sno 
					LEFT JOIN users ON emp_list.username = users.username 
					LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username 
					LEFT JOIN users create_user ON users.um_cuser = create_user.username 
					LEFT JOIN bi_pref ON bi_pref.username = users.username
					LEFT JOIN users modified_user ON bi_pref.modified_user = modified_user.username
					WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' 
					AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype!=''";
			}
			else
			{
				$tque="SELECT count(1) CNT FROM emp_list LEFT JOIN sysuser ON emp_list.username = sysuser.username LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username AND hrcon_compen.ustatus='active' LEFT JOIN department ON hrcon_compen.dept = department.sno LEFT JOIN users ON emp_list.username = users.username LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username LEFT JOIN users create_user ON users.um_cuser = create_user.username LEFT JOIN bi_pref ON bi_pref.username = users.username
					LEFT JOIN users modified_user ON bi_pref.modified_user = modified_user.username WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype='$acctype'";
				$oque="SELECT emp_list.sno SNO,
				       emp_list.username,
				       emp_list.name,
				       department.deptname,
				       users.type,
				       users.userid,
				       sysuser.collaboration,
				       users.last_login,
				       ".tzRetQueryStringDTime("max(userlog_acc.last_login)","DateTime","/").",".tzRetQueryStringDTime("max(userlog_acc.last_access)", "DateTime","/").",".tzRetQueryStringDTime('users.cdate','DateTime','/').",create_user.name,".tzRetQueryStringDTime('bi_pref.mdate','DateTime','/').",modified_user.name, users.usertype 
					FROM emp_list 
					LEFT JOIN sysuser ON emp_list.username = sysuser.username
					LEFT JOIN hrcon_compen ON emp_list.username = hrcon_compen.username AND hrcon_compen.ustatus='active' 
					LEFT JOIN department ON hrcon_compen.dept = department.sno 
					LEFT JOIN users ON emp_list.username = users.username 
					LEFT JOIN userlog_acc ON emp_list.username=userlog_acc.username 
					LEFT JOIN users create_user ON users.um_cuser = create_user.username 
					LEFT JOIN bi_pref ON bi_pref.username = users.username
					LEFT JOIN users modified_user ON bi_pref.modified_user = modified_user.username
					WHERE emp_list.lstatus != 'DA' AND emp_list.lstatus != 'INACTIVE' 
					AND users.type IN ('sp', 'PE', 'consultant') AND users.status != 'DA' AND users.usertype='$acctype'";
			}
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		if($acctype=="APP")
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		else
			$qstr=$gd->buildQSTRForAdmin($gridSearchType,$gridSearchFields,$asFields);

		if($qstr!="")
		{
			if ($gridSearchFields[4]=="" && $gridSearchFields[5]=="")
				$qstr.=" group by users.username";
		}
		else
		{
			$oque.=" group by users.username";
			$tque.=" group by users.username";
		}

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);

        $tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);

        $gridData=$gd->buildAdminAkkenbiManagementData($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$oque);

        return $objResponse;
    }
	
	function buildAdminAkkenbiManagementData($que)
	{
		global $maildb,$db,$acctype;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
            
				if($row[14]=="FO")
					$row[14]="Front Office User";
				else if($row[14]=="BO")
					$row[14]="Back Office User";
				else
					$row[14]="The all in User";

                $grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop();' value=".$row[1]."><span class='checkmark'></span></label>";
                $grid[$j][1]=$this->convertSpecChars($row[2]);
                $grid[$j][2]=$this->convertSpecChars($row[5]);
                $grid[$j][3]=$this->convertSpecChars(trim($row[14]));
                $grid[$j][4]=$this->convertSpecChars($row[3]);
                $grid[$j][5]=$this->convertSpecChars(trim($row[8]));
                $grid[$j][6]=$this->convertSpecChars(trim($row[9]));
				$grid[$j][7]=$this->convertSpecChars(trim($row[10]));
				$grid[$j][8]=$this->convertSpecChars(trim($row[11]));
				$grid[$j][9]=$this->convertSpecChars(trim($row[12]));
				$grid[$j][10]=$this->convertSpecChars(trim($row[13]));
                $grid[$j][11]="<a href=javascript:doEditBI(".$row[1].")><img src=/BSOS/images/icons/preferences.gif title='AkkuReporting Preferences' border=0></a>";
    			$grid[$j][12]="";

    			$j++;
		}
		return $grid;
	}
function getEmployeeShiftAvailability($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{	
		
		global $db,$username;

		if($gridSortCol=="")
			$gridSortCol=0;

		$gd=new gridData();

		$asFields=array("","empl.name");
		$ssFields=array("","TRIM(empl.name)");
		
		$sel_assign_dates_array = $gridExtraFields['sel_assign_dates_array'];						
		$pid = $gridExtraFields['pid'];
		$tab = $gridExtraFields['tab'];
		$assignment_emp_username = $gridExtraFields['assignment_emp_username'];
		
		$emplist_for_sel_dates_qry ="select empl.username,empl.name,empl.sno,substring(cand.username,5) as cand_id from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE')";
		
		$res=mysql_query($emplist_for_sel_dates_qry,$db);
		$empid_array = array();
		$all_empid_array = array();
		while ($row=mysql_fetch_array($res))
		{
			if($assignment_emp_username!=$row[0])
			{
				$all_empid_array[]	= "'".$row[0]."'";
			}
			$employee_shift_avail = $gd->getEmployeeMatchingReassignDatesCount($pid,$row[0],$sel_assign_dates_array);
			
			if($employee_shift_avail == 1){
				$empid_array[] = "'".$row[0]."'";				
			}
		}
		
		$emp_ids = implode(",",$empid_array);
		if($tab == "all")
		{
			$emp_ids = implode(",",$all_empid_array);
		}
		
		$oque="select empl.username,empl.name,empl.sno,substring(cand.username,5) as cand_id from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE') AND empl.username IN(".$emp_ids.")";

		$tque="SELECT count(1) CNT from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE') AND empl.username IN(".$emp_ids.")"; 
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
	
		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}
		$gridData=$gd->buildEmployeeShiftAvailability($oque,$gridExtraFields);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
	}
	function getEmployeeMatchingReassignDatesCount($pid,$employee_username,$sel_assign_dates){
		
		global $db;
		
		foreach ($sel_assign_dates as $Datevalue) {
			$shift_starttime = $Datevalue[0];
			$shift_endtime = $Datevalue[1];
			$whereCond_match_shift = " AND (UNIX_TIMESTAMP('".$shift_starttime."') BETWEEN UNIX_TIMESTAMP(emsl.shift_starttime) AND  UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_endtime."') BETWEEN UNIX_TIMESTAMP(emsl.shift_starttime) AND UNIX_TIMESTAMP(emsl.shift_endtime)) ";
			
			$emp_avail_check_qry = "SELECT COUNT(1) as avail_count
									FROM emp_list as econ
									INNER JOIN hrcon_sm_timeslots AS emsl ON(emsl.username = econ.username)
									WHERE  econ.username = '".$employee_username."' AND emsl.shift_status ='available' ".$whereCond_match_shift."";		
			$avail_qry_res = mysql_query($emp_avail_check_qry,$db);			
			$result_cnt = mysql_fetch_row($avail_qry_res);
			if($result_cnt[0] > 0){
				$avail_count = 1;
			}else{
				return 0;
			}
		}
		return $avail_count;
	}
	
	function buildEmployeeShiftAvailability($que,$gridExtraFields)
	{ 
		global $db;

		$j=0;
		$grid=array();
		$gd=new gridData();
		$res=mysql_query($que,$db);
		 $k =1;   
		$sel_assign_dates_arr = explode(',',$gridExtraFields['sel_assign_dates']);
		$sel_assign_dates = implode("','",$sel_assign_dates_arr);						
		$pid = $gridExtraFields['pid'];
		$tab = $gridExtraFields['tab'];
		 
		$shiftid_qry = "SELECT shiftColor FROM shift_setup WHERE sno = '".$gridExtraFields['shift_id']."'  "; 
		$shiftid_qry_res =  mysql_query($shiftid_qry,$db);
		$shift_array = 	mysql_fetch_row($shiftid_qry_res);
		$temp_color = $shift_color = $shift_array[0];
		
		while ($row=mysql_fetch_array($res))
		{ 	
			$employee_shift_avail =array();		
			$employee_shift_avail =array();
			$grid[$j][0] ="<input type=hidden name=empsno[] value='".$row[2]."'><label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='' value='".$row[0]."'><span class='checkmark'></span></label><input type=hidden name=empids[] value='".$this->convertSpecChars($row[1])."'><input type=hidden name=candids[] value='".$row[3]."'><input type=hidden name=avail_stat[] value=''>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);

			$k =0;
			
			$assignment_info_qry = "SELECT DATE_FORMAT(shift_date,'%m/%d/%Y') as shift_date ,shift_starttime,shift_endtime FROM hrconjob_sm_timeslots WHERE DATE_FORMAT(shift_date,'%m/%d/%Y') IN ('".$sel_assign_dates."') AND pid ='".$pid."' order by shift_date ASC "; 
			$assignment_info_res =  mysql_query($assignment_info_qry,$db);
			
			while($emp_row = mysql_fetch_array($assignment_info_res)){

				$grid[$j][$k+2] = "";
				$empuser = $row[0];

				if($empuser != ""){
					
					if($tab == "all")
					{						
						$whereCond_match_shift = " AND (
						(
							(UNIX_TIMESTAMP('".$emp_row[1]."') > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_endtime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP('".$emp_row[2]."') < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_starttime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') <= UNIX_TIMESTAMP(cst.shift_starttime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') >= UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_starttime))
						)
						OR
						(UNIX_TIMESTAMP('".$emp_row[1]."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[2]."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime))
						) ";
						
						$check_emp_availability = "SELECT cst.shift_status FROM hrcon_sm_timeslots AS cst WHERE cst.username ='".$empuser."' AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$emp_row[0]."')".$whereCond_match_shift;
						
						$check_emp_availability_res 	= mysql_query($check_emp_availability,$db);
						$no_of_rows			= mysql_num_rows($check_emp_availability_res);
						
						if($no_of_rows>0)
						{
							$avalability_exists = false;
							$shift_color		= $temp_color;		
							while($check_emp_availability_row = mysql_fetch_row($check_emp_availability_res))
							{

								if($check_emp_availability_row[0]=="available")
								{
									$avalability_exists = true;
									
								}

							}
							if($avalability_exists==false)
							{
								//applyiing shift color as white if employee schedule is not available
								$shift_color = "#FFFFFF";
							}
							
						}
						else
						{
							//applyiing shift color as white if employee schedule is not available
							$shift_color = "#FFFFFF";
						}
						
					}

					$grid[$j][$k+2] = "<div id='avail_status' style='background-color:{$shift_color};display: inline-block;width: 100px;height: 100%'></div>";
					
				}else{					
					$grid[$j][$k+2] = "";
				}
				$k++;
			}		
    		
			$j++;
		
		}
		return $grid;
	}
	
	
	
	

	//This is to display the student name for Theraphy Source
	function getReasonCodes($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();	
		$whereCond ='';
		if ($gridSearchFields[2] == "all") {
			$whereCond =" AND rc.type IN('reasoncode','cancelcode') ";
			$gridSearchFields[2] ="";
		}elseif ($gridSearchFields[2] == "reasoncode") {
			$whereCond =" AND rc.type IN('reasoncode') ";
			$gridSearchFields[2] ="";
		}elseif ($gridSearchFields[2] == "cancelcode") {
			$whereCond =" AND rc.type IN('cancelcode') ";
			$gridSearchFields[2] ="";
		}

		$asFields = array("", "rc.reason", "rc.reason_description","rc.type", "uss.name",tzRetQueryStringDTime('rc.cdate','DateTime','/'), "us.name", tzRetQueryStringDTime('rc.mdate','DateTime','/'));
				
		$ssFields = array("", "rc.reason", "rc.reason_description","rc.type", "uss.name", "rc.cdate", "us.name", "rc.mdate");
		
		
		$tque="SELECT count(1) 
			FROM reason_codes rc 
			LEFT JOIN users us ON(us.username = rc.muser)
			LEFT JOIN users uss ON(uss.username = rc.cuser) 
			WHERE rc.status='ACTIVE' ".$whereCond;
	
		$oque="SELECT rc.sno,rc.reason,rc.reason_description,uss.name,".tzRetQueryStringDTime('rc.cdate','DateTime','/')." AS cdate,us.name,".tzRetQueryStringDTime('rc.mdate','DateTime','/')." AS mdate,rc.type
			FROM reason_codes rc 
			LEFT JOIN users us ON(us.username = rc.muser)
			LEFT JOIN users uss ON(uss.username = rc.cuser)
			WHERE rc.status='ACTIVE' ".$whereCond." ";
		
		$gstr = "GROUP BY rc.sno";
		
		$grp_str	= "";
		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr1	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque	= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count= "$oque $qstr $grp_str $qstr1 $ostr";
		$total	= $gd->getTotalCount($oque_Count);
		$oque	= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		
		$gridData	= $gd->buildReasonCodes($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}
	
	// Function to build the list of burden items.
	function buildReasonCodes($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{	
			if ($row[7] == 'reasoncode') {
				$reasonCancelCodes = 'ReasonCode';
			}elseif ($row[7] == 'cancelcode') {
				$reasonCancelCodes = 'CancelCode';
			}else{
				$reasonCancelCodes = '';
			}
			
			$chboxValues = $row[0];
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); 
			$grid[$j][2]=$this->convertSpecChars(substr(stripslashes($row[2]), 0, 100)); 
			$grid[$j][3]=$this->convertSpecChars($reasonCancelCodes); 
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);

			$grid[$j][8] = $row[0];
			$j++;
			$isdisabled='';
		}
		return $grid;
	}
function getEmployeeAvailability($empuser,$shift_date,$shift_starttime,$shift_endtime){
	global $db;
	
		
	$whereCond_match_shift = " AND (((UNIX_TIMESTAMP('".$shift_starttime."') > UNIX_TIMESTAMP(emsl.shift_starttime) AND UNIX_TIMESTAMP('".$shift_starttime."') < UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_endtime."') > UNIX_TIMESTAMP(emsl.shift_endtime)) OR (UNIX_TIMESTAMP('".$shift_endtime."') > UNIX_TIMESTAMP(emsl.shift_starttime) AND UNIX_TIMESTAMP('".$shift_endtime."') < UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_starttime."') < UNIX_TIMESTAMP(emsl.shift_starttime)) OR (UNIX_TIMESTAMP('".$shift_endtime."') > UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_starttime."') <= UNIX_TIMESTAMP(emsl.shift_starttime)) OR (UNIX_TIMESTAMP('".$shift_endtime."') >= UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_starttime."') < UNIX_TIMESTAMP(emsl.shift_starttime))) OR (UNIX_TIMESTAMP('".$shift_starttime."') BETWEEN UNIX_TIMESTAMP(emsl.shift_starttime) AND  UNIX_TIMESTAMP(emsl.shift_endtime) AND UNIX_TIMESTAMP('".$shift_endtime."') BETWEEN UNIX_TIMESTAMP(emsl.shift_starttime) AND UNIX_TIMESTAMP(emsl.shift_endtime))) ";
	
		 $emp_avail_check_qry = "SELECT COUNT(1) as avail_count
								FROM empcon_jobs as econ
								LEFT JOIN empconjob_sm_timeslots AS emsl ON(emsl.pid = econ.sno)
								WHERE  DATE_FORMAT(emsl.shift_date,'%m/%d/%Y') IN ('".$shift_date."') 
								AND econ.username = '".$empuser."' ".$whereCond_match_shift."
								
								";
			$avail_qry_res = mysql_query($emp_avail_check_qry,$db);			
			$result_cnt = mysql_fetch_row($avail_qry_res);
			
			
			
		echo $result_cnt[0];
	}
	
		//Time Sheet Load Optimization-
        function buildGridHeadData($qstr,$ostr,$gstr,$gridExtraFields,$timesheetFromDate,$timesheetToDate,$gridSearchFields,$searchFromDate,$searchToDate,$totalSearchCount){
            global $db;
            $printhtml ='';
            $minDateValue = date("Y-m-d",strtotime($timesheetFromDate));
            $maxDateValue = date("Y-m-d",strtotime($timesheetToDate));
            
            if($gridExtraFields['gridTypeValue']=="Accounting_NewTimeSheets"){
                $tque="SELECT ROUND(SUM(t.hours),2)
                        FROM timesheet_hours t
                        LEFT JOIN par_timesheet p ON t.parid=p.sno
                        LEFT JOIN emp_list e ON e.username=p.username
                        LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno
                        WHERE p.rstatus='' AND t.status ='ER' AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' AND p.template IN ('Regular','TimeInTimeOut','Clockinout')";
                $tque.= "$qstr $gstr $ostr";
                $tres=mysql_query($tque,$db);
                if(mysql_num_rows($tres)>1){
                    $total_hours =0;
                    while($row=mysql_fetch_row($tres))
                    {
                    $total_hours+=$row[0];
                    }   
                }else{
                    $trow=mysql_fetch_row($tres);
                    if($trow[0]==""){
                        $total_hours="0:00";
						}
                    else {
                        $total_hours=$trow[0]; 
						}  
                    }
                //UOM  timesheet
                $tque_uom="SELECT ROUND(SUM(t.hours),2)
                        FROM timesheet_hours t
                        LEFT JOIN par_timesheet p ON t.parid=p.sno
                        LEFT JOIN emp_list e ON e.username=p.username
                        LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno
                        WHERE p.rstatus='' AND t.status ='ER' AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' AND p.template IN ('UOM') ";
                $tque_uom.= "$qstr $gstr $ostr";
                $tres_uom=mysql_query($tque_uom,$db);
                if(mysql_num_rows($tres_uom)>1){
                    $totaluom_hours =0;
                    while($row=mysql_fetch_row($tres_uom))
                    {
                    $totaluom_hours+=$row[0];
                    }   
                }else{
                    $trow=mysql_fetch_row($tres_uom);
                    if($trow[0]==""){
                        $totaluom_hours="0:00";
						}
                    else {
                        $totaluom_hours=$trow[0];
						}   
                    }
                //Custom  timesheet
                $tque_custom="SELECT ROUND(SUM(t.hours),2)
                        FROM timesheet_hours t
                        LEFT JOIN par_timesheet p ON t.parid=p.sno
                        LEFT JOIN emp_list e ON e.username=p.username
                        LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno
                        WHERE p.rstatus='' AND t.status ='ER' AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."' AND p.template = 'Custom' ";
                $tque_custom.= "$qstr $gstr $ostr";
                $tres_custom=mysql_query($tque_custom,$db);
                if(mysql_num_rows($tres_custom)>1){
                    $totalcustom_hours =0;
                    while($row=mysql_fetch_row($tres_custom))
                    {
                    $totalcustom_hours+=$row[0];
                    }   
                }else{
                    $trow=mysql_fetch_row($tres_custom);
                    if($trow[0]==""){
                        $totalcustom_hours="0:00";
						}
                    else {
                        $totalcustom_hours=$trow[0]; 
						}  
                    }
                
                 if($this->isSearch($gridSearchFields) && $totalSearchCount>0){
                    $timesheetFromDate = $searchFromDate;
                    $timesheetToDate = $searchToDate;
                }
                
                $printhtml=
                '<tr><td><table width="100%" cellpadding="0" cellspacing="0" border="0">
				<tr>
                    <td align="left"><font class="afontstyle">Total hours submitted from '.$timesheetFromDate.' to '.$timesheetToDate.' : <b>'.number_format($total_hours,2).'</b></font></td>
                </tr>
                <tr>
                    <td align="left"><font class="afontstyle">Total <b>Days* </b>/ <b>Miles*</b> / <b>Units*</b> submitted from '.$timesheetFromDate.' to '.$timesheetToDate.' : <b>'.number_format($totaluom_hours,2).'</b></font></td>
                </tr>';
                if(THERAPY_SOURCE_ENABLED == "Y"){
                $printhtml.='<tr>
                                <td align="left"><font class="afontstyle">Total <b>Hours</b> / <b>Days* </b>/ <b>Miles*</b> / <b>Units*</b>  submitted for Custom Timesheet from '.$timesheetFromDate.' to '.$timesheetToDate.' : <b>'.number_format($totalcustom_hours,2).'</b></font></td>
                            </tr>';
                }
				$printhtml.='</table></td>';
				
                $printhtml.='<td><table cellpadding="0" cellspacing="0" border="0" width="100%"><tr>
                                <td  align="right"><font style="color:red !important" class="afontstyle">NOTE: Process Timesheet Rules will be applied only for "Regular Timesheet Layout".<br>NOTE: Timesheets created using the "Create Multiple Timesheets" link will use only Week Rule.</font></td></tr></table></td>';
                
            }else if($gridExtraFields['gridTypeValue']=="Accounting_AppTimeSheets"){
                
                $tque="SELECT ROUND(SUM(t.hours),2)
                        FROM timesheet_hours t
                        LEFT JOIN par_timesheet p ON t.parid=p.sno
                        LEFT JOIN emp_list e ON e.username=p.username 
                        LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
                        LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
                        LEFT JOIN staffacc_location l ON j.endclient=l.sno 
                       WHERE p.astatus='ER' AND p.rstatus='Applied' AND t.status ='ER' AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."'";
                $tque.= "$qstr $gstr $ostr";
                $tres=mysql_query($tque,$db);
                if(mysql_num_rows($tres)>1){
                    $total_hours =0;
                    while($row=mysql_fetch_row($tres))
                    {
                    $total_hours+=$row[0];
                    }   
                }else{
                    $trow=mysql_fetch_row($tres);
                    if($trow[0]==""){
                        $total_hours="0:00";
						}
                    else {
                        $total_hours=$trow[0];
						}   
                    }
                    
                if($this->isSearch($gridSearchFields) && $totalSearchCount>0){
                    $timesheetFromDate = $searchFromDate;
                    $timesheetToDate = $searchToDate;
                }
                $printhtml = '<tr>
                              <td colspan=3 align="center"><font class="afontstyle">Total hours processed from '.$timesheetFromDate.' to '.$timesheetToDate.': <b>'.number_format($total_hours,2).'</b></font></td>
                              </tr>';
            
            }else if($gridExtraFields['gridTypeValue']=="Accounting_ConTimeSheets"){
                
                $tque="SELECT ROUND(SUM(t.hours),2)
                        FROM timesheet_hours t
                        LEFT JOIN par_timesheet p ON t.parid=p.sno
                        LEFT JOIN emp_list e ON e.username=p.username
                        LEFT JOIN hrcon_jobs j ON t.assid=j.pusername 
			LEFT JOIN staffacc_cinfo s ON t.client=s.sno 
			LEFT JOIN staffacc_location l ON j.endclient=l.sno 
                        WHERE p.template='Regular' AND p.rstatus IN ('Rules','Conflict') AND t.status ='ER' AND ".tzRetQueryStringDate('p.sdate','YMDDate','-').">='".$minDateValue."' AND ".tzRetQueryStringDate('p.edate','YMDDate','-')."<='".$maxDateValue."'";
                $tque.= "$qstr $gstr $ostr";
                $tres=mysql_query($tque,$db);
               if(mysql_num_rows($tres)>1){
                    $total_hours =0;
                    while($row=mysql_fetch_row($tres))
                    {
                    $total_hours+=$row[0];
                    }   
                }else{
                    $trow=mysql_fetch_row($tres);
                    if($trow[0]==""){
                        $total_hours="0:00";
						}
                    else {
                        $total_hours=$trow[0];
						}   
                    }
                if($this->isSearch($gridSearchFields) && $totalSearchCount>0){
                    $timesheetFromDate = $searchFromDate;
                    $timesheetToDate = $searchToDate;
                }
                $printhtml = '<tr>
                                <td colspan=3 align="center"><font class="afontstyle">Total hours processing from '.$timesheetFromDate.' to '.$timesheetToDate.': <b>'.number_format($total_hours,2).'</b></font></td>
                            </tr>';
            }
            return $printhtml;
         } 

    function getManageCustomTypes($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
	
		global $db;
		
		$gd=new gridData();
		//print_r($gridSearchFields);
		$whereCond	="";
		if($gridSearchFields[0] != "") 
		{
			$whereCond.= " AND type_name  LIKE '%".$gridSearchFields[0]."%' ";
			$gridSearchFields[0]	= "";
		}
		if($gridSearchFields[1] != "") 
		{
			
			$whereCond.= " AND code  LIKE '%".$gridSearchFields[1]."%' ";
			$gridSearchFields[1]	= "";
		}
		if($gridSearchFields[3] != "") 
		{
			
			$whereCond.= " AND uss.name  LIKE '%".$gridSearchFields[3]."%' ";
			$gridSearchFields[3]	= "";
		}
		
		if($gridSearchFields[5] != "") 
		{
			
			$whereCond.= " AND us.name  LIKE '%".$gridSearchFields[5]."%' ";
			$gridSearchFields[5]	= "";
		}
		
		
		$asFields = array("","type_name", "code","","uss.name", tzRetQueryStringDTime('ct.cdate','DateTime','/') , "us.name", tzRetQueryStringDTime('ct.mdate','DateTime','/'));
				
		$ssFields = array("","type_name","code","",3, "cdate", 5, "mdate");
		if($gridSearchFields[4] != "") 
		{
			
			$whereCond.= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);			
			$gridSearchFields[4]	= "";
		}
		if($gridSearchFields[6] != "") 
		{
			
			$whereCond.= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			$gridSearchFields[6]	= "";
		}
		

		$custTypeids ='';
		if ($type_ids !=0) {
			$custTypeids = $type_ids;
		}
	
		$oque="SELECT
				ct.sno,ct.type_name,ct.code,uss.name,".tzRetQueryStringDTime('ct.cdate','DateTime','/')." AS cdate,us.name,".tzRetQueryStringDTime('ct.mdate','DateTime','/')." AS mdate,
				(
					SELECT GROUP_CONCAT(DISTINCT(th.cust_type)) FROM timesheet_hours th 
					WHERE th.cust_type !=0 
				) AS timesheetTypeIds,ct.type_display AS displayStatus
				FROM custom_type ct
				LEFT JOIN users us ON(us.username = ct.muser) 
				LEFT JOIN users uss ON(uss.username = ct.cuser) 
				WHERE 1=1 AND ct.status IN ('Active')   
				AND ct.type_display IN('Y','N') ".$whereCond;
		
		$grp_str = "GROUP BY ct.sno";
		$tque="SELECT count(1) FROM (".$oque.") DUMMY WHERE 1=1";

		//$grp_str	= "";
		$lstr	= $gd->buildLimt($gridPage,$gridRecords);
		$qstr1	= $gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr	= $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque	= $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1);	
		$oque_Count= "$oque $qstr $grp_str $qstr1 $ostr";
		$total	= $gd->getTotalCount($oque_Count);
		$oque	= "$oque $qstr $grp_str $qstr1 $ostr $lstr";		
		$gridData	= $gd->buildManageCustomTypes($oque);

		$objResponse	= new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;


	}

	function buildManageCustomTypes($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{	
			$chboxValues = $row[0];
			$name="name=auids[]";
			if(!empty($row[7])) {
				$type_id = explode(",",$row[7]);
				if(in_array($row[0],$type_id)){
					$isdisabled ="disabled='disabled'";
					$name="name=auids_disabled[]";
				}
			}
			$customerForAll = "";
			if(!empty($row[8]) && $row[8]=='Y') {
				$customerForAll = "<span style='margin:8px 33px 0px;position:absolute;'><i class='fa fa-check-square-o'></i></span>";
			}

			$grid[$j][0]="<label class='container-chk'><input type=checkbox ".$isdisabled." ".$name." OnClick=chk_clearTop() value='".$chboxValues."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]); // type_name
			$grid[$j][2]=$this->convertSpecChars($row[2]); // type code
			$grid[$j][3] = $customerForAll;
			$grid[$j][4]=$this->convertSpecChars($row[3]); // created user
			$grid[$j][5]=$this->convertSpecChars($row[4]); // created date
			$grid[$j][6]=$this->convertSpecChars($row[5]); // modified user
			$grid[$j][7]=$this->convertSpecChars($row[6]); // modified date
			$grid[$j][8] = "";
			$grid[$j][9] = $this->convertSpecChars($row[0]);
			$j++;
			$isdisabled='';
		}
		return $grid;
	}
	
	// TextUs Integration Functions
	function getTextUsUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","hg.name","tu.email","tu.phone_number","tu.authentication","uc.name",tzRetQueryStringDate('tu.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('tu.mdate','DateTime','/'));
		$ssFields = array("","hg.name","tu.email","tu.phone_number","tu.authentication","uc.name","tu.cdate","um.name","tu.mdate");

		$tque="SELECT COUNT(1) FROM textus_users tu LEFT JOIN users hg ON hg.username=tu.username LEFT JOIN users uc ON uc.username=tu.cuser LEFT JOIN users um ON um.username=tu.muser WHERE tu.status='A'";
		$oque="SELECT tu.sno, hg.name,tu.email,tu.phone_number,tu.authentication, uc.name, ".tzRetQueryStringDate('tu.cdate','DateTime','/').", um.name, ".tzRetQueryStringDate('tu.mdate','DateTime','/')." FROM textus_users tu LEFT JOIN users hg ON hg.username=tu.username LEFT JOIN users uc ON uc.username=tu.cuser LEFT JOIN users um ON um.username=tu.muser WHERE tu.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTextUsUsers($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildTextUsUsers($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars(ltrim($row[3],'1'));
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);
			$grid[$j][9] = "editUser.php?addr=".$row[0];
			$j++;
		}

		return $grid;
	}


	function getTextUsBroadcasts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","tb.group_name","tb.status",tzRetQueryStringDate('tb.deliver_at','DateTime','/'),tzRetQueryStringDate('tb.cdate','DateTime','/'));
		$ssFields = array("","tb.group_name","tb.status","tb.deliver_at","tb.cdate");

		$tque="SELECT COUNT(1) FROM textus_broadcasts tb WHERE tb.cuser='".$username."'";
		$oque="SELECT tb.sno,tb.group_name,tb.status,".tzRetQueryStringDate('tb.deliver_at','DateTime','/').",
					".tzRetQueryStringDate('tb.cdate','DateTime','/')." FROM textus_broadcasts tb 
					WHERE tb.cuser='".$username."'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTextUsBroadcasts($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}
	function buildTextUsBroadcasts($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "&nbsp;";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars(ucfirst($row[2]));
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $row[0];
			$j++;
		}

		return $grid;
	}

	function getTextUsBroadcastRecordDetails($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$bcSno = $gridExtraFields['bcSno'];

		$gd = new gridData();

		$asFields = array("","tc.first_name","tc.last_name","tc.phone_number","tb.status",tzRetQueryStringDate('tb.deliver_at','DateTime','/'));
		$ssFields = array("","tc.first_name","tc.last_name","tc.phone_number","tb.status","tb.deliver_at");

		$tque="SELECT COUNT(1) FROM textus_broadcasts tb         
   			   INNER JOIN textus_groups_contacts tgc ON tgc.group_id = tb.group_id
   			   INNER JOIN textus_contacts tc ON tc.sno = tgc.contact_sno 
   			   WHERE tb.sno=$bcSno";
		$oque="SELECT tc.respective_sno,tc.first_name,tc.last_name,tc.phone_number,tb.status,".tzRetQueryStringDate('tb.deliver_at','DateTime','/')."
			   FROM textus_broadcasts tb         
   			   INNER JOIN textus_groups_contacts tgc ON tgc.group_id = tb.group_id
   			   INNER JOIN textus_contacts tc ON tc.sno = tgc.contact_sno 
   			   WHERE tb.sno=$bcSno";


		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildTextUsBroadcastRecords($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildTextUsBroadcastRecords($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "&nbsp;";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars(ucfirst($row[4]));
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $row[0];
			$j++;
		}
		return $grid;
	}

	// CRM-eCampaign Candidates List
	function getCandECampaignList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$arrmatch,$user_timezone;

		$gd=new gridData();
		
		$setHeapSizeQry = "SET SESSION max_heap_table_size=1073740800";
		mysql_query($setHeapSizeQry,$db);
					
		$setTmpTableSizeQry = "SET SESSION tmp_table_size=1073740800";
		mysql_query($setTmpTableSizeQry,$db);

		$scoreQuery = " LEFT JOIN candidates_matchingscore cm ON (cm.csno = candidate_list.sno and cm.username = $username and cm.module='mc' ) ";

		$tque="SELECT count(DISTINCT(candidate_list.sno)) ";

		$oque="SELECT
		candidate_list.sno as sno,
		candidate_list.username as username,
		candidate_list.profiletitle as profiletitle,
		candidate_list.fname as fname,
		candidate_list.lname as lname,
		candidate_list.hphone as hphone,
		candidate_list.wphone as wphone,
		candidate_list.mobile as mobile,
		candidate_list.hareacode as hareacode,
		candidate_list.wareacode as wareacode,
		candidate_list.mareacode as mareacode,
		candidate_list.city as city,
		candidate_list.state as state,
		candidate_list.zip as zip,
		IF((candidate_list.amount = '0' OR candidate_list.amount = '' ),'',CONCAT_WS(' ', candidate_list.amount, CONCAT_WS('/',candidate_list.currency, candidate_list.period))) as descomp,
		IF((candidate_list.pramount = '0' OR candidate_list.pramount = '' ),'',CONCAT_WS(' ', candidate_list.pramount, CONCAT_WS('/',candidate_list.rcurrency, IF((candidate_list.rperiod = 'hourly'),'HOUR',IF((candidate_list.rperiod = 'daily'),'DAY',IF((candidate_list.rperiod = 'weekly'),'WEEK', IF((candidate_list.rperiod = 'monthly'),'MONTH', IF((candidate_list.rperiod = 'yearly'),'YEAR',IF((candidate_list.rperiod = 'semi-monthly'),'SEMI-MONTH', IF((candidate_list.rperiod = 'biweekly'),'BI-WEEK', IF((candidate_list.rperiod = 'fortnightly'),'FORT-NIGHT', IF((candidate_list.rperiod = 'perunit'),'UNIT',IF((candidate_list.rperiod = 'flatfee'),'FLATFEE', candidate_list.rperiod))))))))))))) as candrate,
		candidate_list.avail as candavl,
		IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as candtype,
		users.name as owname,
		candidate_list.resid as resid,
		manage.name as mgname, TRIM(BOTH ',' FROM GROUP_CONCAT(mct.credential_type)) AS credential_type, TRIM(BOTH ',' FROM GROUP_CONCAT(mcn.credential_name)) AS credential_name, TRIM(BOTH ',' FROM GROUP_CONCAT(cc.cre_number)) AS cre_number,
		cm.score as score ";

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			require("quickSubCandidates.inc");
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$serdb);				
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			require("visualsearch_mccandidates.php");
			require("database.inc");		
		}
		else
		{
			//$oque.=", '' as score ";
			$aqstr="";
		}

		if($aqstr=="")
			$aqstr=" 1=1 ";

		$tque.=" FROM users, $searchCond candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id $scoreQuery "; 
		$tque.=" WHERE candidate_list.status='ACTIVE' $AdminChk $removed_candids_clause $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username AND ".$aqstr." ";

		$oque.=" FROM users, $searchCond candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id $scoreQuery "; 
		$oque.=" WHERE candidate_list.status='ACTIVE' $AdminChk $removed_candids_clause $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username AND ".$aqstr." ";
		
		$asFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","IF((candidate_list.amount = '0' OR candidate_list.amount = '' ),'',CONCAT_WS(' ', candidate_list.amount, CONCAT_WS('/',candidate_list.currency, candidate_list.period)))","IF((candidate_list.pramount = '0' OR candidate_list.pramount = '' ),'',CONCAT_WS(' ', candidate_list.pramount, CONCAT_WS('/',candidate_list.rcurrency, IF((candidate_list.rperiod = 'hourly'),'HOUR',IF((candidate_list.rperiod = 'daily'),'DAY',IF((candidate_list.rperiod = 'weekly'),'WEEK', IF((candidate_list.rperiod = 'monthly'),'MONTH', IF((candidate_list.rperiod = 'yearly'),'YEAR',IF((candidate_list.rperiod = 'semi-monthly'),'SEMI-MONTH', IF((candidate_list.rperiod = 'biweekly'),'BI-WEEK', IF((candidate_list.rperiod = 'fortnightly'),'FORT-NIGHT', IF((candidate_list.rperiod = 'perunit'),'UNIT',IF((candidate_list.rperiod = 'flatfee'),'FLATFEE', candidate_list.rperiod)))))))))))))","candidate_list.avail","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","mct.credential_type","mcn.credential_name","cc.cre_number","users.name","score");

		$osFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","CAST(REPLACE(candidate_list.amount,',','') AS UNSIGNED)","CAST(REPLACE(candidate_list.pramount,',','') AS UNSIGNED)","candidate_list.avail","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","mct.credential_type","mcn.credential_name","cc.cre_number","users.name","score");
			
		if($osFields[$gridSortCol]=='candidate_list.avail'){ // donot change the column name fetching
                    $ostr ="ORDER BY IF(candidate_list.avail IN('Inactive','Immediate'),candidate_list.avail,DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d')) ".$gridSort ;
                }else{
                    $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); 
                }

		// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
		if(in_array('candidate_list.hphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.hphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.wphone',$asFields)){
			$asFieldsKey = array_search("candidate_list.wphone", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
		}
		if(in_array('candidate_list.mobile',$asFields)){
			$asFieldsKey = array_search("candidate_list.mobile", $asFields);
			$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
			$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
		}

 		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$tque=$gd->buildTQuery($tque,$qstr.$duplicateCheck,$gstr);

		$gstr	= " GROUP BY candidate_list.sno ";
		$oque=$gd->buildOQuery($oque,$qstr.$duplicateCheck,$ostr,$lstr,$gstr);

		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}

		$gridData=$gd->buildCandECampaignList($oque,$gridSortCol,$gridSort);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	// CRM-eCampaigns Candidates Grid Data
	function buildCandECampaignList($que,$gridSortCol,$gridSort)
	{
		global $maildb,$db,$CandSubMode;

		$j=0;
		$grid=array();
		$HidName1=($CandSubMode=="camp")?"contype":"cand[]";
		$AuidRObName=($CandSubMode=="camp")?'sno':'resid';

		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<input type=hidden name=".$HidName1." value='".$row['sno']."'><label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='chk_clearTop();' value='".$row[$AuidRObName]."'><span class='checkmark'></span></label><input type=hidden name=candids[] value='".$row['sno']."'>";
			$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
			$grid[$j][2]=$this->convertSpecChars($row['fname']);
			$grid[$j][3]=$this->convertSpecChars($row['lname']);
			$grid[$j][4]=$this->convertSpecChars($row['hphone']);
			$grid[$j][5]=$this->convertSpecChars($row['wphone']);
			$grid[$j][6]=$this->convertSpecChars($row['mobile']);
			$grid[$j][7]=$this->convertSpecChars($row['city']);
			$grid[$j][8]=$this->convertSpecChars($row['state']);
			$grid[$j][9]=$this->convertSpecChars($row['zip']);	
			$grid[$j][10]=$this->convertSpecChars($row['descomp']);
			$grid[$j][11]=$this->convertSpecChars($row['candrate']);
			$grid[$j][12]=$this->convertSpecChars($row['candavl']);
			$grid[$j][13]=$this->convertSpecChars($row['candtype']);
			$grid[$j][14]=$this->convertSpecChars($row['mgname']);
			$grid[$j][15]=$this->convertSpecChars($row['credential_type']);
			$grid[$j][16]=$this->convertSpecChars($row['credential_name']);
			$grid[$j][17]=$this->convertSpecChars($row['cre_number']);
			$grid[$j][18]=$this->convertSpecChars($row['owname']);
			$grid[$j][19]=$this->convertSpecChars($row['score']);

			if($row['resid']=="" || $row['resid']==0)
				$grid[$j][20]="";
			else
				$grid[$j][20]="<a href=getresume.php?fsno=".$row['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
			$grid[$j][21]="";
			$grid[$j][22]="review.php?cno=".$row['sno']."&posid=$posid&dest=0";
			$j++;
		}

		return $grid;
	}
	
	
	function getReferralBonusMngmt($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields){

        global $maildb,$db;
        $gd = new gridData();
        $whereCond ='';
        
       
		$asFields = array("","mng.sno","rbs.referral_bonus_amount","".getEntityDispName('rbs.referral_bonus_qualification', 'rbs.bonus_qualification_type', 1)."","urs.name",tzRetQueryStringDate('rbs.mdate','DateTime','/'));
		$ssFields = array("","mng.sno","rbs.referral_bonus_amount","".getEntityDispName('rbs.referral_bonus_qualification', 'rbs.bonus_qualification_type', 1)."","urs.name","rbs.mdate");
		$tque="SELECT COUNT(1)
				FROM referral_bonus_settings rbs 
				LEFT JOIN manage mng ON (rbs.jobtypeid = mng.sno AND mng.type='jotype')
				LEFT JOIN users urs ON urs.username=rbs.muser WHERE 1=1 ".$whereCond;
		$oque ="SELECT rbs.sno,
					rbs.jobtypeid,
					mng.name,
					rbs.referral_bonus_amount,
					rbs.referral_bonus_qualification,
					rbs.bonus_qualification_type,
					rbs.muser,
					urs.name,
					".tzRetQueryStringDate('rbs.mdate','DateTime','/')."
				FROM referral_bonus_settings rbs 
				LEFT JOIN manage mng ON (rbs.jobtypeid = mng.sno AND mng.type='jotype')
				LEFT JOIN users urs ON urs.username=rbs.muser WHERE 1=1 ".$whereCond;
		
		$gstr = "";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildgetReferralBonusMngmt($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;

		}
                
        function buildgetReferralBonusMngmt($que)
        {	

        	global $db;

			$j=0;
			$grid=array();
			$bonusQualType='';
			$res=mysql_query($que,$db);	
			while($row=mysql_fetch_array($res))
			{
				if ($row[4] !="" && $row[5] !="") {
					$bonusQualType = $row[4]."-".$row[5];
				}else{
					$bonusQualType = "";	
				}
				
				$grid[$j][0] = "&nbsp;";
				$grid[$j][1] = $this->convertSpecChars($row[2]); 
				$grid[$j][2] = $this->convertSpecChars($row[3]);
				$grid[$j][3] = $this->convertSpecChars($bonusQualType);
				$grid[$j][4] = $this->convertSpecChars(ucfirst($row[7]));
				$grid[$j][5] = $this->convertSpecChars($row[8]);
				$grid[$j][6] = "referral_bonus_settings.php?sno=".$row[0];
				$j++;
			}
			return $grid;
        }

        function getAllPayReferralStatusSnos(){
        	global $maildb,$db;
        	$select = "SELECT GROUP_CONCAT(sno) AS payReferral FROM manage WHERE type='referral_status'";
        	$result = mysql_query($select,$db);
        	$row = mysql_fetch_assoc($result);
        	return $row['payReferral'];
        }

        function getPayReferralMngmt($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields){

	        global $maildb,$db;
	        $gd = new gridData();
	        $whereCond ='';
	        
	        if($gridSearchFields[0]=="")
			{
				$payReferralSnos = $gd->getAllPayReferralStatusSnos();
				$whereCond = " AND mng.`sno` IN (".$payReferralSnos.") ";
				$gridSearchFields[0] = "";
			}
			$asFields = array("","mng.`sno`","cr.sno","".getEntityDispName('el.sno', 'LOWER(el.name)', 1)."","urs.name",tzRetQueryStringDate('cr.ref_applied_date','Date','/'),tzRetQueryStringDate('cr.hire_date','Date','/'),tzRetQueryStringDate('cr.qualified_date','Date','/'),"cr.assign_id","hj.`project`","cr.`bonus_amount`","cr.`bonus_eligibility`","cr.`bonus_calc_type`","cr.`eligibility_duration`",tzRetQueryStringDate('cr.payment_date','Date','/'),tzRetQueryStringDate('cr.status_upd_date','DateTime','/'));			
			
			$ssFields = array("","mng.`sno`","cr.sno","".getEntityDispName('el.sno', 'LOWER(el.name)', 1)."","urs.name",tzRetQueryStringDate('cr.ref_applied_date','Date','/'),tzRetQueryStringDate('cr.hire_date','Date','/'),tzRetQueryStringDate('cr.qualified_date','Date','/'),"cr.assign_id","hj.`project`","cr.`bonus_amount`","cr.`bonus_eligibility`","cr.`bonus_calc_type`","cr.`eligibility_duration`",tzRetQueryStringDate('cr.payment_date','Date','/'),tzRetQueryStringDTime('cr.status_upd_date','DateTime','/'));

			$tque="SELECT COUNT(1)
					FROM `cand_refer` cr
					LEFT JOIN manage mng ON (cr.referral_status = mng.sno AND mng.type='referral_status')
					LEFT JOIN users urs ON (urs.username=cr.username)
					LEFT JOIN hrcon_jobs hj ON (hj.pusername=cr.assign_id)
					LEFT JOIN emp_list el ON (el.sno=cr.emp_id) WHERE 1=1
					AND cr.bonus_amount !='0.00'
					".$whereCond;
					
			$oque ="SELECT 	cr.`sno`, 
							mng.`name` AS referralname,
							cr.`sno` AS referralid,
							".getEntityDispName('el.sno', 'el.name', 1).", 						
							urs.`name` AS referralby,
							IF(cr.ref_applied_date = '0000-00-00 00:00:00','',".tzRetQueryStringDate('cr.ref_applied_date','Date','/')."),
							IF(cr.hire_date = '0000-00-00 00:00:00','',".tzRetQueryStringDate('cr.hire_date','Date','/')."),
							IF(cr.qualified_date = '0000-00-00 00:00:00','',".tzRetQueryStringDate('cr.qualified_date','Date','/')."),
							cr.assign_id,
							hj.`project` AS assignment_name,
							cr.`bonus_amount`,
							cr.`bonus_eligibility`,
							cr.`bonus_calc_type`, 
							cr.`eligibility_duration`, 
							".tzRetQueryStringDate("cr.payment_date","Date","/").",
							IF(cr.status_upd_date = '0000-00-00 00:00:00','',".tzRetQueryStringDate('cr.status_upd_date','Date','/')."),
							mng.sno,
							hj.ustatus,
							el.sno,
							hj.sno,
							hj.s_date,
							cr.referral_status,
							cr.status_notes
							FROM 
							`cand_refer` cr
							LEFT JOIN manage mng ON (cr.referral_status = mng.sno AND mng.type='referral_status')
							LEFT JOIN users urs ON (urs.username=cr.username)
							LEFT JOIN hrcon_jobs hj ON (hj.pusername=cr.assign_id)
							LEFT JOIN emp_list el ON (el.sno=cr.emp_id) WHERE 1=1 
							AND cr.bonus_amount !='0.00' ".$whereCond;
			
			$gstr = "";
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
			$tque=$gd->buildTQuery($tque,$qstr,$gstr);
			$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

			$total=$gd->getTotalRows($tque);
			$gridData=$gd->buildPayReferralMngmt($oque);

			$objResponse = new xajaxResponse();
			$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
			//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

			return $objResponse;
		}
                
        function buildPayReferralMngmt($que)
        {	

        	global $db;

			$j=0;
			$grid=array();
			$bonusQualType='';
			$disqualifiedReferralSno =getManageSno('Disqualified Referrals','referral_status');
			$res=mysql_query($que,$db);	
			while($row=mysql_fetch_array($res))
			{
				if($row[17] == "")
					$asg_status = "approved";
				else if($row[17] == "cancel")
					$asg_status = "cancelled";
				else
					$asg_status = $row[17];

				$assignment = trim($row[19].'|15|'.$asg_status.'|'.$row[18].'|payref|'.$row[20]);

				$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' data-payreferral='".$row[16]."' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
				if ($row[21] == $disqualifiedReferralSno) {
					$grid[$j][1] = "<span title='".$row[22]."' />".$this->convertSpecChars($row[1])."</span>"; 
				}else{
					$grid[$j][1] = $this->convertSpecChars($row[1]); 	
				}
				$grid[$j][2] = $this->convertSpecChars($row[2]);
				$grid[$j][3] = $this->convertSpecChars($row[3]);
				$grid[$j][4] = $this->convertSpecChars($row[4]);
				$grid[$j][5] = $this->convertSpecChars($row[5]);
				$grid[$j][6] = $this->convertSpecChars($row[6]);
				$grid[$j][7] = $this->convertSpecChars($row[7]);
				$grid[$j][8] = "<a href=javascript:showEmployeeAssignment('".$assignment."') >".$this->convertSpecChars($row[8])."</a>";
				$grid[$j][9] = $this->convertSpecChars($row[9]);
				$grid[$j][10] = $this->convertSpecChars($row[10]);
				$grid[$j][11] = $this->convertSpecChars($row[11]);
				$grid[$j][12] = $this->convertSpecChars($row[12]);
				$grid[$j][13] = $this->convertSpecChars($row[13]);
				$grid[$j][14] = $this->convertSpecChars($row[14]);
				$grid[$j][15] = $this->convertSpecChars($row[15]);
				$grid[$j][16] = "&nbsp;";
				$j++;
			}
			return $grid;
        }
		
	///////////////////WOTC-MJA Integration Functions - START////////////////////////
	function getWotcMJAUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","hg.name","el.email","uc.name",tzRetQueryStringDate('mju.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('mju.mdate','DateTime','/'));
		$ssFields = array("","hg.name","el.email","uc.name","mju.cdate","um.name","mju.mdate");

		$tque="SELECT COUNT(*) FROM wotc_mja_users mju LEFT JOIN users hg ON hg.username=mju.username LEFT JOIN users um ON 
				um.username=mju.muser LEFT JOIN users uc ON uc.username=mju.cuser LEFT JOIN emp_list el ON 
				el.username = mju.username WHERE mju.status='A' AND hg.status != 'DA'";

		$oque="SELECT mju.sno, hg.name, ".tzRetQueryStringDate('mju.cdate','DateTime','/').", um.name, ".tzRetQueryStringDate('mju.mdate','DateTime','/').", el.email FROM wotc_mja_users mju LEFT JOIN users hg ON hg.username=mju.username LEFT JOIN users um ON um.username=mju.muser LEFT JOIN users uc ON uc.username=mju.cuser LEFT JOIN emp_list el ON el.username = mju.username WHERE mju.status='A' AND hg.status != 'DA'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildWotcMJAUsers($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildWotcMJAUsers($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[5]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[2]);
			$grid[$j][5] = $this->convertSpecChars($row[3]);
			$grid[$j][6] = $this->convertSpecChars($row[4]);
			$grid[$j][7] = 'javascript:void(0);';
			$j++;
		}

		return $grid;
	}
	///////////////////WOTC-MJA Integration Functions - END////////////////////////
	
	//xajax grid for CSS Users Data Grid - Ankit
	function getAdminUserManAccContacts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{		
		global $maildb,$db,$username,$stat,$user_timezone,$acctype;

		$gd=new gridData();

		$asFields=array("","CONCAT_WS(' - ',staffacc_contact.sno,TRIM(concat_ws(' ',staffacc_contact.fname, staffacc_contact.lname)))", "CONCAT_WS(' - ',staffacc_cinfo.sno,TRIM(staffacc_cinfo.cname))", "staffacc_contact.email", tzRetQueryStringDTime("staffacc_contact.cdate","DateTime","/"), "users.name");	
		$ssFields=array("","names1", "cnames1", "staffacc_contact.email", "staffacc_contact.cdate", "users.name");

		$tque="SELECT count(staffacc_contact.username) FROM staffacc_contact LEFT JOIN staffacc_cinfo ON staffacc_contact.username=staffacc_cinfo.username LEFT JOIN users ON users.username = staffacc_contact.createdby WHERE staffacc_cinfo.type IN ('CUST', 'BOTH') AND staffacc_contact.sno NOT IN ( SELECT staffacc_contactacc.con_id FROM staffacc_contactacc) and staffacc_contact.acccontact = 'Y' and staffacc_contact.username!=''
			";
		$oque="SELECT TRIM(CONCAT_WS(' - ',staffacc_contact.sno,TRIM(concat_ws(' ',staffacc_contact.fname, staffacc_contact.lname)))) as names1, 
				CONCAT_WS(',',staffacc_cinfo.address1,staffacc_cinfo.city,staffacc_cinfo.state), staffacc_contact.username, 
				staffacc_contact.sno, TRIM(CONCAT_WS(' - ',staffacc_cinfo.sno,TRIM(staffacc_cinfo.cname))) as cnames1, staffacc_contact.email, staffacc_cinfo.address1, staffacc_cinfo.city,
				staffacc_cinfo.state, ".tzRetQueryStringDTime("staffacc_contact.cdate","DateTime","/").", users.name FROM staffacc_contact LEFT JOIN staffacc_cinfo ON 
				staffacc_contact.username =staffacc_cinfo.username LEFT JOIN users ON users.username = staffacc_contact.createdby WHERE
				staffacc_cinfo.type IN ('CUST', 'BOTH') AND staffacc_contact.sno NOT IN ( SELECT staffacc_contactacc.con_id FROM 
				staffacc_contactacc) and staffacc_contact.acccontact = 'Y' and staffacc_contact.username != ''";

		$gstr="";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildAdminUserManAccContacts($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);
		return $objResponse;
	}
	
	//xajax grid for CSS Users Data Grid - Ankit
	function buildAdminUserManAccContacts($que)
	{
		global $maildb,$db,$stat,$acctype;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[3]."|".$j."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[4]);
			$grid[$j][3]=$this->convertSpecChars($row[5]);
			$grid[$j][4]=$this->convertSpecChars($row[9]);
			$grid[$j][5]=$this->convertSpecChars($row[10]);

			$grid[$j][6]="<a href=selfservicePref.php?acctype=$acctype&cssmultiuser=No&abstat=yes&addr=".$row[3]." target='_top'>Create User</a>";
			$j++;
		}
		
		return $grid;
	}
	///////////////////Prophecy Integration Functions - START////////////////////////
	function getProphecyUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","users.name","pua.email","pua.feed_code","IF(pua.is_active='true','Success','Failed')","uc.name",tzRetQueryStringDate('pua.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('pua.mdate','DateTime','/'));
		$ssFields = array("","users.name","pua.email","pua.feed_code","pua.is_active","uc.name","pua.cdate","um.name","pua.mdate");

		$tque="SELECT COUNT(*) FROM prophecy_user_accounts pua LEFT JOIN users ON users.username=pua.username LEFT JOIN users um ON um.username=pua.muser LEFT JOIN users uc ON uc.username=pua.cuser WHERE pua.status='A'";

		$oque="SELECT pua.sno, users.name,pua.email,pua.feed_code, IF(pua.is_active='true','Success','Failed'),uc.name,  ".tzRetQueryStringDate('pua.cdate','DateTime','/').",  um.name, ".tzRetQueryStringDate('pua.mdate','DateTime','/')." FROM prophecy_user_accounts pua LEFT JOIN users ON users.username=pua.username LEFT JOIN users um ON um.username=pua.muser LEFT JOIN users uc ON uc.username=pua.cuser WHERE pua.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildProphecyUsers($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildProphecyUsers($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = $this->convertSpecChars($row[7]);
			$grid[$j][8] = $this->convertSpecChars($row[8]);
			$grid[$j][9] = "javascript:void(0);";
			$j++;
		}

		return $grid;
	}
	///////////////////Prophecy Integration Functions - END////////////////////////

	///////////////////STERLING Integration Functions - START////////////////////////
	function getSterlingUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","users.name","su.email","uc.name",tzRetQueryStringDate('su.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('su.mdate','DateTime','/'));
		$ssFields = array("","users.name","su.email","uc.name","su.cdate","um.name","su.mdate");

		$tque="SELECT COUNT(*) FROM sterling_users su LEFT JOIN users ON users.username=su.username LEFT JOIN users um ON um.username=su.muser LEFT JOIN users uc ON uc.username=su.cuser WHERE su.status='A'";

		$oque="SELECT su.sno, users.name,su.email, uc.name, ".tzRetQueryStringDate('su.cdate','DateTime','/').",  um.name, ".tzRetQueryStringDate('su.mdate','DateTime','/')." FROM sterling_users su LEFT JOIN users ON users.username=su.username LEFT JOIN users um ON um.username=su.muser LEFT JOIN users uc ON uc.username=su.cuser WHERE su.status='A'";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildSterlingUsers($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildSterlingUsers($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]);
			$grid[$j][2] = $this->convertSpecChars($row[2]); 
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
			$grid[$j][7] = "javascript:void(0);";
			$j++;
		}

		return $grid;
	}
	///////////////////STERLING Integration Functions - END////////////////////////
	// Accounting Vendors 
	function getVendors($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username;
		
		$decimalPref    = getDecimalPreference();
		if($gridSortCol=="")
		$gridSortCol=1;
		
		$gd=new gridData();
		
		if(PAYROLL_PROCESS_BY=='QB')
		{
			$asFields=array("", "vendor_name", "vendor_id","vendor_type","vendor_phone","vendor_city", "vendor_state");
			$ssFields=array("", "vendor_name", "vendor_id","vendor_type","vendor_phone","vendor_city", "vendor_state");
			
			$oque1="SELECT reg_payee.name as vendor_name,(SELECT sno FROM vendors WHERE vendorid = reg_payee.sno AND vendortype = 'GV' LIMIT 1) as vendor_id,'General Vendor' as vendor_type, wphone as vendor_phone, offcity as vendor_city, offstate as vendor_state, CONCAT('PE',reg_payee.sno) as vendor_sno,reg_payee.sno FROM reg_payee WHERE reg_payee.status='ER' 
			UNION 
			SELECT staffacc_cinfo.cname as vendor_name,(SELECT sno FROM vendors WHERE vendorid = staffacc_cinfo.sno AND vendortype = 'CV' LIMIT 1) as vendor_id,'Consulting Vendor' as vendor_type,staffacc_cinfo.phone as vendor_phone, staffacc_cinfo.city as vendor_city, staffacc_cinfo.state as vendor_state, staffacc_cinfo.username as vendor_sno,staffacc_cinfo.sno FROM staffacc_cinfo,staffacc_list,vendors WHERE staffacc_list.username = staffacc_cinfo.username AND vendors.vendorid=staffacc_cinfo.sno AND staffacc_cinfo.type IN ('CV','BOTH') group by vendors.vendorid
			UNION
			SELECT emp_list.name as vendor_name,(SELECT sno FROM vendors WHERE vendorid = emp_list.sno AND vendortype = 'CT' LIMIT 1) as vendor_id,'Consultant' as vendor_type, hrcon_general.wphone as vendor_phone,hrcon_general.city as vendor_city,hrcon_general.state as vendor_state,emp_list.username as vendor_sno,emp_list.sno FROM emp_list LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username  LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username where hrcon_w4.tax='1099' and hrcon_w4.ustatus='active' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y' AND hrcon_general.ustatus='active' group by emp_list.username";
			 
			$oque = "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
			$tque = "SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		}
		else
		{
			$asFields=array("","vendor_name","vendor_id","vendor_type","current","onetothirty","thirtyonetosixty","sixtyonetoninty","greterthanninty","totaldue");
			$ssFields=array("","vendor_name","vendor_id","vendor_type","current","onetothirty","thirtyonetosixty","sixtyonetoninty","greterthanninty","totaldue");
						
			$oque1="SELECT reg_payee.name as vendor_name,(SELECT sno FROM vendors WHERE vendorid = reg_payee.sno AND vendortype = 'GV' LIMIT 1) as vendor_id,'General Vendor' as vendor_type,
			IF((IF(a.amt IS NULL,0,a.amt))-(IF(b.amt IS NULL,0,b.amt)) IS NULL,0, IF(a.amt IS NULL,0,a.amt)-IF(b.amt IS NULL,0,b.amt)) AS current,
			IF((IF(c.amt IS NULL, 0, c.amt)) - (IF(d.amt IS NULL, 0, d.amt)) IS NULL,0,IF(c.amt IS NULL, 0, c.amt) - IF(d.amt IS NULL, 0, d.amt)) AS 'onetothirty',
			IF((IF(e.amt IS NULL, 0, e.amt)) - (IF(f.amt IS NULL, 0, f.amt)) IS NULL,0,IF(e.amt IS NULL, 0, e.amt) - IF(f.amt IS NULL, 0, f.amt)) AS 'thirtyonetosixty',
			IF((IF(g.amt IS NULL, 0, g.amt)) - (IF(h.amt IS NULL, 0, h.amt)) IS NULL,0,IF(g.amt IS NULL, 0, g.amt) - IF(h.amt IS NULL, 0, h.amt)) AS 'sixtyonetoninty',
			IF((IF(i.amt IS NULL, 0, i.amt)) - (IF(j.amt IS NULL, 0, j.amt)) IS NULL,0,IF(i.amt IS NULL, 0, i.amt) - IF(j.amt IS NULL, 0, j.amt)) AS 'greterthanninty',			
			(IF((IF(a.amt IS NULL,0,a.amt))-(IF(b.amt IS NULL,0,b.amt)) IS NULL,0, IF(a.amt IS NULL,0,a.amt)-IF(b.amt IS NULL,0,b.amt)) + 				
			IF((IF(c.amt IS NULL, 0, c.amt)) - (IF(d.amt IS NULL, 0, d.amt)) IS NULL,0,IF(c.amt IS NULL, 0, c.amt) - IF(d.amt IS NULL, 0, d.amt)) + 				
			IF((IF(e.amt IS NULL, 0, e.amt)) - (IF(f.amt IS NULL, 0, f.amt)) IS NULL,0,IF(e.amt IS NULL, 0, e.amt) - IF(f.amt IS NULL, 0, f.amt)) +				
			IF((IF(g.amt IS NULL, 0, g.amt)) - (IF(h.amt IS NULL, 0, h.amt)) IS NULL,0,IF(g.amt IS NULL, 0, g.amt) - IF(h.amt IS NULL, 0, h.amt)) + 				
			IF((IF(i.amt IS NULL, 0, i.amt)) - (IF(j.amt IS NULL, 0, j.amt)) IS NULL,0,IF(i.amt IS NULL, 0, i.amt) - IF(j.amt IS NULL, 0, j.amt))) AS totaldue,
			CONCAT('PE',reg_payee.sno),reg_payee.sno
			FROM reg_payee 
			
			LEFT JOIN (SELECT bill.client_id,(sum( bill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'bil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = bill.sno)  WHERE bill.status='ER' and bill.due_date > CURDATE() GROUP BY bill.client_id ) a ON a.client_id=CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - IFNULL(transamount.Trans_Amount,0.00)) as amt  FROM bank_trans ,bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, bill	
			where credit_memo_trans.inv_bill_sno = bill.sno AND bill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'bil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=bill.sno) WHERE bank_trans.source = CONCAT('bil',bill.sno) and bill.status IN('ER', 'DL') and bill.due_date > CURDATE() GROUP BY bank_trans.payee) b ON b.payee=CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bill.client_id,(sum( bill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'bil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = bill.sno)  WHERE bill.status='ER' and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE() GROUP BY bill.client_id) c ON c.client_id = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, bill	
			where credit_memo_trans.inv_bill_sno = bill.sno AND bill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'bil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=bill.sno) WHERE bank_trans.source = CONCAT('bil',bill.sno) and bank_trans.source in (select concat('bil',bill.sno) from bill WHERE bill.client_id = bank_trans.payee and bill.status IN('ER','DL') and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE()) GROUP BY bank_trans.payee) d ON d.payee = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bill.client_id,(sum( bill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'bil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = bill.sno)  WHERE bill.status='ER' and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY) GROUP BY bill.client_id) e ON e.client_id = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, bill	
			where credit_memo_trans.inv_bill_sno = bill.sno AND bill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'bil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=bill.sno) WHERE bank_trans.source = CONCAT('bil',bill.sno) and bank_trans.source in (select concat('bil',bill.sno) from bill WHERE bill.client_id = bank_trans.payee and bill.status IN('ER','DL') and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY)) GROUP BY bank_trans.payee) f ON f.payee = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bill.client_id,(sum( bill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'bil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = bill.sno)  WHERE bill.status='ER' and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY) GROUP BY bill.client_id) g ON g.client_id = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, bill	
			where credit_memo_trans.inv_bill_sno = bill.sno AND bill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'bil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=bill.sno) WHERE bank_trans.source = CONCAT('bil',bill.sno) and bank_trans.source in (select concat('bil',bill.sno) from bill WHERE bill.client_id = bank_trans.payee and bill.status IN('ER','DL') and bill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY)) GROUP BY bank_trans.payee) h ON h.payee = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bill.client_id,(sum( bill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'bil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = bill.sno)  WHERE bill.status='ER' and bill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY) GROUP BY bill.client_id) i ON i.client_id = CONCAT('PE',reg_payee.sno)
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,bill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, bill	
			where credit_memo_trans.inv_bill_sno = bill.sno AND bill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'bil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=bill.sno) WHERE bank_trans.source = CONCAT('bil',bill.sno) and bank_trans.source in (select concat('bil',bill.sno) from bill WHERE bill.client_id = bank_trans.payee and bill.status IN('ER','DL') and bill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY)) GROUP BY bank_trans.payee) j ON j.payee = CONCAT('PE',reg_payee.sno)
			
			WHERE reg_payee.status='ER'
			
			UNION
			
			SELECT staffacc_cinfo.cname as vendor_name,(SELECT sno FROM vendors WHERE vendorid = staffacc_cinfo.sno AND vendortype = 'CV' LIMIT 1) as vendor_id,'Consulting Vendor' as vendor_type, 
			IF((IF(a.amt IS NULL,0,a.amt))-(IF(b.amt IS NULL,0,b.amt)) IS NULL,0, IF(a.amt IS NULL,0,a.amt)-IF(b.amt IS NULL,0,b.amt)) AS current,
			IF((IF(c.amt IS NULL, 0, c.amt)) - (IF(d.amt IS NULL, 0, d.amt)) IS NULL,0,IF(c.amt IS NULL, 0, c.amt) - IF(d.amt IS NULL, 0, d.amt)) AS 'onetothirty',
			IF((IF(e.amt IS NULL, 0, e.amt)) - (IF(f.amt IS NULL, 0, f.amt)) IS NULL,0,IF(e.amt IS NULL, 0, e.amt) - IF(f.amt IS NULL, 0, f.amt)) AS 'thirtyonetosixty',
			IF((IF(g.amt IS NULL, 0, g.amt)) - (IF(h.amt IS NULL, 0, h.amt)) IS NULL,0,IF(g.amt IS NULL, 0, g.amt) - IF(h.amt IS NULL, 0, h.amt)) AS 'sixtyonetoninty',
			IF((IF(i.amt IS NULL, 0, i.amt)) - (IF(j.amt IS NULL, 0, j.amt)) IS NULL,0,IF(i.amt IS NULL, 0, i.amt) - IF(j.amt IS NULL, 0, j.amt)) AS 'greterthanninty',			
			IF((IF(k.amt IS NULL, 0, k.amt)) - (IF(l.amt IS NULL, 0, l.amt)) IS NULL,0,IF(k.amt IS NULL, 0, k.amt) - IF(l.amt IS NULL, 0, l.amt)) AS totaldue,
			staffacc_cinfo.username as vendor_sno,staffacc_cinfo.sno 
			FROM staffacc_cinfo
			INNER JOIN staffacc_list ON  staffacc_list.username = staffacc_cinfo.username 
			INNER JOIN vendors ON vendors.vendorid=staffacc_cinfo.sno 
			LEFT JOIN (SELECT cvbill.client_id,(sum( cvbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),".$decimalPref.") Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'cbil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = cvbill.sno)  WHERE cvbill.status='ER' and cvbill.due_date > CURDATE() GROUP BY cvbill.client_id ) a ON a.client_id = staffacc_cinfo.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),".$decimalPref.") - IFNULL(transamount.Trans_Amount,0.00)) as amt FROM bank_trans ,cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),".$decimalPref.") Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, cvbill	
			where credit_memo_trans.inv_bill_sno = cvbill.sno AND cvbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'cbil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=cvbill.sno) WHERE bank_trans.source = CONCAT('cbil',cvbill.sno) and cvbill.status IN('ER', 'DL') and cvbill.due_date > CURDATE() GROUP BY bank_trans.payee) b ON b.payee = staffacc_cinfo.username  
						
			LEFT JOIN (SELECT cvbill.client_id,(sum( cvbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),".$decimalPref.") Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'cbil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = cvbill.sno)  WHERE cvbill.status='ER' and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE() GROUP BY cvbill.client_id) c ON c.client_id = staffacc_cinfo.username 
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),".$decimalPref.") - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),".$decimalPref.") Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, cvbill	
			where credit_memo_trans.inv_bill_sno = cvbill.sno AND cvbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'cbil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=cvbill.sno) WHERE bank_trans.source = CONCAT('cbil',cvbill.sno) and bank_trans.source in (select concat('cbil',cvbill.sno) from cvbill WHERE cvbill.client_id = bank_trans.payee and cvbill.status IN('ER','DL') and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE()) GROUP BY bank_trans.payee) d ON d.payee = staffacc_cinfo.username
									
			LEFT JOIN (SELECT cvbill.client_id,(sum( cvbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),".$decimalPref.") Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'cbil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = cvbill.sno)  WHERE cvbill.status='ER' and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY) GROUP BY cvbill.client_id) e ON e.client_id = staffacc_cinfo.username 
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),".$decimalPref.") - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),".$decimalPref.") Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, cvbill	
			where credit_memo_trans.inv_bill_sno = cvbill.sno AND cvbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'cbil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=cvbill.sno) WHERE bank_trans.source = CONCAT('cbil',cvbill.sno) and bank_trans.source in (select concat('cbil',cvbill.sno) from cvbill WHERE cvbill.client_id = bank_trans.payee and cvbill.status IN('ER','DL') and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY)) GROUP BY bank_trans.payee) f ON f.payee = staffacc_cinfo.username
									
			LEFT JOIN (SELECT cvbill.client_id,(sum( cvbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),".$decimalPref.") Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'cbil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = cvbill.sno)  WHERE cvbill.status='ER' and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY) GROUP BY cvbill.client_id) g ON g.client_id = staffacc_cinfo.username 
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),".$decimalPref.") - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),".$decimalPref.") Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, cvbill	
			where credit_memo_trans.inv_bill_sno = cvbill.sno AND cvbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'cbil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=cvbill.sno) WHERE bank_trans.source = CONCAT('cbil',cvbill.sno) and bank_trans.source in (select concat('cbil',cvbill.sno) from cvbill WHERE cvbill.client_id = bank_trans.payee and cvbill.status IN('ER','DL') and cvbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY)) GROUP BY bank_trans.payee) h ON h.payee = staffacc_cinfo.username
									
			LEFT JOIN (SELECT cvbill.client_id,(sum( cvbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),".$decimalPref.") Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'cbil' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = cvbill.sno)  WHERE cvbill.status='ER' and cvbill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY) GROUP BY cvbill.client_id) i ON i.client_id = staffacc_cinfo.username 
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),".$decimalPref.") - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt  FROM bank_trans ,cvbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),".$decimalPref.") Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, cvbill	
			where credit_memo_trans.inv_bill_sno = cvbill.sno AND cvbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'cbil' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=cvbill.sno) WHERE bank_trans.source = CONCAT('cbil',cvbill.sno) and bank_trans.source in (select concat('cbil',cvbill.sno) from cvbill WHERE cvbill.client_id = bank_trans.payee and cvbill.status IN('ER','DL') and cvbill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY)) GROUP BY bank_trans.payee) j ON j.payee = staffacc_cinfo.username
			
			LEFT JOIN (SELECT cvbill.client_id,sum( cvbill.total ) as amt FROM cvbill WHERE cvbill.status='ER' GROUP BY cvbill.client_id) k ON k.client_id = staffacc_cinfo.username
			
			LEFT JOIN (SELECT bank_trans.payee,IF(ISNULL(sum( bank_trans.amount )),0,sum( bank_trans.amount )) as amt FROM bank_trans WHERE type = 'BillCPMT' GROUP BY bank_trans.payee) l ON l.payee = staffacc_cinfo.username 
			
			WHERE staffacc_cinfo.type IN ('CV','BOTH') group by vendors.vendorid

			UNION
			
			select emp_list.name as vendor_name,(SELECT sno FROM vendors WHERE vendorid = emp_list.sno AND vendortype = 'CT' LIMIT 1) as vendor_id,'Consultant' as vendor_type, 
			IF((IF(a.amt IS NULL,0,a.amt))-(IF(b.amt IS NULL,0,b.amt)) IS NULL,0, IF(a.amt IS NULL,0,a.amt)-IF(b.amt IS NULL,0,b.amt)) AS current,
			IF((IF(c.amt IS NULL, 0, c.amt)) - (IF(d.amt IS NULL, 0, d.amt)) IS NULL,0,IF(c.amt IS NULL, 0, c.amt) - IF(d.amt IS NULL, 0, d.amt)) AS 'onetothirty',
			IF((IF(e.amt IS NULL, 0, e.amt)) - (IF(f.amt IS NULL, 0, f.amt)) IS NULL,0,IF(e.amt IS NULL, 0, e.amt) - IF(f.amt IS NULL, 0, f.amt)) AS 'thirtyonetosixty',
			IF((IF(g.amt IS NULL, 0, g.amt)) - (IF(h.amt IS NULL, 0, h.amt)) IS NULL,0,IF(g.amt IS NULL, 0, g.amt) - IF(h.amt IS NULL, 0, h.amt)) AS 'sixtyonetoninty',
			IF((IF(i.amt IS NULL, 0, i.amt)) - (IF(j.amt IS NULL, 0, j.amt)) IS NULL,0,IF(i.amt IS NULL, 0, i.amt) - IF(j.amt IS NULL, 0, j.amt)) AS 'greterthanninty',			
			IF((IF(k.amt IS NULL, 0, k.amt)) - (IF(l.amt IS NULL, 0, l.amt)) IS NULL,0,IF(k.amt IS NULL, 0, k.amt) - IF(l.amt IS NULL, 0, l.amt)) AS totaldue,
			emp_list.username as vendor_sno,emp_list.sno

			FROM emp_list 
			LEFT JOIN hrcon_w4 ON emp_list.username=hrcon_w4.username  
			LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
			
			LEFT JOIN (SELECT convbill.client_id,(sum( convbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'conbill' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = convbill.sno)  WHERE convbill.status='ER' and convbill.due_date > CURDATE() GROUP BY convbill.client_id) a ON a.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - IFNULL(transamount.Trans_Amount,0.00)) as amt FROM bank_trans ,convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, convbill	
			where credit_memo_trans.inv_bill_sno = convbill.sno AND convbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'conbill' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=convbill.sno) WHERE bank_trans.source = CONCAT('conbill',convbill.sno) and convbill.status IN('ER', 'DL') and convbill.due_date > CURDATE() GROUP BY bank_trans.payee) b ON b.payee = emp_list.username

			LEFT JOIN (SELECT convbill.client_id,(sum( convbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'conbill' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = convbill.sno)  WHERE convbill.status='ER'  and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE() GROUP BY convbill.client_id) c ON c.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bank_trans ,convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, convbill	
			where credit_memo_trans.inv_bill_sno = convbill.sno AND convbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'conbill' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=convbill.sno) WHERE bank_trans.source = CONCAT('conbill',convbill.sno) and bank_trans.source in (select concat('conbill',convbill.sno) from convbill WHERE convbill.client_id = bank_trans.payee and convbill.status IN('ER','DL') and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 30 DAY) AND CURDATE()) GROUP BY bank_trans.payee) d ON d.payee = emp_list.username
						
			LEFT JOIN (SELECT convbill.client_id,(sum( convbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'conbill' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = convbill.sno)  WHERE convbill.status='ER'  and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY) GROUP BY convbill.client_id) e ON e.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bank_trans ,convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, convbill	
			where credit_memo_trans.inv_bill_sno = convbill.sno AND convbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'conbill' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=convbill.sno) WHERE bank_trans.source = CONCAT('conbill',convbill.sno) and bank_trans.source in (select concat('conbill',convbill.sno) from convbill WHERE convbill.client_id = bank_trans.payee and convbill.status IN('ER','DL') and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 60 DAY) AND DATE_SUB(CURDATE(),INTERVAL 31 DAY)) GROUP BY bank_trans.payee) f ON f.payee = emp_list.username
						
			LEFT JOIN (SELECT convbill.client_id,(sum( convbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'conbill' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = convbill.sno)  WHERE convbill.status='ER'  and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY) GROUP BY convbill.client_id) g ON g.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bank_trans ,convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, convbill	
			where credit_memo_trans.inv_bill_sno = convbill.sno AND convbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'conbill' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=convbill.sno) WHERE bank_trans.source = CONCAT('conbill',convbill.sno) and bank_trans.source in (select concat('conbill',convbill.sno) from convbill WHERE convbill.client_id = bank_trans.payee and convbill.status IN('ER','DL') and convbill.due_date BETWEEN DATE_SUB(CURDATE(),INTERVAL 90 DAY) AND DATE_SUB(CURDATE(),INTERVAL 61 DAY)) GROUP BY bank_trans.payee) h ON h.payee = emp_list.username			
			
			LEFT JOIN (SELECT convbill.client_id,(sum( convbill.total )-sum(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,0.00)),2) Trans_Amount,credit_memo_trans.inv_bill_sno  AS billSno FROM credit_memo_trans WHERE credit_memo_trans.type = 'conbill' GROUP BY credit_memo_trans.inv_bill_sno) transamount ON (transamount.billSno = convbill.sno)  WHERE convbill.status='ER'  and convbill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY) GROUP BY convbill.client_id) i ON i.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,(round(SUM(bank_trans.amount),2) - SUM(IFNULL(transamount.Trans_Amount,0.00))) as amt FROM bank_trans ,convbill LEFT JOIN (SELECT round(SUM(IFNULL(credit_memo_trans.used_amount,'0.00')),2) Trans_Amount,credit_memo.credit_inv_bill_id billid  FROM credit_memo_trans, credit_memo, convbill	
			where credit_memo_trans.inv_bill_sno = convbill.sno AND convbill.status = 'ER' AND credit_memo.credit_id=credit_memo_trans.credit_memo_sno
			AND credit_memo.credit_type = 'conbill' GROUP BY credit_memo_trans.credit_memo_sno) transamount ON (transamount.billid=convbill.sno) WHERE bank_trans.source = CONCAT('conbill',convbill.sno) and bank_trans.source in (select concat('conbill',convbill.sno) from convbill WHERE convbill.client_id = bank_trans.payee and convbill.status IN('ER','DL') and convbill.due_date <= DATE_SUB(CURDATE(),INTERVAL 91 DAY)) GROUP BY bank_trans.payee) j ON j.payee = emp_list.username
			
			LEFT JOIN (SELECT convbill.client_id,sum( convbill.total ) as amt FROM convbill WHERE convbill.status='ER' GROUP BY convbill.client_id) k ON k.client_id = emp_list.username
			
			LEFT JOIN (SELECT bank_trans.payee,IF(ISNULL(sum( bank_trans.amount )),0,sum( bank_trans.amount )) as amt FROM bank_trans WHERE type = 'BILLCONPM' GROUP BY bank_trans.payee) l on l.payee = emp_list.username
			
			where hrcon_w4.tax='1099' and hrcon_w4.ustatus='active' AND emp_list.lstatus NOT IN ('DA','INACTIVE') AND emp_list.empterminated != 'Y' AND hrcon_general.ustatus='active' 
			group by emp_list.username ";
			
			$oque = "SELECT * FROM (".$oque1.") DUMMY WHERE 1=1";
			$tque = "SELECT COUNT(1) FROM (".$oque1.") DUMMY WHERE 1=1";
		}			
				
		$gstr = "";
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		
		$oque.="" ;
		$tque.="";
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly
		
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildVendors($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);
		return $objResponse;
	}
	
	function buildVendors($que)
	{
		global $db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		$decimalPref    = getDecimalPreference();
		$oneditUrl='';
		//$shortF='';
		$linkShort='';$edit_url_id='';
		
        while ($row=mysql_fetch_array($res))
		{
		
			if($row[2] == "General Vendor"){
            	$oneditUrl = (PAYROLL_PROCESS_BY=='QB') ? "editvendor.php?addr=".$row[7] :"editvendor.php?addr=".$row[10];
				//$shortF = "GV";
				$linkShort = "gv";
				$decimalP = 2;
			}
			else if($row[2] == "Consulting Vendor"){
				$edit_url_id = (PAYROLL_PROCESS_BY=='QB') ? $row[6] : $row[9];
				$oneditUrl="../clients/addacccompany.php?addr=".$edit_url_id."&srnum=".$edit_url_id."&newComp=yes&crm_select=no&sesn=no&edit_acc=yes&venfrm=yes&sesreg=y";
				//$shortF = "CV";
				$linkShort = "cv";
				$decimalP = getDecimalPreference();
			}
			else if($row[2] == "Consultant"){
            	$oneditUrl = (PAYROLL_PROCESS_BY=='QB') ? "/BSOS/HRM/Employee_Mngmt/getnewconreg.php?VendorEmpType=EmpVendor&VEmpType=Vconsultant&command=emphire&addr=new&rec=".$row[7] :"/BSOS/HRM/Employee_Mngmt/getnewconreg.php?VendorEmpType=EmpVendor&VEmpType=Vconsultant&command=emphire&addr=new&rec=".$row[10];
				//$shortF = "CT";
				$linkShort = "con";
				$decimalP = 2;
			}
			
			if(PAYROLL_PROCESS_BY=='QB')
			{
				$grid[$j][0]="";
				$grid[$j][1]=$this->convertSpecChars(stripslashes($row[0]));//Vendor Name
				$grid[$j][2]=$row[1];//Vendor ID
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[2]));//Type
				$grid[$j][4]=$this->convertSpecChars($row[3]);//Phone
				$grid[$j][5]=$this->convertSpecChars(stripslashes($row[4]));//City
				$grid[$j][6]=$this->convertSpecChars(stripslashes($row[5]));//State
				$grid[$j][7]=$oneditUrl;
				 
				$j++;
			}
			else
			{
				/*
				$row[3] = ($row[3] == '-0.00') ? 0.00:$row[3];
				$row[4] = ($row[4] == '-0.00') ? 0.00:$row[4];
				$row[5] = ($row[5] == '-0.00') ? 0.00:$row[5];
				$row[6] = ($row[6] == '-0.00') ? 0.00:$row[6];
				$row[7] = ($row[7] == '-0.00') ? 0.00:$row[7];
				$row[8] = ($row[8] == '-0.00') ? 0.00:$row[8];
				*/
				$grid[$j][0]="";
				$grid[$j][1]=$this->convertSpecChars($row[0]);//Vendor Name
				$grid[$j][2]=$row[1];//Vendor ID
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][4]="<a href=\"javascript:doACPVDE('".$row[9]."','0','0','".$linkShort."')\">".number_format($row[3],$decimalP,'.','')."</a>";
				$grid[$j][5]="<a href=\"javascript:doACPVDE('".$row[9]."','1','30','".$linkShort."')\">".number_format($row[4],$decimalP,'.','')."</a>";
				$grid[$j][6]="<a href=\"javascript:doACPVDE('".$row[9]."','31','60','".$linkShort."')\">".number_format($row[5],$decimalP,'.','')."</a>";
				$grid[$j][7]="<a href=\"javascript:doACPVDE('".$row[9]."','61','90','".$linkShort."')\">".number_format($row[6],$decimalP,'.','')."</a>";
				$grid[$j][8]="<a href=\"javascript:doACPVDE('".$row[9]."','0','90','".$linkShort."')\">".number_format($row[7],$decimalP,'.','')."</a>";
				$grid[$j][9]="<a href=\"javascript:doACPVDE('".$row[9]."','-1','-1','".$linkShort."')\">".number_format($row[8],$decimalP,'.','')."</a>";
				$grid[$j][10]=$oneditUrl;
								
				$j++;
			}	
		}
        return $grid;
	}

	function getExportedExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
        global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
        // Searching array
		$decimalPref=getDecimalPreference();
        $asFields=array("","emp_list.name","emp_list.sno",tzRetQueryStringDate('par_expense.sdate','Date','/'),tzRetQueryStringDate('par_expense.edate','Date','/'),"round(sum(expense.quantity * expense.unitcost),".$decimalPref.")","round(sum(expense.advance),".$decimalPref.")","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.")","users.name",tzRetQueryStringDTime('(par_expense.exported_time)','DateTime24Sec','/'));
        //ordering array
	    $ssFields = array("","emp_list.name","emp_list.sno","MIN(par_expense.sdate)","MAX(par_expense.edate)","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")","round(sum(expense.advance),".$decimalPref.")","round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.")","users.name",tzRetQueryStringDTime('(par_expense.exported_time)','DateTime24Sec','/'));

		$tque = "select count(a.sno) from(select emp_list.name,".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').",round(sum(expense.quantity * expense.unitcost),".$decimalPref."), round(sum(expense.advance),".$decimalPref."),round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref."),par_expense.username,par_expense.sdate, par_expense.edate,par_expense.sno sno from   par_expense FORCE INDEX(username)
			LEFT JOIN emp_list ON emp_list.username=par_expense.username
               LEFT JOIN expense ON expense.parid = par_expense.sno
               LEFT JOIN users ON users.username = par_expense.exported_user WHERE par_expense.sno=expense.parid AND par_expense.username=emp_list.username AND par_expense.astatus IN('Approved','Billed','ER') 
			AND expense.status IN ('Approved','Billed') AND expense.exported_status = 'YES' ";

        $oque = "select par_expense.sno, ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/')." as mindate,". tzRetQueryStringDate('MAX(par_expense.edate)','Date','/')." as maxdate, round(sum(expense.quantity * expense.unitcost),".$decimalPref."), round(sum(expense.advance),".$decimalPref."),round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref."), emp_list.name, par_expense.username, par_expense.sdate, par_expense.edate, emp_list.sno, '".$expServicedate."' AS expfromDate, '".$expServicedateto."' AS exptoDate, ".tzRetQueryStringDTime('MAX(par_expense.exported_time)','DateTime24Sec','/').", users.name from par_expense LEFT JOIN emp_list ON emp_list.username=par_expense.username LEFT JOIN expense ON expense.parid=par_expense.sno LEFT JOIN users ON users.username = par_expense.exported_user where par_expense.astatus IN ('Approved','Billed','ER') AND par_expense.username=emp_list.username AND expense.status IN ('Approved','Billed') AND expense.exported_status = 'YES'";

        $dateString = "";
        if($gridExtraFields['servicedate']!="")
        {
            $fromArr=explode("/",$gridExtraFields['servicedate']);
            $fromDate= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
            $sDate=date("Y-m-d",$fromDate);
            $dateString .= " AND par_expense.sdate >='".$sDate."'";
        }
        if($gridExtraFields['servicedateto']!="")
        {
            $toArr=explode("/",$gridExtraFields['servicedateto']);
            $toDate= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
            $todaf=date("Y-m-d",$toDate);
            $dateString .= " AND par_expense.edate <='".$todaf."'";
        }

        $gstr = $dateString." GROUP BY par_expense.sno ";
        $hvngstr = "";

        if($gridSearchFields[0]!="")
        {
			$gridSearchFields[0]= strtolower($gridSearchFields[0]);	//employee name
        }
		if($gridSearchFields[4]!="")
        {
          $hvngstr = " having round(sum(expense.quantity * expense.unitcost),".$decimalPref.") LIKE '%$gridSearchFields[4]%'";
          $gridSearchFields[4]="";
        }
        if($gridSearchFields[5]!="")
        {
          if($hvngstr!="")
          {
            $hvngstr .= " and round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[5]%'";
          }
          else
          {
            $hvngstr = " having round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[5]%'";
          }
          $gridSearchFields[5]="";
        }
        if($gridSearchFields[6]!="")
        {
          if($hvngstr!="")
          {
            $hvngstr .= " and round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[6]%'";
          }
          else
          {
            $hvngstr = " having round(sum(expense.quantity * expense.unitcost),".$decimalPref.")-round(sum(expense.advance),".$decimalPref.") LIKE '%$gridSearchFields[6]%'";
          }
          $gridSearchFields[6]="";
        }
        $gstr .= " ".$hvngstr;

        $lstr=$gd->buildLimt($gridPage,$gridRecords);

        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); //Order by fields, append the where clause accordingly
        $tque=$gd->buildTQuery($tque,$qstr,$gstr.") a");
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        
        $total=$gd->getTotalRows($tque);
        $gridData=$gd->buildExportedExpenses($oque);
        $objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
	}
	
	function buildExportedExpenses($que)
	{
        global $maildb,$db;
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick='chk_clearTop_TimeSheet();' value='".$row[0]."'"."><span class='checkmark'></span></label>";
			$row[1] = ($row[2]=="00/00/0000")? "" : $row[1];
			$row[2] = ($row[2]=="00/00/0000")? "" : $row[2];
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[6]));
			$grid[$j][2]=$this->convertSpecChars($row[10]);
			$grid[$j][3]=$this->convertSpecChars($row[1]);
			$grid[$j][4]=$this->convertSpecChars($row[2]);
			$grid[$j][5]=$this->convertSpecChars($row[3]);
			$grid[$j][6]=$row[4];
			$grid[$j][7]=$row[5];
			$grid[$j][8]=$this->convertSpecChars(stripslashes(ucwords($row[14])));
			$grid[$j][9]=$row[13];
			$grid[$j][10]="showdetails_exported.php?expstatus=Exported&addr=".$row[7]."&addr1=".$row[0];
            $j++;
		}
        return $grid;
	}

    function getEskillUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
            global $db,$username;

            $gd = new gridData();

            $asFields = array("","users.name","uc.name",tzRetQueryStringDate('esu.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('esu.mdate','DateTime','/'));
            $ssFields = array("","users.name","uc.name","esu.cdate","um.name","esu.mdate");

            $tque="SELECT COUNT(*) FROM eskill_users esu LEFT JOIN users ON users.username=esu.username LEFT JOIN users um ON um.username=esu.muser LEFT JOIN users uc ON uc.username=esu.cuser WHERE esu.status='A'";

            $oque="SELECT esu.sno,users.name,uc.name, ".tzRetQueryStringDate('esu.cdate','DateTime','/').",  um.name, ".tzRetQueryStringDate('esu.mdate','DateTime','/')." FROM eskill_users esu LEFT JOIN users ON users.username=esu.username LEFT JOIN users um ON um.username=esu.muser LEFT JOIN users uc ON uc.username=esu.cuser WHERE esu.status='A'";

            $gstr = "";

            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildEskillUsers($oque);

            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            // $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

            return $objResponse;
    }

    function buildEskillUsers($que)
    {
            global $db;

            $j=0;
            $grid=array();

            $res=mysql_query($que,$db);	
            while($row=mysql_fetch_array($res))
            {
	            $grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
	            $grid[$j][1] = $this->convertSpecChars($row[1]);
	            $grid[$j][2] = $this->convertSpecChars($row[2]); 
	            $grid[$j][3] = $this->convertSpecChars($row[3]);
	            $grid[$j][4] = $this->convertSpecChars($row[4]);
	            $grid[$j][5] = $this->convertSpecChars($row[5]);
	            $grid[$j][6] = "javascript:void(0);";
	            $j++;
            }

            return $grid;
    }
	function getMyProfSubTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone;
		$gd = new gridData();
		$tod				= stripslashes($gridExtraFields['servicedate']);
		$todaf				= stripslashes($gridExtraFields['servicedateto']);
		if($tod!="" && $todaf!="")
			$time_clause	= " AND par_timesheet.sdate>='".$tod."' AND par_timesheet.edate<='".$todaf."' ";
						
		$asFields = array("",tzRetQueryStringDate('result.par_timesheet_sdate','Date','/'),tzRetQueryStringDate('result.par_timesheet_edate','Date', '/'),"result.custName","result.assignName","result.assignIds","","","","result.ts_layout","ROUND(SUM(result.tot_hours),2)","result.getTimeStat");

		$ssFields = array("",tzRetQueryStringDate('result.par_timesheet_sdate','Date','/'),tzRetQueryStringDate('result.par_timesheet_edate','Date', '/'),"result.custName","result.assignName","result.assignIds","","","","result.ts_layout","ROUND(SUM(result.tot_hours),2)","result.getTimeStat");

		$tque	= "SELECT
					result.par_timesheet_sno
				FROM
				(
						SELECT 
							par_timesheet.sno AS par_timesheet_sno, 
							par_timesheet.username AS par_timesheet_username,
							timesheet_hours.client AS timesheet_hours_client,
							TRIM(emp_list.name) AS emp_list_name, 
							emp_list.sno AS emp_list_sno,
							par_timesheet.sdate AS par_timesheet_sdate, 
							par_timesheet.edate AS par_timesheet_edate, 
							SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))) AS tot_hours,
							CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
							getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
							timesheet_hours.status AS timesheet_hours_status,
							MAX(par_timesheet.stime) AS ts_submitted_time,
							IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,
							GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.pusername))) AS assignIds,
							TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(staffacc_cinfo.cname)))) AS custName,
							GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.project))) AS assignName							
						FROM
							timesheet_hours 
						LEFT JOIN
							par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
						LEFT JOIN
							hrcon_jobs ON hrcon_jobs.pusername = timesheet_hours.assid
						LEFT JOIN
						    staffacc_cinfo ON timesheet_hours.client=staffacc_cinfo.sno	
						LEFT JOIN
							emp_list ON emp_list.username = par_timesheet.username 
						WHERE
						    timesheet_hours.status IN  ('ER', 'Saved', 'Rejected')
						    AND par_timesheet.pstatus IN ('ER', 'Saved', 'Rejected','Approved')
						    AND par_timesheet.username='".$username."'	
							$time_clause
						GROUP BY timesheet_hours.parid,timesheet_hours.status 
					
				) result WHERE 1=1 ";

		$oque	="SELECT
						result.par_timesheet_sno,
						result.par_timesheet_username,
						result.timesheet_hours_client,
						result.emp_list_name,
						result.emp_list_sno,
						".tzRetQueryStringDate('result.par_timesheet_sdate','Date','/').",
						".tzRetQueryStringDate('result.par_timesheet_edate','Date','/').",
						ROUND(result.tot_hours,2) AS tot_hours,
						result.ts_layout,
						result.getTimeStat,
						result.timesheet_hours_status,
						".tzRetQueryStringDTime('result.ts_submitted_time','DateTime24Sec','/').",
						result.tab,
						result.assignIds,
						result.custName,
						result.assignName
				FROM
				(
						SELECT 
							par_timesheet.sno AS par_timesheet_sno, 
							par_timesheet.username AS par_timesheet_username,
							timesheet_hours.client AS timesheet_hours_client,
							TRIM(emp_list.name) AS emp_list_name, 
							emp_list.sno AS emp_list_sno,
							par_timesheet.sdate AS par_timesheet_sdate, 
							par_timesheet.edate AS par_timesheet_edate, 
							SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))) AS tot_hours,
							 CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS ts_layout,
							getTimeStat(par_timesheet.pstatus,timesheet_hours.status) AS getTimeStat,
							timesheet_hours.status AS timesheet_hours_status,
							MAX(par_timesheet.stime) AS ts_submitted_time,
							IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,
							GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.pusername))) AS assignIds,
							TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(staffacc_cinfo.cname)))) AS custName,
							GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.project))) AS assignName
						FROM
							timesheet_hours 
						LEFT JOIN
							par_timesheet ON timesheet_hours.parid = par_timesheet.sno 
						LEFT JOIN
							hrcon_jobs ON hrcon_jobs.pusername = timesheet_hours.assid
						LEFT JOIN
						    staffacc_cinfo ON timesheet_hours.client=staffacc_cinfo.sno								
						LEFT JOIN
							emp_list ON emp_list.username = par_timesheet.username 
						WHERE
							timesheet_hours.status IN  ('ER', 'Saved', 'Rejected')
							AND par_timesheet.pstatus IN ('ER', 'Saved', 'Rejected','Approved')
							AND par_timesheet.username='".$username."'
							$time_clause
						GROUP BY timesheet_hours.parid,timesheet_hours.status
					
				) result WHERE 1=1 ";

		$gstr = " GROUP BY result.par_timesheet_sno,result.timesheet_hours_client,result.timesheet_hours_status ";
		if($gridSortCol == 13){
				$ostr = " ORDER BY result.par_timesheet_edate DESC, result.par_timesheet_sdate DESC ";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		}
		$lstr		= $gd->buildLimt($gridPage,$gridRecords);
		$gqstr 		= $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;
		$tque		= $gd->buildTQuery($tque,$qstr,$gstr);
		$oque		= $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$total		= $gd->getTotalCount($tque);
		$gridData	= $gd->buildMyProfSubTimeSheets($oque);

		$objResponse 	= new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}
	function buildMyProfSubTimeSheets($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[]  Onclick=chk_clearTop_TimeSheet()  value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[5]); 
			$grid[$j][2] = $this->convertSpecChars($row[6]);
			$grid[$j][3] = $this->convertSpecChars(str_replace('\\', '',$row[14]));
			$grid[$j][4] = $this->convertSpecChars(str_replace('\\', '',$row[15]));
			$grid[$j][5] = $this->convertSpecChars(str_replace('\\', '',$row[13]));
			if($row[8] == 'Clock In & Out'){
				$grid[$j][6]=$row[8];
			}
			else{
				$grid[$j][6] = $this->convertSpecChars($row[8])."(".$this->convertSpecChars($row[12]).")";
			}
			$grid[$j][7] = $this->convertSpecChars($row[9]);
			$grid[$j][8] = $this->convertSpecChars($row[10]);
			if($row[8] == 'Clock In & Out'){
				$grid[$j][9]=$row[8];
			}
			else{
				$grid[$j][9] = $this->convertSpecChars(str_replace('\\', '',$row[8]))."(".$this->convertSpecChars(str_replace('\\', '',$row[12])).")";
			}
			$grid[$j][10] = $this->convertSpecChars($row[7]);
			$grid[$j][11] = $this->convertSpecChars(str_replace('\\', '',$row[9]));
			$grid[$j][12] = $row[0]."|".$row[1]."|".$row[2]."|".$row[10]."|".$row[8]; //0|10|8 - parid|status|layot

			$j++;
		}

		return $grid;
	}	

	function getMyProfAppTimeSheets($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];

		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
		$asFields = array("",tzRetQueryStringDate('par_timesheet.sdate','Date','/'),tzRetQueryStringDate('par_timesheet.edate','Date','/'),"TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","GROUP_CONCAT(DISTINCT(IF(timesheet_hours.type='EARN',timesheet_hours.client,hrcon_jobs.project)))","GROUP_CONCAT(DISTINCT(IF(timesheet_hours.type='EARN',timesheet_hours.client,hrcon_jobs.pusername)))","ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END" ,"(IF(timesheet_hours.status = 'Billed','Approved','Approved'))","par_timesheet.puser","users.name",tzRetQueryStringDate('timesheet_hours.approvetime','Date','/'));
		$ssFields = array("",tzRetQueryStringDate('par_timesheet.sdate','Date','/'),tzRetQueryStringDate('par_timesheet.edate','Date','/'),"TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname))))","GROUP_CONCAT(DISTINCT(IF(timesheet_hours.type='EARN',timesheet_hours.client,hrcon_jobs.project)))","GROUP_CONCAT(DISTINCT(IF(timesheet_hours.type='EARN',timesheet_hours.client,hrcon_jobs.pusername)))","ROUND(SUM(timesheet_hours.hours),2)","CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END ","(IF(timesheet_hours.status = 'Billed','Approved','Approved'))","par_timesheet.puser","users.name",tzRetQueryStringDate('timesheet_hours.approvetime','Date','/'));
        // TimeSheet Grid Load Optimization 
        $timesheetFromDate =  $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];
        $searchDateCheck = "AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."'";
        $searchDateCheck = "AND ".tzRetQueryStringDate('par_timesheet.sdate','YMDDate','-').">='".$minDateValue."'";
        $timesheetFromDate = $gridExtraFields['servicedate'];
        $timesheetToDate =  $gridExtraFields['servicedateto'];

        ///// TimeSheet Grid Load Optimization code ends ///////
		$tque = "SELECT count(1) 
			FROM timesheet_hours
			LEFT JOIN par_timesheet ON timesheet_hours.parid = par_timesheet.sno
			LEFT JOIN hrcon_jobs  ON timesheet_hours.assid = hrcon_jobs.pusername 
			LEFT JOIN staffacc_cinfo s ON timesheet_hours.client=s.sno
			LEFT JOIN users ON timesheet_hours.auser = users.username
			WHERE par_timesheet.username='".$username."' AND par_timesheet.astatus IN ('Approved','ER','Billed') and timesheet_hours.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'";

		$oque = "SELECT par_timesheet.sno,".tzRetQueryStringDate('par_timesheet.sdate','Date','/').",".tzRetQueryStringDate('par_timesheet.edate','Date','/').",SUM(CAST(timesheet_hours.hours AS DECIMAL(5,2))),par_timesheet.astatus,par_timesheet.pstatus,CASE par_timesheet.template WHEN 'TimeInTimeOut' THEN 'In & Out' WHEN 'Regular' THEN 'Regular' WHEN 'UOM' THEN 'UOM' WHEN 'Custom' THEN 'Custom' WHEN 'Clockinout' THEN 'Clock In & Out' END AS layout,par_timesheet.puser,par_timesheet.auser,timesheet_hours.status,IF(timesheet_hours.edate!='0000-00-00','Range','Daily') AS tab,GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.pusername))),TRIM(BOTH ',' FROM GROUP_CONCAT(DISTINCT(TRIM(s.cname)))),GROUP_CONCAT(DISTINCT (IF(timesheet_hours.type = 'EARN',timesheet_hours.client,hrcon_jobs.project))),users.name FROM timesheet_hours 	
			LEFT JOIN par_timesheet ON timesheet_hours.parid = par_timesheet.sno
			LEFT JOIN hrcon_jobs  ON timesheet_hours.assid = hrcon_jobs.pusername 
			LEFT JOIN staffacc_cinfo s ON timesheet_hours.client=s.sno
			LEFT JOIN users ON timesheet_hours.auser = users.username
			WHERE par_timesheet.username='".$username."' AND  par_timesheet.astatus IN ('Approved','ER','Billed') and timesheet_hours.status IN ('Approved','Billed') ".$searchDateCheck." AND ".tzRetQueryStringDate('par_timesheet.edate','YMDDate','-')."<='".$maxDateValue."'";
        $gstr="GROUP BY timesheet_hours.parid,timesheet_hours.status";
        $gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
		$ostr ="";
		if($gridSortCol == 16){
				$ostr = " ORDER BY par_timesheet.edate DESC, par_timesheet.sdate DESC";				
			}else{
				$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		}
		$lstr = $gd->buildLimt($gridPage,$gridRecords);

		$qstr = $gqstr[0];
		$hstr = $gqstr[1];
		$gstr.=$hstr;

		$tque = $gd->buildTQuery($tque,$qstr,$gstr);
		$total = $gd->getTotalCount($tque);
		$oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		$gridData = $gd->buildMyProfAppTimeSheets($oque);
        $objResponse = new xajaxResponse();	
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
	}

	function buildMyProfAppTimeSheets($que)
	{
		global $db, $username;

		$j=0;
        $mindatearray =array();
        $maxdatearray = array();
		$grid=array();
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{
		$qu="select hours,hours,timesheet_hours.auser,MAX(".tzRetQueryStringDTime('timesheet_hours.approvetime','DateTime','/')."),hours from timesheet_hours LEFT JOIN par_timesheet ON timesheet_hours.parid=par_timesheet.sno where timesheet_hours.status IN ('Approved','Billed') and par_timesheet.astatus IN ('Approved','ER','Billed') and ".tzRetQueryStringDate('timesheet_hours.sdate','Date','/').">='".$row[1]."' and ".tzRetQueryStringDate('timesheet_hours.sdate','Date','/')."<='".$row[2]."' and par_timesheet.sno='".$row[0]."'and par_timesheet.username='".$username."' GROUP BY timesheet_hours.sno";
        $hres=mysql_query($qu,$db);

       	$appusername = array();
		$ApproveUser = '';
		$ApproveDate = '';
		$appuserval = '';
        while ($hrow =mysql_fetch_array($hres))
        {            
			array_push($appusername,$hrow[2]);	
			$ApproveDate = $hrow[3];
        }
		$appusername = array_values(array_unique($appusername));		
		$arrLeanth = count($appusername);
		$seperater = '';
		for($r = 0; $r< $arrLeanth; $r++)
		{
			$appuserval .= $seperater."".$appusername[$r];
			$seperater = ",";
		}
		$appuserval = str_replace(",","','",$appuserval);
		$get_username="select name from users where username IN ('".$appuserval."')";
		$res_username=mysql_query($get_username,$db);
		$sep = "";
		while($row_username=mysql_fetch_row($res_username))
		{
			$ApproveUser .= $sep."".$row_username[0];
			$sep = ", ";
		}

        $user_que="select name from users where username='".$row[6]."'";
        $rdata=mysql_query($user_que,$db);
        $user_res=mysql_fetch_row($rdata);
        
        $que1="select name from users where username='".$row[7]."'";
        $rdata1=mysql_query($que1,$db);
        $res1=mysql_fetch_row($rdata1);

		$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
		$grid[$j][1]=$this->convertSpecChars($row[1]);
		$grid[$j][2]=$this->convertSpecChars(str_replace('\\', '', $row[2]));
		$grid[$j][3]=$this->convertSpecChars(str_replace('\\', '', $row[12]));
		$grid[$j][4]=$this->convertSpecChars($row[13]);
		$grid[$j][5]=$this->convertSpecChars(str_replace('\\', '', $row[11]));
		$grid[$j][6]=$this->convertSpecChars(str_replace('\\', '', $row[3]));
		if($row[6] == 'Clock In & Out'){
				$grid[$j][7]=$row[6];
		}
		else{
				$grid[$j][7]=$this->convertSpecChars(trim($row[6]).'('.$row[10].')');
		}
		
		$grid[$j][8]="Approved";
		$grid[$j][9]=$this->convertSpecChars($row[7]);
		$grid[$j][10]=$this->convertSpecChars(str_replace('\\', '', $ApproveUser));
		$grid[$j][11]=$ApproveDate;
		$grid[$j][12]= $row[0]."|".$row[9]."|".$row[6];
   		
		$j++;
		}
      
	    return $grid;
	}
	
	// ACA Employee management
	function  getACAEmpManagement($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $db,$username,$user_timezone;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();
    	$asFields=array("","hg.fname","hg.lname","el.sno","hg.wphone","hg.email",
		"DATE_FORMAT( STR_TO_DATE(emp_start_date,'%m/%d/%Y'),'%Y-%m-%d')",
		"IF(hc.job_type = 'Y' ,manage.name,emp_manage.name)","SUM(th.hours)","aed.eligibility_status",
		"aed.effective_date","aed.not_eligible_date","acam.name","aed.ds_pobstatus","empterminated",
		"jtype","hp.ssn",
		"CONCAT_WS(' - ',department.depcode,department.deptname)","aed.mdate","musr.name");

	   	$ssFields=array("","hg.fname","hg.lname","el.sno","hg.wphone","hg.email",
		"IF((IF(hc.job_type = 'Y' ,manage.name,emp_manage.name) = 'Internal Direct'),
		(IF(hc.emp_rehire_date ='',DATE_FORMAT(STR_TO_DATE(IF(hc.date_hire = '0-0-0' OR hc.date_hire = '', '', hc.date_hire),'%m-%d-%Y'),'%m/%d/%Y'),
		DATE_FORMAT( IF(hc.emp_rehire_date='01-01-0001 00:00:00','',hc.emp_rehire_date), '%m/%d/%Y'))),
		'TC')",
		"IFNULL(emp_manage.name,manage.name)","","aed.eligibility_status","aed.effective_date","aed.not_eligible_date","acam.name", "aed.ds_pobstatus","empterminated","jtype","hp.ssn","CONCAT_WS(' - ',department.depcode,department.deptname)","aed.mdate","musr.name");
		
		$department_dynStr = " AND FIND_IN_SET('".$username."',department.permission)>0 ";
		
		$tque = "SELECT COUNT(distinct(el.sno)) FROM aca_emp_data aed
						INNER JOIN emp_list el ON el.sno = aed.emp_sno
						LEFT JOIN hrcon_general hg on hg.username=el.username
						LEFT JOIN hrcon_personal hp on hp.username=el.username
						LEFT JOIN hrcon_jobs hj ON el.username=hj.username and hj.ustatus IN ('closed', 'active') 
						LEFT JOIN hrcon_compen hc ON hc.username=el.username 
						LEFT JOIN department ON hc.dept=department.sno 
						LEFT JOIN manage ON manage.sno=hj.jotype AND manage.type='jotype'
						LEFT JOIN manage emp_manage ON emp_manage.sno=hc.emptype and emp_manage.type='jotype'
						LEFT JOIN timesheet_hours th ON th.username=el.username AND th.status IN ('Approved', 'Billed') AND th.assid=hj.pusername
						LEFT JOIN users musr on el.muser=musr.username
						LEFT JOIN aca_manage_types acam ON (acam.sno = aed.coverage_status AND acam.type = 'coverage_status' AND acam.status='active') 
			 			WHERE hc.ustatus='active' and hg.ustatus='active' and hp.ustatus='active' and el.lstatus not in ('DA','INACTIVE') 
						".$department_dynStr;

			 $oque = "SELECT hg.fname,hg.lname,el.sno,hg.wphone,hg.email,
						IF((IF(hc.job_type = 'Y' ,manage.name,emp_manage.name) = 'Internal Direct'),					
						(IF(hc.emp_rehire_date ='',DATE_FORMAT(STR_TO_DATE(IF(hc.date_hire = '0-0-0' OR hc.date_hire = '', '', hc.date_hire),'%m-%d-%Y'),'%m/%d/%Y'),
						DATE_FORMAT( IF(hc.emp_rehire_date='01-01-0001 00:00:00','',hc.emp_rehire_date), '%m/%d/%Y'))),
						'TC') as emp_start_date,
						IF(hc.job_type = 'Y' ,manage.name,emp_manage.name) as emp_type,SUM(th.hours) as eligible_hrs, IF(aed.eligibility_status != '',aed.eligibility_status,'Not Eligible'),DATE_FORMAT(CONVERT_TZ(aed.effective_date,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),DATE_FORMAT(CONVERT_TZ(aed.not_eligible_date,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),acam.name,aed.ds_pobstatus,IF(el.empterminated='N','Active','Terminated') as empterminated,UNIX_TIMESTAMP(DATE_FORMAT(el.tdate,'%Y-%m-%d')) ter_date,
						IF(hj.jtype='OB','On Bench',IF(hj.jtype='OP' AND hj.ustatus='active','On Assignment','')) as jtype,hp.ssn, 
						CONCAT_WS(' - ',department.depcode,department.deptname) AS deptname,
						DATE_FORMAT(CONVERT_TZ(aed.mdate,'SYSTEM','".$user_timezone[1]."'),'%m/%d/%Y'),musr.name ,
						
						IF(el.email = '', IF(el.alternate_email = '', IF(el.other_email = '', el.name, ''), ''), '') as email_flag_name,
						IF(el.email = '', IF(el.alternate_email = '', el.other_email, el.alternate_email), el.email) as emp_email_id,el.username,aed.is_manual_update FROM aca_emp_data aed
						INNER JOIN emp_list el ON el.sno = aed.emp_sno
						LEFT JOIN hrcon_general hg on hg.username=el.username
						LEFT JOIN hrcon_personal hp on hp.username=el.username
						LEFT JOIN hrcon_jobs hj ON el.username=hj.username and hj.ustatus IN ('closed', 'active') 
						LEFT JOIN hrcon_compen hc ON hc.username=el.username 
						LEFT JOIN department ON hc.dept=department.sno 
						LEFT JOIN manage ON manage.sno=hj.jotype and manage.type='jotype'
						LEFT JOIN manage emp_manage ON emp_manage.sno=hc.emptype and emp_manage.type='jotype'
						LEFT JOIN timesheet_hours th ON th.username=el.username and th.status IN ('Approved', 'Billed') AND th.assid=hj.pusername
						LEFT JOIN aca_manage_types acam ON (acam.sno = aed.coverage_status AND acam.type = 'coverage_status' AND acam.status='active')
						LEFT JOIN users musr on aed.muser=musr.username 
						WHERE hc.ustatus='active' AND hg.ustatus='active' AND hp.ustatus='active' AND el.lstatus not in ('DA','INACTIVE')
						".$department_dynStr;
						
       
		$hvngstr="";
		if($gridSearchFields[6]!="")
        {
            $hvngstr = " AND IFNULL(emp_manage.name,manage.name) = '$gridSearchFields[6]'";
			$gridSearchFields[6]="";
        }
		
		if($gridSearchFields[8]!="")
        {
            $hvngstr = " AND aed.eligibility_status = '$gridSearchFields[8]'";
			$gridSearchFields[8]="";
        }
        $gstr = " ".$hvngstr;
        $ogstr = " ".$hvngstr;
		$gstr .= " GROUP BY el.sno";
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,$ogstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildACAEmpManagement($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;
	}

	function buildACAEmpManagement($que)
	{
		global $db,$ac_aced;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
			if($row[4] == "-" || $row[4] == "--" || $row[4] == "---")
				$row[4] = "";
			else
				$row[4] = $row[4];
			
			if($row[13]=="Terminated")
			{
				if($row[14]<=time())
					$employee_cur_status = $this->convertSpecChars($row[13]);
				else
					$employee_cur_status = $this->convertSpecChars("Active");
			}
			else
			{
				$employee_cur_status = $this->convertSpecChars($row[13]);
			}
			
			$emp_send = $row[0]." ".$row[1]."^".$row[12];
	
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=\"$row[2]\"><span class='checkmark'></span></label><input type='hidden' id='email_flag_name_".$row[2]."' name='email_flag_name[]' value='".$this->convertSpecChars($row[20])."'>
			<input type='hidden' id='employee_email_".$row[2]."' name='employee_email[]' value='".$this->convertSpecChars($row[21])."'><input type='hidden' id='employee_ds_pob_".$row[2]."' name='employee_ds_pob[]' value='".$this->convertSpecChars($emp_send)."'><input type='hidden' id='employee_cur_status_".$row[2]."' name='employee_cur_status[]' value='".$employee_cur_status."'><input type='hidden' id='employee_aca_status_".$row[2]."' name='employee_aca_status_[]' value='".$row[8]."'>";

			//Code for Eligibility check is System or Manual.
			$eligibility_check = 'System';

			if($row[23]==1)
			{
				$eligibility_check = 'Manual';
			}
			
			
			$grid[$j][1]=$this->convertSpecChars($row[0]);
			$grid[$j][2]=$this->convertSpecChars($row[1]);
			$grid[$j][3]=$row[2];
			$grid[$j][4]=$this->convertSpecChars($row[3]);
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			
			if($row[5]=="TC"){
				$tc_start_date =$this->getTimesheetFirstDate($row[22]);
				$grid[$j][6]=$this->convertSpecChars($tc_start_date);
			}else{
				$grid[$j][6]=$this->convertSpecChars($row[5]);
			}
			
			
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			$grid[$j][8]=($row[7] ==0) ? '' :number_format($row[7],2);
			$grid[$j][9]=$this->convertSpecChars($row[8]." (".$eligibility_check.")");
			$grid[$j][10]=$this->convertSpecChars($row[9]);
			$grid[$j][11]=$this->convertSpecChars($row[10]);
			$grid[$j][12]=$this->convertSpecChars($row[11]);
			
			$ds_pobstatus = $row[12];
			if($ds_pobstatus == 'initiated')
			{
				$grid[$j][13] = ucwords($this->convertSpecChars($ds_pobstatus));
			}
			else
			{
				$grid[$j][13]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[2]."','aca_mngmt')>".ucwords($this->convertSpecChars($row[12]))."</a>";
			}
			
			$grid[$j][14]=$this->convertSpecChars($employee_cur_status);
			$grid[$j][15]=$this->convertSpecChars($row[15]);
			$grid[$j][16]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[16])));
			$grid[$j][17]=$this->convertSpecChars($row[17]);
			$grid[$j][18]=$this->convertSpecChars($row[18]);
			$grid[$j][19]=$this->convertSpecChars($row[19]);
			$grid[$j][20]="";
			$grid[$j][21]=$row[2];

			$j++;
		}
	    return $grid;
	}
	
	function getTimesheetFirstDate($emp_username){
		global $db;
		
		$timeQue = "SELECT DATE_FORMAT(IF(ths.sdate = '01-01-0001 00:00:00', '', ths.sdate), '%m/%d/%Y') AS assgn_sdate FROM timesheet_hours ths WHERE ths.username='".$emp_username."' AND ths.status IN ('Approved', 'Billed') ORDER BY sdate ASC LIMIT 1";
		$timeRes = mysql_query($timeQue,$db);
		$timeRow = mysql_fetch_row($timeRes);
		
		return $timeRow[0];
		
	}
	
   // ACA Employee Activities	
	function getACAActivities($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
		global $db,$username,$e_type,$conditionquery; 

		$gd=new gridData();
		$osFields=array("","sdate","users.name","subject","title","subtype","cmngmt_pr.email_attach_flag","tysno","cmngmt_pr.username");
		$asFields=array("","cast(".tzRetQueryStringDTime('sdate','DateTimeSec','/')."AS CHAR)","users.name","subject","title","subtype","tysno","cmngmt_pr.username","cmngmt_pr.email_attach_flag"); 
			
		$tque="select count(distinct(cmngmt_pr.sno)) from cmngmt_pr,users  where cmngmt_pr.lmuser = users.username and title in ('".$e_type."') ".$conditionquery;
		
		$oque="select cmngmt_pr.sno,".tzRetQueryStringDTime('sdate','DateTimeSec','/').",users.name,subject,IF(title='Email','Sent Mail',title) as title,tysno,subtype,cmngmt_pr.username,cmngmt_pr.email_attach_flag from users,cmngmt_pr  where cmngmt_pr.lmuser = users.username and title in ('".$e_type."') ".$conditionquery;
		
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);

		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$osFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque="$oque $qstr $ostr $lstr";
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildACAActivities($oque);
		$objResponse = new xajaxResponse(CONVERT_DEFAULT_MAIL_CHAR,false);
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;

	}	
	
	function buildACAActivities($que)
	{
		global $db,$con_id,$addr;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$despath='';
			
			if($row[6]=="Received Mail"){
				$despath="/BSOS/Activities/email/showemaildet.php?addr=".$addr."&message=".$row[5]."&con_id=".$con_id."&emailid=".$row[6]."";
			}											 	
			else if(strstr($row[6],"POB") || strstr($row[6],"SIGNER")){
				$despath="/BSOS/Activities/document/editdoc.php?addr=".$addr."&sno=".$row[5]."&con_id=".$con_id."&do_action=viewdoc";
			}

			$grid[$j][0]=$despath;
			$grid[$j][1]=$this->convertSpecChars(strtolower($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			
			if(($row[3] == "") && ($row[4]=="REmail") )
				$row[3]="No Subject";
			$grid[$j][3]=iconv("ISO-8859-1","UTF-8",$this->convertSpecChars($row[3]));

			$grid[$j][4]=$this->convertSpecChars($row[4]);
			
			$grid[$j][5]=$this->convertSpecChars($row[6]);
		    
			if($row[8] == 1 || $row[8] == '1')
				$grid[$j][6]="<img src=/BSOS/images/icons/attach.gif alt='attachment' border=0 width=16 heigh=16>";
			else
				$grid[$j][6] ="";
				
			$grid[$j][7]="";
			
			if(strstr($row[6],"POB") || strstr($row[6],"SIGNER")){
				$filedownloadpath="/BSOS/Activities/document/getdoc.php?sno=".$row[5]."";
				$fileviewpath="/BSOS/Activities/document/viewdoc.php?sno=".$row[5]."";				
				$grid[$j][7]="<a href='".$filedownloadpath."'><i alt='Download Document' class='fa fa-download'></i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<a href='javascript: previewDocumentFile(".$row[5].")'><i class='fa fa-tasks' alt='View Document'></i></a>";
				$grid[$j][8]="";
			}
			
			//$grid[$j][8]="";
			$j++;
		}
		return $grid;
	}
	
	function getHubSpotUsers($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
            global $db,$username;

            $gd = new gridData();

            $asFields = array("","users.name","uc.name",tzRetQueryStringDate('hsu.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('hsu.mdate','DateTime','/'));
            $ssFields = array("","users.name","uc.name","hsu.cdate","um.name","hsu.mdate");

            $tque="SELECT COUNT(*) FROM hubspot_users hsu LEFT JOIN users ON users.username=hsu.username LEFT JOIN users um ON um.username=hsu.muser LEFT JOIN users uc ON uc.username=hsu.cuser WHERE hsu.status='A'";

            $oque="SELECT hsu.sno,users.name,uc.name, ".tzRetQueryStringDate('hsu.cdate','DateTime','/').",  um.name, ".tzRetQueryStringDate('hsu.mdate','DateTime','/')." FROM hubspot_users hsu LEFT JOIN users ON users.username=hsu.username LEFT JOIN users um ON um.username=hsu.muser LEFT JOIN users uc ON uc.username=hsu.cuser WHERE hsu.status='A'";

            $gstr = "";

            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildEskillUsers($oque);

            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

            return $objResponse;
    }

    function buildHubSpotUsers($que)
    {
            global $db;

            $j=0;
            $grid=array();

            $res=mysql_query($que,$db);	
            while($row=mysql_fetch_array($res))
            {
	            $grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
	            $grid[$j][1] = $this->convertSpecChars($row[1]);
	            $grid[$j][2] = $this->convertSpecChars($row[2]); 
	            $grid[$j][3] = $this->convertSpecChars($row[3]);
	            $grid[$j][4] = $this->convertSpecChars($row[4]);
	            $grid[$j][5] = $this->convertSpecChars($row[5]);
	            $grid[$j][6] = "javascript:void(0);";
	            $j++;
            }

            return $grid;
    }
    
    function getManageQuestionnaireGrid($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
            global $db,$username;
            $gd = new gridData();
            if($gridSearchFields[5]!="")
            {
                $gridSearchFields[5]= preg_replace('/\s+/', '+', $gridSearchFields[5]);
            }
            
            if($gridSearchFields[0]!="")
            {
                $gridSearchFields[0]= addslashes($gridSearchFields[0]);
            }
            
            if($gridSearchFields[2]!="")
            {
                $gridSearchFields[2]= addslashes($gridSearchFields[2]);
            }
            
            $asFields = array("","jmq.question","jqt.field_desc","GROUP_CONCAT(jqg.group_name)","IF(jmq.is_required,'YES','NO')","jmq.status","ufd.element_name","uc.name",tzRetQueryStringDate('jmq.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('jmq.mdate','DateTime','/'));
            $ssFields = array("","jmq.question","jqt.field_desc","GROUP_CONCAT(jqg.group_name)","IF(jmq.is_required,'YES','NO')","jmq.status","ufd.element_name","uc.name",tzRetQueryStringDate('jmq.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('jmq.mdate','DateTime','/'));

            $tque="SELECT COUNT(DISTINCT(jmq.id))
                   FROM jobboard_manage_questions jmq
                        LEFT JOIN grouped_questions gpdq ON jmq.id = gpdq.question_id AND gpdq.status='active'
                        LEFT JOIN jobboard_question_groups jqg ON gpdq.group_id = jqg.id AND jqg.status='active'
                        LEFT JOIN udf_form_details ufd ON jmq.applicant_udf_elementid = ufd.id
                        LEFT JOIN jobboard_question_types jqt ON jmq.fieldtype_id = jqt.sno
                        LEFT JOIN users uc ON uc.username = jmq.cuser
                        LEFT JOIN users um ON um.username = jmq.muser
                  WHERE jmq.status NOT IN ('delete','backup')";
            
            $oque="SELECT jmq.id,
                        jmq.question,
                        jqt.field_desc,
                        GROUP_CONCAT(jqg.group_name),
                        IF(jmq.is_required,'YES','NO'),
                        jmq.status,
                        ufd.element_name,
                        uc.name AS createduser,
                        ".tzRetQueryStringDate('jmq.cdate','DateTime','/').",
                        um.name AS modifieduser,
                        ".tzRetQueryStringDate('jmq.mdate','DateTime','/')."
                   FROM jobboard_manage_questions jmq
                        LEFT JOIN grouped_questions gpdq ON jmq.id = gpdq.question_id AND gpdq.status='active'
                        LEFT JOIN jobboard_question_groups jqg ON gpdq.group_id = jqg.id AND jqg.status='active'
                        LEFT JOIN udf_form_details ufd ON jmq.applicant_udf_elementid = ufd.id
                        LEFT JOIN jobboard_question_types jqt ON jmq.fieldtype_id = jqt.sno
                        LEFT JOIN users uc ON uc.username = jmq.cuser
                        LEFT JOIN users um ON um.username = jmq.muser
                  WHERE jmq.status NOT IN ('delete','backup')";
            $gstr = "group by jmq.id";
            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $gqstr=$gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $qstr = $gqstr[0];
            $hstr = $gqstr[1];
            $gstr.=$hstr;
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
            $total=$gd->getTotalCount($tque);
            $gridData=$gd->buildManageQuestionnaire($oque);
            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
            return $objResponse;
    }	
	
	function buildManageQuestionnaire($oque)
	{
            global $db;
            $j=0;
            $grid=array();
            $res=mysql_query($oque,$db);	
            while($row=mysql_fetch_row($res))
            {
                $grid[$j][0]= "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
		$grid[$j][1]= html_tls_specialchars(stripslashes($row[1]),ENT_QUOTES);
		$grid[$j][2]= $row[2];
		$grid[$j][3]= html_tls_specialchars(stripslashes(trim($row[3],",")),ENT_QUOTES);
		$grid[$j][4]= $row[4];
		$grid[$j][5]= ucfirst($row[5]);
		$grid[$j][6]= stripslashes(urldecode($row[6]));
		$grid[$j][7]= $row[7];
		$grid[$j][8]= $row[8];
		$grid[$j][9]= $row[9];
		$grid[$j][10]= ($row[10] == "00/00/0000 12:00 AM")? "" : $row[10];
        $grid[$j][11]= $row[0];
                $j++;  
            }
            return $grid;
    }

    function getManageGroupsGrid($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
            global $db,$username;
            $gd = new gridData();
            if($gridSearchFields[0]!="")
            {
                $gridSearchFields[0]= addslashes($gridSearchFields[0]);
            }

            $asFields = array("","jqg.group_name","jqg.status","uc.name",tzRetQueryStringDate('jqg.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('jqg.mdate','DateTime','/'));
            $ssFields = array("","jqg.group_name","jqg.status","uc.name",tzRetQueryStringDate('jqg.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('jqg.mdate','DateTime','/'));

            $tque="SELECT COUNT(*)
                   FROM jobboard_question_groups jqg
                   LEFT JOIN users uc ON uc.username = jqg.cuser
                   LEFT JOIN users um ON um.username = jqg.muser
                   WHERE jqg.status NOT IN ('delete','backup')";
            
            $oque="SELECT jqg.id,
                        jqg.group_name,
                        jqg.status,
                        uc.name AS createduser,
                        ".tzRetQueryStringDate('jqg.cdate','DateTime','/').",
                        um.name AS modifieduser,
                        IF(jqg.mdate = '0000-00-00 00:00:00','',".tzRetQueryStringDate('jqg.mdate','DateTime','/').")
                    FROM jobboard_question_groups jqg
                    LEFT JOIN users uc ON uc.username = jqg.cuser
                    LEFT JOIN users um ON um.username = jqg.muser                 
                    WHERE jqg.status NOT IN ('delete','backup')";
            $gstr = "";

            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            //$ostr = "ORDER BY jqg.mdate DESC";

            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildManageGroups($oque);
            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
            return $objResponse;
    }	
	
	function buildManageGroups($oque)
	{
            global $db;
            $j=0;
            $grid=array();
            $res=mysql_query($oque,$db);	
            while($row=mysql_fetch_row($res))
            {
                $grid[$j][0]= "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clear_mainChkbox() value='".$row[0]."'><span class='checkmark'></span></label>";
				$grid[$j][1]= html_tls_specialchars(stripslashes($row[1]),ENT_QUOTES);
				$grid[$j][2]= ucfirst($row[2]);
				$grid[$j][3]= $row[3];
				$grid[$j][4]= $row[4];
				$grid[$j][5]= $row[5];
				$grid[$j][6]= $row[6];
				$grid[$j][7]= $row[0];
				$grid[$j][8]= "Groups";
				$j++;  
            }
            return $grid;
    }
	function  getApprovedExpenses($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone;
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$parTimeUsername = $gridExtraFields['addr'];
		$minDateValue = date("Y-m-d",strtotime($minDateValue));
		$maxDateValue = date("Y-m-d",strtotime($maxDateValue));
		$decimalPref    = getDecimalPreference();      

		
		if($gridSortCol=="")
			$gridSortCol=1;
		
		$gd=new gridData();		

		$asFields=array("",tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/'),tzRetQueryStringDate('MAX(par_expense.edate)','Date','/'),"ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)","ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)","pm.name","GROUP_CONCAT(DISTINCT users.name ORDER BY users.name ASC)",tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24Sec','/'));

		$ssFields=array("","MIN(par_expense.sdate)","MAX(par_expense.edate)","ROUND(SUM(expense.quantity * expense.unitcost),$decimalPref)","ROUND(SUM(expense.advance),$decimalPref)","ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),$decimalPref)","pm.name","GROUP_CONCAT(DISTINCT users.name ORDER BY users.name ASC)","MAX(expense.approvetime)");
	
		$tque = "SELECT COUNT(1) FROM (SELECT '', ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), users.name, ".tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24Sec','/').", expense.parid FROM par_expense LEFT JOIN expense ON expense.parid=par_expense.sno LEFT JOIN users ON users.username=expense.approveuser LEFT JOIN users pm ON pm.username = par_expense.puser WHERE par_expense.username='".$parTimeUsername."' AND 
			par_expense.astatus IN ('Approved','Billed','ER')  AND 
			expense.status IN ('Approved','Billed') AND 
			expense.exported_status!='YES' AND "
			.tzRetQueryStringDate('par_expense.sdate','YMDDate','-').">='".$minDateValue."' AND "
			.tzRetQueryStringDate('par_expense.edate','YMDDate','-')."<='".$maxDateValue."'";
		
		$oque = "SELECT par_expense.sno, ".tzRetQueryStringDate('MIN(par_expense.sdate)','Date','/').", ".tzRetQueryStringDate('MAX(par_expense.edate)','Date','/').", ROUND(SUM(expense.quantity * expense.unitcost),".$decimalPref."), ROUND(SUM(expense.advance),".$decimalPref."), ROUND((SUM(expense.quantity * expense.unitcost) - SUM(expense.advance)),".$decimalPref."), users.name, ".tzRetQueryStringDTime('MAX(expense.approvetime)','DateTime24Sec','/').", expense.parid,pm.name as proj_mngr
		 ,GROUP_CONCAT(DISTINCT users.name ORDER BY users.name ASC)
			FROM  par_expense
			LEFT JOIN expense ON expense.parid=par_expense.sno 
			LEFT JOIN users ON users.username = expense.approveuser 
			LEFT JOIN users as pm ON pm.username = par_expense.puser 
		WHERE par_expense.username='".$parTimeUsername."' AND 
			par_expense.astatus IN ('Approved','Billed','ER')  AND 
			expense.status IN ('Approved','Billed') AND 
			expense.exported_status!='YES' AND "
			.tzRetQueryStringDate('par_expense.sdate','YMDDate','-').">='".$minDateValue."' AND "
			.tzRetQueryStringDate('par_expense.edate','YMDDate','-')."<='".$maxDateValue."'";

		$grp_str = " GROUP BY par_expense.sno";
		$lstr = $gd->buildLimt($gridPage,$gridRecords);
		$qstr1 = $gd->buildQSTRTimeSht($gridSearchType,$gridSearchFields,$asFields);
		$ostr = $gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly

		$tque = $gd->buildTQuery($tque,$qstr,$grp_str.'  '.$qstr1.')a');
		
		
		$oque = "$oque $qstr $grp_str $qstr1 $ostr $lstr";
		
    	$total = $gd->getTotalRows($tque);
		$gridData = $gd->buildApprovedExpenses($oque);
		
		$objResponse = new xajaxResponse();
		
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		return $objResponse;
	}

	function buildApprovedExpenses($que)
	{

		global $maildb,$db;

		$j=0;
		$grid=array();
		
		$decimalPref    = getDecimalPreference();
		$minDateValue = $gridExtraFields['servicedate'];
		$maxDateValue = $gridExtraFields['servicedateto'];
		$parTimeUsername = $gridExtraFields['addr'];    

		
		$res=mysql_query($que,$db);
        while ($row=mysql_fetch_array($res))
		{

			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' OnClick=chk_clearTop_TimeSheet() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars(stripslashes($row[1]));
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[3]);
			$grid[$j][4]=$this->convertSpecChars($row[4]);
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]="";
			$grid[$j][7]=$this->convertSpecChars($row[10]);//$ApproveUser; [6]
			$grid[$j][8]=$this->convertSpecChars($row[7]);//$ApproveDate;
			$grid[$j][9]=$row[0];
			$j++;
		}
      
	    return $grid;
	}	
	
	// Vendors create Bills Grid
    function getCreateBillsGrid($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db,$username;
        $gd = new gridData();
        $decimalPref=getDecimalPreference();

        include("vendorbills_management/createBillsGrid.php");
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $gqstr=$gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
        $qstr = $gqstr[0];
        $hstr = $gqstr[1];
        $gstr.=$hstr;
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        $total=$gd->getTotalCount($tque);
        $gridData=$gd->buildCreateBills($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
       //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
    }	
	
    function buildCreateBills($oque)
    {
        global $db;
        $decimalPref=getDecimalPreference();
        $j=0;
        $grid=array();
        $res=mysql_query($oque,$db);	
        while($row=mysql_fetch_row($res))
        {
            $grid[$j][0]= "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chkMainChkbox() value='".$row[5].'|'.$row[2]."'><span class='checkmark'></span></label>";
            $grid[$j][1]= html_tls_specialchars(stripslashes($row[1]),ENT_QUOTES);
            $grid[$j][2]= $row[0];
            $grid[$j][3]= $row[2];
            $grid[$j][4]= $row[3];
            $grid[$j][5]= number_format($row[4],2,'.','');
            $grid[$j][6]= $row[5].'|'.$row[2];

            $j++;
        }
        return $grid;
    }
    function buildQSTRGroupForVendorsPayBills($gridSearchType,$gridSearchFields,$asFields)
    {
        $qstr="";
        $hstr="";
                
        $statusSingle=false;
        $statusGroup=false;
        for($i=0;$i<count($gridSearchFields);$i++)
        {
                if($gridSearchFields[$i]!="" && !strpos("*".$asFields[$i+1],"GROUP_CONCAT") && !strpos("*".$asFields[$i+1],"DISTINCT") && !strpos("*".$asFields[$i+1],"SUM") && $asFields[$i+1]!=="dueDate")
                {
                        $statusSingle=true;
                        break;
                }
        }
        if($statusSingle)
        {
                $qstr=" AND (";
                for($i=0;$i<count($gridSearchFields);$i++)
                {
                        $gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
                        $gridSearchField=str_replace("%","\%",$gridSearchField);
                        $gridSearchField=str_replace("_","\_",$gridSearchField);

                        if($gridSearchFields[$i]!="" && !strpos("*".$asFields[$i+1],"GROUP_CONCAT") && !strpos("*".$asFields[$i+1],"DISTINCT") && !strpos("*".$asFields[$i+1],"SUM") && $asFields[$i+1]!=="dueDate")
                                $qstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
                }
                $qstr=substr($qstr,0,(strlen($qstr)-(strlen($gridSearchType)+1)));
                $qstr.=")";
        }

        for($i=0;$i<count($gridSearchFields);$i++)
        {
                if($gridSearchFields[$i]!="" && (strpos("*".$asFields[$i+1],"GROUP_CONCAT") || strpos("*".$asFields[$i+1],"DISTINCT") || strpos("*".$asFields[$i+1],"SUM") || $asFields[$i+1]=="dueDate"))
                {
                        $statusGroup=true;
                        break;
                }
        }
        if($statusGroup)
        {
                $hstr=" HAVING (";

                for($i=0;$i<count($gridSearchFields);$i++)
                {
                        $gridSearchField=mysql_real_escape_string($gridSearchFields[$i]);
                        $gridSearchField=str_replace("%","\%",$gridSearchField);
                        $gridSearchField=str_replace("_","\_",$gridSearchField);

                        if($gridSearchFields[$i]!="" && (strpos("*".$asFields[$i+1],"GROUP_CONCAT") || strpos("*".$asFields[$i+1],"DISTINCT") || strpos("*".$asFields[$i+1],"SUM") || $asFields[$i+1]=="dueDate"))
                                $hstr.=$asFields[$i+1]." LIKE '%".$gridSearchField."%' $gridSearchType ";
                }

                $hstr=substr($hstr,0,(strlen($hstr)-(strlen($gridSearchType)+1)));
                $hstr.=")";
        }

        $gqstr[0]=$qstr;
        $gqstr[1]=$hstr;

        return $gqstr;
    }
        //added by prasad to Accounting--Expenses grid optimization...
    function getPayBillsGrid($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $maildb,$db,$username,$user_timezone;
        $gstr = "";
        $gd = new gridData();
        $decimalPref=getDecimalPreference();
        include("vendorbills_management/payBillsGrid.php");
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $gqstr=$gd->buildQSTRGroupForVendorsPayBills($gridSearchType,$gridSearchFields,$asFields);
        $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
        $qstr = $gqstr[0];
        $hstr = $gqstr[1];
        $gstr.=$hstr;
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
        $total=$gd->getTotalCount($tque);
        $gridData=$gd->buildPayBills($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
        return $objResponse;
    }
	//this  fun for assigning fetched data to grid...
    function buildPayBills($oque)
    {
        global $db;
        $decimalPref=getDecimalPreference();
        $j=0;
		$grid=array();
        $res=mysql_query($oque,$db);
        while($row=mysql_fetch_row($res))
        {   
            $grid[$j][0]= "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chkMainChkbox() value='".$row[1].'|'.$row[2].'|'.$row[3].'|'.$row[6]."'><span class='checkmark'></span></label>";
            $grid[$j][1]= html_tls_specialchars(stripslashes($row[0]),ENT_QUOTES);
            $grid[$j][2]= $row[1];
            $grid[$j][3]= $row[2];
            $grid[$j][4]= $row[3];
            $grid[$j][5]= $row[4];
            $grid[$j][6]= $row[5];
            $grid[$j][7]= number_format($row[6],2,'.','');
            $grid[$j][8]= number_format($row[7],2,'.','');
            $grid[$j][9]=  $row[1].'|'.$row[2].'|'.$row[3].'|'.$row[6];

            $j++;
        }
	return $grid;
    }
    
    function getEmployeePerdiemShiftAvailability($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {	
		
		global $db,$username;

		if($gridSortCol=="")
			$gridSortCol=0;

		$gd=new gridData();

		$asFields=array("","empl.name");
		$ssFields=array("","TRIM(empl.name)");
		
		$sel_assign_dates_array = $gridExtraFields['sel_assign_dates_array'];						
		$pid = $gridExtraFields['pid'];
		$tab = $gridExtraFields['tab'];
		$assignment_emp_username = $gridExtraFields['assignment_emp_username'];
		
		$emplist_for_sel_dates_qry ="select empl.username,empl.name,empl.sno,substring(cand.username,5) as cand_id from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE')";
		
		$res=mysql_query($emplist_for_sel_dates_qry,$db);
		$empid_array = array();
		$all_empid_array = array();
		while ($row=mysql_fetch_array($res))
		{
			if($assignment_emp_username!=$row[0])
			{
				$all_empid_array[]	= "'".$row[0]."'";
			}
			$employee_shift_avail = $gd->getEmployeeMatchingReassignDatesCount($pid,$row[0],$sel_assign_dates_array);
			
			if($employee_shift_avail == 1){
				$empid_array[] = "'".$row[0]."'";				
			}
		}
		
		$emp_ids = implode(",",$empid_array);
		if($tab == "all")
		{
			$emp_ids = implode(",",$all_empid_array);
		}
		
		$oque="select empl.username,empl.name,empl.sno,substring(cand.username,5) as cand_id from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE') AND empl.username IN(".$emp_ids.")";

		$tque="SELECT count(1) CNT from emp_list as empl 
		INNER JOIN candidate_list as cand  ON (concat('emp',empl.sno) = cand.candid)
		LEFT JOIN hrcon_general ON empl.username = hrcon_general.username
		LEFT JOIN hrcon_w4 ON (empl.username=hrcon_w4.username) 
		LEFT JOIN hrcon_compen ON hrcon_compen.username=empl.username 
		LEFT JOIN hrcon_personal ON hrcon_personal.username=empl.username 
		LEFT JOIN department ON hrcon_compen.dept=department.sno 
		where empl.restatus = 'ACTIVE' and empl.empterminated='N' and  hrcon_compen.ustatus='active' and hrcon_w4.ustatus='active' and hrcon_general.ustatus='active' and hrcon_personal.ustatus='active' and empl.lstatus not in ('DA','INACTIVE') AND empl.username IN(".$emp_ids.")"; 
	
		$lstr=$gd->buildLimt($gridPage,$gridRecords);

		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		
		
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
		$tque=$gd->buildTQuery($tque,$qstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
	
		$tres = mysql_query($tque,$db);
		$total = mysql_num_rows($tres);
		if($total == 1)
		{
			$trow = mysql_fetch_row($tres);
			$total = $trow[0];
		}
		$gridData=$gd->buildEmployeePerdiemShiftAvailability($oque,$gridExtraFields);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

        return $objResponse;
	}	
	function buildEmployeePerdiemShiftAvailability($que,$gridExtraFields)
	{ 
		global $db;

		$j=0;
		$grid=array();
		$gd=new gridData();
		$res=mysql_query($que,$db);
		$k =1;   
		$sel_assign_dates_arr = explode(',',$gridExtraFields['sel_assign_dates']);
		$sel_assign_dates = implode("','",$sel_assign_dates_arr);						
		$pid = $gridExtraFields['pid'];
		$tab = $gridExtraFields['tab'];
		 
		$shiftid_qry = "SELECT shiftColor FROM shift_setup WHERE sno = '".$gridExtraFields['shift_id']."'  "; 
		$shiftid_qry_res =  mysql_query($shiftid_qry,$db);
		$shift_array = 	mysql_fetch_row($shiftid_qry_res);
		$temp_color = $shift_color = $shift_array[0];
		
		while ($row=mysql_fetch_array($res))
		{ 	
			$employee_shift_avail =array();		
			$employee_shift_avail =array();
			$grid[$j][0] ="<input type=hidden id=empsno_".$row[0]." name=empsno[] value='".$row[2]."'><label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='' value='".$row[0]."'><span class='checkmark'></span></label><input type=hidden id=empids_".$row[0]." name=empids[][] value='".$this->convertSpecChars($row[1])."'><input type=hidden id=candids_".$row[0]." name=candids[] value='".$row[3]."'><input type=hidden id=avail_stat_".$row[0]." name=avail_stat[] value=''>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);

			$k =2;
			
			//$assignment_info_qry = "SELECT DATE_FORMAT(shift_date,'%m/%d/%Y') as shift_date ,shift_starttime,shift_endtime FROM hrconjob_sm_timeslots WHERE DATE_FORMAT(shift_date,'%m/%d/%Y') IN ('".$sel_assign_dates."') AND pid ='".$pid."' order by shift_date ASC ";

			$assignment_info_qry = "SELECT DATE_FORMAT(shift_startdate,'%m/%d/%Y') as shift_date ,cast(concat(shift_startdate, ' ', shift_starttime) as DATETIME),cast(concat(shift_enddate, ' ', shift_endtime) as DATETIME) FROM hrconjob_perdiem_shift_sch WHERE (DATE_FORMAT(shift_startdate,'%m/%d/%Y') IN ('".$sel_assign_dates."') OR DATE_FORMAT(shift_enddate,'%m/%d/%Y') IN ('".$sel_assign_dates."')) AND hrconjob_sno ='".$pid."' GROUP BY shift_startdate,shift_enddate ORDER BY shift_date ASC "; 

			$assignment_info_res =  mysql_query($assignment_info_qry,$db);
			
			while($emp_row = mysql_fetch_array($assignment_info_res)){

				$grid[$j][$k] = "";
				$empuser = $row[0];

				if($empuser != ""){
					
					if($tab == "all")
					{						
						$whereCond_match_shift = " AND (
						(
							(UNIX_TIMESTAMP('".$emp_row[1]."') > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_endtime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP('".$emp_row[2]."') < UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_starttime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') > UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') <= UNIX_TIMESTAMP(cst.shift_starttime))
							OR
							(UNIX_TIMESTAMP('".$emp_row[2]."') >= UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[1]."') < UNIX_TIMESTAMP(cst.shift_starttime))
						)
						OR
						(UNIX_TIMESTAMP('".$emp_row[1]."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$emp_row[2]."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime))
						) ";
						
						$check_emp_availability = "SELECT cst.shift_status FROM hrcon_sm_timeslots AS cst WHERE cst.username ='".$empuser."' AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$emp_row[0]."')".$whereCond_match_shift;
						
						$check_emp_availability_res 	= mysql_query($check_emp_availability,$db);
						$no_of_rows			= mysql_num_rows($check_emp_availability_res);
						
						if($no_of_rows>0)
						{
							$avalability_exists = false;
							$shift_color		= $temp_color;		
							while($check_emp_availability_row = mysql_fetch_row($check_emp_availability_res))
							{

								if($check_emp_availability_row[0]=="available")
								{
									$avalability_exists = true;
									
								}

							}
							if($avalability_exists==false)
							{
								//applyiing shift color as white if employee schedule is not available
								$shift_color = "#FFFFFF";
							}
							
						}
						else
						{
							//applyiing shift color as white if employee schedule is not available
							$shift_color = "#FFFFFF";
						}
						
					}

					$grid[$j][$k] = "<div id='avail_status' style='background-color:{$shift_color};display: inline-block;width: 100px;height: 100%'></div>";
					
				}else{					
					$grid[$j][$k] = "";
				}
				$k++;
			}		
    		
			$j++;
		
		}
		return $grid;
	}
	function getCandAvailForPartialPlacement($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{	
		
		global $db,$username;

		if($gridSortCol=="")
			$gridSortCol=0;

		$gd=new gridData();

		$asFields=array("","candidate_list.fname","candidate_list.lname");
		$ssFields=array("","trim(candidate_list.fname)","trim(candidate_list.lname)");
		
		$sel_assign_dates_array = $gridExtraFields['sel_assign_dates_array'];						
		$posno 					= $gridExtraFields['pid'];
		$tab 					= $gridExtraFields['tab'];
		
		$rlque="SELECT candids FROM remove_lists WHERE username='$username' AND reqid='$posno'";
			$rlres=mysql_query($rlque,$db);
			$rlrow=mysql_fetch_row($rlres);

			if($rlrow[0]!="")
				$removed_candids_clause = " AND candidate_list.sno NOT IN (".$rlrow[0].") ";
			else
				$removed_candids_clause = "";

			$selPerdiemShiftCond = " AND shift_id IN (".$gridExtraFields['shift_id'].") ";		

			$selDatesStr = $gridExtraFields['sel_shift_dates'];
			$jo_shifts_arr = explode(",", $selDatesStr);


			usort($jo_shifts_arr, array($this, "sort_shift_dates"));
			$jo_shifts_arr_len = count($jo_shifts_arr);		
			
			if($jo_shifts_arr_len > 0){
								
				$candidates_details = $gd->getCandMatchingForPartialPlacement($posno, $jo_shifts_arr, $gridExtraFields);	
								
				$candidates_usernames = array_keys($candidates_details);
				$append_fname_query = "";
				if(empty($candidates_usernames)){
					$append_fname_query = " AND candidate_list.fname!='' ";
				}
			}
			$ss_cand_sub_query=" AND candidate_list.username IN ('".implode("','",$candidates_usernames)."') ".$append_fname_query;	

			$tque="SELECT count(DISTINCT(candidate_list.sno)) ";

			$oque="SELECT
			candidate_list.sno as sno,
			candidate_list.username as username,
			candidate_list.profiletitle as profiletitle,
			candidate_list.fname as fname,
			candidate_list.lname as lname";

			$tque.=" FROM users, candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id "; 
			$tque.=" WHERE candidate_list.status='ACTIVE' $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username ";

			$oque.=" FROM users, candidate_list LEFT JOIN manage ON candidate_list.cl_status=manage.sno LEFT JOIN candidate_credentials cc ON cc.cand_sno = candidate_list.sno LEFT JOIN manage_credentials_type mct ON mct.id = cc.cre_type_id LEFT JOIN manage_credentials_name mcn ON mcn.id = cc.cre_name_id "; 
			$oque.=" WHERE candidate_list.status='ACTIVE' $cand_sub_query $ss_cand_sub_query AND candidate_list.owner=users.username ";

			$lstr=$gd->buildLimt($gridPage,$gridRecords);

			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			
			
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
			$tque=$gd->buildTQuery($tque,$qstr);
			$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
		
			$tres = mysql_query($tque,$db);
			$total = mysql_num_rows($tres);
			if($total == 1)
			{
				$trow = mysql_fetch_row($tres);
				$total = $trow[0];
			}			

			$gridData 	= $gd->buildPartialCandScheduleSearch($oque,$posno,$gridSortCol,$gridSort,$gridExtraFields,$jo_shifts_arr,$candidates_details);
			$objResponse = new xajaxResponse();
			$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
			//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

			return $objResponse;

	}
	
	// Submission Candidates Grid Data - Schedule Search
	function buildPartialCandScheduleSearch($que,$posid,$gridSortCol,$gridSort,$gridExtraFields,$jo_shifts_arr,$candidates_details)
	{
		global $maildb,$db,$CandSubMode;

		$j=0;
		$grid=array();	
			
		$jo_shifts_arr_uniq = array_values(array_unique($jo_shifts_arr)) ;
		$jo_shifts_arr_len 	= count($jo_shifts_arr_uniq);
		$shift_id 			= $gridExtraFields['shift_id'];
		$pos_id 			= $gridExtraFields['pid'];
		
		$res=mysql_query($que,$db);
		$cand_avail_dates = array();
		while ($row=mysql_fetch_array($res))
		{		
			$cand_avail_dates = array();
			$avail_dates = array();
		
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] id='auids[]' OnClick='' value='".$row['sno']."'><span class='checkmark'></span></label>";			
			
			$grid[$j][1]=$this->convertSpecChars($row['fname']);
			$grid[$j][2]=$this->convertSpecChars($row['lname']);
			/*$candname = $row['fname']."_".$row['lname'];
			$grid[$j][3]="<a style='padding: 1px 0px 0px 30px;' href=javascript:displayTimeFrameWindow('/include/shift_schedule/viewalltimeframes.php?refid=".$row['username']."&posid=$posid&module=Req_Mngmt&smsno=$sm_sno&schtype=$sch_search_type&candname=$candname&append_hours=$append_hours')><font class=linkrow><i class='fa fa-info-circle'></i></font></a>";*/
			
			// Finds this current candidate's availability details.
			$candidate_username = $row['username'];
			$avail_dates = $candidates_details[$candidate_username];
			
			foreach ($avail_dates as $key => $value){
				
				$avail_shift_date = explode('|',$value,2);
				$cand_avail_dates[] = $avail_shift_date[0];
			}
			
			// Displays Full Schedule View - for 90 Days starting from yesterday's date 
			for($k = 0; $k<$jo_shifts_arr_len; $k++){
				$cand_avail_keys = array();
				$cand_avail_keys_count = "";
				$width_each_shift ="";
				$shift_div_content = "";
				if(in_array($jo_shifts_arr_uniq[$k],$cand_avail_dates)){
					$cand_avail_keys = array();
					$shift_div_content = "";
					$cand_avail_keys = array_keys($cand_avail_dates,$jo_shifts_arr_uniq[$k]);
					$cand_avail_keys_count = count($cand_avail_keys);
					$tot_shift_width = 100;
					$width_each_shift = 100/$cand_avail_keys_count;
					
					foreach($cand_avail_keys as $ky=>$val){
						$shif_data = "";
						$avail_shift_data=array();$shift_color ="";
						$shif_data = $avail_dates[$val];
						$avail_shift_data = explode('|',$shif_data);
						$shift_color =  $avail_shift_data[2];
						$shift_div_content .= "<div class= 'availstaus' style='background:{$shift_color};display: inline-block;width: {$width_each_shift}px;height:100%'>&nbsp;</div>";
					}
					
						
				}
				
				if(!empty($shift_div_content)){
					$grid[$j][$k+3] = $shift_div_content;
				}else{
					$grid[$j][$k+3] = ""; 
				}
			}				
			if($jo_shifts_arr_len > 0){
				$updated_index = $jo_shifts_arr_len+3;
			}else{
				$updated_index = 3;
			}
			// $grid[$j][$updated_index] = "";
			// $grid[$j][$updated_index+1] = "review.php?cno=".$row['sno']."&posid=$posid&dest=0";	 		
						
			$j++;
		}		
		return $grid;		
	}				

	function getCandMatchingForPartialPlacement($joborder_id, $jo_shifts_arr, $gridExtraFields){
	        global $db;
		
		// Matched Candidates
		$matched_cands = array();

		
		$jo_shifts_arr_len = count($jo_shifts_arr);
			
		//Match only those shift snos which are selected by user
		if(!empty($gridExtraFields['shift_id'])){
			$whereCond_match_shift .= " AND pst.shift_id IN (".$gridExtraFields['shift_id'].") ";
		}

		//2019-04-02 16:45:00,2019-04-02 19:30:00^^2019-04-02 16:45:00,2019-04-02 19:30:00
		if(isset($gridExtraFields['sel_assign_dates_array']))
		{

			$selectedDateWithStartEndTimes = $gridExtraFields['sel_assign_dates_array'];
			$selectedDateWithStartEndTimesArr = explode(",", $selectedDateWithStartEndTimes);
			$selectedStartDateTime 	= $selectedDateWithStartEndTimesArr[0];
			$selectedEndDateTime 	= $selectedDateWithStartEndTimesArr[1];

			//$whereCond_match_shift .= " AND (UNIX_TIMESTAMP(".$selectedStartDateTime.") BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP(".$selectedEndDateTime.") BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";

			$whereCond_match_shift .= " AND (UNIX_TIMESTAMP('".$selectedStartDateTime."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND  UNIX_TIMESTAMP(cst.shift_endtime) AND UNIX_TIMESTAMP('".$selectedEndDateTime."') BETWEEN UNIX_TIMESTAMP(cst.shift_starttime) AND UNIX_TIMESTAMP(cst.shift_endtime)) ";
			/*
			foreach($selectedDateWithStartEndTimesArr AS $key=>$val)
			{
				$selectedDateWithStartEndTimesArr = explode(",", $val);
				$selectedStartDateTime 	= $selectedDateWithStartEndTimesArr[0];
				$selectedEndDateTime 	= $selectedDateWithStartEndTimesArr[1];
			}*/
			
		}

		//getting the submitted shifts count of job order to avoid the candidate if he submitted for all shifts
		$rsusername = array();
		$rsque = "SELECT cl.username FROM resume_status
INNER JOIN manage ON (manage.sno = resume_status.status)
LEFT JOIN candidate_list cl ON (cl.sno = resume_status.res_id) WHERE 
 req_id='".$joborder_id."' AND manage.name NOT IN ('Closed','Cancelled') AND resume_status.pstatus!='A' AND resume_status
.shift_id IN (".$gridExtraFields['shift_id'].") GROUP BY resume_status.res_id";
							
		$rsres=mysql_query($rsque,$db);
		while($rsrow=mysql_fetch_row($rsres))
		{			
			$rsusername[] = $rsrow[0];
		}

		if(count($rsusername)>0){
			$whereCond_match_shift .= " AND cst.username NOT IN ('".implode("','",$rsusername)."') "; 
		}
		
		
			

		$avail_dates = $jo_shifts_arr;
		$all_avail_dates =  implode("','",$avail_dates);	
		
		$cand_sql_query = "SELECT
					cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y') AS avail_date,pst.shift_id,stp.shiftcolor
					FROM candidate_sm_timeslots cst
					INNER JOIN jo_perdiem_shift_sch pst
					  ON cst.shift_date = pst.shift_startdate
					INNER JOIN shift_setup stp
					  ON stp.sno = pst.shift_id
					WHERE cst.shift_status = 'available' AND
					concat(cst.username,'-',IF(stp.sno IS NULL,0,stp.sno)) NOT IN (
                        SELECT concat(concat('cand',res_id),'-',shift_id) FROM resume_status, manage 
                        WHERE  
                        manage.sno = resume_status.status AND 
                        req_id = '".$joborder_id."' AND 
                        manage.name NOT IN ('Closed','Cancelled') AND 
                        resume_status.pstatus != 'A' 
					)
					  AND pst.posid = '".$joborder_id."'
					  AND DATE_FORMAT(cst.shift_date,'%m/%d/%Y') IN ('".$all_avail_dates."') ".$whereCond_match_shift." GROUP BY cst.username, DATE_FORMAT(cst.shift_date,'%m/%d/%Y'),pst.shift_id ";
		
		$cand_res = mysql_query($cand_sql_query,$db);
		
		while($cand_row = mysql_fetch_array($cand_res)){
			$matched_candidate = $cand_row['username'];
			
			$matched_cands[$matched_candidate][] = $cand_row['avail_date'].'|'.$cand_row['shift_id'].'|'.$cand_row['shiftcolor'];
		}
		

		$sm_shifts_snos_count = 0;
		if(!empty($gridExtraFields['shift_id'])){
			$sm_shifts_snos_arr = explode(",",$gridExtraFields['shift_id']);
			$sm_shifts_snos_count = count($sm_shifts_snos_arr);
		}			
		// Removes a candidate record whose availability dates are not matching all shift dates within a shift selected. This is applicable only in case of EXACT SHIFT MATCHING and EXTENDED MATCH + HOURS
		if($sm_shifts_snos_count == 1)
		{
			foreach($matched_cands as $matched_cand_key=>$matched_cand_val)
			{
				$matched_cand_avail_dates_count = count($matched_cand_val);
				if($matched_cand_avail_dates_count != $jo_shifts_arr_len)
				{
					//unset($matched_cands[$matched_cand_key]);
				}
			}
		}
		
		return $matched_cands;		
	}
	
	function getOpportunities($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $maildb,$db,$username,$user_timezone,$sysdb,$maindb,$companyuser,$cvsid;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

		if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
		{
			//require("searchdatabase.inc");
			$setQry = "SET SESSION group_concat_max_len=1073740800";
			mysql_query($setQry,$db);

			require("quickSubCandidates.inc");	
			$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
			
			require("visualsearch_opportunities.php");
			require("database.inc");
		}
		else
		{
			$aqstr=" 1=1 ";
		}
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("Opportunities",$username,$cvsid);
		//print_r($grdi_details);
		
		if(!empty($grdi_details))
		{			
			$asFields = $custom_grid_function_obj->asFields("Opportunities", $username,$cvsid);
			$ssFields=$custom_grid_function_obj->ssFields("Opportunities", $username,$cvsid);	
			$oque = $custom_grid_function_obj->queryBuilder("Opportunities", $username,$cvsid);
			$tque = $custom_grid_function_obj->countQueryBuilder("Opportunities", $username,$cvsid);
			
						
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'Opportunities');
			
			//Sunil	 Added this code to check the gridLoading First time or not	
			if($gridSortCol == 100){
				$ostr = " ORDER BY staffoppr_oppr.mdate DESC ";				
			}else{
				if($asFields[$gridSortCol] == "staffoppr_oppr.ammount")
				{
					$ostr = "ORDER BY CAST(REPLACE($asFields[$gridSortCol],',','') AS UNSIGNED) $gridSort";
				}else{
				
					$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
				}
			}
			if(empty($aqstr))
				$aqstr = '';
			else
				$aqstr = " AND ".$aqstr;
			
			// This query will give us the total number of records, for that we will remove the limit string.
			$tque .= " $qstr $CompanyCond $grpque $aqstr"; 
			
			$oque="$oque $qstr $CompanyCond $grpque $aqstr $ostr $lstr";
			
			// This function will give us the total number of records.			
			//$total=$gd->getDevTotalRows($tque);
			
			$total=$gd->getTotalRows($tque);
				
			
		}
		else
		{
			$asFields=array("","sc.cname","staffoppr_oppr.name","m.name","m1.name","staffoppr_oppr.probability","staffoppr_oppr.ammount",tzRetQueryStringDate('staffoppr_oppr.cdate','Date','/'),tzRetQueryStringDate('staffoppr_oppr.stime','Date','/'),tzRetQueryStringDate('staffoppr_oppr.mdate','Date','/'),"users.name","staffoppr_oppr.sno",);
			$ssFields=array("","sc.cname","staffoppr_oppr.name","m.name","m1.name","staffoppr_oppr.probability","staffoppr_oppr.ammount","staffoppr_oppr.cdate",'staffoppr_oppr.stime','staffoppr_oppr.mdate',"users.name","staffoppr_oppr.sno");
	
			$tque="SELECT
				count(distinct(staffoppr_oppr.sno))
				FROM staffoppr_oppr  
				LEFT JOIN staffoppr_cinfo sc ON sc.sno = staffoppr_oppr.csno AND (FIND_IN_SET('".$username."', sc.accessto) > 0 OR sc.approveuser='".$username."' OR sc.accessto='ALL')
				LEFT JOIN manage m ON staffoppr_oppr.otype=m.sno
				LEFT JOIN manage m1 ON staffoppr_oppr.stage=m1.sno
				LEFT JOIN users ON staffoppr_oppr.owner = users.username
				WHERE $aqstr
				AND sc.status = 'ER'
				AND staffoppr_oppr.oppr_status = 'ACTIVE'";
	
				$oque="SELECT
				staffoppr_oppr.sno AS oppr_sno,
				sc.cname,
				staffoppr_oppr.name as opprname,
				m.name,
				m1.name,
				staffoppr_oppr.probability,
				staffoppr_oppr.ammount,
				IF(DATE_FORMAT(staffoppr_oppr.cdate,'%m/%d/%Y')='00/00/0000','',DATE_FORMAT(staffoppr_oppr.cdate,'%m/%d/%Y')),
				IF(DATE_FORMAT(staffoppr_oppr.stime,'%m/%d/%Y')='00/00/0000','',DATE_FORMAT(staffoppr_oppr.stime,'%m/%d/%Y')),
				IF(DATE_FORMAT(staffoppr_oppr.mdate,'%m/%d/%Y')='00/00/0000','',DATE_FORMAT(staffoppr_oppr.mdate,'%m/%d/%Y')),
				users.name,
				staffoppr_oppr.owner,
				sc.sno AS comp_sno
				FROM staffoppr_oppr  
				LEFT JOIN staffoppr_cinfo sc ON sc.sno = staffoppr_oppr.csno AND (FIND_IN_SET('".$username."', sc.accessto) > 0 OR sc.approveuser='".$username."' OR sc.accessto='ALL')
				LEFT JOIN manage m ON staffoppr_oppr.otype=m.sno
				LEFT JOIN manage m1 ON staffoppr_oppr.stage=m1.sno
				LEFT JOIN users ON staffoppr_oppr.owner = users.username
				WHERE $aqstr
				AND sc.status = 'ER'
				AND staffoppr_oppr.oppr_status = 'ACTIVE'";
			
			//$grpque=" group by sc.sno";
			
			
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			

			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			//Sunil	 Added this code to check the gridLoading First time or not				
			if($gridSortCol == 100){
				$ostr = "ORDER BY staffoppr_oppr.mdate DESC ";				
			}else{
				if($asFields[$gridSortCol] == "staffoppr_oppr.ammount")
				{
					$ostr = "ORDER BY CAST(REPLACE($asFields[$gridSortCol],',','') AS UNSIGNED) $gridSort";
				}else{
				
					$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields); // Order by fields, append the where clause accordingly
				}
			}		
			$tque=$gd->buildTQuery($tque,$qstr.$CompanyCond,'');
			$oque="$oque $qstr $CompanyCond $grpque $ostr $lstr";
	
			$total=$gd->getTotalRows($tque);
		
		}
		
		$gridData=$gd->buildOpportunities($oque,$cvsid);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
		
		return $objResponse;
	}

	function getOpportunitiesCheckBoxValue($sno)
	{
		global $username;
	
		$sel_OpportunitiesCheckBoxValue = "SELECT
				staffoppr_oppr.sno AS oppr_sno,
				sc.cname AS cname,
				staffoppr_oppr.name AS opprname,
				m.name,
				m1.name,
				staffoppr_oppr.probability,
				staffoppr_oppr.ammount,
				".tzRetQueryStringDate('staffoppr_oppr.cdate','Date','/').",
				".tzRetQueryStringDate('staffoppr_oppr.stime','Date','/').",
				".tzRetQueryStringDate('staffoppr_oppr.mdate','Date','/').",
				IF (sc.accessto = 'ALL', 'Public',IF (sc.accessto = '".$username."', 'Private', 'Share')) as share_type,
				'',
				staffoppr_oppr.owner,
				sc.cdate,
				sc.acc_comp AS acc_comp,
				sc.mdate,
				users.name as ownername,
				users1.name AS oppr_owner,
				sc.sno AS comp_sno
				FROM staffoppr_oppr
				LEFT JOIN staffoppr_cinfo sc ON sc.sno = staffoppr_oppr.csno
				LEFT JOIN users  ON staffoppr_oppr.cuser = users.username
				LEFT JOIN users users1 ON staffoppr_oppr.owner = users.username
				LEFT JOIN manage m ON staffoppr_oppr.otype = m.sno
				LEFT JOIN manage m1 ON staffoppr_oppr.stage = m1.sno
				WHERE staffoppr_oppr.sno = ".$sno."
				AND sc.status = 'ER'
				AND staffoppr_oppr.oppr_status = 'ACTIVE'";
		$res_OpportunitiesCheckBoxValue = mysql_query($sel_OpportunitiesCheckBoxValue);
		$rec_OpportunitiesCheckBoxValue = mysql_fetch_assoc($res_OpportunitiesCheckBoxValue);
		return($rec_OpportunitiesCheckBoxValue);	
	}

	function buildOpportunities($que,$cvsid=0)
	{
		global $maildb,$db, $username;
		
		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("Opportunities",$username,$cvsid);

		$returnVal = '';
	    $customSortOrderVal = $this->fetchCustomSortOrder(6,$cvsid);
	    
		if($customSortOrderVal != '')		
			$returnVal = 1+$customSortOrderVal;

		
		if(!empty($grdi_details))
		{
			while ($row=mysql_fetch_row($res))
			{
				$fetchCmpyCsno = $this->fetchOpprCSno($row[0]);

				for($i=0;$i<count($row);$i++)
				{
					if($i == 0)
					{

						$opportunitiesCheckboxVal = $this->getOpportunitiesCheckBoxValue($row[$i]);
						$grid[$j][0]=" <label class='container-chk'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value=
								'".$opportunitiesCheckboxVal["oppr_sno"]
								."|".$opportunitiesCheckboxVal["owner"]
								."|".html_tls_specialchars($opportunitiesCheckboxVal["ownername"],ENT_QUOTES)
								."|".$j
								."|".html_tls_specialchars(stripslashes($opportunitiesCheckboxVal["opprname"]),ENT_QUOTES)
								."|".$opportunitiesCheckboxVal["acc_comp"]
								."'><span class='checkmark'></span></label>";
					}
					else if($returnVal == $i && $customSortOrderVal !='')
					{
					    $hyperLink = "<a href=javascript:showComp('".$fetchCmpyCsno."')>".$this->convertSpecChars(stripslashes($row[$i]))."</a>";
						$grid[$j][$i]= $hyperLink;
					}
					else
					{
						$grid[$j][$i]= $this->convertSpecChars(stripslashes($row[$i]));
					}
				}	
				
				$grid[$j][count($row)]= '';				
				$grid[$j][(count($row)+1)]= "viewopportunitySummary.php?opprsno=".$row['0']."&addr=".$row[count($row)-1];
				$j++;
			}
		}
		else
		{
			while ($row=mysql_fetch_array($res))
			{

				$fetchCmpyCsno = $this->fetchOpprCSno($row[0]);
				$hyperLink = "<a href=javascript:showComp('".$fetchCmpyCsno."')>".$this->convertSpecChars(stripslashes($row[1]))."</a>";

				$grid[$j][0]=" <label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row[0]."|".$row[11]."|".html_tls_specialchars($row[5],ENT_QUOTES)."|".$j."|".html_tls_specialchars(stripslashes($row[2]),ENT_QUOTES)."|".$row[9]."'><span class='checkmark'></span></label>";
				$grid[$j][1]=$hyperLink;
				$grid[$j][2]=$this->convertSpecChars(stripslashes($row[2]));
				$grid[$j][3]=$this->convertSpecChars(stripslashes($row[3]));			
				$grid[$j][4]=$this->convertSpecChars(stripslashes($row[4]));
				$grid[$j][5]=$this->convertSpecChars(stripslashes($row[5]));
				$grid[$j][6]=$this->convertSpecChars(stripslashes($row[6]));
				$grid[$j][7]=$this->convertSpecChars(stripslashes($row[7]));
				$grid[$j][8]=$this->convertSpecChars(stripslashes($row[8]));
				$grid[$j][9]=$this->convertSpecChars(stripslashes($row[9]));
				$grid[$j][10]=$this->convertSpecChars(stripslashes($row[10]));
				$grid[$j][11]="";
				$grid[$j][12]="viewopportunitySummary.php?opprsno=".$row['oppr_sno']."&addr=".$row['comp_sno'];  
				$j++;
			}
		}
		return $grid;
	}
	
	// RSM Integration
	function getRSM_rules($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
            global $db,$username;
            $gd = new gridData();

             //search fields
            $asFields = array("","type.rule_type_name","CONCAT_WS(' - ',sc.sno,sc.cname)","uc.name",tzRetQueryStringDate('rsm.cdate','Date','/'));

            //sort fields
            $ssFields = array("","type.rule_type_name","sc.cname","uc.name",tzRetQueryStringDate('rsm.cdate','Date','/'));

            $tque="SELECT COUNT(*) FROM rsm_rules rsm 
				LEFT JOIN rsm_rule_type type ON rsm.type_id = type.id
				LEFT JOIN staffacc_cinfo sc ON rsm.rule_value = sc.sno 
				LEFT JOIN users um ON um.username = rsm.muser
				LEFT JOIN users uc ON uc.username = rsm.cuser WHERE rsm.status='ACTIVE' AND sc.type = 'CUST'";

            $oque="SELECT type.rule_type_name AS rule_name, CONCAT_WS(' - ',sc.sno,sc.cname) ,uc.name AS created_by, ".tzRetQueryStringDate('rsm.cdate','Date','/').",rsm.sno
				FROM rsm_rules rsm 
				LEFT JOIN rsm_rule_type type ON rsm.type_id = type.id
				LEFT JOIN staffacc_cinfo sc ON rsm.rule_value = sc.sno 
				LEFT JOIN users um ON um.username = rsm.muser
				LEFT JOIN users uc ON uc.username = rsm.cuser WHERE rsm.status='ACTIVE' AND sc.type = 'CUST'";

            $gstr = "";
            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildRSM_rules($oque);

            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

            return $objResponse;
    }
	
	function buildRSM_rules($que)
    {
            global $db;
            $j=0;
            $grid=array();
            $res=mysql_query($que,$db);	
            while($row=mysql_fetch_array($res))
            {
	            $grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[4]."'><span class='checkmark'></span></label>";
	            $grid[$j][1] = $this->convertSpecChars($row[0]);
	            $grid[$j][2] = $this->convertSpecChars($row[1]); 
	            $grid[$j][3] = $this->convertSpecChars($row[2]);
	            $grid[$j][4] = $this->convertSpecChars($row[3]);
	            $j++;
            }
            return $grid;
    }
	
	function getCandlistForSelectedRate($RateType=NULL,$posid=NULL,$Rateval=NULL)
	{
		global $db;
							
		$rate_str = "";
		if($RateType != "" && $Rateval !=""){
			$rate_str = " AND mjo.ratemasterid = '".$RateType."' AND mjo.rate = '".number_format($Rateval,2,".","")."' ";
		}else if($RateType != "")
		{
			$rate_str = " AND mjo.ratemasterid = '".$RateType."'";
		}
		else if($Rateval != "" )
		{
			$rate_str = " AND mjo.rate = '".number_format($Rateval,2,".","")."'";
		}
							
		 $candidate_query = "SELECT GROUP_CONCAT(rs.sno) FROM resume_status as rs
							INNER JOIN candidate_list  as cl ON (cl.sno = rs.res_id)
							INNER JOIN posdesc as jo ON(jo.posid = rs.req_id) 
							INNER JOIN multiplerates_joborder as mjo ON(mjo.joborderid = rs.sno)
							WHERE jo.posid = '".$posid."' AND mjo.jo_mode = 'submission' AND ratetype = 'payrate'
							$rate_str";
							
							
		$candidate_res = mysql_query($candidate_query,$db);
		$candidate_list  =mysql_fetch_row($candidate_res);
		return $candidate_list[0];
	}
	
	// Manage Applied Candidates
	function getManageAppliedCandList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $sysdb,$maindb,$companyuser,$maildb,$db,$username,$user_timezone,$tempvalue,$pageFrom,$groupId,$cvsid;
		
		$searchCond="";
		$duplicateCheck = ""; // For candidates duplicate checking
		$crmGroupTable="";
		$crmGroupCondition = "";
		
		$posid = $gridExtraFields['posid'];
		$jo_shift_type = $gridExtraFields['jo_shift_type'];
		$module = $gridExtraFields['module'];

		$gd=new gridData();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("candidates",$username, $cvsid);
		
		
			if(SHIFT_SCHEDULING_ENABLED == 'N')
		 	{
		 		$shifts_on_job_qry 	= 	"select shiftid from posdesc where posid = '".$posid."'";
				$shifts_on_job_res 	=	mysql_query($shifts_on_job_qry,$db);
				$shifts_on_job_row 	=	mysql_fetch_row($shifts_on_job_res);
				$shifts_sno 		= 	$shifts_on_job_row[0];
				$shift_count 		=   count($shifts_on_job_row);
				
		 	}
		 	else
		 	{
		 		//when enabled the shift management
		 		if($jo_shift_type == "perdiem")
		 		{
					$shifts_on_job = "SELECT GROUP_CONCAT(DISTINCT(shift_id)) FROM jo_perdiem_shift_sch WHERE posid = '".$posid."'";
		 		}
		 		else
		 		{
		 			$shifts_on_job = "SELECT GROUP_CONCAT(DISTINCT(sm_sno)) FROM posdesc_sm_timeslots WHERE pid = '".$posid."'";					
		 		}
		 		
				$shifts_on_job_res =mysql_query($shifts_on_job,$db);
				$shifts_list = mysql_num_rows($shifts_on_job_res);
				
				$shifts_list_arr =mysql_fetch_row($shifts_on_job_res);

				if($shifts_list_arr[0] != "" ){
					$shifts_sno = implode(",",$shifts_list_arr);
				}else {
					$shifts_sno = 0;
				}

				$shift_count = explode(",",$shifts_sno);
		 	}
				
			
			//getting the submitted shifts count of job order to avoid the candidate if he submitted for all shifts
			$rsusername = array();
			$rsque="select resume_status.res_id,count(resume_status.shift_id) from resume_status, manage WHERE manage.sno = resume_status.status AND req_id='".$posid."' AND manage.name NOT IN ('Closed','Cancelled') AND resume_status.pstatus!='A' and resume_status.shift_id IN(".$shifts_sno.") group by resume_status.res_id";
								
			$rsres=mysql_query($rsque,$db);
			while($rsrow=mysql_fetch_row($rsres))
			{
				if($rsrow[1] == count($shift_count) ){
					$rsusername[] = $rsrow[0];
				}
				
			}
			$cand_sub_sphquery = '';
			if(count($rsusername)>0)
			if(($jo_shift_type != "perdiem") && ($selected_tab == 0 || $selected_tab == ""))
			{
				$cand_sub_query=" AND candidate_list.sno NOT IN (".implode(",",$rsusername).") "; 
				//$cand_sub_sphquery="!filter=snoid,".implode(",",$rsusername).";";
			}
			else
			{
				$cand_sub_query = ""; 
			}
		
		
		
		
		

		if(!empty($grdi_details))
		{
			
			$asFields = $custom_grid_function_obj->asFields("candidates", $username, $cvsid);
			

			///////////////////////////// SS FIELDS GENERATION //////////////////////////////
			
			$ssFields = $custom_grid_function_obj->ssFields("candidates", $username, $cvsid);
			$ss_string_org = implode(",",$ssFields);
			$ss_string = implode("^",$ssFields);

			$ss_zip_pos = strpos($ss_string, "zip");
			/*if($ss_zip_pos > 0)
			{
				$ss_zip_pos = (strpos($ss_string, "zip")+strlen("zip"))+1;
				
				if($ss_zip_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."^ZCR ".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_zip_pos)."ZCR^".substr($ss_string, $ss_zip_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}

			$ss_acr_pos = strpos($ss_string, "hphone");
			if($ss_acr_pos > 0)
			{
				$ss_acr_pos = (strpos($ss_string, "hphone")+strlen("hphone"))+1;
				
				if($ss_acr_pos == (strlen($ss_string)+1))
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."^ACR ".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				else
					$ss_string = substr($ss_string, 0, $ss_acr_pos)."ACR^".substr($ss_string, $ss_acr_pos, strlen($ss_string));
				$ssFields = explode("^",$ss_string);
			}*/

			$ssFieldsZcrAcr = $ssFields;

			for($wpindex = 0; $wpindex < count($ssFields); $wpindex++)
			{
				$wpflag = strpos($ssFields[$wpindex],"hphone");
				if($wpflag >0)
				{			
					$ssFields[$wpindex+1] = $ssFields[$wpindex];
					break;
				}
			}
			
			for($zipindex = 0; $zipindex < count($ssFields); $zipindex++)
			{
				$zipflag = strpos($ssFields[$zipindex],"zip");
				if($zipflag >0)
				{			
					$ssFields[$zipindex+1] = $ssFields[$zipindex];
					break;
				}
			}
			
			
			///////////////////////////// END SS FIELDS GENERATION //////////////////////////////
			
			$oque = $custom_grid_function_obj->queryBuilder("candidates", $username ,$cvsid);
			$tque = $custom_grid_function_obj->countQueryBuilder("candidates", $username ,$cvsid);
			
			$tquery = explode("from candidate_list",$tque);
			
			//$tquery[0] = str_replace("concat(fname, ' ', lname)", "concat(staffoppr_contact.fname, ' ', staffoppr_contact.lname)", $tquery[0]);
			$tquery[0] .= "from candidate_list INNER JOIN candidate_appliedjobs as ca ON (candidate_list.sno= ca.candidate_id) INNER JOIN posdesc as jo ON (jo.posid = ca.req_id AND jo.posid = '".$posid."')
							";
			$tque = "";
			$tque = $tquery[0]." ".$tquery[1]; 

			
			$oquery = explode("from candidate_list",$oque); 
			//$oquery[0] = str_replace("concat(fname, ' ', lname)", "concat(staffoppr_contact.fname, ' ', staffoppr_contact.lname)", $oquery[0]);
			$oquery[0] .= "from candidate_list INNER JOIN candidate_appliedjobs as ca ON (candidate_list.sno= ca.candidate_id) INNER JOIN posdesc as jo ON (jo.posid = ca.req_id AND jo.posid = '".$posid."')";
			$oque = "";
			$oque = $oquery[0]." ".$oquery[1];
					
			if(trim($gridExtraFields['resume'])=="" || ($gridExtraFields['SpeedSearchString']=='' && $gridExtraFields['SpeedSearchString']=='?'))
			{
				// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
				foreach($ssFields as $ssFields_key => $ssFields_value) {
					if (strpos($ssFields_value, 'desirejob') !== false) {
					   $asFieldsKey = $ssFields_key;
					   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
					}
				}
			
			}
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
			//$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
			if(in_array('candidate_list.hphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.hphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.wphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.wphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.mobile',$asFields)){
				$asFieldsKey = array_search("candidate_list.mobile", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
			}

			$qstr=$gd->buildGridQSTRCommon($gridSearchType,$gridSearchFields,$asFields,(count($asFields)+1), 'candidates');
			
			if($gridSortCol == 100){
				$ostr = " ORDER BY candidate_list.mtime DESC";				
			}else{  
                                $sortFlag = 0;				
                                if(is_array($ssFieldsZcrAcr))
                                {
                                    if(strpos($ssFieldsZcrAcr[$gridSortCol], 'availsdate') !== false){
                                        $tableAliasValue = explode('.availsdate',substr($ssFieldsZcrAcr[$gridSortCol],3,20)); 
                                        $ostr ="ORDER BY IF(".$tableAliasValue[0].".availsdate = 'inactive', 'Inactive', IF((".$tableAliasValue[0].".availsdate = '0-0-0' OR ".$tableAliasValue[0].".availsdate = '' OR ".$tableAliasValue[0].".availsdate IS NULL OR ".$tableAliasValue[0].".availsdate = 'immediate'),'Immediate', IF((datediff(".$tableAliasValue[0].".availsdate, now())) < 0,'Immediate', DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availsdate, '%Y-%m-%d'), '%Y-%m-%d')))) ".$gridSort ;
                                        $sortFlag = 1;	
                                    }
                                    if(strpos($ssFieldsZcrAcr[$gridSortCol], 'availedate') !== false){
                                        $tableAliasValue = explode('.availedate',substr($ssFieldsZcrAcr[$gridSortCol],4,20)); 
                                        $ostr ="ORDER BY IF((".$tableAliasValue[0].".availedate = '0-0-0' OR ".$tableAliasValue[0].".availedate = '' OR ".$tableAliasValue[0].".availedate IS NULL),'' ,DATE_FORMAT(STR_TO_DATE(".$tableAliasValue[0].".availedate, '%Y-%m-%d'), '%Y-%m-%d')) ".$gridSort;
                                        $sortFlag = 1;	
                                    }
                                }
                                
                                if($sortFlag==0){
                                   $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFieldsZcrAcr); // Order by fields, append the where clause accordingly 
                                }
				
			}	
			
			if(trim($gridExtraFields['resume'])!="" || ($gridExtraFields['SpeedSearchString']!='' && $gridExtraFields['SpeedSearchString']!='?'))
			{
				//require("searchdatabase.inc");

				$setQry = "SET SESSION group_concat_max_len=1073740800";
				mysql_query($setQry,$db);

				require("quickSubCandidates.inc");
				
				$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);	
				$customesearch = true;
				
				require("visualsearch_candidates.php");
				require("database.inc");
			}
			
			if(empty($aqstr))
				$aqstr = '';

			if($pageFrom == "crmGroups") {
				$crmGroupTable=" LEFT JOIN crmgroup_details ON crmgroup_details.refid = candidate_list.sno ";
				$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."'";
			}
			else
			{
				$crmGroupTable="";
				$crmGroupCondition = "";
			}
			
			if(($gridExtraFields['frm_ws_id']=="SHOWCAND" || $gridExtraFields['frm_ws_id']=="SHOWCANDPARSE") && $gridExtraFields['frm_ws_email']!="")
			{
				// Displaying candidates for SHOW CANDIDATE Button from OUTLOOK
				$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
				$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
			}
			
			
			$oque.= $cand_sub_query;
			$tque.= $cand_sub_query;
			/* $oque_split = explode('where',$oque);
			$oque_built = $crmGroupTable." where ".$oque_split[(count($oque_split)-1)];
			array_pop($oque_split);
			$oque = implode(" where ",$oque_split);
			$oque = $oque.$oque_built; */

			/* $tque_split = explode('where',$tque);
			$tque_built = $crmGroupTable." where ".$tque_split[(count($tque_split)-1)];
			array_pop($tque_split);
			$tque = implode(" where ",$tque_split);
			$tque = $tque.$tque_built; */

			if($gridExtraFields['duplicate'] == 'yes')
				$qstr = $gd->duplicateCandidateChecking($gridExtraFields['duplicateCandfname'],$gridExtraFields['duplicateCandlname'],$gridExtraFields['duplicateCandemail']);				

			// This query will give us the total number of records, for that we will remove the limit string.
			$tque .= " $qstr $CompanyCond $grpque $aqstr $crmGroupCondition";
			$oque="$oque $qstr $CompanyCond $grpque $aqstr $crmGroupCondition $ostr $lstr";

			// This function will give us the total number of records.			
			$total=$gd->getTotalRows($tque);
		}
		else
		{
			$tque="SELECT count(1) ";
	
			$oque="SELECT
			candidate_list.sno as sno,
			candidate_list.username as username,
			candidate_list.profiletitle profiletitle,
			candidate_list.fname as fname,
			candidate_list.lname as lname,
			candidate_list.recentemp as company,
			candidate_list.email as email,
			candidate_list.hphone as hphone,
			candidate_list.wphone as wphone,
			candidate_list.areacode as areacode,
			candidate_list.hareacode as hareacode, 
			candidate_list.wareacode as wareacode, 
			candidate_list.mareacode as mareacode, 
			candidate_list.city as city,
			candidate_list.state as state,
			candidate_list.zip as zip,
			candidate_list.mobile as mobile,
			candidate_list.ds_pobstatus as pobstatus,
			IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) as candtype,
			IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share')) as shrtype,
			IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail))) as candavl,
			users.name as owname,
			".tzRetQueryStringDTime('candidate_list.ctime','Date','/')." as crdate,
			".tzRetQueryStringDTime('candidate_list.mtime','Date','/')." as mddate,
			candidate_list.resid as resid,
			candidate_list.owner as owner,
			manage.name as mgname, 
			candidate_list.cl_source as source,
			mg.name as sourcetype,
			IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', IF(candidate_list.other_email = '', candidate_list.fname, ''), ''), '') as email_flag_name,
                IF(candidate_list.email = '', IF(candidate_list.alternate_email = '', candidate_list.other_email, candidate_list.alternate_email), candidate_list.email) as cand_email_id, candidate_list.wotc_mja_status,pc.caregiver_id,veas.email as eskill_email";
			if(trim($gridExtraFields['resume'])=="" || ($gridExtraFields['SpeedSearchString']=='' && $gridExtraFields['SpeedSearchString']=='?'))
			{
					// Replacing phone number fields search field to map any numbers  or with -,(,)'s and spaces.
					foreach($ssFields as $ssFields_key => $ssFields_value) {
						if (strpos($ssFields_value, 'desirejob') !== false) {
						   $asFieldsKey = $ssFields_key;
						   $gridSearchFields[$asFieldsKey-1] = desiredJobType($gridSearchFields,$asFieldsKey);
						}
					}
				}
			//Added by vijaya to provide checking for duplicate candidates.		
			if($gridExtraFields['duplicate']== "yes")
			{
				$gridSearchFields[1] = $gd->gridSearchFieldConvert($gridSearchFields[1]);
				$gridSearchFields[2] = $gd->gridSearchFieldConvert($gridSearchFields[2]);
				$gridSearchFields[4] = $gd->gridSearchFieldConvert($gridSearchFields[4]);
	
				$duplicateCheck = $gd->duplicateCandidateChecking($gridSearchFields[1],$gridSearchFields[2],$gridSearchFields[4]);
			}
			else
			{
				if(trim($gridExtraFields['resume'])!=""  || ($gridExtraFields['SpeedSearchString']!='' &&  $gridExtraFields['SpeedSearchString']!='?'))
				{
					//require("searchdatabase.inc");

					$setQry = "SET SESSION group_concat_max_len=1073740800";
					mysql_query($setQry,$db);
	
					require("quickSubCandidates.inc");
					
					$searchstr=searchSubResumeSphinx($gridExtraFields['resume']);
					
					require("visualsearch_candidates.php");
					require("database.inc");
				}
				
			}
	
			if($aqstr=="")
				$aqstr=" 1=1 ";
			
			/* if($pageFrom == "crmGroups") 
			{
				$crmGroupTable="crmgroup_details,";
				$crmGroupCondition = " AND crmgroup_details.groupid='".$groupId."' AND crmgroup_details.refid=candidate_list.sno";
			}		 */
	
			$tque.=" FROM candidate_list
			INNER JOIN candidate_appliedjobs as ca ON (candidate_list.sno= ca.candidate_id)
			INNER JOIN posdesc as jo ON (jo.posid = ca.req_id AND jo.posid = '".$gridExtraFields['posid']."')
			LEFT JOIN users ON candidate_list.owner=users.username
			LEFT JOIN manage ON candidate_list.cl_status=manage.sno 
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN prophecy_caregivers pc ON pc.username = candidate_list.username AND module='Candidates'
			LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = candidate_list.email";
	
			$tque.=" WHERE candidate_list.status='ACTIVE'  AND (candidate_list.owner='$username' OR FIND_IN_SET('$username',candidate_list.accessto )>0 OR candidate_list.accessto='ALL') AND ".$aqstr." ".$cand_sub_query." ";
			$oque.=" FROM  candidate_list
			INNER JOIN candidate_appliedjobs as ca ON (candidate_list.sno= ca.candidate_id)
			INNER JOIN posdesc as jo ON (jo.posid = ca.req_id AND jo.posid = '".$gridExtraFields['posid']."')
			LEFT JOIN users ON candidate_list.owner=users.username
			LEFT JOIN manage ON candidate_list.cl_status=manage.sno
			LEFT JOIN manage AS mg ON candidate_list.cl_sourcetype=mg.sno 
			LEFT JOIN prophecy_caregivers pc ON pc.username = candidate_list.username AND module='Candidates'
            LEFT JOIN vw_eskill_assessments_sent veas ON veas.email = candidate_list.email";
	            
			$oque.=" WHERE candidate_list.status='ACTIVE'  AND (candidate_list.owner='$username' OR FIND_IN_SET('$username',candidate_list.accessto )>0 OR candidate_list.accessto='ALL') AND ".$aqstr." ".$cand_sub_query." ";
	
			if($gridExtraFields['checklist'] != '')
			{
				//Duplicate Candidates matching ID from Duplicate screen
				$oque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";
				$tque.= " AND candidate_list.sno IN (".$gridExtraFields['checklist'].")";		
			}
			if(($gridExtraFields['frm_ws_id']=="SHOWCAND" || $gridExtraFields['frm_ws_id']=="SHOWCANDPARSE") && $gridExtraFields['frm_ws_email']!="")
			{
				// Displaying candidates for SHOW CANDIDATE Button from OUTLOOK
				$oque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
				$tque.= " AND '".$gridExtraFields['frm_ws_email']."' IN (candidate_list.email, candidate_list.alternate_email, candidate_list.other_email) ";
			}
	
			$asFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share'))","IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail)))","users.name","candidate_list.cl_source","mg.name",tzRetQueryStringDTime('candidate_list.ctime','Date','/'),tzRetQueryStringDTime('candidate_list.mtime','Date','/'),"candidate_list.ds_pobstatus","candidate_list.wotc_mja_status","pc.caregiver_id","eskill_email","");
	
			$ssFields=array("","candidate_list.profiletitle","trim(candidate_list.fname)","trim(candidate_list.lname)","trim(candidate_list.recentemp)","trim(candidate_list.email)","candidate_list.hphone","candidate_list.wphone","candidate_list.mobile","candidate_list.city","candidate_list.state","candidate_list.zip","IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate'))","manage.name","IF(candidate_list.accessto='ALL','Public',IF(candidate_list.accessto='$username','Private','Share'))","IF(candidate_list.avail = 'inactive', 'Inactive', IF((candidate_list.avail = '0-0-0' OR candidate_list.avail = '' OR candidate_list.avail IS NULL OR candidate_list.avail = 'immediate'),'Immediate', IF((datediff(DATE_FORMAT(STR_TO_DATE(candidate_list.avail, '%m/%d/%Y'), '%Y-%m-%d'), now())) < 0,'Immediate', candidate_list.avail)))","users.name","candidate_list.cl_source","mg.name","candidate_list.ctime","candidate_list.mtime","candidate_list.ds_pobstatus","candidate_list.wotc_mja_status","pc.caregiver_id","eskill_email","");
			
			$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
			
			$lstr=$gd->buildLimt($gridPage,$gridRecords);
	
			$CandiateCond = "";
	
			if($gridSearchFields[12] != "")
			{
				$CandiateCond.=" AND IF(candidate_list.ctype='Employee','Employee',IF(candidate_list.owner='$username','My Candidate','Candidate')) = '".$gridSearchFields[12]."' ";
				$gridSearchFields[12] = "";
			}
	
			if($gridSearchFields[13] != "")
			{
				$CandiateCond.=" AND manage.name = '".$gridSearchFields[13]."' ";
				$gridSearchFields[13] = "";
			}
			// Replacing phone number fields query field to map any numbers or with -,(,)'s and spaces.
			if(in_array('candidate_list.hphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.hphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.hphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.hphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.wphone',$asFields)){
				$asFieldsKey = array_search("candidate_list.wphone", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.wphone",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.wphone",$gridSearchFields,$asFieldsKey);
			}
			if(in_array('candidate_list.mobile',$asFields)){
				$asFieldsKey = array_search("candidate_list.mobile", $asFields);
				$asFields[$asFieldsKey] = phoneNoFilterAsFld("candidate_list.mobile",$asFieldsKey);
				$gridSearchFields[$asFieldsKey-1] = phoneNoFilterGridFld("candidate_list.mobile",$gridSearchFields,$asFieldsKey);
			}

			if($gridExtraFields['duplicate']!="yes")
				$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
			else
				$qstr=$duplicateCheck;
	
			$tque=$gd->buildTQuery($tque,$qstr.$CandiateCond,$gstr);
			$oque=$gd->buildOQuery($oque,$qstr.$CandiateCond,$ostr,$lstr,$gstr);
	
			$tres = mysql_query($tque,$db);
			$total = mysql_num_rows($tres);
			if($total == 1)
			{
				$trow = mysql_fetch_row($tres);
				$total = $trow[0];
			}
		}
		
		// ZCR order by condition 
		/* if(isset($_SESSION['SPHINX_Candidates_sub']['savezipCODE']))
		{
			if(isset($_SESSION['ZCR_SPHINX_Candidates'])){
				$zipMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['savezipCODE']);
				$ZcrSortArr = $_SESSION['ZCR_SPHINX_Candidates'];

				asort($ZcrSortArr[$zipMilesArr[1]]);

				$ZcrOrderByQry = "'".implode("','",array_keys($ZcrSortArr[$zipMilesArr[1]]))."'";

				$oque = str_replace("ZCR","field(candidate_list.zip,".$ZcrOrderByQry.")",$oque);
			} else {
				$oque = str_replace("ZCR","candidate_list.zip",$oque);
			}
		} else {
			$oque = str_replace("ZCR","candidate_list.zip",$oque);
		} */

		// ACR order by condition 
		/* if(isset($_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']))
		{
			if(isset($_SESSION['ACR_SPHINX_Candidates'])){
				$areaMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']);
				$AcrSortArr = $_SESSION['ACR_SPHINX_Candidates'];

				asort($AcrSortArr[$areaMilesArr[1]]);

				$AcrOrderByQry = "'".implode("','",array_keys($AcrSortArr[$areaMilesArr[1]]))."'";

				$oque = str_replace("ACR","field(IF(candidate_list.hareacode IN(".$AcrOrderByQry."),candidate_list.hareacode,IF(candidate_list.wareacode IN(".$AcrOrderByQry."),candidate_list.wareacode,IF(candidate_list.mareacode IN(".$AcrOrderByQry."),candidate_list.mareacode,''))),".$AcrOrderByQry.")",$oque);
			} else {
				$oque = str_replace("ACR","candidate_list.hareacode",$oque);
			}
		} else {
			$oque = str_replace("ACR","candidate_list.hareacode",$oque);
		} */

		$gridData=$gd->buildManageAppliedCandList($oque,$gridSortCol,$gridSort,$cvsid,$module);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$crmGroupCondition,$oque);

		return $objResponse;
	}
	
	// Candidates Grid Data
	function buildManageAppliedCandList($que,$gridSortCol,$gridSort,$cvsid,$module)
	{
		global $maildb,$db, $username;

		$gd=new gridData();
		
		$custom_grid_function_obj = new CustomGridFunctions();
		$grdi_details = $custom_grid_function_obj->getGridName("candidates",$username,$cvsid);
		
		// Why we are adding 1 becoz in the below for loop , they are considering 0 as checkbox value.
	    $customSortOrderVal_pob = $this->fetchCustomSortOrder_pob(3,$cvsid);	
		if($customSortOrderVal_pob != '')		
			$returnVal_pob = 1 + $this->fetchCustomSortOrder_pob(3,$cvsid);
		else
			$returnVal_pob = '';
		
		$j=0;
		$grid=array();
		$grid_header = array();
		$res=mysql_query($que,$db);
		
		if(!empty($grdi_details))
		{
			$res_grid_headers = mysql_query($que,$db);
			
			while($rec_grid_headers = mysql_fetch_field($res_grid_headers))
			{
				$grid_header[] = strtolower($rec_grid_headers->name);
			}
			//array_unshift($grid_header,"sno");
			
			while ($row=mysql_fetch_row($res))
			{
				$grid_cols = 0;
				for($i=0;$i<count($row);$i++)
				{					
					if($i == 0)
					{
						$candidateCheckboxVal = $this->getCandidateCheckBoxValue($row[$i]);
						if((trim($candidateCheckboxVal['fname']).trim($candidateCheckboxVal['lname']))=="")
							$candAlert=trim($candidateCheckboxVal['profiletitle']);
						else
							$candAlert=trim(trim($candidateCheckboxVal['fname'])." ".trim($candidateCheckboxVal['lname']));
							$cand_send = "";
						$cand_send = $candidateCheckboxVal['fname']." ".$candidateCheckboxVal['lname']."^".$candidateCheckboxVal['pobstatus'];
						$grid[$j][$grid_cols++]="<label class='container-chk'><input name='cand[]' value='".$candidateCheckboxVal['sno']."' type='hidden'><input type=checkbox name='auids[]'  id='auids[]' OnClick=chk_clearTop() value='".$candidateCheckboxVal['sno']."|".html_tls_specialchars($candidateCheckboxVal['candtype'],ENT_QUOTES)."|".$candidateCheckboxVal['owner']."|".$candidateCheckboxVal['shrtype']."|".html_tls_specialchars($candAlert,ENT_QUOTES)."|".$j."|".html_tls_specialchars($candidateCheckboxVal['username'],ENT_QUOTES)."'><span class='checkmark'></span></label>
						<input type=hidden id='email_flag_name_".$candidateCheckboxVal['sno']."' name='email_flag_name[]' value='".$this->convertSpecChars($candidateCheckboxVal['email_flag_name'])."'>
						<input type='hidden' id='cand_email_".$candidateCheckboxVal['sno']."' name='cand_email[]' value='".$this->convertSpecChars($candidateCheckboxVal['cand_email_id'])."'>
						<input type='hidden' id='cand_ds_pob_".$candidateCheckboxVal['sno']."' name='cand_ds_pob[]' value='".$this->convertSpecChars($cand_send)."'><input type=hidden name=candids[] value='".$candidateCheckboxVal['sno']."'>
						";
					}
					else
					{
						if($grid_header[$i] == "desirejob")
						{
							
							if($row[$i] == ''){
								$grid[$j][$grid_cols++] = '';
							}else{
								$desiredJob = explode('|',$row[$i]);
								$desiredJob = array_filter($desiredJob);
								$grid[$j][$grid_cols++] = implode(',',$desiredJob);
							}
						}elseif($returnVal_pob == $i && $customSortOrderVal_pob !=''){
					
							    $hyperLink_pob = "<a style='color: #0099ff;'  href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcand')>".ucwords($this->convertSpecChars($row[$i]))."</a>";
								$grid[$j][$grid_cols++]= $hyperLink_pob;
								
						}elseif(strtolower($grid_header[$i]) == "caregiver_id"){
					
							    $prophecy_viewLink='';
								if($row[$i] !=''){
									$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row[$i]."','crmcandidates')>View</a>";
								}
								$grid[$j][$grid_cols++]= $prophecy_viewLink;
								
						}elseif(strtolower($grid_header[$i]) == "eskill_email"){
					
							    $eskill_viewLink='';
								if($row[$i] !=''){
									$eskill_viewLink = "<a href=javascript:viewEskillResults('".$row[$i]."','Candidates','".$row[0]."')>View</a>";
								}
								$grid[$j][$grid_cols++]= $eskill_viewLink;
								
						}elseif(strtolower($grid_header[$i]) == "wotc_mja_status") 
                                                {
                                                        // WOTC-MJA condition
                                                        $grid[$j][$grid_cols++]=ucfirst($this->convertSpecChars($row[$i]));
                                                }  
                                                else 
                                                {
                                                        $grid[$j][$grid_cols++] = $this->convertSpecChars($row[$i]);
                                                }

						// Zipcode Radius (ZCR) Condition
						/*if(strtolower($grid_header[$i]) == "zip")
						{
							if(isset($_SESSION['SPHINX_Candidates_sub']['savezipCODE']) && isset($_SESSION['ZCR_SPHINX_Candidates']))
							{
								$zipMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['savezipCODE']);
								$grid[$j][$grid_cols++] = $_SESSION['ZCR_SPHINX_Candidates'][$zipMilesArr[1]][$row[$i]];
							} else {
								$grid[$j][$grid_cols++]="";
							}
						}
						// Areacode Radius (ACR) Condition
						if(strtolower($grid_header[$i]) == "hphone")
						{
							if(isset($_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']) && isset($_SESSION['ACR_SPHINX_Candidates']))
							{
								$areaMilesArr = explode("|", $_SESSION['SPHINX_Candidates_sub']['saveareacodePSM']);
								$grid[$j][$grid_cols++] = $gd->getAreaCodeRadiusPSM($row[0],'candidate_list',$areaMilesArr[1],'ACR_SPHINX_Candidates');                           
							} else {
								$grid[$j][$grid_cols++]="";
							}
						}*/
					}
					
				}				
				$resume_link = "";
				if($candidateCheckboxVal['resid']!="" && $candidateCheckboxVal['resid']!=0)
					$resume_link="<a href=getresume.php?fsno=".$candidateCheckboxVal['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
				
				/*
				 *$grid[$j][count($row)]= $resume_link;				
				
				$grid[$j][count($row)+1]= '';				
				$grid[$j][(count($row)+2)]= "/BSOS/Marketing/Candidates/review.php?cno=".$row[0]."&dest=0";
				*/
				$grid[$j][$grid_cols++]= $resume_link;				
				
				$grid[$j][$grid_cols++]= '';				
				$grid[$j][$grid_cols++]= "/BSOS/Marketing/Candidates/review.php?cno=".$row[0]."&dest=0&module=".$module;
				$j++;
			}
		}
		else
		{
			while ($row=mysql_fetch_array($res))
			{
				if((trim($row['fname']).trim($row['lname']))=="")
					$candAlert=trim($row['profiletitle']);
				else
					$candAlert=trim(trim($row['fname'])." ".trim($row['lname']));
	
	
					$cand_send = "";
					$cand_send = $row['fname']." ".$row['lname']."^".$row['pobstatus'];
					
					
				$resume_link = "";
				if($row['resid']!="" && $row['resid']!=0)
					$resume_link="<a href=getresume.php?fsno=".$row['resid']." target='_top'><i class='fa fa-download' title='View&nbsp;Resume'></i></a>";
			
				$grid[$j][0]="<label class='container-chk'><input name='cand[]' value='".$row['sno']."' type='hidden'><input type=checkbox name=auids[] OnClick=chk_clearTop() value='".$row['sno']."|".$row['candtype']."|".$row['owner']."|".$row['shrtype']."|".html_tls_specialchars($candAlert,ENT_QUOTES)."|".$j."|".$row['username']."'><span class='checkmark'></span></label>
				<input type=hidden id='email_flag_name_".$row['sno']."' name='email_flag_name[]' value='".$this->convertSpecChars($row['email_flag_name'])."'><input type='hidden' id='cand_email_".$row['sno']."' name='cand_email[]' value='".$this->convertSpecChars($row['cand_email_id'])."'><input type='hidden' id='cand_ds_pob_".$row['sno']."' name='cand_ds_pob[]' value='".$this->convertSpecChars($cand_send)."'><input type=hidden name=candids[] value='".$row['sno']."'>
				";
				$grid[$j][1]=$this->convertSpecChars($row['profiletitle']);
				$grid[$j][2]=$this->convertSpecChars($row['fname']);
				$grid[$j][3]=$this->convertSpecChars($row['lname']);
				$grid[$j][4]=$this->convertSpecChars($row['company']);
				$grid[$j][5]=$this->convertSpecChars($row['email']);
				$grid[$j][6]=$this->convertSpecChars($row['hphone']);
				$grid[$j][7]=$this->convertSpecChars($row['wphone']);
				$grid[$j][8]=$this->convertSpecChars($row['mobile']);
	

				$grid[$j][9]=$this->convertSpecChars($row['city']);
				$grid[$j][10]=$this->convertSpecChars($row['state']);
				$grid[$j][11]=$this->convertSpecChars($row['zip']);

	
				$grid[$j][12]=$this->convertSpecChars($row['candtype']);
				$grid[$j][13]=$this->convertSpecChars($row['mgname']);
				$grid[$j][14]=$this->convertSpecChars($row['shrtype']);
				$grid[$j][15]=$this->convertSpecChars($row['candavl']);
				$grid[$j][16]=$this->convertSpecChars($row['owname']);	
				$grid[$j][17]=$this->convertSpecChars($row['source']);			
				$grid[$j][18]=$this->convertSpecChars($row['sourcetype']);			
				$grid[$j][19]=$this->convertSpecChars($row['crdate']);
				$grid[$j][20]=$this->convertSpecChars($row['mddate']);
				$grid[$j][21]="<a style='color: #0099ff;' href=javascript:showDocuSignPOBHistory('".$row[0]."','crmcand')>".ucwords($this->convertSpecChars($row['pobstatus']))."</a>";
				$grid[$j][22]=ucfirst($this->convertSpecChars($row['wotc_mja_status']));		//WOTC MJA Status
				$prophecy_viewLink='';
				if($row['caregiver_id'] !=''){
					$prophecy_viewLink = "<a href=javascript:viewProphecyCaregiver('".$row['caregiver_id']."','crmcandidates')>View</a>";
				}
				$grid[$j][23]=$prophecy_viewLink;
                                
                $eskill_viewLink='';

				if($row['eskill_email'] !=''){
					$eskill_viewLink = "<a href=javascript:viewEskillResults('".$row['eskill_email']."','Candidates','".$row['sno']."')>View</a>";
				}
				$grid[$j][24]=$eskill_viewLink;
				$grid[$j][25]=$resume_link;			
				$grid[$j][26]="";
				$grid[$j][27]="/BSOS/Marketing/Candidates/review.php?cno=".$row['sno']."&dest=0&module=".$module;
				$j++;
			}
		}
		return $grid;
	}
	

	// Function to get the list of Applicant Distribution Groups.
	 function getApplicantDistributionGroups($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db;
		
		$gd=new gridData();
	
		$asFields = array("", "".getEntityDispName('adg.sno', 'LOWER(adg.group_name)', 1)."", "totalusers", "adg.automation", "adg.status", "cu.name", tzRetQueryStringDTime('adg.cdate','DateTime','/'), "mu.name", tzRetQueryStringDTime('adg.mdate','DateTime','/'));
				
		$ssFields = array("", "".getEntityDispName('adg.sno', 'LOWER(adg.group_name)', 1)."", "totalusers", "adg.automation", "adg.status", "cu.name", "adg.cdate", "mu.name", "adg.mdate");
		
		
		// $whereCond 	= " adg.status IN ('active','inactive') ";
		$whereCond 	= " 1=1 ";
		$andClause	= '';

		if($gridSearchFields[3]=="active")
		{
			$whereCond .= " AND adg.status IN ('active') ";
			$gridSearchFields[3] = "";
		}

		// GROUP BY adg.sno having count(*)=1
		$grpbyHaving = "";
		if($gridSearchFields[1]!="")
		{
			$grpbyHaving .= " having count(*)=".$gridSearchFields[1];
			$gridSearchFields[1] = "";
		}

		$gstr = " GROUP BY adg.sno".$grpbyHaving;

		$tque="SELECT adg.sno 
		FROM ad_group_settings adg	
		LEFT JOIN ad_group_membership adu ON adg.sno = adu.group_sno
		LEFT JOIN users cu ON cu.username = adg.cuser
		LEFT JOIN users mu ON mu.username = adg.muser
		LEFT JOIN users ou ON ou.username = adg.default_user
		WHERE ".$whereCond.$andClause;
	
		$oque="SELECT
			adg.sno, 
			".getEntityDispName('adg.sno', 'adg.group_name', 1).",
            COUNT(au.username) AS totalusers,
			adg.automation,
			adg.status,
			cu.name,
			".tzRetQueryStringDTime('adg.cdate','DateTime','/')." AS cdate,
			mu.name,
			".tzRetQueryStringDTime('adg.mdate','DateTime','/')." AS mdate,
			adg.max_cand,
			adg.max_days,
			adg.last_modified,
			adg.note,
			adg.submission,
			adg.placement,
			adg.rotations,
			IF(adg.exclude_weekends = 'Y', 'Yes', 'No'),
			ou.name			
			FROM ad_group_settings adg
			LEFT JOIN ad_group_membership adu ON adg.sno = adu.group_sno
			LEFT JOIN users au ON adu.userid = au.username AND au.status!='DA'
			LEFT JOIN users cu ON cu.username = adg.cuser
			LEFT JOIN users mu ON mu.username = adg.muser
			LEFT JOIN users ou ON ou.username = adg.default_user 	
			WHERE ".$whereCond.$andClause;

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		if($qstr!="")
		{
			$tque.=" AND 1=1";
            $oque.=" AND 1=1";
		}

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
		
		$tque = "SELECT COUNT(*) FROM (".$tque.") grps";

		$gridData=$gd->buildApplicantDistributionGroups($oque);
		$total=$gd->getTotalRows($tque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);

		return $objResponse;	
	}

	// Function to build the list of Applicant Distribution Groups.
	function buildApplicantDistributionGroups($que)
	{
		global $db;
		$j=0;
		$grid = array();
		$res = mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";


			// Group Name Hover Details Customization.
			// max_cand(9),max_days(10),last_modified(11),activity(12),submission(13),placement(14),rotations(15)

			$owner_str = "";

			if($row[11]=='Y')
			{
				$owner_str.="Last Modified Date";
			}
			if($row[12]=='Y')
			{
				if($owner_str=="")
					$owner_str.="Notes";
				else
					$owner_str.=", Notes";
			}
			if($row[13]=='Y')
			{
				if($owner_str=="")
					$owner_str.="Submission";
				else
					$owner_str.=", Submission";
			}
			if($row[14]=='Y')
			{
				if($owner_str=="")
					$owner_str.="Placement";
				else
					$owner_str.=", Placement";
			}

			$group_details = '<span><div class="tooltip">'.$this->convertSpecChars($row[1]).'<span class="tooltiptext">
			Maximum number of open applicants for a user: '.$this->convertSpecChars($row[9]).'.<br>	  
			Timeline to re-assign automatically: '.$this->convertSpecChars($row[10]).' day(s).<br>
			Exclude weekends: '.$row[16].'.<br>
			Change Ownership based on: '.$owner_str.'.<br>
			Maximum number of rotations: '.$this->convertSpecChars($row[15]).' time(s).<br>
			Default Owner: '.$this->convertSpecChars($row[17]).'</span></div></span>';

			$grid[$j][1]=$group_details;

            $grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=($row[3]=="Y")?"Yes":"No"; 
			$grid[$j][4]=($row[4]=="active")?ucfirst($row[4]):"Disabled";
			$grid[$j][5]=$this->convertSpecChars($row[5]);
			$grid[$j][6]=$this->convertSpecChars($row[6]);
			$grid[$j][7]=$this->convertSpecChars($row[7]);
			$grid[$j][8]=$this->convertSpecChars($row[8]);
			$grid[$j][9]=$row[0];
			$j++;
		}
		return $grid;
	}
	
	// E-Verify functions
	function getEverifyAccounts($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
		global $db,$username;

		$gd = new gridData();

		$asFields = array("","everifyacc.user_name","everifyacc.everify_status","uc.name",tzRetQueryStringDate('everifyacc.cdate','DateTime','/'),"um.name",tzRetQueryStringDate('everifyacc.mdate','Date','/'));
		$ssFields = array("","everifyacc.user_name","everifyacc.everify_status","uc.name","everifyacc.cdate","um.name","everifyacc.mdate");

		$tque="SELECT COUNT(1)
                        FROM eVerifyAccounts everifyacc
                             LEFT JOIN users uc ON uc.username = everifyacc.cuser
                             LEFT JOIN users um ON um.username = everifyacc.muser
                       WHERE everifyacc.status IN ('active')";
                
		$oque=" SELECT everifyacc.sno,
                                everifyacc.user_name,
                                everifyacc.everify_status,
                                uc.name,
                                ".tzRetQueryStringDate('everifyacc.cdate','DateTime','/').",
                                um.name,
                                ".tzRetQueryStringDate('everifyacc.mdate','DateTime','/')."
                           FROM eVerifyAccounts everifyacc
                                LEFT JOIN users uc ON uc.username = everifyacc.cuser
                                LEFT JOIN users um ON um.username = everifyacc.muser
                          WHERE everifyacc.status IN ('active')";

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildEverifyAcc($oque);

		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		// $objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildEverifyAcc($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name='auids[]' id='auids[]' onClick=chk_clearTop() value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = $this->convertSpecChars($row[6]);
            $grid[$j][7] = "editEverifyUsers.php?accountID=".$row[0];
			$j++;
		}

		return $grid;
	}	

	// Everify Employee Management
	function  getEverifyList($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields, $gridExtraFields)
	{
		global $maildb,$db,$username,$stat,$user_timezone,$accountingpref,$ac_aced;

		if($gridSortCol=="")
			$gridSortCol=1;

		$gd=new gridData();

    	$asFields=array("","ev.first_name","ev.last_name","emp_list.sno","ev.ssn_hash","ev.case_number","ev.case_status_display","ev.case_eligibility_statement","IF(ev.referred_date='0000-00-00','',ev.referred_date)","IF(ev.closed_date='0000-00-00','',ev.closed_date)","empterminated","own.name","ev.cdate","musr.name","ev.mdate");
		
		$ssFields=array("","ev.first_name","ev.last_name","emp_list.sno","ev.ssn_hash","ev.case_number","ev.case_status_display","ev.case_eligibility_statement","IF(ev.referred_date='0000-00-00','',DATE_FORMAT(ev.referred_date,'%m/%d/%Y'))","IF(ev.closed_date='0000-00-00','',DATE_FORMAT(ev.closed_date,'%m/%d/%Y'))","empterminated","own.name","DATE_FORMAT(ev.cdate,'%m/%d/%Y')","musr.name","DATE_FORMAT(ev.mdate,'%m/%d/%Y')");

		$department_dynStr = " AND FIND_IN_SET('".$username."',department.permission)>0 ";

		$tque = "select count(emp_list.sno) from everify_cases ev
		 LEFT JOIN emp_list ON emp_list.sno=ev.emp_sno 
		 LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		 LEFT JOIN hrcon_w4 ON (emp_list.username=hrcon_w4.username) 
		 LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 
		 LEFT JOIN hrcon_personal ON hrcon_personal.username=emp_list.username 
		 LEFT JOIN department ON hrcon_compen.dept=department.sno 
		 LEFT JOIN users own on ev.cuser=own.username 
		 LEFT JOIN users musr on ev.muser=musr.username 
		 WHERE ev.case_status NOT IN ('Backup') AND hrcon_compen.ustatus='active' AND hrcon_w4.ustatus='active' AND hrcon_general.ustatus='active' AND hrcon_personal.ustatus='active' AND emp_list.lstatus not in ('DA','INACTIVE') ".$department_dynStr;

		$oque = "select emp_list.sno,ev.first_name,ev.last_name,ev.ssn,ev.case_number,ev.case_status_display,ev.case_eligibility_statement,IF(ev.referred_date='0000-00-00','',DATE_FORMAT(ev.referred_date,'%m/%d/%Y')),IF(ev.closed_date='0000-00-00','',DATE_FORMAT(ev.closed_date,'%m/%d/%Y')),IF(emp_list.empterminated='N','Active','Terminated') as empterminated,DATE_FORMAT(ev.cdate,'%m/%d/%Y'),own.name approveuser,DATE_FORMAT(ev.mdate,'%m/%d/%Y'),musr.name muser, ev.sno from everify_cases ev
		 LEFT JOIN emp_list ON emp_list.sno=ev.emp_sno 
		 LEFT JOIN hrcon_general ON emp_list.username = hrcon_general.username 
		 LEFT JOIN hrcon_w4 ON (emp_list.username=hrcon_w4.username)
		 LEFT JOIN hrcon_compen ON hrcon_compen.username=emp_list.username 
		 LEFT JOIN hrcon_personal ON hrcon_personal.username=emp_list.username 
		 LEFT JOIN department ON hrcon_compen.dept=department.sno 
		 LEFT JOIN users own on ev.cuser=own.username				
		 LEFT JOIN users musr on ev.muser=musr.username 
		 WHERE ev.case_status NOT IN ('Backup') AND hrcon_compen.ustatus='active' AND hrcon_w4.ustatus='active' AND hrcon_general.ustatus='active' AND hrcon_personal.ustatus='active' AND emp_list.lstatus not in ('DA','INACTIVE')".$department_dynStr;

		$case_status="";
		if($gridSearchFields[5]=="Open")
		{
			$case_status=" AND (ev.case_status_display NOT IN('Closed','Queue','Archived')) ";
			$gridSearchFields[5] = "";
		}

		if($gridSearchFields[3]!="")
			$gridSearchFields[3]= $ac_aced->hash_data($gridSearchFields[3],$ac_aced->hash_salt);

		$gstr = "";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$ssFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$asFields); // Order by fields, append the where clause accordingly

		if($qstr!="")
		{
            $oque.=" AND 1=1";
            $tque.=" AND 1=1";
		}

		$qstr=$qstr.$case_status; 

		$tque=$gd->buildTQuery($tque,$qstr,'');
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildEverifyList($oque);
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

		return $objResponse;
	}

	function buildEverifyList($que)
	{
		global $maildb,$db,$stat,$ac_aced;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]="<label class='container-chk'><input type=checkbox name=auids[] OnClick=chk_clearTop() value=\"$row[0]\"><input type=hidden name='case_status_".$row[0]."' id='case_status_".$row[0]."' value='".$this->convertSpecChars($row[5])."'><input type=hidden name='ec_sno_".$row[0]."' id='ec_sno_".$row[0]."' value='".$row[14]."'><span class='checkmark'></span></label>";
			$grid[$j][1]=$this->convertSpecChars($row[1]);
			$grid[$j][2]=$this->convertSpecChars($row[2]);
			$grid[$j][3]=$this->convertSpecChars($row[0]);
			$grid[$j][4]=$this->convertSpecChars(format_ssn($ac_aced->decrypt($row[3])));
			$grid[$j][5]=$this->convertSpecChars($row[4]);
			$grid[$j][6]=$this->convertSpecChars($row[5]);
			$grid[$j][7]=$this->displayCaseEligibility($row[6]);
			$grid[$j][8]=$this->convertSpecChars($row[7]);
			$grid[$j][9]=$this->convertSpecChars($row[8]);
			$grid[$j][10]=$this->convertSpecChars($row[9]);
			$grid[$j][11]=$this->convertSpecChars($row[11]);
			$grid[$j][12]=$this->convertSpecChars($row[10]);
			$grid[$j][13]=$this->convertSpecChars($row[13]);
			$grid[$j][14]=$this->convertSpecChars($row[12]);
			$grid[$j][15]=$row[14];

			$j++;
		}
	    return $grid;
	}

	function displayCaseEligibility($caseEligibilityStatement)
    {
        $elegibleStatuses = array(
                                "EMPLOYMENT_AUTHORIZED"     => "Employment Authorized",
                                "NOT_AUTHORIZED_EMPLOYMENT" => "Not Authorized Employment",
                                "RESUBMIT_CASE"             => "Resubmit Case",
                                "NO_SHOW"                   => "No Show",
                                "NO_ACTION_FNC"             => "No Action FNC"
                                );

        if(trim($caseEligibilityStatement)=="")
            return NULL;
        else
            return $elegibleStatuses[trim($caseEligibilityStatement)];
    }
  
function getAvailableCredits($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields)
	{
	global $db,$username;
            $gd = new gridData();
            $asFields=array("","credit_notes","CONCAT_WS('','CR',credit_id)","CONCAT_WS('-',staffacc_cinfo.sno,staffacc_cinfo.cname)","CONCAT_WS('-',emp_id,emp_list.name)","invoice.invoice_number","credit_amount","DATE_FORMAT(CONVERT_TZ(credit_cdate, 'SYSTEM', 'EST5EDT'),'%m/%d/%Y %h:%i %p')","u2.name","DATE_FORMAT(CONVERT_TZ(credit_mdate, 'SYSTEM', 'EST5EDT'),'%m/%d/%Y %h:%i %p')","u1.name");
            $ssFields=array("","credit_notes","credit_memo.credit_id","CONCAT_WS('-',staffacc_cinfo.sno,staffacc_cinfo.cname)","CONCAT_WS('-',emp_id,emp_list.name)","invoice.invoice_number","credit_amount","credit_memo.credit_cdate","u2.name","credit_memo.credit_mdate","u1.name");

        //$tque="SELECT DISTINCT count(credit_id) FROM credit_memo 
		//LEFT JOIN credit_memo_trans ON  (credit_memo_trans.credit_memo_sno = credit_memo.credit_id  AND credit_memo_trans.type='invoice') 
		//LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = credit_memo.credit_source where credit_used_status='N'";
		
		//$tque="SELECT count(credit_id) FROM credit_memo where credit_used_status='N'";
		
		$tque="SELECT DISTINCT count(credit_id) FROM credit_memo
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = credit_memo.credit_source 
		LEFT JOIN invoice ON invoice.sno = credit_memo.credit_inv_bill_id
		LEFT JOIN emp_list ON emp_list.sno = credit_memo.emp_id
		LEFT JOIN users u1 ON u1.username = credit_memo.credit_muser 
		LEFT JOIN users u2 ON u2.username = credit_memo.credit_cuser where credit_notes!='Bill Deleted' AND credit_notes!='Extra Credit Amount' AND credit_used_status='N'";
		
		/*$oque = "SELECT DISTINCT credit_id,credit_source,credit_inv_bill_id,credit_amount,credit_type,credit_used_status,
		".tzRetQueryStringDTime('credit_cdate','DateTime','/').",credit_notes,credit_memo_trans.used_amount,staffacc_cinfo.cname,credit_desc,u1.name,".tzRetQueryStringDTime('credit_mdate','DateTime','/').",staffacc_cinfo.sno,u2.name FROM credit_memo 
		LEFT JOIN credit_memo_trans ON  (credit_memo_trans.credit_memo_sno = credit_memo.credit_id  AND credit_memo_trans.type='invoice') 
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = credit_memo.credit_source
		LEFT JOIN users u1 ON u1.username = credit_memo.credit_muser 
		LEFT JOIN users u2 ON u2.username = credit_memo.credit_cuser where credit_used_status='N'";*/
		
		$oque = "SELECT DISTINCT credit_id,credit_source,invoice.invoice_number,credit_amount,credit_type,credit_used_status,
		".tzRetQueryStringDTime('credit_cdate','DateTime','/').",credit_notes,staffacc_cinfo.cname,credit_desc,if(credit_notes!='Available Credits','System',u2.name),".tzRetQueryStringDTime('credit_mdate','DateTime','/').",staffacc_cinfo.sno,if(credit_cdate=credit_mdate AND credit_notes != 'Available Credits','System',u1.name),emp_id,emp_list.name,credit_memo.line_type FROM credit_memo 
		LEFT JOIN staffacc_cinfo ON staffacc_cinfo.sno = credit_memo.credit_source 
		LEFT JOIN invoice ON invoice.sno = credit_memo.credit_inv_bill_id
		LEFT JOIN emp_list ON emp_list.sno = credit_memo.emp_id
		LEFT JOIN users u1 ON u1.username = credit_memo.credit_muser 
		LEFT JOIN users u2 ON u2.username = credit_memo.credit_cuser where credit_notes!='Bill Deleted' AND credit_notes!='Extra Credit Amount' AND credit_used_status='N'";
        if($gridSearchFields[7] != "")
			{
				$searchname.=" AND if(credit_notes!='Available Credits','System',u2.name) LIKE '%".$gridSearchFields[7]."%' ";
				$gridSearchFields[7] = "";
			}
			
			if($gridSearchFields[9] != "")
			{
				$searchname.=" AND if(credit_cdate=credit_mdate AND credit_notes != 'Available Credits','System',u1.name) LIKE '%".$gridSearchFields[9]."%' ";
				$gridSearchFields[9] = "";
			}
            $gstr = "";
            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
			$qstr .= $searchname;
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            //$oque=$gd->buildOQuery($oque,$qstr,'order by credit_mdate DESC'.$lstr,$gstr);
			$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildAvailableCredits($oque);

            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            //$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$total,$oque);

            return $objResponse;
		
	}
	function buildAvailableCredits($que)
	{
		global $maildb,$db;

		$j=0;
		$grid=array();
		$res=mysql_query($que,$db);
		while ($row=mysql_fetch_array($res))
		{
			$grid[$j][0]='';
			$grid[$j][1]=$this->convertSpecChars($row[7]);
			$grid[$j][2]=$this->convertSpecChars('CR'.$row[0]);
			$grid[$j][3]=$this->convertSpecChars($row[12].'-'.$row[8]);
			if($row[14] != '0'){
			$grid[$j][4]=$this->convertSpecChars($row[14].'-'.$row[15]);
			}
			//$grid[$j][5]=$this->convertSpecChars($row[16]);
			if($row[2] != '0'){
			$grid[$j][5]=$this->convertSpecChars($row[2]);
			}
			$grid[$j][6]=$this->convertSpecChars($row[3]);
			$grid[$j][7]=$this->convertSpecChars($row[6]);
			
			$grid[$j][8]=$this->convertSpecChars($row[10]);
			$grid[$j][9]=$this->convertSpecChars($row[11]);
			
			$grid[$j][10]=$this->convertSpecChars($row[13]);
			$j++;

		}
		return $grid;
}

//In bound referral start
    function getReferralsTotalsSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db;
        $gd = new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields,"cr",False);
        $common_range_sd = $gd->commonReferralsFilter($gridExtraFields,"sd",False);
        //search
        $asFields = array("","GROUP_CONCAT(DISTINCT sno)", "GROUP_CONCAT(DISTINCT name)", "SUM(shared)", "SUM(refered)", "SUM(qualified)", "SUM(hired)", "SUM(bonus)");
        //sort
        $ssFields = array("","sno", "name", "SUM(shared)", "SUM(refered)", "SUM(qualified)", "SUM(hired)", "SUM(bonus)");

        $tque="SELECT sno
                FROM (
                SELECT el.sno, el.name, COUNT(sd.sno) shared, 0 refered, 0 qualified, 0 hired, 0 bonus
                FROM shared_data sd JOIN emp_list el ON sd.username = el.username
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                WHERE {$common_range_sd}
                GROUP BY el.username
                      UNION
                SELECT el.sno, el.name, 0 shared, COUNT(cr.sno) refered, 0 qualified, 0 hired, 0 bonus
                FROM cand_refer cr JOIN emp_list el ON cr.username = el.username 
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                WHERE cr.status = 'active'
                AND {$common_range}
                GROUP BY el.username
                      UNION
                SELECT el.sno, el.name, 0 shared, 0 refered, COUNT(DISTINCT cl.sno) qualified, 0 hired, 0 bonus
                FROM cand_refer cr JOIN emp_list el ON cr.username = el.username
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
                LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
                LEFT JOIN applicants app ON  app.username = cr.ref_id AND FIND_IN_SET(cr.req_id, app.jobtitle)
                WHERE cr.status = 'active' AND ((rs.pstatus IN ('P', 'S')) OR ((app.serial_no IS NOT NULL
                OR cr.user_id IS NOT NULL) AND app.astatus NOT IN ('hire', 'backup', 'HRF')))
                AND {$common_range}
                GROUP BY el.username
                      UNION
                SELECT el_u.sno, el_u.name, 0 shared, 0 refered, 0 qualified, COUNT(1) hired, 0 bonus
                FROM cand_refer cr
                LEFT JOIN emp_list el_u ON el_u.username = cr.username
                LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN emp_list el ON el.sno = cr.emp_id
                LEFT JOIN applicants app ON app.username = cr.ref_id
                LEFT JOIN hrcon_general hg ON el.username = hg.username
                WHERE cr.status = 'active' AND (hg.ustatus = 'active' AND el.lstatus NOT IN ('DA', 'INACTIVE')
                AND el.sno IS NOT NULL AND (FIND_IN_SET(cr.req_id, el.cur_project) OR FIND_IN_SET(cr.req_id,
                 app.jobtitle)) OR (app.jobtitle = '' AND el.cur_project = ''))
                AND {$common_range}
                GROUP BY el_u.username
                      UNION
                SELECT el.sno, el.name, 0 shared, 0 refered, 0 qualified, 0 hired, SUM(bonus_amount) bonus
                FROM cand_refer cr JOIN emp_list el ON cr.username = el.username
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                WHERE cr.status = 'active' AND cr.referral_status = '".getManageSno('Paid','referral_status')."'
                AND {$common_range}
                GROUP BY el.username
                ) temp";

        $oque="SELECT sno as checkele, sno, name, SUM(shared) shared, SUM(refered) refered, SUM(qualified) qualified, SUM(hired) hired, SUM(bonus) bonus
            FROM (
            SELECT el.sno, el.name, COUNT(sd.sno) shared, 0 refered, 0 qualified, 0 hired, 0 bonus
            FROM shared_data sd JOIN emp_list el ON sd.username = el.username
            LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
            LEFT JOIN department dp on dp.sno = hc.dept
            WHERE {$common_range_sd}
            GROUP BY el.username
                  UNION
            SELECT el.sno, el.name, 0 shared, COUNT(cr.sno) refered, 0 qualified, 0 hired, 0 bonus
            FROM cand_refer cr JOIN emp_list el ON cr.username = el.username 
            LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
            LEFT JOIN department dp on dp.sno = hc.dept
            WHERE cr.status = 'active'
            AND {$common_range}
            GROUP BY el.username
                  UNION
            SELECT el.sno, el.name, 0 shared, 0 refered, COUNT(DISTINCT cl.sno) qualified, 0 hired, 0 bonus
            FROM cand_refer cr JOIN emp_list el ON cr.username = el.username
            LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
            LEFT JOIN department dp on dp.sno = hc.dept
            LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
            LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
            LEFT JOIN applicants app ON  app.username = cr.ref_id AND FIND_IN_SET(cr.req_id, app.jobtitle)
            WHERE cr.status = 'active' AND ((rs.pstatus IN ('P', 'S')) OR ((app.serial_no IS NOT NULL
            OR cr.user_id IS NOT NULL) AND app.astatus NOT IN ('hire', 'backup', 'HRF')))
            AND {$common_range}
            GROUP BY el.username
                  UNION
            SELECT el_u.sno, el_u.name, 0 shared, 0 refered, 0 qualified, COUNT(1) hired, 0 bonus
            FROM cand_refer cr
            LEFT JOIN emp_list el_u ON el_u.username = cr.username
            LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
            LEFT JOIN department dp on dp.sno = hc.dept
            LEFT JOIN emp_list el ON el.sno = cr.emp_id
            LEFT JOIN applicants app ON app.username = cr.ref_id
            LEFT JOIN hrcon_general hg ON el.username = hg.username
            WHERE cr.status = 'active' AND (hg.ustatus = 'active' AND el.lstatus NOT IN ('DA', 'INACTIVE')
            AND el.sno IS NOT NULL AND (FIND_IN_SET(cr.req_id, el.cur_project) OR FIND_IN_SET(cr.req_id,
             app.jobtitle)) OR (app.jobtitle = '' AND el.cur_project = ''))
            AND {$common_range}
            GROUP BY el_u.username
                  UNION
            SELECT el.sno, el.name, 0 shared, 0 refered, 0 qualified, 0 hired, SUM(bonus_amount) bonus
            FROM cand_refer cr JOIN emp_list el ON cr.username = el.username
            LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
            LEFT JOIN department dp on dp.sno = hc.dept
            WHERE cr.status = 'active' AND cr.referral_status = '".getManageSno('Paid','referral_status')."'
            AND {$common_range}
            GROUP BY el.username
            ) temp";
        $gstr = " GROUP BY sno ";

        $lstr = $gd->buildLimt($gridPage,$gridRecords);
        $gqstr = $gd->buildQSTRGroup($gridSearchType,$gridSearchFields,$asFields);
        $ostr = $gd->buildOSTR(intval($gridSortCol),$gridSort,$ssFields); 
        $qstr = $gqstr[0];
        $hstr = $gqstr[1];
        $gstr.= $hstr;
                
        $tque = $gd->buildTQuery($tque,$qstr,$gstr);
        $oque = $gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
//  echo $oque;exit;
        $tres = mysql_query($tque,$db);
        $total = mysql_num_rows($tres);
//        $gridData = $gd->buildReferralsSummary($oque);
        $gridData=$gd->buildReferralsBonus($oque);
//        print_r($gridData);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
    }
    
    function getReferralsSharedSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db;
        $gd = new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields,'sd');
       
        $asFields=array("","el.sno", "el.name", "dp.deptname", "pd.posid","pd.postitle","aj.joblocation" ,tzRetQueryStringDTime('pd.stime','Date','/'), tzRetQueryStringDTime('sd.mdate','Date','/'), "jobSharedType(sd.sharetype)", "COUNT(cdr.applied_through)");
        $ssFields=array("","el.sno", "el.name", "dp.deptname", "pd.posid","pd.postitle","aj.joblocation",'pd.stime','sd.mdate',"TRIM(jobSharedType(sd.sharetype))","COUNT(cdr.applied_through)");

        $tque="SELECT sd.sno FROM shared_data  sd 
                JOIN emp_list el ON sd.username = el.username
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN api_jobs  aj ON sd.job_id=aj.sno
                LEFT JOIN hotjobs  hj ON hj.sno=aj.req_id
                LEFT JOIN cand_refer cdr ON hj.req_id =cdr.req_id AND cdr.applied_through=sd.sharetype AND cdr.username=sd.username 
LEFT JOIN posdesc pd ON pd.posid=hj.req_id                 
WHERE  {$common_range}";
		
        $oque="SELECT sd.sno, el.sno, el.name, dp.deptname, pd.posid,pd.postitle,aj.joblocation ,".tzRetQueryStringDTime('pd.stime','Date','/')." cdate, ".tzRetQueryStringDTime('sd.mdate','Date','/')." sdate, jobSharedType(sd.sharetype) shareTh, COUNT(cdr.applied_through) no_of_app FROM shared_data  sd 
                JOIN emp_list el ON sd.username = el.username
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN api_jobs aj ON sd.job_id=aj.sno
                LEFT JOIN hotjobs  hj ON hj.sno=aj.req_id
                LEFT JOIN cand_refer cdr ON hj.req_id =cdr.req_id AND cdr.applied_through=sd.sharetype AND cdr.username=sd.username 
                LEFT JOIN posdesc pd ON pd.posid=hj.req_id 
                WHERE {$common_range} ";
	
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
        $gstr = " GROUP BY sd.job_id,sd.sharetype,el.username ";	
        $ostr=$gd->buildOSTR(intval($gridSortCol),$gridSort,$ssFields);
        $tque=$gd->buildTQuery($tque,$qstr,$gstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
// echo $oque;exit;
        $tres = mysql_query($tque,$db);
	$total = mysql_num_rows($tres);
		
//        $gridData=$gd->buildReferralsSummary($oque);
        $gridData=$gd->buildReferralsBonus($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
        return $objResponse;
    }
    
    function getReferralsSubmittedSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db;
        $gd=new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields);
          
        $asFields=array("","el_u.sno", "el_u.name", "dp.deptname", "pd.posid", "pd.postitle", tzRetQueryStringDTime('pd.stime','Date','/'),"REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')","IF(cr.emp_id!='0','Hired',IF(cr.emp_id='0' AND el.sno IS NOT NULL,'Hired on other Job',IF(app.serial_no IS NOT NULL AND rs.pstatus = 'P','Placed',IF(app.serial_no IS NULL AND rs.pstatus = 'P','Placement-Cancelled',IF(rs.pstatus = 'S','Submitted','Pending')))))","IF(cr.applied_through='RAF','Referred/Applied','Shared/Applied')","jobSharedType(cr.applied_through)", tzRetQueryStringDTime('cr.mdate','Date','/'));
        $ssFields=array("","el_u.sno", "el_u.name", "dp.deptname","pd.posid","TRIM(pd.postitle)","pd.stime","REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')", "rs.pstatus","IF(cr.applied_through = 'RAF', IF(cr.ref_id IS NOT NULL, 'Referred/Applied', 'Referred'), IF(cr.ref_id IS NOT NULL, 'Shared/Applied', 'Shared'))","jobSharedType(cr.applied_through)","cr.mdate");

        
        /*$tque="SELECT cr.sno FROM cand_refer cr 
        JOIN emp_list el_u ON cr.username = el_u.username
        LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
        LEFT JOIN department dp on dp.sno = hc.dept        
        LEFT JOIN posdesc pd ON pd.posid=cr.req_id 
        LEFT JOIN candidate_list cl ON cl.candid = cr.ref_id AND cl.candid!=''
        LEFT JOIN resume_status rs ON rs.res_id = cl.sno AND cr.req_id = rs.req_id AND pstatus IN ('P','S')
        LEFT JOIN applicants app ON app.username=cr.ref_id  AND FIND_IN_SET(cr.req_id, app.jobtitle)>0
        LEFT JOIN emp_list el ON IF(cr.emp_id!=0,el.sno=cr.emp_id,IF(cr.user_id IS NOT NULL,el.username=cr.user_id,el.username=cr.ref_id)) 
        WHERE cr.status='active' AND {$common_range}";*/

        $oque="SELECT cr.sno, el_u.sno, el_u.name, dp.deptname, pd.posid, pd.postitle,".tzRetQueryStringDTime('pd.stime','Date','/')." cdate, REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ') cname ,
        IF(cr.emp_id!='0','Hired',IF(cr.emp_id='0' AND el.sno IS NOT NULL,'Hired on other Job',
        (IF(app.serial_no IS NOT NULL AND rs.pstatus = 'P','Placed',IF(app.serial_no IS NULL AND rs.pstatus = 'P','Placement-Cancelled',IF(rs.pstatus = 'S','Submitted','Pending')))))) AS ref_status,IF(cr.applied_through = 'RAF', if(cr.ref_id IS NOT NULL, 'Referred/Applied', 'Referred'), if(cr.ref_id IS NOT NULL, 'Shared/Applied', 'Shared')) sourcetype, jobSharedType(cr.applied_through) source, ".tzRetQueryStringDTime('cr.mdate','Date','/')." appl_date,IF(rs.seqnumber, rs.seqnumber, 0) seqnumber,IF(cl.sno,cl.sno,cr.sno) clsno
        FROM cand_refer cr 
        JOIN emp_list el_u ON cr.username = el_u.username
        LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
        LEFT JOIN department dp on dp.sno = hc.dept
        LEFT JOIN posdesc pd ON pd.posid=cr.req_id 
        LEFT JOIN candidate_list cl ON cl.candid = cr.ref_id AND cl.candid!=''
        LEFT JOIN resume_status rs ON rs.res_id = cl.sno AND cr.req_id = rs.req_id AND pstatus IN ('P','S')
        LEFT JOIN applicants app ON app.username=cr.ref_id  AND FIND_IN_SET(cr.req_id, app.jobtitle)>0
        LEFT JOIN emp_list el ON IF(cr.emp_id!=0,el.sno=cr.emp_id,IF(cr.user_id IS NOT NULL,el.username=cr.user_id,el.username=cr.ref_id)) 
        WHERE cr.status='active' AND {$common_range}";

        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);				
        $ostr=$gd->buildOSTR(intval($gridSortCol),$gridSort,$ssFields); 
//        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
// echo $oque;exit;
//        $tres = mysql_query($tque,$db);
//	$total = mysql_num_rows($tres);
//        $gridData=$gd->buildReferralsSummary($oque);
        $sort = (intval($gridSortCol) == 8 || intval($gridSortCol) == 9 ) ? 1 : 0; //here 8 is the column number of status
//        $gridData=$gd->buildReferralsBonus($oque,0,$sort);
        $gridData=$gd->buildReferralsSummary($oque,12,13,$sort);
        
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),count($gridData));
		
        return $objResponse;
    }
    
    function getReferralsQualifiedSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db;
        $gd = new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields);
          
        $asFields=array("","el_u.sno", "el_u.name", "dp.deptname", "pd.posid", "pd.postitle", tzRetQueryStringDTime('pd.stime','Date','/'),"REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')","IF(cr.emp_id!='0','Hired',IF(cr.emp_id='0' AND el.sno IS NOT NULL,'Hired on other Job',(IF(app.serial_no IS NOT NULL AND rs.pstatus = 'P','Placed',IF(app.serial_no IS NULL AND rs.pstatus = 'P','Placement-Cancelled',IF(rs.pstatus = 'S','Submitted','Pending'))))))",tzRetQueryStringDTime('rs.mdate','Date','/'),"IF(rs.pstatus = 'S','Submitted','Pending')");
        $ssFields=array("","el_u.sno", "el_u.name", "dp.deptname","pd.posid","TRIM(pd.postitle)","pd.stime","REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')","rs.pstatus","rs.mdate","IF(rs.pstatus = 'S','Submitted','Pending')");

        /*$tque="SELECT cr.sno
                FROM cand_refer cr 
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id 
                LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
                LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
                LEFT JOIN applicants app ON  app.username = cr.ref_id AND FIND_IN_SET(cr.req_id, app.jobtitle)
                LEFT JOIN emp_list el ON IF(cr.emp_id!=0,el.sno=cr.emp_id,IF(cr.user_id IS NOT NULL,el.username=cr.user_id,el.username=cr.ref_id)) 
                WHERE cr.status = 'active' AND ((rs.pstatus IN ('P', 'S')) OR ((app.serial_no IS NOT NULL
                OR cr.user_id IS NOT NULL) AND app.astatus NOT IN ('hire', 'backup', 'HRF'))) AND  {$common_range}";*/
		
        $oque="SELECT cr.sno,el_u.sno,el_u.name,dp.deptname,pd.posid,TRIM(pd.postitle),".tzRetQueryStringDTime('pd.stime','Date','/').",REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ') cname,
        IF(cr.emp_id!='0','Hired',IF(cr.emp_id='0' AND el.sno IS NOT NULL,'Hired on other Job',
        (IF(app.serial_no IS NOT NULL AND rs.pstatus = 'P','Placed',IF(app.serial_no IS NULL AND rs.pstatus = 'P','Placement-Cancelled',IF(rs.pstatus = 'S','Submitted','Pending')))))) AS ref_status,".tzRetQueryStringDTime('rs.mdate','Date','/')." date_submitted,IF(rs.pstatus = 'S','Submitted','Pending'),IF(rs.seqnumber,rs.seqnumber,0),cl.sno
                FROM cand_refer cr 
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id 
                LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
                LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
                LEFT JOIN applicants app ON  app.username = cr.ref_id AND FIND_IN_SET(cr.req_id, app.jobtitle)
                LEFT JOIN emp_list el ON IF(cr.emp_id!=0,el.sno=cr.emp_id,IF(cr.user_id IS NOT NULL,el.username=cr.user_id,el.username=cr.ref_id)) 
                WHERE cr.status = 'active' AND ((rs.pstatus IN ('P', 'S')) OR ((app.serial_no IS NOT NULL
                OR cr.user_id IS NOT NULL) AND app.astatus NOT IN ('hire', 'backup', 'HRF'))) AND {$common_range} ";
	
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);				
        $ostr=$gd->buildOSTR(intval($gridSortCol),$gridSort,$ssFields); 
//        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
// echo $oque;exit;
//        $tres = mysql_query($tque,$db);
//	$total = mysql_num_rows($tres);
        $gridData=$gd->buildReferralsSummary($oque,11,12); // 11 is seqnumber,12 is cl.sno
//        print_r($gridData);exit;
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),count($gridData));
		
        return $objResponse;
    }
    
    function getReferralsHiredSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        global $db;
        $gd = new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields);
          
        $asFields=array("","el_u.sno", "el_u.name", "dp.deptname", "pd.posid", "pd.postitle", tzRetQueryStringDTime('pd.stime','Date','/'),"cr.sno","REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')",tzRetQueryStringDTime("cr.hire_date",'Date','/'));
        $ssFields=array("","el_u.sno", "el_u.name", "dp.deptname","pd.posid","TRIM(pd.postitle)","pd.stime","cr.sno","REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ')","cr.hire_date");

        $tque="SELECT cr.sno
                FROM cand_refer cr
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id
                LEFT JOIN emp_list el ON el.sno = cr.emp_id
                LEFT JOIN applicants app ON app.username = cr.ref_id
                LEFT JOIN hrcon_general hg ON el.username = hg.username
                LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
                LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
                WHERE cr.status = 'active' AND (hg.ustatus = 'active' AND el.lstatus NOT IN ('DA', 'INACTIVE')
                AND el.sno IS NOT NULL AND (FIND_IN_SET(cr.req_id, el.cur_project) OR FIND_IN_SET(cr.req_id,
                 app.jobtitle)) OR (app.jobtitle = '' AND el.cur_project = '')) AND  {$common_range}";
		
        $oque="SELECT cr.sno,el_u.sno,el_u.name,dp.deptname,pd.posid,TRIM(pd.postitle),".tzRetQueryStringDTime('pd.stime','Date','/').",cr.sno referralid,REPLACE(CONCAT(TRIM(cr.fname),' ',TRIM(cr.mname),' ',TRIM(cr.lname)),'  ',' ') cname,".tzRetQueryStringDTime("cr.hire_date",'Date','/')."
                FROM cand_refer cr
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN hrcon_compen hc ON hc.username = el_u.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id
                LEFT JOIN emp_list el ON el.sno = cr.emp_id
                LEFT JOIN applicants app ON app.username = cr.ref_id
                LEFT JOIN hrcon_general hg ON el.username = hg.username
                LEFT JOIN candidate_list cl ON  cl.candid = cr.ref_id AND cl.candid != ''
                LEFT JOIN resume_status rs  ON  rs.res_id = cl.sno AND cr.req_id = rs.req_id
                WHERE cr.status = 'active' AND (hg.ustatus = 'active' AND el.lstatus NOT IN ('DA', 'INACTIVE')
                AND el.sno IS NOT NULL AND (FIND_IN_SET(cr.req_id, el.cur_project) OR FIND_IN_SET(cr.req_id,
                 app.jobtitle)) OR (app.jobtitle = '' AND el.cur_project = '')) AND {$common_range} ";
	
        $lstr=$gd->buildLimt($gridPage,$gridRecords);
        $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);				
        $ostr=$gd->buildOSTR(intval($gridSortCol),$gridSort,$ssFields); 
        $tque=$gd->buildTQuery($tque,$qstr);
        $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr);
// echo $oque;exit;
        $tres = mysql_query($tque,$db);
	$total = mysql_num_rows($tres);
//        $gridData=$gd->buildReferralsSummary($oque);
        $gridData=$gd->buildReferralsBonus($oque);
        $objResponse = new xajaxResponse();
        $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		
        return $objResponse;
    }
    
    function getReferralsBonusSummary($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
    {
        $gd = new gridData();
        $common_range = $gd->commonReferralsFilter($gridExtraFields);
        $whereCond ='';
        if($gridSearchFields[0]==""){
            $payReferralSnos = $gd->getAllPayReferralStatusSnos();
            $whereCond = " AND mng.sno IN (".$payReferralSnos.") ";
            $gridSearchFields[0] = "";
        }
        $asFields = array("","mng.sno","el.sno","el.name","dp.deptname","pd.posid", "el_u.sno", "el_u.name", tzRetQueryStringDate('cr.hire_date','Date','/'),"cr.bonus_amount","cr.bonus_calc_type","cr.eligibility_duration", tzRetQueryStringDate("cr.payment_date","Date","/"));			

        $ssFields = array("","mng.sno","el.sno","el.name","dp.deptname","pd.posid", "el_u.sno", "el_u.name", 'cr.hire_date',"cr.bonus_amount","cr.bonus_calc_type","cr.eligibility_duration", "cr.payment_date");

        $tque="SELECT COUNT(1)
                FROM cand_refer cr
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id
                LEFT JOIN manage mng ON (cr.referral_status = mng.sno AND mng.type='referral_status')
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN emp_list el ON (el.sno=cr.emp_id) 
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                WHERE 1=1
                AND cr.bonus_amount !='0.00'
        {$whereCond} AND {$common_range}";

        $oque ="SELECT 	cr.sno, mng.name referralname, el.sno emp_id, el.name emp_name,dp.deptname, pd.posid, el_u.sno referralby_id, el_u.name referralby_name,
       IF(cr.hire_date = '0000-00-00 00:00:00','',".tzRetQueryStringDate('cr.hire_date','Date','/')."),
       cr.bonus_amount, cr.bonus_calc_type, cr.eligibility_duration,
       ".tzRetQueryStringDate("cr.payment_date","Date","/").", mng.sno
                FROM cand_refer cr                
                LEFT JOIN posdesc pd ON pd.posid=cr.req_id
                LEFT JOIN manage mng ON (cr.referral_status = mng.sno AND mng.type='referral_status')
                JOIN emp_list el_u ON cr.username = el_u.username
                LEFT JOIN emp_list el ON (el.sno=cr.emp_id) 
                LEFT JOIN hrcon_compen hc ON hc.username = el.username AND hc.ustatus='active'
                LEFT JOIN department dp on dp.sno = hc.dept
                WHERE 1=1 
                AND cr.bonus_amount !='0.00' {$whereCond} AND {$common_range}";
            $gstr = "";
            $lstr=$gd->buildLimt($gridPage,$gridRecords);
            $qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
            $ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);
            $tque=$gd->buildTQuery($tque,$qstr,$gstr);
            $oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
//echo $oque;exit;
            $total=$gd->getTotalRows($tque);
            $gridData=$gd->buildReferralsBonus($oque);
            $objResponse = new xajaxResponse();
            $objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
            
            return $objResponse;
    }
    
    function buildReferralsSummary($que,$sortnumber,$filternumber,$sortstring=0)
    {
        global $db;
        $grid = $intermediate = $maxData = $final = [];
        $res = mysql_query($que,$db);
        while ($row=mysql_fetch_row($res)){
           $grid[] = $row; 
        }
        $this->sortnumber = $sortnumber;
        foreach ($grid as $element) {
            $intermediate[$element[$filternumber]][] = $element;
        }
        
        foreach ($intermediate as $element) {
            usort($element, [$this,"sortGridData"]);
            $maxData[] = $element[0];
        }
        
        foreach($maxData as $element){
            foreach($element as $index=>$val){
                if($index==0){
                 $element[$index] =  "<label class='container-chk'><input type='checkbox' name='auids[]' id='auids[]' onClick='chk_clearTop()' value='{$element[$index]}' data-payreferral='{$element[1]}'><span class='checkmark'></span></label>";
                }else{
                  $element[$index] =  $this->convertSpecChars($val);
                }
            }
            $final[] = $element;
        }
        if($sortstring){
            usort($final, array($this,'sortString'));
        }    
        return $final;
    }
    
    function sortGridData($a, $b){
        if ($a == $b)
            return 0;
        return ($a[$this->sortnumber] < $b[$this->sortnumber]) ? 1 : -1;
    }
    
    function commonReferralsFilter($filters,$table='cr',$addDept=True)
    {
        global $sess_usertype,$username;
        $user_depts = $this->getUserDepartments();
//          $allowed_usertype = explode(',',IRM_ALLUSERS_ALLOWED_TYPES);
        $start_date = date("Y-m-d",strtotime($filters['start_date']));
        $end_date = date("Y-m-d",strtotime("{$filters['end_date']} +1 days"));        
        $common_filter = " {$table}.cdate BETWEEN '{$start_date}' AND '{$end_date}' "; 
        if($sess_usertype != "SSU"){
            if(isset($filters['department']) && !empty($filters['department']) && $addDept){
                $common_filter .= " AND dp.sno='{$filters['department']}' ";
            }else{
                $common_filter .= " AND dp.sno IN ({$user_depts}) ";
            } 
        }else{
            $common_filter .= " AND {$table}.username='{$username}' ";
        } 
        return $common_filter;
    }
    
    function getUserDepartments()
    {
        global $db, $username;
        $dept_qry = "SELECT GROUP_CONCAT(sno) depts FROM department WHERE status = 'active' AND FIND_IN_SET({$username}, permission)";
        $departments = 0;
        $res = mysql_query($dept_qry,$db);
        while ($row=mysql_fetch_row($res)){
            $departments = $row[0];
        }
        return $departments;
    }
    
    
    function buildReferralsBonus($que,$e_sort=0,$s_sort=0)
    {
        global $db;
        $grid =[];
        $res = mysql_query($que,$db);
        while ($row=mysql_fetch_row($res)){ 
            foreach($row as $index=>$val){
                $pay_id = isset($row[13])? $row[13]:$row[1]; 
                if($index==0){
                    $row[$index] =  "<label class='container-chk'><input type='checkbox' name='auids[]' id='auids[]' onClick='chk_clearTop()' value='{$row[0]}' data-payreferral='{$pay_id}'><span class='checkmark'></span></label>";
                    }else{
                        $row[$index] =  $this->convertSpecChars($val);
                    }                   
            }
           $grid[] = $row; 
        }
        if($e_sort){
            usort($grid, array($this,'sortNumber'));
        }elseif($s_sort){
            usort($grid, array($this,'sortString'));
        }            
        return $grid;
    }
    
    function sortNumber($a, $b){
        if ($a == $b)
            return 0;
        $sort = ($_REQUEST['xajaxargs'][1] == "ASC") ? -1 : 1;
        return ($a[$_REQUEST['xajaxargs'][0]] < $b[$_REQUEST['xajaxargs'][0]]) ? $sort : -$sort;
    }
    
    function sortString($a, $b){
        return ($_REQUEST['xajaxargs'][1] == "ASC") ? strcmp($a[$_REQUEST['xajaxargs'][0]], $b[$_REQUEST['xajaxargs'][0]]): strcmp($b[$_REQUEST['xajaxargs'][0]], $a[$_REQUEST['xajaxargs'][0]]);
    }
    
    /*function buildReferralsSummary_ori($que)
    {
        global $db;
        $j=0;
        $grid=array();
        $res=mysql_query($que,$db);

        while ($row=mysql_fetch_array($res))
        {
            $grid[$j][0]="";
            $grid[$j][1]=$this->convertSpecChars($row[0]);
            $grid[$j][2]=$this->convertSpecChars($row[1]);
            $grid[$j][3]=$this->convertSpecChars($row[2]);
            $grid[$j][4]=$this->convertSpecChars($row[3]);
            $grid[$j][5]=$this->convertSpecChars($row[4]);
            $grid[$j][6]=$this->convertSpecChars($row[5]);
            $grid[$j][7]=$this->convertSpecChars($row[6]);
            $j++;
        }
        return $grid;
    }*/
    //In bound referral end
	function getPayStubHistory($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
	  
		global $db,$username,$invdept,$invservicedate,$invservicedateto; 
        $invdept=$gridExtraFields['invdept'];
	
		$invservicedate=$gridExtraFields['servicedate'];
		$invservicedateto=$gridExtraFields['servicedateto'];
		
		$gd = new gridData();
 
		$asFields = array("b.sno","b.ee_fullname","b.ee_id","b.batch_number","",tzRetQueryStringDate('b.pay_date','Date','/'),"SUBSTR(b.gross_pay,1,INSTR(b.gross_pay,'.'))","SUBSTR(b.net_pay,1,INSTR(b.net_pay,'.'))");
		$ssFields = array("b.sno","b.ee_fullname","b.ee_id","b.batch_number","",'b.pay_date',"b.gross_pay","b.net_pay");
        $dateString = "";$dept_str ="";
		 
		$FromDate =  $gridExtraFields['servicedate'];
		$ToDate   =  $gridExtraFields['servicedateto'];
		
		if($gd->isSearch($gridSearchFields))
		{
		  $dateString = "";$dept_str ="";
		}else{ 
		 
			if($gridExtraFields['servicedate']!="")
			{
				$fromArr=explode("/",$gridExtraFields['servicedate']);
				$fromDate= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
				$sDate=date("Y-m-d",$fromDate);
				$dateString .= " AND b.pay_date >='".$sDate."'";
			}
			if($gridExtraFields['servicedateto']!="")
			{
				$toArr=explode("/",$gridExtraFields['servicedateto']);
				$toDate= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
				$todaf=date("Y-m-d",$toDate);
				$dateString .= " AND b.pay_date <='".$todaf."'"; 
			}
   
			if($gridExtraFields['invdept']!="")
			{
				$deptcode = $gridExtraFields['invdept'];
				$dept_str .=" AND b.ee_dept_code = '".$deptcode."' ";
			}
			$loc_str ='';
			if($gridExtraFields['invloc'] != "0" && (empty($gridExtraFields['invdept'])))
			{
				$loccode = $gridExtraFields['invloc'];
				$loc_str .=" AND b.ee_loc_code = '".$loccode."' ";  
			}
		}
		$tque="SELECT COUNT(*) FROM paystub_master b WHERE  1=1 ".$dateString.$dept_str.$loc_str;
		
		
		$oque="SELECT b.sno, b.ee_fullname, b.ee_id,b.batch_number,CONCAT(".tzRetQueryStringDate('b.s_date','Date','/').",' - ',".tzRetQueryStringDate('b.e_date','Date','/')."), ".tzRetQueryStringDate('b.pay_date','Date','/').",b.gross_pay,b.net_pay FROM paystub_master b  WHERE 1=1  ".$dateString.$dept_str.$loc_str;

		  
        $gstr = " ";
		//$gstr = "GROUP BY b.sno";
  
		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);

		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildPayStubHistory($oque);

		$cque="SELECT  DATE_FORMAT(max(b.pay_date),'%m/%d/%Y') as max_d,DATE_FORMAT(min(b.pay_date),'%m/%d/%Y') as min_d FROM paystub_master b  WHERE 1=1 AND pay_date!= '0000-00-00' ".$dateString.$dept_str.$loc_str. $qstr;
		$cres=mysql_query($cque,$db);	
        $crow=mysql_fetch_row($cres);
		
		
        $searchFromDate = $crow[1];
        $searchToDate = $crow[0];
        
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
 
 
        
        // Load Optimization
        if($gd->isSearch($gridSearchFields)){
            $FromDate = $searchFromDate;
            $ToDate   = $searchToDate;
			
       }
	   $objResponse->addScriptCall("updateGridDateDisplay",$FromDate,$ToDate);
        
       
		return $objResponse;
	}

	function buildPayStubHistory($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = $this->convertSpecChars($row[3]);
			$grid[$j][4] = $this->convertSpecChars($row[4]);
			$grid[$j][5] = $this->convertSpecChars($row[5]);
			$grid[$j][6] = number_format($this->convertSpecChars($row[6]),2,'.','');
			$grid[$j][7] = number_format($this->convertSpecChars($row[7]),2,'.','');
			$grid[$j][8] = "<a href=ee_view_paycheck.php?sno=".$row[0]." target='_blank'><i class='fa fa-eye' title='Employee View of Paystub'></i></a>";
			$grid[$j][9] = "";
			
			$grid[$j][10]=$row[0];
			
			
			$j++;
		}
		
       
		
		return $grid;
	}
	function getMyPayStubHistory($gridSortCol,$gridSort,$gridPage,$gridRecords,$gridSearchType,$gridSearchFields,$gridExtraFields)
	{
		global $db,$username,$invservicedate,$invservicedateto;
      
		$invservicedate=$gridExtraFields['servicedate'];
		$invservicedateto=$gridExtraFields['servicedateto'];
		
		$gd = new gridData();

		$asFields = array("b.batch_number","",tzRetQueryStringDate('b.pay_date','Date','/'),"SUBSTR(b.gross_pay,1,INSTR(b.gross_pay,'.'))","SUBSTR(b.net_pay,1,INSTR(b.net_pay,'.'))");
		$ssFields = array("b.batch_number","","b.pay_date","b.gross_pay","b.net_pay");
 
        $FromDate =  $gridExtraFields['servicedate'];
		$ToDate   =  $gridExtraFields['servicedateto'];
		$dateString = "";
		if($gd->isSearch($gridSearchFields))
		{
		  $dateString = "";
		}else{
		 
			if($gridExtraFields['servicedate']!="")
			{
				$fromArr=explode("/",$gridExtraFields['servicedate']);
				$fromDate= mktime (0,0,0,$fromArr[0],$fromArr[1],$fromArr[2]);
				$sDate=date("Y-m-d",$fromDate);
				$dateString .= " AND b.pay_date >='".$sDate."'";
			}
			if($gridExtraFields['servicedateto']!="")
			{
				$toArr=explode("/",$gridExtraFields['servicedateto']);
				$toDate= mktime (0,0,0,$toArr[0],$toArr[1],$toArr[2]);
				$todaf=date("Y-m-d",$toDate);
				$dateString .= " AND b.pay_date <='".$todaf."'";
			}
   	
		}
		$tque="SELECT COUNT(*) FROM paystub_master b WHERE   b.ee_username=".$username ." ".$dateString;
		
		
		$oque="SELECT b.sno, CONCAT(".tzRetQueryStringDate('b.s_date','Date','/').",' - ',".tzRetQueryStringDate('b.e_date','Date','/')."), ".tzRetQueryStringDate('b.pay_date','Date','/').",b.gross_pay,b.net_pay FROM paystub_master b  WHERE  b.ee_username=".$username." ".$dateString;

		  
		
        $gstr = " ";
		//$gstr = "GROUP BY b.sno";

		$lstr=$gd->buildLimt($gridPage,$gridRecords);
		$qstr=$gd->buildQSTR($gridSearchType,$gridSearchFields,$asFields);
		$ostr=$gd->buildOSTR($gridSortCol,$gridSort,$ssFields);

		$tque=$gd->buildTQuery($tque,$qstr,$gstr);
		$oque=$gd->buildOQuery($oque,$qstr,$ostr,$lstr,$gstr);
 
		$total=$gd->getTotalRows($tque);
		$gridData=$gd->buildMyPayStubHistory($oque);

		$cque="SELECT  DATE_FORMAT(max(b.pay_date),'%m/%d/%Y') as max_d,DATE_FORMAT(min(b.pay_date),'%m/%d/%Y') as min_d FROM paystub_master b  WHERE 1=1 AND pay_date!= '0000-00-00' AND b.ee_username=".$username." ".$dateString. $qstr;
		$cres=mysql_query($cque,$db);	
        $crow=mysql_fetch_row($cres);
		
		
        $searchFromDate = $crow[1];
        $searchToDate = $crow[0];
       
		$objResponse = new xajaxResponse();
		$objResponse->addScriptCall("updateGrid",$objResponse->phpToJS($gridData),$total);
		//$objResponse->addScriptCall("updateGridPrint",$objResponse->phpToJS($gridData),$total,$tque,$oque);
 
        // Load Optimization
        if($gd->isSearch($gridSearchFields)){
            $FromDate = $searchFromDate;
            $ToDate   = $searchToDate;
			
       }
	   $objResponse->addScriptCall("updateGridDateDisplay",$FromDate,$ToDate);
		return $objResponse;
	}

	function buildMyPayStubHistory($que)
	{
		global $db;

		$j=0;
		$grid=array();

		$res=mysql_query($que,$db);	
		while($row=mysql_fetch_array($res))
		{
			$grid[$j][0] = "<label class='container-chk'><input type=checkbox name=auids[] value='".$row[0]."'><span class='checkmark'></span></label>";
			$grid[$j][1] = $this->convertSpecChars($row[1]); 
			$grid[$j][2] = $this->convertSpecChars($row[2]);
			$grid[$j][3] = number_format($this->convertSpecChars($row[3]),2,'.','');
			$grid[$j][4] = number_format($this->convertSpecChars($row[4]),2,'.','');
			$grid[$j][5] = "";
			
			
			
			$grid[$j][6] = "";
			$grid[$j][7]=$row[0];
			$j++;
		}
  
		return $grid;
	}
	
}
    
?>
